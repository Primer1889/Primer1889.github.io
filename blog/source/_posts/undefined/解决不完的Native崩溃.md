---
title: 了解令人抓挠的 Native 崩溃
catalog: true
date: 2022-10-16 11:57:27
subtitle: Java 崩溃调用栈等很清晰易解决，但是遇到 Native 崩溃时呢
header-img: /img/2210/page-native.webp
tags: Native
categories:
sticky: 14
---


# 关于崩溃

Android 崩溃大致分为两个部分，一是 Java 崩溃，其二是 Native 崩溃。
Java 崩溃还是比较好解决的，但要是遇到 native 崩溃就没那么容易，像我遇到非法地址访问（空指针）、触发相应 signal 信号杀死进程。

为啥 native 崩溃不易解决呢？
- 崩溃上下文不全
- 出错信息模糊，较难分析
- 难以捕获

我们发现，在日常开发中常常遇到的 native 崩溃是信号机制发出的杀死进程现象，比如 signal 9、signal 11 等。那么我们了解下信号机制是怎么样的？

## 信号处理
**1、信号接受：**
内核代理接收信号，内核收到信号之后会将其放入进程的队列，同时向进程发送中断陷入内核态。

**2、信号检测：**
陷入内核态后，何时会触发信号检测？
- 进程从内核态切换到用户态时
- 进程在内核态中从睡眠状态被唤醒时

**3、信号处理：**
信号处理函数处于用户态，调用处理函数前内核会将当前内核栈备份拷贝到用户栈，接着进程在用户态执行相应信号处理函数。
处理函数执行完后，进程返回内核态检查是否还有信号需处理？
- 若所有信号都处理完毕：恢复内核栈（把用户栈的备份拷贝回来），进程返回用户态
- 否则重复步骤，继续处理信号

> 常见信号类型：略

--- 

为了能更好地分析 native 崩溃需要注意什么？`保留编译时符号信息`
c/cpp 代码编译时，保留符号信息（符号表）供后续使用，客户端收集崩溃信息并上传服务器，服务器读取上报崩溃数据并查找符号信息（符号解析）进一步处理数据并生成清晰易懂的崩溃调用栈。

## 分析崩溃

**1、基本信息：**
发生崩溃时，通常根据 logcat 能够知道崩溃相关的基本信息，进程名称、崩溃所在线程、系统信息、崩溃栈、内存信息、信号（如果有）等。

**2、重点分析：**
崩溃分析无非是分析崩溃现场的相关日志，如果没有现场比较完整的日志，可以通过复现、复现、复现获取崩溃现场日志。native 崩溃可以注意 logcat 是否存在相关常见关键词`signal、code、process name、fault addr、kill、tracker 等`。

有时候崩溃现场不易复现，很难获取到崩溃现场调用栈，我知道如果是 Java 层崩溃可以通过 hook（xposted） 然后通过自动化测试运行程序一段时间当再次触发崩溃时可以获取，但如果是 native 崩溃是否也有成熟可用的 hook 技术可以实现呢？