{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/livemylife/source/css/archive.styl","path":"css/archive.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/beantech.css","path":"css/beantech.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/beantech.min.css","path":"css/beantech.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/bootstrap.css","path":"css/bootstrap.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/bootstrap.min.css","path":"css/bootstrap.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/catalog.styl","path":"css/catalog.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/gitalk.css","path":"css/gitalk.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/highlight.styl","path":"css/highlight.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/hux-blog.min.css","path":"css/hux-blog.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/livemylife.css","path":"css/livemylife.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/rocket.styl","path":"css/rocket.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/scroll.css","path":"css/scroll.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/search.css","path":"css/search.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/signature.styl","path":"css/signature.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/themecolor.css","path":"css/themecolor.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/top.css","path":"css/top.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/viewer.min.css","path":"css/viewer.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/wave.css","path":"css/wave.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/widget.styl","path":"css/widget.styl","modified":1,"renderable":1},{"_id":"themes/livemylife/source/dist/APlayer.min.css","path":"dist/APlayer.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/dist/APlayer.min.css.map","path":"dist/APlayer.min.css.map","modified":1,"renderable":1},{"_id":"themes/livemylife/source/dist/APlayer.min.js","path":"dist/APlayer.min.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/dist/APlayer.min.js.map","path":"dist/APlayer.min.js.map","modified":1,"renderable":1},{"_id":"themes/livemylife/source/dist/music.js","path":"dist/music.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.eot","path":"fonts/glyphicons-halflings-regular.eot","modified":1,"renderable":1},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.svg","path":"fonts/glyphicons-halflings-regular.svg","modified":1,"renderable":1},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.ttf","path":"fonts/glyphicons-halflings-regular.ttf","modified":1,"renderable":1},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.woff","path":"fonts/glyphicons-halflings-regular.woff","modified":1,"renderable":1},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.woff2","path":"fonts/glyphicons-halflings-regular.woff2","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/APlayer.min.css","path":"js/APlayer.min.css","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/APlayer.min.css.map","path":"js/APlayer.min.css.map","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/APlayer.min.js.map","path":"js/APlayer.min.js.map","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/APlayer.min.js","path":"js/APlayer.min.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/bootstrap.js","path":"js/bootstrap.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/bootstrap.min.js","path":"js/bootstrap.min.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/catalog.js","path":"js/catalog.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/hux-blog.js","path":"js/hux-blog.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/hux-blog.min.js","path":"js/hux-blog.min.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/jquery.js","path":"js/jquery.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/jquery.min.js","path":"js/jquery.min.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/jquery.nav.js","path":"js/jquery.nav.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/jquery.tagcloud.js","path":"js/jquery.tagcloud.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/langselect.js","path":"js/langselect.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/line.js","path":"js/line.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/mouseclick.js","path":"js/mouseclick.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/ribbonDynamic.js","path":"js/ribbonDynamic.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/scroll.js","path":"js/scroll.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/totop.js","path":"js/totop.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/ziploader.js","path":"js/ziploader.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/images/beside_up.png","path":"css/images/beside_up.png","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/images/beside_up2.png","path":"css/images/beside_up2.png","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/images/beside_up_white.png","path":"css/images/beside_up_white.png","modified":1,"renderable":1},{"_id":"themes/livemylife/source/css/images/beside_up_white2.png","path":"css/images/beside_up_white2.png","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/comment/gitalk.js","path":"js/comment/gitalk.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/comment/gitalk_.js","path":"js/comment/gitalk_.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/viewer/pic-viewer.js","path":"js/viewer/pic-viewer.js","modified":1,"renderable":1},{"_id":"themes/livemylife/source/js/viewer/viewer.min.js","path":"js/viewer/viewer.min.js","modified":1,"renderable":1},{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"source/LICENSE","path":"LICENSE","modified":1,"renderable":0},{"_id":"source/music/music.mp3","path":"music/music.mp3","modified":1,"renderable":0},{"_id":"source/img/220923_classmodify/class_bg.webp","path":"img/220923_classmodify/class_bg.webp","modified":1,"renderable":0},{"_id":"source/img/220923_classmodify/ymclass_bg.png","path":"img/220923_classmodify/ymclass_bg.png","modified":1,"renderable":0},{"_id":"source/img/220926_smailsdk/smail_bg.webp","path":"img/220926_smailsdk/smail_bg.webp","modified":1,"renderable":0},{"_id":"source/img/2210/divider-fenlei.jpg","path":"img/2210/divider-fenlei.jpg","modified":1,"renderable":0},{"_id":"source/img/2210/mine-englishbook.jpg","path":"img/2210/mine-englishbook.jpg","modified":1,"renderable":0},{"_id":"source/img/2210/mine_bookmark.jpg","path":"img/2210/mine_bookmark.jpg","modified":1,"renderable":0},{"_id":"source/img/220928/aboutme_bg.png","path":"img/220928/aboutme_bg.png","modified":1,"renderable":0},{"_id":"source/img/220928/aboutme_bg_sz.jpeg","path":"img/220928/aboutme_bg_sz.jpeg","modified":1,"renderable":0},{"_id":"source/img/220928/android_init_bg.png","path":"img/220928/android_init_bg.png","modified":1,"renderable":0},{"_id":"source/img/220928/android_sysserver_bg.png","path":"img/220928/android_sysserver_bg.png","modified":1,"renderable":0},{"_id":"source/img/220928/android_zygot_bg.png","path":"img/220928/android_zygot_bg.png","modified":1,"renderable":0},{"_id":"source/img/220928/main_index_bg.webp","path":"img/220928/main_index_bg.webp","modified":1,"renderable":0},{"_id":"source/img/220928/tag_bg.webp","path":"img/220928/tag_bg.webp","modified":1,"renderable":0},{"_id":"source/img/220928/total_bg.png","path":"img/220928/total_bg.png","modified":1,"renderable":0},{"_id":"source/img/220928/wuaipojie.jpeg","path":"img/220928/wuaipojie.jpeg","modified":1,"renderable":0},{"_id":"source/img/220928/xposted_bg.png","path":"img/220928/xposted_bg.png","modified":1,"renderable":0},{"_id":"source/img/index/index_bg.webp","path":"img/index/index_bg.webp","modified":1,"renderable":0},{"_id":"source/img/other/bottom2top.png","path":"img/other/bottom2top.png","modified":1,"renderable":0},{"_id":"source/img/2210/about-me.jpg","path":"img/2210/about-me.jpg","modified":1,"renderable":0},{"_id":"source/img/scenery/about_bg4.png","path":"img/scenery/about_bg4.png","modified":1,"renderable":0},{"_id":"source/img/scenery/treat_me_to_coffee.png","path":"img/scenery/treat_me_to_coffee.png","modified":1,"renderable":0},{"_id":"source/img/header_img/404_bg.png","path":"img/header_img/404_bg.png","modified":1,"renderable":0},{"_id":"source/img/header_img/categories_bg.png","path":"img/header_img/categories_bg.png","modified":1,"renderable":0},{"_id":"source/img/header_img/index_new_bg.png","path":"img/header_img/index_new_bg.png","modified":1,"renderable":0},{"_id":"source/img/header_img/lml_bg8.png","path":"img/header_img/lml_bg8.png","modified":1,"renderable":0},{"_id":"source/img/header_img/tag_new_bg.png","path":"img/header_img/tag_new_bg.png","modified":1,"renderable":0},{"_id":"source/img/header_img/main_sea_bg.png","path":"img/header_img/main_sea_bg.png","modified":1,"renderable":0},{"_id":"source/img/signature/nick-name.png","path":"img/signature/nick-name.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/404.md","hash":"3bdf0ec6214c65c8e924c8f716fe73f13471ae3c","modified":1665409099145},{"_id":"source/CNAME","hash":"3a509ddb0fb53de725c6a840d7fad5b072251535","modified":1665409099145},{"_id":"source/LICENSE","hash":"7df059597099bb7dcf25d2a9aedfaf4465f72d8d","modified":1665409099145},{"_id":"source/_posts/page- å’‹ä»¬ä¸€èµ·ä¿®æ”¹ class æ–‡ä»¶.md","hash":"e2b6beb4712a28c3fef81ee940439c72cf205984","modified":1665409099146},{"_id":"source/about/index.md","hash":"befeb8c8f1c72bbbfd3459401753d079e81e2b32","modified":1665812051342},{"_id":"source/_posts/page-Nativeä¿¡å·è¡¨.md","hash":"329f40f379dca2396086913a5d73bf4cfdde64c3","modified":1665409099146},{"_id":"source/categories/index.md","hash":"74b2a570ce9d2ae889b5df96e828c0230c0df9af","modified":1665810398242},{"_id":"source/tags/index.md","hash":"db9dbee5f76fce466159bbd714d05467562f4f84","modified":1665812347302},{"_id":"source/archive/index.md","hash":"208b675a24ebce3c19596c4630a3eb24c1dd4d4b","modified":1665409099150},{"_id":"source/_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨systemserverè¿›ç¨‹.md","hash":"7e6d2a4c8d73d985320d7a69c861351d99705e8d","modified":1665409099147},{"_id":"source/_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨zgoteè¿›ç¨‹.md","hash":"c2a5405e2ac9e4c02b38ab7bbc3358bac3c67ffd","modified":1665409099147},{"_id":"source/_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨initè¿›ç¨‹.md","hash":"b95df51e0765484d109c2a448342686df67f9ce2","modified":1665409099147},{"_id":"source/.DS_Store","hash":"84f35e390633eadc3c78584a28f5f5f8ce7f43a5","modified":1663765629791},{"_id":"source/img/.DS_Store","hash":"e32b5a17280c6097e054e323630ffb4e885a6ec6","modified":1664198110917},{"_id":"source/_posts/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨ä¸€.md","hash":"3a1bdc330c768f4ec08ba5d7fa4190682b33c3c3","modified":1665409099148},{"_id":"source/_posts/undefined/ä½ æˆ‘å­—èŠ‚ç .md","hash":"6f662dc19a80a5bcb5390b3ef773715528edd67f","modified":1665409099149},{"_id":"source/_posts/undefined/ä»smailæ¥å…¥ç¬¬ä¸‰æ–¹.md","hash":"48e946f86651e83e8574762bbaca09cff99eacb4","modified":1665409099149},{"_id":"source/_posts/undefined/å¾çˆ±ç ´è§£.md","hash":"d7483385ad32e0106064845b3cf55c4c0f0b7682","modified":1665810510504},{"_id":"source/_posts/undefined/æˆ‘çš„å•è¯æœ¬.md","hash":"6b70a087c87bbaf808252f1b69d2fc6a34309414","modified":1665811787308},{"_id":"source/_posts/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨äºŒ.md","hash":"b83136c614df092542a0d994cb93af72b45d2682","modified":1665409099148},{"_id":"source/_posts/undefined/æˆ‘çš„å·¥å…·.md","hash":"25f6eaa9733aa88b9dc2ea5cf6d66e2e467d0d8e","modified":1665813564652},{"_id":"source/_posts/undefined/æ¯•ä¸šä¸€å¹´.md","hash":"c0a271cf83937de72d72fc91900f479ac1b1c00b","modified":1665808164791},{"_id":"source/_posts/undefined/è®¾å¤‡ä¿¡æ¯è·å–æ£€æµ‹.md","hash":"bc086513a68a92c76ae963b665f3c8ae8266d9eb","modified":1665409099150},{"_id":"source/img/220928/wuaipojie.jpeg","hash":"b7ec8e12e40a6583632a895de9be4e32c55df4d0","modified":1665409594026},{"_id":"source/img/scenery/treat_me_to_coffee.png","hash":"83619ac3af6e3463a3cb462cb6e31a38543b06e6","modified":1665409099170},{"_id":"source/img/other/bottom2top.png","hash":"35dbb5fa18be3c15a8027c81a41aa267226e8230","modified":1665409099170},{"_id":"source/img/220923_classmodify/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1664110705365},{"_id":"source/img/220926_smailsdk/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1664198119837},{"_id":"source/img/220923_classmodify/class_bg.webp","hash":"a37f0bb77fbcbf74d400e44a9250f606799b6c2f","modified":1665409099151},{"_id":"source/img/220928/main_index_bg.webp","hash":"7da131e67e4b18d0c1917823621662c781d3afc2","modified":1665409099160},{"_id":"source/img/scenery/about_bg4.png","hash":"559928668f158e2117a47049ea23caec99387b15","modified":1665409099170},{"_id":"source/img/signature/nick-name.png","hash":"621bb5f186dbaa4b4e7cd6753b3cd4fe0ef812a3","modified":1665409099171},{"_id":"source/img/2210/about-me.jpg","hash":"b72808d6ce0c244483e0200e6528ab8bb9341473","modified":1665812015177},{"_id":"source/img/header_img/main_sea_bg.png","hash":"d87fb98fd15e51e63d8f153bfe9f61ab7898002b","modified":1665409099169},{"_id":"source/img/2210/mine-englishbook.jpg","hash":"788b3017d0c36a8c874349cfbede0698ae6365c7","modified":1665811715107},{"_id":"themes/livemylife/layout/_partial/comment.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1665409099202},{"_id":"source/img/header_img/categories_bg.png","hash":"310b37816ecac824175fd171a92308a9453c2723","modified":1665409099167},{"_id":"source/img/220928/aboutme_bg_sz.jpeg","hash":"ab8019795ce9d633d87ee18255c45f857fc9c4a7","modified":1665409099156},{"_id":"themes/livemylife/LICENSE","hash":"2b209f06bebeb2a8c2b7e187e436f3e1e1fbc8a7","modified":1665409099200},{"_id":"themes/livemylife/_config.yml","hash":"7638a858e59f075c4066eb9ca880f3bce75ccd04","modified":1665409099200},{"_id":"themes/livemylife/layout/404.ejs","hash":"007f4b206b68a000b891115100a0a2992b0732f4","modified":1665409099201},{"_id":"themes/livemylife/layout/_layout.swig","hash":"1831f3852bb3545e630530318e2be42e5c23aff7","modified":1665409099201},{"_id":"themes/livemylife/layout/about.ejs","hash":"145d53bf1ed755cdcff669eed2c1a1862eb9fb98","modified":1665409099206},{"_id":"themes/livemylife/layout/archive.ejs","hash":"c09dd7bb49a28ec5ac65ef2b4d9f4e0e2c4e31a4","modified":1665409099206},{"_id":"themes/livemylife/layout/categories.ejs","hash":"3b074215b4880c6c5fcc428f586587f8c92d78a2","modified":1665409099206},{"_id":"themes/livemylife/layout/keynote.ejs","hash":"a919348ff0eea1e3df368dcb082d2fb5a2d0aca0","modified":1665409099206},{"_id":"themes/livemylife/layout/index.ejs","hash":"aca8ba8a3c52e3497fcf71ab8ad3ec7d2fa13058","modified":1665409099206},{"_id":"themes/livemylife/layout/layout.ejs","hash":"8be005bb924af5b7fe604ef2c5ff7c903b8e4f69","modified":1665409099207},{"_id":"themes/livemylife/layout/page.ejs","hash":"205c90e8111e6f7388015fccc7f91d015158a2db","modified":1665409099207},{"_id":"themes/livemylife/languages/default.yml","hash":"9f7c6711fdee2cf67277baf810c551723be21c22","modified":1665409099201},{"_id":"themes/livemylife/layout/post.ejs","hash":"49344f40ae0b386eb14d245d07c3378a06d1a651","modified":1665409099207},{"_id":"themes/livemylife/layout/tags.ejs","hash":"3bb8d1c43fd018cafd049e9cd2af6586e9596e38","modified":1665409099207},{"_id":"themes/livemylife/languages/cn.yml","hash":"000466cb7c925e03986b8149235c05822f77e868","modified":1665409099201},{"_id":"themes/livemylife/languages/en.yml","hash":"9f7c6711fdee2cf67277baf810c551723be21c22","modified":1665409099201},{"_id":"themes/livemylife/layout/_partial/anchorjs.ejs","hash":"9a9ff58f3767c7d23c029fcb2030ea353824f79a","modified":1665409099201},{"_id":"themes/livemylife/layout/_partial/catalog.ejs","hash":"11db668dce21b88b0648478ad82e053f50f06919","modified":1665409099202},{"_id":"themes/livemylife/layout/_partial/footer.ejs","hash":"ad43ec694f8f59bee8edf53fc812f36864bbb6a8","modified":1665409099202},{"_id":"themes/livemylife/layout/_partial/gitter.ejs","hash":"348193932983df5196a3bc49e8b59276d978b09f","modified":1665409099202},{"_id":"themes/livemylife/layout/_partial/header.ejs","hash":"b053ba8e43345e34e33dab9f948fc6075f46dbef","modified":1665409099203},{"_id":"themes/livemylife/layout/_partial/head.ejs","hash":"76889b25d50a38617ccd7474b987f5e38218911d","modified":1665409099202},{"_id":"themes/livemylife/layout/_partial/langselect.ejs","hash":"6ead51e4f41fd08eb086edcf7964431dcb8ded8e","modified":1665409099203},{"_id":"themes/livemylife/layout/_partial/music.ejs","hash":"5acec22a2e417185da0d62290f7581e1f21b7ca4","modified":1665409099203},{"_id":"themes/livemylife/layout/_partial/nav.ejs","hash":"a6e6860aa1aae1c9a3a0fd9760f04955b834c333","modified":1665409099203},{"_id":"themes/livemylife/layout/_partial/pagination.ejs","hash":"1c3f390b60dba1da3d57fb7fa95c0dd96efa99b8","modified":1665409099203},{"_id":"themes/livemylife/layout/_partial/sidebar.ejs","hash":"693e7199e6cbdd3d1fea8d6726786a43c548bd78","modified":1665409099204},{"_id":"themes/livemylife/layout/_partial/search.ejs","hash":"6f297d6bff4bc50bb88802c11fe1fd1368200bad","modified":1665409099204},{"_id":"themes/livemylife/layout/_partial/socialshare.ejs","hash":"55f93924d5b876ff35d59f27f12d0934d8209806","modified":1665409099204},{"_id":"themes/livemylife/layout/_partial/themecolor.ejs","hash":"c0da1e6af0e15dd1eb4a07fa8be93fa637fca8e8","modified":1665409099204},{"_id":"themes/livemylife/layout/_partial/tip.ejs","hash":"d535578b4629e830a2518695e9002f4aca115fc3","modified":1665409099204},{"_id":"themes/livemylife/layout/_widget/category.ejs","hash":"b80bc8197ad14393ef4d0c47dcf744d666327e65","modified":1665409099205},{"_id":"themes/livemylife/layout/_widget/featured-tags.ejs","hash":"fa33001a4d3a451d8c68ba1a80f92d049f8dd5a2","modified":1665409099205},{"_id":"themes/livemylife/layout/_widget/archive.ejs","hash":"f943d9b3ab48506a290b02aaff9560675588d495","modified":1665409099204},{"_id":"themes/livemylife/layout/_widget/friends-blog.ejs","hash":"d4050312c5dbec1d5d92881a54367176fea4f955","modified":1665409099205},{"_id":"themes/livemylife/source/css/archive.styl","hash":"715bcbd085eb95ec26c9805c11c374919cde971c","modified":1665409099208},{"_id":"themes/livemylife/layout/_widget/recent-posts.ejs","hash":"4420ebcb7cfd6e4abc09fb29c63e76a6c5598f14","modified":1665409099205},{"_id":"themes/livemylife/layout/_widget/visitor.ejs","hash":"eae7005b1b62019a08286d7ccf555e9c8d1626ee","modified":1665409099206},{"_id":"themes/livemylife/source/css/beantech.css","hash":"f0869d21e3b5cadf6c3b69fa41c6562e2ab945c6","modified":1665809092303},{"_id":"themes/livemylife/layout/_widget/short-about.ejs","hash":"42f62772bf4611dac7ee0982a77b938627cc4e31","modified":1665409099205},{"_id":"themes/livemylife/source/css/beantech.min.css","hash":"53f4e22f888b8842884f7243392f3a02fc81d2c9","modified":1665809096887},{"_id":"themes/livemylife/source/css/catalog.styl","hash":"b4b4b71b20d8b6bce185b962c2feb79314b7813c","modified":1665409099209},{"_id":"themes/livemylife/source/css/gitalk.css","hash":"51783fd60dff05e8e339ff83b41504538662f6ca","modified":1665409099209},{"_id":"themes/livemylife/source/css/highlight.styl","hash":"e842080e6d580f0f70a7df71fbde3c4e49463c19","modified":1665409099209},{"_id":"themes/livemylife/source/css/hux-blog.min.css","hash":"4a48dc3ab8d64a73c8b830027c47474a6828b81d","modified":1665409099209},{"_id":"themes/livemylife/source/css/livemylife.css","hash":"1901c580d1f80f02e266ff371dc15d4e5e824a2d","modified":1665409099209},{"_id":"themes/livemylife/source/css/rocket.styl","hash":"d81a811f3b7149b519f8cebf9a9b5719dd4870c0","modified":1665409099209},{"_id":"themes/livemylife/source/css/search.css","hash":"3ff388d8da7e2c5aac7071f2dccda767ec9c5647","modified":1665409099210},{"_id":"themes/livemylife/source/css/scroll.css","hash":"ba16b97532dd6aaec66a82f3c33cc989d361fa7a","modified":1665409099209},{"_id":"themes/livemylife/source/css/signature.styl","hash":"afc37961c8fc8ddb1a31aae16dcaa3ced58b4633","modified":1665409099210},{"_id":"themes/livemylife/source/css/themecolor.css","hash":"2b1c2095577d95dfe92f3e7b924ea3db50e61fab","modified":1665409099210},{"_id":"themes/livemylife/source/css/top.css","hash":"0303375fbe2ca942cd3d86f31d12fef9bf5785af","modified":1665409099210},{"_id":"themes/livemylife/source/css/viewer.min.css","hash":"0e045aa3df1be7d138caa701ec3aa623ccc7a52d","modified":1665409099210},{"_id":"themes/livemylife/source/css/wave.css","hash":"041f3b4a78e2840ba17679cea05fb14bb646722f","modified":1665409099210},{"_id":"themes/livemylife/source/css/widget.styl","hash":"7a9f735f5ef323dc2950fbd9d76daa16c9a0f1a9","modified":1665409099210},{"_id":"themes/livemylife/source/dist/APlayer.min.css","hash":"fd1d253594e71700e185a9841664e3cbc85501d2","modified":1665409099210},{"_id":"themes/livemylife/source/dist/APlayer.min.css.map","hash":"c59d2bc9472922cf6ef9a99e052dbee6cc7e6b36","modified":1665409099211},{"_id":"themes/livemylife/source/dist/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1665409099211},{"_id":"themes/livemylife/source/dist/music.js","hash":"3eddc21b70a147c96059e2120eb21ec5511b86ca","modified":1665409099212},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.eot","hash":"86b6f62b7853e67d3e635f6512a5a5efc58ea3c3","modified":1665409099212},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.woff","hash":"278e49a86e634da6f2a02f3b47dd9d2a8f26210f","modified":1665409099213},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.ttf","hash":"44bc1850f570972267b169ae18f1cb06b611ffa2","modified":1665409099212},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.woff2","hash":"ca35b697d99cae4d1b60f2d60fcd37771987eb07","modified":1665409099213},{"_id":"themes/livemylife/source/js/bootstrap.min.js","hash":"b3f2ef9f985e7906c9360756b73cd64bf7733647","modified":1665409099214},{"_id":"themes/livemylife/source/js/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1665409099213},{"_id":"themes/livemylife/source/js/APlayer.min.css","hash":"fd1d253594e71700e185a9841664e3cbc85501d2","modified":1665409099213},{"_id":"themes/livemylife/source/js/hux-blog.js","hash":"4b4d3c557405d04c3087d36c13e2834fe05c0f73","modified":1665409099218},{"_id":"themes/livemylife/source/js/catalog.js","hash":"059f3f31492e5b1a9dddf422a48c32969d247415","modified":1665409099215},{"_id":"themes/livemylife/source/js/APlayer.min.css.map","hash":"c59d2bc9472922cf6ef9a99e052dbee6cc7e6b36","modified":1665409099213},{"_id":"themes/livemylife/source/js/hux-blog.min.js","hash":"1563e7f70550ac6b30803d6f449719b853200e35","modified":1665409099219},{"_id":"themes/livemylife/source/js/langselect.js","hash":"52ca6e30814272bc329868944f528f89630404e4","modified":1665409099220},{"_id":"themes/livemylife/source/js/jquery.nav.js","hash":"ef2160a456176a4d09cc0b95d52b27dfbbadf2d8","modified":1665409099220},{"_id":"themes/livemylife/source/js/jquery.tagcloud.js","hash":"4e5fd0b07f3bd935f2e603710447e039e3677211","modified":1665409099220},{"_id":"themes/livemylife/source/js/line.js","hash":"d69576bfe75048345a137c148ffca1d9985811dc","modified":1665409099220},{"_id":"themes/livemylife/source/js/mouseclick.js","hash":"b27fb5ae779a855a93b85c923f1ac927ba52dc86","modified":1665409099220},{"_id":"themes/livemylife/source/js/scroll.js","hash":"265a4c4fc33b5b44b620db64ff31d2bc05d233e9","modified":1665409099220},{"_id":"themes/livemylife/source/js/ribbonDynamic.js","hash":"576f0ce237c87738277868489af30b6538681201","modified":1665409099220},{"_id":"themes/livemylife/source/js/totop.js","hash":"c05360f6fc699ac12e794b1764b4a952713a3017","modified":1665409099220},{"_id":"themes/livemylife/source/js/ziploader.js","hash":"9c25324caf53b56cb68839dcfb34e61e5a6a63f3","modified":1665409099221},{"_id":"themes/livemylife/source/css/images/beside_up.png","hash":"183d87f1a99e93fc663ec798fa8c94cb87c83bcb","modified":1665409099209},{"_id":"themes/livemylife/source/css/images/beside_up2.png","hash":"ef066ba2e93a4738df45ae05020726e066c4dd1f","modified":1665409099209},{"_id":"themes/livemylife/source/css/images/beside_up_white2.png","hash":"52e9d5715def1d3d09ab076d5eb3d22916d8f7d7","modified":1665409099209},{"_id":"themes/livemylife/source/css/images/beside_up_white.png","hash":"49c5922a8de63dcf9468fbcffc70d2ec36b1b527","modified":1665409099209},{"_id":"themes/livemylife/source/js/viewer/viewer.min.js","hash":"ae5380974b6fb8b0e15356c8418186c6c0821222","modified":1665409099221},{"_id":"themes/livemylife/source/js/viewer/pic-viewer.js","hash":"9bf7c37cce781628346803ed7ce8f02623c2d013","modified":1665409099220},{"_id":"source/img/2210/divider-fenlei.jpg","hash":"8b557c7f74cff6e2bd592fc1f74748559a328363","modified":1665812251188},{"_id":"source/img/220926_smailsdk/smail_bg.webp","hash":"3c42495df222245998b7213c8159c4db72319b3c","modified":1665409099153},{"_id":"source/img/220928/android_init_bg.png","hash":"2affcb6364172fdd77cb4d752d4bd6f136ce054a","modified":1665409099157},{"_id":"themes/livemylife/source/css/bootstrap.min.css","hash":"fec7b176a4b9a67c0eb5d184f57b84297efc23aa","modified":1665409099208},{"_id":"themes/livemylife/source/fonts/glyphicons-halflings-regular.svg","hash":"de51a8494180a6db074af2dee2383f0a363c5b08","modified":1665409099212},{"_id":"themes/livemylife/source/js/bootstrap.js","hash":"f8752e9ae24daec0a0baffd7819122f8c6fd9103","modified":1665409099214},{"_id":"themes/livemylife/source/js/jquery.min.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1665409099220},{"_id":"source/img/2210/mine_bookmark.jpg","hash":"0a529951dfb36dd60237e0b80626257f11da7183","modified":1665803447448},{"_id":"source/img/index/index_bg.webp","hash":"0372176f6f7861ba80b37a00a04ad1a2e4e1938e","modified":1665409099170},{"_id":"themes/livemylife/source/css/bootstrap.css","hash":"41c54bf695145ae0b4d9020a1da308ceb05dcaf3","modified":1665409099208},{"_id":"themes/livemylife/source/dist/APlayer.min.js.map","hash":"31a19da0f0cb6b00ec212eafa847f31af86788df","modified":1665409099212},{"_id":"themes/livemylife/source/js/APlayer.min.js.map","hash":"31a19da0f0cb6b00ec212eafa847f31af86788df","modified":1665409099214},{"_id":"source/img/header_img/index_new_bg.png","hash":"3c86eb37698141a99011441c07af47df90fc65d8","modified":1665409099167},{"_id":"source/img/header_img/tag_new_bg.png","hash":"79c939b5c212d539e6bf9b09b65a9e34dbaf1833","modified":1665409099169},{"_id":"themes/livemylife/source/js/jquery.js","hash":"1852661bd11a09ca9b9cb63d1aa6ff390fffaf4e","modified":1665409099219},{"_id":"source/img/220928/aboutme_bg.png","hash":"0a1c3cb03800db1cc0cdd1d13cec5c3be6fc440e","modified":1665409099156},{"_id":"source/img/220928/android_zygot_bg.png","hash":"bcda2e95c6cf4058d8dca41e330f76c2246b6c4b","modified":1665409099160},{"_id":"source/img/220928/xposted_bg.png","hash":"4a63ec286a98f1e274912463c4340524e29c08e9","modified":1665409099164},{"_id":"themes/livemylife/source/js/comment/gitalk_.js","hash":"559bde41e7fca7fc58f0b9a740875f5f4650a763","modified":1665409099218},{"_id":"source/img/220928/android_sysserver_bg.png","hash":"0369a23b5a681cf4ed7c3daa8d306ddd0f1a76c1","modified":1665409099158},{"_id":"themes/livemylife/source/js/comment/gitalk.js","hash":"e5c1b7f8a2803765cff831793af377a9f81fb385","modified":1665409099216},{"_id":"source/img/header_img/lml_bg8.png","hash":"0369a23b5a681cf4ed7c3daa8d306ddd0f1a76c1","modified":1665409099169},{"_id":"source/img/220928/tag_bg.webp","hash":"1aaf79191c3117b7e12d29d0bed65cb112c3f5a4","modified":1665409099161},{"_id":"source/img/220923_classmodify/ymclass_bg.png","hash":"237b680e4247256a1f9dbb63ccfc0d6c05f115a4","modified":1665409099153},{"_id":"source/img/220928/total_bg.png","hash":"237b680e4247256a1f9dbb63ccfc0d6c05f115a4","modified":1665409099163},{"_id":"source/img/header_img/404_bg.png","hash":"120f7a1cbd02d7bf19428ac5019fad91089c3c2f","modified":1665409099166},{"_id":"source/music/music.mp3","hash":"9769b60bed684884921f6f4128be60ea56a6f49b","modified":1665409099183},{"_id":"public/baidusitemap.xml","hash":"86e8d5a56a4be0e32cc176e714c52d6b4604202e","modified":1665813692790},{"_id":"public/sitemap.xml","hash":"3092ff4ef943f332a7e702c445f0c57d7dc407ee","modified":1665813692790},{"_id":"public/searchVersion.json","hash":"ffae35e0674cd2feb6e3217e015fa02851eabfdd","modified":1665813692790},{"_id":"public/404.html","hash":"126d14b0102cc7d14b5b2367baedb6f9fb9f5839","modified":1665813692790},{"_id":"public/tags/index.html","hash":"6bfc50fed03453a24baa56d73910b2f9c3357f83","modified":1665813692790},{"_id":"public/categories/index.html","hash":"0f814f8338861846f4bc593dea56b66e36f8e210","modified":1665813692790},{"_id":"public/undefined/æˆ‘çš„å•è¯æœ¬/index.html","hash":"87e372e96d32e336c2a5b29947218893a5adee2f","modified":1665813692790},{"_id":"public/undefined/æˆ‘çš„å·¥å…·/index.html","hash":"bc73330884d43f526fe94f5b164f2e83c7d0c068","modified":1665813692790},{"_id":"public/undefined/æ¯•ä¸šä¸€å¹´/index.html","hash":"4fe209579276eac290eef1ebdca0f5cdaded4693","modified":1665813692790},{"_id":"public/undefined/å¾çˆ±ç ´è§£/index.html","hash":"77941dd1e127fc9c4ea7c246556ed39527267ece","modified":1665813692790},{"_id":"public/undefined/è®¾å¤‡ä¿¡æ¯è·å–æ£€æµ‹/index.html","hash":"43bc65838a355b40af69ca9d8213e4edfced207a","modified":1665813692790},{"_id":"public/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨äºŒ/index.html","hash":"aa7ea8472edfb371c3f520618e9e645811ae7dcc","modified":1665813692790},{"_id":"public/undefined/Androidç³»ç»Ÿå¯åŠ¨systemserverè¿›ç¨‹/index.html","hash":"d4100f43746c9eb2f3418f0ee868b5892d45c84b","modified":1665813692790},{"_id":"public/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨ä¸€/index.html","hash":"b9ee6c4bba169f090eed52dc4a6672719aee32f3","modified":1665813692790},{"_id":"public/undefined/Androidç³»ç»Ÿå¯åŠ¨zgoteè¿›ç¨‹/index.html","hash":"a2e29becd0db4b33ba8aa9b95c8c7fc090570126","modified":1665813692790},{"_id":"public/undefined/Androidç³»ç»Ÿå¯åŠ¨initè¿›ç¨‹/index.html","hash":"fd22cfc01e57287697456cba137444e3e9cdf590","modified":1665813692790},{"_id":"public/undefined/ä»smailæ¥å…¥ç¬¬ä¸‰æ–¹/index.html","hash":"2b8e4b1f7ade10b04b1175366a017d586f24df43","modified":1665813692790},{"_id":"public/undefined/ä½ æˆ‘å­—èŠ‚ç /index.html","hash":"f25ac17f87cc6985787b64ae8289303e310b195a","modified":1665813692790},{"_id":"public/undefined/page-å’‹ä»¬ä¸€èµ·ä¿®æ”¹-class-æ–‡ä»¶/index.html","hash":"297e27cf61499cd48585c9e7aad71b0339ac7bea","modified":1665813692790},{"_id":"public/undefined/page-Nativeä¿¡å·è¡¨/index.html","hash":"acd8a0be7bd7c53ff23aac88a7c9e26af5959a3e","modified":1665813692790},{"_id":"public/archive/index.html","hash":"de51a72369cd1bc417a09f3d690d106f61031046","modified":1665813692790},{"_id":"public/about/index.html","hash":"c814e87e92adc5013b88faea8450939dc67b00b1","modified":1665813692790},{"_id":"public/archives/archives/2/index.html","hash":"30f858cfea32847634db468e6f32992f7d9c90d0","modified":1665813692790},{"_id":"public/archives/2022/index.html","hash":"0dd83cf4a92f952dcb592f8a9a47c20af797d391","modified":1665813692790},{"_id":"public/archives/2022/09/index.html","hash":"2d0d87b93df2e656554701e4f0d4a981d8b96596","modified":1665813692790},{"_id":"public/archives/2022/10/index.html","hash":"5f54565d42da5a5bd9826cfeef4016824d35e243","modified":1665813692790},{"_id":"public/archives/index.html","hash":"c881a2f2ab77c61b23bcd6b9d4b3dcf70f2ac76e","modified":1665813692790},{"_id":"public/index.html","hash":"fbfc555a65b56a450a927a4e9f5de871fa1e1505","modified":1665813692790},{"_id":"public/archives/2/index.html","hash":"574afc55f0518b7515981b4d5a16806ad9e96387","modified":1665813692790},{"_id":"public/tags/å­—èŠ‚ç /index.html","hash":"2996894fd3c4e69d54fe06130b8d3fac84399a15","modified":1665813692790},{"_id":"public/tags/ç¬”è®°/index.html","hash":"1c266656ab3696eb80ceb02543ab27eceb0ef34e","modified":1665813692790},{"_id":"public/tags/AOSP/index.html","hash":"cfc8d17f57c9dd52af9c2a2ad46b91751504f12e","modified":1665813692790},{"_id":"public/tags/å·¥å…·/index.html","hash":"b6a281a7280ac41173d7375b54f9ec116b4dbf20","modified":1665813692790},{"_id":"public/tags/SDK/index.html","hash":"7d71ae1c1e151d866f6a0d3404766796c1b49ea5","modified":1665813692790},{"_id":"public/tags/åˆ·æœº/index.html","hash":"9908f180845f0dd47e6a2558d963df55c6ebf655","modified":1665813692790},{"_id":"public/archives/2022/archives/2/index.html","hash":"18ac9110775099f624ef43f80435578e92088128","modified":1665813692790},{"_id":"public/dist/APlayer.min.css.map","hash":"c59d2bc9472922cf6ef9a99e052dbee6cc7e6b36","modified":1665813692790},{"_id":"public/fonts/glyphicons-halflings-regular.woff","hash":"278e49a86e634da6f2a02f3b47dd9d2a8f26210f","modified":1665813692790},{"_id":"public/fonts/glyphicons-halflings-regular.eot","hash":"86b6f62b7853e67d3e635f6512a5a5efc58ea3c3","modified":1665813692790},{"_id":"public/js/APlayer.min.css.map","hash":"c59d2bc9472922cf6ef9a99e052dbee6cc7e6b36","modified":1665813692790},{"_id":"public/fonts/glyphicons-halflings-regular.woff2","hash":"ca35b697d99cae4d1b60f2d60fcd37771987eb07","modified":1665813692790},{"_id":"public/fonts/glyphicons-halflings-regular.ttf","hash":"44bc1850f570972267b169ae18f1cb06b611ffa2","modified":1665813692790},{"_id":"public/css/images/beside_up.png","hash":"183d87f1a99e93fc663ec798fa8c94cb87c83bcb","modified":1665813692790},{"_id":"public/css/images/beside_up_white.png","hash":"49c5922a8de63dcf9468fbcffc70d2ec36b1b527","modified":1665813692790},{"_id":"public/css/images/beside_up2.png","hash":"ef066ba2e93a4738df45ae05020726e066c4dd1f","modified":1665813692790},{"_id":"public/css/images/beside_up_white2.png","hash":"52e9d5715def1d3d09ab076d5eb3d22916d8f7d7","modified":1665813692790},{"_id":"public/LICENSE","hash":"7df059597099bb7dcf25d2a9aedfaf4465f72d8d","modified":1665813692790},{"_id":"public/CNAME","hash":"3a509ddb0fb53de725c6a840d7fad5b072251535","modified":1665813692790},{"_id":"public/img/220928/wuaipojie.jpeg","hash":"b7ec8e12e40a6583632a895de9be4e32c55df4d0","modified":1665813692790},{"_id":"public/img/other/bottom2top.png","hash":"35dbb5fa18be3c15a8027c81a41aa267226e8230","modified":1665813692790},{"_id":"public/img/scenery/treat_me_to_coffee.png","hash":"83619ac3af6e3463a3cb462cb6e31a38543b06e6","modified":1665813692790},{"_id":"public/assets/css/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1665813692790},{"_id":"public/assets/js/Meting.min.js","hash":"a0585220b918d78649a7893279e1ec4fb5abe835","modified":1665813692790},{"_id":"public/assets/js/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1665813692790},{"_id":"public/fonts/glyphicons-halflings-regular.svg","hash":"de51a8494180a6db074af2dee2383f0a363c5b08","modified":1665813692790},{"_id":"public/img/220923_classmodify/class_bg.webp","hash":"a37f0bb77fbcbf74d400e44a9250f606799b6c2f","modified":1665813692790},{"_id":"public/img/220928/main_index_bg.webp","hash":"7da131e67e4b18d0c1917823621662c781d3afc2","modified":1665813692790},{"_id":"public/img/scenery/about_bg4.png","hash":"559928668f158e2117a47049ea23caec99387b15","modified":1665813692790},{"_id":"public/img/signature/nick-name.png","hash":"621bb5f186dbaa4b4e7cd6753b3cd4fe0ef812a3","modified":1665813692790},{"_id":"public/css/archive.css","hash":"8db895ebaeff19ac145c961abcfd5d4a8d67a8ea","modified":1665813692790},{"_id":"public/css/livemylife.css","hash":"1901c580d1f80f02e266ff371dc15d4e5e824a2d","modified":1665813692790},{"_id":"public/css/scroll.css","hash":"ba16b97532dd6aaec66a82f3c33cc989d361fa7a","modified":1665813692790},{"_id":"public/css/highlight.css","hash":"03d1f0a648e9bdf7b1f57d217313cbac5d0c7eb1","modified":1665813692790},{"_id":"public/css/search.css","hash":"3ff388d8da7e2c5aac7071f2dccda767ec9c5647","modified":1665813692790},{"_id":"public/css/catalog.css","hash":"6e63e8902ec9ba5ef6256a0c2ef93934c56d612c","modified":1665813692790},{"_id":"public/css/rocket.css","hash":"1aa31deaf2c434e883a7b4d096d187244eb964d0","modified":1665813692790},{"_id":"public/css/viewer.min.css","hash":"0e045aa3df1be7d138caa701ec3aa623ccc7a52d","modified":1665813692790},{"_id":"public/css/signature.css","hash":"47d91f966a30d393aee44cec9bdba0a26e53dd35","modified":1665813692790},{"_id":"public/css/wave.css","hash":"041f3b4a78e2840ba17679cea05fb14bb646722f","modified":1665813692790},{"_id":"public/css/top.css","hash":"0303375fbe2ca942cd3d86f31d12fef9bf5785af","modified":1665813692790},{"_id":"public/css/widget.css","hash":"da95ad3f1938f24d20f1fa77d7a38f0c392b5ec8","modified":1665813692790},{"_id":"public/dist/APlayer.min.css","hash":"fd1d253594e71700e185a9841664e3cbc85501d2","modified":1665813692790},{"_id":"public/dist/music.js","hash":"3eddc21b70a147c96059e2120eb21ec5511b86ca","modified":1665813692790},{"_id":"public/js/APlayer.min.css","hash":"fd1d253594e71700e185a9841664e3cbc85501d2","modified":1665813692790},{"_id":"public/js/hux-blog.js","hash":"4b4d3c557405d04c3087d36c13e2834fe05c0f73","modified":1665813692790},{"_id":"public/js/hux-blog.min.js","hash":"1563e7f70550ac6b30803d6f449719b853200e35","modified":1665813692790},{"_id":"public/js/catalog.js","hash":"059f3f31492e5b1a9dddf422a48c32969d247415","modified":1665813692790},{"_id":"public/js/jquery.nav.js","hash":"ef2160a456176a4d09cc0b95d52b27dfbbadf2d8","modified":1665813692790},{"_id":"public/js/langselect.js","hash":"52ca6e30814272bc329868944f528f89630404e4","modified":1665813692790},{"_id":"public/js/line.js","hash":"d69576bfe75048345a137c148ffca1d9985811dc","modified":1665813692790},{"_id":"public/js/jquery.tagcloud.js","hash":"4e5fd0b07f3bd935f2e603710447e039e3677211","modified":1665813692790},{"_id":"public/js/ribbonDynamic.js","hash":"576f0ce237c87738277868489af30b6538681201","modified":1665813692790},{"_id":"public/js/scroll.js","hash":"265a4c4fc33b5b44b620db64ff31d2bc05d233e9","modified":1665813692790},{"_id":"public/js/mouseclick.js","hash":"b27fb5ae779a855a93b85c923f1ac927ba52dc86","modified":1665813692790},{"_id":"public/js/totop.js","hash":"c05360f6fc699ac12e794b1764b4a952713a3017","modified":1665813692790},{"_id":"public/js/viewer/pic-viewer.js","hash":"9bf7c37cce781628346803ed7ce8f02623c2d013","modified":1665813692790},{"_id":"public/css/gitalk.css","hash":"51783fd60dff05e8e339ff83b41504538662f6ca","modified":1665813692790},{"_id":"public/css/hux-blog.min.css","hash":"4a48dc3ab8d64a73c8b830027c47474a6828b81d","modified":1665813692790},{"_id":"public/css/bootstrap.min.css","hash":"fec7b176a4b9a67c0eb5d184f57b84297efc23aa","modified":1665813692790},{"_id":"public/css/beantech.min.css","hash":"53f4e22f888b8842884f7243392f3a02fc81d2c9","modified":1665813692790},{"_id":"public/css/beantech.css","hash":"f0869d21e3b5cadf6c3b69fa41c6562e2ab945c6","modified":1665813692790},{"_id":"public/css/bootstrap.css","hash":"41c54bf695145ae0b4d9020a1da308ceb05dcaf3","modified":1665813692790},{"_id":"public/css/themecolor.css","hash":"2b1c2095577d95dfe92f3e7b924ea3db50e61fab","modified":1665813692790},{"_id":"public/dist/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1665813692790},{"_id":"public/js/bootstrap.min.js","hash":"b3f2ef9f985e7906c9360756b73cd64bf7733647","modified":1665813692790},{"_id":"public/js/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1665813692790},{"_id":"public/js/bootstrap.js","hash":"f8752e9ae24daec0a0baffd7819122f8c6fd9103","modified":1665813692790},{"_id":"public/js/ziploader.js","hash":"9c25324caf53b56cb68839dcfb34e61e5a6a63f3","modified":1665813692790},{"_id":"public/js/jquery.js","hash":"1852661bd11a09ca9b9cb63d1aa6ff390fffaf4e","modified":1665813692790},{"_id":"public/js/jquery.min.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1665813692790},{"_id":"public/js/viewer/viewer.min.js","hash":"ae5380974b6fb8b0e15356c8418186c6c0821222","modified":1665813692790},{"_id":"public/dist/APlayer.min.js.map","hash":"31a19da0f0cb6b00ec212eafa847f31af86788df","modified":1665813692790},{"_id":"public/js/APlayer.min.js.map","hash":"31a19da0f0cb6b00ec212eafa847f31af86788df","modified":1665813692790},{"_id":"public/img/2210/about-me.jpg","hash":"b72808d6ce0c244483e0200e6528ab8bb9341473","modified":1665813692790},{"_id":"public/img/header_img/main_sea_bg.png","hash":"d87fb98fd15e51e63d8f153bfe9f61ab7898002b","modified":1665813692790},{"_id":"public/js/comment/gitalk_.js","hash":"559bde41e7fca7fc58f0b9a740875f5f4650a763","modified":1665813692790},{"_id":"public/js/comment/gitalk.js","hash":"e5c1b7f8a2803765cff831793af377a9f81fb385","modified":1665813692790},{"_id":"public/img/2210/mine-englishbook.jpg","hash":"788b3017d0c36a8c874349cfbede0698ae6365c7","modified":1665813692790},{"_id":"public/img/header_img/categories_bg.png","hash":"310b37816ecac824175fd171a92308a9453c2723","modified":1665813692790},{"_id":"public/img/220928/aboutme_bg_sz.jpeg","hash":"ab8019795ce9d633d87ee18255c45f857fc9c4a7","modified":1665813692790},{"_id":"public/img/2210/divider-fenlei.jpg","hash":"8b557c7f74cff6e2bd592fc1f74748559a328363","modified":1665813692790},{"_id":"public/img/220926_smailsdk/smail_bg.webp","hash":"3c42495df222245998b7213c8159c4db72319b3c","modified":1665813692790},{"_id":"public/img/220928/android_init_bg.png","hash":"2affcb6364172fdd77cb4d752d4bd6f136ce054a","modified":1665813692790},{"_id":"public/img/2210/mine_bookmark.jpg","hash":"0a529951dfb36dd60237e0b80626257f11da7183","modified":1665813692790},{"_id":"public/img/index/index_bg.webp","hash":"0372176f6f7861ba80b37a00a04ad1a2e4e1938e","modified":1665813692790},{"_id":"public/img/header_img/index_new_bg.png","hash":"3c86eb37698141a99011441c07af47df90fc65d8","modified":1665813692790},{"_id":"public/img/header_img/tag_new_bg.png","hash":"79c939b5c212d539e6bf9b09b65a9e34dbaf1833","modified":1665813692790},{"_id":"public/img/220928/aboutme_bg.png","hash":"0a1c3cb03800db1cc0cdd1d13cec5c3be6fc440e","modified":1665813692790},{"_id":"public/img/220928/android_zygot_bg.png","hash":"bcda2e95c6cf4058d8dca41e330f76c2246b6c4b","modified":1665813692790},{"_id":"public/img/220928/xposted_bg.png","hash":"4a63ec286a98f1e274912463c4340524e29c08e9","modified":1665813692790},{"_id":"public/img/220928/android_sysserver_bg.png","hash":"0369a23b5a681cf4ed7c3daa8d306ddd0f1a76c1","modified":1665813692790},{"_id":"public/img/header_img/lml_bg8.png","hash":"0369a23b5a681cf4ed7c3daa8d306ddd0f1a76c1","modified":1665813692790},{"_id":"public/img/220928/tag_bg.webp","hash":"1aaf79191c3117b7e12d29d0bed65cb112c3f5a4","modified":1665813692790},{"_id":"public/img/220923_classmodify/ymclass_bg.png","hash":"237b680e4247256a1f9dbb63ccfc0d6c05f115a4","modified":1665813692790},{"_id":"public/img/220928/total_bg.png","hash":"237b680e4247256a1f9dbb63ccfc0d6c05f115a4","modified":1665813692790},{"_id":"public/img/header_img/404_bg.png","hash":"120f7a1cbd02d7bf19428ac5019fad91089c3c2f","modified":1665813692790},{"_id":"public/music/music.mp3","hash":"9769b60bed684884921f6f4128be60ea56a6f49b","modified":1665813692790}],"Category":[],"Data":[],"Page":[{"layout":"404","description":"I'm sorry there is nothing that you want , but you can enjoy the scenery here ...","header-img":"img/header_img/404_bg.jpg","_content":"","source":"404.md","raw":"---\nlayout: 404\ndescription: \"I'm sorry there is nothing that you want , but you can enjoy the scenery here ...\"\nheader-img: \"img/header_img/404_bg.jpg\"\n---\n","date":"2022-10-10T13:38:19.145Z","updated":"2022-10-10T13:38:19.145Z","path":"404.html","title":"","comments":1,"_id":"cl99ignsi0000gaqph2d92zx0","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script>","site":{"data":{}},"excerpt":"","more":""},{"layout":"archive","title":"æ–‡ç« å­˜æ¡£","header-img":"img/header_img/archive_bg.png","date":"2017-03-20T12:49:56.000Z","description":"åŸå¸‚çš„æŸæ²¹è·¯å¤ªç¡¬ï¼Œè¸©ä¸å‡ºè¶³è¿¹ï¼","_content":"","source":"archive/index.md","raw":"---\nlayout: \"archive\"\ntitle: \"æ–‡ç« å­˜æ¡£\"\nheader-img: \"img/header_img/archive_bg.png\"\ndate: 2017-03-20 20:49:56\ndescription: åŸå¸‚çš„æŸæ²¹è·¯å¤ªç¡¬ï¼Œè¸©ä¸å‡ºè¶³è¿¹ï¼\n---\n","updated":"2017-03-20T12:49:56.000Z","path":"archive/index.html","comments":1,"_id":"cl99ignsk0002gaqp4x91dsjo","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script>","site":{"data":{}},"excerpt":"","more":""},{"layout":"tags","title":"æ ‡ç­¾","description":"æ–‡ç« æ€»æ˜¯å›´ç»•é‡ç‚¹å±•å¼€ï¼Œå·¥ä½œä¹Ÿæœ‰é‡ç‚¹ï¼Œç”Ÿæ´»ä¹Ÿæ˜¯ã€‚","header-img":"img/2210/divider-fenlei.jpg","_content":"","source":"tags/index.md","raw":"---\nlayout: \"tags\"\ntitle: \"æ ‡ç­¾\"\ndescription: \"æ–‡ç« æ€»æ˜¯å›´ç»•é‡ç‚¹å±•å¼€ï¼Œå·¥ä½œä¹Ÿæœ‰é‡ç‚¹ï¼Œç”Ÿæ´»ä¹Ÿæ˜¯ã€‚\"\nheader-img: \"img/2210/divider-fenlei.jpg\"\n---\n","date":"2022-10-15T05:39:07.302Z","updated":"2022-10-15T05:39:07.302Z","path":"tags/index.html","comments":1,"_id":"cl99ignsm0005gaqp2rwr5mz9","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script>","site":{"data":{}},"excerpt":"","more":""},{"layout":"categories","title":"æ•¬è¯·æœŸå¾…","description":"æ¨¡å—å°šæœªå¼€å‘ ğŸ¤”","header-img":"img/220928/total_bg.png","_content":"","source":"categories/index.md","raw":"---\nlayout: \"categories\"\ntitle: \"æ•¬è¯·æœŸå¾…\"\ndescription: \"æ¨¡å—å°šæœªå¼€å‘ ğŸ¤”\"\nheader-img: \"img/220928/total_bg.png\"\n---\n","date":"2022-10-15T05:06:38.242Z","updated":"2022-10-15T05:06:38.242Z","path":"categories/index.html","comments":1,"_id":"cl99ignsn0007gaqp7dmxhre1","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script>","site":{"data":{}},"excerpt":"","more":""},{"layout":"about","title":"About me!","date":"2016-04-20T20:48:33.000Z","description":"é‚£äº›å¹´å¹è¿‡çš„ç‰›é€¼ï¼Œè¿˜æœ‰å¾ˆå¤šæ²¡æœ‰å®ç°å§ï¼","header-img":"img/2210/about-me.jpg","_content":"\n# è¨€\n\nRead The Fucking Source Code.Â \n\nç«™åœ¨'å·¨äºº'çš„è‚©è†€ä¸Šå¼€å§‹è‡ªå·±çš„æ—…é€”ã€‚\n\næ„‰å¿«çš„å‘¨æœ«ï¼Œä»æ‰“å¼€ç”µè„‘å¼€å§‹ï¼Œåˆ°éª‘è¡Œå½’æ¥ç»“æŸã€‚\n\næµ®ç”Ÿè‹¥æ¢¦è°éå¯„ï¼Œåˆ°å¤„èƒ½æŒ‰ä¾¿æ˜¯å®¶ï¼\n","source":"about/index.md","raw":"---\nlayout: \"about\"\ntitle: \"About me!\"\ndate: 2016-04-21 04:48:33\ndescription: \"é‚£äº›å¹´å¹è¿‡çš„ç‰›é€¼ï¼Œè¿˜æœ‰å¾ˆå¤šæ²¡æœ‰å®ç°å§ï¼\"\nheader-img: \"img/2210/about-me.jpg\"\n---\n\n# è¨€\n\nRead The Fucking Source Code.Â \n\nç«™åœ¨'å·¨äºº'çš„è‚©è†€ä¸Šå¼€å§‹è‡ªå·±çš„æ—…é€”ã€‚\n\næ„‰å¿«çš„å‘¨æœ«ï¼Œä»æ‰“å¼€ç”µè„‘å¼€å§‹ï¼Œåˆ°éª‘è¡Œå½’æ¥ç»“æŸã€‚\n\næµ®ç”Ÿè‹¥æ¢¦è°éå¯„ï¼Œåˆ°å¤„èƒ½æŒ‰ä¾¿æ˜¯å®¶ï¼\n","updated":"2016-04-20T20:48:33.000Z","path":"about/index.html","comments":1,"_id":"cl99ignso0009gaqp8r3j5eqs","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>è¨€</h1>\n<p>Read The Fucking Source Code.</p>\n<p>ç«™åœ¨â€™å·¨äººâ€™çš„è‚©è†€ä¸Šå¼€å§‹è‡ªå·±çš„æ—…é€”ã€‚</p>\n<p>æ„‰å¿«çš„å‘¨æœ«ï¼Œä»æ‰“å¼€ç”µè„‘å¼€å§‹ï¼Œåˆ°éª‘è¡Œå½’æ¥ç»“æŸã€‚</p>\n<p>æµ®ç”Ÿè‹¥æ¢¦è°éå¯„ï¼Œåˆ°å¤„èƒ½æŒ‰ä¾¿æ˜¯å®¶ï¼</p>\n","site":{"data":{}},"excerpt":"","more":"<h1>è¨€</h1>\n<p>Read The Fucking Source Code.</p>\n<p>ç«™åœ¨â€™å·¨äººâ€™çš„è‚©è†€ä¸Šå¼€å§‹è‡ªå·±çš„æ—…é€”ã€‚</p>\n<p>æ„‰å¿«çš„å‘¨æœ«ï¼Œä»æ‰“å¼€ç”µè„‘å¼€å§‹ï¼Œåˆ°éª‘è¡Œå½’æ¥ç»“æŸã€‚</p>\n<p>æµ®ç”Ÿè‹¥æ¢¦è°éå¯„ï¼Œåˆ°å¤„èƒ½æŒ‰ä¾¿æ˜¯å®¶ï¼</p>\n"}],"Post":[{"title":"å’‹ä»¬ä¸€èµ·ä¿®æ”¹ class æ–‡ä»¶","catalog":true,"date":"2022-09-25T12:45:24.000Z","subtitle":"ä¿®æ”¹ç¬¬ä¸‰æ–¹ jar åŒ…æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€ç§æ–¹å¼ï¼","header-img":"/img/220923_classmodify/class_bg.webp","sticky":2,"_content":"\n# ä½ æœ‰é‡åˆ°é€‚ç”¨çš„åœºæ™¯å—\n\n![æ·±å¤§æ‘é•¿.jpg](https://img-blog.csdnimg.cn/img_convert/b489e163aa127c5f7eb59575079df4d6.png)\n\nä½ æœ‰æ²¡æœ‰é‡åˆ°éœ€è¦ä¿®æ”¹ class æ–‡ä»¶é‡æ–°æ‰“åŒ…çš„åœºæ™¯å‘¢ï¼Ÿå·§å¾—å¾ˆï¼Œæœ€è¿‘åˆšå¥½é‡åˆ°éœ€è¦ä¿®æ”¹ä¸€ä¸ªå·²å­˜åœ¨çš„ jar åŒ…ä»¥æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œä¸è¿‡æœ¬æ¬¡ä¿®æ”¹çš„æ˜¯å­—ç¬¦å¸¸é‡ï¼Œå°šæœªæ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„é€»è¾‘ï¼Œè®°å½•ä¸‹æ­¤åˆ»ï¼Œå¦‚ä½•ä¿®æ”¹ï¼Ÿå¦‚ä½•å¿«é€Ÿä¿®æ”¹å®Œæˆéœ€æ±‚ï¼Ÿå¸Œæœ›å¯ä»¥æŠ›ç –å¼•ç‰ï¼Œå‰©ä¸‹çš„è¾ƒä¸ºå¤æ‚çš„é€»è¾‘ä¿®æ”¹å°±äº¤ç»™ä½ ä»¬äº† :)\n\n**ä¸¾ä¸ªä¾‹å­ï¼š**\n\né—®é¢˜æè¿°ï¼š\n    1ã€æŸå¼¹çª—æ–‡æœ¬æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆæ–‡å­—å†—ä½™ï¼Œæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/39cb62ad15a8135fced9b45bb6e0b58e.png)\n\nå…³äºæè¿°ï¼š\n    1ã€æ­¤å¼¹çª—ä»£ç æ˜¯æŸç¬¬ä¸‰æ–¹ jar åŒ…\n    2ã€æ–‡å­—æ˜¾ç¤ºè¦æ±‚åº”è¯¥æ˜¯ï¼š `å®¢æœï¼šQQå·`\n    3ã€ä½†å®é™…æƒ…å†µç¬¬ä¸‰æ–¹ jar åŒ…åœ¨æ˜¾ç¤ºå†…å®¹å‰åŠ äº†å‰ç¼€ `å®¢æœ`ï¼Œä¸ç¬¦åˆè¦æ±‚\n\né¢„æœŸæ•ˆæœï¼š\n    1ã€æ˜¾ç¤ºæ•ˆæœï¼š`å®¢æœQQï¼š2464113103`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/be9836c62729cd6fd5904c8ff4dbcfd5.png)\n\n\né¢„æœŸéœ€æ±‚å¾ˆæ¸…æ™°ï¼Œä»£ç ä¿®æ”¹ä¹Ÿè·Ÿæ¸…æ™°ï¼ˆå»é™¤ç¬¬ä¸‰æ–¹ jar åŒ…å†…å®¹å‰ç¼€ `å®¢æœï¼š`ï¼Œå®ç°å†…å®¹çµæ´»é…ç½®ï¼‰\n\n\n# æ¸©æ•… jar å‘½ä»¤ä½¿ç”¨\n\n1ã€å‘½ä»¤æŸ¥çœ‹ä½¿ç”¨å¸®åŠ© jar -h\n```java\nç”¨æ³•: jar {ctxui}[vfmn0PMe] [jar-file] [manifest-file] [entry-point] [-C dir] files ...\\\né€‰é¡¹:\n    -c  åˆ›å»ºæ–°æ¡£æ¡ˆ\n    -t  åˆ—å‡ºæ¡£æ¡ˆç›®å½•\n    -x  ä»æ¡£æ¡ˆä¸­æå–æŒ‡å®šçš„ (æˆ–æ‰€æœ‰) æ–‡ä»¶\n    -u  æ›´æ–°ç°æœ‰æ¡£æ¡ˆ\n    -v  åœ¨æ ‡å‡†è¾“å‡ºä¸­ç”Ÿæˆè¯¦ç»†è¾“å‡º\n    -f  æŒ‡å®šæ¡£æ¡ˆæ–‡ä»¶å\n    -m  åŒ…å«æŒ‡å®šæ¸…å•æ–‡ä»¶ä¸­çš„æ¸…å•ä¿¡æ¯\n    -n  åˆ›å»ºæ–°æ¡£æ¡ˆåæ‰§è¡Œ Pack200 è§„èŒƒåŒ–\n    -e  ä¸ºæ†ç»‘åˆ°å¯æ‰§è¡Œ jar æ–‡ä»¶çš„ç‹¬ç«‹åº”ç”¨ç¨‹åº\n        æŒ‡å®šåº”ç”¨ç¨‹åºå…¥å£ç‚¹\n    -0  ä»…å­˜å‚¨; ä¸ä½¿ç”¨ä»»ä½• ZIP å‹ç¼©\n    -P  ä¿ç•™æ–‡ä»¶åä¸­çš„å‰å¯¼ '/' (ç»å¯¹è·¯å¾„) å’Œ \"..\" (çˆ¶ç›®å½•) ç»„ä»¶\n    -M  ä¸åˆ›å»ºæ¡ç›®çš„æ¸…å•æ–‡ä»¶\n    -i  ä¸ºæŒ‡å®šçš„ jar æ–‡ä»¶ç”Ÿæˆç´¢å¼•ä¿¡æ¯\n    -C  æ›´æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•å¹¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶\n\nå¦‚æœä»»ä½•æ–‡ä»¶ä¸ºç›®å½•, åˆ™å¯¹å…¶è¿›è¡Œé€’å½’å¤„ç†ã€‚æ¸…å•æ–‡ä»¶å, æ¡£æ¡ˆæ–‡ä»¶åå’Œå…¥å£ç‚¹åç§°çš„æŒ‡å®šé¡ºåº\nä¸ 'm', 'f' å’Œ 'e' æ ‡è®°çš„æŒ‡å®šé¡ºåºç›¸åŒã€‚\n```\n\n2ã€æ‰“åŒ…ç”Ÿæˆ jar\nå°† class æ–‡ä»¶æ‰“åŒ…ä¸º jar æ–‡ä»¶\n```java\njar cvf classes.jar Foo.class Bar.class\n```\n\nå°† folder/ ç›®å½•ä¸‹çš„æ‰€æœ‰ class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶\n```java\njar cvf classes.jar -C folder/ .\n```\n\n3ã€æŸ¥çœ‹ jar æ–‡ä»¶åˆ—è¡¨\n```java\njar -tvf classes.jar\n```\n\n4ã€è§£å‹ jar æ–‡ä»¶\n```java\njar -xvf classes.jar\n```\n\n# å¼€å§‹ä¿®æ”¹ jar\n\næ–¹å¼ä¸€ä¸æ¨èï¼Œåªæ˜¯æƒ³è®©ä½ çŸ¥é“è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚\n\n## æ–¹å¼ä¸€ï¼šjavac\n\n**1ã€ä½¿ç”¨ JD-GUI æ‰“å¼€ jar æ–‡ä»¶å¹¶å¯¼å‡º java ä»£ç **\n\n**2ã€ä½¿ç”¨ javac å‘½ä»¤æŠŠ .java æ–‡ä»¶è½¬æ¢ä¸º .class æ–‡ä»¶**\n```java\njavac -classpath [å¾…ç”Ÿæˆçš„æ–‡ä»¶å.jar] [å·²ä¿®æ”¹çš„æ–‡ä»¶.java]\n```\n\nå®é™…æ“ä½œè¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ javac å‘½ä»¤å¾€å¾€ä¸æ˜¯è‡ªå·±æœŸæœ›çš„é‚£ä¹ˆé¡ºåˆ©ï¼Œé‡åˆ°é—®é¢˜é’ˆå¯¹æ€§å¤„ç†ã€‚\n\n`2.1` å½“é‡åˆ°ç¼–ç é—®é¢˜æ—¶ï¼šéœ€è¦æ·»åŠ é¢å¤–å‚æ•°***-encoding utf-8***\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/49f46c79b1626bc9fa8f8a326a9efa6c.png)\n\n`2.2` å½“é‡åˆ°ç¨‹åºåŒ…æ‰¾ä¸åˆ°æ—¶ï¼šéœ€è¦åœ¨***å·²ä¿®æ”¹.javaæ–‡ä»¶åŒçº§ç›®å½•ä¸‹***æ”¾ç½®ç¼ºå¤±çš„ jar åŒ…ï¼ˆå¯ä»¥ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥å¤šä¸ª jar åŒ…å‚æ•°ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/213dbc4980626c7aa6047fec3884f4a6.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/45f67a8f91ccdddbd528b08be84bb98c.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/4c096fedfc8e73d0a8f5fa17702a651f.png)\n\n\n`æ³¨æ„ï¼š`\nè¿™é‡Œæœ‰ä¸ªå‘ï¼Œå¦‚æœæ‰“åŒ…è¿‡ç¨‹æœ‰ä¾èµ– android jarï¼Œè¦æ±‚å¿…é¡»æ˜¯ android sdk ç›®å½•ä¸‹çš„ jarï¼ˆå®˜æ–¹çš„ï¼‰ï¼Œä¸èƒ½éšä¾¿æ‰¾ä¸€ä¸ªï¼ˆé˜‰å‰²ç‰ˆï¼‰ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/56247e2d3f5361ead4c49454c0a7a3bd.png)\n\n**3ã€æœ€ç»ˆå‘½ä»¤ï¼ˆå¯èƒ½æ˜¯è¿™æ ·ï¼Œä½†ä¸ä¸€å®šï¼‰**\n```java\njavac -encoding utf-8 -classpath [ä¾èµ–çš„1.jar;ä¾èµ–çš„2.jar;ä¾èµ–çš„3.jar;...] [å·²ä¿®æ”¹çš„å•ä¸ª .java æ–‡ä»¶æˆ–è€…å¾…è½¬æ¢çš„ .java æ–‡ä»¶æ‰€åœ¨ç›®å½•]\n```\n```java\njavac -encoding utf-8 -classpath android.jar;classes-dex2jar.jar GRAppStoreActivity.java\n```\n\nè¿™å°±æˆåŠŸæŠŠ java ä»£ç ç¼–è¯‘ä¸º class ä»£ç \n\n**4ã€æ›¿æ¢æ—§çš„ class æ–‡ä»¶å¹¶é‡æ–°æ‰“åŒ…æˆ jar**\n```java\njar cvf [æ–°æ–‡ä»¶å.jar] -C [å¾…æ‰“åŒ…çš„classæ–‡ä»¶ç›®å½•] [è¾“å‡ºåˆ°æŒ‡å®šç›®å½•]\n```\n```java\njar cvf jsonlili.jar -C primer/ .\n```\n\nåˆ°è¿™é‡Œå°±æ‰“åŒ…æˆåŠŸäº†ï¼Œå¦‚æœé‡åˆ°ä»€ä¹ˆé—®é¢˜æ¬¢è¿è¯„è®º :) å¦‚æœ jar ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…è¾ƒå¤šï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸é€‚åˆæ“ä½œçš„ï¼Œè€Œä¸”æ­¥éª¤ä¹Ÿå¾ˆç¹çï¼Œç¹ççš„äº‹æƒ…å¿…é¡»ç®€åŒ–ï¼Œé‡å¤çš„å·¥ä½œå¯ä»¥æµç¨‹åŒ–ï¼Œé‚£ä¹ˆä¸‹é¢ç®€æ˜ä»‹ç»åˆ©ç”¨å·¥å…·å®ç°ä¿®æ”¹ã€‚\n\n## æ–¹å¼äºŒï¼šjclasslib\n**1ã€æŠŠ jar åŒ…æ‹–å…¥å·¥å…·ä¸­æŸ¥çœ‹ä»£ç **\n\næˆ–è€…æ‰“å¼€æŸä¸ª class æ–‡ä»¶ï¼Œå¯¹äºæŸäº›ç®€å•ã€å°‘é‡çš„ä¿®æ”¹ä¹Ÿå¯ä»¥åƒæ–¹å¼ä¸€é‚£æ ·ï¼Œä¿®æ”¹ã€æ›¿æ¢ã€é‡æ–°æ‰“åŒ…ç”Ÿæˆç›®æ ‡ jar\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a6fd42dda952836b3119dff2faa988bd.png)\n\n**2ã€ä»£ç å®šä½å¹¶ä¿®æ”¹**\n\næˆ‘ä»¬ä»¥å¼€å¤´çš„å®¢æœå¼¹çª—æç¤ºä¸ºä¾‹ï¼Œåœ¨åŸå§‹ jar æ–‡ä»¶ä¸­å®šä½åˆ°`å®¢æœï¼š`å›ºå®šå‰ç¼€ï¼Œä»£ç ä½äºåœ¨ ***MyMainActivity*** ç±»çš„æŸä¸ªæ–¹æ³•ä¸­\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ff17b6d926a31e648c532263e6268792.png)\n\næˆ‘ä»¬çŸ¥é“åŒ¿åç±»ç»è¿‡ç¼–è¯‘åçš„ class æ–‡ä»¶æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶åå¾€å¾€å¸¦æœ‰`$`ç¬¦å·ï¼Œæˆ‘ä»¬è§£å‹ jar æ–‡ä»¶å¯ä»¥ç¼©å°æŸ¥æ‰¾èŒƒå›´ï¼Œä¸€ç•ªæŸ¥é˜…åå®šä½åˆ° `MyMainActivity$2$1.class` æ–‡ä»¶ä¸­ï¼ŒMethods -> onClick -> Codeï¼ˆè¿™é‡Œéœ€è¦å¯¹ class æ–‡ä»¶ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b9d17fbc33b11fa541911cf6e3d21416.png)\n\n> ldcï¼šæ˜¯ JVM æŒ‡ä»¤ï¼ŒæŒ‡ä»å¸¸é‡æ± ä¸­å–å‡ºå­—ç¬¦ä¸²å¸¸é‡å¹¶å‹å…¥æ“ä½œæ•°å †æ ˆä¸­ã€‚\n>\n> è¿™é‡Œæœ‰ä¸¤ä¸ªåŠ¨ä½œï¼Œå–å‡ºæ•°æ®ã€æŠŠæ•°æ®å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå¦‚æœä¸äº†è§£æ“ä½œæ•°æ ˆï¼Œå»ºè®®ç•¥è¯»å­—èŠ‚ç ç›¸å…³èµ„æ–™ï¼‰\n\n\nå…³äº class æ–‡ä»¶ç»“æ„å’Œå­—èŠ‚ç æŒ‡ä»¤æ¨èå®˜æ–¹æ–‡æ¡£ï¼š [å­—èŠ‚ç æŒ‡ä»¤](https://docs.oracle.com/javase/specs/jls/se19/html/index.html)\n\n**3ã€ä¿®æ”¹å¹¶ä¿å­˜**\nä»åˆšæ‰çš„ `ldc #61 <å®¢æœï¼š>` ä¸­ç‚¹å‡» `#61` è·³è½¬åˆ°å¸¸é‡ç¼–è¾‘å¤„ä¿®æ”¹å¹¶ä¿å­˜\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec7700f218da9a6d8d57445909ea9f05.png)\n\n\nåˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬å¯¹ class æ–‡ä»¶çš„ä¿®æ”¹å·²ç»å®Œæˆäº† :)\n\n# æœ€å\n\næˆ‘åœ¨æƒ³ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ›´å¤æ‚çš„é€»è¾‘ä»¥æ»¡è¶³æ›´å¤§çš„éœ€æ±‚å‘¢ï¼Ÿæ€ä¹ˆåŠï¼Ÿ\n\nä¸ªäººè§è§£ï¼Œé‚£å°±æ˜¯ï¼š**æŒç»­å­¦ä¹ ï¼Œå®è·µè¾“å‡º**\n\n\n1ã€æˆ‘å¯¹ JVM æŒ‡ä»¤ä¸ç†Ÿï¼Œå¯¹ä¿®æ”¹æ— ä»ä¸‹æ‰‹ï¼Œé‚£ä¹ˆæˆ‘æƒ³ä½ åº”è¯¥éœ€è¦è¿›ä¸€æ­¥äº†è§£ class æ–‡ä»¶ç»“æ„ï¼ŒJVM æŒ‡ä»¤è¯´æ˜ï¼›\nå»å“ªå­¦ä¹ ï¼Ÿæ‰¾å®˜æ–¹èµ„æºã€GitHub å­¦ä¹ èµ„æºã€é˜…è¯»å¤§ä½¬çš„æ–‡ç« ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\n\n2ã€å·¥å…·ä½¿ç”¨çš„æŒæ¡ï¼Œä¸Šé¢æåˆ°çš„ jclasslib å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ç æŸ¥çœ‹ã€ç¼–è¾‘å·¥å…·ï¼Œå·¥å…·æ˜¯å¾€å¾€æœ‰ç«å“å­˜åœ¨ï¼Œ\næˆ‘ä»Šå¤©ä½¿ç”¨çš„æ˜¯ jclasslibï¼Œå¯éšç€è‡ªæˆ‘è§†é‡çš„æ‰©å±•ï¼Œæˆ‘æ˜å¤©å¯èƒ½åœ¨ä½¿ç”¨ Recafï¼ˆä¹Ÿæ˜¯å­—èŠ‚ç ç¼–è¾‘å·¥å…·ï¼‰\n\n\n**é™„åŠ ï¼š**\n- [jclasslib bytecode editor](https://github.com/ingokegel/jclasslib) \n- [JD-GUI](https://github.com/java-decompiler/jd-gui/releases)\n- [åœ¨çº¿ç ´è§£å·¥å…·åŒ…ï¼š](https://down.52pojie.cn/Tools/)\n\n\n","source":"_posts/page- å’‹ä»¬ä¸€èµ·ä¿®æ”¹ class æ–‡ä»¶.md","raw":"---\ntitle: å’‹ä»¬ä¸€èµ·ä¿®æ”¹ class æ–‡ä»¶\ncatalog: true\ndate: 2022-09-25 20:45:24\nsubtitle: ä¿®æ”¹ç¬¬ä¸‰æ–¹ jar åŒ…æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿™æ˜¯ä¸€ç§æ–¹å¼ï¼\nheader-img: /img/220923_classmodify/class_bg.webp\ntags: å­—èŠ‚ç \ncategories:\nsticky: 2\n---\n\n# ä½ æœ‰é‡åˆ°é€‚ç”¨çš„åœºæ™¯å—\n\n![æ·±å¤§æ‘é•¿.jpg](https://img-blog.csdnimg.cn/img_convert/b489e163aa127c5f7eb59575079df4d6.png)\n\nä½ æœ‰æ²¡æœ‰é‡åˆ°éœ€è¦ä¿®æ”¹ class æ–‡ä»¶é‡æ–°æ‰“åŒ…çš„åœºæ™¯å‘¢ï¼Ÿå·§å¾—å¾ˆï¼Œæœ€è¿‘åˆšå¥½é‡åˆ°éœ€è¦ä¿®æ”¹ä¸€ä¸ªå·²å­˜åœ¨çš„ jar åŒ…ä»¥æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œä¸è¿‡æœ¬æ¬¡ä¿®æ”¹çš„æ˜¯å­—ç¬¦å¸¸é‡ï¼Œå°šæœªæ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„é€»è¾‘ï¼Œè®°å½•ä¸‹æ­¤åˆ»ï¼Œå¦‚ä½•ä¿®æ”¹ï¼Ÿå¦‚ä½•å¿«é€Ÿä¿®æ”¹å®Œæˆéœ€æ±‚ï¼Ÿå¸Œæœ›å¯ä»¥æŠ›ç –å¼•ç‰ï¼Œå‰©ä¸‹çš„è¾ƒä¸ºå¤æ‚çš„é€»è¾‘ä¿®æ”¹å°±äº¤ç»™ä½ ä»¬äº† :)\n\n**ä¸¾ä¸ªä¾‹å­ï¼š**\n\né—®é¢˜æè¿°ï¼š\n    1ã€æŸå¼¹çª—æ–‡æœ¬æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆæ–‡å­—å†—ä½™ï¼Œæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/39cb62ad15a8135fced9b45bb6e0b58e.png)\n\nå…³äºæè¿°ï¼š\n    1ã€æ­¤å¼¹çª—ä»£ç æ˜¯æŸç¬¬ä¸‰æ–¹ jar åŒ…\n    2ã€æ–‡å­—æ˜¾ç¤ºè¦æ±‚åº”è¯¥æ˜¯ï¼š `å®¢æœï¼šQQå·`\n    3ã€ä½†å®é™…æƒ…å†µç¬¬ä¸‰æ–¹ jar åŒ…åœ¨æ˜¾ç¤ºå†…å®¹å‰åŠ äº†å‰ç¼€ `å®¢æœ`ï¼Œä¸ç¬¦åˆè¦æ±‚\n\né¢„æœŸæ•ˆæœï¼š\n    1ã€æ˜¾ç¤ºæ•ˆæœï¼š`å®¢æœQQï¼š2464113103`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/be9836c62729cd6fd5904c8ff4dbcfd5.png)\n\n\né¢„æœŸéœ€æ±‚å¾ˆæ¸…æ™°ï¼Œä»£ç ä¿®æ”¹ä¹Ÿè·Ÿæ¸…æ™°ï¼ˆå»é™¤ç¬¬ä¸‰æ–¹ jar åŒ…å†…å®¹å‰ç¼€ `å®¢æœï¼š`ï¼Œå®ç°å†…å®¹çµæ´»é…ç½®ï¼‰\n\n\n# æ¸©æ•… jar å‘½ä»¤ä½¿ç”¨\n\n1ã€å‘½ä»¤æŸ¥çœ‹ä½¿ç”¨å¸®åŠ© jar -h\n```java\nç”¨æ³•: jar {ctxui}[vfmn0PMe] [jar-file] [manifest-file] [entry-point] [-C dir] files ...\\\né€‰é¡¹:\n    -c  åˆ›å»ºæ–°æ¡£æ¡ˆ\n    -t  åˆ—å‡ºæ¡£æ¡ˆç›®å½•\n    -x  ä»æ¡£æ¡ˆä¸­æå–æŒ‡å®šçš„ (æˆ–æ‰€æœ‰) æ–‡ä»¶\n    -u  æ›´æ–°ç°æœ‰æ¡£æ¡ˆ\n    -v  åœ¨æ ‡å‡†è¾“å‡ºä¸­ç”Ÿæˆè¯¦ç»†è¾“å‡º\n    -f  æŒ‡å®šæ¡£æ¡ˆæ–‡ä»¶å\n    -m  åŒ…å«æŒ‡å®šæ¸…å•æ–‡ä»¶ä¸­çš„æ¸…å•ä¿¡æ¯\n    -n  åˆ›å»ºæ–°æ¡£æ¡ˆåæ‰§è¡Œ Pack200 è§„èŒƒåŒ–\n    -e  ä¸ºæ†ç»‘åˆ°å¯æ‰§è¡Œ jar æ–‡ä»¶çš„ç‹¬ç«‹åº”ç”¨ç¨‹åº\n        æŒ‡å®šåº”ç”¨ç¨‹åºå…¥å£ç‚¹\n    -0  ä»…å­˜å‚¨; ä¸ä½¿ç”¨ä»»ä½• ZIP å‹ç¼©\n    -P  ä¿ç•™æ–‡ä»¶åä¸­çš„å‰å¯¼ '/' (ç»å¯¹è·¯å¾„) å’Œ \"..\" (çˆ¶ç›®å½•) ç»„ä»¶\n    -M  ä¸åˆ›å»ºæ¡ç›®çš„æ¸…å•æ–‡ä»¶\n    -i  ä¸ºæŒ‡å®šçš„ jar æ–‡ä»¶ç”Ÿæˆç´¢å¼•ä¿¡æ¯\n    -C  æ›´æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•å¹¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶\n\nå¦‚æœä»»ä½•æ–‡ä»¶ä¸ºç›®å½•, åˆ™å¯¹å…¶è¿›è¡Œé€’å½’å¤„ç†ã€‚æ¸…å•æ–‡ä»¶å, æ¡£æ¡ˆæ–‡ä»¶åå’Œå…¥å£ç‚¹åç§°çš„æŒ‡å®šé¡ºåº\nä¸ 'm', 'f' å’Œ 'e' æ ‡è®°çš„æŒ‡å®šé¡ºåºç›¸åŒã€‚\n```\n\n2ã€æ‰“åŒ…ç”Ÿæˆ jar\nå°† class æ–‡ä»¶æ‰“åŒ…ä¸º jar æ–‡ä»¶\n```java\njar cvf classes.jar Foo.class Bar.class\n```\n\nå°† folder/ ç›®å½•ä¸‹çš„æ‰€æœ‰ class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶\n```java\njar cvf classes.jar -C folder/ .\n```\n\n3ã€æŸ¥çœ‹ jar æ–‡ä»¶åˆ—è¡¨\n```java\njar -tvf classes.jar\n```\n\n4ã€è§£å‹ jar æ–‡ä»¶\n```java\njar -xvf classes.jar\n```\n\n# å¼€å§‹ä¿®æ”¹ jar\n\næ–¹å¼ä¸€ä¸æ¨èï¼Œåªæ˜¯æƒ³è®©ä½ çŸ¥é“è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚\n\n## æ–¹å¼ä¸€ï¼šjavac\n\n**1ã€ä½¿ç”¨ JD-GUI æ‰“å¼€ jar æ–‡ä»¶å¹¶å¯¼å‡º java ä»£ç **\n\n**2ã€ä½¿ç”¨ javac å‘½ä»¤æŠŠ .java æ–‡ä»¶è½¬æ¢ä¸º .class æ–‡ä»¶**\n```java\njavac -classpath [å¾…ç”Ÿæˆçš„æ–‡ä»¶å.jar] [å·²ä¿®æ”¹çš„æ–‡ä»¶.java]\n```\n\nå®é™…æ“ä½œè¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ javac å‘½ä»¤å¾€å¾€ä¸æ˜¯è‡ªå·±æœŸæœ›çš„é‚£ä¹ˆé¡ºåˆ©ï¼Œé‡åˆ°é—®é¢˜é’ˆå¯¹æ€§å¤„ç†ã€‚\n\n`2.1` å½“é‡åˆ°ç¼–ç é—®é¢˜æ—¶ï¼šéœ€è¦æ·»åŠ é¢å¤–å‚æ•°***-encoding utf-8***\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/49f46c79b1626bc9fa8f8a326a9efa6c.png)\n\n`2.2` å½“é‡åˆ°ç¨‹åºåŒ…æ‰¾ä¸åˆ°æ—¶ï¼šéœ€è¦åœ¨***å·²ä¿®æ”¹.javaæ–‡ä»¶åŒçº§ç›®å½•ä¸‹***æ”¾ç½®ç¼ºå¤±çš„ jar åŒ…ï¼ˆå¯ä»¥ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥å¤šä¸ª jar åŒ…å‚æ•°ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/213dbc4980626c7aa6047fec3884f4a6.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/45f67a8f91ccdddbd528b08be84bb98c.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/4c096fedfc8e73d0a8f5fa17702a651f.png)\n\n\n`æ³¨æ„ï¼š`\nè¿™é‡Œæœ‰ä¸ªå‘ï¼Œå¦‚æœæ‰“åŒ…è¿‡ç¨‹æœ‰ä¾èµ– android jarï¼Œè¦æ±‚å¿…é¡»æ˜¯ android sdk ç›®å½•ä¸‹çš„ jarï¼ˆå®˜æ–¹çš„ï¼‰ï¼Œä¸èƒ½éšä¾¿æ‰¾ä¸€ä¸ªï¼ˆé˜‰å‰²ç‰ˆï¼‰ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/56247e2d3f5361ead4c49454c0a7a3bd.png)\n\n**3ã€æœ€ç»ˆå‘½ä»¤ï¼ˆå¯èƒ½æ˜¯è¿™æ ·ï¼Œä½†ä¸ä¸€å®šï¼‰**\n```java\njavac -encoding utf-8 -classpath [ä¾èµ–çš„1.jar;ä¾èµ–çš„2.jar;ä¾èµ–çš„3.jar;...] [å·²ä¿®æ”¹çš„å•ä¸ª .java æ–‡ä»¶æˆ–è€…å¾…è½¬æ¢çš„ .java æ–‡ä»¶æ‰€åœ¨ç›®å½•]\n```\n```java\njavac -encoding utf-8 -classpath android.jar;classes-dex2jar.jar GRAppStoreActivity.java\n```\n\nè¿™å°±æˆåŠŸæŠŠ java ä»£ç ç¼–è¯‘ä¸º class ä»£ç \n\n**4ã€æ›¿æ¢æ—§çš„ class æ–‡ä»¶å¹¶é‡æ–°æ‰“åŒ…æˆ jar**\n```java\njar cvf [æ–°æ–‡ä»¶å.jar] -C [å¾…æ‰“åŒ…çš„classæ–‡ä»¶ç›®å½•] [è¾“å‡ºåˆ°æŒ‡å®šç›®å½•]\n```\n```java\njar cvf jsonlili.jar -C primer/ .\n```\n\nåˆ°è¿™é‡Œå°±æ‰“åŒ…æˆåŠŸäº†ï¼Œå¦‚æœé‡åˆ°ä»€ä¹ˆé—®é¢˜æ¬¢è¿è¯„è®º :) å¦‚æœ jar ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…è¾ƒå¤šï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸é€‚åˆæ“ä½œçš„ï¼Œè€Œä¸”æ­¥éª¤ä¹Ÿå¾ˆç¹çï¼Œç¹ççš„äº‹æƒ…å¿…é¡»ç®€åŒ–ï¼Œé‡å¤çš„å·¥ä½œå¯ä»¥æµç¨‹åŒ–ï¼Œé‚£ä¹ˆä¸‹é¢ç®€æ˜ä»‹ç»åˆ©ç”¨å·¥å…·å®ç°ä¿®æ”¹ã€‚\n\n## æ–¹å¼äºŒï¼šjclasslib\n**1ã€æŠŠ jar åŒ…æ‹–å…¥å·¥å…·ä¸­æŸ¥çœ‹ä»£ç **\n\næˆ–è€…æ‰“å¼€æŸä¸ª class æ–‡ä»¶ï¼Œå¯¹äºæŸäº›ç®€å•ã€å°‘é‡çš„ä¿®æ”¹ä¹Ÿå¯ä»¥åƒæ–¹å¼ä¸€é‚£æ ·ï¼Œä¿®æ”¹ã€æ›¿æ¢ã€é‡æ–°æ‰“åŒ…ç”Ÿæˆç›®æ ‡ jar\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a6fd42dda952836b3119dff2faa988bd.png)\n\n**2ã€ä»£ç å®šä½å¹¶ä¿®æ”¹**\n\næˆ‘ä»¬ä»¥å¼€å¤´çš„å®¢æœå¼¹çª—æç¤ºä¸ºä¾‹ï¼Œåœ¨åŸå§‹ jar æ–‡ä»¶ä¸­å®šä½åˆ°`å®¢æœï¼š`å›ºå®šå‰ç¼€ï¼Œä»£ç ä½äºåœ¨ ***MyMainActivity*** ç±»çš„æŸä¸ªæ–¹æ³•ä¸­\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ff17b6d926a31e648c532263e6268792.png)\n\næˆ‘ä»¬çŸ¥é“åŒ¿åç±»ç»è¿‡ç¼–è¯‘åçš„ class æ–‡ä»¶æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶åå¾€å¾€å¸¦æœ‰`$`ç¬¦å·ï¼Œæˆ‘ä»¬è§£å‹ jar æ–‡ä»¶å¯ä»¥ç¼©å°æŸ¥æ‰¾èŒƒå›´ï¼Œä¸€ç•ªæŸ¥é˜…åå®šä½åˆ° `MyMainActivity$2$1.class` æ–‡ä»¶ä¸­ï¼ŒMethods -> onClick -> Codeï¼ˆè¿™é‡Œéœ€è¦å¯¹ class æ–‡ä»¶ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b9d17fbc33b11fa541911cf6e3d21416.png)\n\n> ldcï¼šæ˜¯ JVM æŒ‡ä»¤ï¼ŒæŒ‡ä»å¸¸é‡æ± ä¸­å–å‡ºå­—ç¬¦ä¸²å¸¸é‡å¹¶å‹å…¥æ“ä½œæ•°å †æ ˆä¸­ã€‚\n>\n> è¿™é‡Œæœ‰ä¸¤ä¸ªåŠ¨ä½œï¼Œå–å‡ºæ•°æ®ã€æŠŠæ•°æ®å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå¦‚æœä¸äº†è§£æ“ä½œæ•°æ ˆï¼Œå»ºè®®ç•¥è¯»å­—èŠ‚ç ç›¸å…³èµ„æ–™ï¼‰\n\n\nå…³äº class æ–‡ä»¶ç»“æ„å’Œå­—èŠ‚ç æŒ‡ä»¤æ¨èå®˜æ–¹æ–‡æ¡£ï¼š [å­—èŠ‚ç æŒ‡ä»¤](https://docs.oracle.com/javase/specs/jls/se19/html/index.html)\n\n**3ã€ä¿®æ”¹å¹¶ä¿å­˜**\nä»åˆšæ‰çš„ `ldc #61 <å®¢æœï¼š>` ä¸­ç‚¹å‡» `#61` è·³è½¬åˆ°å¸¸é‡ç¼–è¾‘å¤„ä¿®æ”¹å¹¶ä¿å­˜\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec7700f218da9a6d8d57445909ea9f05.png)\n\n\nåˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬å¯¹ class æ–‡ä»¶çš„ä¿®æ”¹å·²ç»å®Œæˆäº† :)\n\n# æœ€å\n\næˆ‘åœ¨æƒ³ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ›´å¤æ‚çš„é€»è¾‘ä»¥æ»¡è¶³æ›´å¤§çš„éœ€æ±‚å‘¢ï¼Ÿæ€ä¹ˆåŠï¼Ÿ\n\nä¸ªäººè§è§£ï¼Œé‚£å°±æ˜¯ï¼š**æŒç»­å­¦ä¹ ï¼Œå®è·µè¾“å‡º**\n\n\n1ã€æˆ‘å¯¹ JVM æŒ‡ä»¤ä¸ç†Ÿï¼Œå¯¹ä¿®æ”¹æ— ä»ä¸‹æ‰‹ï¼Œé‚£ä¹ˆæˆ‘æƒ³ä½ åº”è¯¥éœ€è¦è¿›ä¸€æ­¥äº†è§£ class æ–‡ä»¶ç»“æ„ï¼ŒJVM æŒ‡ä»¤è¯´æ˜ï¼›\nå»å“ªå­¦ä¹ ï¼Ÿæ‰¾å®˜æ–¹èµ„æºã€GitHub å­¦ä¹ èµ„æºã€é˜…è¯»å¤§ä½¬çš„æ–‡ç« ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\n\n2ã€å·¥å…·ä½¿ç”¨çš„æŒæ¡ï¼Œä¸Šé¢æåˆ°çš„ jclasslib å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ç æŸ¥çœ‹ã€ç¼–è¾‘å·¥å…·ï¼Œå·¥å…·æ˜¯å¾€å¾€æœ‰ç«å“å­˜åœ¨ï¼Œ\næˆ‘ä»Šå¤©ä½¿ç”¨çš„æ˜¯ jclasslibï¼Œå¯éšç€è‡ªæˆ‘è§†é‡çš„æ‰©å±•ï¼Œæˆ‘æ˜å¤©å¯èƒ½åœ¨ä½¿ç”¨ Recafï¼ˆä¹Ÿæ˜¯å­—èŠ‚ç ç¼–è¾‘å·¥å…·ï¼‰\n\n\n**é™„åŠ ï¼š**\n- [jclasslib bytecode editor](https://github.com/ingokegel/jclasslib) \n- [JD-GUI](https://github.com/java-decompiler/jd-gui/releases)\n- [åœ¨çº¿ç ´è§£å·¥å…·åŒ…ï¼š](https://down.52pojie.cn/Tools/)\n\n\n","slug":"page-å’‹ä»¬ä¸€èµ·ä¿®æ”¹-class-æ–‡ä»¶","published":1,"updated":"2022-09-25T12:45:24.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsj0001gaqpb9qgfwmi","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>ä½ æœ‰é‡åˆ°é€‚ç”¨çš„åœºæ™¯å—</h1>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b489e163aa127c5f7eb59575079df4d6.png\" alt=\"æ·±å¤§æ‘é•¿.jpg\"></p>\n<p>ä½ æœ‰æ²¡æœ‰é‡åˆ°éœ€è¦ä¿®æ”¹ class æ–‡ä»¶é‡æ–°æ‰“åŒ…çš„åœºæ™¯å‘¢ï¼Ÿå·§å¾—å¾ˆï¼Œæœ€è¿‘åˆšå¥½é‡åˆ°éœ€è¦ä¿®æ”¹ä¸€ä¸ªå·²å­˜åœ¨çš„ jar åŒ…ä»¥æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œä¸è¿‡æœ¬æ¬¡ä¿®æ”¹çš„æ˜¯å­—ç¬¦å¸¸é‡ï¼Œå°šæœªæ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„é€»è¾‘ï¼Œè®°å½•ä¸‹æ­¤åˆ»ï¼Œå¦‚ä½•ä¿®æ”¹ï¼Ÿå¦‚ä½•å¿«é€Ÿä¿®æ”¹å®Œæˆéœ€æ±‚ï¼Ÿå¸Œæœ›å¯ä»¥æŠ›ç –å¼•ç‰ï¼Œå‰©ä¸‹çš„è¾ƒä¸ºå¤æ‚çš„é€»è¾‘ä¿®æ”¹å°±äº¤ç»™ä½ ä»¬äº† :)</p>\n<p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p>\n<p>é—®é¢˜æè¿°ï¼š<br>\n1ã€æŸå¼¹çª—æ–‡æœ¬æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆæ–‡å­—å†—ä½™ï¼Œæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/39cb62ad15a8135fced9b45bb6e0b58e.png\" alt=\"image.png\"></p>\n<p>å…³äºæè¿°ï¼š<br>\n1ã€æ­¤å¼¹çª—ä»£ç æ˜¯æŸç¬¬ä¸‰æ–¹ jar åŒ…<br>\n2ã€æ–‡å­—æ˜¾ç¤ºè¦æ±‚åº”è¯¥æ˜¯ï¼š <code>å®¢æœï¼šQQå·</code><br>\n3ã€ä½†å®é™…æƒ…å†µç¬¬ä¸‰æ–¹ jar åŒ…åœ¨æ˜¾ç¤ºå†…å®¹å‰åŠ äº†å‰ç¼€ <code>å®¢æœ</code>ï¼Œä¸ç¬¦åˆè¦æ±‚</p>\n<p>é¢„æœŸæ•ˆæœï¼š<br>\n1ã€æ˜¾ç¤ºæ•ˆæœï¼š<code>å®¢æœQQï¼š2464113103</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/be9836c62729cd6fd5904c8ff4dbcfd5.png\" alt=\"image.png\"></p>\n<p>é¢„æœŸéœ€æ±‚å¾ˆæ¸…æ™°ï¼Œä»£ç ä¿®æ”¹ä¹Ÿè·Ÿæ¸…æ™°ï¼ˆå»é™¤ç¬¬ä¸‰æ–¹ jar åŒ…å†…å®¹å‰ç¼€ <code>å®¢æœï¼š</code>ï¼Œå®ç°å†…å®¹çµæ´»é…ç½®ï¼‰</p>\n<h1>æ¸©æ•… jar å‘½ä»¤ä½¿ç”¨</h1>\n<p>1ã€å‘½ä»¤æŸ¥çœ‹ä½¿ç”¨å¸®åŠ© jar -h</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ç”¨æ³•: jar &#123;ctxui&#125;[vfmn0PMe] [jar-file] [manifest-file] [entry-point] [-C dir] files ...\\</span><br><span class=\"line\">é€‰é¡¹:</span><br><span class=\"line\">    -c  åˆ›å»ºæ–°æ¡£æ¡ˆ</span><br><span class=\"line\">    -t  åˆ—å‡ºæ¡£æ¡ˆç›®å½•</span><br><span class=\"line\">    -x  ä»æ¡£æ¡ˆä¸­æå–æŒ‡å®šçš„ (æˆ–æ‰€æœ‰) æ–‡ä»¶</span><br><span class=\"line\">    -u  æ›´æ–°ç°æœ‰æ¡£æ¡ˆ</span><br><span class=\"line\">    -v  åœ¨æ ‡å‡†è¾“å‡ºä¸­ç”Ÿæˆè¯¦ç»†è¾“å‡º</span><br><span class=\"line\">    -f  æŒ‡å®šæ¡£æ¡ˆæ–‡ä»¶å</span><br><span class=\"line\">    -m  åŒ…å«æŒ‡å®šæ¸…å•æ–‡ä»¶ä¸­çš„æ¸…å•ä¿¡æ¯</span><br><span class=\"line\">    -n  åˆ›å»ºæ–°æ¡£æ¡ˆåæ‰§è¡Œ Pack200 è§„èŒƒåŒ–</span><br><span class=\"line\">    -e  ä¸ºæ†ç»‘åˆ°å¯æ‰§è¡Œ jar æ–‡ä»¶çš„ç‹¬ç«‹åº”ç”¨ç¨‹åº</span><br><span class=\"line\">        æŒ‡å®šåº”ç”¨ç¨‹åºå…¥å£ç‚¹</span><br><span class=\"line\">    -<span class=\"number\">0</span>  ä»…å­˜å‚¨; ä¸ä½¿ç”¨ä»»ä½• ZIP å‹ç¼©</span><br><span class=\"line\">    -P  ä¿ç•™æ–‡ä»¶åä¸­çš„å‰å¯¼ <span class=\"string\">&#x27;/&#x27;</span> (ç»å¯¹è·¯å¾„) å’Œ <span class=\"string\">&quot;..&quot;</span> (çˆ¶ç›®å½•) ç»„ä»¶</span><br><span class=\"line\">    -M  ä¸åˆ›å»ºæ¡ç›®çš„æ¸…å•æ–‡ä»¶</span><br><span class=\"line\">    -i  ä¸ºæŒ‡å®šçš„ jar æ–‡ä»¶ç”Ÿæˆç´¢å¼•ä¿¡æ¯</span><br><span class=\"line\">    -C  æ›´æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•å¹¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶</span><br><span class=\"line\"></span><br><span class=\"line\">å¦‚æœä»»ä½•æ–‡ä»¶ä¸ºç›®å½•, åˆ™å¯¹å…¶è¿›è¡Œé€’å½’å¤„ç†ã€‚æ¸…å•æ–‡ä»¶å, æ¡£æ¡ˆæ–‡ä»¶åå’Œå…¥å£ç‚¹åç§°çš„æŒ‡å®šé¡ºåº</span><br><span class=\"line\">ä¸ <span class=\"string\">&#x27;m&#x27;</span>, <span class=\"string\">&#x27;f&#x27;</span> å’Œ <span class=\"string\">&#x27;e&#x27;</span> æ ‡è®°çš„æŒ‡å®šé¡ºåºç›¸åŒã€‚</span><br></pre></td></tr></table></figure>\n<p>2ã€æ‰“åŒ…ç”Ÿæˆ jar<br>\nå°† class æ–‡ä»¶æ‰“åŒ…ä¸º jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf classes.jar Foo.class Bar.class</span><br></pre></td></tr></table></figure>\n<p>å°† folder/ ç›®å½•ä¸‹çš„æ‰€æœ‰ class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf classes.jar -C folder/ .</span><br></pre></td></tr></table></figure>\n<p>3ã€æŸ¥çœ‹ jar æ–‡ä»¶åˆ—è¡¨</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar -tvf classes.jar</span><br></pre></td></tr></table></figure>\n<p>4ã€è§£å‹ jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar -xvf classes.jar</span><br></pre></td></tr></table></figure>\n<h1>å¼€å§‹ä¿®æ”¹ jar</h1>\n<p>æ–¹å¼ä¸€ä¸æ¨èï¼Œåªæ˜¯æƒ³è®©ä½ çŸ¥é“è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p>\n<h2 id=\"æ–¹å¼ä¸€ï¼šjavac\">æ–¹å¼ä¸€ï¼šjavac</h2>\n<p><strong>1ã€ä½¿ç”¨ JD-GUI æ‰“å¼€ jar æ–‡ä»¶å¹¶å¯¼å‡º java ä»£ç </strong></p>\n<p><strong>2ã€ä½¿ç”¨ javac å‘½ä»¤æŠŠ .java æ–‡ä»¶è½¬æ¢ä¸º .class æ–‡ä»¶</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -classpath [å¾…ç”Ÿæˆçš„æ–‡ä»¶å.jar] [å·²ä¿®æ”¹çš„æ–‡ä»¶.java]</span><br></pre></td></tr></table></figure>\n<p>å®é™…æ“ä½œè¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ javac å‘½ä»¤å¾€å¾€ä¸æ˜¯è‡ªå·±æœŸæœ›çš„é‚£ä¹ˆé¡ºåˆ©ï¼Œé‡åˆ°é—®é¢˜é’ˆå¯¹æ€§å¤„ç†ã€‚</p>\n<p><code>2.1</code> å½“é‡åˆ°ç¼–ç é—®é¢˜æ—¶ï¼šéœ€è¦æ·»åŠ é¢å¤–å‚æ•°***-encoding utf-8***</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/49f46c79b1626bc9fa8f8a326a9efa6c.png\" alt=\"image.png\"></p>\n<p><code>2.2</code> å½“é‡åˆ°ç¨‹åºåŒ…æ‰¾ä¸åˆ°æ—¶ï¼šéœ€è¦åœ¨<em><strong>å·²ä¿®æ”¹.javaæ–‡ä»¶åŒçº§ç›®å½•ä¸‹</strong></em>æ”¾ç½®ç¼ºå¤±çš„ jar åŒ…ï¼ˆå¯ä»¥ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥å¤šä¸ª jar åŒ…å‚æ•°ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/213dbc4980626c7aa6047fec3884f4a6.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/45f67a8f91ccdddbd528b08be84bb98c.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/4c096fedfc8e73d0a8f5fa17702a651f.png\" alt=\"image.png\"></p>\n<p><code>æ³¨æ„ï¼š</code><br>\nè¿™é‡Œæœ‰ä¸ªå‘ï¼Œå¦‚æœæ‰“åŒ…è¿‡ç¨‹æœ‰ä¾èµ– android jarï¼Œè¦æ±‚å¿…é¡»æ˜¯ android sdk ç›®å½•ä¸‹çš„ jarï¼ˆå®˜æ–¹çš„ï¼‰ï¼Œä¸èƒ½éšä¾¿æ‰¾ä¸€ä¸ªï¼ˆé˜‰å‰²ç‰ˆï¼‰ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/56247e2d3f5361ead4c49454c0a7a3bd.png\" alt=\"image.png\"></p>\n<p><strong>3ã€æœ€ç»ˆå‘½ä»¤ï¼ˆå¯èƒ½æ˜¯è¿™æ ·ï¼Œä½†ä¸ä¸€å®šï¼‰</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -encoding utf-<span class=\"number\">8</span> -classpath [ä¾èµ–çš„<span class=\"number\">1.</span>jar;ä¾èµ–çš„<span class=\"number\">2.</span>jar;ä¾èµ–çš„<span class=\"number\">3.</span>jar;...] [å·²ä¿®æ”¹çš„å•ä¸ª .java æ–‡ä»¶æˆ–è€…å¾…è½¬æ¢çš„ .java æ–‡ä»¶æ‰€åœ¨ç›®å½•]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -encoding utf-<span class=\"number\">8</span> -classpath android.jar;classes-dex2jar.jar GRAppStoreActivity.java</span><br></pre></td></tr></table></figure>\n<p>è¿™å°±æˆåŠŸæŠŠ java ä»£ç ç¼–è¯‘ä¸º class ä»£ç </p>\n<p><strong>4ã€æ›¿æ¢æ—§çš„ class æ–‡ä»¶å¹¶é‡æ–°æ‰“åŒ…æˆ jar</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf [æ–°æ–‡ä»¶å.jar] -C [å¾…æ‰“åŒ…çš„classæ–‡ä»¶ç›®å½•] [è¾“å‡ºåˆ°æŒ‡å®šç›®å½•]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf jsonlili.jar -C primer/ .</span><br></pre></td></tr></table></figure>\n<p>åˆ°è¿™é‡Œå°±æ‰“åŒ…æˆåŠŸäº†ï¼Œå¦‚æœé‡åˆ°ä»€ä¹ˆé—®é¢˜æ¬¢è¿è¯„è®º :) å¦‚æœ jar ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…è¾ƒå¤šï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸é€‚åˆæ“ä½œçš„ï¼Œè€Œä¸”æ­¥éª¤ä¹Ÿå¾ˆç¹çï¼Œç¹ççš„äº‹æƒ…å¿…é¡»ç®€åŒ–ï¼Œé‡å¤çš„å·¥ä½œå¯ä»¥æµç¨‹åŒ–ï¼Œé‚£ä¹ˆä¸‹é¢ç®€æ˜ä»‹ç»åˆ©ç”¨å·¥å…·å®ç°ä¿®æ”¹ã€‚</p>\n<h2 id=\"æ–¹å¼äºŒï¼šjclasslib\">æ–¹å¼äºŒï¼šjclasslib</h2>\n<p><strong>1ã€æŠŠ jar åŒ…æ‹–å…¥å·¥å…·ä¸­æŸ¥çœ‹ä»£ç </strong></p>\n<p>æˆ–è€…æ‰“å¼€æŸä¸ª class æ–‡ä»¶ï¼Œå¯¹äºæŸäº›ç®€å•ã€å°‘é‡çš„ä¿®æ”¹ä¹Ÿå¯ä»¥åƒæ–¹å¼ä¸€é‚£æ ·ï¼Œä¿®æ”¹ã€æ›¿æ¢ã€é‡æ–°æ‰“åŒ…ç”Ÿæˆç›®æ ‡ jar</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a6fd42dda952836b3119dff2faa988bd.png\" alt=\"image.png\"></p>\n<p><strong>2ã€ä»£ç å®šä½å¹¶ä¿®æ”¹</strong></p>\n<p>æˆ‘ä»¬ä»¥å¼€å¤´çš„å®¢æœå¼¹çª—æç¤ºä¸ºä¾‹ï¼Œåœ¨åŸå§‹ jar æ–‡ä»¶ä¸­å®šä½åˆ°<code>å®¢æœï¼š</code>å›ºå®šå‰ç¼€ï¼Œä»£ç ä½äºåœ¨ <em><strong>MyMainActivity</strong></em> ç±»çš„æŸä¸ªæ–¹æ³•ä¸­</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ff17b6d926a31e648c532263e6268792.png\" alt=\"image.png\"></p>\n<p>æˆ‘ä»¬çŸ¥é“åŒ¿åç±»ç»è¿‡ç¼–è¯‘åçš„ class æ–‡ä»¶æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶åå¾€å¾€å¸¦æœ‰<code>$</code>ç¬¦å·ï¼Œæˆ‘ä»¬è§£å‹ jar æ–‡ä»¶å¯ä»¥ç¼©å°æŸ¥æ‰¾èŒƒå›´ï¼Œä¸€ç•ªæŸ¥é˜…åå®šä½åˆ° <code>MyMainActivity$2$1.class</code> æ–‡ä»¶ä¸­ï¼ŒMethods -&gt; onClick -&gt; Codeï¼ˆè¿™é‡Œéœ€è¦å¯¹ class æ–‡ä»¶ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b9d17fbc33b11fa541911cf6e3d21416.png\" alt=\"image.png\"></p>\n<blockquote>\n<p>ldcï¼šæ˜¯ JVM æŒ‡ä»¤ï¼ŒæŒ‡ä»å¸¸é‡æ± ä¸­å–å‡ºå­—ç¬¦ä¸²å¸¸é‡å¹¶å‹å…¥æ“ä½œæ•°å †æ ˆä¸­ã€‚</p>\n<p>è¿™é‡Œæœ‰ä¸¤ä¸ªåŠ¨ä½œï¼Œå–å‡ºæ•°æ®ã€æŠŠæ•°æ®å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå¦‚æœä¸äº†è§£æ“ä½œæ•°æ ˆï¼Œå»ºè®®ç•¥è¯»å­—èŠ‚ç ç›¸å…³èµ„æ–™ï¼‰</p>\n</blockquote>\n<p>å…³äº class æ–‡ä»¶ç»“æ„å’Œå­—èŠ‚ç æŒ‡ä»¤æ¨èå®˜æ–¹æ–‡æ¡£ï¼š <a href=\"https://docs.oracle.com/javase/specs/jls/se19/html/index.html\">å­—èŠ‚ç æŒ‡ä»¤</a></p>\n<p><strong>3ã€ä¿®æ”¹å¹¶ä¿å­˜</strong><br>\nä»åˆšæ‰çš„ <code>ldc #61 &lt;å®¢æœï¼š&gt;</code> ä¸­ç‚¹å‡» <code>#61</code> è·³è½¬åˆ°å¸¸é‡ç¼–è¾‘å¤„ä¿®æ”¹å¹¶ä¿å­˜</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec7700f218da9a6d8d57445909ea9f05.png\" alt=\"image.png\"></p>\n<p>åˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬å¯¹ class æ–‡ä»¶çš„ä¿®æ”¹å·²ç»å®Œæˆäº† :)</p>\n<h1>æœ€å</h1>\n<p>æˆ‘åœ¨æƒ³ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ›´å¤æ‚çš„é€»è¾‘ä»¥æ»¡è¶³æ›´å¤§çš„éœ€æ±‚å‘¢ï¼Ÿæ€ä¹ˆåŠï¼Ÿ</p>\n<p>ä¸ªäººè§è§£ï¼Œé‚£å°±æ˜¯ï¼š<strong>æŒç»­å­¦ä¹ ï¼Œå®è·µè¾“å‡º</strong></p>\n<p>1ã€æˆ‘å¯¹ JVM æŒ‡ä»¤ä¸ç†Ÿï¼Œå¯¹ä¿®æ”¹æ— ä»ä¸‹æ‰‹ï¼Œé‚£ä¹ˆæˆ‘æƒ³ä½ åº”è¯¥éœ€è¦è¿›ä¸€æ­¥äº†è§£ class æ–‡ä»¶ç»“æ„ï¼ŒJVM æŒ‡ä»¤è¯´æ˜ï¼›<br>\nå»å“ªå­¦ä¹ ï¼Ÿæ‰¾å®˜æ–¹èµ„æºã€GitHub å­¦ä¹ èµ„æºã€é˜…è¯»å¤§ä½¬çš„æ–‡ç« ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>\n<p>2ã€å·¥å…·ä½¿ç”¨çš„æŒæ¡ï¼Œä¸Šé¢æåˆ°çš„ jclasslib å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ç æŸ¥çœ‹ã€ç¼–è¾‘å·¥å…·ï¼Œå·¥å…·æ˜¯å¾€å¾€æœ‰ç«å“å­˜åœ¨ï¼Œ<br>\næˆ‘ä»Šå¤©ä½¿ç”¨çš„æ˜¯ jclasslibï¼Œå¯éšç€è‡ªæˆ‘è§†é‡çš„æ‰©å±•ï¼Œæˆ‘æ˜å¤©å¯èƒ½åœ¨ä½¿ç”¨ Recafï¼ˆä¹Ÿæ˜¯å­—èŠ‚ç ç¼–è¾‘å·¥å…·ï¼‰</p>\n<p><strong>é™„åŠ ï¼š</strong></p>\n<ul>\n<li><a href=\"https://github.com/ingokegel/jclasslib\">jclasslib bytecode editor</a></li>\n<li><a href=\"https://github.com/java-decompiler/jd-gui/releases\">JD-GUI</a></li>\n<li><a href=\"https://down.52pojie.cn/Tools/\">åœ¨çº¿ç ´è§£å·¥å…·åŒ…ï¼š</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>ä½ æœ‰é‡åˆ°é€‚ç”¨çš„åœºæ™¯å—</h1>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b489e163aa127c5f7eb59575079df4d6.png\" alt=\"æ·±å¤§æ‘é•¿.jpg\"></p>\n<p>ä½ æœ‰æ²¡æœ‰é‡åˆ°éœ€è¦ä¿®æ”¹ class æ–‡ä»¶é‡æ–°æ‰“åŒ…çš„åœºæ™¯å‘¢ï¼Ÿå·§å¾—å¾ˆï¼Œæœ€è¿‘åˆšå¥½é‡åˆ°éœ€è¦ä¿®æ”¹ä¸€ä¸ªå·²å­˜åœ¨çš„ jar åŒ…ä»¥æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œä¸è¿‡æœ¬æ¬¡ä¿®æ”¹çš„æ˜¯å­—ç¬¦å¸¸é‡ï¼Œå°šæœªæ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„é€»è¾‘ï¼Œè®°å½•ä¸‹æ­¤åˆ»ï¼Œå¦‚ä½•ä¿®æ”¹ï¼Ÿå¦‚ä½•å¿«é€Ÿä¿®æ”¹å®Œæˆéœ€æ±‚ï¼Ÿå¸Œæœ›å¯ä»¥æŠ›ç –å¼•ç‰ï¼Œå‰©ä¸‹çš„è¾ƒä¸ºå¤æ‚çš„é€»è¾‘ä¿®æ”¹å°±äº¤ç»™ä½ ä»¬äº† :)</p>\n<p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p>\n<p>é—®é¢˜æè¿°ï¼š<br>\n1ã€æŸå¼¹çª—æ–‡æœ¬æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆæ–‡å­—å†—ä½™ï¼Œæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/39cb62ad15a8135fced9b45bb6e0b58e.png\" alt=\"image.png\"></p>\n<p>å…³äºæè¿°ï¼š<br>\n1ã€æ­¤å¼¹çª—ä»£ç æ˜¯æŸç¬¬ä¸‰æ–¹ jar åŒ…<br>\n2ã€æ–‡å­—æ˜¾ç¤ºè¦æ±‚åº”è¯¥æ˜¯ï¼š <code>å®¢æœï¼šQQå·</code><br>\n3ã€ä½†å®é™…æƒ…å†µç¬¬ä¸‰æ–¹ jar åŒ…åœ¨æ˜¾ç¤ºå†…å®¹å‰åŠ äº†å‰ç¼€ <code>å®¢æœ</code>ï¼Œä¸ç¬¦åˆè¦æ±‚</p>\n<p>é¢„æœŸæ•ˆæœï¼š<br>\n1ã€æ˜¾ç¤ºæ•ˆæœï¼š<code>å®¢æœQQï¼š2464113103</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/be9836c62729cd6fd5904c8ff4dbcfd5.png\" alt=\"image.png\"></p>\n<p>é¢„æœŸéœ€æ±‚å¾ˆæ¸…æ™°ï¼Œä»£ç ä¿®æ”¹ä¹Ÿè·Ÿæ¸…æ™°ï¼ˆå»é™¤ç¬¬ä¸‰æ–¹ jar åŒ…å†…å®¹å‰ç¼€ <code>å®¢æœï¼š</code>ï¼Œå®ç°å†…å®¹çµæ´»é…ç½®ï¼‰</p>\n<h1>æ¸©æ•… jar å‘½ä»¤ä½¿ç”¨</h1>\n<p>1ã€å‘½ä»¤æŸ¥çœ‹ä½¿ç”¨å¸®åŠ© jar -h</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ç”¨æ³•: jar &#123;ctxui&#125;[vfmn0PMe] [jar-file] [manifest-file] [entry-point] [-C dir] files ...\\</span><br><span class=\"line\">é€‰é¡¹:</span><br><span class=\"line\">    -c  åˆ›å»ºæ–°æ¡£æ¡ˆ</span><br><span class=\"line\">    -t  åˆ—å‡ºæ¡£æ¡ˆç›®å½•</span><br><span class=\"line\">    -x  ä»æ¡£æ¡ˆä¸­æå–æŒ‡å®šçš„ (æˆ–æ‰€æœ‰) æ–‡ä»¶</span><br><span class=\"line\">    -u  æ›´æ–°ç°æœ‰æ¡£æ¡ˆ</span><br><span class=\"line\">    -v  åœ¨æ ‡å‡†è¾“å‡ºä¸­ç”Ÿæˆè¯¦ç»†è¾“å‡º</span><br><span class=\"line\">    -f  æŒ‡å®šæ¡£æ¡ˆæ–‡ä»¶å</span><br><span class=\"line\">    -m  åŒ…å«æŒ‡å®šæ¸…å•æ–‡ä»¶ä¸­çš„æ¸…å•ä¿¡æ¯</span><br><span class=\"line\">    -n  åˆ›å»ºæ–°æ¡£æ¡ˆåæ‰§è¡Œ Pack200 è§„èŒƒåŒ–</span><br><span class=\"line\">    -e  ä¸ºæ†ç»‘åˆ°å¯æ‰§è¡Œ jar æ–‡ä»¶çš„ç‹¬ç«‹åº”ç”¨ç¨‹åº</span><br><span class=\"line\">        æŒ‡å®šåº”ç”¨ç¨‹åºå…¥å£ç‚¹</span><br><span class=\"line\">    -<span class=\"number\">0</span>  ä»…å­˜å‚¨; ä¸ä½¿ç”¨ä»»ä½• ZIP å‹ç¼©</span><br><span class=\"line\">    -P  ä¿ç•™æ–‡ä»¶åä¸­çš„å‰å¯¼ <span class=\"string\">&#x27;/&#x27;</span> (ç»å¯¹è·¯å¾„) å’Œ <span class=\"string\">&quot;..&quot;</span> (çˆ¶ç›®å½•) ç»„ä»¶</span><br><span class=\"line\">    -M  ä¸åˆ›å»ºæ¡ç›®çš„æ¸…å•æ–‡ä»¶</span><br><span class=\"line\">    -i  ä¸ºæŒ‡å®šçš„ jar æ–‡ä»¶ç”Ÿæˆç´¢å¼•ä¿¡æ¯</span><br><span class=\"line\">    -C  æ›´æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•å¹¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶</span><br><span class=\"line\"></span><br><span class=\"line\">å¦‚æœä»»ä½•æ–‡ä»¶ä¸ºç›®å½•, åˆ™å¯¹å…¶è¿›è¡Œé€’å½’å¤„ç†ã€‚æ¸…å•æ–‡ä»¶å, æ¡£æ¡ˆæ–‡ä»¶åå’Œå…¥å£ç‚¹åç§°çš„æŒ‡å®šé¡ºåº</span><br><span class=\"line\">ä¸ <span class=\"string\">&#x27;m&#x27;</span>, <span class=\"string\">&#x27;f&#x27;</span> å’Œ <span class=\"string\">&#x27;e&#x27;</span> æ ‡è®°çš„æŒ‡å®šé¡ºåºç›¸åŒã€‚</span><br></pre></td></tr></table></figure>\n<p>2ã€æ‰“åŒ…ç”Ÿæˆ jar<br>\nå°† class æ–‡ä»¶æ‰“åŒ…ä¸º jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf classes.jar Foo.class Bar.class</span><br></pre></td></tr></table></figure>\n<p>å°† folder/ ç›®å½•ä¸‹çš„æ‰€æœ‰ class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf classes.jar -C folder/ .</span><br></pre></td></tr></table></figure>\n<p>3ã€æŸ¥çœ‹ jar æ–‡ä»¶åˆ—è¡¨</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar -tvf classes.jar</span><br></pre></td></tr></table></figure>\n<p>4ã€è§£å‹ jar æ–‡ä»¶</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar -xvf classes.jar</span><br></pre></td></tr></table></figure>\n<h1>å¼€å§‹ä¿®æ”¹ jar</h1>\n<p>æ–¹å¼ä¸€ä¸æ¨èï¼Œåªæ˜¯æƒ³è®©ä½ çŸ¥é“è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p>\n<h2 id=\"æ–¹å¼ä¸€ï¼šjavac\">æ–¹å¼ä¸€ï¼šjavac</h2>\n<p><strong>1ã€ä½¿ç”¨ JD-GUI æ‰“å¼€ jar æ–‡ä»¶å¹¶å¯¼å‡º java ä»£ç </strong></p>\n<p><strong>2ã€ä½¿ç”¨ javac å‘½ä»¤æŠŠ .java æ–‡ä»¶è½¬æ¢ä¸º .class æ–‡ä»¶</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -classpath [å¾…ç”Ÿæˆçš„æ–‡ä»¶å.jar] [å·²ä¿®æ”¹çš„æ–‡ä»¶.java]</span><br></pre></td></tr></table></figure>\n<p>å®é™…æ“ä½œè¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ javac å‘½ä»¤å¾€å¾€ä¸æ˜¯è‡ªå·±æœŸæœ›çš„é‚£ä¹ˆé¡ºåˆ©ï¼Œé‡åˆ°é—®é¢˜é’ˆå¯¹æ€§å¤„ç†ã€‚</p>\n<p><code>2.1</code> å½“é‡åˆ°ç¼–ç é—®é¢˜æ—¶ï¼šéœ€è¦æ·»åŠ é¢å¤–å‚æ•°***-encoding utf-8***</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/49f46c79b1626bc9fa8f8a326a9efa6c.png\" alt=\"image.png\"></p>\n<p><code>2.2</code> å½“é‡åˆ°ç¨‹åºåŒ…æ‰¾ä¸åˆ°æ—¶ï¼šéœ€è¦åœ¨<em><strong>å·²ä¿®æ”¹.javaæ–‡ä»¶åŒçº§ç›®å½•ä¸‹</strong></em>æ”¾ç½®ç¼ºå¤±çš„ jar åŒ…ï¼ˆå¯ä»¥ä½¿ç”¨åˆ†å·åˆ†éš”è¾“å…¥å¤šä¸ª jar åŒ…å‚æ•°ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/213dbc4980626c7aa6047fec3884f4a6.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/45f67a8f91ccdddbd528b08be84bb98c.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/4c096fedfc8e73d0a8f5fa17702a651f.png\" alt=\"image.png\"></p>\n<p><code>æ³¨æ„ï¼š</code><br>\nè¿™é‡Œæœ‰ä¸ªå‘ï¼Œå¦‚æœæ‰“åŒ…è¿‡ç¨‹æœ‰ä¾èµ– android jarï¼Œè¦æ±‚å¿…é¡»æ˜¯ android sdk ç›®å½•ä¸‹çš„ jarï¼ˆå®˜æ–¹çš„ï¼‰ï¼Œä¸èƒ½éšä¾¿æ‰¾ä¸€ä¸ªï¼ˆé˜‰å‰²ç‰ˆï¼‰ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/56247e2d3f5361ead4c49454c0a7a3bd.png\" alt=\"image.png\"></p>\n<p><strong>3ã€æœ€ç»ˆå‘½ä»¤ï¼ˆå¯èƒ½æ˜¯è¿™æ ·ï¼Œä½†ä¸ä¸€å®šï¼‰</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -encoding utf-<span class=\"number\">8</span> -classpath [ä¾èµ–çš„<span class=\"number\">1.</span>jar;ä¾èµ–çš„<span class=\"number\">2.</span>jar;ä¾èµ–çš„<span class=\"number\">3.</span>jar;...] [å·²ä¿®æ”¹çš„å•ä¸ª .java æ–‡ä»¶æˆ–è€…å¾…è½¬æ¢çš„ .java æ–‡ä»¶æ‰€åœ¨ç›®å½•]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javac -encoding utf-<span class=\"number\">8</span> -classpath android.jar;classes-dex2jar.jar GRAppStoreActivity.java</span><br></pre></td></tr></table></figure>\n<p>è¿™å°±æˆåŠŸæŠŠ java ä»£ç ç¼–è¯‘ä¸º class ä»£ç </p>\n<p><strong>4ã€æ›¿æ¢æ—§çš„ class æ–‡ä»¶å¹¶é‡æ–°æ‰“åŒ…æˆ jar</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf [æ–°æ–‡ä»¶å.jar] -C [å¾…æ‰“åŒ…çš„classæ–‡ä»¶ç›®å½•] [è¾“å‡ºåˆ°æŒ‡å®šç›®å½•]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jar cvf jsonlili.jar -C primer/ .</span><br></pre></td></tr></table></figure>\n<p>åˆ°è¿™é‡Œå°±æ‰“åŒ…æˆåŠŸäº†ï¼Œå¦‚æœé‡åˆ°ä»€ä¹ˆé—®é¢˜æ¬¢è¿è¯„è®º :) å¦‚æœ jar ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…è¾ƒå¤šï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸é€‚åˆæ“ä½œçš„ï¼Œè€Œä¸”æ­¥éª¤ä¹Ÿå¾ˆç¹çï¼Œç¹ççš„äº‹æƒ…å¿…é¡»ç®€åŒ–ï¼Œé‡å¤çš„å·¥ä½œå¯ä»¥æµç¨‹åŒ–ï¼Œé‚£ä¹ˆä¸‹é¢ç®€æ˜ä»‹ç»åˆ©ç”¨å·¥å…·å®ç°ä¿®æ”¹ã€‚</p>\n<h2 id=\"æ–¹å¼äºŒï¼šjclasslib\">æ–¹å¼äºŒï¼šjclasslib</h2>\n<p><strong>1ã€æŠŠ jar åŒ…æ‹–å…¥å·¥å…·ä¸­æŸ¥çœ‹ä»£ç </strong></p>\n<p>æˆ–è€…æ‰“å¼€æŸä¸ª class æ–‡ä»¶ï¼Œå¯¹äºæŸäº›ç®€å•ã€å°‘é‡çš„ä¿®æ”¹ä¹Ÿå¯ä»¥åƒæ–¹å¼ä¸€é‚£æ ·ï¼Œä¿®æ”¹ã€æ›¿æ¢ã€é‡æ–°æ‰“åŒ…ç”Ÿæˆç›®æ ‡ jar</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a6fd42dda952836b3119dff2faa988bd.png\" alt=\"image.png\"></p>\n<p><strong>2ã€ä»£ç å®šä½å¹¶ä¿®æ”¹</strong></p>\n<p>æˆ‘ä»¬ä»¥å¼€å¤´çš„å®¢æœå¼¹çª—æç¤ºä¸ºä¾‹ï¼Œåœ¨åŸå§‹ jar æ–‡ä»¶ä¸­å®šä½åˆ°<code>å®¢æœï¼š</code>å›ºå®šå‰ç¼€ï¼Œä»£ç ä½äºåœ¨ <em><strong>MyMainActivity</strong></em> ç±»çš„æŸä¸ªæ–¹æ³•ä¸­</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ff17b6d926a31e648c532263e6268792.png\" alt=\"image.png\"></p>\n<p>æˆ‘ä»¬çŸ¥é“åŒ¿åç±»ç»è¿‡ç¼–è¯‘åçš„ class æ–‡ä»¶æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶åå¾€å¾€å¸¦æœ‰<code>$</code>ç¬¦å·ï¼Œæˆ‘ä»¬è§£å‹ jar æ–‡ä»¶å¯ä»¥ç¼©å°æŸ¥æ‰¾èŒƒå›´ï¼Œä¸€ç•ªæŸ¥é˜…åå®šä½åˆ° <code>MyMainActivity$2$1.class</code> æ–‡ä»¶ä¸­ï¼ŒMethods -&gt; onClick -&gt; Codeï¼ˆè¿™é‡Œéœ€è¦å¯¹ class æ–‡ä»¶ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b9d17fbc33b11fa541911cf6e3d21416.png\" alt=\"image.png\"></p>\n<blockquote>\n<p>ldcï¼šæ˜¯ JVM æŒ‡ä»¤ï¼ŒæŒ‡ä»å¸¸é‡æ± ä¸­å–å‡ºå­—ç¬¦ä¸²å¸¸é‡å¹¶å‹å…¥æ“ä½œæ•°å †æ ˆä¸­ã€‚</p>\n<p>è¿™é‡Œæœ‰ä¸¤ä¸ªåŠ¨ä½œï¼Œå–å‡ºæ•°æ®ã€æŠŠæ•°æ®å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå¦‚æœä¸äº†è§£æ“ä½œæ•°æ ˆï¼Œå»ºè®®ç•¥è¯»å­—èŠ‚ç ç›¸å…³èµ„æ–™ï¼‰</p>\n</blockquote>\n<p>å…³äº class æ–‡ä»¶ç»“æ„å’Œå­—èŠ‚ç æŒ‡ä»¤æ¨èå®˜æ–¹æ–‡æ¡£ï¼š <a href=\"https://docs.oracle.com/javase/specs/jls/se19/html/index.html\">å­—èŠ‚ç æŒ‡ä»¤</a></p>\n<p><strong>3ã€ä¿®æ”¹å¹¶ä¿å­˜</strong><br>\nä»åˆšæ‰çš„ <code>ldc #61 &lt;å®¢æœï¼š&gt;</code> ä¸­ç‚¹å‡» <code>#61</code> è·³è½¬åˆ°å¸¸é‡ç¼–è¾‘å¤„ä¿®æ”¹å¹¶ä¿å­˜</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec7700f218da9a6d8d57445909ea9f05.png\" alt=\"image.png\"></p>\n<p>åˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬å¯¹ class æ–‡ä»¶çš„ä¿®æ”¹å·²ç»å®Œæˆäº† :)</p>\n<h1>æœ€å</h1>\n<p>æˆ‘åœ¨æƒ³ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ›´å¤æ‚çš„é€»è¾‘ä»¥æ»¡è¶³æ›´å¤§çš„éœ€æ±‚å‘¢ï¼Ÿæ€ä¹ˆåŠï¼Ÿ</p>\n<p>ä¸ªäººè§è§£ï¼Œé‚£å°±æ˜¯ï¼š<strong>æŒç»­å­¦ä¹ ï¼Œå®è·µè¾“å‡º</strong></p>\n<p>1ã€æˆ‘å¯¹ JVM æŒ‡ä»¤ä¸ç†Ÿï¼Œå¯¹ä¿®æ”¹æ— ä»ä¸‹æ‰‹ï¼Œé‚£ä¹ˆæˆ‘æƒ³ä½ åº”è¯¥éœ€è¦è¿›ä¸€æ­¥äº†è§£ class æ–‡ä»¶ç»“æ„ï¼ŒJVM æŒ‡ä»¤è¯´æ˜ï¼›<br>\nå»å“ªå­¦ä¹ ï¼Ÿæ‰¾å®˜æ–¹èµ„æºã€GitHub å­¦ä¹ èµ„æºã€é˜…è¯»å¤§ä½¬çš„æ–‡ç« ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>\n<p>2ã€å·¥å…·ä½¿ç”¨çš„æŒæ¡ï¼Œä¸Šé¢æåˆ°çš„ jclasslib å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ç æŸ¥çœ‹ã€ç¼–è¾‘å·¥å…·ï¼Œå·¥å…·æ˜¯å¾€å¾€æœ‰ç«å“å­˜åœ¨ï¼Œ<br>\næˆ‘ä»Šå¤©ä½¿ç”¨çš„æ˜¯ jclasslibï¼Œå¯éšç€è‡ªæˆ‘è§†é‡çš„æ‰©å±•ï¼Œæˆ‘æ˜å¤©å¯èƒ½åœ¨ä½¿ç”¨ Recafï¼ˆä¹Ÿæ˜¯å­—èŠ‚ç ç¼–è¾‘å·¥å…·ï¼‰</p>\n<p><strong>é™„åŠ ï¼š</strong></p>\n<ul>\n<li><a href=\"https://github.com/ingokegel/jclasslib\">jclasslib bytecode editor</a></li>\n<li><a href=\"https://github.com/java-decompiler/jd-gui/releases\">JD-GUI</a></li>\n<li><a href=\"https://down.52pojie.cn/Tools/\">åœ¨çº¿ç ´è§£å·¥å…·åŒ…ï¼š</a></li>\n</ul>\n"},{"title":"Native ä¿¡å·è¡¨ï¼ˆéƒ¨åˆ†ï¼‰","catalog":true,"date":"2022-09-24T07:35:36.000Z","subtitle":"æè¿°å¯¹åº”ä¿¡å·ä»£è¡¨çš„å«ä¹‰ï¼ŒååŠ©é—®é¢˜æ’æŸ¥","header-img":"/img/header_img/tag_bg.png","sticky":1,"_content":"\n# å¸¸è§ä¿¡å·\n\n|   signal  |   code    |   describe    |\n|   ---     |   ---     |   ---    |\n|   SIGILL  |   4   |   éæ³•æŒ‡ä»¤    |\n|   SIGTRAP |   5   |   æ–­ç‚¹è°ƒè¯•å¼‚å¸¸ | \n|   SIGABRT |   6   |   å¼‚å¸¸é€€å‡º    |\n|   SIGBUS  |   7   |   æ€»çº¿é”™è¯¯    |\n|   SIGFPE  |   8   |   æµ®ç‚¹é”™è¯¯    |\n|   SIGEGV  |   11  |   æ— æ•ˆå¼•ç”¨    |\n|   SIGPIPE |   13  |   ç®¡é“é”™è¯¯    |\n|   SIGTERM |   15  |   ç»ˆæ­¢è¿è¡Œ    |\n|   SIGSTKFLT|  16  |   æ ˆå¼‚å¸¸      |\n|   SIGSYS  |   31  |   ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸ |\n\n\n\n\n\n","source":"_posts/page-Nativeä¿¡å·è¡¨.md","raw":"---\ntitle: Native ä¿¡å·è¡¨ï¼ˆéƒ¨åˆ†ï¼‰\ncatalog: true\ndate: 2022-09-24 15:35:36\nsubtitle: æè¿°å¯¹åº”ä¿¡å·ä»£è¡¨çš„å«ä¹‰ï¼ŒååŠ©é—®é¢˜æ’æŸ¥\nheader-img: /img/header_img/tag_bg.png\ntags: ç¬”è®°\ncategories: \nsticky: 1\n---\n\n# å¸¸è§ä¿¡å·\n\n|   signal  |   code    |   describe    |\n|   ---     |   ---     |   ---    |\n|   SIGILL  |   4   |   éæ³•æŒ‡ä»¤    |\n|   SIGTRAP |   5   |   æ–­ç‚¹è°ƒè¯•å¼‚å¸¸ | \n|   SIGABRT |   6   |   å¼‚å¸¸é€€å‡º    |\n|   SIGBUS  |   7   |   æ€»çº¿é”™è¯¯    |\n|   SIGFPE  |   8   |   æµ®ç‚¹é”™è¯¯    |\n|   SIGEGV  |   11  |   æ— æ•ˆå¼•ç”¨    |\n|   SIGPIPE |   13  |   ç®¡é“é”™è¯¯    |\n|   SIGTERM |   15  |   ç»ˆæ­¢è¿è¡Œ    |\n|   SIGSTKFLT|  16  |   æ ˆå¼‚å¸¸      |\n|   SIGSYS  |   31  |   ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸ |\n\n\n\n\n\n","slug":"page-Nativeä¿¡å·è¡¨","published":1,"updated":"2022-09-24T07:35:36.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsl0003gaqp311kas46","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>å¸¸è§ä¿¡å·</h1>\n<table>\n<thead>\n<tr>\n<th>signal</th>\n<th>code</th>\n<th>describe</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SIGILL</td>\n<td>4</td>\n<td>éæ³•æŒ‡ä»¤</td>\n</tr>\n<tr>\n<td>SIGTRAP</td>\n<td>5</td>\n<td>æ–­ç‚¹è°ƒè¯•å¼‚å¸¸</td>\n</tr>\n<tr>\n<td>SIGABRT</td>\n<td>6</td>\n<td>å¼‚å¸¸é€€å‡º</td>\n</tr>\n<tr>\n<td>SIGBUS</td>\n<td>7</td>\n<td>æ€»çº¿é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGFPE</td>\n<td>8</td>\n<td>æµ®ç‚¹é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGEGV</td>\n<td>11</td>\n<td>æ— æ•ˆå¼•ç”¨</td>\n</tr>\n<tr>\n<td>SIGPIPE</td>\n<td>13</td>\n<td>ç®¡é“é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGTERM</td>\n<td>15</td>\n<td>ç»ˆæ­¢è¿è¡Œ</td>\n</tr>\n<tr>\n<td>SIGSTKFLT</td>\n<td>16</td>\n<td>æ ˆå¼‚å¸¸</td>\n</tr>\n<tr>\n<td>SIGSYS</td>\n<td>31</td>\n<td>ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸</td>\n</tr>\n</tbody>\n</table>\n","site":{"data":{}},"excerpt":"","more":"<h1>å¸¸è§ä¿¡å·</h1>\n<table>\n<thead>\n<tr>\n<th>signal</th>\n<th>code</th>\n<th>describe</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SIGILL</td>\n<td>4</td>\n<td>éæ³•æŒ‡ä»¤</td>\n</tr>\n<tr>\n<td>SIGTRAP</td>\n<td>5</td>\n<td>æ–­ç‚¹è°ƒè¯•å¼‚å¸¸</td>\n</tr>\n<tr>\n<td>SIGABRT</td>\n<td>6</td>\n<td>å¼‚å¸¸é€€å‡º</td>\n</tr>\n<tr>\n<td>SIGBUS</td>\n<td>7</td>\n<td>æ€»çº¿é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGFPE</td>\n<td>8</td>\n<td>æµ®ç‚¹é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGEGV</td>\n<td>11</td>\n<td>æ— æ•ˆå¼•ç”¨</td>\n</tr>\n<tr>\n<td>SIGPIPE</td>\n<td>13</td>\n<td>ç®¡é“é”™è¯¯</td>\n</tr>\n<tr>\n<td>SIGTERM</td>\n<td>15</td>\n<td>ç»ˆæ­¢è¿è¡Œ</td>\n</tr>\n<tr>\n<td>SIGSTKFLT</td>\n<td>16</td>\n<td>æ ˆå¼‚å¸¸</td>\n</tr>\n<tr>\n<td>SIGSYS</td>\n<td>31</td>\n<td>ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸</td>\n</tr>\n</tbody>\n</table>\n"},{"title":"Android ç³»ç»Ÿ Systemserver","catalog":true,"date":"2022-09-29T14:57:13.000Z","subtitle":"å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡","header-img":"/img/220928/android_sysserver_bg.png","sticky":6,"_content":"\n\n\n\n**ç›¸å…³æ–‡ä»¶**\n\n- /framework/base/service/java/com/android/server/SystemServer.java\n- /framework/base/service/java/com/android/server/SystemServiceManager.java\n- /framework/base/service/java/com/android/server/WatchDog.java\n- /frameworks/base/core/java/com/android/server/SystemConfig.java\n- ... etc\n\n# è¿è¡Œ System server\n\nç»è¿‡å‰ä¸¤ç¯‡çš„ç³»ç»Ÿæ–‡ç« ï¼Œå·²ç»å®Œæˆäº† initã€zygote è¿›ç¨‹çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå³å°†å¯åŠ¨ç³»ç»Ÿå„å¤§æœåŠ¡ï¼Œå„é¡¹æœåŠ¡ç”±æœåŠ¡ç®¡ç†è€… `System server` å®Œæˆåˆ›å»ºå’Œå¯åŠ¨ï¼Œé‚£ä¹ˆèµ¶ç´§è¿›å…¥ç§ç§å» `/framework/base/service/java/com/android/server/SystemServer.java`\n\n```java\n//SystemServer.java\npublic final class SystemServer implements Dumpable {\n\n    //åˆ—ä¸¾å‡ ä¸ªè®¤ä¸ºé‡è¦çš„æˆå‘˜\n    \n   //ç±»ä¼¼è¿™æ ·çš„æœåŠ¡åç§°ä¸å°‘äº 50 ä¸ª\n    private static final String WIFI_SERVICE_CLASS =\n            \"com.android.server.wifi.WifiService\";                  //Wi-FiæœåŠ¡\n    private static final String WIFI_SCANNING_SERVICE_CLASS =\n            \"com.android.server.wifi.scanner.WifiScanningService\";  //Wi-Fi æ‰«æ\n    private static final String ALARM_MANAGER_SERVICE_CLASS =\n            \"com.android.server.alarm.AlarmManagerService\";         //é—¹é’Ÿ\n    ... etc\n    \n    //ç³»ç»Ÿé»˜è®¤çš„å¯¹è¯æ¡†ç­‰ä¸»é¢˜\n    private static final int DEFAULT_SYSTEM_THEME =\n           com.android.internal.R.style.Theme_DeviceDefault_System;\n    \n    //å¾ˆé‡è¦çš„ä¸€ä¸ªä¸»è§’ï¼Œç³»ç»ŸæœåŠ¡ç®¡ç†è€…\n    private SystemServiceManager mSystemServiceManager;\n\n    //å…·ä½“æœåŠ¡å®ç°ç±»\n    private ActivityManagerService mActivityManagerService;  //Activity ç®¡ç†\n    private PackageManagerService mPackageManagerService;    //å®‰è£…åŒ…ç®¡ç†\n    private ContentResolver mContentResolver;                //å†…å®¹è§£æâ€”â€”å†…å®¹æä¾›è€…æ•°æ®è§£æ\n    private DisplayManagerService mDisplayManagerService;    //è®¾å¤‡æ˜¾ç¤ºç›¸å…³\n\n    //çœ‹å˜é‡åå°±å¾ˆæ¸…æ™°ï¼Œapplication é”™è¯¯æŠ¥å‘Šä¿¡æ¯è®°å½•\n    private static LinkedList<Pair<String, ApplicationErrorReport.CrashInfo>> sPendingWtfs;\n\n    //memtrackerï¼šmemory tracker ã€å‚è€ƒé“¾æ¥ã€‘\n    private static native void startMemtrackProxyService();\n\n    //Hidl Hardware Interface Definition Language ç¡¬ä»¶æŠ½è±¡å±‚è¯­è¨€ã€å‚è€ƒé“¾æ¥ã€‘\n    private static native void startHidlServices();\n\n    //è°ƒè¯•æ¨¡å¼ä¸‹æˆ‘ä»¬åº”ç”¨è¿›ç¨‹èƒ½å¤Ÿ dump headï¼Œdump file æ˜¯è¿›ç¨‹çš„å†…å­˜é•œåƒï¼ŒæŠŠè¿›ç¨‹å½“å‰ä¿å­˜çš„çŠ¶æ€ä¿å­˜åˆ° dump æ–‡ä»¶\n    //head dump å…¶å®åˆ©ç”¨ Android studio å†…ç½®çš„å·¥å…·ï¼ˆAndroid profileã€Memory profileï¼‰ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ï¼Œç›´æ¥å¸®ä½ æŠŠæ–‡ä»¶å¯è§†åŒ–\n    //ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜è·¯å¾„ /data/system/heapdump/\n    private static native void initZygoteChildHeapProfiling();\n\n\n    //ä»ä¸»å‡½æ•°å¼€å§‹æ‰§è¡Œ\n    public static void main(String[] args) {\n        new SystemServer().run();\n    }\n}\n```\n\n\n```java\n//SystemServer\npublic SystemServer() {\n    //è®°å½•æ€§ä¿¡æ¯ï¼Œä¸å½±å“ç»§ç»­é˜…è¯»å§ï¼Œä¸»è¦è¿˜æ˜¯åé¢çš„ run æ–¹æ³•\n\n    mFactoryTestMode = FactoryTest.getMode();\n    mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, 0) + 1;\n    mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();\n    mRuntimeStartUptime = SystemClock.uptimeMillis();\n    Process.setStartTimes(mRuntimeStartElapsedTime, mRuntimeStartUptime);\n\n    mRuntimeRestart = \"1\".equals(SystemProperties.get(\"sys.boot_completed\"));\n}\n```\n\n```java\n//SystemServer.java\nprivate void run() {\n\n    //é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ï¼Œè®°å½•è¿›ç¨‹å¯åŠ¨ä¿¡æ¯ï¼Œå¯åŠ¨æ¬¡æ•°ç­‰\n    SystemProperties.set(SYSPROP_START_COUNT,String.valueOf(mStartCount));\n    //å¦‚æœå½“å‰æ—¶åŒºæ— æ•ˆå°†è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ GMT â€”â€” æ ¼æ—å¨æ²»æ—¶é—´\n    SystemProperties.set(\"persist.sys.timezone\", \"GMT\");\n    //å¦‚æœçŸ¥é“äº†è¯­è¨€ï¼Œå°è¯•é€šè¿‡è¯­è¨€è®¾ç½®åœ°åŒºå±æ€§\n    //ã€presist å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯å¯å†™çš„ï¼Œro å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯åªè¯»çš„ã€‘\n    if (!SystemProperties.get(\"persist.sys.language\").isEmpty()) {\n        final String languageTag = Locale.getDefault().toLanguageTag();\n        SystemProperties.set(\"persist.sys.locale\", languageTag); \n    }\n    \n    /*å‰é¢éƒ½æ˜¯åœ¨è®¾ç½®ä¸€äº›ç³»ç»Ÿå±æ€§ï¼Œæ¥ä¸‹æ¥å°†è¦çœŸæ­£å¯åŠ¨æœåŠ¡*/\n    \n    //SystemClock.elapsedRealtime();  è·å–è®¾å¤‡å¯åŠ¨åˆ°å½“å‰çš„æ¯«ç§’å€¼\n    //æ¸…ç†ä¸€æ¬¡å†…å­˜ï¼Œä¸º application å¯ä»¥åˆ†é…å¾—åˆ°æ›´å¤šå†…å­˜\n    VMRuntime.getRuntime().clearGrowthLimit();\n\n    //å¯åŠ¨å‡†å¤‡çº¿ç¨‹ç­–ç•¥ THREAD_PRIORITY_FOREGROUNDï¼šåº”ç”¨ç¨‹åºä¸å¾—æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ã€ä¸å¾—æ›´æ”¹çº¿ç¨‹æ•°é‡ï¼Œè¿™äº›å°†ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´\n    android.os.Process.setThreadPriority(\n        android.os.Process.THREAD_PRIORITY_FOREGROUND); \n    //è¿™æ˜¯å¯¹å‰ä¸€æ¡è¯­å¥è®¾ç½®å‰å°è¿›ç¨‹çš„é™åˆ¶ THREAD_PRIORITY_FOREGROUNDï¼Œè¿™é‡Œä¼ å…¥ falseï¼Œå¦‚æœæ­¤å‰è®¾ç½®çš„çº¿ç¨‹ç­–ç•¥æ˜¯â€˜åå°è¿›ç¨‹ç»„â€™å°†æŠ›å‡ºå¼‚å¸¸\n    android.os.Process.setCanSelfBackground(false);\n\n    //Looper æ˜¯çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œè¿™é‡Œçš„çº¿ç¨‹è‡ªç„¶æ˜¯æ‰§è¡Œçš„ä¸»çº¿ç¨‹ Main-Threadï¼Œä¹Ÿå°±æ˜¯ application æ‰€åœ¨çº¿ç¨‹\n    //è¿™é‡Œæœ‰ä¸€ä¸ªç»å…¸å…«è‚¡æ–‡ğŸ˜Šï¼šè‡ªå®šä¹‰å­çº¿ç¨‹ Looper éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ prepareLooperï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸»çº¿ç¨‹çš„ Looper å‰ä¸éœ€è¦å…ˆè°ƒç”¨ prepare Looperï¼Ÿ\n    //       Aç­”ï¼šè°ƒç”¨æ—¶è‚¯å®šè¦è°ƒç”¨çš„ã€‚è¿™ä¸æ˜¯åºŸè¯å—ï¼Œæˆ‘ä»¬ä¸è°ƒç”¨é‚£è‚¯å®šæ˜¯â€˜åˆ«äººâ€™å·²ç»åœ¨æˆ‘ä»¬ä½¿ç”¨å‰å°±è°ƒç”¨äº†â€”â€”â€”â€”é‚£è¿™ä¸ªâ€˜åˆ«äººâ€™å…¶å®å°±æ˜¯ Android env åœ¨åˆ›å»ºæ—¶å€™è°ƒç”¨äº†\n    //è¿™ä¸ª application main loop è¢«ç³»ç»Ÿç¼“å­˜åœ¨ Looper.java ä¸­ï¼ˆstatic final ThreadLocal<Looper> sThreadLocal = new ThreadLocal<Looper>();ï¼‰\n    //æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æ˜¯é€šè¿‡ï¼š Looper.getMainLooper()\n    Looper.prepareMainLooper();\n    Looper.getMainLooper().setSlowLogThresholdMs(\n        SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);\n\n    //åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ mSystemContext ä»¥åŠè®¾ç½®ä¸Šè¿°çš„é»˜è®¤ä¸»é¢˜\n    createSystemContext();\n    //ç»§ç»­\n    mSystemServiceManager = new SystemServiceManager(mSystemContext);\n\n    //å¯åŠ¨è¯»å–ç³»ç»Ÿå…¨å±€é…ç½®çš„çº¿ç¨‹æ± ï¼Œä¸‹é¢å¯åŠ¨æœåŠ¡å¯åŠ¨æ—¶å€™å°†ä¼šç”¨åˆ°\n    //ä»€ä¹ˆæ—¶å€™å…³é—­çº¿ç¨‹æ± å‘¢ï¼Ÿif (phase == SystemService.PHASE_BOOT_COMPLETED){SystemServerInitThreadPool.shutdown();}\n    SystemServerInitThreadPool tp = SystemServerInitThreadPool.start();\n\n    //ã€é‡ç‚¹ã€é‡ç‚¹ã€é‡ç‚¹ã€‘\n    //å¯åŠ¨å„ç§ Service\n    startBootstrapServices(t);  //å¯åŠ¨æœåŠ¡\n    startCoreServices(t);       //æ ¸å¿ƒæœåŠ¡\n    startOtherServices(t);      //å…¶ä»–æœåŠ¡\n    \n    //ä¸€ä¸ªæ£€æµ‹å·¥å…·\n    StrictMode.initVmDefaults(null);\n    //è¿›å…¥ä¸€ä¸ªæ— çœ çš„ä¸–ç•Œé»˜é»˜`æ‰“å·¥`ï¼Œä¸ºâ€˜äººæ°‘â€™æœåŠ¡\n    /*\n        1ã€è·å¾—å½“å‰çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueue\n        2ã€åœ¨ for(;;) å¾ªç¯ä¸­ä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ¶ˆæ¯ï¼Œqueue.next()ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿‡ç¨‹\n        3ã€å¦‚æœè·å–åˆ°å¯ç”¨çš„æ¶ˆæ¯åˆ™è¿›è¡Œåˆ†å‘ msg.target.dispatchMessage(msg)\n        4ã€æ¶ˆæ¯åˆ†å‘ä¹‹åè¿›è¡Œå›æ”¶æˆ–æ¸…ç† msg.recycleUnChecked()\n    */\n    Looper.loop();\n}\n```\n\n# å¯åŠ¨ Bootstrap æœåŠ¡\n```java\n//SystemServer.java\nprivate void startBootstrapServices(@NonNull TimingsTraceAndSlog t) {\n\n    //ã€1ã€‘watchdog çœ‹é—¨ğŸ¶ï¼Ÿçœ‹ç€æ˜¯æœ‰è¿™ä¸ªæ„æ€ï¼Œå¤§æ¦‚å°±æ˜¯ç›‘æ§æœåŠ¡\n    /*\n        1ã€å®ƒè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­ mThread = new Thread(this::run, \"watchdog\");\n        2ã€ä¸»è¦æ˜¯æ£€æŸ¥ä¸€äº›çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒåº¦æƒ…å†µï¼Œæ¯”å¦‚æ£€æŸ¥çš„çº¿ç¨‹æœ‰å‰å°çº¿ç¨‹ã€IOã€UIã€mainã€displayã€animationã€surface animation ç­‰çº¿ç¨‹\n    */\n    final Watchdog watchdog = Watchdog.getInstance();\n    watchdog.start();\n\n    //ã€2ã€‘åŠ è½½å…¨å±€ç³»ç»Ÿé…ç½®ä¿¡æ¯\n    /*\n        1ã€æ­¤çº¿ç¨‹æ± åœ¨ SystemServer å¯åŠ¨æ—¶å€™æ‰§è¡Œ\n        2ã€åœ¨ SystemServer å¯åŠ¨å®Œæˆä¹‹åå…³é—­ SystemService.PHASE_BOOT_COMPLETE\n        3ã€è°ƒç”¨ submit æ–¹æ³•çœŸæ­£æ‰§è¡Œç³»ç»Ÿå…¨å±€é…ç½®è¯»å–çš„æ–¹æ³•åœ¨å“ªé‡Œï¼Ÿçº¿ç¨‹æ± æäº¤ä¹‹åæ‰§è¡Œçš„å½“ç„¶æ˜¯ run æ–¹æ³•ã€‚è°çš„ run æ–¹æ³•ï¼ŸSystemConfig::getInstance åˆæ˜¯å•¥ï¼Œåœ¨å“ªé‡Œï¼Ÿã€ä¸è§£ï¼ŒçŸ¥è€…æ¬¢è¿è¯„è®ºã€‘\n        4ã€SystemConfig::getInstanceï¼šJava èƒ½å¤Ÿä½¿ç”¨åŒå¼•å·è®¿é—®é™æ€æ–¹æ³•ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘åªçŸ¥é“ cpp æ˜¯å¯ä»¥è¿™æ ·çš„ï¼Œåæ¥æŸ¥äº†ä¸€ä¸‹ä¼¼ä¹æ˜¯ lambada çš„è¯­æ³•ç³–ğŸ˜ºä¸çŸ¥è€…æ— ç½ª\n        5ã€readPublicNativeLibrariesList();//String[] dirs = {\"/system/etc\", \"/system_ext/etc\", \"/product/etc\",\"vendor/etc\"};è¯»å–æ­¤ç›®å½•ä¸‹ public.libraries- å¼€å¤´ï¼Œ.txt ç»“å°¾çš„é…ç½®æ–‡ä»¶\n        6ã€readAllPermissions();//è§£ææ ¹ç›®å½•ã€Vendorç›®å½•ç­‰ etc/sysconfigã€etc/permission ä¸‹ XML æƒé™æ–‡ä»¶\n    */\n    final String TAG_SYSTEM_CONFIG = \"ReadingSystemConfig\";\n    SystemServerInitThreadPool.submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);\n\n    //ã€3ã€‘å…¬å…±æœåŠ¡\n    /*\n        1ã€å°†æ¥ ActivityManagerServiceã€PackageManagerService ...etc ä¼šä½¿ç”¨\n        2ã€è°ƒç”¨ addService ä¸€çœ‹æµç¨‹æœ€ç»ˆåˆ°äº† IServiceManager.cpp è—å¾—è¿™ä¹ˆæ·±ï¼ŒçœŸæ˜¯æœäº†è¿™ä¸ªè€ sixï¼Œsp<AidlServiceManager> mTheRealServiceManager;   \n    */\n    PlatformCompat platformCompat = new PlatformCompat(mSystemContext);\n    ServiceManager.addService(Context.PLATFORM_COMPAT_SERVICE, platformCompat);\n    ServiceManager.addService(Context.PLATFORM_COMPAT_NATIVE_SERVICE,\n        new PlatformCompatNative(platformCompat));\n\n    //ã€4ã€‘æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç›¸å…³æœåŠ¡\n    mSystemServiceManager.startService(FileIntegrityService.class);\n\n    //ã€5ã€‘åº”ç”¨ç¨‹åºå®‰è£…ç›¸å…³æœåŠ¡\n    Installer installer = mSystemServiceManager.startService(Installer.class);\n\n    //ã€6ã€‘è®¾å¤‡æ ‡è¯†è®¿é—®ç­–ç•¥æœåŠ¡\n    /*\n        1ã€è·å–æ‰‹æœºåºåˆ—å·ï¼šgetSerial()ï¼Œç³»ç»Ÿå±æ€§å¯¹åº”é”® ro.serialnã€‚è°ƒç”¨æ—¶\nelephonyPermissions.checkCallingOrSelfReadDeviceIdentifiers\n        2ã€æŒ‡å®šåŒ…åè·å–åºåˆ—å· getSerialForPackageï¼Œå…¶ä¸­å†æ ¹æ®åŒ…å + å½“å‰ç”¨æˆ·IDè·å–è°ƒç”¨æ­¤ç±»çš„ UIDï¼Œæ‰€ä»¥çŒœæµ‹è¿˜æœ‰æœ‰ä¸å°‘é™åˆ¶çš„ï¼Œæ¯”å¦‚é™åˆ¶é root ç”¨æˆ·ã€é™åˆ¶éç³»ç»Ÿåº”ç”¨\n    */\n    SystemServiceManager.startService(DeviceIdentifiersPolicyService.class);\n    \n    //ã€7ã€‘URI æˆæƒç®¡ç†æœåŠ¡ ï¼ˆå…³äº Uri å¯å‚è€ƒé“¾æ¥ï¼‰\n    mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle.class);\n    \n    //ã€8ã€‘ç”µæ± ç›¸å…³æœåŠ¡\n    /*\n        1ã€ç”µé‡ğŸ”‹è§¦å‘å™¨BatteryTrigger mBatteryTriggerï¼Œé€šè¿‡å¹¿æ’­ç›‘å¬ç”µé‡å˜åŒ–ï¼Œå½“ç”µé‡ä¸‹é™1%å°†ä¼šæ¥æ”¶åˆ°å¹¿æ’­ï¼Œä¼¼ä¹åªåšä¸€ä»¶äº‹ï¼šå°±æ˜¯æ›´æ–°æœ€æ–°ç”µé‡ä¿¡æ¯\n        2ã€IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED); é€šè¿‡ context æ³¨å†Œå¹¿æ’­\n    */\n    mSystemServiceManager.startService(PowerStatsService.class);\n\n    //ã€9ã€‘å†…å­˜åˆ†ææœåŠ¡  ï¼ˆnative è°ƒç”¨ï¼‰\n    startMemtrackProxyService();\n    \n    //ã€10ã€‘AMS æœåŠ¡ï¼ˆç»ˆäºçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ğŸ¶ï¼‰\n    /*\n        1ã€é«˜ç‰ˆæœ¬ä»»åŠ¡æ ˆç®¡ç†ç±»ä¼¼ä¹è¢«åˆ†ç¦»å‡ºæ¥äº†ï¼Œç”± ActivityTaskManagerService å®ç°ï¼Œå†…å®¹å¤ªå¤šï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹\n    */\n    ActivityTaskManagerService atm = mSystemServiceManager.startService(\n        ActivityTaskManagerService.Lifecycle.class).getService();\n    mActivityManagerService = ActivityManagerService.Lifecycle.startService(\n        mSystemServiceManager, atm);\n\n    //ã€11ã€‘æ•°æ®åŠ è½½\n    mDataLoaderManagerService = mSystemServiceManager.startService(\n        DataLoaderManagerService.class);\n        \n    //ã€12ã€‘ç”µæºç®¡ç†æœåŠ¡ï¼Œä¹‹å‰é‚£ä¸ªæ—¶ç”µæ± çŠ¶æ€ç®¡ç†ï¼ˆåªåšäº†ä¸€ä»¶äº‹ï¼šç›‘å¬ç”µé‡å˜åŒ–ï¼‰\n    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);\n\n    //ã€13ã€‘ç³»ç»Ÿæ¢å¤æœåŠ¡ï¼Œæˆ‘ä»¬åˆ·æœºå¸¸è§çš„ Recover æ¨¡å¼\n    mSystemServiceManager.startService(RecoverySystemService.Lifecycle.class);\n\n    //ã€14ã€‘å®‰è£…åŒ…ç®¡ç†æœåŠ¡ï¼Œè¿™æ˜¯ä¸ªå¤§ç±»ï¼Œä¸‰ä¸‡è¡Œå‘¢ï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹\n    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,\n        domainVerificationService, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF,\n        mOnlyCore);\n        \n    //ã€15ã€‘ä¼ æ„Ÿå™¨æœåŠ¡\n    mSystemServiceManager.startService(new SensorPrivacyService(mSystemContext));\n    mSystemServiceManager.startService(SensorService.class);\n}\n```\nå¯åŠ¨æœåŠ¡åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼Œåªæ˜¯éƒ¨åˆ†åˆ—ä¸¾ï¼Œå¹¶ä¸å®Œæ•´ï¼ŒæœåŠ¡æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿå…·ä½“éƒ½åœ¨åšäº†äº›ä»€ä¹ˆï¼Ÿç­‰ç­‰ï¼ï¼ï¼è¿™äº›æ‰§è¡Œç»†èŠ‚å¸Œæœ›åœ¨ä¹‹åçš„ç³»åˆ—æ–‡ç« è¿›ä¸€æ­¥æ·±å…¥ï¼ˆå†…å®¹å®åœ¨æ˜¯å¤ªå¤šäº†ğŸ˜­ï¼‰\n\n# å¯åŠ¨ Core æœåŠ¡\n```java\n//SystemServer.java\nprivate void startCoreServices(@NonNull TimingsTraceAndSlog t) {\n    //ã€1ã€‘ä¸»è¦è´Ÿè´£è¯»å–ç³»ç»Ÿé…ç½®ä¿¡æ¯\n    mSystemServiceManager.startService(SystemConfigService.class);\n    \n    //ã€2ã€‘ç”µé‡è·Ÿè¸ª\n    mSystemServiceManager.startService(BatteryService.class);\n    \n    //ã€3ã€‘åº”ç”¨ä½¿ç”¨çŠ¶æ€è·Ÿè¸ª\n    mSystemServiceManager.startService(UsageStatsService.class);\n    \n    //ã€4ã€‘ç›‘æ§è®¾å¤‡æ˜¯å¦å……ç”µã€å±å¹•æ˜¯å¦äº®èµ·\n    //ï¼ˆé€šè¿‡é«˜ä¼˜å…ˆçº§çš„å¹¿æ’­ç›‘å¬ğŸ“¢ï¼ŒæŒ‡å®šç‰¹å®šçš„ intentfilterâ€”â€”ACTION_SCREEN_ON/ACTION_SCREEN_OFF/ACTION_BATTERY_CHANGEDï¼‰\n    mSystemServiceManager.startService(CachedDeviceStateService.class);\n    \n    //ã€5ã€‘åº”ç”¨ç¨‹åºå›æ»šï¼Ÿï¼Ÿï¼Ÿ\n    mSystemServiceManager.startService(ROLLBACK_MANAGER_SERVICE_CLASS);\n\n    //ã€6ã€‘tombstone å¢“ç¢‘ï¼Œè®°å½•è¿›ç¨‹è¢«æ€æ­»å‰çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒç”¨æ ˆã€å†…å­˜ä½¿ç”¨æƒ…å†µã€CPU ä½¿ç”¨æƒ…å†µã€backtrace ç­‰ç­‰ï¼Œä¸»è¦æ˜¯ç›‘æ§å’Œè®°å½• native å´©æºƒä¿¡æ¯ï¼ˆè·å–è¿™ä¸ªå´©æºƒæ—¥å¿—éœ€è¦ root æƒé™ï¼‰\n    mSystemServiceManager.startService(NativeTombstoneManagerService.class);\n    \n    //ã€7ã€‘Android é”™è¯¯æŠ¥å‘Šç”Ÿæˆï¼Œåº”ç”¨å´©æºƒæ—¶å€™æŸ¥çœ‹è¿™ä¸ªæŠ¥å‘Šè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼ˆå‰ææ˜¯ä½ èƒ½å¤Ÿçœ‹æ‡‚æŠ¥å‘Šï¼‰\n    // å¯ä»¥åŒ adb bugreport è·å–é”™è¯¯æŠ¥å‘Šï¼ˆAndroid ç‰ˆæœ¬ä¹‹é—´è·å–æ–¹å¼ç¨æœ‰åŒºåˆ«ï¼Œæ ¹æ® adb bugreport æç¤ºæ“ä½œå³å¯ï¼‰\n    mSystemServiceManager.startService(BugreportManagerService.class);\n\n    //ã€8ã€‘ä¸»è¦è¿˜æ˜¯ç›‘è§†å’Œæ”¶é›† GPU ä¿¡æ¯\n    mSystemServiceManager.startService(GpuService.class);    \n}\n```\n\næ ¸å¿ƒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼Œä¸»è¦æ˜¯ä¿¡æ¯è®°å½•ç›¸å…³ï¼Œå¿…ä¸å¯å°‘ã€ç¡®å®å¾ˆæ˜¯å…³é”®ã€‚\n\n# å¯åŠ¨ Other æœåŠ¡\n```java\n//SystemServer.java\n private void startOtherServices(@NonNull TimingsTraceAndSlog t) {\n\n        try {\n            //é—¹é’ŸæœåŠ¡â°\n            mSystemServiceManager.startService(ALARM_MANAGER_SERVICE_CLASS);\n            //WMS æœåŠ¡\n            mSystemServiceManager.startBootPhase(t, SystemService.PHASE_WAIT_FOR_SENSOR_SERVICE);\n            wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,\n                    new PhoneWindowManager(), mActivityManagerService.mActivityTaskManager);\n            ServiceManager.addService(Context.WINDOW_SERVICE, wm, /* allowIsolated= */ false,\n                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);\n            ServiceManager.addService(Context.INPUT_SERVICE, inputManager,\n                    /* allowIsolated= */ false, DUMP_FLAG_PRIORITY_CRITICAL);\n\n            //è“ç‰™æœåŠ¡\n            if (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) {\n                Slog.i(TAG, \"No Bluetooth Service (factory test)\");\n            } else if (!context.getPackageManager().hasSystemFeature\n                    (PackageManager.FEATURE_BLUETOOTH)) {\n                Slog.i(TAG, \"No Bluetooth Service (Bluetooth Hardware Not Present)\");\n            } else {\n                mSystemServiceManager.startService(BluetoothService.class);\n            }\n\n            //ç½‘ç»œåˆ—è¡¨ç›‘æ§æœåŠ¡\n            mSystemServiceManager.startService(NetworkWatchlistService.Lifecycle.class);\n\n            //è¾“å…¥æ³•ç®¡ç†æœåŠ¡\n            if (InputMethodSystemProperty.MULTI_CLIENT_IME_ENABLED) {\n                mSystemServiceManager.startService(\n                        MultiClientInputMethodManagerService.Lifecycle.class);\n            } else {\n                mSystemServiceManager.startService(InputMethodManagerService.Lifecycle.class);\n            }\n            \n            //è¾…åŠ©åŠŸèƒ½\n            try {\n                mSystemServiceManager.startService(ACCESSIBILITY_MANAGER_SERVICE_CLASS);\n            } catch (Throwable e) {\n                reportWtf(\"starting Accessibility Manager\", e);\n            }\n            \n            //å¼€å‘è€…é€‰é¡¹ä¸­ï¼ŒOEM è§£é”è¿˜è®°å¾—å—\n            if (hasPdb || OemLockService.isHalPresent()) {\n                mSystemServiceManager.startService(OemLockService.class);\n            }\n\n            //çŠ¶æ€æ     \n            try {\n                statusBar = new StatusBarManagerService(context);\n                ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);\n             } catch (Throwable e) {\n             }\n             \n\n\n            startContentCaptureService(context, t);\n            startAttentionService(context, t);\n            startRotationResolverService(context, t);\n            startSystemCaptionsManagerService(context, t);\n            //æ–‡å­—è¯­éŸ³è½¬æ¢\n            startTextToSpeechManagerService(context, t);\n\n            //ç³»ç»Ÿè¯­éŸ³è¯†åˆ«\n            mSystemServiceManager.startService(SPEECH_RECOGNITION_MANAGER_SERVICE_CLASS);\n            \n            //æ™ºæ…§ç©ºé—´ï¼Ÿè®°å¾—åä¸ºæ‰‹æœºæœç´¢é¡µé¢æ˜¯è¿™ä¸ªåç§°ï¼Œæœ‰çš„å«â€˜æ™ºæ…§åœºæ™¯â€™\n            mSystemServiceManager.startService(SMARTSPACE_MANAGER_SERVICE_CLASS);\n\n            //ç½‘ç»œ\n            try {\n                networkManagement = NetworkManagementService.create(context);\n                ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);\n            } catch (Throwable e) {\n            }\n            \n            //å­—ä½“\n            mSystemServiceManager.startService(new FontManagerService.Lifecycle(context, safeMode));\n\n            //Wi-Fi\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_SCANNING_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_RTT)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_RTT_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_AWARE)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_AWARE_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_DIRECT)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_P2P_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            \n            //VPN\n            try {\n                vpnManager = VpnManagerService.create(context);\n                ServiceManager.addService(Context.VPN_MANAGEMENT_SERVICE, vpnManager);\n            } catch (Throwable e) {\n            }\n            t.traceEnd();\n\n            t.traceBegin(\"StartVcnManagementService\");\n            try {\n                vcnManagement = VcnManagementService.create(context);\n                ServiceManager.addService(Context.VCN_MANAGEMENT_SERVICE, vcnManagement);\n            } catch (Throwable e) {\n                reportWtf(\"starting VCN Management Service\", e);\n            }\n            t.traceEnd();\n\n            //ç³»ç»Ÿæ›´æ–°\n            try {\n                ServiceManager.addService(Context.SYSTEM_UPDATE_SERVICE,\n                        new SystemUpdateManagerService(context));\n            } catch (Throwable e) {\n            }\n            \n            //é€šçŸ¥æ \n            mSystemServiceManager.startService(NotificationManagerService.class);\n            SystemNotificationChannels.removeDeprecated(context);\n            SystemNotificationChannels.createAll(context);\n            notification = INotificationManager.Stub.asInterface(\n                    ServiceManager.getService(Context.NOTIFICATION_SERVICE));\n\n            //å£çº¸\n            if (context.getResources().getBoolean(R.bool.config_enableWallpaperService)) {\n                mSystemServiceManager.startService(WALLPAPER_SERVICE_CLASS);\n            } else {\n            }\n\n            //éŸ³é‡\n            if (!isArc) {\n                mSystemServiceManager.startService(AudioService.Lifecycle.class);\n            } else {\n                String className = context.getResources()\n                        .getString(R.string.config_deviceSpecificAudioService);\n                try {\n                    mSystemServiceManager.startService(className + \"$Lifecycle\");\n                } catch (Throwable e) {\n                }\n            }\n            \n            //æ— é™å¹¿æ’­\n            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_BROADCAST_RADIO)) {\n                t.traceBegin(\"StartBroadcastRadioService\");\n                mSystemServiceManager.startService(BroadcastRadioService.class);\n                t.traceEnd();\n            }\n        \n            //adb è°ƒè¯•\n            try {\n                mSystemServiceManager.startService(ADB_SERVICE_CLASS);\n            } catch (Throwable e) {\n                Slog.e(TAG, \"Failure starting AdbService\");\n            }\n            \n            //app å¯åŠ¨\n        mSystemServiceManager.startService(LauncherAppsService.class);\n            \n            //å¯åŠ¨å¯†ç é”\n        mSystemServiceManager.startBootPhase(t, SystemService.PHASE_LOCK_SETTINGS_READY);\n        \n        //ç´§æ¥ç€ä¼šæœ‰å„é¡¹ä¹‹å‰å¯åŠ¨çš„æœåŠ¡è°ƒç”¨ systemReady() æ–¹æ³•ï¼ŒæŒ‡å®šæœåŠ¡å‡†å¤‡å®Œæ¯•ï¼Œå³å°†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ\n        mPackageManagerService.systemReady();\n        mDisplayManagerService.systemReady(safeMode, mOnlyCore);\n        ... etc\n        \n        //ç­‰å¾…æœåŠ¡å‡†å¤‡å®Œæ¯•\n        mPackageManagerService.waitForAppDataPrepared();\n\n        //å„é¡¹æœåŠ¡è°ƒç”¨ systemRunning()ã€start() æ–¹æ³•å¼€å§‹è¿è¡ŒæœåŠ¡è‡ªèº«\n        countryDetectorF.systemRunning();\n        networkTimeUpdaterF.systemRunning();\n        inputManagerF.systemRunning();\n        telephonyRegistryF.systemRunning();\n        mmsServiceF.systemRunning();\n        ... etc\n        \n        //å¯åŠ¨ç³»ç»Ÿç•Œé¢æœåŠ¡\n        /*\n            1ã€é€šè¿‡ intent æŒ‡å®šç‰¹å®šçš„ç»„ä»¶ context.startServiceAsUser(intent, UserHandle.SYSTEM);\n            2ã€startServiceAsUser æ›´ä¸Šå±‚çš„ä»£ç å¯¹æˆ‘ä»¬çœ‹æ¥åƒæ˜¯è°ƒç”¨ context.startService\n            3ã€æŒ‡å®šçš„å¯åŠ¨çš„æœåŠ¡ç»„ä»¶ pm.getSystemUiServiceComponent() æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n                PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);\n                PackageManagerInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PackageManagerInternalImpl\n                è€Œ PackageManagerInternalImpl æ˜¯ PackageManager çš„å†…éƒ¨ç±»ï¼Œæ‰€å±æˆå‘˜æ˜¯ private final PackageManagerInternal mPmInternal;\n                è€Œ getSystemUiServiceComponent å°±æ˜¯è·å–ä¸€ä¸ª string èµ„æºcom.android.internal.R.string.config_systemUIServiceComponent\n            4ã€èµ„æºæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼šframeworks/base/core/res/res/values/config.xmlã€çœ‹è¿™ä¸ªæ–‡ä»¶æœ‰å¥½å¤šæœåŠ¡çš„ componentã€‘\n            5ã€èµ„æºå†…å®¹ \n            <!-- SystemUi service component -->\n            <string name=\"config_systemUIServiceComponent\" translatable=\"false\">com.android.systemui/com.android.systemui.SystemUIService</string>\n        */\n        startSystemUi(context, windowManagerF);\n    }\n}\n```\n\n## å¯åŠ¨ SystemUI æœåŠ¡\n\n```java\n//SystemServer.java\nprivate static void startSystemUi(Context context, WindowManagerService windowManager) {\n    PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);\n    Intent intent = new Intent();\n    /*\n        1ã€å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæœåŠ¡ component: com.android.systemui/com.android.systemui.SystemUIService\n        2ã€æ­¤æœåŠ¡ Java å®ç°ç±»æ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/src/com/android/systemui/SystemUIService.java\n        3ã€è¿™ä¸ªç±»æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæˆå‘˜åˆ†åˆ«è´Ÿè´£ä¸åŒçš„äº‹æƒ…\n            mainHandle  ï¼šä¸»çº¿ç¨‹é€šè®¯ï¼Œæ˜çŸ¥æ•…é—®\n            dumpHandle  ï¼šå½“å‰çº¿ç¨‹è¿è¡ŒçŠ¶æ€ä¿¡æ¯è¾“å‡º\n            logBufferFreezer   ï¼šè´Ÿè´£é”™è¯¯æŠ¥å‘Šæ—¥å¿—ç›¸å…³ã€é”™è¯¯æŠ¥å‘Š-å‚è€ƒé“¾æ¥ã€‘\n            \n        4ã€system server è¿›ç¨‹å¯åŠ¨çš„ UI æœåŠ¡ï¼šæ¥åˆ°äº† SystemUIApplication.java è¿™ä¸ªç±» ((SystemUIApplication) getApplication()).startServicesIfNeeded();\n            æ‰€æœ‰çš„ UI æœåŠ¡åŒ…å«å“ªäº›ï¼ŸæœåŠ¡åç§°åˆ—è¡¨å“ªé‡Œæ¥ï¼Ÿåˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„èµ„æº config_systemUIServiceComponents R.array.config_systemUIServiceComponentsPerUser\n            èµ„æºæ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/res/value/config.xml\n            \n            4.1ã€æœåŠ¡åˆ—è¡¨å‚è€ƒä¸‹æ–‡ã€‘\n            4.2 é€šè¿‡åå°„åˆ›å»ºæœåŠ¡ Class.forname(serviceName) è°ƒç”¨æŒ‡å®šæ„é€ å‡½æ•° newInstance\n            4.3 å¯åŠ¨æœåŠ¡ mServices[i].start(); æ¥ä¸‹æ¥å°±ä¸å…·ä½“çœ‹äº†ï¼Œä»¥åå…·ä½“æœåŠ¡å…·ä½“åˆ†æ\n            \n        5ã€SysteUIApplication ä»–æ˜¯ä¸€ä¸ª Applicationï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰åˆ›å»ºè¯¥å®ä¾‹æ˜¯ä¼šå…ˆæ‰§è¡Œ onCreate æ–¹æ³•ï¼Œ\n            è¿™é‡Œæœ‰è°ƒç”¨ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå¯¹äºéç§æœ‰çš„éç³»ç»Ÿç”¨æˆ·å°†æ‰§è¡Œ startSecondaryUserServicesIfNeeded();\n            è·å–çš„æœåŠ¡åˆ—è¡¨æ˜¯ R.array.config_systemUIServiceComponentsPerUser æŸ¥çœ‹åªæœ‰ä¸€ä¸ªæœåŠ¡\n            \n            5.1 com.android.systemui.util.NotificationChannels\n            \n    intent.setComponent(pm.getSystemUiServiceComponent());\n    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);\n    context.startServiceAsUser(intent, UserHandle.SYSTEM);\n    windowManager.onSystemUiStarted();\n}\n```\n\n**system UI æœåŠ¡åˆ—è¡¨**\n```xml\n//é€šçŸ¥æ¸ é“æœåŠ¡ï¼ˆAndroid ä½ç‰ˆæœ¬çš„é€šçŸ¥åˆ›å»ºæ˜¯ä¸éœ€è¦è®¾ç½®é€šçŸ¥æ¸ é“ï¼Œåæ¥é«˜ç‰ˆæœ¬å¼•å…¥é€šçŸ¥æ¸ é“å¹¶ä¸”å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™é€šçŸ¥æ˜¾ç¤ºå­˜åœ¨å¼‚å¸¸ï¼‰\n<item>com.android.systemui.util.NotificationChannels</item> \n<item>com.android.systemui.keyguard.KeyguardViewMediator</item> \n//åº”ç”¨æœ€è¿‘ä»»åŠ¡åˆ—è¡¨\n<item>com.android.systemui.recents.Recents</item> \n//éŸ³é‡\n<item>com.android.systemui.volume.VolumeUI</item> \n<item>com.android.systemui.stackdivider.Divider</item> \n//çŠ¶æ€æ \n<item>com.android.systemui.statusbar.phone.StatusBar</item>\n<item>com.android.systemui.usb.StorageNotification</item> \n<item>com.android.systemui.power.PowerUI</item> \n<item>com.android.systemui.media.RingtonePlayer</item> \n//é”®ç›˜\n<item>com.android.systemui.keyboard.KeyboardUI</item> \n<item>com.android.systemui.pip.PipUI</item> \n<item>com.android.systemui.shortcut.ShortcutKeyDispatcher</item> \n<item>@string/config_systemUIVendorServiceComponent</item> \n<item>com.android.systemui.util.leak.GarbageMonitor$Service</item> \n<item>com.android.systemui.LatencyTester</item> \n<item>com.android.systemui.globalactions.GlobalActionsComponent</item> <item>com.android.systemui.ScreenDecorations</item> \n<item>com.android.systemui.biometrics.AuthController</item> \n<item>com.android.systemui.SliceBroadcastRelayHandler</item> \n<item>com.android.systemui.SizeCompatModeActivityController</item> \n<item>com.android.systemui.statusbar.notification.InstantAppNotifier</item> \n<item>com.android.systemui.theme.ThemeOverlayController</item> \n<item>com.android.systemui.accessibility.WindowMagnification</item> \n<item>com.android.systemui.accessibility.SystemActions</item> \n<item>com.android.systemui.toast.ToastUI</item>\n```\n\nSystem Server å¤§æ¦‚æ˜¯å¯åŠ¨å®Œæˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆå»å“ªé‡Œè¿è¡Œäº†å‘¢ï¼Ÿï¼Ÿï¼Ÿæˆ–è€…ä¸‹ä¸€æ­¥æˆ‘ä»¬ç»§ç»­çœ‹é‚£ä¸ªç‚¹æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿï¼Ÿï¼Ÿä¹‹å‰æˆ‘ä»¬åªæ˜¯ç²—ç•¥æµè§ˆï¼Œä¸­é—´å¿½ç•¥äº†å¾ˆå¤šï¼Œä¸‹ä¸€æ­¥çš„å…¥å£ç‚¹å¯èƒ½è¦è¿”å›ä¹‹å‰çš„ä»£ç é‡æ–°é˜…è¯»å‘ç°åˆé€‚çš„åˆ‡å…¥ç‚¹ï¼ŒSystemServer ä¹Ÿå·²ç»è¿›å…¥äº†â€˜æ°¸ä¹…çš„å¾ªç¯â€™ï¼Œç­‰å¾…çš„å°±æ˜¯æ¥å—å¤–éƒ¨â€˜ä¿¡å·â€™åšç›¸åº”å¤„ç†ã€ç»§ç»­åˆ†å‘åˆ°å…·ä½“æ‰§è¡Œã€‚ \n\né‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸‹å‘¨å†è§ğŸ˜Š\n\n# é™„åŠ \n\n## å¦‚ä½•å¿«é€Ÿæœç´¢\n**Android é¡¹ç›®ä¸­å¦‚ä½•å¿«é€Ÿæœç´¢æŸå…³é”®å­—ï¼Ÿ**\n\nAOSP æ•´ä¸ªé¡¹ç›®æ˜¯å¾ˆåºå¤§çš„ï¼Œä¸ä»…ä»…æ˜¯åŒ…å« java ä»£ç ï¼Œå°±æ‹¿å½“å‰æˆ‘ä¸‹è½½çš„ `Android 11-r21 åˆ†æ”¯`æ¥è¯´ï¼Œæˆ‘æ˜¯é€šè¿‡ git ä¸‹è½½åœ¨æ²¡æœ‰æŒ‡å®š `single-branch dept=1` å‚æ•°ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸‹è½½å®Œæ¯•å ç”¨å¤§çº¦ **430G** å­˜å‚¨ç©ºé—´ã€‚\n\nä¸€å¼€å§‹æˆ‘æŠŠæºç å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ï¼Œé€šè¿‡ VSCode æ‰“å¼€æœºå­˜åœ¨æ¢°ç¡¬ç›˜çš„ä¸­çš„é¡¹ç›®ï¼ˆæ•´ä¸ª AOSPï¼‰ï¼Œæ¯”å¦‚æœç´¢æŸä¸ªå…³é”®å­—ï¼Œé‚£ä¸ªé€Ÿåº¦å ªæ¯”é¾Ÿé€Ÿï¼›åæ¥æŠŠé¡¹ç›®æ‹·è´åˆ°ç¬”è®°æœ¬ SSD å›ºæ€ç¡¬ç›˜ï¼Œæœç´¢é€Ÿåº¦ç¡®å®æœ‰äº†æ˜æ˜¾çš„æé«˜ï¼Œä½†æ•´ä¸ªé¡¹ç›®æœç´¢è¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼Œä¸æ˜¯ååˆ†æ»¡æ„ï¼›å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€æŸä¸ªæ¨¡å—â€”â€”â€” framework æ¨¡å—ã€framework base æ¨¡å—ç­‰ç­‰ï¼Œæœç´¢é€Ÿåº¦è¿˜å¯ä»¥æ¥å—ã€‚ä½†å¦‚æœè¦æ‰¾çš„ä»£ç æ ¹æœ¬ä¸åœ¨å½“å‰æ¨¡å—ï¼Œæ¯”å¦‚ä½ æ‰“å¼€ framework base æ¨¡å—ï¼Œä½†å®é™…ä»£ç åœ¨ framework service æ¨¡å—ï¼Œè¿™æ ·æ˜¯æœç´¢ä¸åˆ°ç»“æœçš„ï¼Œå› æ­¤è¿˜å¾—æŠŠæœç´¢èŒƒå›´æ‰©å¤§ï¼Œå¼•å…¥çš„æ¨¡å—å¤šäº†é€Ÿåº¦ç»ˆæ˜¯ä¼šå˜æ…¢ã€‚\n\næœç´¢èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç›®æ ‡ï¼Œæ˜¯ä¸æ˜¯è¦å€ŸåŠ©ä¸€ä¸ªä¸œè¥¿â€”â€”â€”â€”**ç´¢å¼•**ï¼Œå¦‚æœæœ‰å·¥å…·æŠŠ AOSP æ•´ä¸ªé¡¹ç›®é¢„å…ˆå»ºç«‹ç´¢å¼•ï¼Œç„¶åå†æ‰“å¼€é¡¹ç›®æœç´¢ï¼Œä¸‹æ¬¡æœç´¢æ—¶æ— éœ€é‡æ–°åˆ›å»ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æœç´¢ä¸å¾—è¦èµ·é£ã€‚~~ä¸æœç´¢ç›¸å…³ç´¢å¼•ç¡®å®æ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚~~\n\n\nã€**æœ€å**ã€‘\n\næ¨èä½¿ç”¨å·²æœ‰çš„åœ¨çº¿ç½‘ç«™è¾…åŠ©æœç´¢ï¼š[**åŸºäº opengrok çš„ AOSPXRef**](http://aospxref.com)\n\nä»¥æœç´¢ SystemUIService `config_systemUIServiceComponent`ä¸ºä¾‹ï¼š\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6d6877806a144cfb2a73a40aa569c01~tplv-k3u1fbpfcp-watermark.image?)\n\nã€**æœ€åçš„æœ€å**ã€‘\n\nASOPXRef ç°æœ‰çš„é¡¹ç›®æ˜¯è¾ƒå°‘çš„ï¼Œä¹Ÿå°±æ˜¯å‡ ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œå¦‚æœèƒ½æ»¡è¶³è‡ªå·±çš„éœ€æ±‚åˆšå¥½ï¼Œè¦æ˜¯æƒ³çœ‹çš„æºç ç‰ˆæœ¬ä¸æ˜¯å·²å­˜åœ¨çš„å»ºè®®è¿˜æ˜¯è‡ªå·±é€šè¿‡ `opengrok` å¼•æ“æ­å»ºä¸€ä¸ªæœåŠ¡ã€‚\n**Oracle opengrokï¼š**[å¿«é€Ÿä¸”å¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“](https://github.com/oracle/opengrok)\n\n\n\n## å‚è€ƒé“¾æ¥\n- WTFï¼šWhat a Terrible Failure â€”â€” Android ç³»ç»Ÿé”™è¯¯è®°å½•çš„ä¸€ç§\n- Memtrackï¼šå†…å­˜åˆ†æ https://zhuanlan.zhihu.com/p/168361476\n- Hidlï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼Œåœ¨è¾ƒä½ Android ç‰ˆæœ¬å¯èƒ½è¿˜åœ¨ä½¿ç”¨ HAL ï¼ˆhardware abstract layerï¼‰https://zhuanlan.zhihu.com/p/28256541\n- Android Uriï¼šhttps://www.cnblogs.com/bhlsheji/p/4246580.html\n- Android é”™è¯¯æŠ¥å‘Šï¼šhttps://developer.android.com/studio/debug/bug-report ï¼Œhttps://source.android.com/source/read-bug-reports.html\n- Android å¢“ç¢‘ï¼šhttps://source.android.com/devices/tech/debug\n\n","source":"_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨systemserverè¿›ç¨‹.md","raw":"---\ntitle: Android ç³»ç»Ÿ Systemserver\ncatalog: true\ndate: 2022-09-29 22:57:13\nsubtitle: å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡\nheader-img: /img/220928/android_sysserver_bg.png\ntags: AOSP\nsticky: 6\ncategories:\n---\n\n\n\n\n**ç›¸å…³æ–‡ä»¶**\n\n- /framework/base/service/java/com/android/server/SystemServer.java\n- /framework/base/service/java/com/android/server/SystemServiceManager.java\n- /framework/base/service/java/com/android/server/WatchDog.java\n- /frameworks/base/core/java/com/android/server/SystemConfig.java\n- ... etc\n\n# è¿è¡Œ System server\n\nç»è¿‡å‰ä¸¤ç¯‡çš„ç³»ç»Ÿæ–‡ç« ï¼Œå·²ç»å®Œæˆäº† initã€zygote è¿›ç¨‹çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå³å°†å¯åŠ¨ç³»ç»Ÿå„å¤§æœåŠ¡ï¼Œå„é¡¹æœåŠ¡ç”±æœåŠ¡ç®¡ç†è€… `System server` å®Œæˆåˆ›å»ºå’Œå¯åŠ¨ï¼Œé‚£ä¹ˆèµ¶ç´§è¿›å…¥ç§ç§å» `/framework/base/service/java/com/android/server/SystemServer.java`\n\n```java\n//SystemServer.java\npublic final class SystemServer implements Dumpable {\n\n    //åˆ—ä¸¾å‡ ä¸ªè®¤ä¸ºé‡è¦çš„æˆå‘˜\n    \n   //ç±»ä¼¼è¿™æ ·çš„æœåŠ¡åç§°ä¸å°‘äº 50 ä¸ª\n    private static final String WIFI_SERVICE_CLASS =\n            \"com.android.server.wifi.WifiService\";                  //Wi-FiæœåŠ¡\n    private static final String WIFI_SCANNING_SERVICE_CLASS =\n            \"com.android.server.wifi.scanner.WifiScanningService\";  //Wi-Fi æ‰«æ\n    private static final String ALARM_MANAGER_SERVICE_CLASS =\n            \"com.android.server.alarm.AlarmManagerService\";         //é—¹é’Ÿ\n    ... etc\n    \n    //ç³»ç»Ÿé»˜è®¤çš„å¯¹è¯æ¡†ç­‰ä¸»é¢˜\n    private static final int DEFAULT_SYSTEM_THEME =\n           com.android.internal.R.style.Theme_DeviceDefault_System;\n    \n    //å¾ˆé‡è¦çš„ä¸€ä¸ªä¸»è§’ï¼Œç³»ç»ŸæœåŠ¡ç®¡ç†è€…\n    private SystemServiceManager mSystemServiceManager;\n\n    //å…·ä½“æœåŠ¡å®ç°ç±»\n    private ActivityManagerService mActivityManagerService;  //Activity ç®¡ç†\n    private PackageManagerService mPackageManagerService;    //å®‰è£…åŒ…ç®¡ç†\n    private ContentResolver mContentResolver;                //å†…å®¹è§£æâ€”â€”å†…å®¹æä¾›è€…æ•°æ®è§£æ\n    private DisplayManagerService mDisplayManagerService;    //è®¾å¤‡æ˜¾ç¤ºç›¸å…³\n\n    //çœ‹å˜é‡åå°±å¾ˆæ¸…æ™°ï¼Œapplication é”™è¯¯æŠ¥å‘Šä¿¡æ¯è®°å½•\n    private static LinkedList<Pair<String, ApplicationErrorReport.CrashInfo>> sPendingWtfs;\n\n    //memtrackerï¼šmemory tracker ã€å‚è€ƒé“¾æ¥ã€‘\n    private static native void startMemtrackProxyService();\n\n    //Hidl Hardware Interface Definition Language ç¡¬ä»¶æŠ½è±¡å±‚è¯­è¨€ã€å‚è€ƒé“¾æ¥ã€‘\n    private static native void startHidlServices();\n\n    //è°ƒè¯•æ¨¡å¼ä¸‹æˆ‘ä»¬åº”ç”¨è¿›ç¨‹èƒ½å¤Ÿ dump headï¼Œdump file æ˜¯è¿›ç¨‹çš„å†…å­˜é•œåƒï¼ŒæŠŠè¿›ç¨‹å½“å‰ä¿å­˜çš„çŠ¶æ€ä¿å­˜åˆ° dump æ–‡ä»¶\n    //head dump å…¶å®åˆ©ç”¨ Android studio å†…ç½®çš„å·¥å…·ï¼ˆAndroid profileã€Memory profileï¼‰ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ï¼Œç›´æ¥å¸®ä½ æŠŠæ–‡ä»¶å¯è§†åŒ–\n    //ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜è·¯å¾„ /data/system/heapdump/\n    private static native void initZygoteChildHeapProfiling();\n\n\n    //ä»ä¸»å‡½æ•°å¼€å§‹æ‰§è¡Œ\n    public static void main(String[] args) {\n        new SystemServer().run();\n    }\n}\n```\n\n\n```java\n//SystemServer\npublic SystemServer() {\n    //è®°å½•æ€§ä¿¡æ¯ï¼Œä¸å½±å“ç»§ç»­é˜…è¯»å§ï¼Œä¸»è¦è¿˜æ˜¯åé¢çš„ run æ–¹æ³•\n\n    mFactoryTestMode = FactoryTest.getMode();\n    mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, 0) + 1;\n    mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();\n    mRuntimeStartUptime = SystemClock.uptimeMillis();\n    Process.setStartTimes(mRuntimeStartElapsedTime, mRuntimeStartUptime);\n\n    mRuntimeRestart = \"1\".equals(SystemProperties.get(\"sys.boot_completed\"));\n}\n```\n\n```java\n//SystemServer.java\nprivate void run() {\n\n    //é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ï¼Œè®°å½•è¿›ç¨‹å¯åŠ¨ä¿¡æ¯ï¼Œå¯åŠ¨æ¬¡æ•°ç­‰\n    SystemProperties.set(SYSPROP_START_COUNT,String.valueOf(mStartCount));\n    //å¦‚æœå½“å‰æ—¶åŒºæ— æ•ˆå°†è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ GMT â€”â€” æ ¼æ—å¨æ²»æ—¶é—´\n    SystemProperties.set(\"persist.sys.timezone\", \"GMT\");\n    //å¦‚æœçŸ¥é“äº†è¯­è¨€ï¼Œå°è¯•é€šè¿‡è¯­è¨€è®¾ç½®åœ°åŒºå±æ€§\n    //ã€presist å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯å¯å†™çš„ï¼Œro å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯åªè¯»çš„ã€‘\n    if (!SystemProperties.get(\"persist.sys.language\").isEmpty()) {\n        final String languageTag = Locale.getDefault().toLanguageTag();\n        SystemProperties.set(\"persist.sys.locale\", languageTag); \n    }\n    \n    /*å‰é¢éƒ½æ˜¯åœ¨è®¾ç½®ä¸€äº›ç³»ç»Ÿå±æ€§ï¼Œæ¥ä¸‹æ¥å°†è¦çœŸæ­£å¯åŠ¨æœåŠ¡*/\n    \n    //SystemClock.elapsedRealtime();  è·å–è®¾å¤‡å¯åŠ¨åˆ°å½“å‰çš„æ¯«ç§’å€¼\n    //æ¸…ç†ä¸€æ¬¡å†…å­˜ï¼Œä¸º application å¯ä»¥åˆ†é…å¾—åˆ°æ›´å¤šå†…å­˜\n    VMRuntime.getRuntime().clearGrowthLimit();\n\n    //å¯åŠ¨å‡†å¤‡çº¿ç¨‹ç­–ç•¥ THREAD_PRIORITY_FOREGROUNDï¼šåº”ç”¨ç¨‹åºä¸å¾—æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ã€ä¸å¾—æ›´æ”¹çº¿ç¨‹æ•°é‡ï¼Œè¿™äº›å°†ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´\n    android.os.Process.setThreadPriority(\n        android.os.Process.THREAD_PRIORITY_FOREGROUND); \n    //è¿™æ˜¯å¯¹å‰ä¸€æ¡è¯­å¥è®¾ç½®å‰å°è¿›ç¨‹çš„é™åˆ¶ THREAD_PRIORITY_FOREGROUNDï¼Œè¿™é‡Œä¼ å…¥ falseï¼Œå¦‚æœæ­¤å‰è®¾ç½®çš„çº¿ç¨‹ç­–ç•¥æ˜¯â€˜åå°è¿›ç¨‹ç»„â€™å°†æŠ›å‡ºå¼‚å¸¸\n    android.os.Process.setCanSelfBackground(false);\n\n    //Looper æ˜¯çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œè¿™é‡Œçš„çº¿ç¨‹è‡ªç„¶æ˜¯æ‰§è¡Œçš„ä¸»çº¿ç¨‹ Main-Threadï¼Œä¹Ÿå°±æ˜¯ application æ‰€åœ¨çº¿ç¨‹\n    //è¿™é‡Œæœ‰ä¸€ä¸ªç»å…¸å…«è‚¡æ–‡ğŸ˜Šï¼šè‡ªå®šä¹‰å­çº¿ç¨‹ Looper éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ prepareLooperï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸»çº¿ç¨‹çš„ Looper å‰ä¸éœ€è¦å…ˆè°ƒç”¨ prepare Looperï¼Ÿ\n    //       Aç­”ï¼šè°ƒç”¨æ—¶è‚¯å®šè¦è°ƒç”¨çš„ã€‚è¿™ä¸æ˜¯åºŸè¯å—ï¼Œæˆ‘ä»¬ä¸è°ƒç”¨é‚£è‚¯å®šæ˜¯â€˜åˆ«äººâ€™å·²ç»åœ¨æˆ‘ä»¬ä½¿ç”¨å‰å°±è°ƒç”¨äº†â€”â€”â€”â€”é‚£è¿™ä¸ªâ€˜åˆ«äººâ€™å…¶å®å°±æ˜¯ Android env åœ¨åˆ›å»ºæ—¶å€™è°ƒç”¨äº†\n    //è¿™ä¸ª application main loop è¢«ç³»ç»Ÿç¼“å­˜åœ¨ Looper.java ä¸­ï¼ˆstatic final ThreadLocal<Looper> sThreadLocal = new ThreadLocal<Looper>();ï¼‰\n    //æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æ˜¯é€šè¿‡ï¼š Looper.getMainLooper()\n    Looper.prepareMainLooper();\n    Looper.getMainLooper().setSlowLogThresholdMs(\n        SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);\n\n    //åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ mSystemContext ä»¥åŠè®¾ç½®ä¸Šè¿°çš„é»˜è®¤ä¸»é¢˜\n    createSystemContext();\n    //ç»§ç»­\n    mSystemServiceManager = new SystemServiceManager(mSystemContext);\n\n    //å¯åŠ¨è¯»å–ç³»ç»Ÿå…¨å±€é…ç½®çš„çº¿ç¨‹æ± ï¼Œä¸‹é¢å¯åŠ¨æœåŠ¡å¯åŠ¨æ—¶å€™å°†ä¼šç”¨åˆ°\n    //ä»€ä¹ˆæ—¶å€™å…³é—­çº¿ç¨‹æ± å‘¢ï¼Ÿif (phase == SystemService.PHASE_BOOT_COMPLETED){SystemServerInitThreadPool.shutdown();}\n    SystemServerInitThreadPool tp = SystemServerInitThreadPool.start();\n\n    //ã€é‡ç‚¹ã€é‡ç‚¹ã€é‡ç‚¹ã€‘\n    //å¯åŠ¨å„ç§ Service\n    startBootstrapServices(t);  //å¯åŠ¨æœåŠ¡\n    startCoreServices(t);       //æ ¸å¿ƒæœåŠ¡\n    startOtherServices(t);      //å…¶ä»–æœåŠ¡\n    \n    //ä¸€ä¸ªæ£€æµ‹å·¥å…·\n    StrictMode.initVmDefaults(null);\n    //è¿›å…¥ä¸€ä¸ªæ— çœ çš„ä¸–ç•Œé»˜é»˜`æ‰“å·¥`ï¼Œä¸ºâ€˜äººæ°‘â€™æœåŠ¡\n    /*\n        1ã€è·å¾—å½“å‰çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueue\n        2ã€åœ¨ for(;;) å¾ªç¯ä¸­ä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ¶ˆæ¯ï¼Œqueue.next()ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿‡ç¨‹\n        3ã€å¦‚æœè·å–åˆ°å¯ç”¨çš„æ¶ˆæ¯åˆ™è¿›è¡Œåˆ†å‘ msg.target.dispatchMessage(msg)\n        4ã€æ¶ˆæ¯åˆ†å‘ä¹‹åè¿›è¡Œå›æ”¶æˆ–æ¸…ç† msg.recycleUnChecked()\n    */\n    Looper.loop();\n}\n```\n\n# å¯åŠ¨ Bootstrap æœåŠ¡\n```java\n//SystemServer.java\nprivate void startBootstrapServices(@NonNull TimingsTraceAndSlog t) {\n\n    //ã€1ã€‘watchdog çœ‹é—¨ğŸ¶ï¼Ÿçœ‹ç€æ˜¯æœ‰è¿™ä¸ªæ„æ€ï¼Œå¤§æ¦‚å°±æ˜¯ç›‘æ§æœåŠ¡\n    /*\n        1ã€å®ƒè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­ mThread = new Thread(this::run, \"watchdog\");\n        2ã€ä¸»è¦æ˜¯æ£€æŸ¥ä¸€äº›çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒåº¦æƒ…å†µï¼Œæ¯”å¦‚æ£€æŸ¥çš„çº¿ç¨‹æœ‰å‰å°çº¿ç¨‹ã€IOã€UIã€mainã€displayã€animationã€surface animation ç­‰çº¿ç¨‹\n    */\n    final Watchdog watchdog = Watchdog.getInstance();\n    watchdog.start();\n\n    //ã€2ã€‘åŠ è½½å…¨å±€ç³»ç»Ÿé…ç½®ä¿¡æ¯\n    /*\n        1ã€æ­¤çº¿ç¨‹æ± åœ¨ SystemServer å¯åŠ¨æ—¶å€™æ‰§è¡Œ\n        2ã€åœ¨ SystemServer å¯åŠ¨å®Œæˆä¹‹åå…³é—­ SystemService.PHASE_BOOT_COMPLETE\n        3ã€è°ƒç”¨ submit æ–¹æ³•çœŸæ­£æ‰§è¡Œç³»ç»Ÿå…¨å±€é…ç½®è¯»å–çš„æ–¹æ³•åœ¨å“ªé‡Œï¼Ÿçº¿ç¨‹æ± æäº¤ä¹‹åæ‰§è¡Œçš„å½“ç„¶æ˜¯ run æ–¹æ³•ã€‚è°çš„ run æ–¹æ³•ï¼ŸSystemConfig::getInstance åˆæ˜¯å•¥ï¼Œåœ¨å“ªé‡Œï¼Ÿã€ä¸è§£ï¼ŒçŸ¥è€…æ¬¢è¿è¯„è®ºã€‘\n        4ã€SystemConfig::getInstanceï¼šJava èƒ½å¤Ÿä½¿ç”¨åŒå¼•å·è®¿é—®é™æ€æ–¹æ³•ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘åªçŸ¥é“ cpp æ˜¯å¯ä»¥è¿™æ ·çš„ï¼Œåæ¥æŸ¥äº†ä¸€ä¸‹ä¼¼ä¹æ˜¯ lambada çš„è¯­æ³•ç³–ğŸ˜ºä¸çŸ¥è€…æ— ç½ª\n        5ã€readPublicNativeLibrariesList();//String[] dirs = {\"/system/etc\", \"/system_ext/etc\", \"/product/etc\",\"vendor/etc\"};è¯»å–æ­¤ç›®å½•ä¸‹ public.libraries- å¼€å¤´ï¼Œ.txt ç»“å°¾çš„é…ç½®æ–‡ä»¶\n        6ã€readAllPermissions();//è§£ææ ¹ç›®å½•ã€Vendorç›®å½•ç­‰ etc/sysconfigã€etc/permission ä¸‹ XML æƒé™æ–‡ä»¶\n    */\n    final String TAG_SYSTEM_CONFIG = \"ReadingSystemConfig\";\n    SystemServerInitThreadPool.submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);\n\n    //ã€3ã€‘å…¬å…±æœåŠ¡\n    /*\n        1ã€å°†æ¥ ActivityManagerServiceã€PackageManagerService ...etc ä¼šä½¿ç”¨\n        2ã€è°ƒç”¨ addService ä¸€çœ‹æµç¨‹æœ€ç»ˆåˆ°äº† IServiceManager.cpp è—å¾—è¿™ä¹ˆæ·±ï¼ŒçœŸæ˜¯æœäº†è¿™ä¸ªè€ sixï¼Œsp<AidlServiceManager> mTheRealServiceManager;   \n    */\n    PlatformCompat platformCompat = new PlatformCompat(mSystemContext);\n    ServiceManager.addService(Context.PLATFORM_COMPAT_SERVICE, platformCompat);\n    ServiceManager.addService(Context.PLATFORM_COMPAT_NATIVE_SERVICE,\n        new PlatformCompatNative(platformCompat));\n\n    //ã€4ã€‘æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç›¸å…³æœåŠ¡\n    mSystemServiceManager.startService(FileIntegrityService.class);\n\n    //ã€5ã€‘åº”ç”¨ç¨‹åºå®‰è£…ç›¸å…³æœåŠ¡\n    Installer installer = mSystemServiceManager.startService(Installer.class);\n\n    //ã€6ã€‘è®¾å¤‡æ ‡è¯†è®¿é—®ç­–ç•¥æœåŠ¡\n    /*\n        1ã€è·å–æ‰‹æœºåºåˆ—å·ï¼šgetSerial()ï¼Œç³»ç»Ÿå±æ€§å¯¹åº”é”® ro.serialnã€‚è°ƒç”¨æ—¶\nelephonyPermissions.checkCallingOrSelfReadDeviceIdentifiers\n        2ã€æŒ‡å®šåŒ…åè·å–åºåˆ—å· getSerialForPackageï¼Œå…¶ä¸­å†æ ¹æ®åŒ…å + å½“å‰ç”¨æˆ·IDè·å–è°ƒç”¨æ­¤ç±»çš„ UIDï¼Œæ‰€ä»¥çŒœæµ‹è¿˜æœ‰æœ‰ä¸å°‘é™åˆ¶çš„ï¼Œæ¯”å¦‚é™åˆ¶é root ç”¨æˆ·ã€é™åˆ¶éç³»ç»Ÿåº”ç”¨\n    */\n    SystemServiceManager.startService(DeviceIdentifiersPolicyService.class);\n    \n    //ã€7ã€‘URI æˆæƒç®¡ç†æœåŠ¡ ï¼ˆå…³äº Uri å¯å‚è€ƒé“¾æ¥ï¼‰\n    mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle.class);\n    \n    //ã€8ã€‘ç”µæ± ç›¸å…³æœåŠ¡\n    /*\n        1ã€ç”µé‡ğŸ”‹è§¦å‘å™¨BatteryTrigger mBatteryTriggerï¼Œé€šè¿‡å¹¿æ’­ç›‘å¬ç”µé‡å˜åŒ–ï¼Œå½“ç”µé‡ä¸‹é™1%å°†ä¼šæ¥æ”¶åˆ°å¹¿æ’­ï¼Œä¼¼ä¹åªåšä¸€ä»¶äº‹ï¼šå°±æ˜¯æ›´æ–°æœ€æ–°ç”µé‡ä¿¡æ¯\n        2ã€IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED); é€šè¿‡ context æ³¨å†Œå¹¿æ’­\n    */\n    mSystemServiceManager.startService(PowerStatsService.class);\n\n    //ã€9ã€‘å†…å­˜åˆ†ææœåŠ¡  ï¼ˆnative è°ƒç”¨ï¼‰\n    startMemtrackProxyService();\n    \n    //ã€10ã€‘AMS æœåŠ¡ï¼ˆç»ˆäºçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ğŸ¶ï¼‰\n    /*\n        1ã€é«˜ç‰ˆæœ¬ä»»åŠ¡æ ˆç®¡ç†ç±»ä¼¼ä¹è¢«åˆ†ç¦»å‡ºæ¥äº†ï¼Œç”± ActivityTaskManagerService å®ç°ï¼Œå†…å®¹å¤ªå¤šï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹\n    */\n    ActivityTaskManagerService atm = mSystemServiceManager.startService(\n        ActivityTaskManagerService.Lifecycle.class).getService();\n    mActivityManagerService = ActivityManagerService.Lifecycle.startService(\n        mSystemServiceManager, atm);\n\n    //ã€11ã€‘æ•°æ®åŠ è½½\n    mDataLoaderManagerService = mSystemServiceManager.startService(\n        DataLoaderManagerService.class);\n        \n    //ã€12ã€‘ç”µæºç®¡ç†æœåŠ¡ï¼Œä¹‹å‰é‚£ä¸ªæ—¶ç”µæ± çŠ¶æ€ç®¡ç†ï¼ˆåªåšäº†ä¸€ä»¶äº‹ï¼šç›‘å¬ç”µé‡å˜åŒ–ï¼‰\n    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);\n\n    //ã€13ã€‘ç³»ç»Ÿæ¢å¤æœåŠ¡ï¼Œæˆ‘ä»¬åˆ·æœºå¸¸è§çš„ Recover æ¨¡å¼\n    mSystemServiceManager.startService(RecoverySystemService.Lifecycle.class);\n\n    //ã€14ã€‘å®‰è£…åŒ…ç®¡ç†æœåŠ¡ï¼Œè¿™æ˜¯ä¸ªå¤§ç±»ï¼Œä¸‰ä¸‡è¡Œå‘¢ï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹\n    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,\n        domainVerificationService, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF,\n        mOnlyCore);\n        \n    //ã€15ã€‘ä¼ æ„Ÿå™¨æœåŠ¡\n    mSystemServiceManager.startService(new SensorPrivacyService(mSystemContext));\n    mSystemServiceManager.startService(SensorService.class);\n}\n```\nå¯åŠ¨æœåŠ¡åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼Œåªæ˜¯éƒ¨åˆ†åˆ—ä¸¾ï¼Œå¹¶ä¸å®Œæ•´ï¼ŒæœåŠ¡æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿå…·ä½“éƒ½åœ¨åšäº†äº›ä»€ä¹ˆï¼Ÿç­‰ç­‰ï¼ï¼ï¼è¿™äº›æ‰§è¡Œç»†èŠ‚å¸Œæœ›åœ¨ä¹‹åçš„ç³»åˆ—æ–‡ç« è¿›ä¸€æ­¥æ·±å…¥ï¼ˆå†…å®¹å®åœ¨æ˜¯å¤ªå¤šäº†ğŸ˜­ï¼‰\n\n# å¯åŠ¨ Core æœåŠ¡\n```java\n//SystemServer.java\nprivate void startCoreServices(@NonNull TimingsTraceAndSlog t) {\n    //ã€1ã€‘ä¸»è¦è´Ÿè´£è¯»å–ç³»ç»Ÿé…ç½®ä¿¡æ¯\n    mSystemServiceManager.startService(SystemConfigService.class);\n    \n    //ã€2ã€‘ç”µé‡è·Ÿè¸ª\n    mSystemServiceManager.startService(BatteryService.class);\n    \n    //ã€3ã€‘åº”ç”¨ä½¿ç”¨çŠ¶æ€è·Ÿè¸ª\n    mSystemServiceManager.startService(UsageStatsService.class);\n    \n    //ã€4ã€‘ç›‘æ§è®¾å¤‡æ˜¯å¦å……ç”µã€å±å¹•æ˜¯å¦äº®èµ·\n    //ï¼ˆé€šè¿‡é«˜ä¼˜å…ˆçº§çš„å¹¿æ’­ç›‘å¬ğŸ“¢ï¼ŒæŒ‡å®šç‰¹å®šçš„ intentfilterâ€”â€”ACTION_SCREEN_ON/ACTION_SCREEN_OFF/ACTION_BATTERY_CHANGEDï¼‰\n    mSystemServiceManager.startService(CachedDeviceStateService.class);\n    \n    //ã€5ã€‘åº”ç”¨ç¨‹åºå›æ»šï¼Ÿï¼Ÿï¼Ÿ\n    mSystemServiceManager.startService(ROLLBACK_MANAGER_SERVICE_CLASS);\n\n    //ã€6ã€‘tombstone å¢“ç¢‘ï¼Œè®°å½•è¿›ç¨‹è¢«æ€æ­»å‰çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒç”¨æ ˆã€å†…å­˜ä½¿ç”¨æƒ…å†µã€CPU ä½¿ç”¨æƒ…å†µã€backtrace ç­‰ç­‰ï¼Œä¸»è¦æ˜¯ç›‘æ§å’Œè®°å½• native å´©æºƒä¿¡æ¯ï¼ˆè·å–è¿™ä¸ªå´©æºƒæ—¥å¿—éœ€è¦ root æƒé™ï¼‰\n    mSystemServiceManager.startService(NativeTombstoneManagerService.class);\n    \n    //ã€7ã€‘Android é”™è¯¯æŠ¥å‘Šç”Ÿæˆï¼Œåº”ç”¨å´©æºƒæ—¶å€™æŸ¥çœ‹è¿™ä¸ªæŠ¥å‘Šè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼ˆå‰ææ˜¯ä½ èƒ½å¤Ÿçœ‹æ‡‚æŠ¥å‘Šï¼‰\n    // å¯ä»¥åŒ adb bugreport è·å–é”™è¯¯æŠ¥å‘Šï¼ˆAndroid ç‰ˆæœ¬ä¹‹é—´è·å–æ–¹å¼ç¨æœ‰åŒºåˆ«ï¼Œæ ¹æ® adb bugreport æç¤ºæ“ä½œå³å¯ï¼‰\n    mSystemServiceManager.startService(BugreportManagerService.class);\n\n    //ã€8ã€‘ä¸»è¦è¿˜æ˜¯ç›‘è§†å’Œæ”¶é›† GPU ä¿¡æ¯\n    mSystemServiceManager.startService(GpuService.class);    \n}\n```\n\næ ¸å¿ƒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼Œä¸»è¦æ˜¯ä¿¡æ¯è®°å½•ç›¸å…³ï¼Œå¿…ä¸å¯å°‘ã€ç¡®å®å¾ˆæ˜¯å…³é”®ã€‚\n\n# å¯åŠ¨ Other æœåŠ¡\n```java\n//SystemServer.java\n private void startOtherServices(@NonNull TimingsTraceAndSlog t) {\n\n        try {\n            //é—¹é’ŸæœåŠ¡â°\n            mSystemServiceManager.startService(ALARM_MANAGER_SERVICE_CLASS);\n            //WMS æœåŠ¡\n            mSystemServiceManager.startBootPhase(t, SystemService.PHASE_WAIT_FOR_SENSOR_SERVICE);\n            wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,\n                    new PhoneWindowManager(), mActivityManagerService.mActivityTaskManager);\n            ServiceManager.addService(Context.WINDOW_SERVICE, wm, /* allowIsolated= */ false,\n                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);\n            ServiceManager.addService(Context.INPUT_SERVICE, inputManager,\n                    /* allowIsolated= */ false, DUMP_FLAG_PRIORITY_CRITICAL);\n\n            //è“ç‰™æœåŠ¡\n            if (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) {\n                Slog.i(TAG, \"No Bluetooth Service (factory test)\");\n            } else if (!context.getPackageManager().hasSystemFeature\n                    (PackageManager.FEATURE_BLUETOOTH)) {\n                Slog.i(TAG, \"No Bluetooth Service (Bluetooth Hardware Not Present)\");\n            } else {\n                mSystemServiceManager.startService(BluetoothService.class);\n            }\n\n            //ç½‘ç»œåˆ—è¡¨ç›‘æ§æœåŠ¡\n            mSystemServiceManager.startService(NetworkWatchlistService.Lifecycle.class);\n\n            //è¾“å…¥æ³•ç®¡ç†æœåŠ¡\n            if (InputMethodSystemProperty.MULTI_CLIENT_IME_ENABLED) {\n                mSystemServiceManager.startService(\n                        MultiClientInputMethodManagerService.Lifecycle.class);\n            } else {\n                mSystemServiceManager.startService(InputMethodManagerService.Lifecycle.class);\n            }\n            \n            //è¾…åŠ©åŠŸèƒ½\n            try {\n                mSystemServiceManager.startService(ACCESSIBILITY_MANAGER_SERVICE_CLASS);\n            } catch (Throwable e) {\n                reportWtf(\"starting Accessibility Manager\", e);\n            }\n            \n            //å¼€å‘è€…é€‰é¡¹ä¸­ï¼ŒOEM è§£é”è¿˜è®°å¾—å—\n            if (hasPdb || OemLockService.isHalPresent()) {\n                mSystemServiceManager.startService(OemLockService.class);\n            }\n\n            //çŠ¶æ€æ     \n            try {\n                statusBar = new StatusBarManagerService(context);\n                ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);\n             } catch (Throwable e) {\n             }\n             \n\n\n            startContentCaptureService(context, t);\n            startAttentionService(context, t);\n            startRotationResolverService(context, t);\n            startSystemCaptionsManagerService(context, t);\n            //æ–‡å­—è¯­éŸ³è½¬æ¢\n            startTextToSpeechManagerService(context, t);\n\n            //ç³»ç»Ÿè¯­éŸ³è¯†åˆ«\n            mSystemServiceManager.startService(SPEECH_RECOGNITION_MANAGER_SERVICE_CLASS);\n            \n            //æ™ºæ…§ç©ºé—´ï¼Ÿè®°å¾—åä¸ºæ‰‹æœºæœç´¢é¡µé¢æ˜¯è¿™ä¸ªåç§°ï¼Œæœ‰çš„å«â€˜æ™ºæ…§åœºæ™¯â€™\n            mSystemServiceManager.startService(SMARTSPACE_MANAGER_SERVICE_CLASS);\n\n            //ç½‘ç»œ\n            try {\n                networkManagement = NetworkManagementService.create(context);\n                ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);\n            } catch (Throwable e) {\n            }\n            \n            //å­—ä½“\n            mSystemServiceManager.startService(new FontManagerService.Lifecycle(context, safeMode));\n\n            //Wi-Fi\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_SCANNING_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_RTT)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_RTT_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_AWARE)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_AWARE_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            if (context.getPackageManager().hasSystemFeature(\n                    PackageManager.FEATURE_WIFI_DIRECT)) {\n                mSystemServiceManager.startServiceFromJar(\n                        WIFI_P2P_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);\n            }\n            \n            //VPN\n            try {\n                vpnManager = VpnManagerService.create(context);\n                ServiceManager.addService(Context.VPN_MANAGEMENT_SERVICE, vpnManager);\n            } catch (Throwable e) {\n            }\n            t.traceEnd();\n\n            t.traceBegin(\"StartVcnManagementService\");\n            try {\n                vcnManagement = VcnManagementService.create(context);\n                ServiceManager.addService(Context.VCN_MANAGEMENT_SERVICE, vcnManagement);\n            } catch (Throwable e) {\n                reportWtf(\"starting VCN Management Service\", e);\n            }\n            t.traceEnd();\n\n            //ç³»ç»Ÿæ›´æ–°\n            try {\n                ServiceManager.addService(Context.SYSTEM_UPDATE_SERVICE,\n                        new SystemUpdateManagerService(context));\n            } catch (Throwable e) {\n            }\n            \n            //é€šçŸ¥æ \n            mSystemServiceManager.startService(NotificationManagerService.class);\n            SystemNotificationChannels.removeDeprecated(context);\n            SystemNotificationChannels.createAll(context);\n            notification = INotificationManager.Stub.asInterface(\n                    ServiceManager.getService(Context.NOTIFICATION_SERVICE));\n\n            //å£çº¸\n            if (context.getResources().getBoolean(R.bool.config_enableWallpaperService)) {\n                mSystemServiceManager.startService(WALLPAPER_SERVICE_CLASS);\n            } else {\n            }\n\n            //éŸ³é‡\n            if (!isArc) {\n                mSystemServiceManager.startService(AudioService.Lifecycle.class);\n            } else {\n                String className = context.getResources()\n                        .getString(R.string.config_deviceSpecificAudioService);\n                try {\n                    mSystemServiceManager.startService(className + \"$Lifecycle\");\n                } catch (Throwable e) {\n                }\n            }\n            \n            //æ— é™å¹¿æ’­\n            if (mPackageManager.hasSystemFeature(PackageManager.FEATURE_BROADCAST_RADIO)) {\n                t.traceBegin(\"StartBroadcastRadioService\");\n                mSystemServiceManager.startService(BroadcastRadioService.class);\n                t.traceEnd();\n            }\n        \n            //adb è°ƒè¯•\n            try {\n                mSystemServiceManager.startService(ADB_SERVICE_CLASS);\n            } catch (Throwable e) {\n                Slog.e(TAG, \"Failure starting AdbService\");\n            }\n            \n            //app å¯åŠ¨\n        mSystemServiceManager.startService(LauncherAppsService.class);\n            \n            //å¯åŠ¨å¯†ç é”\n        mSystemServiceManager.startBootPhase(t, SystemService.PHASE_LOCK_SETTINGS_READY);\n        \n        //ç´§æ¥ç€ä¼šæœ‰å„é¡¹ä¹‹å‰å¯åŠ¨çš„æœåŠ¡è°ƒç”¨ systemReady() æ–¹æ³•ï¼ŒæŒ‡å®šæœåŠ¡å‡†å¤‡å®Œæ¯•ï¼Œå³å°†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ\n        mPackageManagerService.systemReady();\n        mDisplayManagerService.systemReady(safeMode, mOnlyCore);\n        ... etc\n        \n        //ç­‰å¾…æœåŠ¡å‡†å¤‡å®Œæ¯•\n        mPackageManagerService.waitForAppDataPrepared();\n\n        //å„é¡¹æœåŠ¡è°ƒç”¨ systemRunning()ã€start() æ–¹æ³•å¼€å§‹è¿è¡ŒæœåŠ¡è‡ªèº«\n        countryDetectorF.systemRunning();\n        networkTimeUpdaterF.systemRunning();\n        inputManagerF.systemRunning();\n        telephonyRegistryF.systemRunning();\n        mmsServiceF.systemRunning();\n        ... etc\n        \n        //å¯åŠ¨ç³»ç»Ÿç•Œé¢æœåŠ¡\n        /*\n            1ã€é€šè¿‡ intent æŒ‡å®šç‰¹å®šçš„ç»„ä»¶ context.startServiceAsUser(intent, UserHandle.SYSTEM);\n            2ã€startServiceAsUser æ›´ä¸Šå±‚çš„ä»£ç å¯¹æˆ‘ä»¬çœ‹æ¥åƒæ˜¯è°ƒç”¨ context.startService\n            3ã€æŒ‡å®šçš„å¯åŠ¨çš„æœåŠ¡ç»„ä»¶ pm.getSystemUiServiceComponent() æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n                PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);\n                PackageManagerInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PackageManagerInternalImpl\n                è€Œ PackageManagerInternalImpl æ˜¯ PackageManager çš„å†…éƒ¨ç±»ï¼Œæ‰€å±æˆå‘˜æ˜¯ private final PackageManagerInternal mPmInternal;\n                è€Œ getSystemUiServiceComponent å°±æ˜¯è·å–ä¸€ä¸ª string èµ„æºcom.android.internal.R.string.config_systemUIServiceComponent\n            4ã€èµ„æºæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼šframeworks/base/core/res/res/values/config.xmlã€çœ‹è¿™ä¸ªæ–‡ä»¶æœ‰å¥½å¤šæœåŠ¡çš„ componentã€‘\n            5ã€èµ„æºå†…å®¹ \n            <!-- SystemUi service component -->\n            <string name=\"config_systemUIServiceComponent\" translatable=\"false\">com.android.systemui/com.android.systemui.SystemUIService</string>\n        */\n        startSystemUi(context, windowManagerF);\n    }\n}\n```\n\n## å¯åŠ¨ SystemUI æœåŠ¡\n\n```java\n//SystemServer.java\nprivate static void startSystemUi(Context context, WindowManagerService windowManager) {\n    PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);\n    Intent intent = new Intent();\n    /*\n        1ã€å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæœåŠ¡ component: com.android.systemui/com.android.systemui.SystemUIService\n        2ã€æ­¤æœåŠ¡ Java å®ç°ç±»æ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/src/com/android/systemui/SystemUIService.java\n        3ã€è¿™ä¸ªç±»æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæˆå‘˜åˆ†åˆ«è´Ÿè´£ä¸åŒçš„äº‹æƒ…\n            mainHandle  ï¼šä¸»çº¿ç¨‹é€šè®¯ï¼Œæ˜çŸ¥æ•…é—®\n            dumpHandle  ï¼šå½“å‰çº¿ç¨‹è¿è¡ŒçŠ¶æ€ä¿¡æ¯è¾“å‡º\n            logBufferFreezer   ï¼šè´Ÿè´£é”™è¯¯æŠ¥å‘Šæ—¥å¿—ç›¸å…³ã€é”™è¯¯æŠ¥å‘Š-å‚è€ƒé“¾æ¥ã€‘\n            \n        4ã€system server è¿›ç¨‹å¯åŠ¨çš„ UI æœåŠ¡ï¼šæ¥åˆ°äº† SystemUIApplication.java è¿™ä¸ªç±» ((SystemUIApplication) getApplication()).startServicesIfNeeded();\n            æ‰€æœ‰çš„ UI æœåŠ¡åŒ…å«å“ªäº›ï¼ŸæœåŠ¡åç§°åˆ—è¡¨å“ªé‡Œæ¥ï¼Ÿåˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„èµ„æº config_systemUIServiceComponents R.array.config_systemUIServiceComponentsPerUser\n            èµ„æºæ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/res/value/config.xml\n            \n            4.1ã€æœåŠ¡åˆ—è¡¨å‚è€ƒä¸‹æ–‡ã€‘\n            4.2 é€šè¿‡åå°„åˆ›å»ºæœåŠ¡ Class.forname(serviceName) è°ƒç”¨æŒ‡å®šæ„é€ å‡½æ•° newInstance\n            4.3 å¯åŠ¨æœåŠ¡ mServices[i].start(); æ¥ä¸‹æ¥å°±ä¸å…·ä½“çœ‹äº†ï¼Œä»¥åå…·ä½“æœåŠ¡å…·ä½“åˆ†æ\n            \n        5ã€SysteUIApplication ä»–æ˜¯ä¸€ä¸ª Applicationï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰åˆ›å»ºè¯¥å®ä¾‹æ˜¯ä¼šå…ˆæ‰§è¡Œ onCreate æ–¹æ³•ï¼Œ\n            è¿™é‡Œæœ‰è°ƒç”¨ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå¯¹äºéç§æœ‰çš„éç³»ç»Ÿç”¨æˆ·å°†æ‰§è¡Œ startSecondaryUserServicesIfNeeded();\n            è·å–çš„æœåŠ¡åˆ—è¡¨æ˜¯ R.array.config_systemUIServiceComponentsPerUser æŸ¥çœ‹åªæœ‰ä¸€ä¸ªæœåŠ¡\n            \n            5.1 com.android.systemui.util.NotificationChannels\n            \n    intent.setComponent(pm.getSystemUiServiceComponent());\n    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);\n    context.startServiceAsUser(intent, UserHandle.SYSTEM);\n    windowManager.onSystemUiStarted();\n}\n```\n\n**system UI æœåŠ¡åˆ—è¡¨**\n```xml\n//é€šçŸ¥æ¸ é“æœåŠ¡ï¼ˆAndroid ä½ç‰ˆæœ¬çš„é€šçŸ¥åˆ›å»ºæ˜¯ä¸éœ€è¦è®¾ç½®é€šçŸ¥æ¸ é“ï¼Œåæ¥é«˜ç‰ˆæœ¬å¼•å…¥é€šçŸ¥æ¸ é“å¹¶ä¸”å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™é€šçŸ¥æ˜¾ç¤ºå­˜åœ¨å¼‚å¸¸ï¼‰\n<item>com.android.systemui.util.NotificationChannels</item> \n<item>com.android.systemui.keyguard.KeyguardViewMediator</item> \n//åº”ç”¨æœ€è¿‘ä»»åŠ¡åˆ—è¡¨\n<item>com.android.systemui.recents.Recents</item> \n//éŸ³é‡\n<item>com.android.systemui.volume.VolumeUI</item> \n<item>com.android.systemui.stackdivider.Divider</item> \n//çŠ¶æ€æ \n<item>com.android.systemui.statusbar.phone.StatusBar</item>\n<item>com.android.systemui.usb.StorageNotification</item> \n<item>com.android.systemui.power.PowerUI</item> \n<item>com.android.systemui.media.RingtonePlayer</item> \n//é”®ç›˜\n<item>com.android.systemui.keyboard.KeyboardUI</item> \n<item>com.android.systemui.pip.PipUI</item> \n<item>com.android.systemui.shortcut.ShortcutKeyDispatcher</item> \n<item>@string/config_systemUIVendorServiceComponent</item> \n<item>com.android.systemui.util.leak.GarbageMonitor$Service</item> \n<item>com.android.systemui.LatencyTester</item> \n<item>com.android.systemui.globalactions.GlobalActionsComponent</item> <item>com.android.systemui.ScreenDecorations</item> \n<item>com.android.systemui.biometrics.AuthController</item> \n<item>com.android.systemui.SliceBroadcastRelayHandler</item> \n<item>com.android.systemui.SizeCompatModeActivityController</item> \n<item>com.android.systemui.statusbar.notification.InstantAppNotifier</item> \n<item>com.android.systemui.theme.ThemeOverlayController</item> \n<item>com.android.systemui.accessibility.WindowMagnification</item> \n<item>com.android.systemui.accessibility.SystemActions</item> \n<item>com.android.systemui.toast.ToastUI</item>\n```\n\nSystem Server å¤§æ¦‚æ˜¯å¯åŠ¨å®Œæˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆå»å“ªé‡Œè¿è¡Œäº†å‘¢ï¼Ÿï¼Ÿï¼Ÿæˆ–è€…ä¸‹ä¸€æ­¥æˆ‘ä»¬ç»§ç»­çœ‹é‚£ä¸ªç‚¹æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿï¼Ÿï¼Ÿä¹‹å‰æˆ‘ä»¬åªæ˜¯ç²—ç•¥æµè§ˆï¼Œä¸­é—´å¿½ç•¥äº†å¾ˆå¤šï¼Œä¸‹ä¸€æ­¥çš„å…¥å£ç‚¹å¯èƒ½è¦è¿”å›ä¹‹å‰çš„ä»£ç é‡æ–°é˜…è¯»å‘ç°åˆé€‚çš„åˆ‡å…¥ç‚¹ï¼ŒSystemServer ä¹Ÿå·²ç»è¿›å…¥äº†â€˜æ°¸ä¹…çš„å¾ªç¯â€™ï¼Œç­‰å¾…çš„å°±æ˜¯æ¥å—å¤–éƒ¨â€˜ä¿¡å·â€™åšç›¸åº”å¤„ç†ã€ç»§ç»­åˆ†å‘åˆ°å…·ä½“æ‰§è¡Œã€‚ \n\né‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸‹å‘¨å†è§ğŸ˜Š\n\n# é™„åŠ \n\n## å¦‚ä½•å¿«é€Ÿæœç´¢\n**Android é¡¹ç›®ä¸­å¦‚ä½•å¿«é€Ÿæœç´¢æŸå…³é”®å­—ï¼Ÿ**\n\nAOSP æ•´ä¸ªé¡¹ç›®æ˜¯å¾ˆåºå¤§çš„ï¼Œä¸ä»…ä»…æ˜¯åŒ…å« java ä»£ç ï¼Œå°±æ‹¿å½“å‰æˆ‘ä¸‹è½½çš„ `Android 11-r21 åˆ†æ”¯`æ¥è¯´ï¼Œæˆ‘æ˜¯é€šè¿‡ git ä¸‹è½½åœ¨æ²¡æœ‰æŒ‡å®š `single-branch dept=1` å‚æ•°ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸‹è½½å®Œæ¯•å ç”¨å¤§çº¦ **430G** å­˜å‚¨ç©ºé—´ã€‚\n\nä¸€å¼€å§‹æˆ‘æŠŠæºç å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ï¼Œé€šè¿‡ VSCode æ‰“å¼€æœºå­˜åœ¨æ¢°ç¡¬ç›˜çš„ä¸­çš„é¡¹ç›®ï¼ˆæ•´ä¸ª AOSPï¼‰ï¼Œæ¯”å¦‚æœç´¢æŸä¸ªå…³é”®å­—ï¼Œé‚£ä¸ªé€Ÿåº¦å ªæ¯”é¾Ÿé€Ÿï¼›åæ¥æŠŠé¡¹ç›®æ‹·è´åˆ°ç¬”è®°æœ¬ SSD å›ºæ€ç¡¬ç›˜ï¼Œæœç´¢é€Ÿåº¦ç¡®å®æœ‰äº†æ˜æ˜¾çš„æé«˜ï¼Œä½†æ•´ä¸ªé¡¹ç›®æœç´¢è¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼Œä¸æ˜¯ååˆ†æ»¡æ„ï¼›å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€æŸä¸ªæ¨¡å—â€”â€”â€” framework æ¨¡å—ã€framework base æ¨¡å—ç­‰ç­‰ï¼Œæœç´¢é€Ÿåº¦è¿˜å¯ä»¥æ¥å—ã€‚ä½†å¦‚æœè¦æ‰¾çš„ä»£ç æ ¹æœ¬ä¸åœ¨å½“å‰æ¨¡å—ï¼Œæ¯”å¦‚ä½ æ‰“å¼€ framework base æ¨¡å—ï¼Œä½†å®é™…ä»£ç åœ¨ framework service æ¨¡å—ï¼Œè¿™æ ·æ˜¯æœç´¢ä¸åˆ°ç»“æœçš„ï¼Œå› æ­¤è¿˜å¾—æŠŠæœç´¢èŒƒå›´æ‰©å¤§ï¼Œå¼•å…¥çš„æ¨¡å—å¤šäº†é€Ÿåº¦ç»ˆæ˜¯ä¼šå˜æ…¢ã€‚\n\næœç´¢èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç›®æ ‡ï¼Œæ˜¯ä¸æ˜¯è¦å€ŸåŠ©ä¸€ä¸ªä¸œè¥¿â€”â€”â€”â€”**ç´¢å¼•**ï¼Œå¦‚æœæœ‰å·¥å…·æŠŠ AOSP æ•´ä¸ªé¡¹ç›®é¢„å…ˆå»ºç«‹ç´¢å¼•ï¼Œç„¶åå†æ‰“å¼€é¡¹ç›®æœç´¢ï¼Œä¸‹æ¬¡æœç´¢æ—¶æ— éœ€é‡æ–°åˆ›å»ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æœç´¢ä¸å¾—è¦èµ·é£ã€‚~~ä¸æœç´¢ç›¸å…³ç´¢å¼•ç¡®å®æ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚~~\n\n\nã€**æœ€å**ã€‘\n\næ¨èä½¿ç”¨å·²æœ‰çš„åœ¨çº¿ç½‘ç«™è¾…åŠ©æœç´¢ï¼š[**åŸºäº opengrok çš„ AOSPXRef**](http://aospxref.com)\n\nä»¥æœç´¢ SystemUIService `config_systemUIServiceComponent`ä¸ºä¾‹ï¼š\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6d6877806a144cfb2a73a40aa569c01~tplv-k3u1fbpfcp-watermark.image?)\n\nã€**æœ€åçš„æœ€å**ã€‘\n\nASOPXRef ç°æœ‰çš„é¡¹ç›®æ˜¯è¾ƒå°‘çš„ï¼Œä¹Ÿå°±æ˜¯å‡ ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œå¦‚æœèƒ½æ»¡è¶³è‡ªå·±çš„éœ€æ±‚åˆšå¥½ï¼Œè¦æ˜¯æƒ³çœ‹çš„æºç ç‰ˆæœ¬ä¸æ˜¯å·²å­˜åœ¨çš„å»ºè®®è¿˜æ˜¯è‡ªå·±é€šè¿‡ `opengrok` å¼•æ“æ­å»ºä¸€ä¸ªæœåŠ¡ã€‚\n**Oracle opengrokï¼š**[å¿«é€Ÿä¸”å¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“](https://github.com/oracle/opengrok)\n\n\n\n## å‚è€ƒé“¾æ¥\n- WTFï¼šWhat a Terrible Failure â€”â€” Android ç³»ç»Ÿé”™è¯¯è®°å½•çš„ä¸€ç§\n- Memtrackï¼šå†…å­˜åˆ†æ https://zhuanlan.zhihu.com/p/168361476\n- Hidlï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼Œåœ¨è¾ƒä½ Android ç‰ˆæœ¬å¯èƒ½è¿˜åœ¨ä½¿ç”¨ HAL ï¼ˆhardware abstract layerï¼‰https://zhuanlan.zhihu.com/p/28256541\n- Android Uriï¼šhttps://www.cnblogs.com/bhlsheji/p/4246580.html\n- Android é”™è¯¯æŠ¥å‘Šï¼šhttps://developer.android.com/studio/debug/bug-report ï¼Œhttps://source.android.com/source/read-bug-reports.html\n- Android å¢“ç¢‘ï¼šhttps://source.android.com/devices/tech/debug\n\n","slug":"Androidç³»ç»Ÿå¯åŠ¨systemserverè¿›ç¨‹","published":1,"lang":"undefined","updated":"2022-09-29T14:57:13.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsm0006gaqp7m2t9fpu","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p><strong>ç›¸å…³æ–‡ä»¶</strong></p>\n<ul>\n<li>/framework/base/service/java/com/android/server/SystemServer.java</li>\n<li>/framework/base/service/java/com/android/server/SystemServiceManager.java</li>\n<li>/framework/base/service/java/com/android/server/WatchDog.java</li>\n<li>/frameworks/base/core/java/com/android/server/SystemConfig.java</li>\n<li>â€¦ etc</li>\n</ul>\n<h1>è¿è¡Œ System server</h1>\n<p>ç»è¿‡å‰ä¸¤ç¯‡çš„ç³»ç»Ÿæ–‡ç« ï¼Œå·²ç»å®Œæˆäº† initã€zygote è¿›ç¨‹çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå³å°†å¯åŠ¨ç³»ç»Ÿå„å¤§æœåŠ¡ï¼Œå„é¡¹æœåŠ¡ç”±æœåŠ¡ç®¡ç†è€… <code>System server</code> å®Œæˆåˆ›å»ºå’Œå¯åŠ¨ï¼Œé‚£ä¹ˆèµ¶ç´§è¿›å…¥ç§ç§å» <code>/framework/base/service/java/com/android/server/SystemServer.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SystemServer</span> <span class=\"keyword\">implements</span> <span class=\"title\">Dumpable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆ—ä¸¾å‡ ä¸ªè®¤ä¸ºé‡è¦çš„æˆå‘˜</span></span><br><span class=\"line\">    </span><br><span class=\"line\">   <span class=\"comment\">//ç±»ä¼¼è¿™æ ·çš„æœåŠ¡åç§°ä¸å°‘äº 50 ä¸ª</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WIFI_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.wifi.WifiService&quot;</span>;                  <span class=\"comment\">//Wi-FiæœåŠ¡</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WIFI_SCANNING_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.wifi.scanner.WifiScanningService&quot;</span>;  <span class=\"comment\">//Wi-Fi æ‰«æ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ALARM_MANAGER_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.alarm.AlarmManagerService&quot;</span>;         <span class=\"comment\">//é—¹é’Ÿ</span></span><br><span class=\"line\">    ... etc</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç³»ç»Ÿé»˜è®¤çš„å¯¹è¯æ¡†ç­‰ä¸»é¢˜</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_SYSTEM_THEME =</span><br><span class=\"line\">           com.android.internal.R.style.Theme_DeviceDefault_System;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¾ˆé‡è¦çš„ä¸€ä¸ªä¸»è§’ï¼Œç³»ç»ŸæœåŠ¡ç®¡ç†è€…</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SystemServiceManager mSystemServiceManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…·ä½“æœåŠ¡å®ç°ç±»</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ActivityManagerService mActivityManagerService;  <span class=\"comment\">//Activity ç®¡ç†</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PackageManagerService mPackageManagerService;    <span class=\"comment\">//å®‰è£…åŒ…ç®¡ç†</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ContentResolver mContentResolver;                <span class=\"comment\">//å†…å®¹è§£æâ€”â€”å†…å®¹æä¾›è€…æ•°æ®è§£æ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DisplayManagerService mDisplayManagerService;    <span class=\"comment\">//è®¾å¤‡æ˜¾ç¤ºç›¸å…³</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœ‹å˜é‡åå°±å¾ˆæ¸…æ™°ï¼Œapplication é”™è¯¯æŠ¥å‘Šä¿¡æ¯è®°å½•</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> LinkedList&lt;Pair&lt;String, ApplicationErrorReport.CrashInfo&gt;&gt; sPendingWtfs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//memtrackerï¼šmemory tracker ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">startMemtrackProxyService</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Hidl Hardware Interface Definition Language ç¡¬ä»¶æŠ½è±¡å±‚è¯­è¨€ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">startHidlServices</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è°ƒè¯•æ¨¡å¼ä¸‹æˆ‘ä»¬åº”ç”¨è¿›ç¨‹èƒ½å¤Ÿ dump headï¼Œdump file æ˜¯è¿›ç¨‹çš„å†…å­˜é•œåƒï¼ŒæŠŠè¿›ç¨‹å½“å‰ä¿å­˜çš„çŠ¶æ€ä¿å­˜åˆ° dump æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"comment\">//head dump å…¶å®åˆ©ç”¨ Android studio å†…ç½®çš„å·¥å…·ï¼ˆAndroid profileã€Memory profileï¼‰ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ï¼Œç›´æ¥å¸®ä½ æŠŠæ–‡ä»¶å¯è§†åŒ–</span></span><br><span class=\"line\">    <span class=\"comment\">//ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜è·¯å¾„ /data/system/heapdump/</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">initZygoteChildHeapProfiling</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ä»ä¸»å‡½æ•°å¼€å§‹æ‰§è¡Œ</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> SystemServer().run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SystemServer</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//è®°å½•æ€§ä¿¡æ¯ï¼Œä¸å½±å“ç»§ç»­é˜…è¯»å§ï¼Œä¸»è¦è¿˜æ˜¯åé¢çš„ run æ–¹æ³•</span></span><br><span class=\"line\"></span><br><span class=\"line\">    mFactoryTestMode = FactoryTest.getMode();</span><br><span class=\"line\">    mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, <span class=\"number\">0</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\">    mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();</span><br><span class=\"line\">    mRuntimeStartUptime = SystemClock.uptimeMillis();</span><br><span class=\"line\">    Process.setStartTimes(mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class=\"line\"></span><br><span class=\"line\">    mRuntimeRestart = <span class=\"string\">&quot;1&quot;</span>.equals(SystemProperties.get(<span class=\"string\">&quot;sys.boot_completed&quot;</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ï¼Œè®°å½•è¿›ç¨‹å¯åŠ¨ä¿¡æ¯ï¼Œå¯åŠ¨æ¬¡æ•°ç­‰</span></span><br><span class=\"line\">    SystemProperties.set(SYSPROP_START_COUNT,String.valueOf(mStartCount));</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœå½“å‰æ—¶åŒºæ— æ•ˆå°†è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ GMT â€”â€” æ ¼æ—å¨æ²»æ—¶é—´</span></span><br><span class=\"line\">    SystemProperties.set(<span class=\"string\">&quot;persist.sys.timezone&quot;</span>, <span class=\"string\">&quot;GMT&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœçŸ¥é“äº†è¯­è¨€ï¼Œå°è¯•é€šè¿‡è¯­è¨€è®¾ç½®åœ°åŒºå±æ€§</span></span><br><span class=\"line\">    <span class=\"comment\">//ã€presist å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯å¯å†™çš„ï¼Œro å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯åªè¯»çš„ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!SystemProperties.get(<span class=\"string\">&quot;persist.sys.language&quot;</span>).isEmpty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String languageTag = Locale.getDefault().toLanguageTag();</span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;persist.sys.locale&quot;</span>, languageTag); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/*å‰é¢éƒ½æ˜¯åœ¨è®¾ç½®ä¸€äº›ç³»ç»Ÿå±æ€§ï¼Œæ¥ä¸‹æ¥å°†è¦çœŸæ­£å¯åŠ¨æœåŠ¡*/</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//SystemClock.elapsedRealtime();  è·å–è®¾å¤‡å¯åŠ¨åˆ°å½“å‰çš„æ¯«ç§’å€¼</span></span><br><span class=\"line\">    <span class=\"comment\">//æ¸…ç†ä¸€æ¬¡å†…å­˜ï¼Œä¸º application å¯ä»¥åˆ†é…å¾—åˆ°æ›´å¤šå†…å­˜</span></span><br><span class=\"line\">    VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å‡†å¤‡çº¿ç¨‹ç­–ç•¥ THREAD_PRIORITY_FOREGROUNDï¼šåº”ç”¨ç¨‹åºä¸å¾—æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ã€ä¸å¾—æ›´æ”¹çº¿ç¨‹æ•°é‡ï¼Œè¿™äº›å°†ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´</span></span><br><span class=\"line\">    android.os.Process.setThreadPriority(</span><br><span class=\"line\">        android.os.Process.THREAD_PRIORITY_FOREGROUND); </span><br><span class=\"line\">    <span class=\"comment\">//è¿™æ˜¯å¯¹å‰ä¸€æ¡è¯­å¥è®¾ç½®å‰å°è¿›ç¨‹çš„é™åˆ¶ THREAD_PRIORITY_FOREGROUNDï¼Œè¿™é‡Œä¼ å…¥ falseï¼Œå¦‚æœæ­¤å‰è®¾ç½®çš„çº¿ç¨‹ç­–ç•¥æ˜¯â€˜åå°è¿›ç¨‹ç»„â€™å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class=\"line\">    android.os.Process.setCanSelfBackground(<span class=\"keyword\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Looper æ˜¯çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œè¿™é‡Œçš„çº¿ç¨‹è‡ªç„¶æ˜¯æ‰§è¡Œçš„ä¸»çº¿ç¨‹ Main-Threadï¼Œä¹Ÿå°±æ˜¯ application æ‰€åœ¨çº¿ç¨‹</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œæœ‰ä¸€ä¸ªç»å…¸å…«è‚¡æ–‡ğŸ˜Šï¼šè‡ªå®šä¹‰å­çº¿ç¨‹ Looper éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ prepareLooperï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸»çº¿ç¨‹çš„ Looper å‰ä¸éœ€è¦å…ˆè°ƒç”¨ prepare Looperï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//       Aç­”ï¼šè°ƒç”¨æ—¶è‚¯å®šè¦è°ƒç”¨çš„ã€‚è¿™ä¸æ˜¯åºŸè¯å—ï¼Œæˆ‘ä»¬ä¸è°ƒç”¨é‚£è‚¯å®šæ˜¯â€˜åˆ«äººâ€™å·²ç»åœ¨æˆ‘ä»¬ä½¿ç”¨å‰å°±è°ƒç”¨äº†â€”â€”â€”â€”é‚£è¿™ä¸ªâ€˜åˆ«äººâ€™å…¶å®å°±æ˜¯ Android env åœ¨åˆ›å»ºæ—¶å€™è°ƒç”¨äº†</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿™ä¸ª application main loop è¢«ç³»ç»Ÿç¼“å­˜åœ¨ Looper.java ä¸­ï¼ˆstatic final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">//æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æ˜¯é€šè¿‡ï¼š Looper.getMainLooper()</span></span><br><span class=\"line\">    Looper.prepareMainLooper();</span><br><span class=\"line\">    Looper.getMainLooper().setSlowLogThresholdMs(</span><br><span class=\"line\">        SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ mSystemContext ä»¥åŠè®¾ç½®ä¸Šè¿°çš„é»˜è®¤ä¸»é¢˜</span></span><br><span class=\"line\">    createSystemContext();</span><br><span class=\"line\">    <span class=\"comment\">//ç»§ç»­</span></span><br><span class=\"line\">    mSystemServiceManager = <span class=\"keyword\">new</span> SystemServiceManager(mSystemContext);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨è¯»å–ç³»ç»Ÿå…¨å±€é…ç½®çš„çº¿ç¨‹æ± ï¼Œä¸‹é¢å¯åŠ¨æœåŠ¡å¯åŠ¨æ—¶å€™å°†ä¼šç”¨åˆ°</span></span><br><span class=\"line\">    <span class=\"comment\">//ä»€ä¹ˆæ—¶å€™å…³é—­çº¿ç¨‹æ± å‘¢ï¼Ÿif (phase == SystemService.PHASE_BOOT_COMPLETED)&#123;SystemServerInitThreadPool.shutdown();&#125;</span></span><br><span class=\"line\">    SystemServerInitThreadPool tp = SystemServerInitThreadPool.start();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€é‡ç‚¹ã€é‡ç‚¹ã€é‡ç‚¹ã€‘</span></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å„ç§ Service</span></span><br><span class=\"line\">    startBootstrapServices(t);  <span class=\"comment\">//å¯åŠ¨æœåŠ¡</span></span><br><span class=\"line\">    startCoreServices(t);       <span class=\"comment\">//æ ¸å¿ƒæœåŠ¡</span></span><br><span class=\"line\">    startOtherServices(t);      <span class=\"comment\">//å…¶ä»–æœåŠ¡</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸€ä¸ªæ£€æµ‹å·¥å…·</span></span><br><span class=\"line\">    StrictMode.initVmDefaults(<span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"comment\">//è¿›å…¥ä¸€ä¸ªæ— çœ çš„ä¸–ç•Œé»˜é»˜`æ‰“å·¥`ï¼Œä¸ºâ€˜äººæ°‘â€™æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€è·å¾—å½“å‰çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueue</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åœ¨ for(;;) å¾ªç¯ä¸­ä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ¶ˆæ¯ï¼Œqueue.next()ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿‡ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¦‚æœè·å–åˆ°å¯ç”¨çš„æ¶ˆæ¯åˆ™è¿›è¡Œåˆ†å‘ msg.target.dispatchMessage(msg)</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€æ¶ˆæ¯åˆ†å‘ä¹‹åè¿›è¡Œå›æ”¶æˆ–æ¸…ç† msg.recycleUnChecked()</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    Looper.loop();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>å¯åŠ¨ Bootstrap æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startBootstrapServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€1ã€‘watchdog çœ‹é—¨ğŸ¶ï¼Ÿçœ‹ç€æ˜¯æœ‰è¿™ä¸ªæ„æ€ï¼Œå¤§æ¦‚å°±æ˜¯ç›‘æ§æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å®ƒè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­ mThread = new Thread(this::run, &quot;watchdog&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€ä¸»è¦æ˜¯æ£€æŸ¥ä¸€äº›çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒåº¦æƒ…å†µï¼Œæ¯”å¦‚æ£€æŸ¥çš„çº¿ç¨‹æœ‰å‰å°çº¿ç¨‹ã€IOã€UIã€mainã€displayã€animationã€surface animation ç­‰çº¿ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Watchdog watchdog = Watchdog.getInstance();</span><br><span class=\"line\">    watchdog.start();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€2ã€‘åŠ è½½å…¨å±€ç³»ç»Ÿé…ç½®ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æ­¤çº¿ç¨‹æ± åœ¨ SystemServer å¯åŠ¨æ—¶å€™æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åœ¨ SystemServer å¯åŠ¨å®Œæˆä¹‹åå…³é—­ SystemService.PHASE_BOOT_COMPLETE</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€è°ƒç”¨ submit æ–¹æ³•çœŸæ­£æ‰§è¡Œç³»ç»Ÿå…¨å±€é…ç½®è¯»å–çš„æ–¹æ³•åœ¨å“ªé‡Œï¼Ÿçº¿ç¨‹æ± æäº¤ä¹‹åæ‰§è¡Œçš„å½“ç„¶æ˜¯ run æ–¹æ³•ã€‚è°çš„ run æ–¹æ³•ï¼ŸSystemConfig::getInstance åˆæ˜¯å•¥ï¼Œåœ¨å“ªé‡Œï¼Ÿã€ä¸è§£ï¼ŒçŸ¥è€…æ¬¢è¿è¯„è®ºã€‘</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€SystemConfig::getInstanceï¼šJava èƒ½å¤Ÿä½¿ç”¨åŒå¼•å·è®¿é—®é™æ€æ–¹æ³•ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘åªçŸ¥é“ cpp æ˜¯å¯ä»¥è¿™æ ·çš„ï¼Œåæ¥æŸ¥äº†ä¸€ä¸‹ä¼¼ä¹æ˜¯ lambada çš„è¯­æ³•ç³–ğŸ˜ºä¸çŸ¥è€…æ— ç½ª</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€readPublicNativeLibrariesList();//String[] dirs = &#123;&quot;/system/etc&quot;, &quot;/system_ext/etc&quot;, &quot;/product/etc&quot;,&quot;vendor/etc&quot;&#125;;è¯»å–æ­¤ç›®å½•ä¸‹ public.libraries- å¼€å¤´ï¼Œ.txt ç»“å°¾çš„é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">        6ã€readAllPermissions();//è§£ææ ¹ç›®å½•ã€Vendorç›®å½•ç­‰ etc/sysconfigã€etc/permission ä¸‹ XML æƒé™æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> String TAG_SYSTEM_CONFIG = <span class=\"string\">&quot;ReadingSystemConfig&quot;</span>;</span><br><span class=\"line\">    SystemServerInitThreadPool.submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€3ã€‘å…¬å…±æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å°†æ¥ ActivityManagerServiceã€PackageManagerService ...etc ä¼šä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€è°ƒç”¨ addService ä¸€çœ‹æµç¨‹æœ€ç»ˆåˆ°äº† IServiceManager.cpp è—å¾—è¿™ä¹ˆæ·±ï¼ŒçœŸæ˜¯æœäº†è¿™ä¸ªè€ sixï¼Œsp&lt;AidlServiceManager&gt; mTheRealServiceManager;   </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    PlatformCompat platformCompat = <span class=\"keyword\">new</span> PlatformCompat(mSystemContext);</span><br><span class=\"line\">    ServiceManager.addService(Context.PLATFORM_COMPAT_SERVICE, platformCompat);</span><br><span class=\"line\">    ServiceManager.addService(Context.PLATFORM_COMPAT_NATIVE_SERVICE,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> PlatformCompatNative(platformCompat));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€4ã€‘æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    mSystemServiceManager.startService(FileIntegrityService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€5ã€‘åº”ç”¨ç¨‹åºå®‰è£…ç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€6ã€‘è®¾å¤‡æ ‡è¯†è®¿é—®ç­–ç•¥æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€è·å–æ‰‹æœºåºåˆ—å·ï¼šgetSerial()ï¼Œç³»ç»Ÿå±æ€§å¯¹åº”é”® ro.serialnã€‚è°ƒç”¨æ—¶</span></span><br><span class=\"line\"><span class=\"comment\">elephonyPermissions.checkCallingOrSelfReadDeviceIdentifiers</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€æŒ‡å®šåŒ…åè·å–åºåˆ—å· getSerialForPackageï¼Œå…¶ä¸­å†æ ¹æ®åŒ…å + å½“å‰ç”¨æˆ·IDè·å–è°ƒç”¨æ­¤ç±»çš„ UIDï¼Œæ‰€ä»¥çŒœæµ‹è¿˜æœ‰æœ‰ä¸å°‘é™åˆ¶çš„ï¼Œæ¯”å¦‚é™åˆ¶é root ç”¨æˆ·ã€é™åˆ¶éç³»ç»Ÿåº”ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    SystemServiceManager.startService(DeviceIdentifiersPolicyService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€7ã€‘URI æˆæƒç®¡ç†æœåŠ¡ ï¼ˆå…³äº Uri å¯å‚è€ƒé“¾æ¥ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€8ã€‘ç”µæ± ç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ç”µé‡ğŸ”‹è§¦å‘å™¨BatteryTrigger mBatteryTriggerï¼Œé€šè¿‡å¹¿æ’­ç›‘å¬ç”µé‡å˜åŒ–ï¼Œå½“ç”µé‡ä¸‹é™1%å°†ä¼šæ¥æ”¶åˆ°å¹¿æ’­ï¼Œä¼¼ä¹åªåšä¸€ä»¶äº‹ï¼šå°±æ˜¯æ›´æ–°æœ€æ–°ç”µé‡ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED); é€šè¿‡ context æ³¨å†Œå¹¿æ’­</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mSystemServiceManager.startService(PowerStatsService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€9ã€‘å†…å­˜åˆ†ææœåŠ¡  ï¼ˆnative è°ƒç”¨ï¼‰</span></span><br><span class=\"line\">    startMemtrackProxyService();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€10ã€‘AMS æœåŠ¡ï¼ˆç»ˆäºçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ğŸ¶ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€é«˜ç‰ˆæœ¬ä»»åŠ¡æ ˆç®¡ç†ç±»ä¼¼ä¹è¢«åˆ†ç¦»å‡ºæ¥äº†ï¼Œç”± ActivityTaskManagerService å®ç°ï¼Œå†…å®¹å¤ªå¤šï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    ActivityTaskManagerService atm = mSystemServiceManager.startService(</span><br><span class=\"line\">        ActivityTaskManagerService.Lifecycle.class).getService();</span><br><span class=\"line\">    mActivityManagerService = ActivityManagerService.Lifecycle.startService(</span><br><span class=\"line\">        mSystemServiceManager, atm);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€11ã€‘æ•°æ®åŠ è½½</span></span><br><span class=\"line\">    mDataLoaderManagerService = mSystemServiceManager.startService(</span><br><span class=\"line\">        DataLoaderManagerService.class);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//ã€12ã€‘ç”µæºç®¡ç†æœåŠ¡ï¼Œä¹‹å‰é‚£ä¸ªæ—¶ç”µæ± çŠ¶æ€ç®¡ç†ï¼ˆåªåšäº†ä¸€ä»¶äº‹ï¼šç›‘å¬ç”µé‡å˜åŒ–ï¼‰</span></span><br><span class=\"line\">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€13ã€‘ç³»ç»Ÿæ¢å¤æœåŠ¡ï¼Œæˆ‘ä»¬åˆ·æœºå¸¸è§çš„ Recover æ¨¡å¼</span></span><br><span class=\"line\">    mSystemServiceManager.startService(RecoverySystemService.Lifecycle.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€14ã€‘å®‰è£…åŒ…ç®¡ç†æœåŠ¡ï¼Œè¿™æ˜¯ä¸ªå¤§ç±»ï¼Œä¸‰ä¸‡è¡Œå‘¢ï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹</span></span><br><span class=\"line\">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class=\"line\">        domainVerificationService, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF,</span><br><span class=\"line\">        mOnlyCore);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//ã€15ã€‘ä¼ æ„Ÿå™¨æœåŠ¡</span></span><br><span class=\"line\">    mSystemServiceManager.startService(<span class=\"keyword\">new</span> SensorPrivacyService(mSystemContext));</span><br><span class=\"line\">    mSystemServiceManager.startService(SensorService.class);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨æœåŠ¡åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼Œåªæ˜¯éƒ¨åˆ†åˆ—ä¸¾ï¼Œå¹¶ä¸å®Œæ•´ï¼ŒæœåŠ¡æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿå…·ä½“éƒ½åœ¨åšäº†äº›ä»€ä¹ˆï¼Ÿç­‰ç­‰ï¼ï¼ï¼è¿™äº›æ‰§è¡Œç»†èŠ‚å¸Œæœ›åœ¨ä¹‹åçš„ç³»åˆ—æ–‡ç« è¿›ä¸€æ­¥æ·±å…¥ï¼ˆå†…å®¹å®åœ¨æ˜¯å¤ªå¤šäº†ğŸ˜­ï¼‰</p>\n<h1>å¯åŠ¨ Core æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startCoreServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//ã€1ã€‘ä¸»è¦è´Ÿè´£è¯»å–ç³»ç»Ÿé…ç½®ä¿¡æ¯</span></span><br><span class=\"line\">    mSystemServiceManager.startService(SystemConfigService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€2ã€‘ç”µé‡è·Ÿè¸ª</span></span><br><span class=\"line\">    mSystemServiceManager.startService(BatteryService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€3ã€‘åº”ç”¨ä½¿ç”¨çŠ¶æ€è·Ÿè¸ª</span></span><br><span class=\"line\">    mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€4ã€‘ç›‘æ§è®¾å¤‡æ˜¯å¦å……ç”µã€å±å¹•æ˜¯å¦äº®èµ·</span></span><br><span class=\"line\">    <span class=\"comment\">//ï¼ˆé€šè¿‡é«˜ä¼˜å…ˆçº§çš„å¹¿æ’­ç›‘å¬ğŸ“¢ï¼ŒæŒ‡å®šç‰¹å®šçš„ intentfilterâ€”â€”ACTION_SCREEN_ON/ACTION_SCREEN_OFF/ACTION_BATTERY_CHANGEDï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(CachedDeviceStateService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€5ã€‘åº”ç”¨ç¨‹åºå›æ»šï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">    mSystemServiceManager.startService(ROLLBACK_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€6ã€‘tombstone å¢“ç¢‘ï¼Œè®°å½•è¿›ç¨‹è¢«æ€æ­»å‰çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒç”¨æ ˆã€å†…å­˜ä½¿ç”¨æƒ…å†µã€CPU ä½¿ç”¨æƒ…å†µã€backtrace ç­‰ç­‰ï¼Œä¸»è¦æ˜¯ç›‘æ§å’Œè®°å½• native å´©æºƒä¿¡æ¯ï¼ˆè·å–è¿™ä¸ªå´©æºƒæ—¥å¿—éœ€è¦ root æƒé™ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(NativeTombstoneManagerService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€7ã€‘Android é”™è¯¯æŠ¥å‘Šç”Ÿæˆï¼Œåº”ç”¨å´©æºƒæ—¶å€™æŸ¥çœ‹è¿™ä¸ªæŠ¥å‘Šè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼ˆå‰ææ˜¯ä½ èƒ½å¤Ÿçœ‹æ‡‚æŠ¥å‘Šï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">// å¯ä»¥åŒ adb bugreport è·å–é”™è¯¯æŠ¥å‘Šï¼ˆAndroid ç‰ˆæœ¬ä¹‹é—´è·å–æ–¹å¼ç¨æœ‰åŒºåˆ«ï¼Œæ ¹æ® adb bugreport æç¤ºæ“ä½œå³å¯ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(BugreportManagerService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€8ã€‘ä¸»è¦è¿˜æ˜¯ç›‘è§†å’Œæ”¶é›† GPU ä¿¡æ¯</span></span><br><span class=\"line\">    mSystemServiceManager.startService(GpuService.class);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ ¸å¿ƒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼Œä¸»è¦æ˜¯ä¿¡æ¯è®°å½•ç›¸å…³ï¼Œå¿…ä¸å¯å°‘ã€ç¡®å®å¾ˆæ˜¯å…³é”®ã€‚</p>\n<h1>å¯åŠ¨ Other æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startOtherServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//é—¹é’ŸæœåŠ¡â°</span></span><br><span class=\"line\">            mSystemServiceManager.startService(ALARM_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            <span class=\"comment\">//WMS æœåŠ¡</span></span><br><span class=\"line\">            mSystemServiceManager.startBootPhase(t, SystemService.PHASE_WAIT_FOR_SENSOR_SERVICE);</span><br><span class=\"line\">            wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> PhoneWindowManager(), mActivityManagerService.mActivityTaskManager);</span><br><span class=\"line\">            ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class=\"comment\">/* allowIsolated= */</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);</span><br><span class=\"line\">            ServiceManager.addService(Context.INPUT_SERVICE, inputManager,</span><br><span class=\"line\">                    <span class=\"comment\">/* allowIsolated= */</span> <span class=\"keyword\">false</span>, DUMP_FLAG_PRIORITY_CRITICAL);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è“ç‰™æœåŠ¡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class=\"line\">                Slog.i(TAG, <span class=\"string\">&quot;No Bluetooth Service (factory test)&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!context.getPackageManager().hasSystemFeature</span><br><span class=\"line\">                    (PackageManager.FEATURE_BLUETOOTH)) &#123;</span><br><span class=\"line\">                Slog.i(TAG, <span class=\"string\">&quot;No Bluetooth Service (Bluetooth Hardware Not Present)&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(BluetoothService.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç½‘ç»œåˆ—è¡¨ç›‘æ§æœåŠ¡</span></span><br><span class=\"line\">            mSystemServiceManager.startService(NetworkWatchlistService.Lifecycle.class);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è¾“å…¥æ³•ç®¡ç†æœåŠ¡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (InputMethodSystemProperty.MULTI_CLIENT_IME_ENABLED) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(</span><br><span class=\"line\">                        MultiClientInputMethodManagerService.Lifecycle.class);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(InputMethodManagerService.Lifecycle.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//è¾…åŠ©åŠŸèƒ½</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(ACCESSIBILITY_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                reportWtf(<span class=\"string\">&quot;starting Accessibility Manager&quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å¼€å‘è€…é€‰é¡¹ä¸­ï¼ŒOEM è§£é”è¿˜è®°å¾—å—</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (hasPdb || OemLockService.isHalPresent()) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(OemLockService.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//çŠ¶æ€æ     </span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                statusBar = <span class=\"keyword\">new</span> StatusBarManagerService(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);</span><br><span class=\"line\">             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">             &#125;</span><br><span class=\"line\">             </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            startContentCaptureService(context, t);</span><br><span class=\"line\">            startAttentionService(context, t);</span><br><span class=\"line\">            startRotationResolverService(context, t);</span><br><span class=\"line\">            startSystemCaptionsManagerService(context, t);</span><br><span class=\"line\">            <span class=\"comment\">//æ–‡å­—è¯­éŸ³è½¬æ¢</span></span><br><span class=\"line\">            startTextToSpeechManagerService(context, t);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç³»ç»Ÿè¯­éŸ³è¯†åˆ«</span></span><br><span class=\"line\">            mSystemServiceManager.startService(SPEECH_RECOGNITION_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//æ™ºæ…§ç©ºé—´ï¼Ÿè®°å¾—åä¸ºæ‰‹æœºæœç´¢é¡µé¢æ˜¯è¿™ä¸ªåç§°ï¼Œæœ‰çš„å«â€˜æ™ºæ…§åœºæ™¯â€™</span></span><br><span class=\"line\">            mSystemServiceManager.startService(SMARTSPACE_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç½‘ç»œ</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                networkManagement = NetworkManagementService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å­—ä½“</span></span><br><span class=\"line\">            mSystemServiceManager.startService(<span class=\"keyword\">new</span> FontManagerService.Lifecycle(context, safeMode));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//Wi-Fi</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_SCANNING_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_RTT)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_RTT_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_AWARE)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_AWARE_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_DIRECT)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_P2P_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//VPN</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                vpnManager = VpnManagerService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.VPN_MANAGEMENT_SERVICE, vpnManager);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            t.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">            t.traceBegin(<span class=\"string\">&quot;StartVcnManagementService&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                vcnManagement = VcnManagementService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.VCN_MANAGEMENT_SERVICE, vcnManagement);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                reportWtf(<span class=\"string\">&quot;starting VCN Management Service&quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            t.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç³»ç»Ÿæ›´æ–°</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                ServiceManager.addService(Context.SYSTEM_UPDATE_SERVICE,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> SystemUpdateManagerService(context));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//é€šçŸ¥æ </span></span><br><span class=\"line\">            mSystemServiceManager.startService(NotificationManagerService.class);</span><br><span class=\"line\">            SystemNotificationChannels.removeDeprecated(context);</span><br><span class=\"line\">            SystemNotificationChannels.createAll(context);</span><br><span class=\"line\">            notification = INotificationManager.Stub.asInterface(</span><br><span class=\"line\">                    ServiceManager.getService(Context.NOTIFICATION_SERVICE));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//å£çº¸</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getResources().getBoolean(R.bool.config_enableWallpaperService)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(WALLPAPER_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//éŸ³é‡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!isArc) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(AudioService.Lifecycle.class);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                String className = context.getResources()</span><br><span class=\"line\">                        .getString(R.string.config_deviceSpecificAudioService);</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    mSystemServiceManager.startService(className + <span class=\"string\">&quot;$Lifecycle&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//æ— é™å¹¿æ’­</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mPackageManager.hasSystemFeature(PackageManager.FEATURE_BROADCAST_RADIO)) &#123;</span><br><span class=\"line\">                t.traceBegin(<span class=\"string\">&quot;StartBroadcastRadioService&quot;</span>);</span><br><span class=\"line\">                mSystemServiceManager.startService(BroadcastRadioService.class);</span><br><span class=\"line\">                t.traceEnd();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">            <span class=\"comment\">//adb è°ƒè¯•</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(ADB_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                Slog.e(TAG, <span class=\"string\">&quot;Failure starting AdbService&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//app å¯åŠ¨</span></span><br><span class=\"line\">        mSystemServiceManager.startService(LauncherAppsService.class);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å¯åŠ¨å¯†ç é”</span></span><br><span class=\"line\">        mSystemServiceManager.startBootPhase(t, SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ç´§æ¥ç€ä¼šæœ‰å„é¡¹ä¹‹å‰å¯åŠ¨çš„æœåŠ¡è°ƒç”¨ systemReady() æ–¹æ³•ï¼ŒæŒ‡å®šæœåŠ¡å‡†å¤‡å®Œæ¯•ï¼Œå³å°†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ</span></span><br><span class=\"line\">        mPackageManagerService.systemReady();</span><br><span class=\"line\">        mDisplayManagerService.systemReady(safeMode, mOnlyCore);</span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ç­‰å¾…æœåŠ¡å‡†å¤‡å®Œæ¯•</span></span><br><span class=\"line\">        mPackageManagerService.waitForAppDataPrepared();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//å„é¡¹æœåŠ¡è°ƒç”¨ systemRunning()ã€start() æ–¹æ³•å¼€å§‹è¿è¡ŒæœåŠ¡è‡ªèº«</span></span><br><span class=\"line\">        countryDetectorF.systemRunning();</span><br><span class=\"line\">        networkTimeUpdaterF.systemRunning();</span><br><span class=\"line\">        inputManagerF.systemRunning();</span><br><span class=\"line\">        telephonyRegistryF.systemRunning();</span><br><span class=\"line\">        mmsServiceF.systemRunning();</span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//å¯åŠ¨ç³»ç»Ÿç•Œé¢æœåŠ¡</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€é€šè¿‡ intent æŒ‡å®šç‰¹å®šçš„ç»„ä»¶ context.startServiceAsUser(intent, UserHandle.SYSTEM);</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€startServiceAsUser æ›´ä¸Šå±‚çš„ä»£ç å¯¹æˆ‘ä»¬çœ‹æ¥åƒæ˜¯è°ƒç”¨ context.startService</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æŒ‡å®šçš„å¯åŠ¨çš„æœåŠ¡ç»„ä»¶ pm.getSystemUiServiceComponent() æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">                PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);</span></span><br><span class=\"line\"><span class=\"comment\">                PackageManagerInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PackageManagerInternalImpl</span></span><br><span class=\"line\"><span class=\"comment\">                è€Œ PackageManagerInternalImpl æ˜¯ PackageManager çš„å†…éƒ¨ç±»ï¼Œæ‰€å±æˆå‘˜æ˜¯ private final PackageManagerInternal mPmInternal;</span></span><br><span class=\"line\"><span class=\"comment\">                è€Œ getSystemUiServiceComponent å°±æ˜¯è·å–ä¸€ä¸ª string èµ„æºcom.android.internal.R.string.config_systemUIServiceComponent</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€èµ„æºæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼šframeworks/base/core/res/res/values/config.xmlã€çœ‹è¿™ä¸ªæ–‡ä»¶æœ‰å¥½å¤šæœåŠ¡çš„ componentã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            5ã€èµ„æºå†…å®¹ </span></span><br><span class=\"line\"><span class=\"comment\">            &lt;!-- SystemUi service component --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;string name=&quot;config_systemUIServiceComponent&quot; translatable=&quot;false&quot;&gt;com.android.systemui/com.android.systemui.SystemUIService&lt;/string&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        startSystemUi(context, windowManagerF);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"å¯åŠ¨-SystemUI-æœåŠ¡\">å¯åŠ¨ SystemUI æœåŠ¡</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">startSystemUi</span><span class=\"params\">(Context context, WindowManagerService windowManager)</span> </span>&#123;</span><br><span class=\"line\">    PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);</span><br><span class=\"line\">    Intent intent = <span class=\"keyword\">new</span> Intent();</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæœåŠ¡ component: com.android.systemui/com.android.systemui.SystemUIService</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€æ­¤æœåŠ¡ Java å®ç°ç±»æ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/src/com/android/systemui/SystemUIService.java</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€è¿™ä¸ªç±»æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæˆå‘˜åˆ†åˆ«è´Ÿè´£ä¸åŒçš„äº‹æƒ…</span></span><br><span class=\"line\"><span class=\"comment\">            mainHandle  ï¼šä¸»çº¿ç¨‹é€šè®¯ï¼Œæ˜çŸ¥æ•…é—®</span></span><br><span class=\"line\"><span class=\"comment\">            dumpHandle  ï¼šå½“å‰çº¿ç¨‹è¿è¡ŒçŠ¶æ€ä¿¡æ¯è¾“å‡º</span></span><br><span class=\"line\"><span class=\"comment\">            logBufferFreezer   ï¼šè´Ÿè´£é”™è¯¯æŠ¥å‘Šæ—¥å¿—ç›¸å…³ã€é”™è¯¯æŠ¥å‘Š-å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">        4ã€system server è¿›ç¨‹å¯åŠ¨çš„ UI æœåŠ¡ï¼šæ¥åˆ°äº† SystemUIApplication.java è¿™ä¸ªç±» ((SystemUIApplication) getApplication()).startServicesIfNeeded();</span></span><br><span class=\"line\"><span class=\"comment\">            æ‰€æœ‰çš„ UI æœåŠ¡åŒ…å«å“ªäº›ï¼ŸæœåŠ¡åç§°åˆ—è¡¨å“ªé‡Œæ¥ï¼Ÿåˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„èµ„æº config_systemUIServiceComponents R.array.config_systemUIServiceComponentsPerUser</span></span><br><span class=\"line\"><span class=\"comment\">            èµ„æºæ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/res/value/config.xml</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">            4.1ã€æœåŠ¡åˆ—è¡¨å‚è€ƒä¸‹æ–‡ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            4.2 é€šè¿‡åå°„åˆ›å»ºæœåŠ¡ Class.forname(serviceName) è°ƒç”¨æŒ‡å®šæ„é€ å‡½æ•° newInstance</span></span><br><span class=\"line\"><span class=\"comment\">            4.3 å¯åŠ¨æœåŠ¡ mServices[i].start(); æ¥ä¸‹æ¥å°±ä¸å…·ä½“çœ‹äº†ï¼Œä»¥åå…·ä½“æœåŠ¡å…·ä½“åˆ†æ</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">        5ã€SysteUIApplication ä»–æ˜¯ä¸€ä¸ª Applicationï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰åˆ›å»ºè¯¥å®ä¾‹æ˜¯ä¼šå…ˆæ‰§è¡Œ onCreate æ–¹æ³•ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">            è¿™é‡Œæœ‰è°ƒç”¨ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå¯¹äºéç§æœ‰çš„éç³»ç»Ÿç”¨æˆ·å°†æ‰§è¡Œ startSecondaryUserServicesIfNeeded();</span></span><br><span class=\"line\"><span class=\"comment\">            è·å–çš„æœåŠ¡åˆ—è¡¨æ˜¯ R.array.config_systemUIServiceComponentsPerUser æŸ¥çœ‹åªæœ‰ä¸€ä¸ªæœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">            5.1 com.android.systemui.util.NotificationChannels</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">    intent.setComponent(pm.getSystemUiServiceComponent());</span></span><br><span class=\"line\"><span class=\"comment\">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span></span><br><span class=\"line\"><span class=\"comment\">    context.startServiceAsUser(intent, UserHandle.SYSTEM);</span></span><br><span class=\"line\"><span class=\"comment\">    windowManager.onSystemUiStarted();</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p><strong>system UI æœåŠ¡åˆ—è¡¨</strong></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//é€šçŸ¥æ¸ é“æœåŠ¡ï¼ˆAndroid ä½ç‰ˆæœ¬çš„é€šçŸ¥åˆ›å»ºæ˜¯ä¸éœ€è¦è®¾ç½®é€šçŸ¥æ¸ é“ï¼Œåæ¥é«˜ç‰ˆæœ¬å¼•å…¥é€šçŸ¥æ¸ é“å¹¶ä¸”å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™é€šçŸ¥æ˜¾ç¤ºå­˜åœ¨å¼‚å¸¸ï¼‰</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.util.NotificationChannels<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.keyguard.KeyguardViewMediator<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//åº”ç”¨æœ€è¿‘ä»»åŠ¡åˆ—è¡¨</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.recents.Recents<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//éŸ³é‡</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.volume.VolumeUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.stackdivider.Divider<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//çŠ¶æ€æ </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.statusbar.phone.StatusBar<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.usb.StorageNotification<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.power.PowerUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.media.RingtonePlayer<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//é”®ç›˜</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.keyboard.KeyboardUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.pip.PipUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.shortcut.ShortcutKeyDispatcher<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>@string/config_systemUIVendorServiceComponent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.util.leak.GarbageMonitor$Service<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.LatencyTester<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.globalactions.GlobalActionsComponent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> <span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.ScreenDecorations<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.biometrics.AuthController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.SliceBroadcastRelayHandler<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.SizeCompatModeActivityController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.statusbar.notification.InstantAppNotifier<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.theme.ThemeOverlayController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.accessibility.WindowMagnification<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.accessibility.SystemActions<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.toast.ToastUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>System Server å¤§æ¦‚æ˜¯å¯åŠ¨å®Œæˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆå»å“ªé‡Œè¿è¡Œäº†å‘¢ï¼Ÿï¼Ÿï¼Ÿæˆ–è€…ä¸‹ä¸€æ­¥æˆ‘ä»¬ç»§ç»­çœ‹é‚£ä¸ªç‚¹æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿï¼Ÿï¼Ÿä¹‹å‰æˆ‘ä»¬åªæ˜¯ç²—ç•¥æµè§ˆï¼Œä¸­é—´å¿½ç•¥äº†å¾ˆå¤šï¼Œä¸‹ä¸€æ­¥çš„å…¥å£ç‚¹å¯èƒ½è¦è¿”å›ä¹‹å‰çš„ä»£ç é‡æ–°é˜…è¯»å‘ç°åˆé€‚çš„åˆ‡å…¥ç‚¹ï¼ŒSystemServer ä¹Ÿå·²ç»è¿›å…¥äº†â€˜æ°¸ä¹…çš„å¾ªç¯â€™ï¼Œç­‰å¾…çš„å°±æ˜¯æ¥å—å¤–éƒ¨â€˜ä¿¡å·â€™åšç›¸åº”å¤„ç†ã€ç»§ç»­åˆ†å‘åˆ°å…·ä½“æ‰§è¡Œã€‚</p>\n<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸‹å‘¨å†è§ğŸ˜Š</p>\n<h1>é™„åŠ </h1>\n<h2 id=\"å¦‚ä½•å¿«é€Ÿæœç´¢\">å¦‚ä½•å¿«é€Ÿæœç´¢</h2>\n<p><strong>Android é¡¹ç›®ä¸­å¦‚ä½•å¿«é€Ÿæœç´¢æŸå…³é”®å­—ï¼Ÿ</strong></p>\n<p>AOSP æ•´ä¸ªé¡¹ç›®æ˜¯å¾ˆåºå¤§çš„ï¼Œä¸ä»…ä»…æ˜¯åŒ…å« java ä»£ç ï¼Œå°±æ‹¿å½“å‰æˆ‘ä¸‹è½½çš„ <code>Android 11-r21 åˆ†æ”¯</code>æ¥è¯´ï¼Œæˆ‘æ˜¯é€šè¿‡ git ä¸‹è½½åœ¨æ²¡æœ‰æŒ‡å®š <code>single-branch dept=1</code> å‚æ•°ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸‹è½½å®Œæ¯•å ç”¨å¤§çº¦ <strong>430G</strong> å­˜å‚¨ç©ºé—´ã€‚</p>\n<p>ä¸€å¼€å§‹æˆ‘æŠŠæºç å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ï¼Œé€šè¿‡ VSCode æ‰“å¼€æœºå­˜åœ¨æ¢°ç¡¬ç›˜çš„ä¸­çš„é¡¹ç›®ï¼ˆæ•´ä¸ª AOSPï¼‰ï¼Œæ¯”å¦‚æœç´¢æŸä¸ªå…³é”®å­—ï¼Œé‚£ä¸ªé€Ÿåº¦å ªæ¯”é¾Ÿé€Ÿï¼›åæ¥æŠŠé¡¹ç›®æ‹·è´åˆ°ç¬”è®°æœ¬ SSD å›ºæ€ç¡¬ç›˜ï¼Œæœç´¢é€Ÿåº¦ç¡®å®æœ‰äº†æ˜æ˜¾çš„æé«˜ï¼Œä½†æ•´ä¸ªé¡¹ç›®æœç´¢è¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼Œä¸æ˜¯ååˆ†æ»¡æ„ï¼›å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€æŸä¸ªæ¨¡å—â€”â€”â€” framework æ¨¡å—ã€framework base æ¨¡å—ç­‰ç­‰ï¼Œæœç´¢é€Ÿåº¦è¿˜å¯ä»¥æ¥å—ã€‚ä½†å¦‚æœè¦æ‰¾çš„ä»£ç æ ¹æœ¬ä¸åœ¨å½“å‰æ¨¡å—ï¼Œæ¯”å¦‚ä½ æ‰“å¼€ framework base æ¨¡å—ï¼Œä½†å®é™…ä»£ç åœ¨ framework service æ¨¡å—ï¼Œè¿™æ ·æ˜¯æœç´¢ä¸åˆ°ç»“æœçš„ï¼Œå› æ­¤è¿˜å¾—æŠŠæœç´¢èŒƒå›´æ‰©å¤§ï¼Œå¼•å…¥çš„æ¨¡å—å¤šäº†é€Ÿåº¦ç»ˆæ˜¯ä¼šå˜æ…¢ã€‚</p>\n<p>æœç´¢èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç›®æ ‡ï¼Œæ˜¯ä¸æ˜¯è¦å€ŸåŠ©ä¸€ä¸ªä¸œè¥¿â€”â€”â€”â€”<strong>ç´¢å¼•</strong>ï¼Œå¦‚æœæœ‰å·¥å…·æŠŠ AOSP æ•´ä¸ªé¡¹ç›®é¢„å…ˆå»ºç«‹ç´¢å¼•ï¼Œç„¶åå†æ‰“å¼€é¡¹ç›®æœç´¢ï¼Œä¸‹æ¬¡æœç´¢æ—¶æ— éœ€é‡æ–°åˆ›å»ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æœç´¢ä¸å¾—è¦èµ·é£ã€‚<s>ä¸æœç´¢ç›¸å…³ç´¢å¼•ç¡®å®æ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚</s></p>\n<p>ã€<strong>æœ€å</strong>ã€‘</p>\n<p>æ¨èä½¿ç”¨å·²æœ‰çš„åœ¨çº¿ç½‘ç«™è¾…åŠ©æœç´¢ï¼š<a href=\"http://aospxref.com\"><strong>åŸºäº opengrok çš„ AOSPXRef</strong></a></p>\n<p>ä»¥æœç´¢ SystemUIService <code>config_systemUIServiceComponent</code>ä¸ºä¾‹ï¼š<br>\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6d6877806a144cfb2a73a40aa569c01~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>ã€<strong>æœ€åçš„æœ€å</strong>ã€‘</p>\n<p>ASOPXRef ç°æœ‰çš„é¡¹ç›®æ˜¯è¾ƒå°‘çš„ï¼Œä¹Ÿå°±æ˜¯å‡ ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œå¦‚æœèƒ½æ»¡è¶³è‡ªå·±çš„éœ€æ±‚åˆšå¥½ï¼Œè¦æ˜¯æƒ³çœ‹çš„æºç ç‰ˆæœ¬ä¸æ˜¯å·²å­˜åœ¨çš„å»ºè®®è¿˜æ˜¯è‡ªå·±é€šè¿‡ <code>opengrok</code> å¼•æ“æ­å»ºä¸€ä¸ªæœåŠ¡ã€‚<br>\n<strong>Oracle opengrokï¼š</strong><a href=\"https://github.com/oracle/opengrok\">å¿«é€Ÿä¸”å¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“</a></p>\n<h2 id=\"å‚è€ƒé“¾æ¥\">å‚è€ƒé“¾æ¥</h2>\n<ul>\n<li>WTFï¼šWhat a Terrible Failure â€”â€” Android ç³»ç»Ÿé”™è¯¯è®°å½•çš„ä¸€ç§</li>\n<li>Memtrackï¼šå†…å­˜åˆ†æ <a href=\"https://zhuanlan.zhihu.com/p/168361476\">https://zhuanlan.zhihu.com/p/168361476</a></li>\n<li>Hidlï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼Œåœ¨è¾ƒä½ Android ç‰ˆæœ¬å¯èƒ½è¿˜åœ¨ä½¿ç”¨ HAL ï¼ˆhardware abstract layerï¼‰<a href=\"https://zhuanlan.zhihu.com/p/28256541\">https://zhuanlan.zhihu.com/p/28256541</a></li>\n<li>Android Uriï¼š<a href=\"https://www.cnblogs.com/bhlsheji/p/4246580.html\">https://www.cnblogs.com/bhlsheji/p/4246580.html</a></li>\n<li>Android é”™è¯¯æŠ¥å‘Šï¼š<a href=\"https://developer.android.com/studio/debug/bug-report\">https://developer.android.com/studio/debug/bug-report</a> ï¼Œ<a href=\"https://source.android.com/source/read-bug-reports.html\">https://source.android.com/source/read-bug-reports.html</a></li>\n<li>Android å¢“ç¢‘ï¼š<a href=\"https://source.android.com/devices/tech/debug\">https://source.android.com/devices/tech/debug</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p><strong>ç›¸å…³æ–‡ä»¶</strong></p>\n<ul>\n<li>/framework/base/service/java/com/android/server/SystemServer.java</li>\n<li>/framework/base/service/java/com/android/server/SystemServiceManager.java</li>\n<li>/framework/base/service/java/com/android/server/WatchDog.java</li>\n<li>/frameworks/base/core/java/com/android/server/SystemConfig.java</li>\n<li>â€¦ etc</li>\n</ul>\n<h1>è¿è¡Œ System server</h1>\n<p>ç»è¿‡å‰ä¸¤ç¯‡çš„ç³»ç»Ÿæ–‡ç« ï¼Œå·²ç»å®Œæˆäº† initã€zygote è¿›ç¨‹çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå³å°†å¯åŠ¨ç³»ç»Ÿå„å¤§æœåŠ¡ï¼Œå„é¡¹æœåŠ¡ç”±æœåŠ¡ç®¡ç†è€… <code>System server</code> å®Œæˆåˆ›å»ºå’Œå¯åŠ¨ï¼Œé‚£ä¹ˆèµ¶ç´§è¿›å…¥ç§ç§å» <code>/framework/base/service/java/com/android/server/SystemServer.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SystemServer</span> <span class=\"keyword\">implements</span> <span class=\"title\">Dumpable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆ—ä¸¾å‡ ä¸ªè®¤ä¸ºé‡è¦çš„æˆå‘˜</span></span><br><span class=\"line\">    </span><br><span class=\"line\">   <span class=\"comment\">//ç±»ä¼¼è¿™æ ·çš„æœåŠ¡åç§°ä¸å°‘äº 50 ä¸ª</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WIFI_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.wifi.WifiService&quot;</span>;                  <span class=\"comment\">//Wi-FiæœåŠ¡</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WIFI_SCANNING_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.wifi.scanner.WifiScanningService&quot;</span>;  <span class=\"comment\">//Wi-Fi æ‰«æ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ALARM_MANAGER_SERVICE_CLASS =</span><br><span class=\"line\">            <span class=\"string\">&quot;com.android.server.alarm.AlarmManagerService&quot;</span>;         <span class=\"comment\">//é—¹é’Ÿ</span></span><br><span class=\"line\">    ... etc</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç³»ç»Ÿé»˜è®¤çš„å¯¹è¯æ¡†ç­‰ä¸»é¢˜</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_SYSTEM_THEME =</span><br><span class=\"line\">           com.android.internal.R.style.Theme_DeviceDefault_System;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¾ˆé‡è¦çš„ä¸€ä¸ªä¸»è§’ï¼Œç³»ç»ŸæœåŠ¡ç®¡ç†è€…</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SystemServiceManager mSystemServiceManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…·ä½“æœåŠ¡å®ç°ç±»</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ActivityManagerService mActivityManagerService;  <span class=\"comment\">//Activity ç®¡ç†</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PackageManagerService mPackageManagerService;    <span class=\"comment\">//å®‰è£…åŒ…ç®¡ç†</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ContentResolver mContentResolver;                <span class=\"comment\">//å†…å®¹è§£æâ€”â€”å†…å®¹æä¾›è€…æ•°æ®è§£æ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> DisplayManagerService mDisplayManagerService;    <span class=\"comment\">//è®¾å¤‡æ˜¾ç¤ºç›¸å…³</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœ‹å˜é‡åå°±å¾ˆæ¸…æ™°ï¼Œapplication é”™è¯¯æŠ¥å‘Šä¿¡æ¯è®°å½•</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> LinkedList&lt;Pair&lt;String, ApplicationErrorReport.CrashInfo&gt;&gt; sPendingWtfs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//memtrackerï¼šmemory tracker ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">startMemtrackProxyService</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Hidl Hardware Interface Definition Language ç¡¬ä»¶æŠ½è±¡å±‚è¯­è¨€ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">startHidlServices</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è°ƒè¯•æ¨¡å¼ä¸‹æˆ‘ä»¬åº”ç”¨è¿›ç¨‹èƒ½å¤Ÿ dump headï¼Œdump file æ˜¯è¿›ç¨‹çš„å†…å­˜é•œåƒï¼ŒæŠŠè¿›ç¨‹å½“å‰ä¿å­˜çš„çŠ¶æ€ä¿å­˜åˆ° dump æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"comment\">//head dump å…¶å®åˆ©ç”¨ Android studio å†…ç½®çš„å·¥å…·ï¼ˆAndroid profileã€Memory profileï¼‰ä¹Ÿæ˜¯å¯ä»¥ç”Ÿæˆçš„ï¼Œç›´æ¥å¸®ä½ æŠŠæ–‡ä»¶å¯è§†åŒ–</span></span><br><span class=\"line\">    <span class=\"comment\">//ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜è·¯å¾„ /data/system/heapdump/</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">native</span> <span class=\"keyword\">void</span> <span class=\"title\">initZygoteChildHeapProfiling</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ä»ä¸»å‡½æ•°å¼€å§‹æ‰§è¡Œ</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> SystemServer().run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SystemServer</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//è®°å½•æ€§ä¿¡æ¯ï¼Œä¸å½±å“ç»§ç»­é˜…è¯»å§ï¼Œä¸»è¦è¿˜æ˜¯åé¢çš„ run æ–¹æ³•</span></span><br><span class=\"line\"></span><br><span class=\"line\">    mFactoryTestMode = FactoryTest.getMode();</span><br><span class=\"line\">    mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, <span class=\"number\">0</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\">    mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();</span><br><span class=\"line\">    mRuntimeStartUptime = SystemClock.uptimeMillis();</span><br><span class=\"line\">    Process.setStartTimes(mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class=\"line\"></span><br><span class=\"line\">    mRuntimeRestart = <span class=\"string\">&quot;1&quot;</span>.equals(SystemProperties.get(<span class=\"string\">&quot;sys.boot_completed&quot;</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ï¼Œè®°å½•è¿›ç¨‹å¯åŠ¨ä¿¡æ¯ï¼Œå¯åŠ¨æ¬¡æ•°ç­‰</span></span><br><span class=\"line\">    SystemProperties.set(SYSPROP_START_COUNT,String.valueOf(mStartCount));</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœå½“å‰æ—¶åŒºæ— æ•ˆå°†è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ GMT â€”â€” æ ¼æ—å¨æ²»æ—¶é—´</span></span><br><span class=\"line\">    SystemProperties.set(<span class=\"string\">&quot;persist.sys.timezone&quot;</span>, <span class=\"string\">&quot;GMT&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœçŸ¥é“äº†è¯­è¨€ï¼Œå°è¯•é€šè¿‡è¯­è¨€è®¾ç½®åœ°åŒºå±æ€§</span></span><br><span class=\"line\">    <span class=\"comment\">//ã€presist å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯å¯å†™çš„ï¼Œro å‰ç¼€çš„ç³»ç»Ÿå±æ€§æ˜¯åªè¯»çš„ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!SystemProperties.get(<span class=\"string\">&quot;persist.sys.language&quot;</span>).isEmpty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> String languageTag = Locale.getDefault().toLanguageTag();</span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;persist.sys.locale&quot;</span>, languageTag); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/*å‰é¢éƒ½æ˜¯åœ¨è®¾ç½®ä¸€äº›ç³»ç»Ÿå±æ€§ï¼Œæ¥ä¸‹æ¥å°†è¦çœŸæ­£å¯åŠ¨æœåŠ¡*/</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//SystemClock.elapsedRealtime();  è·å–è®¾å¤‡å¯åŠ¨åˆ°å½“å‰çš„æ¯«ç§’å€¼</span></span><br><span class=\"line\">    <span class=\"comment\">//æ¸…ç†ä¸€æ¬¡å†…å­˜ï¼Œä¸º application å¯ä»¥åˆ†é…å¾—åˆ°æ›´å¤šå†…å­˜</span></span><br><span class=\"line\">    VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å‡†å¤‡çº¿ç¨‹ç­–ç•¥ THREAD_PRIORITY_FOREGROUNDï¼šåº”ç”¨ç¨‹åºä¸å¾—æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ã€ä¸å¾—æ›´æ”¹çº¿ç¨‹æ•°é‡ï¼Œè¿™äº›å°†ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´</span></span><br><span class=\"line\">    android.os.Process.setThreadPriority(</span><br><span class=\"line\">        android.os.Process.THREAD_PRIORITY_FOREGROUND); </span><br><span class=\"line\">    <span class=\"comment\">//è¿™æ˜¯å¯¹å‰ä¸€æ¡è¯­å¥è®¾ç½®å‰å°è¿›ç¨‹çš„é™åˆ¶ THREAD_PRIORITY_FOREGROUNDï¼Œè¿™é‡Œä¼ å…¥ falseï¼Œå¦‚æœæ­¤å‰è®¾ç½®çš„çº¿ç¨‹ç­–ç•¥æ˜¯â€˜åå°è¿›ç¨‹ç»„â€™å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class=\"line\">    android.os.Process.setCanSelfBackground(<span class=\"keyword\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Looper æ˜¯çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œè¿™é‡Œçš„çº¿ç¨‹è‡ªç„¶æ˜¯æ‰§è¡Œçš„ä¸»çº¿ç¨‹ Main-Threadï¼Œä¹Ÿå°±æ˜¯ application æ‰€åœ¨çº¿ç¨‹</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œæœ‰ä¸€ä¸ªç»å…¸å…«è‚¡æ–‡ğŸ˜Šï¼šè‡ªå®šä¹‰å­çº¿ç¨‹ Looper éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ prepareLooperï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸»çº¿ç¨‹çš„ Looper å‰ä¸éœ€è¦å…ˆè°ƒç”¨ prepare Looperï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//       Aç­”ï¼šè°ƒç”¨æ—¶è‚¯å®šè¦è°ƒç”¨çš„ã€‚è¿™ä¸æ˜¯åºŸè¯å—ï¼Œæˆ‘ä»¬ä¸è°ƒç”¨é‚£è‚¯å®šæ˜¯â€˜åˆ«äººâ€™å·²ç»åœ¨æˆ‘ä»¬ä½¿ç”¨å‰å°±è°ƒç”¨äº†â€”â€”â€”â€”é‚£è¿™ä¸ªâ€˜åˆ«äººâ€™å…¶å®å°±æ˜¯ Android env åœ¨åˆ›å»ºæ—¶å€™è°ƒç”¨äº†</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿™ä¸ª application main loop è¢«ç³»ç»Ÿç¼“å­˜åœ¨ Looper.java ä¸­ï¼ˆstatic final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">//æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æ˜¯é€šè¿‡ï¼š Looper.getMainLooper()</span></span><br><span class=\"line\">    Looper.prepareMainLooper();</span><br><span class=\"line\">    Looper.getMainLooper().setSlowLogThresholdMs(</span><br><span class=\"line\">        SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ mSystemContext ä»¥åŠè®¾ç½®ä¸Šè¿°çš„é»˜è®¤ä¸»é¢˜</span></span><br><span class=\"line\">    createSystemContext();</span><br><span class=\"line\">    <span class=\"comment\">//ç»§ç»­</span></span><br><span class=\"line\">    mSystemServiceManager = <span class=\"keyword\">new</span> SystemServiceManager(mSystemContext);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨è¯»å–ç³»ç»Ÿå…¨å±€é…ç½®çš„çº¿ç¨‹æ± ï¼Œä¸‹é¢å¯åŠ¨æœåŠ¡å¯åŠ¨æ—¶å€™å°†ä¼šç”¨åˆ°</span></span><br><span class=\"line\">    <span class=\"comment\">//ä»€ä¹ˆæ—¶å€™å…³é—­çº¿ç¨‹æ± å‘¢ï¼Ÿif (phase == SystemService.PHASE_BOOT_COMPLETED)&#123;SystemServerInitThreadPool.shutdown();&#125;</span></span><br><span class=\"line\">    SystemServerInitThreadPool tp = SystemServerInitThreadPool.start();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€é‡ç‚¹ã€é‡ç‚¹ã€é‡ç‚¹ã€‘</span></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å„ç§ Service</span></span><br><span class=\"line\">    startBootstrapServices(t);  <span class=\"comment\">//å¯åŠ¨æœåŠ¡</span></span><br><span class=\"line\">    startCoreServices(t);       <span class=\"comment\">//æ ¸å¿ƒæœåŠ¡</span></span><br><span class=\"line\">    startOtherServices(t);      <span class=\"comment\">//å…¶ä»–æœåŠ¡</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸€ä¸ªæ£€æµ‹å·¥å…·</span></span><br><span class=\"line\">    StrictMode.initVmDefaults(<span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"comment\">//è¿›å…¥ä¸€ä¸ªæ— çœ çš„ä¸–ç•Œé»˜é»˜`æ‰“å·¥`ï¼Œä¸ºâ€˜äººæ°‘â€™æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€è·å¾—å½“å‰çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueue</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åœ¨ for(;;) å¾ªç¯ä¸­ä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ¶ˆæ¯ï¼Œqueue.next()ï¼Œè¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿‡ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¦‚æœè·å–åˆ°å¯ç”¨çš„æ¶ˆæ¯åˆ™è¿›è¡Œåˆ†å‘ msg.target.dispatchMessage(msg)</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€æ¶ˆæ¯åˆ†å‘ä¹‹åè¿›è¡Œå›æ”¶æˆ–æ¸…ç† msg.recycleUnChecked()</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    Looper.loop();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>å¯åŠ¨ Bootstrap æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startBootstrapServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€1ã€‘watchdog çœ‹é—¨ğŸ¶ï¼Ÿçœ‹ç€æ˜¯æœ‰è¿™ä¸ªæ„æ€ï¼Œå¤§æ¦‚å°±æ˜¯ç›‘æ§æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å®ƒè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­ mThread = new Thread(this::run, &quot;watchdog&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€ä¸»è¦æ˜¯æ£€æŸ¥ä¸€äº›çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒåº¦æƒ…å†µï¼Œæ¯”å¦‚æ£€æŸ¥çš„çº¿ç¨‹æœ‰å‰å°çº¿ç¨‹ã€IOã€UIã€mainã€displayã€animationã€surface animation ç­‰çº¿ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Watchdog watchdog = Watchdog.getInstance();</span><br><span class=\"line\">    watchdog.start();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€2ã€‘åŠ è½½å…¨å±€ç³»ç»Ÿé…ç½®ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æ­¤çº¿ç¨‹æ± åœ¨ SystemServer å¯åŠ¨æ—¶å€™æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åœ¨ SystemServer å¯åŠ¨å®Œæˆä¹‹åå…³é—­ SystemService.PHASE_BOOT_COMPLETE</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€è°ƒç”¨ submit æ–¹æ³•çœŸæ­£æ‰§è¡Œç³»ç»Ÿå…¨å±€é…ç½®è¯»å–çš„æ–¹æ³•åœ¨å“ªé‡Œï¼Ÿçº¿ç¨‹æ± æäº¤ä¹‹åæ‰§è¡Œçš„å½“ç„¶æ˜¯ run æ–¹æ³•ã€‚è°çš„ run æ–¹æ³•ï¼ŸSystemConfig::getInstance åˆæ˜¯å•¥ï¼Œåœ¨å“ªé‡Œï¼Ÿã€ä¸è§£ï¼ŒçŸ¥è€…æ¬¢è¿è¯„è®ºã€‘</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€SystemConfig::getInstanceï¼šJava èƒ½å¤Ÿä½¿ç”¨åŒå¼•å·è®¿é—®é™æ€æ–¹æ³•ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘åªçŸ¥é“ cpp æ˜¯å¯ä»¥è¿™æ ·çš„ï¼Œåæ¥æŸ¥äº†ä¸€ä¸‹ä¼¼ä¹æ˜¯ lambada çš„è¯­æ³•ç³–ğŸ˜ºä¸çŸ¥è€…æ— ç½ª</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€readPublicNativeLibrariesList();//String[] dirs = &#123;&quot;/system/etc&quot;, &quot;/system_ext/etc&quot;, &quot;/product/etc&quot;,&quot;vendor/etc&quot;&#125;;è¯»å–æ­¤ç›®å½•ä¸‹ public.libraries- å¼€å¤´ï¼Œ.txt ç»“å°¾çš„é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">        6ã€readAllPermissions();//è§£ææ ¹ç›®å½•ã€Vendorç›®å½•ç­‰ etc/sysconfigã€etc/permission ä¸‹ XML æƒé™æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> String TAG_SYSTEM_CONFIG = <span class=\"string\">&quot;ReadingSystemConfig&quot;</span>;</span><br><span class=\"line\">    SystemServerInitThreadPool.submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€3ã€‘å…¬å…±æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å°†æ¥ ActivityManagerServiceã€PackageManagerService ...etc ä¼šä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€è°ƒç”¨ addService ä¸€çœ‹æµç¨‹æœ€ç»ˆåˆ°äº† IServiceManager.cpp è—å¾—è¿™ä¹ˆæ·±ï¼ŒçœŸæ˜¯æœäº†è¿™ä¸ªè€ sixï¼Œsp&lt;AidlServiceManager&gt; mTheRealServiceManager;   </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    PlatformCompat platformCompat = <span class=\"keyword\">new</span> PlatformCompat(mSystemContext);</span><br><span class=\"line\">    ServiceManager.addService(Context.PLATFORM_COMPAT_SERVICE, platformCompat);</span><br><span class=\"line\">    ServiceManager.addService(Context.PLATFORM_COMPAT_NATIVE_SERVICE,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> PlatformCompatNative(platformCompat));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€4ã€‘æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    mSystemServiceManager.startService(FileIntegrityService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€5ã€‘åº”ç”¨ç¨‹åºå®‰è£…ç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€6ã€‘è®¾å¤‡æ ‡è¯†è®¿é—®ç­–ç•¥æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€è·å–æ‰‹æœºåºåˆ—å·ï¼šgetSerial()ï¼Œç³»ç»Ÿå±æ€§å¯¹åº”é”® ro.serialnã€‚è°ƒç”¨æ—¶</span></span><br><span class=\"line\"><span class=\"comment\">elephonyPermissions.checkCallingOrSelfReadDeviceIdentifiers</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€æŒ‡å®šåŒ…åè·å–åºåˆ—å· getSerialForPackageï¼Œå…¶ä¸­å†æ ¹æ®åŒ…å + å½“å‰ç”¨æˆ·IDè·å–è°ƒç”¨æ­¤ç±»çš„ UIDï¼Œæ‰€ä»¥çŒœæµ‹è¿˜æœ‰æœ‰ä¸å°‘é™åˆ¶çš„ï¼Œæ¯”å¦‚é™åˆ¶é root ç”¨æˆ·ã€é™åˆ¶éç³»ç»Ÿåº”ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    SystemServiceManager.startService(DeviceIdentifiersPolicyService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€7ã€‘URI æˆæƒç®¡ç†æœåŠ¡ ï¼ˆå…³äº Uri å¯å‚è€ƒé“¾æ¥ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€8ã€‘ç”µæ± ç›¸å…³æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ç”µé‡ğŸ”‹è§¦å‘å™¨BatteryTrigger mBatteryTriggerï¼Œé€šè¿‡å¹¿æ’­ç›‘å¬ç”µé‡å˜åŒ–ï¼Œå½“ç”µé‡ä¸‹é™1%å°†ä¼šæ¥æ”¶åˆ°å¹¿æ’­ï¼Œä¼¼ä¹åªåšä¸€ä»¶äº‹ï¼šå°±æ˜¯æ›´æ–°æœ€æ–°ç”µé‡ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED); é€šè¿‡ context æ³¨å†Œå¹¿æ’­</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mSystemServiceManager.startService(PowerStatsService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€9ã€‘å†…å­˜åˆ†ææœåŠ¡  ï¼ˆnative è°ƒç”¨ï¼‰</span></span><br><span class=\"line\">    startMemtrackProxyService();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€10ã€‘AMS æœåŠ¡ï¼ˆç»ˆäºçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ğŸ¶ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€é«˜ç‰ˆæœ¬ä»»åŠ¡æ ˆç®¡ç†ç±»ä¼¼ä¹è¢«åˆ†ç¦»å‡ºæ¥äº†ï¼Œç”± ActivityTaskManagerService å®ç°ï¼Œå†…å®¹å¤ªå¤šï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    ActivityTaskManagerService atm = mSystemServiceManager.startService(</span><br><span class=\"line\">        ActivityTaskManagerService.Lifecycle.class).getService();</span><br><span class=\"line\">    mActivityManagerService = ActivityManagerService.Lifecycle.startService(</span><br><span class=\"line\">        mSystemServiceManager, atm);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€11ã€‘æ•°æ®åŠ è½½</span></span><br><span class=\"line\">    mDataLoaderManagerService = mSystemServiceManager.startService(</span><br><span class=\"line\">        DataLoaderManagerService.class);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//ã€12ã€‘ç”µæºç®¡ç†æœåŠ¡ï¼Œä¹‹å‰é‚£ä¸ªæ—¶ç”µæ± çŠ¶æ€ç®¡ç†ï¼ˆåªåšäº†ä¸€ä»¶äº‹ï¼šç›‘å¬ç”µé‡å˜åŒ–ï¼‰</span></span><br><span class=\"line\">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€13ã€‘ç³»ç»Ÿæ¢å¤æœåŠ¡ï¼Œæˆ‘ä»¬åˆ·æœºå¸¸è§çš„ Recover æ¨¡å¼</span></span><br><span class=\"line\">    mSystemServiceManager.startService(RecoverySystemService.Lifecycle.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€14ã€‘å®‰è£…åŒ…ç®¡ç†æœåŠ¡ï¼Œè¿™æ˜¯ä¸ªå¤§ç±»ï¼Œä¸‰ä¸‡è¡Œå‘¢ï¼Œä¸‹æ¬¡ä¸€å®šçœ‹çœ‹</span></span><br><span class=\"line\">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class=\"line\">        domainVerificationService, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF,</span><br><span class=\"line\">        mOnlyCore);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//ã€15ã€‘ä¼ æ„Ÿå™¨æœåŠ¡</span></span><br><span class=\"line\">    mSystemServiceManager.startService(<span class=\"keyword\">new</span> SensorPrivacyService(mSystemContext));</span><br><span class=\"line\">    mSystemServiceManager.startService(SensorService.class);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨æœåŠ¡åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼Œåªæ˜¯éƒ¨åˆ†åˆ—ä¸¾ï¼Œå¹¶ä¸å®Œæ•´ï¼ŒæœåŠ¡æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿå…·ä½“éƒ½åœ¨åšäº†äº›ä»€ä¹ˆï¼Ÿç­‰ç­‰ï¼ï¼ï¼è¿™äº›æ‰§è¡Œç»†èŠ‚å¸Œæœ›åœ¨ä¹‹åçš„ç³»åˆ—æ–‡ç« è¿›ä¸€æ­¥æ·±å…¥ï¼ˆå†…å®¹å®åœ¨æ˜¯å¤ªå¤šäº†ğŸ˜­ï¼‰</p>\n<h1>å¯åŠ¨ Core æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startCoreServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//ã€1ã€‘ä¸»è¦è´Ÿè´£è¯»å–ç³»ç»Ÿé…ç½®ä¿¡æ¯</span></span><br><span class=\"line\">    mSystemServiceManager.startService(SystemConfigService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€2ã€‘ç”µé‡è·Ÿè¸ª</span></span><br><span class=\"line\">    mSystemServiceManager.startService(BatteryService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€3ã€‘åº”ç”¨ä½¿ç”¨çŠ¶æ€è·Ÿè¸ª</span></span><br><span class=\"line\">    mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€4ã€‘ç›‘æ§è®¾å¤‡æ˜¯å¦å……ç”µã€å±å¹•æ˜¯å¦äº®èµ·</span></span><br><span class=\"line\">    <span class=\"comment\">//ï¼ˆé€šè¿‡é«˜ä¼˜å…ˆçº§çš„å¹¿æ’­ç›‘å¬ğŸ“¢ï¼ŒæŒ‡å®šç‰¹å®šçš„ intentfilterâ€”â€”ACTION_SCREEN_ON/ACTION_SCREEN_OFF/ACTION_BATTERY_CHANGEDï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(CachedDeviceStateService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€5ã€‘åº”ç”¨ç¨‹åºå›æ»šï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">    mSystemServiceManager.startService(ROLLBACK_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€6ã€‘tombstone å¢“ç¢‘ï¼Œè®°å½•è¿›ç¨‹è¢«æ€æ­»å‰çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒç”¨æ ˆã€å†…å­˜ä½¿ç”¨æƒ…å†µã€CPU ä½¿ç”¨æƒ…å†µã€backtrace ç­‰ç­‰ï¼Œä¸»è¦æ˜¯ç›‘æ§å’Œè®°å½• native å´©æºƒä¿¡æ¯ï¼ˆè·å–è¿™ä¸ªå´©æºƒæ—¥å¿—éœ€è¦ root æƒé™ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(NativeTombstoneManagerService.class);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ã€7ã€‘Android é”™è¯¯æŠ¥å‘Šç”Ÿæˆï¼Œåº”ç”¨å´©æºƒæ—¶å€™æŸ¥çœ‹è¿™ä¸ªæŠ¥å‘Šè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼ˆå‰ææ˜¯ä½ èƒ½å¤Ÿçœ‹æ‡‚æŠ¥å‘Šï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">// å¯ä»¥åŒ adb bugreport è·å–é”™è¯¯æŠ¥å‘Šï¼ˆAndroid ç‰ˆæœ¬ä¹‹é—´è·å–æ–¹å¼ç¨æœ‰åŒºåˆ«ï¼Œæ ¹æ® adb bugreport æç¤ºæ“ä½œå³å¯ï¼‰</span></span><br><span class=\"line\">    mSystemServiceManager.startService(BugreportManagerService.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ã€8ã€‘ä¸»è¦è¿˜æ˜¯ç›‘è§†å’Œæ”¶é›† GPU ä¿¡æ¯</span></span><br><span class=\"line\">    mSystemServiceManager.startService(GpuService.class);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ ¸å¿ƒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼Œä¸»è¦æ˜¯ä¿¡æ¯è®°å½•ç›¸å…³ï¼Œå¿…ä¸å¯å°‘ã€ç¡®å®å¾ˆæ˜¯å…³é”®ã€‚</p>\n<h1>å¯åŠ¨ Other æœåŠ¡</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">startOtherServices</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//é—¹é’ŸæœåŠ¡â°</span></span><br><span class=\"line\">            mSystemServiceManager.startService(ALARM_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            <span class=\"comment\">//WMS æœåŠ¡</span></span><br><span class=\"line\">            mSystemServiceManager.startBootPhase(t, SystemService.PHASE_WAIT_FOR_SENSOR_SERVICE);</span><br><span class=\"line\">            wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> PhoneWindowManager(), mActivityManagerService.mActivityTaskManager);</span><br><span class=\"line\">            ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class=\"comment\">/* allowIsolated= */</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);</span><br><span class=\"line\">            ServiceManager.addService(Context.INPUT_SERVICE, inputManager,</span><br><span class=\"line\">                    <span class=\"comment\">/* allowIsolated= */</span> <span class=\"keyword\">false</span>, DUMP_FLAG_PRIORITY_CRITICAL);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è“ç‰™æœåŠ¡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class=\"line\">                Slog.i(TAG, <span class=\"string\">&quot;No Bluetooth Service (factory test)&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!context.getPackageManager().hasSystemFeature</span><br><span class=\"line\">                    (PackageManager.FEATURE_BLUETOOTH)) &#123;</span><br><span class=\"line\">                Slog.i(TAG, <span class=\"string\">&quot;No Bluetooth Service (Bluetooth Hardware Not Present)&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(BluetoothService.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç½‘ç»œåˆ—è¡¨ç›‘æ§æœåŠ¡</span></span><br><span class=\"line\">            mSystemServiceManager.startService(NetworkWatchlistService.Lifecycle.class);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è¾“å…¥æ³•ç®¡ç†æœåŠ¡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (InputMethodSystemProperty.MULTI_CLIENT_IME_ENABLED) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(</span><br><span class=\"line\">                        MultiClientInputMethodManagerService.Lifecycle.class);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(InputMethodManagerService.Lifecycle.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//è¾…åŠ©åŠŸèƒ½</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(ACCESSIBILITY_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                reportWtf(<span class=\"string\">&quot;starting Accessibility Manager&quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å¼€å‘è€…é€‰é¡¹ä¸­ï¼ŒOEM è§£é”è¿˜è®°å¾—å—</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (hasPdb || OemLockService.isHalPresent()) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(OemLockService.class);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//çŠ¶æ€æ     </span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                statusBar = <span class=\"keyword\">new</span> StatusBarManagerService(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);</span><br><span class=\"line\">             &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">             &#125;</span><br><span class=\"line\">             </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            startContentCaptureService(context, t);</span><br><span class=\"line\">            startAttentionService(context, t);</span><br><span class=\"line\">            startRotationResolverService(context, t);</span><br><span class=\"line\">            startSystemCaptionsManagerService(context, t);</span><br><span class=\"line\">            <span class=\"comment\">//æ–‡å­—è¯­éŸ³è½¬æ¢</span></span><br><span class=\"line\">            startTextToSpeechManagerService(context, t);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç³»ç»Ÿè¯­éŸ³è¯†åˆ«</span></span><br><span class=\"line\">            mSystemServiceManager.startService(SPEECH_RECOGNITION_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//æ™ºæ…§ç©ºé—´ï¼Ÿè®°å¾—åä¸ºæ‰‹æœºæœç´¢é¡µé¢æ˜¯è¿™ä¸ªåç§°ï¼Œæœ‰çš„å«â€˜æ™ºæ…§åœºæ™¯â€™</span></span><br><span class=\"line\">            mSystemServiceManager.startService(SMARTSPACE_MANAGER_SERVICE_CLASS);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç½‘ç»œ</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                networkManagement = NetworkManagementService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å­—ä½“</span></span><br><span class=\"line\">            mSystemServiceManager.startService(<span class=\"keyword\">new</span> FontManagerService.Lifecycle(context, safeMode));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//Wi-Fi</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_SCANNING_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_RTT)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_RTT_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_AWARE)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_AWARE_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getPackageManager().hasSystemFeature(</span><br><span class=\"line\">                    PackageManager.FEATURE_WIFI_DIRECT)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startServiceFromJar(</span><br><span class=\"line\">                        WIFI_P2P_SERVICE_CLASS, WIFI_APEX_SERVICE_JAR_PATH);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//VPN</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                vpnManager = VpnManagerService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.VPN_MANAGEMENT_SERVICE, vpnManager);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            t.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">            t.traceBegin(<span class=\"string\">&quot;StartVcnManagementService&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                vcnManagement = VcnManagementService.create(context);</span><br><span class=\"line\">                ServiceManager.addService(Context.VCN_MANAGEMENT_SERVICE, vcnManagement);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                reportWtf(<span class=\"string\">&quot;starting VCN Management Service&quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            t.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ç³»ç»Ÿæ›´æ–°</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                ServiceManager.addService(Context.SYSTEM_UPDATE_SERVICE,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> SystemUpdateManagerService(context));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//é€šçŸ¥æ </span></span><br><span class=\"line\">            mSystemServiceManager.startService(NotificationManagerService.class);</span><br><span class=\"line\">            SystemNotificationChannels.removeDeprecated(context);</span><br><span class=\"line\">            SystemNotificationChannels.createAll(context);</span><br><span class=\"line\">            notification = INotificationManager.Stub.asInterface(</span><br><span class=\"line\">                    ServiceManager.getService(Context.NOTIFICATION_SERVICE));</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//å£çº¸</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (context.getResources().getBoolean(R.bool.config_enableWallpaperService)) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(WALLPAPER_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//éŸ³é‡</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!isArc) &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(AudioService.Lifecycle.class);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                String className = context.getResources()</span><br><span class=\"line\">                        .getString(R.string.config_deviceSpecificAudioService);</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    mSystemServiceManager.startService(className + <span class=\"string\">&quot;$Lifecycle&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//æ— é™å¹¿æ’­</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mPackageManager.hasSystemFeature(PackageManager.FEATURE_BROADCAST_RADIO)) &#123;</span><br><span class=\"line\">                t.traceBegin(<span class=\"string\">&quot;StartBroadcastRadioService&quot;</span>);</span><br><span class=\"line\">                mSystemServiceManager.startService(BroadcastRadioService.class);</span><br><span class=\"line\">                t.traceEnd();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">            <span class=\"comment\">//adb è°ƒè¯•</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                mSystemServiceManager.startService(ADB_SERVICE_CLASS);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                Slog.e(TAG, <span class=\"string\">&quot;Failure starting AdbService&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//app å¯åŠ¨</span></span><br><span class=\"line\">        mSystemServiceManager.startService(LauncherAppsService.class);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//å¯åŠ¨å¯†ç é”</span></span><br><span class=\"line\">        mSystemServiceManager.startBootPhase(t, SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ç´§æ¥ç€ä¼šæœ‰å„é¡¹ä¹‹å‰å¯åŠ¨çš„æœåŠ¡è°ƒç”¨ systemReady() æ–¹æ³•ï¼ŒæŒ‡å®šæœåŠ¡å‡†å¤‡å®Œæ¯•ï¼Œå³å°†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ</span></span><br><span class=\"line\">        mPackageManagerService.systemReady();</span><br><span class=\"line\">        mDisplayManagerService.systemReady(safeMode, mOnlyCore);</span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ç­‰å¾…æœåŠ¡å‡†å¤‡å®Œæ¯•</span></span><br><span class=\"line\">        mPackageManagerService.waitForAppDataPrepared();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//å„é¡¹æœåŠ¡è°ƒç”¨ systemRunning()ã€start() æ–¹æ³•å¼€å§‹è¿è¡ŒæœåŠ¡è‡ªèº«</span></span><br><span class=\"line\">        countryDetectorF.systemRunning();</span><br><span class=\"line\">        networkTimeUpdaterF.systemRunning();</span><br><span class=\"line\">        inputManagerF.systemRunning();</span><br><span class=\"line\">        telephonyRegistryF.systemRunning();</span><br><span class=\"line\">        mmsServiceF.systemRunning();</span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//å¯åŠ¨ç³»ç»Ÿç•Œé¢æœåŠ¡</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€é€šè¿‡ intent æŒ‡å®šç‰¹å®šçš„ç»„ä»¶ context.startServiceAsUser(intent, UserHandle.SYSTEM);</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€startServiceAsUser æ›´ä¸Šå±‚çš„ä»£ç å¯¹æˆ‘ä»¬çœ‹æ¥åƒæ˜¯è°ƒç”¨ context.startService</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æŒ‡å®šçš„å¯åŠ¨çš„æœåŠ¡ç»„ä»¶ pm.getSystemUiServiceComponent() æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">                PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);</span></span><br><span class=\"line\"><span class=\"comment\">                PackageManagerInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PackageManagerInternalImpl</span></span><br><span class=\"line\"><span class=\"comment\">                è€Œ PackageManagerInternalImpl æ˜¯ PackageManager çš„å†…éƒ¨ç±»ï¼Œæ‰€å±æˆå‘˜æ˜¯ private final PackageManagerInternal mPmInternal;</span></span><br><span class=\"line\"><span class=\"comment\">                è€Œ getSystemUiServiceComponent å°±æ˜¯è·å–ä¸€ä¸ª string èµ„æºcom.android.internal.R.string.config_systemUIServiceComponent</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€èµ„æºæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼šframeworks/base/core/res/res/values/config.xmlã€çœ‹è¿™ä¸ªæ–‡ä»¶æœ‰å¥½å¤šæœåŠ¡çš„ componentã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            5ã€èµ„æºå†…å®¹ </span></span><br><span class=\"line\"><span class=\"comment\">            &lt;!-- SystemUi service component --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;string name=&quot;config_systemUIServiceComponent&quot; translatable=&quot;false&quot;&gt;com.android.systemui/com.android.systemui.SystemUIService&lt;/string&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        startSystemUi(context, windowManagerF);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"å¯åŠ¨-SystemUI-æœåŠ¡\">å¯åŠ¨ SystemUI æœåŠ¡</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">startSystemUi</span><span class=\"params\">(Context context, WindowManagerService windowManager)</span> </span>&#123;</span><br><span class=\"line\">    PackageManagerInternal pm = LocalServices.getService(PackageManagerInternal.class);</span><br><span class=\"line\">    Intent intent = <span class=\"keyword\">new</span> Intent();</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæœåŠ¡ component: com.android.systemui/com.android.systemui.SystemUIService</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€æ­¤æœåŠ¡ Java å®ç°ç±»æ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/src/com/android/systemui/SystemUIService.java</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€è¿™ä¸ªç±»æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæˆå‘˜åˆ†åˆ«è´Ÿè´£ä¸åŒçš„äº‹æƒ…</span></span><br><span class=\"line\"><span class=\"comment\">            mainHandle  ï¼šä¸»çº¿ç¨‹é€šè®¯ï¼Œæ˜çŸ¥æ•…é—®</span></span><br><span class=\"line\"><span class=\"comment\">            dumpHandle  ï¼šå½“å‰çº¿ç¨‹è¿è¡ŒçŠ¶æ€ä¿¡æ¯è¾“å‡º</span></span><br><span class=\"line\"><span class=\"comment\">            logBufferFreezer   ï¼šè´Ÿè´£é”™è¯¯æŠ¥å‘Šæ—¥å¿—ç›¸å…³ã€é”™è¯¯æŠ¥å‘Š-å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">        4ã€system server è¿›ç¨‹å¯åŠ¨çš„ UI æœåŠ¡ï¼šæ¥åˆ°äº† SystemUIApplication.java è¿™ä¸ªç±» ((SystemUIApplication) getApplication()).startServicesIfNeeded();</span></span><br><span class=\"line\"><span class=\"comment\">            æ‰€æœ‰çš„ UI æœåŠ¡åŒ…å«å“ªäº›ï¼ŸæœåŠ¡åç§°åˆ—è¡¨å“ªé‡Œæ¥ï¼Ÿåˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„èµ„æº config_systemUIServiceComponents R.array.config_systemUIServiceComponentsPerUser</span></span><br><span class=\"line\"><span class=\"comment\">            èµ„æºæ‰€åœ¨è·¯å¾„æ˜¯ /framework/base/packages/SystemUI/res/value/config.xml</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">            4.1ã€æœåŠ¡åˆ—è¡¨å‚è€ƒä¸‹æ–‡ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">            4.2 é€šè¿‡åå°„åˆ›å»ºæœåŠ¡ Class.forname(serviceName) è°ƒç”¨æŒ‡å®šæ„é€ å‡½æ•° newInstance</span></span><br><span class=\"line\"><span class=\"comment\">            4.3 å¯åŠ¨æœåŠ¡ mServices[i].start(); æ¥ä¸‹æ¥å°±ä¸å…·ä½“çœ‹äº†ï¼Œä»¥åå…·ä½“æœåŠ¡å…·ä½“åˆ†æ</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">        5ã€SysteUIApplication ä»–æ˜¯ä¸€ä¸ª Applicationï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰åˆ›å»ºè¯¥å®ä¾‹æ˜¯ä¼šå…ˆæ‰§è¡Œ onCreate æ–¹æ³•ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">            è¿™é‡Œæœ‰è°ƒç”¨ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå¯¹äºéç§æœ‰çš„éç³»ç»Ÿç”¨æˆ·å°†æ‰§è¡Œ startSecondaryUserServicesIfNeeded();</span></span><br><span class=\"line\"><span class=\"comment\">            è·å–çš„æœåŠ¡åˆ—è¡¨æ˜¯ R.array.config_systemUIServiceComponentsPerUser æŸ¥çœ‹åªæœ‰ä¸€ä¸ªæœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">            5.1 com.android.systemui.util.NotificationChannels</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\">    intent.setComponent(pm.getSystemUiServiceComponent());</span></span><br><span class=\"line\"><span class=\"comment\">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span></span><br><span class=\"line\"><span class=\"comment\">    context.startServiceAsUser(intent, UserHandle.SYSTEM);</span></span><br><span class=\"line\"><span class=\"comment\">    windowManager.onSystemUiStarted();</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p><strong>system UI æœåŠ¡åˆ—è¡¨</strong></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//é€šçŸ¥æ¸ é“æœåŠ¡ï¼ˆAndroid ä½ç‰ˆæœ¬çš„é€šçŸ¥åˆ›å»ºæ˜¯ä¸éœ€è¦è®¾ç½®é€šçŸ¥æ¸ é“ï¼Œåæ¥é«˜ç‰ˆæœ¬å¼•å…¥é€šçŸ¥æ¸ é“å¹¶ä¸”å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™é€šçŸ¥æ˜¾ç¤ºå­˜åœ¨å¼‚å¸¸ï¼‰</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.util.NotificationChannels<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.keyguard.KeyguardViewMediator<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//åº”ç”¨æœ€è¿‘ä»»åŠ¡åˆ—è¡¨</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.recents.Recents<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//éŸ³é‡</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.volume.VolumeUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.stackdivider.Divider<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//çŠ¶æ€æ </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.statusbar.phone.StatusBar<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.usb.StorageNotification<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.power.PowerUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.media.RingtonePlayer<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\">//é”®ç›˜</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.keyboard.KeyboardUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.pip.PipUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.shortcut.ShortcutKeyDispatcher<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>@string/config_systemUIVendorServiceComponent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.util.leak.GarbageMonitor$Service<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.LatencyTester<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.globalactions.GlobalActionsComponent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> <span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.ScreenDecorations<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.biometrics.AuthController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.SliceBroadcastRelayHandler<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.SizeCompatModeActivityController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.statusbar.notification.InstantAppNotifier<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.theme.ThemeOverlayController<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.accessibility.WindowMagnification<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.accessibility.SystemActions<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">item</span>&gt;</span>com.android.systemui.toast.ToastUI<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>System Server å¤§æ¦‚æ˜¯å¯åŠ¨å®Œæˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆå»å“ªé‡Œè¿è¡Œäº†å‘¢ï¼Ÿï¼Ÿï¼Ÿæˆ–è€…ä¸‹ä¸€æ­¥æˆ‘ä»¬ç»§ç»­çœ‹é‚£ä¸ªç‚¹æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿï¼Ÿï¼Ÿä¹‹å‰æˆ‘ä»¬åªæ˜¯ç²—ç•¥æµè§ˆï¼Œä¸­é—´å¿½ç•¥äº†å¾ˆå¤šï¼Œä¸‹ä¸€æ­¥çš„å…¥å£ç‚¹å¯èƒ½è¦è¿”å›ä¹‹å‰çš„ä»£ç é‡æ–°é˜…è¯»å‘ç°åˆé€‚çš„åˆ‡å…¥ç‚¹ï¼ŒSystemServer ä¹Ÿå·²ç»è¿›å…¥äº†â€˜æ°¸ä¹…çš„å¾ªç¯â€™ï¼Œç­‰å¾…çš„å°±æ˜¯æ¥å—å¤–éƒ¨â€˜ä¿¡å·â€™åšç›¸åº”å¤„ç†ã€ç»§ç»­åˆ†å‘åˆ°å…·ä½“æ‰§è¡Œã€‚</p>\n<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸‹å‘¨å†è§ğŸ˜Š</p>\n<h1>é™„åŠ </h1>\n<h2 id=\"å¦‚ä½•å¿«é€Ÿæœç´¢\">å¦‚ä½•å¿«é€Ÿæœç´¢</h2>\n<p><strong>Android é¡¹ç›®ä¸­å¦‚ä½•å¿«é€Ÿæœç´¢æŸå…³é”®å­—ï¼Ÿ</strong></p>\n<p>AOSP æ•´ä¸ªé¡¹ç›®æ˜¯å¾ˆåºå¤§çš„ï¼Œä¸ä»…ä»…æ˜¯åŒ…å« java ä»£ç ï¼Œå°±æ‹¿å½“å‰æˆ‘ä¸‹è½½çš„ <code>Android 11-r21 åˆ†æ”¯</code>æ¥è¯´ï¼Œæˆ‘æ˜¯é€šè¿‡ git ä¸‹è½½åœ¨æ²¡æœ‰æŒ‡å®š <code>single-branch dept=1</code> å‚æ•°ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸‹è½½å®Œæ¯•å ç”¨å¤§çº¦ <strong>430G</strong> å­˜å‚¨ç©ºé—´ã€‚</p>\n<p>ä¸€å¼€å§‹æˆ‘æŠŠæºç å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ï¼Œé€šè¿‡ VSCode æ‰“å¼€æœºå­˜åœ¨æ¢°ç¡¬ç›˜çš„ä¸­çš„é¡¹ç›®ï¼ˆæ•´ä¸ª AOSPï¼‰ï¼Œæ¯”å¦‚æœç´¢æŸä¸ªå…³é”®å­—ï¼Œé‚£ä¸ªé€Ÿåº¦å ªæ¯”é¾Ÿé€Ÿï¼›åæ¥æŠŠé¡¹ç›®æ‹·è´åˆ°ç¬”è®°æœ¬ SSD å›ºæ€ç¡¬ç›˜ï¼Œæœç´¢é€Ÿåº¦ç¡®å®æœ‰äº†æ˜æ˜¾çš„æé«˜ï¼Œä½†æ•´ä¸ªé¡¹ç›®æœç´¢è¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼Œä¸æ˜¯ååˆ†æ»¡æ„ï¼›å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€æŸä¸ªæ¨¡å—â€”â€”â€” framework æ¨¡å—ã€framework base æ¨¡å—ç­‰ç­‰ï¼Œæœç´¢é€Ÿåº¦è¿˜å¯ä»¥æ¥å—ã€‚ä½†å¦‚æœè¦æ‰¾çš„ä»£ç æ ¹æœ¬ä¸åœ¨å½“å‰æ¨¡å—ï¼Œæ¯”å¦‚ä½ æ‰“å¼€ framework base æ¨¡å—ï¼Œä½†å®é™…ä»£ç åœ¨ framework service æ¨¡å—ï¼Œè¿™æ ·æ˜¯æœç´¢ä¸åˆ°ç»“æœçš„ï¼Œå› æ­¤è¿˜å¾—æŠŠæœç´¢èŒƒå›´æ‰©å¤§ï¼Œå¼•å…¥çš„æ¨¡å—å¤šäº†é€Ÿåº¦ç»ˆæ˜¯ä¼šå˜æ…¢ã€‚</p>\n<p>æœç´¢èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç›®æ ‡ï¼Œæ˜¯ä¸æ˜¯è¦å€ŸåŠ©ä¸€ä¸ªä¸œè¥¿â€”â€”â€”â€”<strong>ç´¢å¼•</strong>ï¼Œå¦‚æœæœ‰å·¥å…·æŠŠ AOSP æ•´ä¸ªé¡¹ç›®é¢„å…ˆå»ºç«‹ç´¢å¼•ï¼Œç„¶åå†æ‰“å¼€é¡¹ç›®æœç´¢ï¼Œä¸‹æ¬¡æœç´¢æ—¶æ— éœ€é‡æ–°åˆ›å»ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æœç´¢ä¸å¾—è¦èµ·é£ã€‚<s>ä¸æœç´¢ç›¸å…³ç´¢å¼•ç¡®å®æ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚</s></p>\n<p>ã€<strong>æœ€å</strong>ã€‘</p>\n<p>æ¨èä½¿ç”¨å·²æœ‰çš„åœ¨çº¿ç½‘ç«™è¾…åŠ©æœç´¢ï¼š<a href=\"http://aospxref.com\"><strong>åŸºäº opengrok çš„ AOSPXRef</strong></a></p>\n<p>ä»¥æœç´¢ SystemUIService <code>config_systemUIServiceComponent</code>ä¸ºä¾‹ï¼š<br>\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6d6877806a144cfb2a73a40aa569c01~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>ã€<strong>æœ€åçš„æœ€å</strong>ã€‘</p>\n<p>ASOPXRef ç°æœ‰çš„é¡¹ç›®æ˜¯è¾ƒå°‘çš„ï¼Œä¹Ÿå°±æ˜¯å‡ ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œå¦‚æœèƒ½æ»¡è¶³è‡ªå·±çš„éœ€æ±‚åˆšå¥½ï¼Œè¦æ˜¯æƒ³çœ‹çš„æºç ç‰ˆæœ¬ä¸æ˜¯å·²å­˜åœ¨çš„å»ºè®®è¿˜æ˜¯è‡ªå·±é€šè¿‡ <code>opengrok</code> å¼•æ“æ­å»ºä¸€ä¸ªæœåŠ¡ã€‚<br>\n<strong>Oracle opengrokï¼š</strong><a href=\"https://github.com/oracle/opengrok\">å¿«é€Ÿä¸”å¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“</a></p>\n<h2 id=\"å‚è€ƒé“¾æ¥\">å‚è€ƒé“¾æ¥</h2>\n<ul>\n<li>WTFï¼šWhat a Terrible Failure â€”â€” Android ç³»ç»Ÿé”™è¯¯è®°å½•çš„ä¸€ç§</li>\n<li>Memtrackï¼šå†…å­˜åˆ†æ <a href=\"https://zhuanlan.zhihu.com/p/168361476\">https://zhuanlan.zhihu.com/p/168361476</a></li>\n<li>Hidlï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼Œåœ¨è¾ƒä½ Android ç‰ˆæœ¬å¯èƒ½è¿˜åœ¨ä½¿ç”¨ HAL ï¼ˆhardware abstract layerï¼‰<a href=\"https://zhuanlan.zhihu.com/p/28256541\">https://zhuanlan.zhihu.com/p/28256541</a></li>\n<li>Android Uriï¼š<a href=\"https://www.cnblogs.com/bhlsheji/p/4246580.html\">https://www.cnblogs.com/bhlsheji/p/4246580.html</a></li>\n<li>Android é”™è¯¯æŠ¥å‘Šï¼š<a href=\"https://developer.android.com/studio/debug/bug-report\">https://developer.android.com/studio/debug/bug-report</a> ï¼Œ<a href=\"https://source.android.com/source/read-bug-reports.html\">https://source.android.com/source/read-bug-reports.html</a></li>\n<li>Android å¢“ç¢‘ï¼š<a href=\"https://source.android.com/devices/tech/debug\">https://source.android.com/devices/tech/debug</a></li>\n</ul>\n"},{"layout":"android","catalog":true,"title":"Android ç³»ç»Ÿ Init","subtitle":"æœ¬ç³»åˆ—æ–‡ç« åŸºäº Android 11-r21 master","date":"2022-09-29T14:55:05.000Z","header-img":"/img/220928/android_init_bg.png","sticky":5,"_content":"\n\n# è®¾å¤‡å¯åŠ¨ç®€è¿°\n\n**1ã€BIOS åŠ è½½**\n- åŠ ç”µè‡ªæ£€ï¼ˆåŸºæœ¬è¾“å‡º/è¾“å…¥ç³»ç»Ÿ stdioï¼‰\n    - ç¡¬ä»¶è‡ªæ£€`POST`\n- å¤–éƒ¨å­˜å‚¨è®¾å¤‡`å¯åŠ¨é¡ºåºæ’åº`ï¼Œä¸‹ä¸€ä¸ªè·å¾—æ§åˆ¶æƒçš„è®¾å¤‡\n- è¯»å–æ¿€æ´»åˆ†åŒºç¬¬ä¸€ä¸ªæ‰‡åŒºçš„ `ä¸»å¼•å¯¼è®°å½•`ï¼ˆ512 å­—èŠ‚ï¼‰\n    - è´Ÿè´£åˆ†åŒºè¯»å†™åˆæ³•æ€§åˆ¤æ–­\n    - è´Ÿè´£å¼•å¯¼ä¿¡æ¯å®šä½\n    - æ•°æ®å­˜å‚¨\n        - è°ƒç”¨æ“ä½œç³»ç»Ÿçš„æœºå™¨ç \n        - åˆ†åŒºè¡¨\n            - ä¸»åˆ†åŒºæ˜¯æ¿€æ´»çš„ï¼Œæ¿€æ´»åˆ†åŒºçš„ç¬¬ä¸€ä¸ªæ‰‡åŒºæ˜¯`å·å¼•å¯¼è®°å½•`ï¼ˆå‘Šè¯‰è®¡ç®—æœºæ“ä½œç³»ç»Ÿåœ¨åˆ†åŒºçš„ä½ç½®-ç³»ç»Ÿç›˜åˆ†åŒºï¼‰\n            - å½“åªæœ‰ä¸€ä¸ªç³»ç»Ÿæ—¶å€™ï¼Œæ§åˆ¶æƒå°†äº¤ç»™æŸåˆ†åŒºï¼›å¦åˆ™å°†å¯åŠ¨`å¯åŠ¨ç®¡ç†å™¨`è®©ç”¨æˆ·é€‰æ‹©æ“ä½œç³»ç»Ÿ\n        - ä¸»å¼•å¯¼è®°å½•ç­¾å\n            - æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯ `0x55ã€0xAA` è¡¨ç¤ºå¯å¯åŠ¨è®¾å¤‡\n\n**2ã€kernel åŠ è½½**\n\n- ç¡®å®šæ“ä½œç³»ç»Ÿä¹‹åè·å¾—æ§åˆ¶æƒï¼Œæ¥ç€åŠ è½½å†…æ ¸åˆ°å†…å­˜\n- Linux ç³»ç»Ÿå†…æ ¸ä½äº`boot/kernel`\n- è¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº`sbin/init`\n- è§£æé…ç½®æ–‡ä»¶`etc/initab`åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¿›ç¨‹ `id 1`\n- ä¹‹å init è¿›ç¨‹åˆ†åˆ«åŠ è½½ç³»ç»Ÿå„æ¨¡å—çš„è¿›ç¨‹\n\n\n# Android å¯åŠ¨\nAndroid ä¸å­˜åœ¨ BIOSï¼Œä½†æ˜¯æœ‰ `Bootloader`ï¼ŒAndroid ä¸å­˜åœ¨ç¡¬ç›˜ï¼Œä½†æ˜¯æœ‰`ROM`ï¼ˆç±»ä¼¼ç¡¬ç›˜ï¼Œç”±ä¸åŒåŒºåŸŸåˆ’åˆ†ï¼‰ã€‚\n\n**1ã€Bootloader**\n- åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡\n- å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„ï¼ˆä¸ºç³»ç»Ÿè°ƒç”¨æœåŠ¡ï¼‰\n\n**2ã€ROM**\n- /boot ï¼šå¼•å¯¼ç¨‹åº â€”â€” æ“ä½œå†…æ ¸ã€å†…å­˜çš„ç¨‹åº\n- /system ï¼šç›¸å½“äºç³»ç»Ÿç›˜ â€”â€” æ“ä½œç³»ç»Ÿã€ç³»ç»Ÿç¨‹åº\n- /recovery ï¼š æ¢å¤åˆ†åŒº â€”â€” æ¢å¤æ“ä½œç³»ç»Ÿï¼ˆåˆ·æœºï¼‰\n- /data ï¼š ç”¨æˆ·æ•°æ® â€”â€” å®‰è£…ç¨‹åºã€å¤–éƒ¨æ•°æ®\n- /cache ï¼š ç³»ç»Ÿç¼“å­˜\n- /scared ï¼š ç”¨æˆ·å­˜å‚¨ç©ºé—´ â€”â€” ç›¸å†Œã€éŸ³ä¹\n\n\n**3ã€Bootloader åŠ è½½**\n- åŠ ç”µï¼Œå¼•å¯¼èŠ¯ç‰‡åŠ è½½ ROM é¢„è®¾ä»£ç æ‰§è¡Œ\n- èŠ¯ç‰‡æŸ¥æ‰¾ Bootloader ä»£ç å¹¶åŠ è½½åˆ°å†…å­˜\n- Bootloader å¼€å§‹æ‰§è¡Œï¼ŒæŸ¥æ‰¾æ“ä½œç³»ç»Ÿã€åŠ è½½ Linux å†…æ ¸åˆ°å†…å­˜\n- Linux å†…æ ¸å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–ç¡¬ä»¶ã€åŠ è½½é©±åŠ¨ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€åˆ›å»ºå¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´ `init è¿›ç¨‹`\n\n# Linux å†…æ ¸åŠ è½½\n\n**1ã€idle è¿›ç¨‹ï¼ˆpid = 0ï¼‰**\n- Linux ç³»ç»Ÿç¬¬ä¸€ä¸ªè¿›ç¨‹\n- è¿›ç¨‹åå­—`init_task`ï¼Œé€€åŒ–åçš„`idle`\n- ä¸æ˜¯é€šè¿‡`forkã€kernel_thread`åˆ›å»ºçš„è¿›ç¨‹\n- ä¸»è¦è´Ÿè´£è¿›ç¨‹è°ƒåº¦å·¥ä½œï¼Œè¿›å…¥æ— é™å¾ªç¯\n\n**2ã€init è¿›ç¨‹ï¼ˆpid = 1ï¼‰**\n- ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹\n- å¯åŠ¨å‰éƒ¨åˆ†ï¼šå®Œæˆåˆ›å»ºå’Œå†…æ ¸åˆå§‹åŒ–\n- å¯åŠ¨åéƒ¨åˆ†ï¼šå®Œæˆ Android ç³»ç»Ÿåˆå§‹åŒ–\n- /system/core/init/init.cpp\n\n\n**3ã€kthreadd è¿›ç¨‹ï¼ˆpid = 2ï¼‰**\n- Linux å†…æ ¸ç®¡ç†è€…ï¼Œå†…æ ¸çº¿ç¨‹çš„çˆ¶è¿›ç¨‹\n- ä¸»è¦è´Ÿè´£å†…æ ¸çº¿ç¨‹çš„è°ƒåº¦å’Œç®¡ç†\n- ç”± idle é€šè¿‡`kernel_thead`åˆ›å»º\n\n# Android ç³»ç»Ÿå¯åŠ¨\n\nç›¸å…³æ–‡ä»¶ï¼š\n- /system/core/init/main.cpp\n- /system/core/init/first_state_main.cpp\n- /system/core/init/first_state_init.cpp\n- /system/core/init/main.cpp\n- /system/core/init/selinux.cpp\n- /system/core/init/main.cpp\n- /system/core/init/init.cpp\n- /system/core/init/property_service.cpp\n- /system/core/init/subcontext.h\n- /system/core/init/subcontext.cpp\n- /system/core/init/builtins.cpp\n- /system/core/init/action.cpp\n\n\nç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰å¯åŠ¨æ„å‘³ç€å¼€å§‹ Android ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ï¼Œåˆå§‹åŒ–è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ main å‡½æ•°çš„æ‰§è¡Œï¼Œä¸»è¦è´Ÿè´£å‡†å¤‡å’Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿã€‚\n\n```cpp\n//main.cpp\nint main(int argc, char** argv) {\n    \n    //ç•¥\n\n   if (argc > 1) {\n       if (!strcmp(argv[1], \"subcontext\")) {\n           //å†…æ ¸æ—¥å¿—åˆå§‹åŒ–ï¼Œå†…æ ¸çš„æºç åœ¨å¦å¤–çš„ä»“åº“ï¼Œæš‚æ—¶çœ‹ä¸äº†\n           android::base::InitLogging(argv, &android::base::KernelLogger);\n           //å‡½æ•°æ˜ å°„ï¼Œè°ƒç”¨çš„å¯éƒ½æ˜¯å†…æ ¸å‡½æ•°ã€å‚è€ƒbuiltins.cppã€‘\n           const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n           //4ã€è¿˜æ˜¯è¿›å…¥ subcontext.cppï¼Œå¼€å§‹ä¸Šä¸‹æ–‡\n           return SubcontextMain(argc, argv, &function_map);\n        }\n\n        //2ã€æ‰§è¡Œç¬¬äºŒé˜¶æ®µå‰ï¼Œå»ºç«‹Linuxå®‰å…¨æœºåˆ¶\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            //3ã€åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    //1ã€åˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µ\n    return FirstStageMain(argc, argv);\n}\n```\n\n## åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰\n\nä¸ºæ–‡ä»¶ç³»ç»Ÿå‡†å¤‡å’Œåˆ›å»ºç¯å¢ƒ\n\n```cpp\n//first_state_init.cpp\nint FirstStageMain(int argc, char** argv) {\n    //å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿ\n    CHECKCALL(clearenv());\n    //Linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œsocket ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    //755 æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ chmod 755 è®¿é—®æƒé™ï¼›7/5/5 â€”â€” ç”¨æˆ·/ç”¨æˆ·ç»„/å…¶ä»–ç”¨æˆ·ï¼ˆ421ç»„åˆï¼‰\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    //é‡è¦çš„å¯åŠ¨é…ç½®æ–‡ä»¶ï¼Œæ›´å¤šè¯·å‚è€ƒ https://www.kernel.org/doc/html/\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n        \n    //å¿…ä¸å¯å°‘çš„æ—¥å¿—\n    //ç»è¿‡å‰é¢çš„å‡†å¤‡ã€æ£€éªŒå·¥ä½œï¼Œåˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µåˆå§‹åŒ–å·¥ä½œå°±è¦å¼€å§‹\n    InitKernelLogging(argv);\n    \n    //æ£€æŸ¥è™šæ‹Ÿå†…å­˜æ˜¯å¦é‡Šæ”¾ã€å¦‚æœªå¼€å¯åˆ™éœ€è¦é‡å¯\n    auto old_root_dir = std::unique_ptr<DIR, decltype(&closedir)>{opendir(\"/\"), closedir};\n    //åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå¯èƒ½è¿˜è®°å¾— majorï¼ˆå†…æ ¸ä¸»ç‰ˆæœ¬ï¼‰ã€ minorï¼ˆå†…æ ¸æ¬¡ç‰ˆæœ¬ï¼‰ï¼Œç‰ˆæœ¬ä¿¡æ¯åœ¨åŠ è½½å‰éƒ½ä¼šå»è§£æï¼Œ\n    if (!LoadKernelModules(IsRecoveryMode() \n    && !ForceNormalBoot(cmdline, bootconfig), \n    want_console,want_parallel, module_count)) {\n       //ç•¥\n    }\n    \n    //åœ¨ recovery æ¨¡å¼ä¸‹ä¸å…è®¸åˆ›å»ºè®¾å¤‡å•Š\n    if (!IsRecoveryMode()) {\n        created_devices = DoCreateDevices();\n    }\n    \n    //ä¸ºåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µå‡†å¤‡\n    ///second_stage_resource/system/etc/ramdisk/build.prop\n    std::string dest = GetRamdiskPropForSecondStage();\n    \n    //æ‰§è¡Œç¬¬ä¸€é˜¶æ®µçš„æŒ‚è½½\n    if (!DoFirstStageMount(!created_devices))\n    \n    //ç¥å¥‡çš„ execv å‡½æ•°ï¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ›¿æ¢å½“å‰è¿›ç¨‹æ˜ åƒç»§ç»­æ‰§è¡Œï¼Œç´§æ¥ç€é€šè¿‡ä¼ å…¥çš„ `selinux_setup`å‚æ•°æ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°\n    //æ›´å¤š execv å‚è€ƒï¼šhttps://linux.die.net/man/3/execv\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    execv(path, const_cast<char**>(args));\n    //ç¬¬ä¸€é˜¶æ®µå¤§è‡´åˆ°æ­¤ç»“æŸ\n```\n\nå‡†å¤‡ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜ å°„ã€‚\n\n```cpp\n//builtins.cpp\n//è¿™ä¸ªå†…ç½®å‡½æ•°æ˜ å°„æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\n// æ¯”å¦‚  {\"start\",{1,1,{false,  do_start}}},\n// start å‘½ä»¤å¯¹åº”çš„æ‰§è¡Œçš„å‡½æ•°å°±æ˜¯ buildins.cpp é‡Œé¢å®šä¹‰çš„ do_start å‡½æ•°\nconst BuiltinFunctionMap& GetBuiltinFunctionMap() {\n    constexpr std::size_t kMax = std::numeric_limits<std::size_t>::max();\n    static const BuiltinFunctionMap builtin_functions = {\n        {\"bootchart\",               {1,     1,    {false,  do_bootchart}}},\n        {\"chmod\",                   {2,     2,    {true,   do_chmod}}},\n        {\"chown\",                   {2,     3,    {true,   do_chown}}},\n        {\"class_reset\",             {1,     1,    {false,  do_class_reset}}},\n        {\"class_restart\",           {1,     2,    {false,  do_class_restart}}},\n        {\"class_start\",             {1,     1,    {false,  do_class_start}}},\n        {\"class_stop\",              {1,     1,    {false,  do_class_stop}}},\n        {\"copy\",                    {2,     2,    {true,   do_copy}}},\n        {\"copy_per_line\",           {2,     2,    {true,   do_copy_per_line}}},\n        {\"domainname\",              {1,     1,    {true,   do_domainname}}},\n        {\"enable\",                  {1,     1,    {false,  do_enable}}},\n        {\"exec\",                    {1,     kMax, {false,  do_exec}}},\n        {\"exec_background\",         {1,     kMax, {false,  do_exec_background}}},\n        {\"exec_start\",              {1,     1,    {false,  do_exec_start}}},\n        {\"export\",                  {2,     2,    {false,  do_export}}},\n        {\"hostname\",                {1,     1,    {true,   do_hostname}}},\n        {\"ifup\",                    {1,     1,    {true,   do_ifup}}},\n        {\"init_user0\",              {0,     0,    {false,  do_init_user0}}},\n        {\"insmod\",                  {1,     kMax, {true,   do_insmod}}},\n        {\"installkey\",              {1,     1,    {false,  do_installkey}}},\n        {\"interface_restart\",       {1,     1,    {false,  do_interface_restart}}},\n        {\"interface_start\",         {1,     1,    {false,  do_interface_start}}},\n        {\"interface_stop\",          {1,     1,    {false,  do_interface_stop}}},\n        {\"load_exports\",            {1,     1,    {false,  do_load_exports}}},\n        {\"load_persist_props\",      {0,     0,    {false,  do_load_persist_props}}},\n        {\"load_system_props\",       {0,     0,    {false,  do_load_system_props}}},\n        {\"loglevel\",                {1,     1,    {false,  do_loglevel}}},\n        {\"mark_post_data\",          {0,     0,    {false,  do_mark_post_data}}},\n        {\"mkdir\",                   {1,     6,    {true,   do_mkdir}}},\n        {\"mount_all\",               {0,     kMax, {false,  do_mount_all}}},\n        {\"mount\",                   {3,     kMax, {false,  do_mount}}},\n        {\"perform_apex_config\",     {0,     0,    {false,  do_perform_apex_config}}},\n        {\"umount\",                  {1,     1,    {false,  do_umount}}},\n        {\"umount_all\",              {0,     1,    {false,  do_umount_all}}},\n        {\"update_linker_config\",    {0,     0,    {false,  do_update_linker_config}}},\n        {\"readahead\",               {1,     2,    {true,   do_readahead}}},\n        {\"remount_userdata\",        {0,     0,    {false,  do_remount_userdata}}},\n        {\"restart\",                 {1,     2,    {false,  do_restart}}},\n        {\"restorecon\",              {1,     kMax, {true,   do_restorecon}}},\n        {\"restorecon_recursive\",    {1,     kMax, {true,   do_restorecon_recursive}}},\n        {\"rm\",                      {1,     1,    {true,   do_rm}}},\n        {\"rmdir\",                   {1,     1,    {true,   do_rmdir}}},\n        {\"setprop\",                 {2,     2,    {true,   do_setprop}}},\n        {\"setrlimit\",               {3,     3,    {false,  do_setrlimit}}},\n        {\"start\",                   {1,     1,    {false,  do_start}}},\n        {\"stop\",                    {1,     1,    {false,  do_stop}}},\n        {\"swapon_all\",              {0,     1,    {false,  do_swapon_all}}},\n        {\"enter_default_mount_ns\",  {0,     0,    {false,  do_enter_default_mount_ns}}},\n        {\"symlink\",                 {2,     2,    {true,   do_symlink}}},\n        {\"sysclktz\",                {1,     1,    {false,  do_sysclktz}}},\n        {\"trigger\",                 {1,     1,    {false,  do_trigger}}},\n        {\"verity_update_state\",     {0,     0,    {false,  do_verity_update_state}}},\n        {\"wait\",                    {1,     2,    {true,   do_wait}}},\n        {\"wait_for_prop\",           {2,     2,    {false,  do_wait_for_prop}}},\n        {\"write\",                   {2,     2,    {true,   do_write}}},\n    };\n    return builtin_functions;\n}\n```\n\n## å»ºç«‹ SELinux\n\nç¬¬ä¸€é˜¶æ®µæœ€å execv å‡½æ•°ä¼ å…¥åˆå§‹åŒ–å‚æ•° `selinux_setup`ï¼Œæ‰§è¡Œæµç¨‹å›åˆ° main.cppï¼Œç”± strcmp å‡½æ•°åˆ¤æ–­è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚\n\n```cpp\n//main.cpp\nif (!strcmp(argv[1], \"selinux_setup\")) {\n    return SetupSelinux(argv);\n}\n```\n\n```cpp\n//SetupSelinux.cpp\nint SetupSelinux(char** argv) {\n    //å‡†å¤‡å®‰å…¨ç­–ç•¥ï¼ŒæŸè·¯å¾„ä¸‹çš„ SEPolicy.zip æ–‡ä»¶\n    PrepareApexSepolicy();\n    //è¯»å–å®‰å…¨ç­–ç•¥\n    ReadPolicy(&policy);\n    //åŠ è½½å®‰å…¨ç­–ç•¥\n    LoadSelinuxPolicy(policy);\n    //å¼ºåˆ¶æ‰§è¡Œç­–ç•¥\n    SelinuxSetEnforcement();\n\n    //å…³é”®ä»£ç åˆæ¥äº†ï¼Œè°ƒç”¨ execvï¼Œåˆå§‹åŒ–å‚æ•° second_stageï¼Œå‡†å¤‡æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n}\n```\n\n## åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰\nexecv è°ƒç”¨åˆæ¥äº†ï¼Œæœ¬æ¬¡ä¼ å…¥åˆå§‹åŒ–å‚æ•°æ˜¯ `second_stage`ï¼Œæ‰§è¡Œæµç¨‹å†æ¬¡å›åˆ° main.cppï¼Œç´§æ¥ç€å¼€å§‹ç¬¬äºŒé˜¶æ®µçš„åˆå§‹åŒ–ã€‚\n\n```cpp\n//main.cpp\nif (!strcmp(argv[1], \"second_stage\")) {\n    return SecondStageMain(argc, argv);\n}\n```\n```cpp\n//init.cpp\nint SecondStageMain(int argc, char** argv) {\n    //å¦‚æœè®¾å¤‡è§£é” unlockï¼Œå°†å…è®¸ adb root åŠ è½½è°ƒè¯•ä¿¡æ¯\n    const char* force_debuggable_env = getenv(\"INIT_FORCE_DEBUGGABLE\");\n    bool load_debug_prop = false;\n    if (force_debuggable_env && AvbHandle::IsDeviceUnlocked()) {\n        load_debug_prop = \"true\"s == force_debuggable_env;\n    }\n    \n    //å±æ€§åˆå§‹åŒ–ï¼Œåˆ›å»ºå±æ€§ä¿¡æ¯å¹¶å­˜å‚¨åœ¨ /dev/__properties__/property_info æ–‡ä»¶ä¸­\n    //ä»å…¶ä»–å¤šä¸ªæ–‡ä»¶è¯»å–æ•°æ®ï¼Œæ„é€ æˆ PropertyInf å±æ€§é›†åˆ\n    //è¿˜å¤„ç†äº†å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šè¿™äº›è¢«å¤„ç†çš„ä¿¡æ¯å°†è¢« InitPropertySet(name,value) å‡½æ•°å†™å…¥ property_info æ–‡ä»¶ä¸­\n    //    ProcessKernelDt();\n    //    ProcessKernelCmdline();\n    //    ProcessBootconfig();\n    //    ExportKernelBootProps();//é‡åˆ°äº†é™Œç”Ÿåˆç†Ÿæ‚‰çš„ ro.boot é”®å€¼å¯¹å±æ€§ï¼Œä¾‹å¦‚ \"ro.boot.mode\"\n    \n    //PropertyLoadBootDefaults();//ä¸Šè¿°æ”¶é›†åˆ°çš„å±æ€§ä¿¡æ¯éƒ½å°†è¢«åŠ è½½ï¼Œå¦‚æœæ˜¯æ¢å¤æ¨¡å¼ï¼ˆåˆ·æœºï¼‰IsRecoveryMode()ï¼Œé‚£ä¹ˆä¼šåŠ è½½é»˜è®¤çš„å±æ€§æ–‡ä»¶ /prop.default \n    //GetRamdiskPropForSecondStage(); //ç¬¬äºŒé˜¶æ®µéœ€è¦çš„å±æ€§å»å“ªé‡ŒåŠ è½½ï¼Ÿ/second_stage_resources/system/etc/ramdisk/build.prop\n    PropertyInit();\n    \n    //æŒ‚è½½ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿï¼šapexã€linkerconfig\n    MountExtraFilesystems();\n    \n    //æ³¨å†Œ socket ç›‘å¬\n    Epoll epoll;\n    InstallSignalFdHandler(&epoll);\n    InstallInitNotifier(&epoll);\n\n    //å¯åŠ¨å±æ€§æœåŠ¡ï¼Œé€šè¿‡ socket é€šè®¯\n    StartPropertyService();\n    \n    //oemï¼šåˆ·æœºçš„åŒå­¦å¯èƒ½ä¼šè®°å¾— â€˜å¼€å‘è€…é€‰é¡¹â€™ ä¸­å°±æœ‰ä¸ªé€‰é¡¹æ˜¯ â€˜OEMè§£é”â€™â€”â€”æ˜¯å¦å…è®¸è§£é”å¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ·æœºæ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šæ‰“å¼€æ­¤é€‰é¡¹\n    export_oem_lock_status(); \n    \n    //åŸæ¥ usb å¯¹åº”çš„å±æ€§æ˜¯ sys.usb.controllerï¼Œæ‰€åœ¨æ–‡ä»¶ /sys/class/udc\n    SetUsbController();\n    \n    //å†…æ ¸ç‰ˆæœ¬ ro.kernel.versionï¼ŒåŒ…å«ä¸»ç‰ˆæœ¬ major å’Œæ¬¡ç‰ˆæœ¬ minor\n    SetKernelVersion();\n    \n    //åˆå§‹åŒ– subcontext ä¸€ä¸ªè¿›ç¨‹ã€è¯·è½¬åˆ° subcontext.hã€‘\n    InitializeSubcontext();\n    \n    //åŠ è½½å¯åŠ¨è„šæœ¬\n    //é¦–å…ˆé€šè¿‡ Property åŠ è½½ ro.boot.init_rc å±æ€§å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™åŠ è½½ /system/etc/init/hw/init.rc\n    //actionManager æ·»åŠ ä¸€å †ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ action è¿›å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ\n    //serviceList é€šè¿‡è§£æä¸€äº› /init.rcã€/system/etc/initã€/vendor/etc/init è·å–çš„æœåŠ¡\n    LoadBootScripts(actionManager, serviceList);\n\n    //å‡†å¤‡è¿›å…¥æ— é™å¾ªç¯ï¼Œæ­¤å‰é‡ç½®è¿›ç¨‹ä¼˜å…ˆçº§\n    //prio ä¼˜å…ˆçº§èŒƒå›´ 0ï½139ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜\n    setpriority(PRIO_PROCESS, 0, 0);\n    while (true) {\n        //epoll è´Ÿè´£äº‹ä»¶å¤„ç†ï¼Œé»˜è®¤æƒ…å†µ epoll ä¼šä¼‘çœ ï¼Œç±»ä¼¼é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶åˆ°æ¥ï¼›å…³äº epoll \n        //å¦‚æœæœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç­‰å¾…äº‹ä»¶å°†è¢«ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é©¬ä¸Šå¤„ç†äº‹ä»¶\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{kDiagnosticTimeout};\n        \n        //æ¯æ¬¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å…³æœº\n        auto shutdown_command = shutdown_state.CheckShutdown();\n        \n        //è¿˜ä¼šæ£€æµ‹å¦‚æœè¿›ç¨‹éœ€è¦é‡å¯ï¼Œå°†ç«‹å³å¯åŠ¨\n        auto next_process_action_time = HandleProcessActions();\n    \n        //å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°† fron ç¬¬ä¸€ä¸ªäº‹ä»¶å–å‡ºè¿›è¡Œå¤„ç†ï¼Œé€’å½’è¿›è¡Œï¼ŒåŠ é”åŒæ­¥è¿›è¡Œ\n        HandleControlMessage();\n        //è‡³æ­¤ï¼Œç¬¬äºŒé˜¶æ®µå®Œæ¯•\n    }\n}\n```\n\n```cpp\n//subcontext.h\nclass Subcontext {\n  public:\n    Subcontext(std::vector<std::string> path_prefixes, std::string context, bool host = false)\n        : path_prefixes_(std::move(path_prefixes)), context_(std::move(context)), pid_(0) {\n        if (!host) {\n            //æ„é€ å‡½æ•°ä¸­ç›´æ¥ fork ä¸€ä¸ªè¿›ç¨‹\n            Fork();\n        }\n    }\n}\n\n```\n\n```cpp\n//subcontext.cpp\nvoid Subcontext::Fork() {\n    //åˆ›å»ºä¸€ä¸ªå¯¹åº”ä¸Šä¸‹æ–‡çš„ socket\n    unique_fd subcontext_socket;\n    if (!Socketpair(AF_UNIX, SOCK_SEQPACKET | SOCK_CLOEXEC, 0, &socket_, &subcontext_socket)) {\n        return;\n    }\n    \n#if defined(__ANDROID__)\n    //subcontext çš„åˆå§‹åŒ–éœ€è¦åœ¨æŒ‚è½½ default çš„ç©ºé—´ä¸‹ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® /apex\n    if (auto result = SwitchToMountNamespaceIfNeeded(NS_DEFAULT); !result.ok()) {\n        LOG(FATAL) << \"Could not switch to \\\"default\\\" mount namespace: \" << result.error();\n    }\n#endif\n\n   //è·å–ä¸‹ä¸€é˜¶æ®µåˆå§‹åŒ–çš„æ‰§è¡Œè·¯å¾„ï¼Œè‡³å…³é‡è¦å•Šå…„å¼Ÿä»¬\n   //Android11 æºç çº¦450Gï¼Œç›®å‰ä½¿ç”¨ vscode æœç´¢æŸå…³é”®å­—ï¼Œ\n   //æœç´¢æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæœç´¢å¤ªæ…¢äº†ï¼Œä¼¼ä¹ç´¢å¼•å»ºç«‹å¤ªæ…¢ï¼Ÿæœ‰ä»€ä¹ˆæ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿æ¢ vscode ???  \n   //å·¥å…· â€”â€”â€”â€” https://github.com/oracle/opengrok  Oracle å¼€æºçš„çœŸæ˜¯ç¦åˆ©å¥½ã€‚\n   // \n   //----- å‡è£…æˆ‘æ˜¯åˆ†å‰²çº¿ -----\n   //\n   //é‚£ä¹ˆ GetExecutablePath å®ç°åœ¨å“ªé‡Œï¼Ÿæºç ä¸­æ²¡çœ‹åˆ°å•Š\n   //âš ï¸æ³¨æ„äº†ï¼š\n   // 1ã€è°ƒç”¨ GetExecutablePath() æ‰€åœ¨å‘½åç©ºé—´æ˜¯ using android::base::GetExecutablePath;\n   // 2ã€çœ‹çœ‹å¼•å…¥çš„å¤´æ–‡ä»¶ #include <android-base/properties.h>ï¼Œæ³¨æ„å’¯ï¼Œæ˜¯å°–æ‹¬å·<>å¼•å…¥æ–¹å¼ï¼Œè€Œä¸æ˜¯åŒå¼•å·â€œâ€æœ¬åœ°å¼•å…¥ï¼Œè¯´æ˜æœ¬åœ°é¡¹ç›®ä¸‹æ ¹æœ¬æ‰¾ä¸åˆ°ï¼Œæ˜¯é€šè¿‡ç³»ç»Ÿè¿æ¥è¿›æ¥çš„ã€‚\n   // 3ã€æŸ¥é˜…å®˜ç½‘ï¼Œå‘ç°æ–‡ä»¶å®ç°åœ¨å†…æ ¸ä»“åº“æœ‰ä¸€ä»½å¯æŸ¥é˜…ã€‚https://source.android.google.cn/devices/tech/config/kernel?hl=zh-cn\n   auto init_path = GetExecutablePath();\n   auto child_fd_string = std::to_string(child_fd);\n   //ç»ˆäºåˆç­‰åˆ°äº† execv å‡½æ•°ï¼Œæ³¨æ„ä¼ å‚ subcontextï¼Œæ˜¯ä¸æ˜¯åˆå›åˆ°äº† main.cppã€æˆ–è®¸ä½ å¯¹ main.cpp å·²æ²¡æœ‰äº†å°è±¡ï¼Œæ¯•ç«Ÿå­¦ä¹ å°±æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œåå¤çš„ã€åå¤çš„ã€åå¤çš„å°è±¡ä¹Ÿå°±æ·±åˆ»äº†ã€‘\n   const char* args[] = {init_path.c_str(), \"subcontext\", context_.c_str(),child_fd_string.c_str(), nullptr};\n   execv(init_path.data(), const_cast<char**>(args));\n}\n```\n\n```cpp\n//main.cpp\n//æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œåœ°çƒæ˜¯åœ†çš„ï¼Œä½ åœ¨æ­¤å¤„é™å€™ï¼Œæˆ‘ä¸€ç›´å¾€åŒ—èµ°ï¼Œæœ€åè¿˜èƒ½ç›¸é‡ä¸æ˜¯å—ï¼Ÿ\nif (!strcmp(argv[1], \"subcontext\")) {\n    android::base::InitLogging(argv, &android::base::KernelLogger); \n    const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n    return SubcontextMain(argc, argv, &function_map);\n}\n```\n\n\n```cpp\n//subcontext.cpp\nint SubcontextMain(int argc, char** argv, const BuiltinFunctionMap* function_map) {\n    \n    //ä¸»è¦è¿˜æ˜¯å¹²ä¸¤ä»¶äº‹ï¼Œåˆ›å»ºä¸Šä¸‹æ–‡è¿›ç¨‹ã€å¹¶è¿›å…¥æ— é™å¾ªç¯\n    auto subcontext_process = SubcontextProcess(function_map, context, init_fd);\n    // Restore prio before main loop\n    setpriority(PRIO_PROCESS, 0, 0);\n    subcontext_process.MainLoop();\n}\n```\n\n```cpp\n//subcontext.cpp\nclass SubcontextProcess {\n  public:\n    SubcontextProcess(const BuiltinFunctionMap* function_map, std::string context, int init_fd)\n        : function_map_(function_map), context_(std::move(context)), init_fd_(init_fd){};\n    void MainLoop();\n}\n\nvoid SubcontextProcess::MainLoop() {\n    pollfd ufd[1];\n    ufd[0].events = POLLIN;\n    ufd[0].fd = init_fd_;\n    \n    //è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†å¾ªç¯äº‹ä»¶çš„è¿˜æ˜¯ poll å…·æŸ„ï¼Œä½¿ç”¨ socket é€šè®¯\n    while (true) {\n        //å¤„ç†çš„æ¶ˆæ¯ç±»å‹æœ‰ä¸¤ç§ï¼šæ‰§è¡Œå‹ã€æ•°æ®è§£æå‹\n        auto subcontext_command = SubcontextCommand();\n        auto reply = SubcontextReply();\n        switch (subcontext_command.command_case()) {\n            case SubcontextCommand::kExecuteCommand: {\n                RunCommand(subcontext_command.execute_command(), &reply);\n                break;\n            }\n            case SubcontextCommand::kExpandArgsCommand: {\n                ExpandArgs(subcontext_command.expand_args_command(), &reply);\n                break;\n            }\n            default:\n                LOG(FATAL) << \"Unknown message type from init: \"\n                           << subcontext_command.command_case();\n        }\n        \n        //å¾ªç¯ä¸­å¹²çš„äº‹å°±æ˜¯ä¸æ–­åˆ†å‘æ¶ˆæ¯ï¼Œåˆ°æ­¤ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ–èŠ‚æœ¬ç»“æŸ\n        //ï¼Ÿï¼Ÿï¼Ÿå‘µï¼Œä¸€è„¸æ‡µé€¼å§ï¼Œæ¶ˆæ¯å‘å‡ºå»ä¹‹åå‘¢ï¼Ÿä¹‹ååˆå»æ‰§è¡Œå“ªé‡Œäº†ğŸ¤”ï¸\n        if (auto result = SendMessage(init_fd_, reply); !result.ok()) {\n            LOG(FATAL) << \"Failed to send message to init: \" << result.error();\n        } \n    }\n}\n```\n\n# æœ€å\nAndroid ç³»ç»Ÿå¯åŠ¨ç”± Linux åˆ›å»º init è¿›ç¨‹ï¼Œinit è¿›ç¨‹é€šè¿‡è§£æ `init.rc` ç­‰å‡ ä¸ªåˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è§£ææ•°æ®ç»§ç»­åˆ›å»ºã€å¯åŠ¨å…¶ä»–çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œç´§æ¥ç€å»ºç«‹ SELinux æœºåˆ¶ï¼Œå†æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µã€‚\n\næ¥ä¸‹æ¥ä¼šæ‰§è¡Œåˆ°å“ªäº†å‘¢ï¼Ÿ`init.rc` åˆå§‹åŒ–é…ç½®æ–‡ä»¶çš„å†…å®¹å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ˜¯ä»å“ªé‡ŒåŠ è½½çš„ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿä¸å¾—ä¸è¯´ï¼Œä½œä¸ºæ–°æ‰‹çš„æˆ‘ç¡®å®è¿˜æœ‰å¾ˆå¤šç–‘é—®ï¼Œç›¸ä¿¡åç»­èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ã€‚\n\n\n**å…¶ä»–çŸ¥è¯†**\n\n- Ramdisk: å°†ä¸€å—å†…å­˜å½“ä½œç‰©ç†ç£ç›˜ä½¿ç”¨ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰\n- signalfd: ä¿¡å·æŠ½è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¸€åˆ‡çš†æ–‡ä»¶ï¼‰ï¼Œä¿¡å·å¼‚æ­¥æ“ä½œå°†è½¬æ¢é—® I/O æ“ä½œ\n- Epollï¼šå¤šè·¯å¤ç”¨ã€æ‰¹é‡å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œpoll å‡çº§ç‰ˆ\n- GSIï¼šgeneric system imageï¼ˆç³»ç»Ÿé•œåƒï¼‰\n- opengrokï¼šä¸€ä¸ªå¿«é€Ÿå¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“\n\n**å‚è€ƒé“¾æ¥**\n\n- Linux å†…æ ¸æ–‡æ¡£ï¼šhttps://www.kernel.org/doc/html/\n- Linux æ–‡æ¡£ï¼šhttps://linux.die.net/\n","source":"_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨initè¿›ç¨‹.md","raw":"---\nlayout: android\ncatalog: true\ntitle: Android ç³»ç»Ÿ Init\nsubtitle: æœ¬ç³»åˆ—æ–‡ç« åŸºäº Android 11-r21 master\ndate: 2022-09-29 22:55:05\ntags: AOSP\nheader-img: /img/220928/android_init_bg.png\nsticky: 5\n---\n\n\n# è®¾å¤‡å¯åŠ¨ç®€è¿°\n\n**1ã€BIOS åŠ è½½**\n- åŠ ç”µè‡ªæ£€ï¼ˆåŸºæœ¬è¾“å‡º/è¾“å…¥ç³»ç»Ÿ stdioï¼‰\n    - ç¡¬ä»¶è‡ªæ£€`POST`\n- å¤–éƒ¨å­˜å‚¨è®¾å¤‡`å¯åŠ¨é¡ºåºæ’åº`ï¼Œä¸‹ä¸€ä¸ªè·å¾—æ§åˆ¶æƒçš„è®¾å¤‡\n- è¯»å–æ¿€æ´»åˆ†åŒºç¬¬ä¸€ä¸ªæ‰‡åŒºçš„ `ä¸»å¼•å¯¼è®°å½•`ï¼ˆ512 å­—èŠ‚ï¼‰\n    - è´Ÿè´£åˆ†åŒºè¯»å†™åˆæ³•æ€§åˆ¤æ–­\n    - è´Ÿè´£å¼•å¯¼ä¿¡æ¯å®šä½\n    - æ•°æ®å­˜å‚¨\n        - è°ƒç”¨æ“ä½œç³»ç»Ÿçš„æœºå™¨ç \n        - åˆ†åŒºè¡¨\n            - ä¸»åˆ†åŒºæ˜¯æ¿€æ´»çš„ï¼Œæ¿€æ´»åˆ†åŒºçš„ç¬¬ä¸€ä¸ªæ‰‡åŒºæ˜¯`å·å¼•å¯¼è®°å½•`ï¼ˆå‘Šè¯‰è®¡ç®—æœºæ“ä½œç³»ç»Ÿåœ¨åˆ†åŒºçš„ä½ç½®-ç³»ç»Ÿç›˜åˆ†åŒºï¼‰\n            - å½“åªæœ‰ä¸€ä¸ªç³»ç»Ÿæ—¶å€™ï¼Œæ§åˆ¶æƒå°†äº¤ç»™æŸåˆ†åŒºï¼›å¦åˆ™å°†å¯åŠ¨`å¯åŠ¨ç®¡ç†å™¨`è®©ç”¨æˆ·é€‰æ‹©æ“ä½œç³»ç»Ÿ\n        - ä¸»å¼•å¯¼è®°å½•ç­¾å\n            - æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯ `0x55ã€0xAA` è¡¨ç¤ºå¯å¯åŠ¨è®¾å¤‡\n\n**2ã€kernel åŠ è½½**\n\n- ç¡®å®šæ“ä½œç³»ç»Ÿä¹‹åè·å¾—æ§åˆ¶æƒï¼Œæ¥ç€åŠ è½½å†…æ ¸åˆ°å†…å­˜\n- Linux ç³»ç»Ÿå†…æ ¸ä½äº`boot/kernel`\n- è¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº`sbin/init`\n- è§£æé…ç½®æ–‡ä»¶`etc/initab`åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¿›ç¨‹ `id 1`\n- ä¹‹å init è¿›ç¨‹åˆ†åˆ«åŠ è½½ç³»ç»Ÿå„æ¨¡å—çš„è¿›ç¨‹\n\n\n# Android å¯åŠ¨\nAndroid ä¸å­˜åœ¨ BIOSï¼Œä½†æ˜¯æœ‰ `Bootloader`ï¼ŒAndroid ä¸å­˜åœ¨ç¡¬ç›˜ï¼Œä½†æ˜¯æœ‰`ROM`ï¼ˆç±»ä¼¼ç¡¬ç›˜ï¼Œç”±ä¸åŒåŒºåŸŸåˆ’åˆ†ï¼‰ã€‚\n\n**1ã€Bootloader**\n- åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡\n- å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„ï¼ˆä¸ºç³»ç»Ÿè°ƒç”¨æœåŠ¡ï¼‰\n\n**2ã€ROM**\n- /boot ï¼šå¼•å¯¼ç¨‹åº â€”â€” æ“ä½œå†…æ ¸ã€å†…å­˜çš„ç¨‹åº\n- /system ï¼šç›¸å½“äºç³»ç»Ÿç›˜ â€”â€” æ“ä½œç³»ç»Ÿã€ç³»ç»Ÿç¨‹åº\n- /recovery ï¼š æ¢å¤åˆ†åŒº â€”â€” æ¢å¤æ“ä½œç³»ç»Ÿï¼ˆåˆ·æœºï¼‰\n- /data ï¼š ç”¨æˆ·æ•°æ® â€”â€” å®‰è£…ç¨‹åºã€å¤–éƒ¨æ•°æ®\n- /cache ï¼š ç³»ç»Ÿç¼“å­˜\n- /scared ï¼š ç”¨æˆ·å­˜å‚¨ç©ºé—´ â€”â€” ç›¸å†Œã€éŸ³ä¹\n\n\n**3ã€Bootloader åŠ è½½**\n- åŠ ç”µï¼Œå¼•å¯¼èŠ¯ç‰‡åŠ è½½ ROM é¢„è®¾ä»£ç æ‰§è¡Œ\n- èŠ¯ç‰‡æŸ¥æ‰¾ Bootloader ä»£ç å¹¶åŠ è½½åˆ°å†…å­˜\n- Bootloader å¼€å§‹æ‰§è¡Œï¼ŒæŸ¥æ‰¾æ“ä½œç³»ç»Ÿã€åŠ è½½ Linux å†…æ ¸åˆ°å†…å­˜\n- Linux å†…æ ¸å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–ç¡¬ä»¶ã€åŠ è½½é©±åŠ¨ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€åˆ›å»ºå¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´ `init è¿›ç¨‹`\n\n# Linux å†…æ ¸åŠ è½½\n\n**1ã€idle è¿›ç¨‹ï¼ˆpid = 0ï¼‰**\n- Linux ç³»ç»Ÿç¬¬ä¸€ä¸ªè¿›ç¨‹\n- è¿›ç¨‹åå­—`init_task`ï¼Œé€€åŒ–åçš„`idle`\n- ä¸æ˜¯é€šè¿‡`forkã€kernel_thread`åˆ›å»ºçš„è¿›ç¨‹\n- ä¸»è¦è´Ÿè´£è¿›ç¨‹è°ƒåº¦å·¥ä½œï¼Œè¿›å…¥æ— é™å¾ªç¯\n\n**2ã€init è¿›ç¨‹ï¼ˆpid = 1ï¼‰**\n- ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹\n- å¯åŠ¨å‰éƒ¨åˆ†ï¼šå®Œæˆåˆ›å»ºå’Œå†…æ ¸åˆå§‹åŒ–\n- å¯åŠ¨åéƒ¨åˆ†ï¼šå®Œæˆ Android ç³»ç»Ÿåˆå§‹åŒ–\n- /system/core/init/init.cpp\n\n\n**3ã€kthreadd è¿›ç¨‹ï¼ˆpid = 2ï¼‰**\n- Linux å†…æ ¸ç®¡ç†è€…ï¼Œå†…æ ¸çº¿ç¨‹çš„çˆ¶è¿›ç¨‹\n- ä¸»è¦è´Ÿè´£å†…æ ¸çº¿ç¨‹çš„è°ƒåº¦å’Œç®¡ç†\n- ç”± idle é€šè¿‡`kernel_thead`åˆ›å»º\n\n# Android ç³»ç»Ÿå¯åŠ¨\n\nç›¸å…³æ–‡ä»¶ï¼š\n- /system/core/init/main.cpp\n- /system/core/init/first_state_main.cpp\n- /system/core/init/first_state_init.cpp\n- /system/core/init/main.cpp\n- /system/core/init/selinux.cpp\n- /system/core/init/main.cpp\n- /system/core/init/init.cpp\n- /system/core/init/property_service.cpp\n- /system/core/init/subcontext.h\n- /system/core/init/subcontext.cpp\n- /system/core/init/builtins.cpp\n- /system/core/init/action.cpp\n\n\nç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰å¯åŠ¨æ„å‘³ç€å¼€å§‹ Android ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ï¼Œåˆå§‹åŒ–è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ main å‡½æ•°çš„æ‰§è¡Œï¼Œä¸»è¦è´Ÿè´£å‡†å¤‡å’Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿã€‚\n\n```cpp\n//main.cpp\nint main(int argc, char** argv) {\n    \n    //ç•¥\n\n   if (argc > 1) {\n       if (!strcmp(argv[1], \"subcontext\")) {\n           //å†…æ ¸æ—¥å¿—åˆå§‹åŒ–ï¼Œå†…æ ¸çš„æºç åœ¨å¦å¤–çš„ä»“åº“ï¼Œæš‚æ—¶çœ‹ä¸äº†\n           android::base::InitLogging(argv, &android::base::KernelLogger);\n           //å‡½æ•°æ˜ å°„ï¼Œè°ƒç”¨çš„å¯éƒ½æ˜¯å†…æ ¸å‡½æ•°ã€å‚è€ƒbuiltins.cppã€‘\n           const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n           //4ã€è¿˜æ˜¯è¿›å…¥ subcontext.cppï¼Œå¼€å§‹ä¸Šä¸‹æ–‡\n           return SubcontextMain(argc, argv, &function_map);\n        }\n\n        //2ã€æ‰§è¡Œç¬¬äºŒé˜¶æ®µå‰ï¼Œå»ºç«‹Linuxå®‰å…¨æœºåˆ¶\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            //3ã€åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    //1ã€åˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µ\n    return FirstStageMain(argc, argv);\n}\n```\n\n## åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰\n\nä¸ºæ–‡ä»¶ç³»ç»Ÿå‡†å¤‡å’Œåˆ›å»ºç¯å¢ƒ\n\n```cpp\n//first_state_init.cpp\nint FirstStageMain(int argc, char** argv) {\n    //å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿ\n    CHECKCALL(clearenv());\n    //Linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œsocket ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    //755 æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ chmod 755 è®¿é—®æƒé™ï¼›7/5/5 â€”â€” ç”¨æˆ·/ç”¨æˆ·ç»„/å…¶ä»–ç”¨æˆ·ï¼ˆ421ç»„åˆï¼‰\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    //é‡è¦çš„å¯åŠ¨é…ç½®æ–‡ä»¶ï¼Œæ›´å¤šè¯·å‚è€ƒ https://www.kernel.org/doc/html/\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n        \n    //å¿…ä¸å¯å°‘çš„æ—¥å¿—\n    //ç»è¿‡å‰é¢çš„å‡†å¤‡ã€æ£€éªŒå·¥ä½œï¼Œåˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µåˆå§‹åŒ–å·¥ä½œå°±è¦å¼€å§‹\n    InitKernelLogging(argv);\n    \n    //æ£€æŸ¥è™šæ‹Ÿå†…å­˜æ˜¯å¦é‡Šæ”¾ã€å¦‚æœªå¼€å¯åˆ™éœ€è¦é‡å¯\n    auto old_root_dir = std::unique_ptr<DIR, decltype(&closedir)>{opendir(\"/\"), closedir};\n    //åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå¯èƒ½è¿˜è®°å¾— majorï¼ˆå†…æ ¸ä¸»ç‰ˆæœ¬ï¼‰ã€ minorï¼ˆå†…æ ¸æ¬¡ç‰ˆæœ¬ï¼‰ï¼Œç‰ˆæœ¬ä¿¡æ¯åœ¨åŠ è½½å‰éƒ½ä¼šå»è§£æï¼Œ\n    if (!LoadKernelModules(IsRecoveryMode() \n    && !ForceNormalBoot(cmdline, bootconfig), \n    want_console,want_parallel, module_count)) {\n       //ç•¥\n    }\n    \n    //åœ¨ recovery æ¨¡å¼ä¸‹ä¸å…è®¸åˆ›å»ºè®¾å¤‡å•Š\n    if (!IsRecoveryMode()) {\n        created_devices = DoCreateDevices();\n    }\n    \n    //ä¸ºåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µå‡†å¤‡\n    ///second_stage_resource/system/etc/ramdisk/build.prop\n    std::string dest = GetRamdiskPropForSecondStage();\n    \n    //æ‰§è¡Œç¬¬ä¸€é˜¶æ®µçš„æŒ‚è½½\n    if (!DoFirstStageMount(!created_devices))\n    \n    //ç¥å¥‡çš„ execv å‡½æ•°ï¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ›¿æ¢å½“å‰è¿›ç¨‹æ˜ åƒç»§ç»­æ‰§è¡Œï¼Œç´§æ¥ç€é€šè¿‡ä¼ å…¥çš„ `selinux_setup`å‚æ•°æ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°\n    //æ›´å¤š execv å‚è€ƒï¼šhttps://linux.die.net/man/3/execv\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    execv(path, const_cast<char**>(args));\n    //ç¬¬ä¸€é˜¶æ®µå¤§è‡´åˆ°æ­¤ç»“æŸ\n```\n\nå‡†å¤‡ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜ å°„ã€‚\n\n```cpp\n//builtins.cpp\n//è¿™ä¸ªå†…ç½®å‡½æ•°æ˜ å°„æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\n// æ¯”å¦‚  {\"start\",{1,1,{false,  do_start}}},\n// start å‘½ä»¤å¯¹åº”çš„æ‰§è¡Œçš„å‡½æ•°å°±æ˜¯ buildins.cpp é‡Œé¢å®šä¹‰çš„ do_start å‡½æ•°\nconst BuiltinFunctionMap& GetBuiltinFunctionMap() {\n    constexpr std::size_t kMax = std::numeric_limits<std::size_t>::max();\n    static const BuiltinFunctionMap builtin_functions = {\n        {\"bootchart\",               {1,     1,    {false,  do_bootchart}}},\n        {\"chmod\",                   {2,     2,    {true,   do_chmod}}},\n        {\"chown\",                   {2,     3,    {true,   do_chown}}},\n        {\"class_reset\",             {1,     1,    {false,  do_class_reset}}},\n        {\"class_restart\",           {1,     2,    {false,  do_class_restart}}},\n        {\"class_start\",             {1,     1,    {false,  do_class_start}}},\n        {\"class_stop\",              {1,     1,    {false,  do_class_stop}}},\n        {\"copy\",                    {2,     2,    {true,   do_copy}}},\n        {\"copy_per_line\",           {2,     2,    {true,   do_copy_per_line}}},\n        {\"domainname\",              {1,     1,    {true,   do_domainname}}},\n        {\"enable\",                  {1,     1,    {false,  do_enable}}},\n        {\"exec\",                    {1,     kMax, {false,  do_exec}}},\n        {\"exec_background\",         {1,     kMax, {false,  do_exec_background}}},\n        {\"exec_start\",              {1,     1,    {false,  do_exec_start}}},\n        {\"export\",                  {2,     2,    {false,  do_export}}},\n        {\"hostname\",                {1,     1,    {true,   do_hostname}}},\n        {\"ifup\",                    {1,     1,    {true,   do_ifup}}},\n        {\"init_user0\",              {0,     0,    {false,  do_init_user0}}},\n        {\"insmod\",                  {1,     kMax, {true,   do_insmod}}},\n        {\"installkey\",              {1,     1,    {false,  do_installkey}}},\n        {\"interface_restart\",       {1,     1,    {false,  do_interface_restart}}},\n        {\"interface_start\",         {1,     1,    {false,  do_interface_start}}},\n        {\"interface_stop\",          {1,     1,    {false,  do_interface_stop}}},\n        {\"load_exports\",            {1,     1,    {false,  do_load_exports}}},\n        {\"load_persist_props\",      {0,     0,    {false,  do_load_persist_props}}},\n        {\"load_system_props\",       {0,     0,    {false,  do_load_system_props}}},\n        {\"loglevel\",                {1,     1,    {false,  do_loglevel}}},\n        {\"mark_post_data\",          {0,     0,    {false,  do_mark_post_data}}},\n        {\"mkdir\",                   {1,     6,    {true,   do_mkdir}}},\n        {\"mount_all\",               {0,     kMax, {false,  do_mount_all}}},\n        {\"mount\",                   {3,     kMax, {false,  do_mount}}},\n        {\"perform_apex_config\",     {0,     0,    {false,  do_perform_apex_config}}},\n        {\"umount\",                  {1,     1,    {false,  do_umount}}},\n        {\"umount_all\",              {0,     1,    {false,  do_umount_all}}},\n        {\"update_linker_config\",    {0,     0,    {false,  do_update_linker_config}}},\n        {\"readahead\",               {1,     2,    {true,   do_readahead}}},\n        {\"remount_userdata\",        {0,     0,    {false,  do_remount_userdata}}},\n        {\"restart\",                 {1,     2,    {false,  do_restart}}},\n        {\"restorecon\",              {1,     kMax, {true,   do_restorecon}}},\n        {\"restorecon_recursive\",    {1,     kMax, {true,   do_restorecon_recursive}}},\n        {\"rm\",                      {1,     1,    {true,   do_rm}}},\n        {\"rmdir\",                   {1,     1,    {true,   do_rmdir}}},\n        {\"setprop\",                 {2,     2,    {true,   do_setprop}}},\n        {\"setrlimit\",               {3,     3,    {false,  do_setrlimit}}},\n        {\"start\",                   {1,     1,    {false,  do_start}}},\n        {\"stop\",                    {1,     1,    {false,  do_stop}}},\n        {\"swapon_all\",              {0,     1,    {false,  do_swapon_all}}},\n        {\"enter_default_mount_ns\",  {0,     0,    {false,  do_enter_default_mount_ns}}},\n        {\"symlink\",                 {2,     2,    {true,   do_symlink}}},\n        {\"sysclktz\",                {1,     1,    {false,  do_sysclktz}}},\n        {\"trigger\",                 {1,     1,    {false,  do_trigger}}},\n        {\"verity_update_state\",     {0,     0,    {false,  do_verity_update_state}}},\n        {\"wait\",                    {1,     2,    {true,   do_wait}}},\n        {\"wait_for_prop\",           {2,     2,    {false,  do_wait_for_prop}}},\n        {\"write\",                   {2,     2,    {true,   do_write}}},\n    };\n    return builtin_functions;\n}\n```\n\n## å»ºç«‹ SELinux\n\nç¬¬ä¸€é˜¶æ®µæœ€å execv å‡½æ•°ä¼ å…¥åˆå§‹åŒ–å‚æ•° `selinux_setup`ï¼Œæ‰§è¡Œæµç¨‹å›åˆ° main.cppï¼Œç”± strcmp å‡½æ•°åˆ¤æ–­è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚\n\n```cpp\n//main.cpp\nif (!strcmp(argv[1], \"selinux_setup\")) {\n    return SetupSelinux(argv);\n}\n```\n\n```cpp\n//SetupSelinux.cpp\nint SetupSelinux(char** argv) {\n    //å‡†å¤‡å®‰å…¨ç­–ç•¥ï¼ŒæŸè·¯å¾„ä¸‹çš„ SEPolicy.zip æ–‡ä»¶\n    PrepareApexSepolicy();\n    //è¯»å–å®‰å…¨ç­–ç•¥\n    ReadPolicy(&policy);\n    //åŠ è½½å®‰å…¨ç­–ç•¥\n    LoadSelinuxPolicy(policy);\n    //å¼ºåˆ¶æ‰§è¡Œç­–ç•¥\n    SelinuxSetEnforcement();\n\n    //å…³é”®ä»£ç åˆæ¥äº†ï¼Œè°ƒç”¨ execvï¼Œåˆå§‹åŒ–å‚æ•° second_stageï¼Œå‡†å¤‡æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n}\n```\n\n## åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰\nexecv è°ƒç”¨åˆæ¥äº†ï¼Œæœ¬æ¬¡ä¼ å…¥åˆå§‹åŒ–å‚æ•°æ˜¯ `second_stage`ï¼Œæ‰§è¡Œæµç¨‹å†æ¬¡å›åˆ° main.cppï¼Œç´§æ¥ç€å¼€å§‹ç¬¬äºŒé˜¶æ®µçš„åˆå§‹åŒ–ã€‚\n\n```cpp\n//main.cpp\nif (!strcmp(argv[1], \"second_stage\")) {\n    return SecondStageMain(argc, argv);\n}\n```\n```cpp\n//init.cpp\nint SecondStageMain(int argc, char** argv) {\n    //å¦‚æœè®¾å¤‡è§£é” unlockï¼Œå°†å…è®¸ adb root åŠ è½½è°ƒè¯•ä¿¡æ¯\n    const char* force_debuggable_env = getenv(\"INIT_FORCE_DEBUGGABLE\");\n    bool load_debug_prop = false;\n    if (force_debuggable_env && AvbHandle::IsDeviceUnlocked()) {\n        load_debug_prop = \"true\"s == force_debuggable_env;\n    }\n    \n    //å±æ€§åˆå§‹åŒ–ï¼Œåˆ›å»ºå±æ€§ä¿¡æ¯å¹¶å­˜å‚¨åœ¨ /dev/__properties__/property_info æ–‡ä»¶ä¸­\n    //ä»å…¶ä»–å¤šä¸ªæ–‡ä»¶è¯»å–æ•°æ®ï¼Œæ„é€ æˆ PropertyInf å±æ€§é›†åˆ\n    //è¿˜å¤„ç†äº†å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šè¿™äº›è¢«å¤„ç†çš„ä¿¡æ¯å°†è¢« InitPropertySet(name,value) å‡½æ•°å†™å…¥ property_info æ–‡ä»¶ä¸­\n    //    ProcessKernelDt();\n    //    ProcessKernelCmdline();\n    //    ProcessBootconfig();\n    //    ExportKernelBootProps();//é‡åˆ°äº†é™Œç”Ÿåˆç†Ÿæ‚‰çš„ ro.boot é”®å€¼å¯¹å±æ€§ï¼Œä¾‹å¦‚ \"ro.boot.mode\"\n    \n    //PropertyLoadBootDefaults();//ä¸Šè¿°æ”¶é›†åˆ°çš„å±æ€§ä¿¡æ¯éƒ½å°†è¢«åŠ è½½ï¼Œå¦‚æœæ˜¯æ¢å¤æ¨¡å¼ï¼ˆåˆ·æœºï¼‰IsRecoveryMode()ï¼Œé‚£ä¹ˆä¼šåŠ è½½é»˜è®¤çš„å±æ€§æ–‡ä»¶ /prop.default \n    //GetRamdiskPropForSecondStage(); //ç¬¬äºŒé˜¶æ®µéœ€è¦çš„å±æ€§å»å“ªé‡ŒåŠ è½½ï¼Ÿ/second_stage_resources/system/etc/ramdisk/build.prop\n    PropertyInit();\n    \n    //æŒ‚è½½ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿï¼šapexã€linkerconfig\n    MountExtraFilesystems();\n    \n    //æ³¨å†Œ socket ç›‘å¬\n    Epoll epoll;\n    InstallSignalFdHandler(&epoll);\n    InstallInitNotifier(&epoll);\n\n    //å¯åŠ¨å±æ€§æœåŠ¡ï¼Œé€šè¿‡ socket é€šè®¯\n    StartPropertyService();\n    \n    //oemï¼šåˆ·æœºçš„åŒå­¦å¯èƒ½ä¼šè®°å¾— â€˜å¼€å‘è€…é€‰é¡¹â€™ ä¸­å°±æœ‰ä¸ªé€‰é¡¹æ˜¯ â€˜OEMè§£é”â€™â€”â€”æ˜¯å¦å…è®¸è§£é”å¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ·æœºæ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šæ‰“å¼€æ­¤é€‰é¡¹\n    export_oem_lock_status(); \n    \n    //åŸæ¥ usb å¯¹åº”çš„å±æ€§æ˜¯ sys.usb.controllerï¼Œæ‰€åœ¨æ–‡ä»¶ /sys/class/udc\n    SetUsbController();\n    \n    //å†…æ ¸ç‰ˆæœ¬ ro.kernel.versionï¼ŒåŒ…å«ä¸»ç‰ˆæœ¬ major å’Œæ¬¡ç‰ˆæœ¬ minor\n    SetKernelVersion();\n    \n    //åˆå§‹åŒ– subcontext ä¸€ä¸ªè¿›ç¨‹ã€è¯·è½¬åˆ° subcontext.hã€‘\n    InitializeSubcontext();\n    \n    //åŠ è½½å¯åŠ¨è„šæœ¬\n    //é¦–å…ˆé€šè¿‡ Property åŠ è½½ ro.boot.init_rc å±æ€§å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™åŠ è½½ /system/etc/init/hw/init.rc\n    //actionManager æ·»åŠ ä¸€å †ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ action è¿›å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ\n    //serviceList é€šè¿‡è§£æä¸€äº› /init.rcã€/system/etc/initã€/vendor/etc/init è·å–çš„æœåŠ¡\n    LoadBootScripts(actionManager, serviceList);\n\n    //å‡†å¤‡è¿›å…¥æ— é™å¾ªç¯ï¼Œæ­¤å‰é‡ç½®è¿›ç¨‹ä¼˜å…ˆçº§\n    //prio ä¼˜å…ˆçº§èŒƒå›´ 0ï½139ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜\n    setpriority(PRIO_PROCESS, 0, 0);\n    while (true) {\n        //epoll è´Ÿè´£äº‹ä»¶å¤„ç†ï¼Œé»˜è®¤æƒ…å†µ epoll ä¼šä¼‘çœ ï¼Œç±»ä¼¼é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶åˆ°æ¥ï¼›å…³äº epoll \n        //å¦‚æœæœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç­‰å¾…äº‹ä»¶å°†è¢«ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é©¬ä¸Šå¤„ç†äº‹ä»¶\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{kDiagnosticTimeout};\n        \n        //æ¯æ¬¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å…³æœº\n        auto shutdown_command = shutdown_state.CheckShutdown();\n        \n        //è¿˜ä¼šæ£€æµ‹å¦‚æœè¿›ç¨‹éœ€è¦é‡å¯ï¼Œå°†ç«‹å³å¯åŠ¨\n        auto next_process_action_time = HandleProcessActions();\n    \n        //å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°† fron ç¬¬ä¸€ä¸ªäº‹ä»¶å–å‡ºè¿›è¡Œå¤„ç†ï¼Œé€’å½’è¿›è¡Œï¼ŒåŠ é”åŒæ­¥è¿›è¡Œ\n        HandleControlMessage();\n        //è‡³æ­¤ï¼Œç¬¬äºŒé˜¶æ®µå®Œæ¯•\n    }\n}\n```\n\n```cpp\n//subcontext.h\nclass Subcontext {\n  public:\n    Subcontext(std::vector<std::string> path_prefixes, std::string context, bool host = false)\n        : path_prefixes_(std::move(path_prefixes)), context_(std::move(context)), pid_(0) {\n        if (!host) {\n            //æ„é€ å‡½æ•°ä¸­ç›´æ¥ fork ä¸€ä¸ªè¿›ç¨‹\n            Fork();\n        }\n    }\n}\n\n```\n\n```cpp\n//subcontext.cpp\nvoid Subcontext::Fork() {\n    //åˆ›å»ºä¸€ä¸ªå¯¹åº”ä¸Šä¸‹æ–‡çš„ socket\n    unique_fd subcontext_socket;\n    if (!Socketpair(AF_UNIX, SOCK_SEQPACKET | SOCK_CLOEXEC, 0, &socket_, &subcontext_socket)) {\n        return;\n    }\n    \n#if defined(__ANDROID__)\n    //subcontext çš„åˆå§‹åŒ–éœ€è¦åœ¨æŒ‚è½½ default çš„ç©ºé—´ä¸‹ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® /apex\n    if (auto result = SwitchToMountNamespaceIfNeeded(NS_DEFAULT); !result.ok()) {\n        LOG(FATAL) << \"Could not switch to \\\"default\\\" mount namespace: \" << result.error();\n    }\n#endif\n\n   //è·å–ä¸‹ä¸€é˜¶æ®µåˆå§‹åŒ–çš„æ‰§è¡Œè·¯å¾„ï¼Œè‡³å…³é‡è¦å•Šå…„å¼Ÿä»¬\n   //Android11 æºç çº¦450Gï¼Œç›®å‰ä½¿ç”¨ vscode æœç´¢æŸå…³é”®å­—ï¼Œ\n   //æœç´¢æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæœç´¢å¤ªæ…¢äº†ï¼Œä¼¼ä¹ç´¢å¼•å»ºç«‹å¤ªæ…¢ï¼Ÿæœ‰ä»€ä¹ˆæ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿æ¢ vscode ???  \n   //å·¥å…· â€”â€”â€”â€” https://github.com/oracle/opengrok  Oracle å¼€æºçš„çœŸæ˜¯ç¦åˆ©å¥½ã€‚\n   // \n   //----- å‡è£…æˆ‘æ˜¯åˆ†å‰²çº¿ -----\n   //\n   //é‚£ä¹ˆ GetExecutablePath å®ç°åœ¨å“ªé‡Œï¼Ÿæºç ä¸­æ²¡çœ‹åˆ°å•Š\n   //âš ï¸æ³¨æ„äº†ï¼š\n   // 1ã€è°ƒç”¨ GetExecutablePath() æ‰€åœ¨å‘½åç©ºé—´æ˜¯ using android::base::GetExecutablePath;\n   // 2ã€çœ‹çœ‹å¼•å…¥çš„å¤´æ–‡ä»¶ #include <android-base/properties.h>ï¼Œæ³¨æ„å’¯ï¼Œæ˜¯å°–æ‹¬å·<>å¼•å…¥æ–¹å¼ï¼Œè€Œä¸æ˜¯åŒå¼•å·â€œâ€æœ¬åœ°å¼•å…¥ï¼Œè¯´æ˜æœ¬åœ°é¡¹ç›®ä¸‹æ ¹æœ¬æ‰¾ä¸åˆ°ï¼Œæ˜¯é€šè¿‡ç³»ç»Ÿè¿æ¥è¿›æ¥çš„ã€‚\n   // 3ã€æŸ¥é˜…å®˜ç½‘ï¼Œå‘ç°æ–‡ä»¶å®ç°åœ¨å†…æ ¸ä»“åº“æœ‰ä¸€ä»½å¯æŸ¥é˜…ã€‚https://source.android.google.cn/devices/tech/config/kernel?hl=zh-cn\n   auto init_path = GetExecutablePath();\n   auto child_fd_string = std::to_string(child_fd);\n   //ç»ˆäºåˆç­‰åˆ°äº† execv å‡½æ•°ï¼Œæ³¨æ„ä¼ å‚ subcontextï¼Œæ˜¯ä¸æ˜¯åˆå›åˆ°äº† main.cppã€æˆ–è®¸ä½ å¯¹ main.cpp å·²æ²¡æœ‰äº†å°è±¡ï¼Œæ¯•ç«Ÿå­¦ä¹ å°±æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œåå¤çš„ã€åå¤çš„ã€åå¤çš„å°è±¡ä¹Ÿå°±æ·±åˆ»äº†ã€‘\n   const char* args[] = {init_path.c_str(), \"subcontext\", context_.c_str(),child_fd_string.c_str(), nullptr};\n   execv(init_path.data(), const_cast<char**>(args));\n}\n```\n\n```cpp\n//main.cpp\n//æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œåœ°çƒæ˜¯åœ†çš„ï¼Œä½ åœ¨æ­¤å¤„é™å€™ï¼Œæˆ‘ä¸€ç›´å¾€åŒ—èµ°ï¼Œæœ€åè¿˜èƒ½ç›¸é‡ä¸æ˜¯å—ï¼Ÿ\nif (!strcmp(argv[1], \"subcontext\")) {\n    android::base::InitLogging(argv, &android::base::KernelLogger); \n    const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n    return SubcontextMain(argc, argv, &function_map);\n}\n```\n\n\n```cpp\n//subcontext.cpp\nint SubcontextMain(int argc, char** argv, const BuiltinFunctionMap* function_map) {\n    \n    //ä¸»è¦è¿˜æ˜¯å¹²ä¸¤ä»¶äº‹ï¼Œåˆ›å»ºä¸Šä¸‹æ–‡è¿›ç¨‹ã€å¹¶è¿›å…¥æ— é™å¾ªç¯\n    auto subcontext_process = SubcontextProcess(function_map, context, init_fd);\n    // Restore prio before main loop\n    setpriority(PRIO_PROCESS, 0, 0);\n    subcontext_process.MainLoop();\n}\n```\n\n```cpp\n//subcontext.cpp\nclass SubcontextProcess {\n  public:\n    SubcontextProcess(const BuiltinFunctionMap* function_map, std::string context, int init_fd)\n        : function_map_(function_map), context_(std::move(context)), init_fd_(init_fd){};\n    void MainLoop();\n}\n\nvoid SubcontextProcess::MainLoop() {\n    pollfd ufd[1];\n    ufd[0].events = POLLIN;\n    ufd[0].fd = init_fd_;\n    \n    //è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†å¾ªç¯äº‹ä»¶çš„è¿˜æ˜¯ poll å…·æŸ„ï¼Œä½¿ç”¨ socket é€šè®¯\n    while (true) {\n        //å¤„ç†çš„æ¶ˆæ¯ç±»å‹æœ‰ä¸¤ç§ï¼šæ‰§è¡Œå‹ã€æ•°æ®è§£æå‹\n        auto subcontext_command = SubcontextCommand();\n        auto reply = SubcontextReply();\n        switch (subcontext_command.command_case()) {\n            case SubcontextCommand::kExecuteCommand: {\n                RunCommand(subcontext_command.execute_command(), &reply);\n                break;\n            }\n            case SubcontextCommand::kExpandArgsCommand: {\n                ExpandArgs(subcontext_command.expand_args_command(), &reply);\n                break;\n            }\n            default:\n                LOG(FATAL) << \"Unknown message type from init: \"\n                           << subcontext_command.command_case();\n        }\n        \n        //å¾ªç¯ä¸­å¹²çš„äº‹å°±æ˜¯ä¸æ–­åˆ†å‘æ¶ˆæ¯ï¼Œåˆ°æ­¤ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ–èŠ‚æœ¬ç»“æŸ\n        //ï¼Ÿï¼Ÿï¼Ÿå‘µï¼Œä¸€è„¸æ‡µé€¼å§ï¼Œæ¶ˆæ¯å‘å‡ºå»ä¹‹åå‘¢ï¼Ÿä¹‹ååˆå»æ‰§è¡Œå“ªé‡Œäº†ğŸ¤”ï¸\n        if (auto result = SendMessage(init_fd_, reply); !result.ok()) {\n            LOG(FATAL) << \"Failed to send message to init: \" << result.error();\n        } \n    }\n}\n```\n\n# æœ€å\nAndroid ç³»ç»Ÿå¯åŠ¨ç”± Linux åˆ›å»º init è¿›ç¨‹ï¼Œinit è¿›ç¨‹é€šè¿‡è§£æ `init.rc` ç­‰å‡ ä¸ªåˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è§£ææ•°æ®ç»§ç»­åˆ›å»ºã€å¯åŠ¨å…¶ä»–çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œç´§æ¥ç€å»ºç«‹ SELinux æœºåˆ¶ï¼Œå†æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µã€‚\n\næ¥ä¸‹æ¥ä¼šæ‰§è¡Œåˆ°å“ªäº†å‘¢ï¼Ÿ`init.rc` åˆå§‹åŒ–é…ç½®æ–‡ä»¶çš„å†…å®¹å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ˜¯ä»å“ªé‡ŒåŠ è½½çš„ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿä¸å¾—ä¸è¯´ï¼Œä½œä¸ºæ–°æ‰‹çš„æˆ‘ç¡®å®è¿˜æœ‰å¾ˆå¤šç–‘é—®ï¼Œç›¸ä¿¡åç»­èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ã€‚\n\n\n**å…¶ä»–çŸ¥è¯†**\n\n- Ramdisk: å°†ä¸€å—å†…å­˜å½“ä½œç‰©ç†ç£ç›˜ä½¿ç”¨ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰\n- signalfd: ä¿¡å·æŠ½è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¸€åˆ‡çš†æ–‡ä»¶ï¼‰ï¼Œä¿¡å·å¼‚æ­¥æ“ä½œå°†è½¬æ¢é—® I/O æ“ä½œ\n- Epollï¼šå¤šè·¯å¤ç”¨ã€æ‰¹é‡å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œpoll å‡çº§ç‰ˆ\n- GSIï¼šgeneric system imageï¼ˆç³»ç»Ÿé•œåƒï¼‰\n- opengrokï¼šä¸€ä¸ªå¿«é€Ÿå¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“\n\n**å‚è€ƒé“¾æ¥**\n\n- Linux å†…æ ¸æ–‡æ¡£ï¼šhttps://www.kernel.org/doc/html/\n- Linux æ–‡æ¡£ï¼šhttps://linux.die.net/\n","slug":"Androidç³»ç»Ÿå¯åŠ¨initè¿›ç¨‹","published":1,"lang":"undefined","updated":"2022-09-29T14:55:05.000Z","comments":1,"photos":[],"link":"","_id":"cl99ignsn0008gaqp74h4b86f","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>è®¾å¤‡å¯åŠ¨ç®€è¿°</h1>\n<p><strong>1ã€BIOS åŠ è½½</strong></p>\n<ul>\n<li>åŠ ç”µè‡ªæ£€ï¼ˆåŸºæœ¬è¾“å‡º/è¾“å…¥ç³»ç»Ÿ stdioï¼‰\n<ul>\n<li>ç¡¬ä»¶è‡ªæ£€<code>POST</code></li>\n</ul>\n</li>\n<li>å¤–éƒ¨å­˜å‚¨è®¾å¤‡<code>å¯åŠ¨é¡ºåºæ’åº</code>ï¼Œä¸‹ä¸€ä¸ªè·å¾—æ§åˆ¶æƒçš„è®¾å¤‡</li>\n<li>è¯»å–æ¿€æ´»åˆ†åŒºç¬¬ä¸€ä¸ªæ‰‡åŒºçš„ <code>ä¸»å¼•å¯¼è®°å½•</code>ï¼ˆ512 å­—èŠ‚ï¼‰\n<ul>\n<li>è´Ÿè´£åˆ†åŒºè¯»å†™åˆæ³•æ€§åˆ¤æ–­</li>\n<li>è´Ÿè´£å¼•å¯¼ä¿¡æ¯å®šä½</li>\n<li>æ•°æ®å­˜å‚¨\n<ul>\n<li>è°ƒç”¨æ“ä½œç³»ç»Ÿçš„æœºå™¨ç </li>\n<li>åˆ†åŒºè¡¨\n<ul>\n<li>ä¸»åˆ†åŒºæ˜¯æ¿€æ´»çš„ï¼Œæ¿€æ´»åˆ†åŒºçš„ç¬¬ä¸€ä¸ªæ‰‡åŒºæ˜¯<code>å·å¼•å¯¼è®°å½•</code>ï¼ˆå‘Šè¯‰è®¡ç®—æœºæ“ä½œç³»ç»Ÿåœ¨åˆ†åŒºçš„ä½ç½®-ç³»ç»Ÿç›˜åˆ†åŒºï¼‰</li>\n<li>å½“åªæœ‰ä¸€ä¸ªç³»ç»Ÿæ—¶å€™ï¼Œæ§åˆ¶æƒå°†äº¤ç»™æŸåˆ†åŒºï¼›å¦åˆ™å°†å¯åŠ¨<code>å¯åŠ¨ç®¡ç†å™¨</code>è®©ç”¨æˆ·é€‰æ‹©æ“ä½œç³»ç»Ÿ</li>\n</ul>\n</li>\n<li>ä¸»å¼•å¯¼è®°å½•ç­¾å\n<ul>\n<li>æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯ <code>0x55ã€0xAA</code> è¡¨ç¤ºå¯å¯åŠ¨è®¾å¤‡</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>2ã€kernel åŠ è½½</strong></p>\n<ul>\n<li>ç¡®å®šæ“ä½œç³»ç»Ÿä¹‹åè·å¾—æ§åˆ¶æƒï¼Œæ¥ç€åŠ è½½å†…æ ¸åˆ°å†…å­˜</li>\n<li>Linux ç³»ç»Ÿå†…æ ¸ä½äº<code>boot/kernel</code></li>\n<li>è¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº<code>sbin/init</code></li>\n<li>è§£æé…ç½®æ–‡ä»¶<code>etc/initab</code>åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¿›ç¨‹ <code>id 1</code></li>\n<li>ä¹‹å init è¿›ç¨‹åˆ†åˆ«åŠ è½½ç³»ç»Ÿå„æ¨¡å—çš„è¿›ç¨‹</li>\n</ul>\n<h1>Android å¯åŠ¨</h1>\n<p>Android ä¸å­˜åœ¨ BIOSï¼Œä½†æ˜¯æœ‰ <code>Bootloader</code>ï¼ŒAndroid ä¸å­˜åœ¨ç¡¬ç›˜ï¼Œä½†æ˜¯æœ‰<code>ROM</code>ï¼ˆç±»ä¼¼ç¡¬ç›˜ï¼Œç”±ä¸åŒåŒºåŸŸåˆ’åˆ†ï¼‰ã€‚</p>\n<p><strong>1ã€Bootloader</strong></p>\n<ul>\n<li>åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡</li>\n<li>å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„ï¼ˆä¸ºç³»ç»Ÿè°ƒç”¨æœåŠ¡ï¼‰</li>\n</ul>\n<p><strong>2ã€ROM</strong></p>\n<ul>\n<li>/boot ï¼šå¼•å¯¼ç¨‹åº â€”â€” æ“ä½œå†…æ ¸ã€å†…å­˜çš„ç¨‹åº</li>\n<li>/system ï¼šç›¸å½“äºç³»ç»Ÿç›˜ â€”â€” æ“ä½œç³»ç»Ÿã€ç³»ç»Ÿç¨‹åº</li>\n<li>/recovery ï¼š æ¢å¤åˆ†åŒº â€”â€” æ¢å¤æ“ä½œç³»ç»Ÿï¼ˆåˆ·æœºï¼‰</li>\n<li>/data ï¼š ç”¨æˆ·æ•°æ® â€”â€” å®‰è£…ç¨‹åºã€å¤–éƒ¨æ•°æ®</li>\n<li>/cache ï¼š ç³»ç»Ÿç¼“å­˜</li>\n<li>/scared ï¼š ç”¨æˆ·å­˜å‚¨ç©ºé—´ â€”â€” ç›¸å†Œã€éŸ³ä¹</li>\n</ul>\n<p><strong>3ã€Bootloader åŠ è½½</strong></p>\n<ul>\n<li>åŠ ç”µï¼Œå¼•å¯¼èŠ¯ç‰‡åŠ è½½ ROM é¢„è®¾ä»£ç æ‰§è¡Œ</li>\n<li>èŠ¯ç‰‡æŸ¥æ‰¾ Bootloader ä»£ç å¹¶åŠ è½½åˆ°å†…å­˜</li>\n<li>Bootloader å¼€å§‹æ‰§è¡Œï¼ŒæŸ¥æ‰¾æ“ä½œç³»ç»Ÿã€åŠ è½½ Linux å†…æ ¸åˆ°å†…å­˜</li>\n<li>Linux å†…æ ¸å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–ç¡¬ä»¶ã€åŠ è½½é©±åŠ¨ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€åˆ›å»ºå¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´ <code>init è¿›ç¨‹</code></li>\n</ul>\n<h1>Linux å†…æ ¸åŠ è½½</h1>\n<p><strong>1ã€idle è¿›ç¨‹ï¼ˆpid = 0ï¼‰</strong></p>\n<ul>\n<li>Linux ç³»ç»Ÿç¬¬ä¸€ä¸ªè¿›ç¨‹</li>\n<li>è¿›ç¨‹åå­—<code>init_task</code>ï¼Œé€€åŒ–åçš„<code>idle</code></li>\n<li>ä¸æ˜¯é€šè¿‡<code>forkã€kernel_thread</code>åˆ›å»ºçš„è¿›ç¨‹</li>\n<li>ä¸»è¦è´Ÿè´£è¿›ç¨‹è°ƒåº¦å·¥ä½œï¼Œè¿›å…¥æ— é™å¾ªç¯</li>\n</ul>\n<p><strong>2ã€init è¿›ç¨‹ï¼ˆpid = 1ï¼‰</strong></p>\n<ul>\n<li>ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹</li>\n<li>å¯åŠ¨å‰éƒ¨åˆ†ï¼šå®Œæˆåˆ›å»ºå’Œå†…æ ¸åˆå§‹åŒ–</li>\n<li>å¯åŠ¨åéƒ¨åˆ†ï¼šå®Œæˆ Android ç³»ç»Ÿåˆå§‹åŒ–</li>\n<li>/system/core/init/init.cpp</li>\n</ul>\n<p><strong>3ã€kthreadd è¿›ç¨‹ï¼ˆpid = 2ï¼‰</strong></p>\n<ul>\n<li>Linux å†…æ ¸ç®¡ç†è€…ï¼Œå†…æ ¸çº¿ç¨‹çš„çˆ¶è¿›ç¨‹</li>\n<li>ä¸»è¦è´Ÿè´£å†…æ ¸çº¿ç¨‹çš„è°ƒåº¦å’Œç®¡ç†</li>\n<li>ç”± idle é€šè¿‡<code>kernel_thead</code>åˆ›å»º</li>\n</ul>\n<h1>Android ç³»ç»Ÿå¯åŠ¨</h1>\n<p>ç›¸å…³æ–‡ä»¶ï¼š</p>\n<ul>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/first_state_main.cpp</li>\n<li>/system/core/init/first_state_init.cpp</li>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/selinux.cpp</li>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/init.cpp</li>\n<li>/system/core/init/property_service.cpp</li>\n<li>/system/core/init/subcontext.h</li>\n<li>/system/core/init/subcontext.cpp</li>\n<li>/system/core/init/builtins.cpp</li>\n<li>/system/core/init/action.cpp</li>\n</ul>\n<p>ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰å¯åŠ¨æ„å‘³ç€å¼€å§‹ Android ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ï¼Œåˆå§‹åŒ–è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ main å‡½æ•°çš„æ‰§è¡Œï¼Œä¸»è¦è´Ÿè´£å‡†å¤‡å’Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç•¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">           <span class=\"comment\">//å†…æ ¸æ—¥å¿—åˆå§‹åŒ–ï¼Œå†…æ ¸çš„æºç åœ¨å¦å¤–çš„ä»“åº“ï¼Œæš‚æ—¶çœ‹ä¸äº†</span></span><br><span class=\"line\">           android::base::<span class=\"built_in\">InitLogging</span>(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">           <span class=\"comment\">//å‡½æ•°æ˜ å°„ï¼Œè°ƒç”¨çš„å¯éƒ½æ˜¯å†…æ ¸å‡½æ•°ã€å‚è€ƒbuiltins.cppã€‘</span></span><br><span class=\"line\">           <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = <span class=\"built_in\">GetBuiltinFunctionMap</span>();</span><br><span class=\"line\">           <span class=\"comment\">//4ã€è¿˜æ˜¯è¿›å…¥ subcontext.cppï¼Œå¼€å§‹ä¸Šä¸‹æ–‡</span></span><br><span class=\"line\">           <span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//2ã€æ‰§è¡Œç¬¬äºŒé˜¶æ®µå‰ï¼Œå»ºç«‹Linuxå®‰å…¨æœºåˆ¶</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SetupSelinux</span>(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//3ã€åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SecondStageMain</span>(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//1ã€åˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µ</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">FirstStageMain</span>(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰\">åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰</h2>\n<p>ä¸ºæ–‡ä»¶ç³»ç»Ÿå‡†å¤‡å’Œåˆ›å»ºç¯å¢ƒ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//first_state_init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">clearenv</span>());</span><br><span class=\"line\">    <span class=\"comment\">//Linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œsocket ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">mkdir</span>(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">//755 æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ chmod 755 è®¿é—®æƒé™ï¼›7/5/5 â€”â€” ç”¨æˆ·/ç”¨æˆ·ç»„/å…¶ä»–ç”¨æˆ·ï¼ˆ421ç»„åˆï¼‰</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">chmod</span>(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"comment\">//é‡è¦çš„å¯åŠ¨é…ç½®æ–‡ä»¶ï¼Œæ›´å¤šè¯·å‚è€ƒ https://www.kernel.org/doc/html/</span></span><br><span class=\"line\">    android::base::<span class=\"built_in\">ReadFileToString</span>(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//å¿…ä¸å¯å°‘çš„æ—¥å¿—</span></span><br><span class=\"line\">    <span class=\"comment\">//ç»è¿‡å‰é¢çš„å‡†å¤‡ã€æ£€éªŒå·¥ä½œï¼Œåˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µåˆå§‹åŒ–å·¥ä½œå°±è¦å¼€å§‹</span></span><br><span class=\"line\">    <span class=\"built_in\">InitKernelLogging</span>(argv);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ£€æŸ¥è™šæ‹Ÿå†…å­˜æ˜¯å¦é‡Šæ”¾ã€å¦‚æœªå¼€å¯åˆ™éœ€è¦é‡å¯</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> old_root_dir = std::unique_ptr&lt;DIR, <span class=\"keyword\">decltype</span>(&amp;closedir)&gt;&#123;<span class=\"built_in\">opendir</span>(<span class=\"string\">&quot;/&quot;</span>), closedir&#125;;</span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå¯èƒ½è¿˜è®°å¾— majorï¼ˆå†…æ ¸ä¸»ç‰ˆæœ¬ï¼‰ã€ minorï¼ˆå†…æ ¸æ¬¡ç‰ˆæœ¬ï¼‰ï¼Œç‰ˆæœ¬ä¿¡æ¯åœ¨åŠ è½½å‰éƒ½ä¼šå»è§£æï¼Œ</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">LoadKernelModules</span>(<span class=\"built_in\">IsRecoveryMode</span>() </span><br><span class=\"line\">    &amp;&amp; !<span class=\"built_in\">ForceNormalBoot</span>(cmdline, bootconfig), </span><br><span class=\"line\">    want_console,want_parallel, module_count)) &#123;</span><br><span class=\"line\">       <span class=\"comment\">//ç•¥</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åœ¨ recovery æ¨¡å¼ä¸‹ä¸å…è®¸åˆ›å»ºè®¾å¤‡å•Š</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsRecoveryMode</span>()) &#123;</span><br><span class=\"line\">        created_devices = <span class=\"built_in\">DoCreateDevices</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸ºåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µå‡†å¤‡</span></span><br><span class=\"line\">    <span class=\"comment\">///second_stage_resource/system/etc/ramdisk/build.prop</span></span><br><span class=\"line\">    std::string dest = <span class=\"built_in\">GetRamdiskPropForSecondStage</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ‰§è¡Œç¬¬ä¸€é˜¶æ®µçš„æŒ‚è½½</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">DoFirstStageMount</span>(!created_devices))</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç¥å¥‡çš„ execv å‡½æ•°ï¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ›¿æ¢å½“å‰è¿›ç¨‹æ˜ åƒç»§ç»­æ‰§è¡Œï¼Œç´§æ¥ç€é€šè¿‡ä¼ å…¥çš„ `selinux_setup`å‚æ•°æ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°</span></span><br><span class=\"line\">    <span class=\"comment\">//æ›´å¤š execv å‚è€ƒï¼šhttps://linux.die.net/man/3/execv</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"built_in\">execv</span>(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">    <span class=\"comment\">//ç¬¬ä¸€é˜¶æ®µå¤§è‡´åˆ°æ­¤ç»“æŸ</span></span><br></pre></td></tr></table></figure>\n<p>å‡†å¤‡ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜ å°„ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//builtins.cpp</span></span><br><span class=\"line\"><span class=\"comment\">//è¿™ä¸ªå†…ç½®å‡½æ•°æ˜ å°„æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">// æ¯”å¦‚  &#123;&quot;start&quot;,&#123;1,1,&#123;false,  do_start&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">// start å‘½ä»¤å¯¹åº”çš„æ‰§è¡Œçš„å‡½æ•°å°±æ˜¯ buildins.cpp é‡Œé¢å®šä¹‰çš„ do_start å‡½æ•°</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span> BuiltinFunctionMap&amp; <span class=\"title\">GetBuiltinFunctionMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">constexpr</span> std::<span class=\"keyword\">size_t</span> kMax = std::numeric_limits&lt;std::<span class=\"keyword\">size_t</span>&gt;::<span class=\"built_in\">max</span>();</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">const</span> BuiltinFunctionMap builtin_functions = &#123;</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;bootchart&quot;</span>,               &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_bootchart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;chmod&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_chmod&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;chown&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">3</span>,    &#123;<span class=\"literal\">true</span>,   do_chown&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_reset&quot;</span>,             &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_reset&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_restart&quot;</span>,           &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_class_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_start&quot;</span>,             &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_stop&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;copy&quot;</span>,                    &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_copy&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;copy_per_line&quot;</span>,           &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_copy_per_line&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;domainname&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_domainname&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;enable&quot;</span>,                  &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_enable&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec&quot;</span>,                    &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_exec&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec_background&quot;</span>,         &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_exec_background&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec_start&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_exec_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;export&quot;</span>,                  &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_export&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;hostname&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_hostname&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;ifup&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_ifup&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;init_user0&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_init_user0&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;insmod&quot;</span>,                  &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_insmod&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;installkey&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_installkey&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_restart&quot;</span>,       &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_start&quot;</span>,         &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_stop&quot;</span>,          &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_exports&quot;</span>,            &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_load_exports&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_persist_props&quot;</span>,      &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_load_persist_props&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_system_props&quot;</span>,       &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_load_system_props&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;loglevel&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_loglevel&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mark_post_data&quot;</span>,          &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_mark_post_data&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mkdir&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">6</span>,    &#123;<span class=\"literal\">true</span>,   do_mkdir&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mount_all&quot;</span>,               &#123;<span class=\"number\">0</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_mount_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mount&quot;</span>,                   &#123;<span class=\"number\">3</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_mount&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;perform_apex_config&quot;</span>,     &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_perform_apex_config&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;umount&quot;</span>,                  &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_umount&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;umount_all&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_umount_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;update_linker_config&quot;</span>,    &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_update_linker_config&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;readahead&quot;</span>,               &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_readahead&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;remount_userdata&quot;</span>,        &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_remount_userdata&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restart&quot;</span>,                 &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restorecon&quot;</span>,              &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_restorecon&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restorecon_recursive&quot;</span>,    &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_restorecon_recursive&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;rm&quot;</span>,                      &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_rm&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;rmdir&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_rmdir&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;setprop&quot;</span>,                 &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_setprop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;setrlimit&quot;</span>,               &#123;<span class=\"number\">3</span>,     <span class=\"number\">3</span>,    &#123;<span class=\"literal\">false</span>,  do_setrlimit&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;start&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;stop&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;swapon_all&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_swapon_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;enter_default_mount_ns&quot;</span>,  &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_enter_default_mount_ns&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;symlink&quot;</span>,                 &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_symlink&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;sysclktz&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_sysclktz&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;trigger&quot;</span>,                 &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_trigger&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;verity_update_state&quot;</span>,     &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_verity_update_state&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;wait&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_wait&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;wait_for_prop&quot;</span>,           &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_wait_for_prop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;write&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_write&#125;&#125;&#125;,</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> builtin_functions;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"å»ºç«‹-SELinux\">å»ºç«‹ SELinux</h2>\n<p>ç¬¬ä¸€é˜¶æ®µæœ€å execv å‡½æ•°ä¼ å…¥åˆå§‹åŒ–å‚æ•° <code>selinux_setup</code>ï¼Œæ‰§è¡Œæµç¨‹å›åˆ° main.cppï¼Œç”± strcmp å‡½æ•°åˆ¤æ–­è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SetupSelinux</span>(argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SetupSelinux.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡å®‰å…¨ç­–ç•¥ï¼ŒæŸè·¯å¾„ä¸‹çš„ SEPolicy.zip æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"built_in\">PrepareApexSepolicy</span>();</span><br><span class=\"line\">    <span class=\"comment\">//è¯»å–å®‰å…¨ç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">ReadPolicy</span>(&amp;policy);</span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å®‰å…¨ç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">LoadSelinuxPolicy</span>(policy);</span><br><span class=\"line\">    <span class=\"comment\">//å¼ºåˆ¶æ‰§è¡Œç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">SelinuxSetEnforcement</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…³é”®ä»£ç åˆæ¥äº†ï¼Œè°ƒç”¨ execvï¼Œåˆå§‹åŒ–å‚æ•° second_stageï¼Œå‡†å¤‡æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"built_in\">execv</span>(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰\">åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰</h2>\n<p>execv è°ƒç”¨åˆæ¥äº†ï¼Œæœ¬æ¬¡ä¼ å…¥åˆå§‹åŒ–å‚æ•°æ˜¯ <code>second_stage</code>ï¼Œæ‰§è¡Œæµç¨‹å†æ¬¡å›åˆ° main.cppï¼Œç´§æ¥ç€å¼€å§‹ç¬¬äºŒé˜¶æ®µçš„åˆå§‹åŒ–ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SecondStageMain</span>(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœè®¾å¤‡è§£é” unlockï¼Œå°†å…è®¸ adb root åŠ è½½è°ƒè¯•ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* force_debuggable_env = <span class=\"built_in\">getenv</span>(<span class=\"string\">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">bool</span> load_debug_prop = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (force_debuggable_env &amp;&amp; AvbHandle::<span class=\"built_in\">IsDeviceUnlocked</span>()) &#123;</span><br><span class=\"line\">        load_debug_prop = <span class=\"string\">&quot;true&quot;</span>s == force_debuggable_env;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å±æ€§åˆå§‹åŒ–ï¼Œåˆ›å»ºå±æ€§ä¿¡æ¯å¹¶å­˜å‚¨åœ¨ /dev/__properties__/property_info æ–‡ä»¶ä¸­</span></span><br><span class=\"line\">    <span class=\"comment\">//ä»å…¶ä»–å¤šä¸ªæ–‡ä»¶è¯»å–æ•°æ®ï¼Œæ„é€ æˆ PropertyInf å±æ€§é›†åˆ</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜å¤„ç†äº†å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šè¿™äº›è¢«å¤„ç†çš„ä¿¡æ¯å°†è¢« InitPropertySet(name,value) å‡½æ•°å†™å…¥ property_info æ–‡ä»¶ä¸­</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessKernelDt();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessKernelCmdline();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessBootconfig();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ExportKernelBootProps();//é‡åˆ°äº†é™Œç”Ÿåˆç†Ÿæ‚‰çš„ ro.boot é”®å€¼å¯¹å±æ€§ï¼Œä¾‹å¦‚ &quot;ro.boot.mode&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//PropertyLoadBootDefaults();//ä¸Šè¿°æ”¶é›†åˆ°çš„å±æ€§ä¿¡æ¯éƒ½å°†è¢«åŠ è½½ï¼Œå¦‚æœæ˜¯æ¢å¤æ¨¡å¼ï¼ˆåˆ·æœºï¼‰IsRecoveryMode()ï¼Œé‚£ä¹ˆä¼šåŠ è½½é»˜è®¤çš„å±æ€§æ–‡ä»¶ /prop.default </span></span><br><span class=\"line\">    <span class=\"comment\">//GetRamdiskPropForSecondStage(); //ç¬¬äºŒé˜¶æ®µéœ€è¦çš„å±æ€§å»å“ªé‡ŒåŠ è½½ï¼Ÿ/second_stage_resources/system/etc/ramdisk/build.prop</span></span><br><span class=\"line\">    <span class=\"built_in\">PropertyInit</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æŒ‚è½½ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿï¼šapexã€linkerconfig</span></span><br><span class=\"line\">    <span class=\"built_in\">MountExtraFilesystems</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ³¨å†Œ socket ç›‘å¬</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"built_in\">InstallSignalFdHandler</span>(&amp;epoll);</span><br><span class=\"line\">    <span class=\"built_in\">InstallInitNotifier</span>(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å±æ€§æœåŠ¡ï¼Œé€šè¿‡ socket é€šè®¯</span></span><br><span class=\"line\">    <span class=\"built_in\">StartPropertyService</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//oemï¼šåˆ·æœºçš„åŒå­¦å¯èƒ½ä¼šè®°å¾— â€˜å¼€å‘è€…é€‰é¡¹â€™ ä¸­å°±æœ‰ä¸ªé€‰é¡¹æ˜¯ â€˜OEMè§£é”â€™â€”â€”æ˜¯å¦å…è®¸è§£é”å¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ·æœºæ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šæ‰“å¼€æ­¤é€‰é¡¹</span></span><br><span class=\"line\">    <span class=\"built_in\">export_oem_lock_status</span>(); </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åŸæ¥ usb å¯¹åº”çš„å±æ€§æ˜¯ sys.usb.controllerï¼Œæ‰€åœ¨æ–‡ä»¶ /sys/class/udc</span></span><br><span class=\"line\">    <span class=\"built_in\">SetUsbController</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å†…æ ¸ç‰ˆæœ¬ ro.kernel.versionï¼ŒåŒ…å«ä¸»ç‰ˆæœ¬ major å’Œæ¬¡ç‰ˆæœ¬ minor</span></span><br><span class=\"line\">    <span class=\"built_in\">SetKernelVersion</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆå§‹åŒ– subcontext ä¸€ä¸ªè¿›ç¨‹ã€è¯·è½¬åˆ° subcontext.hã€‘</span></span><br><span class=\"line\">    <span class=\"built_in\">InitializeSubcontext</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å¯åŠ¨è„šæœ¬</span></span><br><span class=\"line\">    <span class=\"comment\">//é¦–å…ˆé€šè¿‡ Property åŠ è½½ ro.boot.init_rc å±æ€§å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™åŠ è½½ /system/etc/init/hw/init.rc</span></span><br><span class=\"line\">    <span class=\"comment\">//actionManager æ·»åŠ ä¸€å †ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ action è¿›å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ</span></span><br><span class=\"line\">    <span class=\"comment\">//serviceList é€šè¿‡è§£æä¸€äº› /init.rcã€/system/etc/initã€/vendor/etc/init è·å–çš„æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"built_in\">LoadBootScripts</span>(actionManager, serviceList);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡è¿›å…¥æ— é™å¾ªç¯ï¼Œæ­¤å‰é‡ç½®è¿›ç¨‹ä¼˜å…ˆçº§</span></span><br><span class=\"line\">    <span class=\"comment\">//prio ä¼˜å…ˆçº§èŒƒå›´ 0ï½139ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class=\"line\">    <span class=\"built_in\">setpriority</span>(PRIO_PROCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//epoll è´Ÿè´£äº‹ä»¶å¤„ç†ï¼Œé»˜è®¤æƒ…å†µ epoll ä¼šä¼‘çœ ï¼Œç±»ä¼¼é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶åˆ°æ¥ï¼›å…³äº epoll </span></span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœæœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç­‰å¾…äº‹ä»¶å°†è¢«ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é©¬ä¸Šå¤„ç†äº‹ä»¶</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = std::optional&lt;std::chrono::milliseconds&gt;&#123;kDiagnosticTimeout&#125;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//æ¯æ¬¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å…³æœº</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> shutdown_command = shutdown_state.<span class=\"built_in\">CheckShutdown</span>();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è¿˜ä¼šæ£€æµ‹å¦‚æœè¿›ç¨‹éœ€è¦é‡å¯ï¼Œå°†ç«‹å³å¯åŠ¨</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> next_process_action_time = <span class=\"built_in\">HandleProcessActions</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°† fron ç¬¬ä¸€ä¸ªäº‹ä»¶å–å‡ºè¿›è¡Œå¤„ç†ï¼Œé€’å½’è¿›è¡Œï¼ŒåŠ é”åŒæ­¥è¿›è¡Œ</span></span><br><span class=\"line\">        <span class=\"built_in\">HandleControlMessage</span>();</span><br><span class=\"line\">        <span class=\"comment\">//è‡³æ­¤ï¼Œç¬¬äºŒé˜¶æ®µå®Œæ¯•</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.h</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Subcontext</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">Subcontext</span>(std::vector&lt;std::string&gt; path_prefixes, std::string context, <span class=\"keyword\">bool</span> host = <span class=\"literal\">false</span>)</span><br><span class=\"line\">        : <span class=\"built_in\">path_prefixes_</span>(std::<span class=\"built_in\">move</span>(path_prefixes)), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">pid_</span>(<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!host) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//æ„é€ å‡½æ•°ä¸­ç›´æ¥ fork ä¸€ä¸ªè¿›ç¨‹</span></span><br><span class=\"line\">            <span class=\"built_in\">Fork</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Subcontext::Fork</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªå¯¹åº”ä¸Šä¸‹æ–‡çš„ socket</span></span><br><span class=\"line\">    unique_fd subcontext_socket;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">Socketpair</span>(AF_UNIX, SOCK_SEQPACKET | SOCK_CLOEXEC, <span class=\"number\">0</span>, &amp;socket_, &amp;subcontext_socket)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined(__ANDROID__)</span></span><br><span class=\"line\">    <span class=\"comment\">//subcontext çš„åˆå§‹åŒ–éœ€è¦åœ¨æŒ‚è½½ default çš„ç©ºé—´ä¸‹ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® /apex</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = <span class=\"built_in\">SwitchToMountNamespaceIfNeeded</span>(NS_DEFAULT); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Could not switch to \\&quot;default\\&quot; mount namespace: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//è·å–ä¸‹ä¸€é˜¶æ®µåˆå§‹åŒ–çš„æ‰§è¡Œè·¯å¾„ï¼Œè‡³å…³é‡è¦å•Šå…„å¼Ÿä»¬</span></span><br><span class=\"line\">   <span class=\"comment\">//Android11 æºç çº¦450Gï¼Œç›®å‰ä½¿ç”¨ vscode æœç´¢æŸå…³é”®å­—ï¼Œ</span></span><br><span class=\"line\">   <span class=\"comment\">//æœç´¢æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæœç´¢å¤ªæ…¢äº†ï¼Œä¼¼ä¹ç´¢å¼•å»ºç«‹å¤ªæ…¢ï¼Ÿæœ‰ä»€ä¹ˆæ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿æ¢ vscode ???  </span></span><br><span class=\"line\">   <span class=\"comment\">//å·¥å…· â€”â€”â€”â€” https://github.com/oracle/opengrok  Oracle å¼€æºçš„çœŸæ˜¯ç¦åˆ©å¥½ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// </span></span><br><span class=\"line\">   <span class=\"comment\">//----- å‡è£…æˆ‘æ˜¯åˆ†å‰²çº¿ -----</span></span><br><span class=\"line\">   <span class=\"comment\">//</span></span><br><span class=\"line\">   <span class=\"comment\">//é‚£ä¹ˆ GetExecutablePath å®ç°åœ¨å“ªé‡Œï¼Ÿæºç ä¸­æ²¡çœ‹åˆ°å•Š</span></span><br><span class=\"line\">   <span class=\"comment\">//âš ï¸æ³¨æ„äº†ï¼š</span></span><br><span class=\"line\">   <span class=\"comment\">// 1ã€è°ƒç”¨ GetExecutablePath() æ‰€åœ¨å‘½åç©ºé—´æ˜¯ using android::base::GetExecutablePath;</span></span><br><span class=\"line\">   <span class=\"comment\">// 2ã€çœ‹çœ‹å¼•å…¥çš„å¤´æ–‡ä»¶ #include &lt;android-base/properties.h&gt;ï¼Œæ³¨æ„å’¯ï¼Œæ˜¯å°–æ‹¬å·&lt;&gt;å¼•å…¥æ–¹å¼ï¼Œè€Œä¸æ˜¯åŒå¼•å·â€œâ€æœ¬åœ°å¼•å…¥ï¼Œè¯´æ˜æœ¬åœ°é¡¹ç›®ä¸‹æ ¹æœ¬æ‰¾ä¸åˆ°ï¼Œæ˜¯é€šè¿‡ç³»ç»Ÿè¿æ¥è¿›æ¥çš„ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// 3ã€æŸ¥é˜…å®˜ç½‘ï¼Œå‘ç°æ–‡ä»¶å®ç°åœ¨å†…æ ¸ä»“åº“æœ‰ä¸€ä»½å¯æŸ¥é˜…ã€‚https://source.android.google.cn/devices/tech/config/kernel?hl=zh-cn</span></span><br><span class=\"line\">   <span class=\"keyword\">auto</span> init_path = <span class=\"built_in\">GetExecutablePath</span>();</span><br><span class=\"line\">   <span class=\"keyword\">auto</span> child_fd_string = std::<span class=\"built_in\">to_string</span>(child_fd);</span><br><span class=\"line\">   <span class=\"comment\">//ç»ˆäºåˆç­‰åˆ°äº† execv å‡½æ•°ï¼Œæ³¨æ„ä¼ å‚ subcontextï¼Œæ˜¯ä¸æ˜¯åˆå›åˆ°äº† main.cppã€æˆ–è®¸ä½ å¯¹ main.cpp å·²æ²¡æœ‰äº†å°è±¡ï¼Œæ¯•ç«Ÿå­¦ä¹ å°±æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œåå¤çš„ã€åå¤çš„ã€åå¤çš„å°è±¡ä¹Ÿå°±æ·±åˆ»äº†ã€‘</span></span><br><span class=\"line\">   <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;init_path.<span class=\"built_in\">c_str</span>(), <span class=\"string\">&quot;subcontext&quot;</span>, context_.<span class=\"built_in\">c_str</span>(),child_fd_string.<span class=\"built_in\">c_str</span>(), <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">   <span class=\"built_in\">execv</span>(init_path.<span class=\"built_in\">data</span>(), <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"comment\">//æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œåœ°çƒæ˜¯åœ†çš„ï¼Œä½ åœ¨æ­¤å¤„é™å€™ï¼Œæˆ‘ä¸€ç›´å¾€åŒ—èµ°ï¼Œæœ€åè¿˜èƒ½ç›¸é‡ä¸æ˜¯å—ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">    android::base::<span class=\"built_in\">InitLogging</span>(argv, &amp;android::base::KernelLogger); </span><br><span class=\"line\">    <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = <span class=\"built_in\">GetBuiltinFunctionMap</span>();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SubcontextMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv, <span class=\"keyword\">const</span> BuiltinFunctionMap* function_map)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸»è¦è¿˜æ˜¯å¹²ä¸¤ä»¶äº‹ï¼Œåˆ›å»ºä¸Šä¸‹æ–‡è¿›ç¨‹ã€å¹¶è¿›å…¥æ— é™å¾ªç¯</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> subcontext_process = <span class=\"built_in\">SubcontextProcess</span>(function_map, context, init_fd);</span><br><span class=\"line\">    <span class=\"comment\">// Restore prio before main loop</span></span><br><span class=\"line\">    <span class=\"built_in\">setpriority</span>(PRIO_PROCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    subcontext_process.<span class=\"built_in\">MainLoop</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SubcontextProcess</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">SubcontextProcess</span>(<span class=\"keyword\">const</span> BuiltinFunctionMap* function_map, std::string context, <span class=\"keyword\">int</span> init_fd)</span><br><span class=\"line\">        : <span class=\"built_in\">function_map_</span>(function_map), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">init_fd_</span>(init_fd)&#123;&#125;;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">MainLoop</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SubcontextProcess::MainLoop</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    pollfd ufd[<span class=\"number\">1</span>];</span><br><span class=\"line\">    ufd[<span class=\"number\">0</span>].events = POLLIN;</span><br><span class=\"line\">    ufd[<span class=\"number\">0</span>].fd = init_fd_;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†å¾ªç¯äº‹ä»¶çš„è¿˜æ˜¯ poll å…·æŸ„ï¼Œä½¿ç”¨ socket é€šè®¯</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¤„ç†çš„æ¶ˆæ¯ç±»å‹æœ‰ä¸¤ç§ï¼šæ‰§è¡Œå‹ã€æ•°æ®è§£æå‹</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> subcontext_command = <span class=\"built_in\">SubcontextCommand</span>();</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> reply = <span class=\"built_in\">SubcontextReply</span>();</span><br><span class=\"line\">        <span class=\"built_in\"><span class=\"keyword\">switch</span></span> (subcontext_command.<span class=\"built_in\">command_case</span>()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> SubcontextCommand::kExecuteCommand: &#123;</span><br><span class=\"line\">                <span class=\"built_in\">RunCommand</span>(subcontext_command.<span class=\"built_in\">execute_command</span>(), &amp;reply);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> SubcontextCommand::kExpandArgsCommand: &#123;</span><br><span class=\"line\">                <span class=\"built_in\">ExpandArgs</span>(subcontext_command.<span class=\"built_in\">expand_args_command</span>(), &amp;reply);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Unknown message type from init: &quot;</span></span><br><span class=\"line\">                           &lt;&lt; subcontext_command.<span class=\"built_in\">command_case</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//å¾ªç¯ä¸­å¹²çš„äº‹å°±æ˜¯ä¸æ–­åˆ†å‘æ¶ˆæ¯ï¼Œåˆ°æ­¤ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ–èŠ‚æœ¬ç»“æŸ</span></span><br><span class=\"line\">        <span class=\"comment\">//ï¼Ÿï¼Ÿï¼Ÿå‘µï¼Œä¸€è„¸æ‡µé€¼å§ï¼Œæ¶ˆæ¯å‘å‡ºå»ä¹‹åå‘¢ï¼Ÿä¹‹ååˆå»æ‰§è¡Œå“ªé‡Œäº†ğŸ¤”ï¸</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = <span class=\"built_in\">SendMessage</span>(init_fd_, reply); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to send message to init: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>æœ€å</h1>\n<p>Android ç³»ç»Ÿå¯åŠ¨ç”± Linux åˆ›å»º init è¿›ç¨‹ï¼Œinit è¿›ç¨‹é€šè¿‡è§£æ <code>init.rc</code> ç­‰å‡ ä¸ªåˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è§£ææ•°æ®ç»§ç»­åˆ›å»ºã€å¯åŠ¨å…¶ä»–çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œç´§æ¥ç€å»ºç«‹ SELinux æœºåˆ¶ï¼Œå†æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µã€‚</p>\n<p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œåˆ°å“ªäº†å‘¢ï¼Ÿ<code>init.rc</code> åˆå§‹åŒ–é…ç½®æ–‡ä»¶çš„å†…å®¹å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ˜¯ä»å“ªé‡ŒåŠ è½½çš„ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿä¸å¾—ä¸è¯´ï¼Œä½œä¸ºæ–°æ‰‹çš„æˆ‘ç¡®å®è¿˜æœ‰å¾ˆå¤šç–‘é—®ï¼Œç›¸ä¿¡åç»­èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ã€‚</p>\n<p><strong>å…¶ä»–çŸ¥è¯†</strong></p>\n<ul>\n<li>Ramdisk: å°†ä¸€å—å†…å­˜å½“ä½œç‰©ç†ç£ç›˜ä½¿ç”¨ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰</li>\n<li>signalfd: ä¿¡å·æŠ½è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¸€åˆ‡çš†æ–‡ä»¶ï¼‰ï¼Œä¿¡å·å¼‚æ­¥æ“ä½œå°†è½¬æ¢é—® I/O æ“ä½œ</li>\n<li>Epollï¼šå¤šè·¯å¤ç”¨ã€æ‰¹é‡å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œpoll å‡çº§ç‰ˆ</li>\n<li>GSIï¼šgeneric system imageï¼ˆç³»ç»Ÿé•œåƒï¼‰</li>\n<li>opengrokï¼šä¸€ä¸ªå¿«é€Ÿå¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“</li>\n</ul>\n<p><strong>å‚è€ƒé“¾æ¥</strong></p>\n<ul>\n<li>Linux å†…æ ¸æ–‡æ¡£ï¼š<a href=\"https://www.kernel.org/doc/html/\">https://www.kernel.org/doc/html/</a></li>\n<li>Linux æ–‡æ¡£ï¼š<a href=\"https://linux.die.net/\">https://linux.die.net/</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>è®¾å¤‡å¯åŠ¨ç®€è¿°</h1>\n<p><strong>1ã€BIOS åŠ è½½</strong></p>\n<ul>\n<li>åŠ ç”µè‡ªæ£€ï¼ˆåŸºæœ¬è¾“å‡º/è¾“å…¥ç³»ç»Ÿ stdioï¼‰\n<ul>\n<li>ç¡¬ä»¶è‡ªæ£€<code>POST</code></li>\n</ul>\n</li>\n<li>å¤–éƒ¨å­˜å‚¨è®¾å¤‡<code>å¯åŠ¨é¡ºåºæ’åº</code>ï¼Œä¸‹ä¸€ä¸ªè·å¾—æ§åˆ¶æƒçš„è®¾å¤‡</li>\n<li>è¯»å–æ¿€æ´»åˆ†åŒºç¬¬ä¸€ä¸ªæ‰‡åŒºçš„ <code>ä¸»å¼•å¯¼è®°å½•</code>ï¼ˆ512 å­—èŠ‚ï¼‰\n<ul>\n<li>è´Ÿè´£åˆ†åŒºè¯»å†™åˆæ³•æ€§åˆ¤æ–­</li>\n<li>è´Ÿè´£å¼•å¯¼ä¿¡æ¯å®šä½</li>\n<li>æ•°æ®å­˜å‚¨\n<ul>\n<li>è°ƒç”¨æ“ä½œç³»ç»Ÿçš„æœºå™¨ç </li>\n<li>åˆ†åŒºè¡¨\n<ul>\n<li>ä¸»åˆ†åŒºæ˜¯æ¿€æ´»çš„ï¼Œæ¿€æ´»åˆ†åŒºçš„ç¬¬ä¸€ä¸ªæ‰‡åŒºæ˜¯<code>å·å¼•å¯¼è®°å½•</code>ï¼ˆå‘Šè¯‰è®¡ç®—æœºæ“ä½œç³»ç»Ÿåœ¨åˆ†åŒºçš„ä½ç½®-ç³»ç»Ÿç›˜åˆ†åŒºï¼‰</li>\n<li>å½“åªæœ‰ä¸€ä¸ªç³»ç»Ÿæ—¶å€™ï¼Œæ§åˆ¶æƒå°†äº¤ç»™æŸåˆ†åŒºï¼›å¦åˆ™å°†å¯åŠ¨<code>å¯åŠ¨ç®¡ç†å™¨</code>è®©ç”¨æˆ·é€‰æ‹©æ“ä½œç³»ç»Ÿ</li>\n</ul>\n</li>\n<li>ä¸»å¼•å¯¼è®°å½•ç­¾å\n<ul>\n<li>æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯ <code>0x55ã€0xAA</code> è¡¨ç¤ºå¯å¯åŠ¨è®¾å¤‡</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>2ã€kernel åŠ è½½</strong></p>\n<ul>\n<li>ç¡®å®šæ“ä½œç³»ç»Ÿä¹‹åè·å¾—æ§åˆ¶æƒï¼Œæ¥ç€åŠ è½½å†…æ ¸åˆ°å†…å­˜</li>\n<li>Linux ç³»ç»Ÿå†…æ ¸ä½äº<code>boot/kernel</code></li>\n<li>è¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº<code>sbin/init</code></li>\n<li>è§£æé…ç½®æ–‡ä»¶<code>etc/initab</code>åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¿›ç¨‹ <code>id 1</code></li>\n<li>ä¹‹å init è¿›ç¨‹åˆ†åˆ«åŠ è½½ç³»ç»Ÿå„æ¨¡å—çš„è¿›ç¨‹</li>\n</ul>\n<h1>Android å¯åŠ¨</h1>\n<p>Android ä¸å­˜åœ¨ BIOSï¼Œä½†æ˜¯æœ‰ <code>Bootloader</code>ï¼ŒAndroid ä¸å­˜åœ¨ç¡¬ç›˜ï¼Œä½†æ˜¯æœ‰<code>ROM</code>ï¼ˆç±»ä¼¼ç¡¬ç›˜ï¼Œç”±ä¸åŒåŒºåŸŸåˆ’åˆ†ï¼‰ã€‚</p>\n<p><strong>1ã€Bootloader</strong></p>\n<ul>\n<li>åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡</li>\n<li>å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„ï¼ˆä¸ºç³»ç»Ÿè°ƒç”¨æœåŠ¡ï¼‰</li>\n</ul>\n<p><strong>2ã€ROM</strong></p>\n<ul>\n<li>/boot ï¼šå¼•å¯¼ç¨‹åº â€”â€” æ“ä½œå†…æ ¸ã€å†…å­˜çš„ç¨‹åº</li>\n<li>/system ï¼šç›¸å½“äºç³»ç»Ÿç›˜ â€”â€” æ“ä½œç³»ç»Ÿã€ç³»ç»Ÿç¨‹åº</li>\n<li>/recovery ï¼š æ¢å¤åˆ†åŒº â€”â€” æ¢å¤æ“ä½œç³»ç»Ÿï¼ˆåˆ·æœºï¼‰</li>\n<li>/data ï¼š ç”¨æˆ·æ•°æ® â€”â€” å®‰è£…ç¨‹åºã€å¤–éƒ¨æ•°æ®</li>\n<li>/cache ï¼š ç³»ç»Ÿç¼“å­˜</li>\n<li>/scared ï¼š ç”¨æˆ·å­˜å‚¨ç©ºé—´ â€”â€” ç›¸å†Œã€éŸ³ä¹</li>\n</ul>\n<p><strong>3ã€Bootloader åŠ è½½</strong></p>\n<ul>\n<li>åŠ ç”µï¼Œå¼•å¯¼èŠ¯ç‰‡åŠ è½½ ROM é¢„è®¾ä»£ç æ‰§è¡Œ</li>\n<li>èŠ¯ç‰‡æŸ¥æ‰¾ Bootloader ä»£ç å¹¶åŠ è½½åˆ°å†…å­˜</li>\n<li>Bootloader å¼€å§‹æ‰§è¡Œï¼ŒæŸ¥æ‰¾æ“ä½œç³»ç»Ÿã€åŠ è½½ Linux å†…æ ¸åˆ°å†…å­˜</li>\n<li>Linux å†…æ ¸å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–ç¡¬ä»¶ã€åŠ è½½é©±åŠ¨ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€åˆ›å»ºå¹¶å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´ <code>init è¿›ç¨‹</code></li>\n</ul>\n<h1>Linux å†…æ ¸åŠ è½½</h1>\n<p><strong>1ã€idle è¿›ç¨‹ï¼ˆpid = 0ï¼‰</strong></p>\n<ul>\n<li>Linux ç³»ç»Ÿç¬¬ä¸€ä¸ªè¿›ç¨‹</li>\n<li>è¿›ç¨‹åå­—<code>init_task</code>ï¼Œé€€åŒ–åçš„<code>idle</code></li>\n<li>ä¸æ˜¯é€šè¿‡<code>forkã€kernel_thread</code>åˆ›å»ºçš„è¿›ç¨‹</li>\n<li>ä¸»è¦è´Ÿè´£è¿›ç¨‹è°ƒåº¦å·¥ä½œï¼Œè¿›å…¥æ— é™å¾ªç¯</li>\n</ul>\n<p><strong>2ã€init è¿›ç¨‹ï¼ˆpid = 1ï¼‰</strong></p>\n<ul>\n<li>ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹</li>\n<li>å¯åŠ¨å‰éƒ¨åˆ†ï¼šå®Œæˆåˆ›å»ºå’Œå†…æ ¸åˆå§‹åŒ–</li>\n<li>å¯åŠ¨åéƒ¨åˆ†ï¼šå®Œæˆ Android ç³»ç»Ÿåˆå§‹åŒ–</li>\n<li>/system/core/init/init.cpp</li>\n</ul>\n<p><strong>3ã€kthreadd è¿›ç¨‹ï¼ˆpid = 2ï¼‰</strong></p>\n<ul>\n<li>Linux å†…æ ¸ç®¡ç†è€…ï¼Œå†…æ ¸çº¿ç¨‹çš„çˆ¶è¿›ç¨‹</li>\n<li>ä¸»è¦è´Ÿè´£å†…æ ¸çº¿ç¨‹çš„è°ƒåº¦å’Œç®¡ç†</li>\n<li>ç”± idle é€šè¿‡<code>kernel_thead</code>åˆ›å»º</li>\n</ul>\n<h1>Android ç³»ç»Ÿå¯åŠ¨</h1>\n<p>ç›¸å…³æ–‡ä»¶ï¼š</p>\n<ul>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/first_state_main.cpp</li>\n<li>/system/core/init/first_state_init.cpp</li>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/selinux.cpp</li>\n<li>/system/core/init/main.cpp</li>\n<li>/system/core/init/init.cpp</li>\n<li>/system/core/init/property_service.cpp</li>\n<li>/system/core/init/subcontext.h</li>\n<li>/system/core/init/subcontext.cpp</li>\n<li>/system/core/init/builtins.cpp</li>\n<li>/system/core/init/action.cpp</li>\n</ul>\n<p>ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰å¯åŠ¨æ„å‘³ç€å¼€å§‹ Android ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ï¼Œåˆå§‹åŒ–è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ main å‡½æ•°çš„æ‰§è¡Œï¼Œä¸»è¦è´Ÿè´£å‡†å¤‡å’Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç•¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">           <span class=\"comment\">//å†…æ ¸æ—¥å¿—åˆå§‹åŒ–ï¼Œå†…æ ¸çš„æºç åœ¨å¦å¤–çš„ä»“åº“ï¼Œæš‚æ—¶çœ‹ä¸äº†</span></span><br><span class=\"line\">           android::base::<span class=\"built_in\">InitLogging</span>(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">           <span class=\"comment\">//å‡½æ•°æ˜ å°„ï¼Œè°ƒç”¨çš„å¯éƒ½æ˜¯å†…æ ¸å‡½æ•°ã€å‚è€ƒbuiltins.cppã€‘</span></span><br><span class=\"line\">           <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = <span class=\"built_in\">GetBuiltinFunctionMap</span>();</span><br><span class=\"line\">           <span class=\"comment\">//4ã€è¿˜æ˜¯è¿›å…¥ subcontext.cppï¼Œå¼€å§‹ä¸Šä¸‹æ–‡</span></span><br><span class=\"line\">           <span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//2ã€æ‰§è¡Œç¬¬äºŒé˜¶æ®µå‰ï¼Œå»ºç«‹Linuxå®‰å…¨æœºåˆ¶</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SetupSelinux</span>(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//3ã€åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">SecondStageMain</span>(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//1ã€åˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µ</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">FirstStageMain</span>(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰\">åˆå§‹åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰</h2>\n<p>ä¸ºæ–‡ä»¶ç³»ç»Ÿå‡†å¤‡å’Œåˆ›å»ºç¯å¢ƒ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//first_state_init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">clearenv</span>());</span><br><span class=\"line\">    <span class=\"comment\">//Linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œsocket ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">mkdir</span>(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">//755 æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ chmod 755 è®¿é—®æƒé™ï¼›7/5/5 â€”â€” ç”¨æˆ·/ç”¨æˆ·ç»„/å…¶ä»–ç”¨æˆ·ï¼ˆ421ç»„åˆï¼‰</span></span><br><span class=\"line\">    <span class=\"built_in\">CHECKCALL</span>(<span class=\"built_in\">chmod</span>(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"comment\">//é‡è¦çš„å¯åŠ¨é…ç½®æ–‡ä»¶ï¼Œæ›´å¤šè¯·å‚è€ƒ https://www.kernel.org/doc/html/</span></span><br><span class=\"line\">    android::base::<span class=\"built_in\">ReadFileToString</span>(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">//å¿…ä¸å¯å°‘çš„æ—¥å¿—</span></span><br><span class=\"line\">    <span class=\"comment\">//ç»è¿‡å‰é¢çš„å‡†å¤‡ã€æ£€éªŒå·¥ä½œï¼Œåˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µåˆå§‹åŒ–å·¥ä½œå°±è¦å¼€å§‹</span></span><br><span class=\"line\">    <span class=\"built_in\">InitKernelLogging</span>(argv);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ£€æŸ¥è™šæ‹Ÿå†…å­˜æ˜¯å¦é‡Šæ”¾ã€å¦‚æœªå¼€å¯åˆ™éœ€è¦é‡å¯</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> old_root_dir = std::unique_ptr&lt;DIR, <span class=\"keyword\">decltype</span>(&amp;closedir)&gt;&#123;<span class=\"built_in\">opendir</span>(<span class=\"string\">&quot;/&quot;</span>), closedir&#125;;</span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå¯èƒ½è¿˜è®°å¾— majorï¼ˆå†…æ ¸ä¸»ç‰ˆæœ¬ï¼‰ã€ minorï¼ˆå†…æ ¸æ¬¡ç‰ˆæœ¬ï¼‰ï¼Œç‰ˆæœ¬ä¿¡æ¯åœ¨åŠ è½½å‰éƒ½ä¼šå»è§£æï¼Œ</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">LoadKernelModules</span>(<span class=\"built_in\">IsRecoveryMode</span>() </span><br><span class=\"line\">    &amp;&amp; !<span class=\"built_in\">ForceNormalBoot</span>(cmdline, bootconfig), </span><br><span class=\"line\">    want_console,want_parallel, module_count)) &#123;</span><br><span class=\"line\">       <span class=\"comment\">//ç•¥</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åœ¨ recovery æ¨¡å¼ä¸‹ä¸å…è®¸åˆ›å»ºè®¾å¤‡å•Š</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsRecoveryMode</span>()) &#123;</span><br><span class=\"line\">        created_devices = <span class=\"built_in\">DoCreateDevices</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸ºåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µå‡†å¤‡</span></span><br><span class=\"line\">    <span class=\"comment\">///second_stage_resource/system/etc/ramdisk/build.prop</span></span><br><span class=\"line\">    std::string dest = <span class=\"built_in\">GetRamdiskPropForSecondStage</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ‰§è¡Œç¬¬ä¸€é˜¶æ®µçš„æŒ‚è½½</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">DoFirstStageMount</span>(!created_devices))</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ç¥å¥‡çš„ execv å‡½æ•°ï¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ›¿æ¢å½“å‰è¿›ç¨‹æ˜ åƒç»§ç»­æ‰§è¡Œï¼Œç´§æ¥ç€é€šè¿‡ä¼ å…¥çš„ `selinux_setup`å‚æ•°æ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°</span></span><br><span class=\"line\">    <span class=\"comment\">//æ›´å¤š execv å‚è€ƒï¼šhttps://linux.die.net/man/3/execv</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"built_in\">execv</span>(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">    <span class=\"comment\">//ç¬¬ä¸€é˜¶æ®µå¤§è‡´åˆ°æ­¤ç»“æŸ</span></span><br></pre></td></tr></table></figure>\n<p>å‡†å¤‡ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜ å°„ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//builtins.cpp</span></span><br><span class=\"line\"><span class=\"comment\">//è¿™ä¸ªå†…ç½®å‡½æ•°æ˜ å°„æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">// æ¯”å¦‚  &#123;&quot;start&quot;,&#123;1,1,&#123;false,  do_start&#125;&#125;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">// start å‘½ä»¤å¯¹åº”çš„æ‰§è¡Œçš„å‡½æ•°å°±æ˜¯ buildins.cpp é‡Œé¢å®šä¹‰çš„ do_start å‡½æ•°</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span> BuiltinFunctionMap&amp; <span class=\"title\">GetBuiltinFunctionMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">constexpr</span> std::<span class=\"keyword\">size_t</span> kMax = std::numeric_limits&lt;std::<span class=\"keyword\">size_t</span>&gt;::<span class=\"built_in\">max</span>();</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">const</span> BuiltinFunctionMap builtin_functions = &#123;</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;bootchart&quot;</span>,               &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_bootchart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;chmod&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_chmod&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;chown&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">3</span>,    &#123;<span class=\"literal\">true</span>,   do_chown&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_reset&quot;</span>,             &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_reset&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_restart&quot;</span>,           &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_class_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_start&quot;</span>,             &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;class_stop&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_class_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;copy&quot;</span>,                    &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_copy&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;copy_per_line&quot;</span>,           &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_copy_per_line&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;domainname&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_domainname&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;enable&quot;</span>,                  &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_enable&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec&quot;</span>,                    &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_exec&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec_background&quot;</span>,         &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_exec_background&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;exec_start&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_exec_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;export&quot;</span>,                  &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_export&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;hostname&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_hostname&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;ifup&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_ifup&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;init_user0&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_init_user0&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;insmod&quot;</span>,                  &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_insmod&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;installkey&quot;</span>,              &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_installkey&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_restart&quot;</span>,       &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_start&quot;</span>,         &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;interface_stop&quot;</span>,          &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_interface_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_exports&quot;</span>,            &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_load_exports&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_persist_props&quot;</span>,      &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_load_persist_props&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;load_system_props&quot;</span>,       &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_load_system_props&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;loglevel&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_loglevel&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mark_post_data&quot;</span>,          &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_mark_post_data&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mkdir&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">6</span>,    &#123;<span class=\"literal\">true</span>,   do_mkdir&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mount_all&quot;</span>,               &#123;<span class=\"number\">0</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_mount_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;mount&quot;</span>,                   &#123;<span class=\"number\">3</span>,     kMax, &#123;<span class=\"literal\">false</span>,  do_mount&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;perform_apex_config&quot;</span>,     &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_perform_apex_config&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;umount&quot;</span>,                  &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_umount&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;umount_all&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_umount_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;update_linker_config&quot;</span>,    &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_update_linker_config&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;readahead&quot;</span>,               &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_readahead&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;remount_userdata&quot;</span>,        &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_remount_userdata&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restart&quot;</span>,                 &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_restart&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restorecon&quot;</span>,              &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_restorecon&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;restorecon_recursive&quot;</span>,    &#123;<span class=\"number\">1</span>,     kMax, &#123;<span class=\"literal\">true</span>,   do_restorecon_recursive&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;rm&quot;</span>,                      &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_rm&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;rmdir&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">true</span>,   do_rmdir&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;setprop&quot;</span>,                 &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_setprop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;setrlimit&quot;</span>,               &#123;<span class=\"number\">3</span>,     <span class=\"number\">3</span>,    &#123;<span class=\"literal\">false</span>,  do_setrlimit&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;start&quot;</span>,                   &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_start&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;stop&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_stop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;swapon_all&quot;</span>,              &#123;<span class=\"number\">0</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_swapon_all&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;enter_default_mount_ns&quot;</span>,  &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_enter_default_mount_ns&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;symlink&quot;</span>,                 &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_symlink&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;sysclktz&quot;</span>,                &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_sysclktz&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;trigger&quot;</span>,                 &#123;<span class=\"number\">1</span>,     <span class=\"number\">1</span>,    &#123;<span class=\"literal\">false</span>,  do_trigger&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;verity_update_state&quot;</span>,     &#123;<span class=\"number\">0</span>,     <span class=\"number\">0</span>,    &#123;<span class=\"literal\">false</span>,  do_verity_update_state&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;wait&quot;</span>,                    &#123;<span class=\"number\">1</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_wait&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;wait_for_prop&quot;</span>,           &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">false</span>,  do_wait_for_prop&#125;&#125;&#125;,</span><br><span class=\"line\">        &#123;<span class=\"string\">&quot;write&quot;</span>,                   &#123;<span class=\"number\">2</span>,     <span class=\"number\">2</span>,    &#123;<span class=\"literal\">true</span>,   do_write&#125;&#125;&#125;,</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> builtin_functions;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"å»ºç«‹-SELinux\">å»ºç«‹ SELinux</h2>\n<p>ç¬¬ä¸€é˜¶æ®µæœ€å execv å‡½æ•°ä¼ å…¥åˆå§‹åŒ–å‚æ•° <code>selinux_setup</code>ï¼Œæ‰§è¡Œæµç¨‹å›åˆ° main.cppï¼Œç”± strcmp å‡½æ•°åˆ¤æ–­è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SetupSelinux</span>(argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SetupSelinux.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡å®‰å…¨ç­–ç•¥ï¼ŒæŸè·¯å¾„ä¸‹çš„ SEPolicy.zip æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"built_in\">PrepareApexSepolicy</span>();</span><br><span class=\"line\">    <span class=\"comment\">//è¯»å–å®‰å…¨ç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">ReadPolicy</span>(&amp;policy);</span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å®‰å…¨ç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">LoadSelinuxPolicy</span>(policy);</span><br><span class=\"line\">    <span class=\"comment\">//å¼ºåˆ¶æ‰§è¡Œç­–ç•¥</span></span><br><span class=\"line\">    <span class=\"built_in\">SelinuxSetEnforcement</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…³é”®ä»£ç åˆæ¥äº†ï¼Œè°ƒç”¨ execvï¼Œåˆå§‹åŒ–å‚æ•° second_stageï¼Œå‡†å¤‡æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"built_in\">execv</span>(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰\">åˆå§‹åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰</h2>\n<p>execv è°ƒç”¨åˆæ¥äº†ï¼Œæœ¬æ¬¡ä¼ å…¥åˆå§‹åŒ–å‚æ•°æ˜¯ <code>second_stage</code>ï¼Œæ‰§è¡Œæµç¨‹å†æ¬¡å›åˆ° main.cppï¼Œç´§æ¥ç€å¼€å§‹ç¬¬äºŒé˜¶æ®µçš„åˆå§‹åŒ–ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SecondStageMain</span>(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœè®¾å¤‡è§£é” unlockï¼Œå°†å…è®¸ adb root åŠ è½½è°ƒè¯•ä¿¡æ¯</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* force_debuggable_env = <span class=\"built_in\">getenv</span>(<span class=\"string\">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">bool</span> load_debug_prop = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (force_debuggable_env &amp;&amp; AvbHandle::<span class=\"built_in\">IsDeviceUnlocked</span>()) &#123;</span><br><span class=\"line\">        load_debug_prop = <span class=\"string\">&quot;true&quot;</span>s == force_debuggable_env;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å±æ€§åˆå§‹åŒ–ï¼Œåˆ›å»ºå±æ€§ä¿¡æ¯å¹¶å­˜å‚¨åœ¨ /dev/__properties__/property_info æ–‡ä»¶ä¸­</span></span><br><span class=\"line\">    <span class=\"comment\">//ä»å…¶ä»–å¤šä¸ªæ–‡ä»¶è¯»å–æ•°æ®ï¼Œæ„é€ æˆ PropertyInf å±æ€§é›†åˆ</span></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜å¤„ç†äº†å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šè¿™äº›è¢«å¤„ç†çš„ä¿¡æ¯å°†è¢« InitPropertySet(name,value) å‡½æ•°å†™å…¥ property_info æ–‡ä»¶ä¸­</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessKernelDt();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessKernelCmdline();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ProcessBootconfig();</span></span><br><span class=\"line\">    <span class=\"comment\">//    ExportKernelBootProps();//é‡åˆ°äº†é™Œç”Ÿåˆç†Ÿæ‚‰çš„ ro.boot é”®å€¼å¯¹å±æ€§ï¼Œä¾‹å¦‚ &quot;ro.boot.mode&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//PropertyLoadBootDefaults();//ä¸Šè¿°æ”¶é›†åˆ°çš„å±æ€§ä¿¡æ¯éƒ½å°†è¢«åŠ è½½ï¼Œå¦‚æœæ˜¯æ¢å¤æ¨¡å¼ï¼ˆåˆ·æœºï¼‰IsRecoveryMode()ï¼Œé‚£ä¹ˆä¼šåŠ è½½é»˜è®¤çš„å±æ€§æ–‡ä»¶ /prop.default </span></span><br><span class=\"line\">    <span class=\"comment\">//GetRamdiskPropForSecondStage(); //ç¬¬äºŒé˜¶æ®µéœ€è¦çš„å±æ€§å»å“ªé‡ŒåŠ è½½ï¼Ÿ/second_stage_resources/system/etc/ramdisk/build.prop</span></span><br><span class=\"line\">    <span class=\"built_in\">PropertyInit</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æŒ‚è½½ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿï¼šapexã€linkerconfig</span></span><br><span class=\"line\">    <span class=\"built_in\">MountExtraFilesystems</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ³¨å†Œ socket ç›‘å¬</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"built_in\">InstallSignalFdHandler</span>(&amp;epoll);</span><br><span class=\"line\">    <span class=\"built_in\">InstallInitNotifier</span>(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å±æ€§æœåŠ¡ï¼Œé€šè¿‡ socket é€šè®¯</span></span><br><span class=\"line\">    <span class=\"built_in\">StartPropertyService</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//oemï¼šåˆ·æœºçš„åŒå­¦å¯èƒ½ä¼šè®°å¾— â€˜å¼€å‘è€…é€‰é¡¹â€™ ä¸­å°±æœ‰ä¸ªé€‰é¡¹æ˜¯ â€˜OEMè§£é”â€™â€”â€”æ˜¯å¦å…è®¸è§£é”å¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ·æœºæ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šæ‰“å¼€æ­¤é€‰é¡¹</span></span><br><span class=\"line\">    <span class=\"built_in\">export_oem_lock_status</span>(); </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åŸæ¥ usb å¯¹åº”çš„å±æ€§æ˜¯ sys.usb.controllerï¼Œæ‰€åœ¨æ–‡ä»¶ /sys/class/udc</span></span><br><span class=\"line\">    <span class=\"built_in\">SetUsbController</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å†…æ ¸ç‰ˆæœ¬ ro.kernel.versionï¼ŒåŒ…å«ä¸»ç‰ˆæœ¬ major å’Œæ¬¡ç‰ˆæœ¬ minor</span></span><br><span class=\"line\">    <span class=\"built_in\">SetKernelVersion</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆå§‹åŒ– subcontext ä¸€ä¸ªè¿›ç¨‹ã€è¯·è½¬åˆ° subcontext.hã€‘</span></span><br><span class=\"line\">    <span class=\"built_in\">InitializeSubcontext</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åŠ è½½å¯åŠ¨è„šæœ¬</span></span><br><span class=\"line\">    <span class=\"comment\">//é¦–å…ˆé€šè¿‡ Property åŠ è½½ ro.boot.init_rc å±æ€§å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™åŠ è½½ /system/etc/init/hw/init.rc</span></span><br><span class=\"line\">    <span class=\"comment\">//actionManager æ·»åŠ ä¸€å †ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ action è¿›å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ</span></span><br><span class=\"line\">    <span class=\"comment\">//serviceList é€šè¿‡è§£æä¸€äº› /init.rcã€/system/etc/initã€/vendor/etc/init è·å–çš„æœåŠ¡</span></span><br><span class=\"line\">    <span class=\"built_in\">LoadBootScripts</span>(actionManager, serviceList);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å‡†å¤‡è¿›å…¥æ— é™å¾ªç¯ï¼Œæ­¤å‰é‡ç½®è¿›ç¨‹ä¼˜å…ˆçº§</span></span><br><span class=\"line\">    <span class=\"comment\">//prio ä¼˜å…ˆçº§èŒƒå›´ 0ï½139ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class=\"line\">    <span class=\"built_in\">setpriority</span>(PRIO_PROCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//epoll è´Ÿè´£äº‹ä»¶å¤„ç†ï¼Œé»˜è®¤æƒ…å†µ epoll ä¼šä¼‘çœ ï¼Œç±»ä¼¼é˜»å¡ç›´åˆ°æœ‰äº‹ä»¶åˆ°æ¥ï¼›å…³äº epoll </span></span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœæœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç­‰å¾…äº‹ä»¶å°†è¢«ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é©¬ä¸Šå¤„ç†äº‹ä»¶</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = std::optional&lt;std::chrono::milliseconds&gt;&#123;kDiagnosticTimeout&#125;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//æ¯æ¬¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å…³æœº</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> shutdown_command = shutdown_state.<span class=\"built_in\">CheckShutdown</span>();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è¿˜ä¼šæ£€æµ‹å¦‚æœè¿›ç¨‹éœ€è¦é‡å¯ï¼Œå°†ç«‹å³å¯åŠ¨</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> next_process_action_time = <span class=\"built_in\">HandleProcessActions</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°† fron ç¬¬ä¸€ä¸ªäº‹ä»¶å–å‡ºè¿›è¡Œå¤„ç†ï¼Œé€’å½’è¿›è¡Œï¼ŒåŠ é”åŒæ­¥è¿›è¡Œ</span></span><br><span class=\"line\">        <span class=\"built_in\">HandleControlMessage</span>();</span><br><span class=\"line\">        <span class=\"comment\">//è‡³æ­¤ï¼Œç¬¬äºŒé˜¶æ®µå®Œæ¯•</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.h</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Subcontext</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">Subcontext</span>(std::vector&lt;std::string&gt; path_prefixes, std::string context, <span class=\"keyword\">bool</span> host = <span class=\"literal\">false</span>)</span><br><span class=\"line\">        : <span class=\"built_in\">path_prefixes_</span>(std::<span class=\"built_in\">move</span>(path_prefixes)), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">pid_</span>(<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!host) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//æ„é€ å‡½æ•°ä¸­ç›´æ¥ fork ä¸€ä¸ªè¿›ç¨‹</span></span><br><span class=\"line\">            <span class=\"built_in\">Fork</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Subcontext::Fork</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªå¯¹åº”ä¸Šä¸‹æ–‡çš„ socket</span></span><br><span class=\"line\">    unique_fd subcontext_socket;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">Socketpair</span>(AF_UNIX, SOCK_SEQPACKET | SOCK_CLOEXEC, <span class=\"number\">0</span>, &amp;socket_, &amp;subcontext_socket)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined(__ANDROID__)</span></span><br><span class=\"line\">    <span class=\"comment\">//subcontext çš„åˆå§‹åŒ–éœ€è¦åœ¨æŒ‚è½½ default çš„ç©ºé—´ä¸‹ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® /apex</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = <span class=\"built_in\">SwitchToMountNamespaceIfNeeded</span>(NS_DEFAULT); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Could not switch to \\&quot;default\\&quot; mount namespace: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//è·å–ä¸‹ä¸€é˜¶æ®µåˆå§‹åŒ–çš„æ‰§è¡Œè·¯å¾„ï¼Œè‡³å…³é‡è¦å•Šå…„å¼Ÿä»¬</span></span><br><span class=\"line\">   <span class=\"comment\">//Android11 æºç çº¦450Gï¼Œç›®å‰ä½¿ç”¨ vscode æœç´¢æŸå…³é”®å­—ï¼Œ</span></span><br><span class=\"line\">   <span class=\"comment\">//æœç´¢æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæœç´¢å¤ªæ…¢äº†ï¼Œä¼¼ä¹ç´¢å¼•å»ºç«‹å¤ªæ…¢ï¼Ÿæœ‰ä»€ä¹ˆæ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿æ¢ vscode ???  </span></span><br><span class=\"line\">   <span class=\"comment\">//å·¥å…· â€”â€”â€”â€” https://github.com/oracle/opengrok  Oracle å¼€æºçš„çœŸæ˜¯ç¦åˆ©å¥½ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// </span></span><br><span class=\"line\">   <span class=\"comment\">//----- å‡è£…æˆ‘æ˜¯åˆ†å‰²çº¿ -----</span></span><br><span class=\"line\">   <span class=\"comment\">//</span></span><br><span class=\"line\">   <span class=\"comment\">//é‚£ä¹ˆ GetExecutablePath å®ç°åœ¨å“ªé‡Œï¼Ÿæºç ä¸­æ²¡çœ‹åˆ°å•Š</span></span><br><span class=\"line\">   <span class=\"comment\">//âš ï¸æ³¨æ„äº†ï¼š</span></span><br><span class=\"line\">   <span class=\"comment\">// 1ã€è°ƒç”¨ GetExecutablePath() æ‰€åœ¨å‘½åç©ºé—´æ˜¯ using android::base::GetExecutablePath;</span></span><br><span class=\"line\">   <span class=\"comment\">// 2ã€çœ‹çœ‹å¼•å…¥çš„å¤´æ–‡ä»¶ #include &lt;android-base/properties.h&gt;ï¼Œæ³¨æ„å’¯ï¼Œæ˜¯å°–æ‹¬å·&lt;&gt;å¼•å…¥æ–¹å¼ï¼Œè€Œä¸æ˜¯åŒå¼•å·â€œâ€æœ¬åœ°å¼•å…¥ï¼Œè¯´æ˜æœ¬åœ°é¡¹ç›®ä¸‹æ ¹æœ¬æ‰¾ä¸åˆ°ï¼Œæ˜¯é€šè¿‡ç³»ç»Ÿè¿æ¥è¿›æ¥çš„ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// 3ã€æŸ¥é˜…å®˜ç½‘ï¼Œå‘ç°æ–‡ä»¶å®ç°åœ¨å†…æ ¸ä»“åº“æœ‰ä¸€ä»½å¯æŸ¥é˜…ã€‚https://source.android.google.cn/devices/tech/config/kernel?hl=zh-cn</span></span><br><span class=\"line\">   <span class=\"keyword\">auto</span> init_path = <span class=\"built_in\">GetExecutablePath</span>();</span><br><span class=\"line\">   <span class=\"keyword\">auto</span> child_fd_string = std::<span class=\"built_in\">to_string</span>(child_fd);</span><br><span class=\"line\">   <span class=\"comment\">//ç»ˆäºåˆç­‰åˆ°äº† execv å‡½æ•°ï¼Œæ³¨æ„ä¼ å‚ subcontextï¼Œæ˜¯ä¸æ˜¯åˆå›åˆ°äº† main.cppã€æˆ–è®¸ä½ å¯¹ main.cpp å·²æ²¡æœ‰äº†å°è±¡ï¼Œæ¯•ç«Ÿå­¦ä¹ å°±æ˜¯ä¸€ä¸ªä¸æ–­é‡å¤çš„è¿‡ç¨‹ï¼Œåå¤çš„ã€åå¤çš„ã€åå¤çš„å°è±¡ä¹Ÿå°±æ·±åˆ»äº†ã€‘</span></span><br><span class=\"line\">   <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;init_path.<span class=\"built_in\">c_str</span>(), <span class=\"string\">&quot;subcontext&quot;</span>, context_.<span class=\"built_in\">c_str</span>(),child_fd_string.<span class=\"built_in\">c_str</span>(), <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">   <span class=\"built_in\">execv</span>(init_path.<span class=\"built_in\">data</span>(), <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"comment\">//æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œåœ°çƒæ˜¯åœ†çš„ï¼Œä½ åœ¨æ­¤å¤„é™å€™ï¼Œæˆ‘ä¸€ç›´å¾€åŒ—èµ°ï¼Œæœ€åè¿˜èƒ½ç›¸é‡ä¸æ˜¯å—ï¼Ÿ</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">    android::base::<span class=\"built_in\">InitLogging</span>(argv, &amp;android::base::KernelLogger); </span><br><span class=\"line\">    <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = <span class=\"built_in\">GetBuiltinFunctionMap</span>();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SubcontextMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv, <span class=\"keyword\">const</span> BuiltinFunctionMap* function_map)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ä¸»è¦è¿˜æ˜¯å¹²ä¸¤ä»¶äº‹ï¼Œåˆ›å»ºä¸Šä¸‹æ–‡è¿›ç¨‹ã€å¹¶è¿›å…¥æ— é™å¾ªç¯</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> subcontext_process = <span class=\"built_in\">SubcontextProcess</span>(function_map, context, init_fd);</span><br><span class=\"line\">    <span class=\"comment\">// Restore prio before main loop</span></span><br><span class=\"line\">    <span class=\"built_in\">setpriority</span>(PRIO_PROCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    subcontext_process.<span class=\"built_in\">MainLoop</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SubcontextProcess</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">SubcontextProcess</span>(<span class=\"keyword\">const</span> BuiltinFunctionMap* function_map, std::string context, <span class=\"keyword\">int</span> init_fd)</span><br><span class=\"line\">        : <span class=\"built_in\">function_map_</span>(function_map), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">init_fd_</span>(init_fd)&#123;&#125;;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">MainLoop</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SubcontextProcess::MainLoop</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    pollfd ufd[<span class=\"number\">1</span>];</span><br><span class=\"line\">    ufd[<span class=\"number\">0</span>].events = POLLIN;</span><br><span class=\"line\">    ufd[<span class=\"number\">0</span>].fd = init_fd_;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†å¾ªç¯äº‹ä»¶çš„è¿˜æ˜¯ poll å…·æŸ„ï¼Œä½¿ç”¨ socket é€šè®¯</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¤„ç†çš„æ¶ˆæ¯ç±»å‹æœ‰ä¸¤ç§ï¼šæ‰§è¡Œå‹ã€æ•°æ®è§£æå‹</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> subcontext_command = <span class=\"built_in\">SubcontextCommand</span>();</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> reply = <span class=\"built_in\">SubcontextReply</span>();</span><br><span class=\"line\">        <span class=\"built_in\"><span class=\"keyword\">switch</span></span> (subcontext_command.<span class=\"built_in\">command_case</span>()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> SubcontextCommand::kExecuteCommand: &#123;</span><br><span class=\"line\">                <span class=\"built_in\">RunCommand</span>(subcontext_command.<span class=\"built_in\">execute_command</span>(), &amp;reply);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> SubcontextCommand::kExpandArgsCommand: &#123;</span><br><span class=\"line\">                <span class=\"built_in\">ExpandArgs</span>(subcontext_command.<span class=\"built_in\">expand_args_command</span>(), &amp;reply);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Unknown message type from init: &quot;</span></span><br><span class=\"line\">                           &lt;&lt; subcontext_command.<span class=\"built_in\">command_case</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//å¾ªç¯ä¸­å¹²çš„äº‹å°±æ˜¯ä¸æ–­åˆ†å‘æ¶ˆæ¯ï¼Œåˆ°æ­¤ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ–èŠ‚æœ¬ç»“æŸ</span></span><br><span class=\"line\">        <span class=\"comment\">//ï¼Ÿï¼Ÿï¼Ÿå‘µï¼Œä¸€è„¸æ‡µé€¼å§ï¼Œæ¶ˆæ¯å‘å‡ºå»ä¹‹åå‘¢ï¼Ÿä¹‹ååˆå»æ‰§è¡Œå“ªé‡Œäº†ğŸ¤”ï¸</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = <span class=\"built_in\">SendMessage</span>(init_fd_, reply); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">LOG</span>(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to send message to init: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>æœ€å</h1>\n<p>Android ç³»ç»Ÿå¯åŠ¨ç”± Linux åˆ›å»º init è¿›ç¨‹ï¼Œinit è¿›ç¨‹é€šè¿‡è§£æ <code>init.rc</code> ç­‰å‡ ä¸ªåˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è§£ææ•°æ®ç»§ç»­åˆ›å»ºã€å¯åŠ¨å…¶ä»–çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œç´§æ¥ç€å»ºç«‹ SELinux æœºåˆ¶ï¼Œå†æ‰§è¡Œåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µã€‚</p>\n<p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œåˆ°å“ªäº†å‘¢ï¼Ÿ<code>init.rc</code> åˆå§‹åŒ–é…ç½®æ–‡ä»¶çš„å†…å®¹å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ˜¯ä»å“ªé‡ŒåŠ è½½çš„ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿä¸å¾—ä¸è¯´ï¼Œä½œä¸ºæ–°æ‰‹çš„æˆ‘ç¡®å®è¿˜æœ‰å¾ˆå¤šç–‘é—®ï¼Œç›¸ä¿¡åç»­èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ã€‚</p>\n<p><strong>å…¶ä»–çŸ¥è¯†</strong></p>\n<ul>\n<li>Ramdisk: å°†ä¸€å—å†…å­˜å½“ä½œç‰©ç†ç£ç›˜ä½¿ç”¨ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰</li>\n<li>signalfd: ä¿¡å·æŠ½è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä¸€åˆ‡çš†æ–‡ä»¶ï¼‰ï¼Œä¿¡å·å¼‚æ­¥æ“ä½œå°†è½¬æ¢é—® I/O æ“ä½œ</li>\n<li>Epollï¼šå¤šè·¯å¤ç”¨ã€æ‰¹é‡å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œpoll å‡çº§ç‰ˆ</li>\n<li>GSIï¼šgeneric system imageï¼ˆç³»ç»Ÿé•œåƒï¼‰</li>\n<li>opengrokï¼šä¸€ä¸ªå¿«é€Ÿå¯ç”¨çš„æºä»£ç æœç´¢å’Œäº¤å‰å¼•ç”¨å¼•æ“</li>\n</ul>\n<p><strong>å‚è€ƒé“¾æ¥</strong></p>\n<ul>\n<li>Linux å†…æ ¸æ–‡æ¡£ï¼š<a href=\"https://www.kernel.org/doc/html/\">https://www.kernel.org/doc/html/</a></li>\n<li>Linux æ–‡æ¡£ï¼š<a href=\"https://linux.die.net/\">https://linux.die.net/</a></li>\n</ul>\n"},{"title":"Android ç³»ç»Ÿ zygote","catalog":true,"date":"2022-09-29T14:56:05.000Z","subtitle":"ä¿—ç§° Java ä¸–ç•Œçš„é¼»ç¥–","header-img":"/img/220928/android_zygot_bg.png","sticky":7,"_content":"\n\nç›¸å…³æ–‡ä»¶ï¼š\n\n- /system/core/init/init.cpp\n- /system/etc/init/hw/init.rc  (æºç å·¥ç¨‹æ²¡æ‰¾åˆ°ï¼Œæ˜¯ä»æ‰‹æœºä¸Šè·å–)\n- /system/etc/init/hw/init.zygote32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰\n- /system/etc/init/hw/init.zygote64_32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰\n- /system/core/init/action.cpp\n- /system/core/init/service.cpp\n- /system/core/init/service_list.cpp\n- frameworks/base/core/java/com/android/internal/os/ZygoteInit.java\n- frameworks/base/core/java/com/android/internal/os/ZygoteServer.java\n- frameworks/base/core/java/com/android/internal/os/Zygote.java\n- frameworks/base/core/java/com/android/internal/os/WrapperInit.java\n\n\n# è§£æåˆå§‹åŒ–é…ç½®æ–‡ä»¶ \n\nåˆå§‹åŒ–é…ç½®æ–‡ä»¶åŒ…æ‹¬ä½†ä¸é™äº init.rcã€hw/init.rcã€‚å¸¦ç€çš„ç–‘æƒ‘ç»§ç»­çœ‹æºç ï¼Œä¹‹å‰æåˆ°æ‰§è¡Œåˆ°åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µæ—¶ init è¿›ç¨‹è¿›å…¥æ— é™çš„è½®è¯¢ï¼ˆloopï¼‰ï¼Œä¼¼ä¹ä¸çŸ¥å»å‘ä½•å¤„ï¼Ÿç–‘æƒ‘æ˜¯åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯åå†åšå¤„ç†ï¼Œç¬¬äºŒé˜¶æ®µä¸­åˆ›å»º init è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°`LoadBootScripts(actionManager,serviceList)`ï¼ŒåŠ è½½å¯åŠ¨è„šæœ¬çš„å…³é”®ï¼Œç›¸å½“é‡è¦ï¼Œä¸`init.rc`æ–‡ä»¶å­˜åœ¨åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚\n\n```cpp\n//init.cpp\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //è§£æ init.rcï¼Œå¯åŠ¨çš„å…³é”®æ–‡ä»¶\n        parser.ParseConfig(\"/system/etc/init/hw/init.rc\");\n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n        \n        parser.ParseConfig(\"/system_ext/etc/init\");\n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            //vendor å‚å•†ç›¸å…³çš„åˆå§‹åŒ–é…ç½®\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n```cpp\n//init.cpp\nvoid SecondStageMain(){\n\n    //æ•°æ®è§£æè·å¾—ï¼Œå¼€å§‹æ„å»º action é˜Ÿåˆ—\n    ActionManager& am = ActionManager::GetInstance();\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    .... etc\n\n    //è§¦å‘å¯åŠ¨\n    am.QueueEventTrigger(\"init\");\n    \n    //è‹¥å¤„äºå……ç”µæ¨¡å¼å°†å»¶è¿Ÿåˆå§‹åŒ–\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        am.QueueEventTrigger(\"late-init\");\n    }\n    \n    //init è¿›ç¨‹è¿›å…¥æ— é™è½®è®­\n    while(true){\n        //å¼€å§‹é€šè¿‡ command å‘½ä»¤æ‰§è¡Œ inir.rc è„šæœ¬å„é¡¹æœåŠ¡ä»¥åŠåˆå§‹åŒ–\n        if (!(prop_waiter_state.MightBeWaiting() || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(prop_waiter_state.MightBeWaiting() || Service::is_exec_service_running())) {\n\n        // If there's more work to do, wake up again immediately.\n        if (am.HasMoreCommands())\n            epoll_timeout = 0ms;\n        }\n    }\n}\n```\n\nåœ¨ Android 11 ä¸Šï¼Œinit.rc æ–‡ä»¶ä½äº`/system/etc/init/hw/init.rc`\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92ab7d4ccd7a4118a1f705928d97c212~tplv-k3u1fbpfcp-watermark.image?)\n\nè¿™æ˜¯æˆ‘åœ¨å°ç±³æ‰‹æœºæ‰¾çš„ï¼Œrc æ–‡ä»¶è¢«è§†ä¸º Android åˆå§‹åŒ–è¯­è¨€ï¼Œé‚£è‚¯å®šä¹Ÿæœ‰è‡ªå·±çš„è¯­æ³•æˆ–æ ¼å¼ï¼Œå¯ä»¥å‚è€ƒï¼šhttps://www.cnblogs.com/gufanyuan/p/9350130.html\n\n**markï¼š**\n- action on åæºå¸¦ä¸€ç»„å‘½ä»¤\n- trigger è§¦å‘å™¨ï¼Œç¡®å®šä½•æ—¶æ‰§è¡Œå‘½ä»¤\n- service å½“ init é€€å‡ºæ—¶å¯åŠ¨æˆ–é‡å¯\n- options è¿›ä¸€æ­¥æ§åˆ¶å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å’Œæ—¶é—´\n- å‘½ä»¤ï¼šon æ¯ä¸€è¡Œä»£è¡¨ä¸€æ¡å‘½ä»¤\n- import å¯¼å…¥é¢å¤–çš„ rc æ–‡ä»¶éœ€è¦è§£æ\n\nçœ‹çœ‹ rc æ–‡ä»¶ï¼š\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0991aad99b524f9ebc147ce1fe075047~tplv-k3u1fbpfcp-watermark.image?)\n\n```cpp\n//  /system/etc/init/hw/init.rc\n# å°ç±³ç³»ç»Ÿï¼Œä¹Ÿæœ‰å‚å•†è‡ªå·±çš„è§£ææ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œå±äºè‡ªå·±çš„è¿›ç¨‹\n# import æŒ‡æ˜å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶éœ€è¦è§£æ\n# MIUI ADD:\nimport /init.miui.rc\n\n# è¿˜è®°å¾— SecondStageMain actionManage å—\n# am.QueueEventTrigger(\"early-init\");\non early-init\n    # ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç† uevent æ¶ˆæ¯\n    start ueventd\n    # apex æœåŠ¡äºç³»ç»Ÿæ¨¡å—å®‰è£…\n    exec_start apexd-bootstrap\n\n# è§¦å‘æ‰€æœ‰ action\n# am.QueueEventTrigger(\"init\");\non init\n    # åˆ›å»º stdio æ ‡å‡†è¾“å…¥è¾“å‡ºé“¾æ¥\n    symlink /proc/self/fd/0 /dev/stdin\n    # ç»™ sdcard æ›´æ”¹æƒé™\n    chmod 0770 /config/sdcardfs\n    \n    # å¯åŠ¨æœåŠ¡\n    # ç³»ç»ŸæœåŠ¡ï¼Œè¶Šæ¥è¶Šæ¥è¿‘åº”ç”¨å±‚äº†\n    start servicemanager\n    # hwâ€”â€”hardwareï¼Œç¡¬ä»¶æœåŠ¡\n    start hwservicemanager\n    #ä¾›åº”å•†æœåŠ¡\n    start vndservicemanager\n    # init action å°±æ‰§è¡Œåˆ°è¿™ï¼Œä¸­é—´çœç•¥å¾ˆå¤šå‘½ä»¤ï¼Œè¿™é‡Œåªæ˜¯æŠ½å–å‡ ä¸ªï¼Œç‚¹åˆ°ä¸ºæ­¢\n    \n# æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ ¸å¿ƒæœåŠ¡\n# am.QueueEventTrigger(\"late-init\");\non late-init\n    # è§¦å‘ fsï¼šVold æ§åˆ¶å’Œç®¡ç†å¤–éƒ¨å­˜å‚¨çš„è¿›ç¨‹\n    trigger early-fs\n\n    # é‡ç‚¹æ¥äº†âš ï¸âš ï¸âš ï¸\n    # import /system/etc/init/hw/init.${ro.zygote}.rc\n    # zygote è¿›æ¥äº†ï¼Œå¸¸è¯´çš„ Android åº”ç”¨å±‚çš„é¼»ç¥–\n    trigger zygote-start\n    \n    trigger early-boot\n    trigger boot\n\non boot\n    # å¯åŠ¨ HAL ç¡¬ä»¶æŠ½è±¡ç±»æœåŠ¡\n    class_start hal\n    # å¯åŠ¨æ ¸å¿ƒç±»æœåŠ¡\n    class_start core\n```\n\n# è§£æ zygote.rc\n\nçœ‹ä¸Šé¢æˆªå›¾ï¼Œç°åœ¨è¯¥æ‰§è¡Œ`init.zygote32.rcã€init.zygote64_32.rc`ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚\n```cpp\n//  /system/etc/init/hw/init.zygote32.rc\n// zygote32 : åªæœ‰ä¸€ä¸ª 32ï¼Œé‚£å°±æ˜¯çº¯çº¯çš„ä¸º 32 ä½å‡†å¤‡çš„\n\nservice zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n\n```\n\n```c++\n//  /system/etc/init/hw/init.zygote64_32.rc\n// zygote64_32 : å‰éƒ¨åˆ† 64 æŒ‡ä¸»è¦æ¨¡å¼ï¼Œåéƒ¨åˆ† 32 æŒ‡è¾…åŠ©æ¨¡å¼ï¼›åŒæ ·çš„ä¹Ÿä¼šæœ‰ zygote32_64.rcã€zygote32.rcã€zygote64.rc  etc.\n\n# service æ˜¯ Android åˆå§‹åŒ–è¯è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡ init å¯åŠ¨æˆ–é€€å‡ºæ—¶é‡æ–°å¯åŠ¨æœåŠ¡\n# æ˜¾ç„¶ï¼Œè¿™é‡Œçš„æœåŠ¡åç§°å°±æ˜¯â€˜å®¶å–»æˆ·æ™“â€™çš„ zygote è¿›ç¨‹\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote\n    class main\n    priority -20     ### è¿›ç¨‹ä¼˜å…ˆçº§ -20 ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå–å€¼èŒƒå›´ [-20,19]\n    user root        ### ç”± root ç”¨æˆ·æ‰§è¡Œ \n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    task_profiles ProcessCapacityHigh MaxPerformance\n\n# zygote_secondary ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ\n# ä½ åœ¨çœ‹å‰é¢æåˆ°çš„â€˜ä¸»æ¨¡å¼â€™å’Œâ€˜è¾…æ¨¡å¼â€™ï¼Œæ°å¥½ zygote æ˜¯ app_process64ï¼Œzygote_secondary æ˜¯ app_process32ï¼Œ\n# åˆšåˆšå¥½å¯¹åº”ä¸Šæ–‡ä»¶å init.zygote64_32.rc ã€ä¸»æ¨¡å¼æ˜¯64ï¼Œè¾…æ¨¡å¼æ˜¯32ã€‘\nservice zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote_secondary stream 660 root system\n    socket usap_pool_secondary stream 660 root system\n    onrestart restart zygote\n    task_profiles ProcessCapacityHigh MaxPerformance\n```\n\n# åˆ›å»º zygote Process\n\nåœ¨åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ SecondStageMain è§£æäº† inir.rcï¼Œå›åˆ° main.cpp çŸ¥é“ GetBuiltinFunctionMap å‡½æ•°æ˜ å°„è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥ SubcontextMainï¼Œç¬¬å››éƒ¨åˆ†å¼€å§‹æ‰§è¡Œï¼Œæ¥ç€çœ‹çœ‹æ‰§è¡Œæµç¨‹ã€‚\n\n```cpp\n//main.cpp\nreturn SubcontextMain(argc, argv, &function_map);\n\n//subcontext.cpp\nauto subcontext_process = SubcontextProcess(function_map, context, init_fd);\n\n//subcontext.cpp\nSubcontextProcess(const BuiltinFunctionMap* function_map, std::string context, int init_fd)\n: function_map_(function_map), context_(std::move(context)), init_fd_(init_fd){};\n//é€šè¿‡æ„é€ å‡½æ•°ï¼Œç›´æ¥å°†å‡½æ•°æ˜ å°„è¡¨èµ‹å€¼ç»™æˆå‘˜ function_map_\nconst BuiltinFunctionMap* function_map_;\n\n//åœ¨ SubcontextMain ä¸­å¼€å§‹ä¸»å¾ªç¯\nsubcontext_process.MainLoop();\n\n//ä¸»å¾ªç¯ä¸­å‡†å¤‡æ‰§è¡Œå‘½ä»¤\nRunCommand(subcontext_command.execute_command(), &reply);\n\n//æ˜ å°„è¡¨ function_map_ è¢«ä½¿ç”¨\n//æ ¹æ®å‚æ•°ï¼ˆå‘½ä»¤ï¼‰æŸ¥æ‰¾å¯¹åº”çš„å†…ç½®å‡½æ•°\nauto map_result = function_map_->Find(args);\n//æ‰¾åˆ°äº†å‘½ä»¤å‡†å¤‡æ‰§è¡Œ\nresult = RunBuiltinFunction(map_result->function, args, context_);\n\n//æ„é€ å‚æ•°ï¼Œç›´æ¥è°ƒç”¨\n//å›æƒ³ä¸€ä¸‹ï¼Œæ˜ å°„è¡¨ä¸­æ˜¯å¦æœ‰ç€ä¸€ä¸ª item\n//{\"class_start\", {1, 1, {false, do_class_start}}}\n//do_class_startï¼šå†…ç½®å‡½æ•°è¢«å£°æ˜åœ¨ builtins.cpp ä¸­ï¼Œä¸‹é¢çœ‹çœ‹å…¶å®ç°\nauto builtin_arguments = BuiltinArguments(context);\nreturn function(builtin_arguments);\n```\n\n```cpp\n//builtins.cpp\nstatic Result<void> do_class_start(const BuiltinArguments& args) {\n    if (android::base::GetBoolProperty(\"persist.init.dont_start_class.\" + args[1], false))\n        return {};\n    //æœåŠ¡å¯åŠ¨\n    /*\n        1ã€ServiceList::GetInstance() åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿å•Šï¼Ÿservice åˆ—è¡¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n    è¿˜è®°å¾—ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ– SecondStageMain ä¸­è¿™æ®µä»£ç å—\n    ServiceList& sm = ServiceList::GetInstance();\n    LoadBootScripts(am, sm); //è¿™æ­£æ˜¯åœ¨è§£æ init.rc æ–‡ä»¶ï¼Œå…¶ä¸­å°±åŒ…å« hw/init.rc\n    \n        2ã€å¯ä»¥è®¤ä¸º service å°±æ˜¯é€šè¿‡è§£æ init.rc ä¸­çš„ service è·å¾—çš„ï¼Œæ­¤æ–‡ä»¶æ­£å¥½ä¹Ÿå¯¼å…¥ import hw/init.rcï¼Œå…¶ä¸­åŒ…å« zygote ç›¸å…³ï¼Œ\n    è¿›è€Œç»§ç»­è§£æ init.zygote.rcï¼Œzygote.rc æ–‡ä»¶å†…å®¹ä¹Ÿä¼šè¢«è§£æåˆ°\n\nServiceList.GetInstance å°±æ˜¯ std::vector<std::unique_ptr<Service>> services_;\nservice->classenames() å°±æ˜¯ std::set<std::string> classnames_;\n    \n        3ã€åˆ›å»º Service çš„æ„é€ å‡½æ•°ï¼š\n    Service::Service(const std::string& name, unsigned flags, uid_t uid, gid_t gid,\n       const std::vector<gid_t>& supp_gids, int namespace_flags,\n       const std::string& seclabel, Subcontext* subcontext_for_restart_commands,\n       const std::vector<std::string>& args, bool from_apex)\n       :  name_(name),\n       classnames_({\"default\"}),\n        ... etc\n     ){}\n    \n    */\n\n    for (const auto& service : ServiceList::GetInstance()) {\n        //å‚æ•°çš„æ¥æº\n        /*\n            1ã€åå¤æŸ¥é˜…èµ„æ–™å¾—çŸ¥ args å°±æ˜¯ rc æ–‡ä»¶ä¸­æ¯ä¸ª service çš„å‚æ•°\n        args[1] è‡ªç„¶æ˜¯ç¬¬äºŒä¸ªå‚æ•°\n        çœ‹ hw/zygote.rc service æ‰§è¡Œ zygote å‘½ä»¤å‰éƒ¨åˆ†\n        ...\n        service zygote\n          class main\n          ...\n        \n            2ã€å› æ­¤ args[1] å…¶å®å°±æ˜¯ main\n        åŒæ ·ï¼Œæˆ‘ä»¬çœ‹ hw/init.usb.rc ä¹Ÿæœ‰ä¸€ä¸ª service\n        ...\n        service adbd\n           class core\n           ...   \n        adb çš„ä½¿ç”¨ä¸ adbd å¯æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œadbd æ˜¯ä¸€ä¸ªè¿œç¨‹æœåŠ¡è¿›ç¨‹\n        \n            3ã€æ‰€ä»¥è¿™é‡Œçš„æ„æ€æ˜¯ï¼š\n        æ ¹æ®å‚æ•°åç§°å»æœåŠ¡åˆ—è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæœåŠ¡å­˜åœ¨é‚£ä¹ˆå¼€å§‹æ‰§è¡Œ\n        æœåŠ¡ä¸€èˆ¬æ˜¯ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œä¸”å¾ˆæœ‰å¯èƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹\n        */\n        if (service->classnames().count(args[1])) {\n            if (auto result = service->StartIfNotDisabled(); !result.ok()) {\n                LOG(ERROR) << \"Could not start service '\" << service->name()\n                           << \"' as part of class '\" << args[1] << \"': \" << result.error();\n            }\n        }\n    }\n    return {};\n}\n\n//service.cpp\nResult<void> Service::StartIfNotDisabled() {\n    if (!(flags_ & SVC_DISABLED)) {\n        return Start();\n    } else {\n        flags_ |= SVC_DISABLED_START;\n    }\n    return {};\n}\n\n//service.cpp\nResult<void> Service::Start() {\n    \n    pid_t pid = -1;\n    if (namespaces_.flags) {\n        pid = clone(nullptr, nullptr, namespaces_.flags | SIGCHLD, nullptr);\n    } else {\n        //å°±è¿™ï¼Ÿè¿›ç¨‹å°±è¢« fork å‡ºæ¥äº†ï¼Ÿï¼Ÿï¼Ÿ\n        pid = fork();\n    }\n\n    // pid 0 æ˜¯ idle è¿›ç¨‹ï¼Œè‚¯å®šä¸èƒ½\n    if (pid == 0) {\n        umask(077);\n        RunService(override_mount_namespace, descriptors, std::move(pipefd));\n        _exit(127);\n    }\n    \n    //åˆ›å»ºè¿›ç¨‹ç»„\n    errno = -createProcessGroup(proc_attr_.uid, pid_, use_memcg);\n}\n```\n\nåˆ°æ­¤ï¼Œé€šè¿‡æŸ¥æ‰¾æœåŠ¡åˆ—è¡¨åˆ›å»ºäº†ä¸€å †è¿›ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸»è¦å…³æ³¨ `zygote`è¿›ç¨‹çš„åˆ›å»ºï¼Œè¿™æ—¶å€™é—´ä» cpp è¿›å…¥ Java\n\n# åˆå§‹åŒ– zygote\n## é¢„åŠ è½½é…ç½®\n\n```cpp\n//ZygoteInit.java\npublic class ZygoteInit {\n    /*\n     * åˆå§‹åŒ–ä¸»è¦åšï¼š\n     * 1ã€å®Œæˆé¢„åˆå§‹åŒ–\n     * 2ã€åˆ›å»º zygote æœåŠ¡\n     * 3ã€åˆ›å»ºç³»ç»ŸæœåŠ¡\n     */\n    public static void main(String[] argv) {\n        //ã€1ã€‘å®Œæˆé¢„åˆå§‹åŒ–\n        /*\n            1ã€è°ƒç”¨ ZygoteHooks.onBeginPreload(); ZygoteHooks ä» Dalvik åŒ…å¼•å…¥ï¼Œåœ¨ framework ä¸‹æ²¡æœ‰æ‰¾åˆ°çš„æºç åº”è¯¥æ˜¯åœ¨åˆ«å¤„äº†ï¼Œé¢„æƒ³æ˜¯å¯¹ Dalvik çš„åˆå§‹åŒ–ï¼›é¢„åŠ è½½ç»“æŸæ—¶ä¹Ÿä¼šè°ƒç”¨ ZygoteHooks.onEndPreload();\n            2ã€VMRuntime ä¸º Dalvik é¢„åŠ è½½è·¯å¾„ä¸‹çš„ç±» /system/etc/preloaded-classesã€profilebootclasspath\n            3ã€åˆ›å»ºå¹¶ç¼“å­˜éå¯åŠ¨ç±»è·¯å¾„ä¸‹çš„ç±»åŠ è½½å™¨ /system/framework/android.hidl.base-V1.0-java.jarã€/system/framework/android.hidl.manager-V1.0-java.jar (HIDL æ¥å£å®šä¹‰è¯­è¨€ â€”â€” https://source.android.google.cn/devices/architecture/hidl?hl=zh-cn)\n            4ã€åŠ è½½èµ„æºï¼ŒåŠ è½½å‰å…ˆæ›´æ–°é…ç½®ï¼ˆæ¯”å¦‚å½“å‰è®¾å¤‡åˆ†è¾¨ç‡ã€å±å¹•å°ºå¯¸ã€è¯­è¨€ï¼‰ï¼Œ\n        æ ¹æ®åˆ†è¾¨ç‡åŠ è½½ drawableã€é¢œè‰²èµ„æº\n            5ã€é€šè¿‡ native åŠ è½½ä¸ºåº”ç”¨è¿›ç¨‹å‡†å¤‡çš„ HAL ç¡¬ä»¶æŠ½è±¡åˆ—è¡¨\n            6ã€å¦‚æœå¼€å¯äº† ro.zygote.disable_gl_preloadï¼Œä¹Ÿé€šè¿‡ native æ‰§è¡Œå›¾å½¢ GL é¢„åŠ è½½\n            7ã€é€šè¿‡ System.loadLibrary åŠ è½½å…±äº«åº“ android.libã€compiler_rt.libã€jnigraphics.lib\n            8ã€å‡†å¤‡ Hyphenator ç¯å¢ƒï¼Œç¼“å­˜å­—ä½“\n            9ã€åŠ è½½ webviewchromium_loader.libï¼Œå‡†å¤‡ webview \n            10ã€é€šè¿‡ AndroidKeyStoreProvider å®‰è£… keystore å†…å®¹æä¾›è€…  \n        */\n        preload(bootTimingsTraceLog);\n        \n        //åˆå§‹åŒ– GCï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†\n        ZygoteHooks.gcAndFinalize()ï¼›\n        //åˆ°è¿™é‡Œ zygote å·²ç»æ˜¯ã€åˆå§‹åŒ–å®Œæ¯•ã€‘\n        Zygote.initNativeState(isPrimaryZygote)\n        \n        //ã€2ã€‘åˆ›å»º zygote æœåŠ¡\n        ZygoteServer zygoteServer = null;\n        zygoteServer = new ZygoteServer(isPrimaryZygote);\n        \n        //ã€3ã€‘åˆ›å»ºç³»ç»ŸæœåŠ¡\n        if (startSystemServer) {\n            //forkï¼Œå¯è§æ¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼›ABI â€”â€” Application binary interfaceã€å‚è€ƒé“¾æ¥ã€‘\n            //åœ¨ Android é¡¹ç›®ä¸­å¯¹åº”çš„å°±æ˜¯ ndk filterï¼Œå¦‚ arm64ã€x86  .etc\n            //ä¸ºæ”¯æŒä¸åŒå¹³å°ï¼Œndk filter æ˜¯èƒ½å¤Ÿé…ç½®å¤šä¸ªçš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼å­˜åœ¨\n            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);\n            if (r != null) {\n                //åˆ›å»ºä¹‹åé©¬ä¸Šè¿è¡Œ\n                return;\n            }\n         }\n         \n        // zygote æœåŠ¡è¿›å…¥è‡ªå·±çš„ä¸–ç•Œè½®è®­\n        caller = zygoteServer.runSelectLoop(abiList);\n        if(caller != null){\n            caller.run();\n        }\n    }\n}\n```\n\n## åˆ›å»º zygoteServer\n\næœåŠ¡ä¸»è¦è¿˜æ˜¯é€šè¿‡ socket å®ç°ï¼Œç­‰å¾…æ¥è‡ª Linuxã€unix å®ˆæŠ¤è¿›ç¨‹ (socket) çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å­è¿›ç¨‹çš„åˆ›å»ºã€‚\n\n```cpp\n//ZygoteServer.java\nclass ZygoteServer {\n\n//åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„æˆå‘˜\n//ç”¨äºç›‘å¬ socket è¿æ¥\nprivate LocalServerSocket mZygoteSocket;\n//ä¸º USAP éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  æœåŠ¡\nprivate final LocalServerSocket mUsapPoolSocket;\n\nZygoteServer(boolean isPrimaryZygote) {\n        //é€šè¿‡ native è°ƒç”¨è·å–\n        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();\n        \n        //ä¸» zygote\n        if (isPrimaryZygote) {\n            //å®Œæˆçš„ socket åç§°éœ€è¦å’Œ ANDROID_SOCKET_ + socketname æ‹¼æ¥ï¼Œ\n            //ç„¶åæ‹¿å®Œæ•´çš„åç§°å»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾è·å–æ–‡ä»¶æè¿°ç¬¦ fd â€”â€” file describeï¼Œå®é™…æ˜¯ä¸€ä¸ªæ•´å‹æ•°å€¼ã€å‚è€ƒé“¾æ¥ã€‘\n            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);\n            mUsapPoolSocket =\n                    Zygote.createManagedSocketFromInitSocket(\n                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);\n        } else { //è¾… zygote\n            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);\n            mUsapPoolSocket =\n                    Zygote.createManagedSocketFromInitSocket(\n                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);\n        }\n\n        //è·å– éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  é…ç½®ï¼Œè¿˜æ˜¯é€šè¿‡ç³»ç»Ÿé…ç½® SystemPropertice è·å–\n        /*\n            mUsapPoolSizeMax â€”â€” usap_pool_size_max\n            mUsapPoolSizeMin â€”â€” usap_pool_size_min\n            mUsapPoolRefillThreshold â€”â€” usap_refill_threshold\n        */\n        fetchUsapPoolPolicyProps();\n    }\n}\n\n//æœ€é‡è¦çš„è¿˜æ˜¯è¿›å…¥ poll è½®è®­ã€å…³äºé«˜å¹¶å‘ IO å¤šè·¯å¤ç”¨ï¼Œå‚è€ƒé“¾æ¥ã€‘\nRunnable runSelectLoop(String abiList) {\n\n    while(true){\n        //æ¯ä¸€æ¬¡è½®è®­ä¸”è¶…è¿‡ä¸€åˆ†é’Ÿéƒ½æ›´æ–° USAP é…ç½®\n        fetchUsapPoolPolicyPropsWithMinInterval\n\n        //ç³»ç»Ÿè°ƒç”¨ poll å¤„ç†æ–‡ä»¶æè¿°ç¬¦ fd\n        //Os.poll è¿”å›å€¼0ï¼šè¡¨ç¤ºå¤„ç†è¶…æ—¶æˆ–éé˜»å¡çŠ¶æ€æ²¡æœ‰å¯å¤„ç†çš„æ–‡ä»¶æè¿°ç¬¦\n        pollReturnValue = Os.poll(pollFDs, pollTimeoutMs);\n        \n        ... etc\n        \n        //è¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯è¿”å›å€¼ï¼Œç±»å‹æ˜¯ Runnable\n        //è¿™æ˜¯åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å‘ç”Ÿé‡ç½® USAPï¼Œcommand çš„å†…å®¹æ˜¯ï¼š\n        /*\n            fetchUsapPoolPolicyPropsIfUnfetched();\n            ZygoteHooks.preFork();\n            ZygoteHooks.postForkCommon();\n        */\n        final Runnable command = fillUsapPool(sessionSocketRawFDs, isPriorityRefill);\n        if (command != null) {\n            return command;\n        }\n}\n```\n\n## åˆ›å»º SystemServer\n\n```cpp\n//ZygoteInit.java\n\n/*\n    abiList â€”â€” ndl filter\n    socketname â€”â€” zygote è¿›ç¨‹åç§°\n    zygoteServer â€”â€” è‡ªç„¶æ˜¯ zygote çš„ä¸»è¦æœåŠ¡\n*/\nprivate static Runnable forkSystemServer(String abiList, String socketName,\n                                             ZygoteServer zygoteServer) {\n    //å¯åŠ¨å‚æ•°\n    String[] args = {\n                \"--setuid=1000\", //linux ä¸­ä¸åŒ uid å¯ä»¥ä»£è¡¨æ‹¥æœ‰ä¸åŒçš„æƒé™\n                \"--setgid=1000\",\n                \"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,\"\n                        + \"1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012\",\n                \"--capabilities=\" + capabilities + \",\" + capabilities,\n                \"--nice-name=system_server\",\n                \"--runtime-args\",\n                \"--target-sdk-version=\" + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,\n                \"com.android.server.SystemServer\",\n     };\n     \n\n    //çœç•¥å‚æ•°æ„é€ è¿‡ç¨‹\n    ZygoteArguments parsedArgs;\n    \n    //åˆ›å»ºæœåŠ¡è¿›ç¨‹ï¼Œè¿˜æ˜¯è°ƒç”¨ native æ–¹æ³•\n    /*\n        int pid = nativeForkSystemServer(\n        uid, gid, gids, runtimeFlags, rlimits,\n        permittedCapabilities, effectiveCapabilities);\n    */\n    pid = Zygote.forkSystemServer(\n        parsedArgs.mUid, parsedArgs.mGid,\n        parsedArgs.mGids,\n        parsedArgs.mRuntimeFlags,\n        null,\n        parsedArgs.mPermittedCapabilities,\n        parsedArgs.mEffectiveCapabilities);\n     \n    /*\n        pid=0 åˆ™æ˜¯å­è¿›ç¨‹è¢«åˆ›å»º\n        pid=-1 åˆ™è¡¨ç¤ºå‡ºé”™\n        pid (é0å€¼)åˆ›å»ºçˆ¶è¿›ç¨‹\n    */\n    if (pid == 0) {\n        //ï¼Ÿï¼Ÿï¼Ÿè¿˜ä¼šæœ‰ç¬¬äºŒä¸ª zygote è¿›ç¨‹ï¼Œè¿™æ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿï¼Ÿï¼Ÿ\n        //çœ‹çœ‹å®˜æ–¹æè¿°ï¼šWe determine this by comparing the device ABI list with this zygotes list. \n        //            If this zygote supports all ABIs this device supports, there won't be another zygote.\n        if (hasSecondZygote(abiList)) {\n            waitForSecondaryZygote(socketName);\n        }\n\n        zygoteServer.closeServerSocket();\n        //ç»§ç»­æŠŠå‚æ•°åˆ†å‘ç»™ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œè¿™é‡Œåšçš„äº‹æƒ…æ¯”è¾ƒå¤šäº†\n        /*\n            1ã€è·å–ç³»ç»ŸæœåŠ¡ç±»è·¯å¾„ systemServerClassPathï¼Œé¦–å…ˆè¿˜æ˜¯ä»ç³»ç»Ÿç¯å¢ƒä¸­è¯»å–Os.getenv(\"SYSTEMSERVERCLASSPATH\")ï¼›å½“è¿›ç¨‹æ‰§è¡Œæ—¶ ART å°†ä¼šå¤„ç†æ­¤è·¯å¾„\n            2ã€è´Ÿè´£ zygote çš„ native åˆå§‹åŒ–å’Œ application çš„æ‰§è¡Œ\n            3ã€è¿™é‡Œæ— è®ºå…ˆèµ°é‚£ä¸ªåˆ†æ”¯ï¼Œåé¢éƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼šreturn RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,\n        classLoader);\n        \n            if (parsedArgs.mInvokeWith != null) {\n                WrapperInit.execApplication(parsedArgs.mInvokeWith,\n                        parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,\n                        VMRuntime.getCurrentInstructionSet(), null, args);\n            } else {\n                ClassLoader cl = getOrCreateSystemServerClassLoader();\n                return ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,\n                parsedArgs.mDisabledCompatChanges,\n                parsedArgs.mRemainingArgs, cl);\n            }\n        */\n        return handleSystemServerProcess(parsedArgs);\n    }\n}\n```\n\n```cpp\n//RuntimeInit.java\nprotected static Runnable applicationInit(int targetSdkVersion, long[] disabledCompatChanges,\n        String[] argv, ClassLoader classLoader) {\n\n    //è®¾ç½®è¿è¡Œç›®æ ‡ç‰ˆæœ¬\n    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);\n    //é€šè¿‡å¯åŠ¨ç±»åæ‰¾åˆ°æ­¤ç±»ï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½å¹¶è°ƒç”¨å…¶ main æ–¹æ³•\n    return findStaticMain(args.startClass, args.startArgs, classLoader);\n}\n```\n\n```cpp\n//RuntimeInit.java\nprotected static Runnable findStaticMain(String className, String[] argv,\n            ClassLoader classLoader) {\n  \n    //å¸¸è§„æ–¹æ³•ï¼Œåªæ˜¯æ‰§è¡Œ classloader\n    Class<?> cl = Class.forName(className, true, classLoader);\n    Method m = cl.getMethod(\"main\", new Class[] { String[].class });\n    \n        //å› ä¸ºå½“å‰æ˜¯åœ¨ zygote è¿›ç¨‹åˆ›å»º SystemServerï¼Œåœ¨æ­¤æµç¨‹ä¸­æœ¬æ¬¡æ‰§è¡Œæˆ‘ä»¬è®¤ä¸ºå‚æ•° className=\"com.android.internal.os.SystemServer\"\n    return new MethodAndArgsCaller(m, argv);\n}\n```\n\nåˆ°è¿™é‡Œ SystemServer å·²ç»åˆ›å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯é€šè¿‡ `MethodAndArgsCaller` æ–¹æ³•æ‰§è¡Œå…¶ä¸­çš„ `main` æ–¹æ³•ï¼Œæºç è·¯å¾„æ˜¯`/frameworks/base/services/java/com/android/server/SystemServer.java`ã€‚\n\n\n# é™„åŠ \n\n## å‚è€ƒé“¾æ¥\n\n- Androi.bpï¼šbp æ–‡ä»¶ï¼Œæ›¿æ¢ .mk çš„é…ç½®æ–‡ï¼Œç”± https://github.com/palantir/blueprint æ¡†æ¶è§£æ\n- Android.mkï¼šmk æ–‡ä»¶ï¼ŒAndroid ç¨‹åºç¼–è¯‘\n- lmkdï¼šlow memory killer deamon ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹\n- Apexï¼šAndroid pony express è§£å†³è¾ƒä½çº§åˆ«ç³»ç»Ÿæ¨¡å—çš„å®‰è£…æµç¨‹ https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn\n- syspro æ–‡ä»¶ï¼šç³»ç»Ÿå…±äº«ä¿¡æ¯çš„å±æ€§é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½œä¸ºç³»ç»Ÿ API å®ç° https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=ä¸€ä¸ª,Sysprop%20è¯´æ˜æ–‡ä»¶åŒ…å«ä¸€æ¡å±æ€§æ¶ˆæ¯ï¼Œç”¨æ¥æè¿°ä¸€ç»„å±æ€§%E3%80%82\n- ABIï¼šä¸ CPU æŒ‡ä»¤é›†ç›¸å…³ https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn\n- fd ï¼šæ–‡ä»¶æè¿°ç¬¦ https://www.cnblogs.com/cscshi/p/15705033.html\n- Linux IO å¤šè·¯å¤ç”¨ï¼šselectã€pollã€epoll https://cloud.tencent.com/developer/article/1005481\n- MTEï¼šmemory tagging extension  [ å†…å­˜æ ‡ç­¾æ‰©å±• ](https://cloud.tencent.com/developer/article/2003341#:~:text=Arm%20MTEï¼ˆå†…å­˜æ ‡è®°ï¼‰ä½œä¸ºArmv8.5æŒ‡ä»¤é›†çš„ä¸€éƒ¨åˆ†å¼•å…¥%E3%80%82%20MTEç°åœ¨å†…ç½®äºArm%20æœ€è¿‘å®£å¸ƒçš„ç¬¦åˆArmv9%20çš„%20CPU%20ä¸­ï¼Œä¾‹å¦‚,Cortex-X2ã€Cortex-A710%20å’ŒCortex-A510%E3%80%82%20æœªæ¥åŸºäºArmv9%20çš„%20CPU%20ä¹Ÿå°†é›†æˆ%20MTE%E3%80%82)\n- å·²åŠ æ ‡è®°æŒ‡é’ˆï¼šhttps://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn\n\n","source":"_posts/undefined/Androidç³»ç»Ÿå¯åŠ¨zgoteè¿›ç¨‹.md","raw":"---\ntitle: Android ç³»ç»Ÿ zygote \ncatalog: true\ndate: 2022-09-29 22:56:05\nsubtitle: ä¿—ç§° Java ä¸–ç•Œçš„é¼»ç¥–\nheader-img: /img/220928/android_zygot_bg.png\ntags: AOSP\nsticky: 7\ncategories:\n---\n\n\nç›¸å…³æ–‡ä»¶ï¼š\n\n- /system/core/init/init.cpp\n- /system/etc/init/hw/init.rc  (æºç å·¥ç¨‹æ²¡æ‰¾åˆ°ï¼Œæ˜¯ä»æ‰‹æœºä¸Šè·å–)\n- /system/etc/init/hw/init.zygote32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰\n- /system/etc/init/hw/init.zygote64_32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰\n- /system/core/init/action.cpp\n- /system/core/init/service.cpp\n- /system/core/init/service_list.cpp\n- frameworks/base/core/java/com/android/internal/os/ZygoteInit.java\n- frameworks/base/core/java/com/android/internal/os/ZygoteServer.java\n- frameworks/base/core/java/com/android/internal/os/Zygote.java\n- frameworks/base/core/java/com/android/internal/os/WrapperInit.java\n\n\n# è§£æåˆå§‹åŒ–é…ç½®æ–‡ä»¶ \n\nåˆå§‹åŒ–é…ç½®æ–‡ä»¶åŒ…æ‹¬ä½†ä¸é™äº init.rcã€hw/init.rcã€‚å¸¦ç€çš„ç–‘æƒ‘ç»§ç»­çœ‹æºç ï¼Œä¹‹å‰æåˆ°æ‰§è¡Œåˆ°åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µæ—¶ init è¿›ç¨‹è¿›å…¥æ— é™çš„è½®è¯¢ï¼ˆloopï¼‰ï¼Œä¼¼ä¹ä¸çŸ¥å»å‘ä½•å¤„ï¼Ÿç–‘æƒ‘æ˜¯åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯åå†åšå¤„ç†ï¼Œç¬¬äºŒé˜¶æ®µä¸­åˆ›å»º init è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°`LoadBootScripts(actionManager,serviceList)`ï¼ŒåŠ è½½å¯åŠ¨è„šæœ¬çš„å…³é”®ï¼Œç›¸å½“é‡è¦ï¼Œä¸`init.rc`æ–‡ä»¶å­˜åœ¨åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚\n\n```cpp\n//init.cpp\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //è§£æ init.rcï¼Œå¯åŠ¨çš„å…³é”®æ–‡ä»¶\n        parser.ParseConfig(\"/system/etc/init/hw/init.rc\");\n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n        \n        parser.ParseConfig(\"/system_ext/etc/init\");\n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            //vendor å‚å•†ç›¸å…³çš„åˆå§‹åŒ–é…ç½®\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n```cpp\n//init.cpp\nvoid SecondStageMain(){\n\n    //æ•°æ®è§£æè·å¾—ï¼Œå¼€å§‹æ„å»º action é˜Ÿåˆ—\n    ActionManager& am = ActionManager::GetInstance();\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    .... etc\n\n    //è§¦å‘å¯åŠ¨\n    am.QueueEventTrigger(\"init\");\n    \n    //è‹¥å¤„äºå……ç”µæ¨¡å¼å°†å»¶è¿Ÿåˆå§‹åŒ–\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        am.QueueEventTrigger(\"late-init\");\n    }\n    \n    //init è¿›ç¨‹è¿›å…¥æ— é™è½®è®­\n    while(true){\n        //å¼€å§‹é€šè¿‡ command å‘½ä»¤æ‰§è¡Œ inir.rc è„šæœ¬å„é¡¹æœåŠ¡ä»¥åŠåˆå§‹åŒ–\n        if (!(prop_waiter_state.MightBeWaiting() || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(prop_waiter_state.MightBeWaiting() || Service::is_exec_service_running())) {\n\n        // If there's more work to do, wake up again immediately.\n        if (am.HasMoreCommands())\n            epoll_timeout = 0ms;\n        }\n    }\n}\n```\n\nåœ¨ Android 11 ä¸Šï¼Œinit.rc æ–‡ä»¶ä½äº`/system/etc/init/hw/init.rc`\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92ab7d4ccd7a4118a1f705928d97c212~tplv-k3u1fbpfcp-watermark.image?)\n\nè¿™æ˜¯æˆ‘åœ¨å°ç±³æ‰‹æœºæ‰¾çš„ï¼Œrc æ–‡ä»¶è¢«è§†ä¸º Android åˆå§‹åŒ–è¯­è¨€ï¼Œé‚£è‚¯å®šä¹Ÿæœ‰è‡ªå·±çš„è¯­æ³•æˆ–æ ¼å¼ï¼Œå¯ä»¥å‚è€ƒï¼šhttps://www.cnblogs.com/gufanyuan/p/9350130.html\n\n**markï¼š**\n- action on åæºå¸¦ä¸€ç»„å‘½ä»¤\n- trigger è§¦å‘å™¨ï¼Œç¡®å®šä½•æ—¶æ‰§è¡Œå‘½ä»¤\n- service å½“ init é€€å‡ºæ—¶å¯åŠ¨æˆ–é‡å¯\n- options è¿›ä¸€æ­¥æ§åˆ¶å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å’Œæ—¶é—´\n- å‘½ä»¤ï¼šon æ¯ä¸€è¡Œä»£è¡¨ä¸€æ¡å‘½ä»¤\n- import å¯¼å…¥é¢å¤–çš„ rc æ–‡ä»¶éœ€è¦è§£æ\n\nçœ‹çœ‹ rc æ–‡ä»¶ï¼š\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0991aad99b524f9ebc147ce1fe075047~tplv-k3u1fbpfcp-watermark.image?)\n\n```cpp\n//  /system/etc/init/hw/init.rc\n# å°ç±³ç³»ç»Ÿï¼Œä¹Ÿæœ‰å‚å•†è‡ªå·±çš„è§£ææ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œå±äºè‡ªå·±çš„è¿›ç¨‹\n# import æŒ‡æ˜å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶éœ€è¦è§£æ\n# MIUI ADD:\nimport /init.miui.rc\n\n# è¿˜è®°å¾— SecondStageMain actionManage å—\n# am.QueueEventTrigger(\"early-init\");\non early-init\n    # ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç† uevent æ¶ˆæ¯\n    start ueventd\n    # apex æœåŠ¡äºç³»ç»Ÿæ¨¡å—å®‰è£…\n    exec_start apexd-bootstrap\n\n# è§¦å‘æ‰€æœ‰ action\n# am.QueueEventTrigger(\"init\");\non init\n    # åˆ›å»º stdio æ ‡å‡†è¾“å…¥è¾“å‡ºé“¾æ¥\n    symlink /proc/self/fd/0 /dev/stdin\n    # ç»™ sdcard æ›´æ”¹æƒé™\n    chmod 0770 /config/sdcardfs\n    \n    # å¯åŠ¨æœåŠ¡\n    # ç³»ç»ŸæœåŠ¡ï¼Œè¶Šæ¥è¶Šæ¥è¿‘åº”ç”¨å±‚äº†\n    start servicemanager\n    # hwâ€”â€”hardwareï¼Œç¡¬ä»¶æœåŠ¡\n    start hwservicemanager\n    #ä¾›åº”å•†æœåŠ¡\n    start vndservicemanager\n    # init action å°±æ‰§è¡Œåˆ°è¿™ï¼Œä¸­é—´çœç•¥å¾ˆå¤šå‘½ä»¤ï¼Œè¿™é‡Œåªæ˜¯æŠ½å–å‡ ä¸ªï¼Œç‚¹åˆ°ä¸ºæ­¢\n    \n# æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ ¸å¿ƒæœåŠ¡\n# am.QueueEventTrigger(\"late-init\");\non late-init\n    # è§¦å‘ fsï¼šVold æ§åˆ¶å’Œç®¡ç†å¤–éƒ¨å­˜å‚¨çš„è¿›ç¨‹\n    trigger early-fs\n\n    # é‡ç‚¹æ¥äº†âš ï¸âš ï¸âš ï¸\n    # import /system/etc/init/hw/init.${ro.zygote}.rc\n    # zygote è¿›æ¥äº†ï¼Œå¸¸è¯´çš„ Android åº”ç”¨å±‚çš„é¼»ç¥–\n    trigger zygote-start\n    \n    trigger early-boot\n    trigger boot\n\non boot\n    # å¯åŠ¨ HAL ç¡¬ä»¶æŠ½è±¡ç±»æœåŠ¡\n    class_start hal\n    # å¯åŠ¨æ ¸å¿ƒç±»æœåŠ¡\n    class_start core\n```\n\n# è§£æ zygote.rc\n\nçœ‹ä¸Šé¢æˆªå›¾ï¼Œç°åœ¨è¯¥æ‰§è¡Œ`init.zygote32.rcã€init.zygote64_32.rc`ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚\n```cpp\n//  /system/etc/init/hw/init.zygote32.rc\n// zygote32 : åªæœ‰ä¸€ä¸ª 32ï¼Œé‚£å°±æ˜¯çº¯çº¯çš„ä¸º 32 ä½å‡†å¤‡çš„\n\nservice zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n\n```\n\n```c++\n//  /system/etc/init/hw/init.zygote64_32.rc\n// zygote64_32 : å‰éƒ¨åˆ† 64 æŒ‡ä¸»è¦æ¨¡å¼ï¼Œåéƒ¨åˆ† 32 æŒ‡è¾…åŠ©æ¨¡å¼ï¼›åŒæ ·çš„ä¹Ÿä¼šæœ‰ zygote32_64.rcã€zygote32.rcã€zygote64.rc  etc.\n\n# service æ˜¯ Android åˆå§‹åŒ–è¯è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡ init å¯åŠ¨æˆ–é€€å‡ºæ—¶é‡æ–°å¯åŠ¨æœåŠ¡\n# æ˜¾ç„¶ï¼Œè¿™é‡Œçš„æœåŠ¡åç§°å°±æ˜¯â€˜å®¶å–»æˆ·æ™“â€™çš„ zygote è¿›ç¨‹\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote\n    class main\n    priority -20     ### è¿›ç¨‹ä¼˜å…ˆçº§ -20 ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå–å€¼èŒƒå›´ [-20,19]\n    user root        ### ç”± root ç”¨æˆ·æ‰§è¡Œ \n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    task_profiles ProcessCapacityHigh MaxPerformance\n\n# zygote_secondary ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ\n# ä½ åœ¨çœ‹å‰é¢æåˆ°çš„â€˜ä¸»æ¨¡å¼â€™å’Œâ€˜è¾…æ¨¡å¼â€™ï¼Œæ°å¥½ zygote æ˜¯ app_process64ï¼Œzygote_secondary æ˜¯ app_process32ï¼Œ\n# åˆšåˆšå¥½å¯¹åº”ä¸Šæ–‡ä»¶å init.zygote64_32.rc ã€ä¸»æ¨¡å¼æ˜¯64ï¼Œè¾…æ¨¡å¼æ˜¯32ã€‘\nservice zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote_secondary stream 660 root system\n    socket usap_pool_secondary stream 660 root system\n    onrestart restart zygote\n    task_profiles ProcessCapacityHigh MaxPerformance\n```\n\n# åˆ›å»º zygote Process\n\nåœ¨åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ SecondStageMain è§£æäº† inir.rcï¼Œå›åˆ° main.cpp çŸ¥é“ GetBuiltinFunctionMap å‡½æ•°æ˜ å°„è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥ SubcontextMainï¼Œç¬¬å››éƒ¨åˆ†å¼€å§‹æ‰§è¡Œï¼Œæ¥ç€çœ‹çœ‹æ‰§è¡Œæµç¨‹ã€‚\n\n```cpp\n//main.cpp\nreturn SubcontextMain(argc, argv, &function_map);\n\n//subcontext.cpp\nauto subcontext_process = SubcontextProcess(function_map, context, init_fd);\n\n//subcontext.cpp\nSubcontextProcess(const BuiltinFunctionMap* function_map, std::string context, int init_fd)\n: function_map_(function_map), context_(std::move(context)), init_fd_(init_fd){};\n//é€šè¿‡æ„é€ å‡½æ•°ï¼Œç›´æ¥å°†å‡½æ•°æ˜ å°„è¡¨èµ‹å€¼ç»™æˆå‘˜ function_map_\nconst BuiltinFunctionMap* function_map_;\n\n//åœ¨ SubcontextMain ä¸­å¼€å§‹ä¸»å¾ªç¯\nsubcontext_process.MainLoop();\n\n//ä¸»å¾ªç¯ä¸­å‡†å¤‡æ‰§è¡Œå‘½ä»¤\nRunCommand(subcontext_command.execute_command(), &reply);\n\n//æ˜ å°„è¡¨ function_map_ è¢«ä½¿ç”¨\n//æ ¹æ®å‚æ•°ï¼ˆå‘½ä»¤ï¼‰æŸ¥æ‰¾å¯¹åº”çš„å†…ç½®å‡½æ•°\nauto map_result = function_map_->Find(args);\n//æ‰¾åˆ°äº†å‘½ä»¤å‡†å¤‡æ‰§è¡Œ\nresult = RunBuiltinFunction(map_result->function, args, context_);\n\n//æ„é€ å‚æ•°ï¼Œç›´æ¥è°ƒç”¨\n//å›æƒ³ä¸€ä¸‹ï¼Œæ˜ å°„è¡¨ä¸­æ˜¯å¦æœ‰ç€ä¸€ä¸ª item\n//{\"class_start\", {1, 1, {false, do_class_start}}}\n//do_class_startï¼šå†…ç½®å‡½æ•°è¢«å£°æ˜åœ¨ builtins.cpp ä¸­ï¼Œä¸‹é¢çœ‹çœ‹å…¶å®ç°\nauto builtin_arguments = BuiltinArguments(context);\nreturn function(builtin_arguments);\n```\n\n```cpp\n//builtins.cpp\nstatic Result<void> do_class_start(const BuiltinArguments& args) {\n    if (android::base::GetBoolProperty(\"persist.init.dont_start_class.\" + args[1], false))\n        return {};\n    //æœåŠ¡å¯åŠ¨\n    /*\n        1ã€ServiceList::GetInstance() åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿å•Šï¼Ÿservice åˆ—è¡¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n    è¿˜è®°å¾—ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ– SecondStageMain ä¸­è¿™æ®µä»£ç å—\n    ServiceList& sm = ServiceList::GetInstance();\n    LoadBootScripts(am, sm); //è¿™æ­£æ˜¯åœ¨è§£æ init.rc æ–‡ä»¶ï¼Œå…¶ä¸­å°±åŒ…å« hw/init.rc\n    \n        2ã€å¯ä»¥è®¤ä¸º service å°±æ˜¯é€šè¿‡è§£æ init.rc ä¸­çš„ service è·å¾—çš„ï¼Œæ­¤æ–‡ä»¶æ­£å¥½ä¹Ÿå¯¼å…¥ import hw/init.rcï¼Œå…¶ä¸­åŒ…å« zygote ç›¸å…³ï¼Œ\n    è¿›è€Œç»§ç»­è§£æ init.zygote.rcï¼Œzygote.rc æ–‡ä»¶å†…å®¹ä¹Ÿä¼šè¢«è§£æåˆ°\n\nServiceList.GetInstance å°±æ˜¯ std::vector<std::unique_ptr<Service>> services_;\nservice->classenames() å°±æ˜¯ std::set<std::string> classnames_;\n    \n        3ã€åˆ›å»º Service çš„æ„é€ å‡½æ•°ï¼š\n    Service::Service(const std::string& name, unsigned flags, uid_t uid, gid_t gid,\n       const std::vector<gid_t>& supp_gids, int namespace_flags,\n       const std::string& seclabel, Subcontext* subcontext_for_restart_commands,\n       const std::vector<std::string>& args, bool from_apex)\n       :  name_(name),\n       classnames_({\"default\"}),\n        ... etc\n     ){}\n    \n    */\n\n    for (const auto& service : ServiceList::GetInstance()) {\n        //å‚æ•°çš„æ¥æº\n        /*\n            1ã€åå¤æŸ¥é˜…èµ„æ–™å¾—çŸ¥ args å°±æ˜¯ rc æ–‡ä»¶ä¸­æ¯ä¸ª service çš„å‚æ•°\n        args[1] è‡ªç„¶æ˜¯ç¬¬äºŒä¸ªå‚æ•°\n        çœ‹ hw/zygote.rc service æ‰§è¡Œ zygote å‘½ä»¤å‰éƒ¨åˆ†\n        ...\n        service zygote\n          class main\n          ...\n        \n            2ã€å› æ­¤ args[1] å…¶å®å°±æ˜¯ main\n        åŒæ ·ï¼Œæˆ‘ä»¬çœ‹ hw/init.usb.rc ä¹Ÿæœ‰ä¸€ä¸ª service\n        ...\n        service adbd\n           class core\n           ...   \n        adb çš„ä½¿ç”¨ä¸ adbd å¯æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œadbd æ˜¯ä¸€ä¸ªè¿œç¨‹æœåŠ¡è¿›ç¨‹\n        \n            3ã€æ‰€ä»¥è¿™é‡Œçš„æ„æ€æ˜¯ï¼š\n        æ ¹æ®å‚æ•°åç§°å»æœåŠ¡åˆ—è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæœåŠ¡å­˜åœ¨é‚£ä¹ˆå¼€å§‹æ‰§è¡Œ\n        æœåŠ¡ä¸€èˆ¬æ˜¯ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œä¸”å¾ˆæœ‰å¯èƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹\n        */\n        if (service->classnames().count(args[1])) {\n            if (auto result = service->StartIfNotDisabled(); !result.ok()) {\n                LOG(ERROR) << \"Could not start service '\" << service->name()\n                           << \"' as part of class '\" << args[1] << \"': \" << result.error();\n            }\n        }\n    }\n    return {};\n}\n\n//service.cpp\nResult<void> Service::StartIfNotDisabled() {\n    if (!(flags_ & SVC_DISABLED)) {\n        return Start();\n    } else {\n        flags_ |= SVC_DISABLED_START;\n    }\n    return {};\n}\n\n//service.cpp\nResult<void> Service::Start() {\n    \n    pid_t pid = -1;\n    if (namespaces_.flags) {\n        pid = clone(nullptr, nullptr, namespaces_.flags | SIGCHLD, nullptr);\n    } else {\n        //å°±è¿™ï¼Ÿè¿›ç¨‹å°±è¢« fork å‡ºæ¥äº†ï¼Ÿï¼Ÿï¼Ÿ\n        pid = fork();\n    }\n\n    // pid 0 æ˜¯ idle è¿›ç¨‹ï¼Œè‚¯å®šä¸èƒ½\n    if (pid == 0) {\n        umask(077);\n        RunService(override_mount_namespace, descriptors, std::move(pipefd));\n        _exit(127);\n    }\n    \n    //åˆ›å»ºè¿›ç¨‹ç»„\n    errno = -createProcessGroup(proc_attr_.uid, pid_, use_memcg);\n}\n```\n\nåˆ°æ­¤ï¼Œé€šè¿‡æŸ¥æ‰¾æœåŠ¡åˆ—è¡¨åˆ›å»ºäº†ä¸€å †è¿›ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸»è¦å…³æ³¨ `zygote`è¿›ç¨‹çš„åˆ›å»ºï¼Œè¿™æ—¶å€™é—´ä» cpp è¿›å…¥ Java\n\n# åˆå§‹åŒ– zygote\n## é¢„åŠ è½½é…ç½®\n\n```cpp\n//ZygoteInit.java\npublic class ZygoteInit {\n    /*\n     * åˆå§‹åŒ–ä¸»è¦åšï¼š\n     * 1ã€å®Œæˆé¢„åˆå§‹åŒ–\n     * 2ã€åˆ›å»º zygote æœåŠ¡\n     * 3ã€åˆ›å»ºç³»ç»ŸæœåŠ¡\n     */\n    public static void main(String[] argv) {\n        //ã€1ã€‘å®Œæˆé¢„åˆå§‹åŒ–\n        /*\n            1ã€è°ƒç”¨ ZygoteHooks.onBeginPreload(); ZygoteHooks ä» Dalvik åŒ…å¼•å…¥ï¼Œåœ¨ framework ä¸‹æ²¡æœ‰æ‰¾åˆ°çš„æºç åº”è¯¥æ˜¯åœ¨åˆ«å¤„äº†ï¼Œé¢„æƒ³æ˜¯å¯¹ Dalvik çš„åˆå§‹åŒ–ï¼›é¢„åŠ è½½ç»“æŸæ—¶ä¹Ÿä¼šè°ƒç”¨ ZygoteHooks.onEndPreload();\n            2ã€VMRuntime ä¸º Dalvik é¢„åŠ è½½è·¯å¾„ä¸‹çš„ç±» /system/etc/preloaded-classesã€profilebootclasspath\n            3ã€åˆ›å»ºå¹¶ç¼“å­˜éå¯åŠ¨ç±»è·¯å¾„ä¸‹çš„ç±»åŠ è½½å™¨ /system/framework/android.hidl.base-V1.0-java.jarã€/system/framework/android.hidl.manager-V1.0-java.jar (HIDL æ¥å£å®šä¹‰è¯­è¨€ â€”â€” https://source.android.google.cn/devices/architecture/hidl?hl=zh-cn)\n            4ã€åŠ è½½èµ„æºï¼ŒåŠ è½½å‰å…ˆæ›´æ–°é…ç½®ï¼ˆæ¯”å¦‚å½“å‰è®¾å¤‡åˆ†è¾¨ç‡ã€å±å¹•å°ºå¯¸ã€è¯­è¨€ï¼‰ï¼Œ\n        æ ¹æ®åˆ†è¾¨ç‡åŠ è½½ drawableã€é¢œè‰²èµ„æº\n            5ã€é€šè¿‡ native åŠ è½½ä¸ºåº”ç”¨è¿›ç¨‹å‡†å¤‡çš„ HAL ç¡¬ä»¶æŠ½è±¡åˆ—è¡¨\n            6ã€å¦‚æœå¼€å¯äº† ro.zygote.disable_gl_preloadï¼Œä¹Ÿé€šè¿‡ native æ‰§è¡Œå›¾å½¢ GL é¢„åŠ è½½\n            7ã€é€šè¿‡ System.loadLibrary åŠ è½½å…±äº«åº“ android.libã€compiler_rt.libã€jnigraphics.lib\n            8ã€å‡†å¤‡ Hyphenator ç¯å¢ƒï¼Œç¼“å­˜å­—ä½“\n            9ã€åŠ è½½ webviewchromium_loader.libï¼Œå‡†å¤‡ webview \n            10ã€é€šè¿‡ AndroidKeyStoreProvider å®‰è£… keystore å†…å®¹æä¾›è€…  \n        */\n        preload(bootTimingsTraceLog);\n        \n        //åˆå§‹åŒ– GCï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†\n        ZygoteHooks.gcAndFinalize()ï¼›\n        //åˆ°è¿™é‡Œ zygote å·²ç»æ˜¯ã€åˆå§‹åŒ–å®Œæ¯•ã€‘\n        Zygote.initNativeState(isPrimaryZygote)\n        \n        //ã€2ã€‘åˆ›å»º zygote æœåŠ¡\n        ZygoteServer zygoteServer = null;\n        zygoteServer = new ZygoteServer(isPrimaryZygote);\n        \n        //ã€3ã€‘åˆ›å»ºç³»ç»ŸæœåŠ¡\n        if (startSystemServer) {\n            //forkï¼Œå¯è§æ¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼›ABI â€”â€” Application binary interfaceã€å‚è€ƒé“¾æ¥ã€‘\n            //åœ¨ Android é¡¹ç›®ä¸­å¯¹åº”çš„å°±æ˜¯ ndk filterï¼Œå¦‚ arm64ã€x86  .etc\n            //ä¸ºæ”¯æŒä¸åŒå¹³å°ï¼Œndk filter æ˜¯èƒ½å¤Ÿé…ç½®å¤šä¸ªçš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼å­˜åœ¨\n            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);\n            if (r != null) {\n                //åˆ›å»ºä¹‹åé©¬ä¸Šè¿è¡Œ\n                return;\n            }\n         }\n         \n        // zygote æœåŠ¡è¿›å…¥è‡ªå·±çš„ä¸–ç•Œè½®è®­\n        caller = zygoteServer.runSelectLoop(abiList);\n        if(caller != null){\n            caller.run();\n        }\n    }\n}\n```\n\n## åˆ›å»º zygoteServer\n\næœåŠ¡ä¸»è¦è¿˜æ˜¯é€šè¿‡ socket å®ç°ï¼Œç­‰å¾…æ¥è‡ª Linuxã€unix å®ˆæŠ¤è¿›ç¨‹ (socket) çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å­è¿›ç¨‹çš„åˆ›å»ºã€‚\n\n```cpp\n//ZygoteServer.java\nclass ZygoteServer {\n\n//åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„æˆå‘˜\n//ç”¨äºç›‘å¬ socket è¿æ¥\nprivate LocalServerSocket mZygoteSocket;\n//ä¸º USAP éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  æœåŠ¡\nprivate final LocalServerSocket mUsapPoolSocket;\n\nZygoteServer(boolean isPrimaryZygote) {\n        //é€šè¿‡ native è°ƒç”¨è·å–\n        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();\n        \n        //ä¸» zygote\n        if (isPrimaryZygote) {\n            //å®Œæˆçš„ socket åç§°éœ€è¦å’Œ ANDROID_SOCKET_ + socketname æ‹¼æ¥ï¼Œ\n            //ç„¶åæ‹¿å®Œæ•´çš„åç§°å»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾è·å–æ–‡ä»¶æè¿°ç¬¦ fd â€”â€” file describeï¼Œå®é™…æ˜¯ä¸€ä¸ªæ•´å‹æ•°å€¼ã€å‚è€ƒé“¾æ¥ã€‘\n            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);\n            mUsapPoolSocket =\n                    Zygote.createManagedSocketFromInitSocket(\n                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);\n        } else { //è¾… zygote\n            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);\n            mUsapPoolSocket =\n                    Zygote.createManagedSocketFromInitSocket(\n                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);\n        }\n\n        //è·å– éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  é…ç½®ï¼Œè¿˜æ˜¯é€šè¿‡ç³»ç»Ÿé…ç½® SystemPropertice è·å–\n        /*\n            mUsapPoolSizeMax â€”â€” usap_pool_size_max\n            mUsapPoolSizeMin â€”â€” usap_pool_size_min\n            mUsapPoolRefillThreshold â€”â€” usap_refill_threshold\n        */\n        fetchUsapPoolPolicyProps();\n    }\n}\n\n//æœ€é‡è¦çš„è¿˜æ˜¯è¿›å…¥ poll è½®è®­ã€å…³äºé«˜å¹¶å‘ IO å¤šè·¯å¤ç”¨ï¼Œå‚è€ƒé“¾æ¥ã€‘\nRunnable runSelectLoop(String abiList) {\n\n    while(true){\n        //æ¯ä¸€æ¬¡è½®è®­ä¸”è¶…è¿‡ä¸€åˆ†é’Ÿéƒ½æ›´æ–° USAP é…ç½®\n        fetchUsapPoolPolicyPropsWithMinInterval\n\n        //ç³»ç»Ÿè°ƒç”¨ poll å¤„ç†æ–‡ä»¶æè¿°ç¬¦ fd\n        //Os.poll è¿”å›å€¼0ï¼šè¡¨ç¤ºå¤„ç†è¶…æ—¶æˆ–éé˜»å¡çŠ¶æ€æ²¡æœ‰å¯å¤„ç†çš„æ–‡ä»¶æè¿°ç¬¦\n        pollReturnValue = Os.poll(pollFDs, pollTimeoutMs);\n        \n        ... etc\n        \n        //è¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯è¿”å›å€¼ï¼Œç±»å‹æ˜¯ Runnable\n        //è¿™æ˜¯åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å‘ç”Ÿé‡ç½® USAPï¼Œcommand çš„å†…å®¹æ˜¯ï¼š\n        /*\n            fetchUsapPoolPolicyPropsIfUnfetched();\n            ZygoteHooks.preFork();\n            ZygoteHooks.postForkCommon();\n        */\n        final Runnable command = fillUsapPool(sessionSocketRawFDs, isPriorityRefill);\n        if (command != null) {\n            return command;\n        }\n}\n```\n\n## åˆ›å»º SystemServer\n\n```cpp\n//ZygoteInit.java\n\n/*\n    abiList â€”â€” ndl filter\n    socketname â€”â€” zygote è¿›ç¨‹åç§°\n    zygoteServer â€”â€” è‡ªç„¶æ˜¯ zygote çš„ä¸»è¦æœåŠ¡\n*/\nprivate static Runnable forkSystemServer(String abiList, String socketName,\n                                             ZygoteServer zygoteServer) {\n    //å¯åŠ¨å‚æ•°\n    String[] args = {\n                \"--setuid=1000\", //linux ä¸­ä¸åŒ uid å¯ä»¥ä»£è¡¨æ‹¥æœ‰ä¸åŒçš„æƒé™\n                \"--setgid=1000\",\n                \"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,\"\n                        + \"1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012\",\n                \"--capabilities=\" + capabilities + \",\" + capabilities,\n                \"--nice-name=system_server\",\n                \"--runtime-args\",\n                \"--target-sdk-version=\" + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,\n                \"com.android.server.SystemServer\",\n     };\n     \n\n    //çœç•¥å‚æ•°æ„é€ è¿‡ç¨‹\n    ZygoteArguments parsedArgs;\n    \n    //åˆ›å»ºæœåŠ¡è¿›ç¨‹ï¼Œè¿˜æ˜¯è°ƒç”¨ native æ–¹æ³•\n    /*\n        int pid = nativeForkSystemServer(\n        uid, gid, gids, runtimeFlags, rlimits,\n        permittedCapabilities, effectiveCapabilities);\n    */\n    pid = Zygote.forkSystemServer(\n        parsedArgs.mUid, parsedArgs.mGid,\n        parsedArgs.mGids,\n        parsedArgs.mRuntimeFlags,\n        null,\n        parsedArgs.mPermittedCapabilities,\n        parsedArgs.mEffectiveCapabilities);\n     \n    /*\n        pid=0 åˆ™æ˜¯å­è¿›ç¨‹è¢«åˆ›å»º\n        pid=-1 åˆ™è¡¨ç¤ºå‡ºé”™\n        pid (é0å€¼)åˆ›å»ºçˆ¶è¿›ç¨‹\n    */\n    if (pid == 0) {\n        //ï¼Ÿï¼Ÿï¼Ÿè¿˜ä¼šæœ‰ç¬¬äºŒä¸ª zygote è¿›ç¨‹ï¼Œè¿™æ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿï¼Ÿï¼Ÿ\n        //çœ‹çœ‹å®˜æ–¹æè¿°ï¼šWe determine this by comparing the device ABI list with this zygotes list. \n        //            If this zygote supports all ABIs this device supports, there won't be another zygote.\n        if (hasSecondZygote(abiList)) {\n            waitForSecondaryZygote(socketName);\n        }\n\n        zygoteServer.closeServerSocket();\n        //ç»§ç»­æŠŠå‚æ•°åˆ†å‘ç»™ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œè¿™é‡Œåšçš„äº‹æƒ…æ¯”è¾ƒå¤šäº†\n        /*\n            1ã€è·å–ç³»ç»ŸæœåŠ¡ç±»è·¯å¾„ systemServerClassPathï¼Œé¦–å…ˆè¿˜æ˜¯ä»ç³»ç»Ÿç¯å¢ƒä¸­è¯»å–Os.getenv(\"SYSTEMSERVERCLASSPATH\")ï¼›å½“è¿›ç¨‹æ‰§è¡Œæ—¶ ART å°†ä¼šå¤„ç†æ­¤è·¯å¾„\n            2ã€è´Ÿè´£ zygote çš„ native åˆå§‹åŒ–å’Œ application çš„æ‰§è¡Œ\n            3ã€è¿™é‡Œæ— è®ºå…ˆèµ°é‚£ä¸ªåˆ†æ”¯ï¼Œåé¢éƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼šreturn RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,\n        classLoader);\n        \n            if (parsedArgs.mInvokeWith != null) {\n                WrapperInit.execApplication(parsedArgs.mInvokeWith,\n                        parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,\n                        VMRuntime.getCurrentInstructionSet(), null, args);\n            } else {\n                ClassLoader cl = getOrCreateSystemServerClassLoader();\n                return ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,\n                parsedArgs.mDisabledCompatChanges,\n                parsedArgs.mRemainingArgs, cl);\n            }\n        */\n        return handleSystemServerProcess(parsedArgs);\n    }\n}\n```\n\n```cpp\n//RuntimeInit.java\nprotected static Runnable applicationInit(int targetSdkVersion, long[] disabledCompatChanges,\n        String[] argv, ClassLoader classLoader) {\n\n    //è®¾ç½®è¿è¡Œç›®æ ‡ç‰ˆæœ¬\n    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);\n    //é€šè¿‡å¯åŠ¨ç±»åæ‰¾åˆ°æ­¤ç±»ï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½å¹¶è°ƒç”¨å…¶ main æ–¹æ³•\n    return findStaticMain(args.startClass, args.startArgs, classLoader);\n}\n```\n\n```cpp\n//RuntimeInit.java\nprotected static Runnable findStaticMain(String className, String[] argv,\n            ClassLoader classLoader) {\n  \n    //å¸¸è§„æ–¹æ³•ï¼Œåªæ˜¯æ‰§è¡Œ classloader\n    Class<?> cl = Class.forName(className, true, classLoader);\n    Method m = cl.getMethod(\"main\", new Class[] { String[].class });\n    \n        //å› ä¸ºå½“å‰æ˜¯åœ¨ zygote è¿›ç¨‹åˆ›å»º SystemServerï¼Œåœ¨æ­¤æµç¨‹ä¸­æœ¬æ¬¡æ‰§è¡Œæˆ‘ä»¬è®¤ä¸ºå‚æ•° className=\"com.android.internal.os.SystemServer\"\n    return new MethodAndArgsCaller(m, argv);\n}\n```\n\nåˆ°è¿™é‡Œ SystemServer å·²ç»åˆ›å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯é€šè¿‡ `MethodAndArgsCaller` æ–¹æ³•æ‰§è¡Œå…¶ä¸­çš„ `main` æ–¹æ³•ï¼Œæºç è·¯å¾„æ˜¯`/frameworks/base/services/java/com/android/server/SystemServer.java`ã€‚\n\n\n# é™„åŠ \n\n## å‚è€ƒé“¾æ¥\n\n- Androi.bpï¼šbp æ–‡ä»¶ï¼Œæ›¿æ¢ .mk çš„é…ç½®æ–‡ï¼Œç”± https://github.com/palantir/blueprint æ¡†æ¶è§£æ\n- Android.mkï¼šmk æ–‡ä»¶ï¼ŒAndroid ç¨‹åºç¼–è¯‘\n- lmkdï¼šlow memory killer deamon ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹\n- Apexï¼šAndroid pony express è§£å†³è¾ƒä½çº§åˆ«ç³»ç»Ÿæ¨¡å—çš„å®‰è£…æµç¨‹ https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn\n- syspro æ–‡ä»¶ï¼šç³»ç»Ÿå…±äº«ä¿¡æ¯çš„å±æ€§é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½œä¸ºç³»ç»Ÿ API å®ç° https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=ä¸€ä¸ª,Sysprop%20è¯´æ˜æ–‡ä»¶åŒ…å«ä¸€æ¡å±æ€§æ¶ˆæ¯ï¼Œç”¨æ¥æè¿°ä¸€ç»„å±æ€§%E3%80%82\n- ABIï¼šä¸ CPU æŒ‡ä»¤é›†ç›¸å…³ https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn\n- fd ï¼šæ–‡ä»¶æè¿°ç¬¦ https://www.cnblogs.com/cscshi/p/15705033.html\n- Linux IO å¤šè·¯å¤ç”¨ï¼šselectã€pollã€epoll https://cloud.tencent.com/developer/article/1005481\n- MTEï¼šmemory tagging extension  [ å†…å­˜æ ‡ç­¾æ‰©å±• ](https://cloud.tencent.com/developer/article/2003341#:~:text=Arm%20MTEï¼ˆå†…å­˜æ ‡è®°ï¼‰ä½œä¸ºArmv8.5æŒ‡ä»¤é›†çš„ä¸€éƒ¨åˆ†å¼•å…¥%E3%80%82%20MTEç°åœ¨å†…ç½®äºArm%20æœ€è¿‘å®£å¸ƒçš„ç¬¦åˆArmv9%20çš„%20CPU%20ä¸­ï¼Œä¾‹å¦‚,Cortex-X2ã€Cortex-A710%20å’ŒCortex-A510%E3%80%82%20æœªæ¥åŸºäºArmv9%20çš„%20CPU%20ä¹Ÿå°†é›†æˆ%20MTE%E3%80%82)\n- å·²åŠ æ ‡è®°æŒ‡é’ˆï¼šhttps://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn\n\n","slug":"Androidç³»ç»Ÿå¯åŠ¨zgoteè¿›ç¨‹","published":1,"lang":"undefined","updated":"2022-09-29T14:56:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignso000agaqp6pb183u7","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p>ç›¸å…³æ–‡ä»¶ï¼š</p>\n<ul>\n<li>/system/core/init/init.cpp</li>\n<li>/system/etc/init/hw/init.rc  (æºç å·¥ç¨‹æ²¡æ‰¾åˆ°ï¼Œæ˜¯ä»æ‰‹æœºä¸Šè·å–)</li>\n<li>/system/etc/init/hw/init.zygote32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰</li>\n<li>/system/etc/init/hw/init.zygote64_32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰</li>\n<li>/system/core/init/action.cpp</li>\n<li>/system/core/init/service.cpp</li>\n<li>/system/core/init/service_list.cpp</li>\n<li>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/Zygote.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/WrapperInit.java</li>\n</ul>\n<h1>è§£æåˆå§‹åŒ–é…ç½®æ–‡ä»¶</h1>\n<p>åˆå§‹åŒ–é…ç½®æ–‡ä»¶åŒ…æ‹¬ä½†ä¸é™äº init.rcã€hw/init.rcã€‚å¸¦ç€çš„ç–‘æƒ‘ç»§ç»­çœ‹æºç ï¼Œä¹‹å‰æåˆ°æ‰§è¡Œåˆ°åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µæ—¶ init è¿›ç¨‹è¿›å…¥æ— é™çš„è½®è¯¢ï¼ˆloopï¼‰ï¼Œä¼¼ä¹ä¸çŸ¥å»å‘ä½•å¤„ï¼Ÿç–‘æƒ‘æ˜¯åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯åå†åšå¤„ç†ï¼Œç¬¬äºŒé˜¶æ®µä¸­åˆ›å»º init è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°<code>LoadBootScripts(actionManager,serviceList)</code>ï¼ŒåŠ è½½å¯åŠ¨è„šæœ¬çš„å…³é”®ï¼Œç›¸å½“é‡è¦ï¼Œä¸<code>init.rc</code>æ–‡ä»¶å­˜åœ¨åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = <span class=\"built_in\">CreateParser</span>(action_manager, service_list);</span><br><span class=\"line\">    std::string bootscript = <span class=\"built_in\">GetProperty</span>(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.<span class=\"built_in\">empty</span>()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//è§£æ init.rcï¼Œå¯åŠ¨çš„å…³é”®æ–‡ä»¶</span></span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system/etc/init/hw/init.rc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system_ext/etc/init&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//vendor å‚å•†ç›¸å…³çš„åˆå§‹åŒ–é…ç½®</span></span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ•°æ®è§£æè·å¾—ï¼Œå¼€å§‹æ„å»º action é˜Ÿåˆ—</span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::<span class=\"built_in\">GetInstance</span>();</span><br><span class=\"line\">    am.<span class=\"built_in\">QueueBuiltinAction</span>(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    .... etc</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è§¦å‘å¯åŠ¨</span></span><br><span class=\"line\">    am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è‹¥å¤„äºå……ç”µæ¨¡å¼å°†å»¶è¿Ÿåˆå§‹åŒ–</span></span><br><span class=\"line\">    std::string bootmode = <span class=\"built_in\">GetProperty</span>(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//init è¿›ç¨‹è¿›å…¥æ— é™è½®è®­</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¼€å§‹é€šè¿‡ command å‘½ä»¤æ‰§è¡Œ inir.rc è„šæœ¬å„é¡¹æœåŠ¡ä»¥åŠåˆå§‹åŒ–</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(prop_waiter_state.<span class=\"built_in\">MightBeWaiting</span>() || Service::<span class=\"built_in\">is_exec_service_running</span>())) &#123;</span><br><span class=\"line\">            am.<span class=\"built_in\">ExecuteOneCommand</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(prop_waiter_state.<span class=\"built_in\">MightBeWaiting</span>() || Service::<span class=\"built_in\">is_exec_service_running</span>())) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// If there&#x27;s more work to do, wake up again immediately.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (am.<span class=\"built_in\">HasMoreCommands</span>())</span><br><span class=\"line\">            epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åœ¨ Android 11 ä¸Šï¼Œinit.rc æ–‡ä»¶ä½äº<code>/system/etc/init/hw/init.rc</code></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92ab7d4ccd7a4118a1f705928d97c212~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>è¿™æ˜¯æˆ‘åœ¨å°ç±³æ‰‹æœºæ‰¾çš„ï¼Œrc æ–‡ä»¶è¢«è§†ä¸º Android åˆå§‹åŒ–è¯­è¨€ï¼Œé‚£è‚¯å®šä¹Ÿæœ‰è‡ªå·±çš„è¯­æ³•æˆ–æ ¼å¼ï¼Œå¯ä»¥å‚è€ƒï¼š<a href=\"https://www.cnblogs.com/gufanyuan/p/9350130.html\">https://www.cnblogs.com/gufanyuan/p/9350130.html</a></p>\n<p><strong>markï¼š</strong></p>\n<ul>\n<li>action on åæºå¸¦ä¸€ç»„å‘½ä»¤</li>\n<li>trigger è§¦å‘å™¨ï¼Œç¡®å®šä½•æ—¶æ‰§è¡Œå‘½ä»¤</li>\n<li>service å½“ init é€€å‡ºæ—¶å¯åŠ¨æˆ–é‡å¯</li>\n<li>options è¿›ä¸€æ­¥æ§åˆ¶å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å’Œæ—¶é—´</li>\n<li>å‘½ä»¤ï¼šon æ¯ä¸€è¡Œä»£è¡¨ä¸€æ¡å‘½ä»¤</li>\n<li>import å¯¼å…¥é¢å¤–çš„ rc æ–‡ä»¶éœ€è¦è§£æ</li>\n</ul>\n<p>çœ‹çœ‹ rc æ–‡ä»¶ï¼š</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0991aad99b524f9ebc147ce1fe075047~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.rc</span></span><br><span class=\"line\"># å°ç±³ç³»ç»Ÿï¼Œä¹Ÿæœ‰å‚å•†è‡ªå·±çš„è§£ææ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œå±äºè‡ªå·±çš„è¿›ç¨‹</span><br><span class=\"line\"><span class=\"meta\"># import æŒ‡æ˜å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶éœ€è¦è§£æ</span></span><br><span class=\"line\"># MIUI ADD:</span><br><span class=\"line\"><span class=\"keyword\">import</span> /init.miui.rc</span><br><span class=\"line\"></span><br><span class=\"line\"># è¿˜è®°å¾— SecondStageMain actionManage å—</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;early-init&quot;</span>);</span></span><br><span class=\"line\">on early-init</span><br><span class=\"line\">    # ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç† uevent æ¶ˆæ¯</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\">    <span class=\"meta\"># apex æœåŠ¡äºç³»ç»Ÿæ¨¡å—å®‰è£…</span></span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\"># è§¦å‘æ‰€æœ‰ action</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;init&quot;</span>);</span></span><br><span class=\"line\">on init</span><br><span class=\"line\">    # åˆ›å»º stdio æ ‡å‡†è¾“å…¥è¾“å‡ºé“¾æ¥</span><br><span class=\"line\">    symlink /proc/self/fd/<span class=\"number\">0</span> /dev/stdin</span><br><span class=\"line\">    # ç»™ sdcard æ›´æ”¹æƒé™</span><br><span class=\"line\">    chmod <span class=\"number\">0770</span> /config/sdcardfs</span><br><span class=\"line\">    </span><br><span class=\"line\">    # å¯åŠ¨æœåŠ¡</span><br><span class=\"line\">    # ç³»ç»ŸæœåŠ¡ï¼Œè¶Šæ¥è¶Šæ¥è¿‘åº”ç”¨å±‚äº†</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    <span class=\"meta\"># hwâ€”â€”hardwareï¼Œç¡¬ä»¶æœåŠ¡</span></span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    #ä¾›åº”å•†æœåŠ¡</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\">    <span class=\"meta\"># init action å°±æ‰§è¡Œåˆ°è¿™ï¼Œä¸­é—´çœç•¥å¾ˆå¤šå‘½ä»¤ï¼Œè¿™é‡Œåªæ˜¯æŠ½å–å‡ ä¸ªï¼Œç‚¹åˆ°ä¸ºæ­¢</span></span><br><span class=\"line\">    </span><br><span class=\"line\"># æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ ¸å¿ƒæœåŠ¡</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;late-init&quot;</span>);</span></span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    # è§¦å‘ fsï¼šVold æ§åˆ¶å’Œç®¡ç†å¤–éƒ¨å­˜å‚¨çš„è¿›ç¨‹</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\"></span><br><span class=\"line\">    # é‡ç‚¹æ¥äº†âš ï¸âš ï¸âš ï¸</span><br><span class=\"line\">    <span class=\"meta\"># import /system/etc/init/hw/init.$&#123;ro.zygote&#125;.rc</span></span><br><span class=\"line\">    <span class=\"meta\"># zygote è¿›æ¥äº†ï¼Œå¸¸è¯´çš„ Android åº”ç”¨å±‚çš„é¼»ç¥–</span></span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\">    </span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br><span class=\"line\"></span><br><span class=\"line\">on boot</span><br><span class=\"line\">    # å¯åŠ¨ HAL ç¡¬ä»¶æŠ½è±¡ç±»æœåŠ¡</span><br><span class=\"line\">    class_start hal</span><br><span class=\"line\">    # å¯åŠ¨æ ¸å¿ƒç±»æœåŠ¡</span><br><span class=\"line\">    class_start core</span><br></pre></td></tr></table></figure>\n<h1>è§£æ zygote.rc</h1>\n<p>çœ‹ä¸Šé¢æˆªå›¾ï¼Œç°åœ¨è¯¥æ‰§è¡Œ<code>init.zygote32.rcã€init.zygote64_32.rc</code>ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.zygote32.rc</span></span><br><span class=\"line\"><span class=\"comment\">// zygote32 : åªæœ‰ä¸€ä¸ª 32ï¼Œé‚£å°±æ˜¯çº¯çº¯çš„ä¸º 32 ä½å‡†å¤‡çš„</span></span><br><span class=\"line\"></span><br><span class=\"line\">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">priority</span> -20</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">user</span> <span class=\"title\">root</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">group</span> <span class=\"title\">root</span> <span class=\"title\">readproc</span> <span class=\"title\">reserved_disk</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">socket</span> <span class=\"title\">zygote</span> <span class=\"title\">stream</span> 660 <span class=\"title\">root</span> <span class=\"title\">system</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">socket</span> <span class=\"title\">usap_pool_primary</span> <span class=\"title\">stream</span> 660 <span class=\"title\">root</span> <span class=\"title\">system</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">exec_background</span> - <span class=\"title\">system</span> <span class=\"title\">system</span> -- /<span class=\"title\">system</span>/<span class=\"title\">bin</span>/<span class=\"title\">vdc</span> <span class=\"title\">volume</span> <span class=\"title\">abort_fuse</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">write</span> /<span class=\"title\">sys</span>/<span class=\"title\">power</span>/<span class=\"title\">state</span> <span class=\"title\">on</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">audioserver</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">cameraserver</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">media</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">netd</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">wificond</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">writepid</span> /<span class=\"title\">dev</span>/<span class=\"title\">cpuset</span>/<span class=\"title\">foreground</span>/<span class=\"title\">tasks</span></span></span><br><span class=\"line\"><span class=\"class\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.zygote64_32.rc</span></span><br><span class=\"line\"><span class=\"comment\">// zygote64_32 : å‰éƒ¨åˆ† 64 æŒ‡ä¸»è¦æ¨¡å¼ï¼Œåéƒ¨åˆ† 32 æŒ‡è¾…åŠ©æ¨¡å¼ï¼›åŒæ ·çš„ä¹Ÿä¼šæœ‰ zygote32_64.rcã€zygote32.rcã€zygote64.rc  etc.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># service æ˜¯ Android åˆå§‹åŒ–è¯è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡ init å¯åŠ¨æˆ–é€€å‡ºæ—¶é‡æ–°å¯åŠ¨æœåŠ¡</span></span><br><span class=\"line\"># æ˜¾ç„¶ï¼Œè¿™é‡Œçš„æœåŠ¡åç§°å°±æ˜¯â€˜å®¶å–»æˆ·æ™“â€™çš„ zygote è¿›ç¨‹</span><br><span class=\"line\">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority <span class=\"number\">-20</span>     ### è¿›ç¨‹ä¼˜å…ˆçº§ <span class=\"number\">-20</span> ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå–å€¼èŒƒå›´ [<span class=\"number\">-20</span>,<span class=\"number\">19</span>]</span><br><span class=\"line\">    user root        ### ç”± root ç”¨æˆ·æ‰§è¡Œ </span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    socket usap_pool_primary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse</span><br><span class=\"line\">    onrestart write /sys/power/state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    task_profiles ProcessCapacityHigh MaxPerformance</span><br><span class=\"line\"></span><br><span class=\"line\"># zygote_secondary ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span><br><span class=\"line\"># ä½ åœ¨çœ‹å‰é¢æåˆ°çš„â€˜ä¸»æ¨¡å¼â€™å’Œâ€˜è¾…æ¨¡å¼â€™ï¼Œæ°å¥½ zygote æ˜¯ app_process64ï¼Œzygote_secondary æ˜¯ app_process32ï¼Œ</span><br><span class=\"line\"># åˆšåˆšå¥½å¯¹åº”ä¸Šæ–‡ä»¶å init.zygote64_32.rc ã€ä¸»æ¨¡å¼æ˜¯<span class=\"number\">64</span>ï¼Œè¾…æ¨¡å¼æ˜¯<span class=\"number\">32</span>ã€‘</span><br><span class=\"line\">service zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority <span class=\"number\">-20</span></span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote_secondary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    socket usap_pool_secondary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    task_profiles ProcessCapacityHigh MaxPerformance</span><br></pre></td></tr></table></figure>\n<h1>åˆ›å»º zygote Process</h1>\n<p>åœ¨åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ SecondStageMain è§£æäº† inir.rcï¼Œå›åˆ° main.cpp çŸ¥é“ GetBuiltinFunctionMap å‡½æ•°æ˜ å°„è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥ SubcontextMainï¼Œç¬¬å››éƒ¨åˆ†å¼€å§‹æ‰§è¡Œï¼Œæ¥ç€çœ‹çœ‹æ‰§è¡Œæµç¨‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> subcontext_process = <span class=\"built_in\">SubcontextProcess</span>(function_map, context, init_fd);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"built_in\">SubcontextProcess</span>(<span class=\"keyword\">const</span> BuiltinFunctionMap* function_map, std::string context, <span class=\"keyword\">int</span> init_fd)</span><br><span class=\"line\">: <span class=\"built_in\">function_map_</span>(function_map), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">init_fd_</span>(init_fd)&#123;&#125;;</span><br><span class=\"line\"><span class=\"comment\">//é€šè¿‡æ„é€ å‡½æ•°ï¼Œç›´æ¥å°†å‡½æ•°æ˜ å°„è¡¨èµ‹å€¼ç»™æˆå‘˜ function_map_</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> BuiltinFunctionMap* function_map_;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//åœ¨ SubcontextMain ä¸­å¼€å§‹ä¸»å¾ªç¯</span></span><br><span class=\"line\">subcontext_process.<span class=\"built_in\">MainLoop</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//ä¸»å¾ªç¯ä¸­å‡†å¤‡æ‰§è¡Œå‘½ä»¤</span></span><br><span class=\"line\"><span class=\"built_in\">RunCommand</span>(subcontext_command.<span class=\"built_in\">execute_command</span>(), &amp;reply);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ˜ å°„è¡¨ function_map_ è¢«ä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">//æ ¹æ®å‚æ•°ï¼ˆå‘½ä»¤ï¼‰æŸ¥æ‰¾å¯¹åº”çš„å†…ç½®å‡½æ•°</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> map_result = function_map_-&gt;<span class=\"built_in\">Find</span>(args);</span><br><span class=\"line\"><span class=\"comment\">//æ‰¾åˆ°äº†å‘½ä»¤å‡†å¤‡æ‰§è¡Œ</span></span><br><span class=\"line\">result = <span class=\"built_in\">RunBuiltinFunction</span>(map_result-&gt;function, args, context_);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ„é€ å‚æ•°ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class=\"line\"><span class=\"comment\">//å›æƒ³ä¸€ä¸‹ï¼Œæ˜ å°„è¡¨ä¸­æ˜¯å¦æœ‰ç€ä¸€ä¸ª item</span></span><br><span class=\"line\"><span class=\"comment\">//&#123;&quot;class_start&quot;, &#123;1, 1, &#123;false, do_class_start&#125;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">//do_class_startï¼šå†…ç½®å‡½æ•°è¢«å£°æ˜åœ¨ builtins.cpp ä¸­ï¼Œä¸‹é¢çœ‹çœ‹å…¶å®ç°</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> builtin_arguments = <span class=\"built_in\">BuiltinArguments</span>(context);</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">function</span>(builtin_arguments);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//builtins.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">do_class_start</span><span class=\"params\">(<span class=\"keyword\">const</span> BuiltinArguments&amp; args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (android::base::<span class=\"built_in\">GetBoolProperty</span>(<span class=\"string\">&quot;persist.init.dont_start_class.&quot;</span> + args[<span class=\"number\">1</span>], <span class=\"literal\">false</span>))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">    <span class=\"comment\">//æœåŠ¡å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ServiceList::GetInstance() åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿å•Šï¼Ÿservice åˆ—è¡¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">    è¿˜è®°å¾—ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ– SecondStageMain ä¸­è¿™æ®µä»£ç å—</span></span><br><span class=\"line\"><span class=\"comment\">    ServiceList&amp; sm = ServiceList::GetInstance();</span></span><br><span class=\"line\"><span class=\"comment\">    LoadBootScripts(am, sm); //è¿™æ­£æ˜¯åœ¨è§£æ init.rc æ–‡ä»¶ï¼Œå…¶ä¸­å°±åŒ…å« hw/init.rc</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¯ä»¥è®¤ä¸º service å°±æ˜¯é€šè¿‡è§£æ init.rc ä¸­çš„ service è·å¾—çš„ï¼Œæ­¤æ–‡ä»¶æ­£å¥½ä¹Ÿå¯¼å…¥ import hw/init.rcï¼Œå…¶ä¸­åŒ…å« zygote ç›¸å…³ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">    è¿›è€Œç»§ç»­è§£æ init.zygote.rcï¼Œzygote.rc æ–‡ä»¶å†…å®¹ä¹Ÿä¼šè¢«è§£æåˆ°</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">ServiceList.GetInstance å°±æ˜¯ std::vector&lt;std::unique_ptr&lt;Service&gt;&gt; services_;</span></span><br><span class=\"line\"><span class=\"comment\">service-&gt;classenames() å°±æ˜¯ std::set&lt;std::string&gt; classnames_;</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">        3ã€åˆ›å»º Service çš„æ„é€ å‡½æ•°ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">    Service::Service(const std::string&amp; name, unsigned flags, uid_t uid, gid_t gid,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::vector&lt;gid_t&gt;&amp; supp_gids, int namespace_flags,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::string&amp; seclabel, Subcontext* subcontext_for_restart_commands,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::vector&lt;std::string&gt;&amp; args, bool from_apex)</span></span><br><span class=\"line\"><span class=\"comment\">       :  name_(name),</span></span><br><span class=\"line\"><span class=\"comment\">       classnames_(&#123;&quot;default&quot;&#125;),</span></span><br><span class=\"line\"><span class=\"comment\">        ... etc</span></span><br><span class=\"line\"><span class=\"comment\">     )&#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; service : ServiceList::<span class=\"built_in\">GetInstance</span>()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å‚æ•°çš„æ¥æº</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€åå¤æŸ¥é˜…èµ„æ–™å¾—çŸ¥ args å°±æ˜¯ rc æ–‡ä»¶ä¸­æ¯ä¸ª service çš„å‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">        args[1] è‡ªç„¶æ˜¯ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">        çœ‹ hw/zygote.rc service æ‰§è¡Œ zygote å‘½ä»¤å‰éƒ¨åˆ†</span></span><br><span class=\"line\"><span class=\"comment\">        ...</span></span><br><span class=\"line\"><span class=\"comment\">        service zygote</span></span><br><span class=\"line\"><span class=\"comment\">          class main</span></span><br><span class=\"line\"><span class=\"comment\">          ...</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            2ã€å› æ­¤ args[1] å…¶å®å°±æ˜¯ main</span></span><br><span class=\"line\"><span class=\"comment\">        åŒæ ·ï¼Œæˆ‘ä»¬çœ‹ hw/init.usb.rc ä¹Ÿæœ‰ä¸€ä¸ª service</span></span><br><span class=\"line\"><span class=\"comment\">        ...</span></span><br><span class=\"line\"><span class=\"comment\">        service adbd</span></span><br><span class=\"line\"><span class=\"comment\">           class core</span></span><br><span class=\"line\"><span class=\"comment\">           ...   </span></span><br><span class=\"line\"><span class=\"comment\">        adb çš„ä½¿ç”¨ä¸ adbd å¯æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œadbd æ˜¯ä¸€ä¸ªè¿œç¨‹æœåŠ¡è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æ‰€ä»¥è¿™é‡Œçš„æ„æ€æ˜¯ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">        æ ¹æ®å‚æ•°åç§°å»æœåŠ¡åˆ—è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæœåŠ¡å­˜åœ¨é‚£ä¹ˆå¼€å§‹æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">        æœåŠ¡ä¸€èˆ¬æ˜¯ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œä¸”å¾ˆæœ‰å¯èƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service-&gt;<span class=\"built_in\">classnames</span>().<span class=\"built_in\">count</span>(args[<span class=\"number\">1</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = service-&gt;<span class=\"built_in\">StartIfNotDisabled</span>(); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">                <span class=\"built_in\">LOG</span>(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not start service &#x27;&quot;</span> &lt;&lt; service-&gt;<span class=\"built_in\">name</span>()</span><br><span class=\"line\">                           &lt;&lt; <span class=\"string\">&quot;&#x27; as part of class &#x27;&quot;</span> &lt;&lt; args[<span class=\"number\">1</span>] &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//service.cpp</span></span><br><span class=\"line\"><span class=\"function\">Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">Service::StartIfNotDisabled</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_DISABLED)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">Start</span>();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        flags_ |= SVC_DISABLED_START;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//service.cpp</span></span><br><span class=\"line\"><span class=\"function\">Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">Service::Start</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">pid_t</span> pid = <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (namespaces_.flags) &#123;</span><br><span class=\"line\">        pid = <span class=\"built_in\">clone</span>(<span class=\"literal\">nullptr</span>, <span class=\"literal\">nullptr</span>, namespaces_.flags | SIGCHLD, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å°±è¿™ï¼Ÿè¿›ç¨‹å°±è¢« fork å‡ºæ¥äº†ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        pid = fork();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// pid 0 æ˜¯ idle è¿›ç¨‹ï¼Œè‚¯å®šä¸èƒ½</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">umask</span>(<span class=\"number\">077</span>);</span><br><span class=\"line\">        <span class=\"built_in\">RunService</span>(override_mount_namespace, descriptors, std::<span class=\"built_in\">move</span>(pipefd));</span><br><span class=\"line\">        _exit(<span class=\"number\">127</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºè¿›ç¨‹ç»„</span></span><br><span class=\"line\">    errno = -<span class=\"built_in\">createProcessGroup</span>(proc_attr_.uid, pid_, use_memcg);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆ°æ­¤ï¼Œé€šè¿‡æŸ¥æ‰¾æœåŠ¡åˆ—è¡¨åˆ›å»ºäº†ä¸€å †è¿›ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>zygote</code>è¿›ç¨‹çš„åˆ›å»ºï¼Œè¿™æ—¶å€™é—´ä» cpp è¿›å…¥ Java</p>\n<h1>åˆå§‹åŒ– zygote</h1>\n<h2 id=\"é¢„åŠ è½½é…ç½®\">é¢„åŠ è½½é…ç½®</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteInit.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ZygoteInit</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * åˆå§‹åŒ–ä¸»è¦åšï¼š</span></span><br><span class=\"line\"><span class=\"comment\">     * 1ã€å®Œæˆé¢„åˆå§‹åŒ–</span></span><br><span class=\"line\"><span class=\"comment\">     * 2ã€åˆ›å»º zygote æœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">     * 3ã€åˆ›å»ºç³»ç»ŸæœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] argv)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//ã€1ã€‘å®Œæˆé¢„åˆå§‹åŒ–</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€è°ƒç”¨ ZygoteHooks.onBeginPreload(); ZygoteHooks ä» Dalvik åŒ…å¼•å…¥ï¼Œåœ¨ framework ä¸‹æ²¡æœ‰æ‰¾åˆ°çš„æºç åº”è¯¥æ˜¯åœ¨åˆ«å¤„äº†ï¼Œé¢„æƒ³æ˜¯å¯¹ Dalvik çš„åˆå§‹åŒ–ï¼›é¢„åŠ è½½ç»“æŸæ—¶ä¹Ÿä¼šè°ƒç”¨ ZygoteHooks.onEndPreload();</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€VMRuntime ä¸º Dalvik é¢„åŠ è½½è·¯å¾„ä¸‹çš„ç±» /system/etc/preloaded-classesã€profilebootclasspath</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€åˆ›å»ºå¹¶ç¼“å­˜éå¯åŠ¨ç±»è·¯å¾„ä¸‹çš„ç±»åŠ è½½å™¨ /system/framework/android.hidl.base-V1.0-java.jarã€/system/framework/android.hidl.manager-V1.0-java.jar (HIDL æ¥å£å®šä¹‰è¯­è¨€ â€”â€” https://source.android.google.cn/devices/architecture/hidl?hl=zh-cn)</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€åŠ è½½èµ„æºï¼ŒåŠ è½½å‰å…ˆæ›´æ–°é…ç½®ï¼ˆæ¯”å¦‚å½“å‰è®¾å¤‡åˆ†è¾¨ç‡ã€å±å¹•å°ºå¯¸ã€è¯­è¨€ï¼‰ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">        æ ¹æ®åˆ†è¾¨ç‡åŠ è½½ drawableã€é¢œè‰²èµ„æº</span></span><br><span class=\"line\"><span class=\"comment\">            5ã€é€šè¿‡ native åŠ è½½ä¸ºåº”ç”¨è¿›ç¨‹å‡†å¤‡çš„ HAL ç¡¬ä»¶æŠ½è±¡åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">            6ã€å¦‚æœå¼€å¯äº† ro.zygote.disable_gl_preloadï¼Œä¹Ÿé€šè¿‡ native æ‰§è¡Œå›¾å½¢ GL é¢„åŠ è½½</span></span><br><span class=\"line\"><span class=\"comment\">            7ã€é€šè¿‡ System.loadLibrary åŠ è½½å…±äº«åº“ android.libã€compiler_rt.libã€jnigraphics.lib</span></span><br><span class=\"line\"><span class=\"comment\">            8ã€å‡†å¤‡ Hyphenator ç¯å¢ƒï¼Œç¼“å­˜å­—ä½“</span></span><br><span class=\"line\"><span class=\"comment\">            9ã€åŠ è½½ webviewchromium_loader.libï¼Œå‡†å¤‡ webview </span></span><br><span class=\"line\"><span class=\"comment\">            10ã€é€šè¿‡ AndroidKeyStoreProvider å®‰è£… keystore å†…å®¹æä¾›è€…  </span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"built_in\">preload</span>(bootTimingsTraceLog);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//åˆå§‹åŒ– GCï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†</span></span><br><span class=\"line\">        ZygoteHooks.<span class=\"built_in\">gcAndFinalize</span>()ï¼›</span><br><span class=\"line\">        <span class=\"comment\">//åˆ°è¿™é‡Œ zygote å·²ç»æ˜¯ã€åˆå§‹åŒ–å®Œæ¯•ã€‘</span></span><br><span class=\"line\">        Zygote.<span class=\"built_in\">initNativeState</span>(isPrimaryZygote)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€2ã€‘åˆ›å»º zygote æœåŠ¡</span></span><br><span class=\"line\">        ZygoteServer zygoteServer = null;</span><br><span class=\"line\">        zygoteServer = <span class=\"keyword\">new</span> <span class=\"built_in\">ZygoteServer</span>(isPrimaryZygote);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€3ã€‘åˆ›å»ºç³»ç»ŸæœåŠ¡</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startSystemServer) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//forkï¼Œå¯è§æ¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼›ABI â€”â€” Application binary interfaceã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">            <span class=\"comment\">//åœ¨ Android é¡¹ç›®ä¸­å¯¹åº”çš„å°±æ˜¯ ndk filterï¼Œå¦‚ arm64ã€x86  .etc</span></span><br><span class=\"line\">            <span class=\"comment\">//ä¸ºæ”¯æŒä¸åŒå¹³å°ï¼Œndk filter æ˜¯èƒ½å¤Ÿé…ç½®å¤šä¸ªçš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼å­˜åœ¨</span></span><br><span class=\"line\">            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r != null) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//åˆ›å»ºä¹‹åé©¬ä¸Šè¿è¡Œ</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         </span><br><span class=\"line\">        <span class=\"comment\">// zygote æœåŠ¡è¿›å…¥è‡ªå·±çš„ä¸–ç•Œè½®è®­</span></span><br><span class=\"line\">        caller = zygoteServer.<span class=\"built_in\">runSelectLoop</span>(abiList);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(caller != null)&#123;</span><br><span class=\"line\">            caller.<span class=\"built_in\">run</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆ›å»º-zygoteServer\">åˆ›å»º zygoteServer</h2>\n<p>æœåŠ¡ä¸»è¦è¿˜æ˜¯é€šè¿‡ socket å®ç°ï¼Œç­‰å¾…æ¥è‡ª Linuxã€unix å®ˆæŠ¤è¿›ç¨‹ (socket) çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å­è¿›ç¨‹çš„åˆ›å»ºã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteServer.java</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ZygoteServer</span> &#123;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„æˆå‘˜</span></span><br><span class=\"line\"><span class=\"comment\">//ç”¨äºç›‘å¬ socket è¿æ¥</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> LocalServerSocket mZygoteSocket;</span><br><span class=\"line\"><span class=\"comment\">//ä¸º USAP éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  æœåŠ¡</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LocalServerSocket mUsapPoolSocket;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ZygoteServer</span>(boolean isPrimaryZygote) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//é€šè¿‡ native è°ƒç”¨è·å–</span></span><br><span class=\"line\">        mUsapPoolEventFD = Zygote.<span class=\"built_in\">getUsapPoolEventFD</span>();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ä¸» zygote</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isPrimaryZygote) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//å®Œæˆçš„ socket åç§°éœ€è¦å’Œ ANDROID_SOCKET_ + socketname æ‹¼æ¥ï¼Œ</span></span><br><span class=\"line\">            <span class=\"comment\">//ç„¶åæ‹¿å®Œæ•´çš„åç§°å»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾è·å–æ–‡ä»¶æè¿°ç¬¦ fd â€”â€” file describeï¼Œå®é™…æ˜¯ä¸€ä¸ªæ•´å‹æ•°å€¼ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">            mZygoteSocket = Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">            mUsapPoolSocket =</span><br><span class=\"line\">                    Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(</span><br><span class=\"line\">                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//è¾… zygote</span></span><br><span class=\"line\">            mZygoteSocket = Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(Zygote.SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">            mUsapPoolSocket =</span><br><span class=\"line\">                    Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(</span><br><span class=\"line\">                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//è·å– éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  é…ç½®ï¼Œè¿˜æ˜¯é€šè¿‡ç³»ç»Ÿé…ç½® SystemPropertice è·å–</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolSizeMax â€”â€” usap_pool_size_max</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolSizeMin â€”â€” usap_pool_size_min</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolRefillThreshold â€”â€” usap_refill_threshold</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"built_in\">fetchUsapPoolPolicyProps</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æœ€é‡è¦çš„è¿˜æ˜¯è¿›å…¥ poll è½®è®­ã€å…³äºé«˜å¹¶å‘ IO å¤šè·¯å¤ç”¨ï¼Œå‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\"><span class=\"function\">Runnable <span class=\"title\">runSelectLoop</span><span class=\"params\">(String abiList)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//æ¯ä¸€æ¬¡è½®è®­ä¸”è¶…è¿‡ä¸€åˆ†é’Ÿéƒ½æ›´æ–° USAP é…ç½®</span></span><br><span class=\"line\">        fetchUsapPoolPolicyPropsWithMinInterval</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//ç³»ç»Ÿè°ƒç”¨ poll å¤„ç†æ–‡ä»¶æè¿°ç¬¦ fd</span></span><br><span class=\"line\">        <span class=\"comment\">//Os.poll è¿”å›å€¼0ï¼šè¡¨ç¤ºå¤„ç†è¶…æ—¶æˆ–éé˜»å¡çŠ¶æ€æ²¡æœ‰å¯å¤„ç†çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class=\"line\">        pollReturnValue = Os.<span class=\"built_in\">poll</span>(pollFDs, pollTimeoutMs);</span><br><span class=\"line\">        </span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯è¿”å›å€¼ï¼Œç±»å‹æ˜¯ Runnable</span></span><br><span class=\"line\">        <span class=\"comment\">//è¿™æ˜¯åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å‘ç”Ÿé‡ç½® USAPï¼Œcommand çš„å†…å®¹æ˜¯ï¼š</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            fetchUsapPoolPolicyPropsIfUnfetched();</span></span><br><span class=\"line\"><span class=\"comment\">            ZygoteHooks.preFork();</span></span><br><span class=\"line\"><span class=\"comment\">            ZygoteHooks.postForkCommon();</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Runnable command = <span class=\"built_in\">fillUsapPool</span>(sessionSocketRawFDs, isPriorityRefill);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (command != null) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> command;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆ›å»º-SystemServer\">åˆ›å»º SystemServer</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteInit.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    abiList â€”â€” ndl filter</span></span><br><span class=\"line\"><span class=\"comment\">    socketname â€”â€” zygote è¿›ç¨‹åç§°</span></span><br><span class=\"line\"><span class=\"comment\">    zygoteServer â€”â€” è‡ªç„¶æ˜¯ zygote çš„ä¸»è¦æœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">forkSystemServer</span><span class=\"params\">(String abiList, String socketName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                             ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å‚æ•°</span></span><br><span class=\"line\">    String[] args = &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;--setuid=1000&quot;</span>, <span class=\"comment\">//linux ä¸­ä¸åŒ uid å¯ä»¥ä»£è¡¨æ‹¥æœ‰ä¸åŒçš„æƒé™</span></span><br><span class=\"line\">                <span class=\"string\">&quot;--setgid=1000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&quot;</span></span><br><span class=\"line\">                        + <span class=\"string\">&quot;1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--capabilities=&quot;</span> + capabilities + <span class=\"string\">&quot;,&quot;</span> + capabilities,</span><br><span class=\"line\">                <span class=\"string\">&quot;--nice-name=system_server&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--runtime-args&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--target-sdk-version=&quot;</span> + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class=\"line\">                <span class=\"string\">&quot;com.android.server.SystemServer&quot;</span>,</span><br><span class=\"line\">     &#125;;</span><br><span class=\"line\">     </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœç•¥å‚æ•°æ„é€ è¿‡ç¨‹</span></span><br><span class=\"line\">    ZygoteArguments parsedArgs;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºæœåŠ¡è¿›ç¨‹ï¼Œè¿˜æ˜¯è°ƒç”¨ native æ–¹æ³•</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        int pid = nativeForkSystemServer(</span></span><br><span class=\"line\"><span class=\"comment\">        uid, gid, gids, runtimeFlags, rlimits,</span></span><br><span class=\"line\"><span class=\"comment\">        permittedCapabilities, effectiveCapabilities);</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    pid = Zygote.forkSystemServer(</span><br><span class=\"line\">        parsedArgs.mUid, parsedArgs.mGid,</span><br><span class=\"line\">        parsedArgs.mGids,</span><br><span class=\"line\">        parsedArgs.mRuntimeFlags,</span><br><span class=\"line\">        null,</span><br><span class=\"line\">        parsedArgs.mPermittedCapabilities,</span><br><span class=\"line\">        parsedArgs.mEffectiveCapabilities);</span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        pid=0 åˆ™æ˜¯å­è¿›ç¨‹è¢«åˆ›å»º</span></span><br><span class=\"line\"><span class=\"comment\">        pid=-1 åˆ™è¡¨ç¤ºå‡ºé”™</span></span><br><span class=\"line\"><span class=\"comment\">        pid (é0å€¼)åˆ›å»ºçˆ¶è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ï¼Ÿï¼Ÿï¼Ÿè¿˜ä¼šæœ‰ç¬¬äºŒä¸ª zygote è¿›ç¨‹ï¼Œè¿™æ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"comment\">//çœ‹çœ‹å®˜æ–¹æè¿°ï¼šWe determine this by comparing the device ABI list with this zygotes list. </span></span><br><span class=\"line\">        <span class=\"comment\">//            If this zygote supports all ABIs this device supports, there won&#x27;t be another zygote.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">hasSecondZygote</span>(abiList)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">waitForSecondaryZygote</span>(socketName);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        zygoteServer.<span class=\"built_in\">closeServerSocket</span>();</span><br><span class=\"line\">        <span class=\"comment\">//ç»§ç»­æŠŠå‚æ•°åˆ†å‘ç»™ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œè¿™é‡Œåšçš„äº‹æƒ…æ¯”è¾ƒå¤šäº†</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€è·å–ç³»ç»ŸæœåŠ¡ç±»è·¯å¾„ systemServerClassPathï¼Œé¦–å…ˆè¿˜æ˜¯ä»ç³»ç»Ÿç¯å¢ƒä¸­è¯»å–Os.getenv(&quot;SYSTEMSERVERCLASSPATH&quot;)ï¼›å½“è¿›ç¨‹æ‰§è¡Œæ—¶ ART å°†ä¼šå¤„ç†æ­¤è·¯å¾„</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€è´Ÿè´£ zygote çš„ native åˆå§‹åŒ–å’Œ application çš„æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€è¿™é‡Œæ— è®ºå…ˆèµ°é‚£ä¸ªåˆ†æ”¯ï¼Œåé¢éƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼šreturn RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,</span></span><br><span class=\"line\"><span class=\"comment\">        classLoader);</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            if (parsedArgs.mInvokeWith != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                WrapperInit.execApplication(parsedArgs.mInvokeWith,</span></span><br><span class=\"line\"><span class=\"comment\">                        parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,</span></span><br><span class=\"line\"><span class=\"comment\">                        VMRuntime.getCurrentInstructionSet(), null, args);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125; else &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                ClassLoader cl = getOrCreateSystemServerClassLoader();</span></span><br><span class=\"line\"><span class=\"comment\">                return ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span></span><br><span class=\"line\"><span class=\"comment\">                parsedArgs.mDisabledCompatChanges,</span></span><br><span class=\"line\"><span class=\"comment\">                parsedArgs.mRemainingArgs, cl);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">handleSystemServerProcess</span>(parsedArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RuntimeInit.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">applicationInit</span><span class=\"params\">(<span class=\"keyword\">int</span> targetSdkVersion, <span class=\"keyword\">long</span>[] disabledCompatChanges,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String[] argv, ClassLoader classLoader)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è®¾ç½®è¿è¡Œç›®æ ‡ç‰ˆæœ¬</span></span><br><span class=\"line\">    VMRuntime.<span class=\"built_in\">getRuntime</span>().<span class=\"built_in\">setTargetSdkVersion</span>(targetSdkVersion);</span><br><span class=\"line\">    <span class=\"comment\">//é€šè¿‡å¯åŠ¨ç±»åæ‰¾åˆ°æ­¤ç±»ï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½å¹¶è°ƒç”¨å…¶ main æ–¹æ³•</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">findStaticMain</span>(args.startClass, args.startArgs, classLoader);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RuntimeInit.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">findStaticMain</span><span class=\"params\">(String className, String[] argv,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">//å¸¸è§„æ–¹æ³•ï¼Œåªæ˜¯æ‰§è¡Œ classloader</span></span><br><span class=\"line\">    Class&lt;?&gt; cl = Class.forName(className, <span class=\"literal\">true</span>, classLoader);</span><br><span class=\"line\">    Method m = cl.<span class=\"built_in\">getMethod</span>(<span class=\"string\">&quot;main&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123; String[].class &#125;);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">//å› ä¸ºå½“å‰æ˜¯åœ¨ zygote è¿›ç¨‹åˆ›å»º SystemServerï¼Œåœ¨æ­¤æµç¨‹ä¸­æœ¬æ¬¡æ‰§è¡Œæˆ‘ä»¬è®¤ä¸ºå‚æ•° className=&quot;com.android.internal.os.SystemServer&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">MethodAndArgsCaller</span>(m, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆ°è¿™é‡Œ SystemServer å·²ç»åˆ›å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯é€šè¿‡ <code>MethodAndArgsCaller</code> æ–¹æ³•æ‰§è¡Œå…¶ä¸­çš„ <code>main</code> æ–¹æ³•ï¼Œæºç è·¯å¾„æ˜¯<code>/frameworks/base/services/java/com/android/server/SystemServer.java</code>ã€‚</p>\n<h1>é™„åŠ </h1>\n<h2 id=\"å‚è€ƒé“¾æ¥\">å‚è€ƒé“¾æ¥</h2>\n<ul>\n<li>Androi.bpï¼šbp æ–‡ä»¶ï¼Œæ›¿æ¢ .mk çš„é…ç½®æ–‡ï¼Œç”± <a href=\"https://github.com/palantir/blueprint\">https://github.com/palantir/blueprint</a> æ¡†æ¶è§£æ</li>\n<li><a href=\"http://Android.mk\">Android.mk</a>ï¼šmk æ–‡ä»¶ï¼ŒAndroid ç¨‹åºç¼–è¯‘</li>\n<li>lmkdï¼šlow memory killer deamon ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹</li>\n<li>Apexï¼šAndroid pony express è§£å†³è¾ƒä½çº§åˆ«ç³»ç»Ÿæ¨¡å—çš„å®‰è£…æµç¨‹ <a href=\"https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn\">https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn</a></li>\n<li>syspro æ–‡ä»¶ï¼šç³»ç»Ÿå…±äº«ä¿¡æ¯çš„å±æ€§é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½œä¸ºç³»ç»Ÿ API å®ç° <a href=\"https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=%E4%B8%80%E4%B8%AA,Sysprop%20%E8%AF%B4%E6%98%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%B8%80%E6%9D%A1%E5%B1%9E%E6%80%A7%E6%B6%88%E6%81%AF%EF%BC%8C%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0%E4%B8%80%E7%BB%84%E5%B1%9E%E6%80%A7%E3%80%82\">https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=ä¸€ä¸ª,Sysprop è¯´æ˜æ–‡ä»¶åŒ…å«ä¸€æ¡å±æ€§æ¶ˆæ¯ï¼Œç”¨æ¥æè¿°ä¸€ç»„å±æ€§ã€‚</a></li>\n<li>ABIï¼šä¸ CPU æŒ‡ä»¤é›†ç›¸å…³ <a href=\"https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn\">https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn</a></li>\n<li>fd ï¼šæ–‡ä»¶æè¿°ç¬¦ <a href=\"https://www.cnblogs.com/cscshi/p/15705033.html\">https://www.cnblogs.com/cscshi/p/15705033.html</a></li>\n<li>Linux IO å¤šè·¯å¤ç”¨ï¼šselectã€pollã€epoll <a href=\"https://cloud.tencent.com/developer/article/1005481\">https://cloud.tencent.com/developer/article/1005481</a></li>\n<li>MTEï¼šmemory tagging extension  <a href=\"https://cloud.tencent.com/developer/article/2003341#:~:text=Arm%20MTE%EF%BC%88%E5%86%85%E5%AD%98%E6%A0%87%E8%AE%B0%EF%BC%89%E4%BD%9C%E4%B8%BAArmv8.5%E6%8C%87%E4%BB%A4%E9%9B%86%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%E5%BC%95%E5%85%A5%E3%80%82%20MTE%E7%8E%B0%E5%9C%A8%E5%86%85%E7%BD%AE%E4%BA%8EArm%20%E6%9C%80%E8%BF%91%E5%AE%A3%E5%B8%83%E7%9A%84%E7%AC%A6%E5%90%88Armv9%20%E7%9A%84%20CPU%20%E4%B8%AD%EF%BC%8C%E4%BE%8B%E5%A6%82,Cortex-X2%E3%80%81Cortex-A710%20%E5%92%8CCortex-A510%E3%80%82%20%E6%9C%AA%E6%9D%A5%E5%9F%BA%E4%BA%8EArmv9%20%E7%9A%84%20CPU%20%E4%B9%9F%E5%B0%86%E9%9B%86%E6%88%90%20MTE%E3%80%82\"> å†…å­˜æ ‡ç­¾æ‰©å±• </a></li>\n<li>å·²åŠ æ ‡è®°æŒ‡é’ˆï¼š<a href=\"https://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn\">https://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>ç›¸å…³æ–‡ä»¶ï¼š</p>\n<ul>\n<li>/system/core/init/init.cpp</li>\n<li>/system/etc/init/hw/init.rc  (æºç å·¥ç¨‹æ²¡æ‰¾åˆ°ï¼Œæ˜¯ä»æ‰‹æœºä¸Šè·å–)</li>\n<li>/system/etc/init/hw/init.zygote32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰</li>\n<li>/system/etc/init/hw/init.zygote64_32.rc ï¼ˆæ‰‹æœºä¸Šè·å–ï¼‰</li>\n<li>/system/core/init/action.cpp</li>\n<li>/system/core/init/service.cpp</li>\n<li>/system/core/init/service_list.cpp</li>\n<li>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/Zygote.java</li>\n<li>frameworks/base/core/java/com/android/internal/os/WrapperInit.java</li>\n</ul>\n<h1>è§£æåˆå§‹åŒ–é…ç½®æ–‡ä»¶</h1>\n<p>åˆå§‹åŒ–é…ç½®æ–‡ä»¶åŒ…æ‹¬ä½†ä¸é™äº init.rcã€hw/init.rcã€‚å¸¦ç€çš„ç–‘æƒ‘ç»§ç»­çœ‹æºç ï¼Œä¹‹å‰æåˆ°æ‰§è¡Œåˆ°åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µæ—¶ init è¿›ç¨‹è¿›å…¥æ— é™çš„è½®è¯¢ï¼ˆloopï¼‰ï¼Œä¼¼ä¹ä¸çŸ¥å»å‘ä½•å¤„ï¼Ÿç–‘æƒ‘æ˜¯åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯åå†åšå¤„ç†ï¼Œç¬¬äºŒé˜¶æ®µä¸­åˆ›å»º init è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°<code>LoadBootScripts(actionManager,serviceList)</code>ï¼ŒåŠ è½½å¯åŠ¨è„šæœ¬çš„å…³é”®ï¼Œç›¸å½“é‡è¦ï¼Œä¸<code>init.rc</code>æ–‡ä»¶å­˜åœ¨åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = <span class=\"built_in\">CreateParser</span>(action_manager, service_list);</span><br><span class=\"line\">    std::string bootscript = <span class=\"built_in\">GetProperty</span>(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.<span class=\"built_in\">empty</span>()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//è§£æ init.rcï¼Œå¯åŠ¨çš„å…³é”®æ–‡ä»¶</span></span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system/etc/init/hw/init.rc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/system_ext/etc/init&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//vendor å‚å•†ç›¸å…³çš„åˆå§‹åŒ–é…ç½®</span></span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.<span class=\"built_in\">ParseConfig</span>(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.<span class=\"built_in\">emplace_back</span>(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.<span class=\"built_in\">ParseConfig</span>(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//init.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ•°æ®è§£æè·å¾—ï¼Œå¼€å§‹æ„å»º action é˜Ÿåˆ—</span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::<span class=\"built_in\">GetInstance</span>();</span><br><span class=\"line\">    am.<span class=\"built_in\">QueueBuiltinAction</span>(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    .... etc</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è§¦å‘å¯åŠ¨</span></span><br><span class=\"line\">    am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è‹¥å¤„äºå……ç”µæ¨¡å¼å°†å»¶è¿Ÿåˆå§‹åŒ–</span></span><br><span class=\"line\">    std::string bootmode = <span class=\"built_in\">GetProperty</span>(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        am.<span class=\"built_in\">QueueEventTrigger</span>(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//init è¿›ç¨‹è¿›å…¥æ— é™è½®è®­</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¼€å§‹é€šè¿‡ command å‘½ä»¤æ‰§è¡Œ inir.rc è„šæœ¬å„é¡¹æœåŠ¡ä»¥åŠåˆå§‹åŒ–</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(prop_waiter_state.<span class=\"built_in\">MightBeWaiting</span>() || Service::<span class=\"built_in\">is_exec_service_running</span>())) &#123;</span><br><span class=\"line\">            am.<span class=\"built_in\">ExecuteOneCommand</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(prop_waiter_state.<span class=\"built_in\">MightBeWaiting</span>() || Service::<span class=\"built_in\">is_exec_service_running</span>())) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// If there&#x27;s more work to do, wake up again immediately.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (am.<span class=\"built_in\">HasMoreCommands</span>())</span><br><span class=\"line\">            epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åœ¨ Android 11 ä¸Šï¼Œinit.rc æ–‡ä»¶ä½äº<code>/system/etc/init/hw/init.rc</code></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92ab7d4ccd7a4118a1f705928d97c212~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>è¿™æ˜¯æˆ‘åœ¨å°ç±³æ‰‹æœºæ‰¾çš„ï¼Œrc æ–‡ä»¶è¢«è§†ä¸º Android åˆå§‹åŒ–è¯­è¨€ï¼Œé‚£è‚¯å®šä¹Ÿæœ‰è‡ªå·±çš„è¯­æ³•æˆ–æ ¼å¼ï¼Œå¯ä»¥å‚è€ƒï¼š<a href=\"https://www.cnblogs.com/gufanyuan/p/9350130.html\">https://www.cnblogs.com/gufanyuan/p/9350130.html</a></p>\n<p><strong>markï¼š</strong></p>\n<ul>\n<li>action on åæºå¸¦ä¸€ç»„å‘½ä»¤</li>\n<li>trigger è§¦å‘å™¨ï¼Œç¡®å®šä½•æ—¶æ‰§è¡Œå‘½ä»¤</li>\n<li>service å½“ init é€€å‡ºæ—¶å¯åŠ¨æˆ–é‡å¯</li>\n<li>options è¿›ä¸€æ­¥æ§åˆ¶å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å’Œæ—¶é—´</li>\n<li>å‘½ä»¤ï¼šon æ¯ä¸€è¡Œä»£è¡¨ä¸€æ¡å‘½ä»¤</li>\n<li>import å¯¼å…¥é¢å¤–çš„ rc æ–‡ä»¶éœ€è¦è§£æ</li>\n</ul>\n<p>çœ‹çœ‹ rc æ–‡ä»¶ï¼š</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0991aad99b524f9ebc147ce1fe075047~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.rc</span></span><br><span class=\"line\"># å°ç±³ç³»ç»Ÿï¼Œä¹Ÿæœ‰å‚å•†è‡ªå·±çš„è§£ææ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œå±äºè‡ªå·±çš„è¿›ç¨‹</span><br><span class=\"line\"><span class=\"meta\"># import æŒ‡æ˜å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶éœ€è¦è§£æ</span></span><br><span class=\"line\"># MIUI ADD:</span><br><span class=\"line\"><span class=\"keyword\">import</span> /init.miui.rc</span><br><span class=\"line\"></span><br><span class=\"line\"># è¿˜è®°å¾— SecondStageMain actionManage å—</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;early-init&quot;</span>);</span></span><br><span class=\"line\">on early-init</span><br><span class=\"line\">    # ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£å¤„ç† uevent æ¶ˆæ¯</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\">    <span class=\"meta\"># apex æœåŠ¡äºç³»ç»Ÿæ¨¡å—å®‰è£…</span></span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\"># è§¦å‘æ‰€æœ‰ action</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;init&quot;</span>);</span></span><br><span class=\"line\">on init</span><br><span class=\"line\">    # åˆ›å»º stdio æ ‡å‡†è¾“å…¥è¾“å‡ºé“¾æ¥</span><br><span class=\"line\">    symlink /proc/self/fd/<span class=\"number\">0</span> /dev/stdin</span><br><span class=\"line\">    # ç»™ sdcard æ›´æ”¹æƒé™</span><br><span class=\"line\">    chmod <span class=\"number\">0770</span> /config/sdcardfs</span><br><span class=\"line\">    </span><br><span class=\"line\">    # å¯åŠ¨æœåŠ¡</span><br><span class=\"line\">    # ç³»ç»ŸæœåŠ¡ï¼Œè¶Šæ¥è¶Šæ¥è¿‘åº”ç”¨å±‚äº†</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    <span class=\"meta\"># hwâ€”â€”hardwareï¼Œç¡¬ä»¶æœåŠ¡</span></span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    #ä¾›åº”å•†æœåŠ¡</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\">    <span class=\"meta\"># init action å°±æ‰§è¡Œåˆ°è¿™ï¼Œä¸­é—´çœç•¥å¾ˆå¤šå‘½ä»¤ï¼Œè¿™é‡Œåªæ˜¯æŠ½å–å‡ ä¸ªï¼Œç‚¹åˆ°ä¸ºæ­¢</span></span><br><span class=\"line\">    </span><br><span class=\"line\"># æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ ¸å¿ƒæœåŠ¡</span><br><span class=\"line\"><span class=\"meta\"># am.QueueEventTrigger(<span class=\"meta-string\">&quot;late-init&quot;</span>);</span></span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    # è§¦å‘ fsï¼šVold æ§åˆ¶å’Œç®¡ç†å¤–éƒ¨å­˜å‚¨çš„è¿›ç¨‹</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\"></span><br><span class=\"line\">    # é‡ç‚¹æ¥äº†âš ï¸âš ï¸âš ï¸</span><br><span class=\"line\">    <span class=\"meta\"># import /system/etc/init/hw/init.$&#123;ro.zygote&#125;.rc</span></span><br><span class=\"line\">    <span class=\"meta\"># zygote è¿›æ¥äº†ï¼Œå¸¸è¯´çš„ Android åº”ç”¨å±‚çš„é¼»ç¥–</span></span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\">    </span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br><span class=\"line\"></span><br><span class=\"line\">on boot</span><br><span class=\"line\">    # å¯åŠ¨ HAL ç¡¬ä»¶æŠ½è±¡ç±»æœåŠ¡</span><br><span class=\"line\">    class_start hal</span><br><span class=\"line\">    # å¯åŠ¨æ ¸å¿ƒç±»æœåŠ¡</span><br><span class=\"line\">    class_start core</span><br></pre></td></tr></table></figure>\n<h1>è§£æ zygote.rc</h1>\n<p>çœ‹ä¸Šé¢æˆªå›¾ï¼Œç°åœ¨è¯¥æ‰§è¡Œ<code>init.zygote32.rcã€init.zygote64_32.rc</code>ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.zygote32.rc</span></span><br><span class=\"line\"><span class=\"comment\">// zygote32 : åªæœ‰ä¸€ä¸ª 32ï¼Œé‚£å°±æ˜¯çº¯çº¯çš„ä¸º 32 ä½å‡†å¤‡çš„</span></span><br><span class=\"line\"></span><br><span class=\"line\">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">priority</span> -20</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">user</span> <span class=\"title\">root</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">group</span> <span class=\"title\">root</span> <span class=\"title\">readproc</span> <span class=\"title\">reserved_disk</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">socket</span> <span class=\"title\">zygote</span> <span class=\"title\">stream</span> 660 <span class=\"title\">root</span> <span class=\"title\">system</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">socket</span> <span class=\"title\">usap_pool_primary</span> <span class=\"title\">stream</span> 660 <span class=\"title\">root</span> <span class=\"title\">system</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">exec_background</span> - <span class=\"title\">system</span> <span class=\"title\">system</span> -- /<span class=\"title\">system</span>/<span class=\"title\">bin</span>/<span class=\"title\">vdc</span> <span class=\"title\">volume</span> <span class=\"title\">abort_fuse</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">write</span> /<span class=\"title\">sys</span>/<span class=\"title\">power</span>/<span class=\"title\">state</span> <span class=\"title\">on</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">audioserver</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">cameraserver</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">media</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">netd</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">onrestart</span> <span class=\"title\">restart</span> <span class=\"title\">wificond</span></span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">writepid</span> /<span class=\"title\">dev</span>/<span class=\"title\">cpuset</span>/<span class=\"title\">foreground</span>/<span class=\"title\">tasks</span></span></span><br><span class=\"line\"><span class=\"class\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /system/etc/init/hw/init.zygote64_32.rc</span></span><br><span class=\"line\"><span class=\"comment\">// zygote64_32 : å‰éƒ¨åˆ† 64 æŒ‡ä¸»è¦æ¨¡å¼ï¼Œåéƒ¨åˆ† 32 æŒ‡è¾…åŠ©æ¨¡å¼ï¼›åŒæ ·çš„ä¹Ÿä¼šæœ‰ zygote32_64.rcã€zygote32.rcã€zygote64.rc  etc.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># service æ˜¯ Android åˆå§‹åŒ–è¯è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡ init å¯åŠ¨æˆ–é€€å‡ºæ—¶é‡æ–°å¯åŠ¨æœåŠ¡</span></span><br><span class=\"line\"># æ˜¾ç„¶ï¼Œè¿™é‡Œçš„æœåŠ¡åç§°å°±æ˜¯â€˜å®¶å–»æˆ·æ™“â€™çš„ zygote è¿›ç¨‹</span><br><span class=\"line\">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority <span class=\"number\">-20</span>     ### è¿›ç¨‹ä¼˜å…ˆçº§ <span class=\"number\">-20</span> ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå–å€¼èŒƒå›´ [<span class=\"number\">-20</span>,<span class=\"number\">19</span>]</span><br><span class=\"line\">    user root        ### ç”± root ç”¨æˆ·æ‰§è¡Œ </span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    socket usap_pool_primary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse</span><br><span class=\"line\">    onrestart write /sys/power/state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    task_profiles ProcessCapacityHigh MaxPerformance</span><br><span class=\"line\"></span><br><span class=\"line\"># zygote_secondary ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span><br><span class=\"line\"># ä½ åœ¨çœ‹å‰é¢æåˆ°çš„â€˜ä¸»æ¨¡å¼â€™å’Œâ€˜è¾…æ¨¡å¼â€™ï¼Œæ°å¥½ zygote æ˜¯ app_process64ï¼Œzygote_secondary æ˜¯ app_process32ï¼Œ</span><br><span class=\"line\"># åˆšåˆšå¥½å¯¹åº”ä¸Šæ–‡ä»¶å init.zygote64_32.rc ã€ä¸»æ¨¡å¼æ˜¯<span class=\"number\">64</span>ï¼Œè¾…æ¨¡å¼æ˜¯<span class=\"number\">32</span>ã€‘</span><br><span class=\"line\">service zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority <span class=\"number\">-20</span></span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote_secondary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    socket usap_pool_secondary stream <span class=\"number\">660</span> root system</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    task_profiles ProcessCapacityHigh MaxPerformance</span><br></pre></td></tr></table></figure>\n<h1>åˆ›å»º zygote Process</h1>\n<p>åœ¨åˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µ SecondStageMain è§£æäº† inir.rcï¼Œå›åˆ° main.cpp çŸ¥é“ GetBuiltinFunctionMap å‡½æ•°æ˜ å°„è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥ SubcontextMainï¼Œç¬¬å››éƒ¨åˆ†å¼€å§‹æ‰§è¡Œï¼Œæ¥ç€çœ‹çœ‹æ‰§è¡Œæµç¨‹ã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">SubcontextMain</span>(argc, argv, &amp;function_map);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> subcontext_process = <span class=\"built_in\">SubcontextProcess</span>(function_map, context, init_fd);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//subcontext.cpp</span></span><br><span class=\"line\"><span class=\"built_in\">SubcontextProcess</span>(<span class=\"keyword\">const</span> BuiltinFunctionMap* function_map, std::string context, <span class=\"keyword\">int</span> init_fd)</span><br><span class=\"line\">: <span class=\"built_in\">function_map_</span>(function_map), <span class=\"built_in\">context_</span>(std::<span class=\"built_in\">move</span>(context)), <span class=\"built_in\">init_fd_</span>(init_fd)&#123;&#125;;</span><br><span class=\"line\"><span class=\"comment\">//é€šè¿‡æ„é€ å‡½æ•°ï¼Œç›´æ¥å°†å‡½æ•°æ˜ å°„è¡¨èµ‹å€¼ç»™æˆå‘˜ function_map_</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> BuiltinFunctionMap* function_map_;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//åœ¨ SubcontextMain ä¸­å¼€å§‹ä¸»å¾ªç¯</span></span><br><span class=\"line\">subcontext_process.<span class=\"built_in\">MainLoop</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//ä¸»å¾ªç¯ä¸­å‡†å¤‡æ‰§è¡Œå‘½ä»¤</span></span><br><span class=\"line\"><span class=\"built_in\">RunCommand</span>(subcontext_command.<span class=\"built_in\">execute_command</span>(), &amp;reply);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ˜ å°„è¡¨ function_map_ è¢«ä½¿ç”¨</span></span><br><span class=\"line\"><span class=\"comment\">//æ ¹æ®å‚æ•°ï¼ˆå‘½ä»¤ï¼‰æŸ¥æ‰¾å¯¹åº”çš„å†…ç½®å‡½æ•°</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> map_result = function_map_-&gt;<span class=\"built_in\">Find</span>(args);</span><br><span class=\"line\"><span class=\"comment\">//æ‰¾åˆ°äº†å‘½ä»¤å‡†å¤‡æ‰§è¡Œ</span></span><br><span class=\"line\">result = <span class=\"built_in\">RunBuiltinFunction</span>(map_result-&gt;function, args, context_);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ„é€ å‚æ•°ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class=\"line\"><span class=\"comment\">//å›æƒ³ä¸€ä¸‹ï¼Œæ˜ å°„è¡¨ä¸­æ˜¯å¦æœ‰ç€ä¸€ä¸ª item</span></span><br><span class=\"line\"><span class=\"comment\">//&#123;&quot;class_start&quot;, &#123;1, 1, &#123;false, do_class_start&#125;&#125;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">//do_class_startï¼šå†…ç½®å‡½æ•°è¢«å£°æ˜åœ¨ builtins.cpp ä¸­ï¼Œä¸‹é¢çœ‹çœ‹å…¶å®ç°</span></span><br><span class=\"line\"><span class=\"keyword\">auto</span> builtin_arguments = <span class=\"built_in\">BuiltinArguments</span>(context);</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">function</span>(builtin_arguments);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//builtins.cpp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">do_class_start</span><span class=\"params\">(<span class=\"keyword\">const</span> BuiltinArguments&amp; args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (android::base::<span class=\"built_in\">GetBoolProperty</span>(<span class=\"string\">&quot;persist.init.dont_start_class.&quot;</span> + args[<span class=\"number\">1</span>], <span class=\"literal\">false</span>))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">    <span class=\"comment\">//æœåŠ¡å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ServiceList::GetInstance() åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿å•Šï¼Ÿservice åˆ—è¡¨åˆæ˜¯ä»€ä¹ˆï¼Ÿ</span></span><br><span class=\"line\"><span class=\"comment\">    è¿˜è®°å¾—ç¬¬äºŒé˜¶æ®µåˆå§‹åŒ– SecondStageMain ä¸­è¿™æ®µä»£ç å—</span></span><br><span class=\"line\"><span class=\"comment\">    ServiceList&amp; sm = ServiceList::GetInstance();</span></span><br><span class=\"line\"><span class=\"comment\">    LoadBootScripts(am, sm); //è¿™æ­£æ˜¯åœ¨è§£æ init.rc æ–‡ä»¶ï¼Œå…¶ä¸­å°±åŒ…å« hw/init.rc</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¯ä»¥è®¤ä¸º service å°±æ˜¯é€šè¿‡è§£æ init.rc ä¸­çš„ service è·å¾—çš„ï¼Œæ­¤æ–‡ä»¶æ­£å¥½ä¹Ÿå¯¼å…¥ import hw/init.rcï¼Œå…¶ä¸­åŒ…å« zygote ç›¸å…³ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">    è¿›è€Œç»§ç»­è§£æ init.zygote.rcï¼Œzygote.rc æ–‡ä»¶å†…å®¹ä¹Ÿä¼šè¢«è§£æåˆ°</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">ServiceList.GetInstance å°±æ˜¯ std::vector&lt;std::unique_ptr&lt;Service&gt;&gt; services_;</span></span><br><span class=\"line\"><span class=\"comment\">service-&gt;classenames() å°±æ˜¯ std::set&lt;std::string&gt; classnames_;</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">        3ã€åˆ›å»º Service çš„æ„é€ å‡½æ•°ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">    Service::Service(const std::string&amp; name, unsigned flags, uid_t uid, gid_t gid,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::vector&lt;gid_t&gt;&amp; supp_gids, int namespace_flags,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::string&amp; seclabel, Subcontext* subcontext_for_restart_commands,</span></span><br><span class=\"line\"><span class=\"comment\">       const std::vector&lt;std::string&gt;&amp; args, bool from_apex)</span></span><br><span class=\"line\"><span class=\"comment\">       :  name_(name),</span></span><br><span class=\"line\"><span class=\"comment\">       classnames_(&#123;&quot;default&quot;&#125;),</span></span><br><span class=\"line\"><span class=\"comment\">        ... etc</span></span><br><span class=\"line\"><span class=\"comment\">     )&#123;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; service : ServiceList::<span class=\"built_in\">GetInstance</span>()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å‚æ•°çš„æ¥æº</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€åå¤æŸ¥é˜…èµ„æ–™å¾—çŸ¥ args å°±æ˜¯ rc æ–‡ä»¶ä¸­æ¯ä¸ª service çš„å‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">        args[1] è‡ªç„¶æ˜¯ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">        çœ‹ hw/zygote.rc service æ‰§è¡Œ zygote å‘½ä»¤å‰éƒ¨åˆ†</span></span><br><span class=\"line\"><span class=\"comment\">        ...</span></span><br><span class=\"line\"><span class=\"comment\">        service zygote</span></span><br><span class=\"line\"><span class=\"comment\">          class main</span></span><br><span class=\"line\"><span class=\"comment\">          ...</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            2ã€å› æ­¤ args[1] å…¶å®å°±æ˜¯ main</span></span><br><span class=\"line\"><span class=\"comment\">        åŒæ ·ï¼Œæˆ‘ä»¬çœ‹ hw/init.usb.rc ä¹Ÿæœ‰ä¸€ä¸ª service</span></span><br><span class=\"line\"><span class=\"comment\">        ...</span></span><br><span class=\"line\"><span class=\"comment\">        service adbd</span></span><br><span class=\"line\"><span class=\"comment\">           class core</span></span><br><span class=\"line\"><span class=\"comment\">           ...   </span></span><br><span class=\"line\"><span class=\"comment\">        adb çš„ä½¿ç”¨ä¸ adbd å¯æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œadbd æ˜¯ä¸€ä¸ªè¿œç¨‹æœåŠ¡è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æ‰€ä»¥è¿™é‡Œçš„æ„æ€æ˜¯ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">        æ ¹æ®å‚æ•°åç§°å»æœåŠ¡åˆ—è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæœåŠ¡å­˜åœ¨é‚£ä¹ˆå¼€å§‹æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">        æœåŠ¡ä¸€èˆ¬æ˜¯ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œä¸”å¾ˆæœ‰å¯èƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service-&gt;<span class=\"built_in\">classnames</span>().<span class=\"built_in\">count</span>(args[<span class=\"number\">1</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = service-&gt;<span class=\"built_in\">StartIfNotDisabled</span>(); !result.<span class=\"built_in\">ok</span>()) &#123;</span><br><span class=\"line\">                <span class=\"built_in\">LOG</span>(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not start service &#x27;&quot;</span> &lt;&lt; service-&gt;<span class=\"built_in\">name</span>()</span><br><span class=\"line\">                           &lt;&lt; <span class=\"string\">&quot;&#x27; as part of class &#x27;&quot;</span> &lt;&lt; args[<span class=\"number\">1</span>] &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.<span class=\"built_in\">error</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//service.cpp</span></span><br><span class=\"line\"><span class=\"function\">Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">Service::StartIfNotDisabled</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_DISABLED)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">Start</span>();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        flags_ |= SVC_DISABLED_START;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//service.cpp</span></span><br><span class=\"line\"><span class=\"function\">Result&lt;<span class=\"keyword\">void</span>&gt; <span class=\"title\">Service::Start</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">pid_t</span> pid = <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (namespaces_.flags) &#123;</span><br><span class=\"line\">        pid = <span class=\"built_in\">clone</span>(<span class=\"literal\">nullptr</span>, <span class=\"literal\">nullptr</span>, namespaces_.flags | SIGCHLD, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å°±è¿™ï¼Ÿè¿›ç¨‹å°±è¢« fork å‡ºæ¥äº†ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        pid = fork();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// pid 0 æ˜¯ idle è¿›ç¨‹ï¼Œè‚¯å®šä¸èƒ½</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">umask</span>(<span class=\"number\">077</span>);</span><br><span class=\"line\">        <span class=\"built_in\">RunService</span>(override_mount_namespace, descriptors, std::<span class=\"built_in\">move</span>(pipefd));</span><br><span class=\"line\">        _exit(<span class=\"number\">127</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºè¿›ç¨‹ç»„</span></span><br><span class=\"line\">    errno = -<span class=\"built_in\">createProcessGroup</span>(proc_attr_.uid, pid_, use_memcg);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆ°æ­¤ï¼Œé€šè¿‡æŸ¥æ‰¾æœåŠ¡åˆ—è¡¨åˆ›å»ºäº†ä¸€å †è¿›ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>zygote</code>è¿›ç¨‹çš„åˆ›å»ºï¼Œè¿™æ—¶å€™é—´ä» cpp è¿›å…¥ Java</p>\n<h1>åˆå§‹åŒ– zygote</h1>\n<h2 id=\"é¢„åŠ è½½é…ç½®\">é¢„åŠ è½½é…ç½®</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteInit.java</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ZygoteInit</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * åˆå§‹åŒ–ä¸»è¦åšï¼š</span></span><br><span class=\"line\"><span class=\"comment\">     * 1ã€å®Œæˆé¢„åˆå§‹åŒ–</span></span><br><span class=\"line\"><span class=\"comment\">     * 2ã€åˆ›å»º zygote æœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">     * 3ã€åˆ›å»ºç³»ç»ŸæœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] argv)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//ã€1ã€‘å®Œæˆé¢„åˆå§‹åŒ–</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€è°ƒç”¨ ZygoteHooks.onBeginPreload(); ZygoteHooks ä» Dalvik åŒ…å¼•å…¥ï¼Œåœ¨ framework ä¸‹æ²¡æœ‰æ‰¾åˆ°çš„æºç åº”è¯¥æ˜¯åœ¨åˆ«å¤„äº†ï¼Œé¢„æƒ³æ˜¯å¯¹ Dalvik çš„åˆå§‹åŒ–ï¼›é¢„åŠ è½½ç»“æŸæ—¶ä¹Ÿä¼šè°ƒç”¨ ZygoteHooks.onEndPreload();</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€VMRuntime ä¸º Dalvik é¢„åŠ è½½è·¯å¾„ä¸‹çš„ç±» /system/etc/preloaded-classesã€profilebootclasspath</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€åˆ›å»ºå¹¶ç¼“å­˜éå¯åŠ¨ç±»è·¯å¾„ä¸‹çš„ç±»åŠ è½½å™¨ /system/framework/android.hidl.base-V1.0-java.jarã€/system/framework/android.hidl.manager-V1.0-java.jar (HIDL æ¥å£å®šä¹‰è¯­è¨€ â€”â€” https://source.android.google.cn/devices/architecture/hidl?hl=zh-cn)</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€åŠ è½½èµ„æºï¼ŒåŠ è½½å‰å…ˆæ›´æ–°é…ç½®ï¼ˆæ¯”å¦‚å½“å‰è®¾å¤‡åˆ†è¾¨ç‡ã€å±å¹•å°ºå¯¸ã€è¯­è¨€ï¼‰ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">        æ ¹æ®åˆ†è¾¨ç‡åŠ è½½ drawableã€é¢œè‰²èµ„æº</span></span><br><span class=\"line\"><span class=\"comment\">            5ã€é€šè¿‡ native åŠ è½½ä¸ºåº”ç”¨è¿›ç¨‹å‡†å¤‡çš„ HAL ç¡¬ä»¶æŠ½è±¡åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">            6ã€å¦‚æœå¼€å¯äº† ro.zygote.disable_gl_preloadï¼Œä¹Ÿé€šè¿‡ native æ‰§è¡Œå›¾å½¢ GL é¢„åŠ è½½</span></span><br><span class=\"line\"><span class=\"comment\">            7ã€é€šè¿‡ System.loadLibrary åŠ è½½å…±äº«åº“ android.libã€compiler_rt.libã€jnigraphics.lib</span></span><br><span class=\"line\"><span class=\"comment\">            8ã€å‡†å¤‡ Hyphenator ç¯å¢ƒï¼Œç¼“å­˜å­—ä½“</span></span><br><span class=\"line\"><span class=\"comment\">            9ã€åŠ è½½ webviewchromium_loader.libï¼Œå‡†å¤‡ webview </span></span><br><span class=\"line\"><span class=\"comment\">            10ã€é€šè¿‡ AndroidKeyStoreProvider å®‰è£… keystore å†…å®¹æä¾›è€…  </span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"built_in\">preload</span>(bootTimingsTraceLog);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//åˆå§‹åŒ– GCï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†</span></span><br><span class=\"line\">        ZygoteHooks.<span class=\"built_in\">gcAndFinalize</span>()ï¼›</span><br><span class=\"line\">        <span class=\"comment\">//åˆ°è¿™é‡Œ zygote å·²ç»æ˜¯ã€åˆå§‹åŒ–å®Œæ¯•ã€‘</span></span><br><span class=\"line\">        Zygote.<span class=\"built_in\">initNativeState</span>(isPrimaryZygote)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€2ã€‘åˆ›å»º zygote æœåŠ¡</span></span><br><span class=\"line\">        ZygoteServer zygoteServer = null;</span><br><span class=\"line\">        zygoteServer = <span class=\"keyword\">new</span> <span class=\"built_in\">ZygoteServer</span>(isPrimaryZygote);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€3ã€‘åˆ›å»ºç³»ç»ŸæœåŠ¡</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startSystemServer) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//forkï¼Œå¯è§æ¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼›ABI â€”â€” Application binary interfaceã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">            <span class=\"comment\">//åœ¨ Android é¡¹ç›®ä¸­å¯¹åº”çš„å°±æ˜¯ ndk filterï¼Œå¦‚ arm64ã€x86  .etc</span></span><br><span class=\"line\">            <span class=\"comment\">//ä¸ºæ”¯æŒä¸åŒå¹³å°ï¼Œndk filter æ˜¯èƒ½å¤Ÿé…ç½®å¤šä¸ªçš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼å­˜åœ¨</span></span><br><span class=\"line\">            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r != null) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//åˆ›å»ºä¹‹åé©¬ä¸Šè¿è¡Œ</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         </span><br><span class=\"line\">        <span class=\"comment\">// zygote æœåŠ¡è¿›å…¥è‡ªå·±çš„ä¸–ç•Œè½®è®­</span></span><br><span class=\"line\">        caller = zygoteServer.<span class=\"built_in\">runSelectLoop</span>(abiList);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(caller != null)&#123;</span><br><span class=\"line\">            caller.<span class=\"built_in\">run</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆ›å»º-zygoteServer\">åˆ›å»º zygoteServer</h2>\n<p>æœåŠ¡ä¸»è¦è¿˜æ˜¯é€šè¿‡ socket å®ç°ï¼Œç­‰å¾…æ¥è‡ª Linuxã€unix å®ˆæŠ¤è¿›ç¨‹ (socket) çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å­è¿›ç¨‹çš„åˆ›å»ºã€‚</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteServer.java</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ZygoteServer</span> &#123;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„æˆå‘˜</span></span><br><span class=\"line\"><span class=\"comment\">//ç”¨äºç›‘å¬ socket è¿æ¥</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> LocalServerSocket mZygoteSocket;</span><br><span class=\"line\"><span class=\"comment\">//ä¸º USAP éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  æœåŠ¡</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LocalServerSocket mUsapPoolSocket;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ZygoteServer</span>(boolean isPrimaryZygote) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//é€šè¿‡ native è°ƒç”¨è·å–</span></span><br><span class=\"line\">        mUsapPoolEventFD = Zygote.<span class=\"built_in\">getUsapPoolEventFD</span>();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ä¸» zygote</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isPrimaryZygote) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//å®Œæˆçš„ socket åç§°éœ€è¦å’Œ ANDROID_SOCKET_ + socketname æ‹¼æ¥ï¼Œ</span></span><br><span class=\"line\">            <span class=\"comment\">//ç„¶åæ‹¿å®Œæ•´çš„åç§°å»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾è·å–æ–‡ä»¶æè¿°ç¬¦ fd â€”â€” file describeï¼Œå®é™…æ˜¯ä¸€ä¸ªæ•´å‹æ•°å€¼ã€å‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\">            mZygoteSocket = Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">            mUsapPoolSocket =</span><br><span class=\"line\">                    Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(</span><br><span class=\"line\">                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//è¾… zygote</span></span><br><span class=\"line\">            mZygoteSocket = Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(Zygote.SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">            mUsapPoolSocket =</span><br><span class=\"line\">                    Zygote.<span class=\"built_in\">createManagedSocketFromInitSocket</span>(</span><br><span class=\"line\">                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//è·å– éä¸“ç”¨åº”ç”¨è¿›ç¨‹æ±  é…ç½®ï¼Œè¿˜æ˜¯é€šè¿‡ç³»ç»Ÿé…ç½® SystemPropertice è·å–</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolSizeMax â€”â€” usap_pool_size_max</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolSizeMin â€”â€” usap_pool_size_min</span></span><br><span class=\"line\"><span class=\"comment\">            mUsapPoolRefillThreshold â€”â€” usap_refill_threshold</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"built_in\">fetchUsapPoolPolicyProps</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æœ€é‡è¦çš„è¿˜æ˜¯è¿›å…¥ poll è½®è®­ã€å…³äºé«˜å¹¶å‘ IO å¤šè·¯å¤ç”¨ï¼Œå‚è€ƒé“¾æ¥ã€‘</span></span><br><span class=\"line\"><span class=\"function\">Runnable <span class=\"title\">runSelectLoop</span><span class=\"params\">(String abiList)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//æ¯ä¸€æ¬¡è½®è®­ä¸”è¶…è¿‡ä¸€åˆ†é’Ÿéƒ½æ›´æ–° USAP é…ç½®</span></span><br><span class=\"line\">        fetchUsapPoolPolicyPropsWithMinInterval</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//ç³»ç»Ÿè°ƒç”¨ poll å¤„ç†æ–‡ä»¶æè¿°ç¬¦ fd</span></span><br><span class=\"line\">        <span class=\"comment\">//Os.poll è¿”å›å€¼0ï¼šè¡¨ç¤ºå¤„ç†è¶…æ—¶æˆ–éé˜»å¡çŠ¶æ€æ²¡æœ‰å¯å¤„ç†çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class=\"line\">        pollReturnValue = Os.<span class=\"built_in\">poll</span>(pollFDs, pollTimeoutMs);</span><br><span class=\"line\">        </span><br><span class=\"line\">        ... etc</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯è¿”å›å€¼ï¼Œç±»å‹æ˜¯ Runnable</span></span><br><span class=\"line\">        <span class=\"comment\">//è¿™æ˜¯åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å‘ç”Ÿé‡ç½® USAPï¼Œcommand çš„å†…å®¹æ˜¯ï¼š</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            fetchUsapPoolPolicyPropsIfUnfetched();</span></span><br><span class=\"line\"><span class=\"comment\">            ZygoteHooks.preFork();</span></span><br><span class=\"line\"><span class=\"comment\">            ZygoteHooks.postForkCommon();</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Runnable command = <span class=\"built_in\">fillUsapPool</span>(sessionSocketRawFDs, isPriorityRefill);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (command != null) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> command;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"åˆ›å»º-SystemServer\">åˆ›å»º SystemServer</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ZygoteInit.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    abiList â€”â€” ndl filter</span></span><br><span class=\"line\"><span class=\"comment\">    socketname â€”â€” zygote è¿›ç¨‹åç§°</span></span><br><span class=\"line\"><span class=\"comment\">    zygoteServer â€”â€” è‡ªç„¶æ˜¯ zygote çš„ä¸»è¦æœåŠ¡</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">forkSystemServer</span><span class=\"params\">(String abiList, String socketName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                             ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å‚æ•°</span></span><br><span class=\"line\">    String[] args = &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;--setuid=1000&quot;</span>, <span class=\"comment\">//linux ä¸­ä¸åŒ uid å¯ä»¥ä»£è¡¨æ‹¥æœ‰ä¸åŒçš„æƒé™</span></span><br><span class=\"line\">                <span class=\"string\">&quot;--setgid=1000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&quot;</span></span><br><span class=\"line\">                        + <span class=\"string\">&quot;1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--capabilities=&quot;</span> + capabilities + <span class=\"string\">&quot;,&quot;</span> + capabilities,</span><br><span class=\"line\">                <span class=\"string\">&quot;--nice-name=system_server&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--runtime-args&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;--target-sdk-version=&quot;</span> + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class=\"line\">                <span class=\"string\">&quot;com.android.server.SystemServer&quot;</span>,</span><br><span class=\"line\">     &#125;;</span><br><span class=\"line\">     </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœç•¥å‚æ•°æ„é€ è¿‡ç¨‹</span></span><br><span class=\"line\">    ZygoteArguments parsedArgs;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºæœåŠ¡è¿›ç¨‹ï¼Œè¿˜æ˜¯è°ƒç”¨ native æ–¹æ³•</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        int pid = nativeForkSystemServer(</span></span><br><span class=\"line\"><span class=\"comment\">        uid, gid, gids, runtimeFlags, rlimits,</span></span><br><span class=\"line\"><span class=\"comment\">        permittedCapabilities, effectiveCapabilities);</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    pid = Zygote.forkSystemServer(</span><br><span class=\"line\">        parsedArgs.mUid, parsedArgs.mGid,</span><br><span class=\"line\">        parsedArgs.mGids,</span><br><span class=\"line\">        parsedArgs.mRuntimeFlags,</span><br><span class=\"line\">        null,</span><br><span class=\"line\">        parsedArgs.mPermittedCapabilities,</span><br><span class=\"line\">        parsedArgs.mEffectiveCapabilities);</span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        pid=0 åˆ™æ˜¯å­è¿›ç¨‹è¢«åˆ›å»º</span></span><br><span class=\"line\"><span class=\"comment\">        pid=-1 åˆ™è¡¨ç¤ºå‡ºé”™</span></span><br><span class=\"line\"><span class=\"comment\">        pid (é0å€¼)åˆ›å»ºçˆ¶è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ï¼Ÿï¼Ÿï¼Ÿè¿˜ä¼šæœ‰ç¬¬äºŒä¸ª zygote è¿›ç¨‹ï¼Œè¿™æ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"comment\">//çœ‹çœ‹å®˜æ–¹æè¿°ï¼šWe determine this by comparing the device ABI list with this zygotes list. </span></span><br><span class=\"line\">        <span class=\"comment\">//            If this zygote supports all ABIs this device supports, there won&#x27;t be another zygote.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">hasSecondZygote</span>(abiList)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">waitForSecondaryZygote</span>(socketName);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        zygoteServer.<span class=\"built_in\">closeServerSocket</span>();</span><br><span class=\"line\">        <span class=\"comment\">//ç»§ç»­æŠŠå‚æ•°åˆ†å‘ç»™ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œè¿™é‡Œåšçš„äº‹æƒ…æ¯”è¾ƒå¤šäº†</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€è·å–ç³»ç»ŸæœåŠ¡ç±»è·¯å¾„ systemServerClassPathï¼Œé¦–å…ˆè¿˜æ˜¯ä»ç³»ç»Ÿç¯å¢ƒä¸­è¯»å–Os.getenv(&quot;SYSTEMSERVERCLASSPATH&quot;)ï¼›å½“è¿›ç¨‹æ‰§è¡Œæ—¶ ART å°†ä¼šå¤„ç†æ­¤è·¯å¾„</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€è´Ÿè´£ zygote çš„ native åˆå§‹åŒ–å’Œ application çš„æ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€è¿™é‡Œæ— è®ºå…ˆèµ°é‚£ä¸ªåˆ†æ”¯ï¼Œåé¢éƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼šreturn RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,</span></span><br><span class=\"line\"><span class=\"comment\">        classLoader);</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">            if (parsedArgs.mInvokeWith != null) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                WrapperInit.execApplication(parsedArgs.mInvokeWith,</span></span><br><span class=\"line\"><span class=\"comment\">                        parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,</span></span><br><span class=\"line\"><span class=\"comment\">                        VMRuntime.getCurrentInstructionSet(), null, args);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125; else &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                ClassLoader cl = getOrCreateSystemServerClassLoader();</span></span><br><span class=\"line\"><span class=\"comment\">                return ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span></span><br><span class=\"line\"><span class=\"comment\">                parsedArgs.mDisabledCompatChanges,</span></span><br><span class=\"line\"><span class=\"comment\">                parsedArgs.mRemainingArgs, cl);</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">handleSystemServerProcess</span>(parsedArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RuntimeInit.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">applicationInit</span><span class=\"params\">(<span class=\"keyword\">int</span> targetSdkVersion, <span class=\"keyword\">long</span>[] disabledCompatChanges,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String[] argv, ClassLoader classLoader)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è®¾ç½®è¿è¡Œç›®æ ‡ç‰ˆæœ¬</span></span><br><span class=\"line\">    VMRuntime.<span class=\"built_in\">getRuntime</span>().<span class=\"built_in\">setTargetSdkVersion</span>(targetSdkVersion);</span><br><span class=\"line\">    <span class=\"comment\">//é€šè¿‡å¯åŠ¨ç±»åæ‰¾åˆ°æ­¤ç±»ï¼Œç”±ç±»åŠ è½½å™¨åŠ è½½å¹¶è°ƒç”¨å…¶ main æ–¹æ³•</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">findStaticMain</span>(args.startClass, args.startArgs, classLoader);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RuntimeInit.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> Runnable <span class=\"title\">findStaticMain</span><span class=\"params\">(String className, String[] argv,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">//å¸¸è§„æ–¹æ³•ï¼Œåªæ˜¯æ‰§è¡Œ classloader</span></span><br><span class=\"line\">    Class&lt;?&gt; cl = Class.forName(className, <span class=\"literal\">true</span>, classLoader);</span><br><span class=\"line\">    Method m = cl.<span class=\"built_in\">getMethod</span>(<span class=\"string\">&quot;main&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123; String[].class &#125;);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">//å› ä¸ºå½“å‰æ˜¯åœ¨ zygote è¿›ç¨‹åˆ›å»º SystemServerï¼Œåœ¨æ­¤æµç¨‹ä¸­æœ¬æ¬¡æ‰§è¡Œæˆ‘ä»¬è®¤ä¸ºå‚æ•° className=&quot;com.android.internal.os.SystemServer&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">MethodAndArgsCaller</span>(m, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆ°è¿™é‡Œ SystemServer å·²ç»åˆ›å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯é€šè¿‡ <code>MethodAndArgsCaller</code> æ–¹æ³•æ‰§è¡Œå…¶ä¸­çš„ <code>main</code> æ–¹æ³•ï¼Œæºç è·¯å¾„æ˜¯<code>/frameworks/base/services/java/com/android/server/SystemServer.java</code>ã€‚</p>\n<h1>é™„åŠ </h1>\n<h2 id=\"å‚è€ƒé“¾æ¥\">å‚è€ƒé“¾æ¥</h2>\n<ul>\n<li>Androi.bpï¼šbp æ–‡ä»¶ï¼Œæ›¿æ¢ .mk çš„é…ç½®æ–‡ï¼Œç”± <a href=\"https://github.com/palantir/blueprint\">https://github.com/palantir/blueprint</a> æ¡†æ¶è§£æ</li>\n<li><a href=\"http://Android.mk\">Android.mk</a>ï¼šmk æ–‡ä»¶ï¼ŒAndroid ç¨‹åºç¼–è¯‘</li>\n<li>lmkdï¼šlow memory killer deamon ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹</li>\n<li>Apexï¼šAndroid pony express è§£å†³è¾ƒä½çº§åˆ«ç³»ç»Ÿæ¨¡å—çš„å®‰è£…æµç¨‹ <a href=\"https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn\">https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn</a></li>\n<li>syspro æ–‡ä»¶ï¼šç³»ç»Ÿå…±äº«ä¿¡æ¯çš„å±æ€§é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½œä¸ºç³»ç»Ÿ API å®ç° <a href=\"https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=%E4%B8%80%E4%B8%AA,Sysprop%20%E8%AF%B4%E6%98%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%B8%80%E6%9D%A1%E5%B1%9E%E6%80%A7%E6%B6%88%E6%81%AF%EF%BC%8C%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0%E4%B8%80%E7%BB%84%E5%B1%9E%E6%80%A7%E3%80%82\">https://source.android.google.cn/devices/architecture/sysprops-apis?hl=zh-cn#:~:text=ä¸€ä¸ª,Sysprop è¯´æ˜æ–‡ä»¶åŒ…å«ä¸€æ¡å±æ€§æ¶ˆæ¯ï¼Œç”¨æ¥æè¿°ä¸€ç»„å±æ€§ã€‚</a></li>\n<li>ABIï¼šä¸ CPU æŒ‡ä»¤é›†ç›¸å…³ <a href=\"https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn\">https://developer.android.google.cn/ndk/guides/abis?hl=zh-cn</a></li>\n<li>fd ï¼šæ–‡ä»¶æè¿°ç¬¦ <a href=\"https://www.cnblogs.com/cscshi/p/15705033.html\">https://www.cnblogs.com/cscshi/p/15705033.html</a></li>\n<li>Linux IO å¤šè·¯å¤ç”¨ï¼šselectã€pollã€epoll <a href=\"https://cloud.tencent.com/developer/article/1005481\">https://cloud.tencent.com/developer/article/1005481</a></li>\n<li>MTEï¼šmemory tagging extension  <a href=\"https://cloud.tencent.com/developer/article/2003341#:~:text=Arm%20MTE%EF%BC%88%E5%86%85%E5%AD%98%E6%A0%87%E8%AE%B0%EF%BC%89%E4%BD%9C%E4%B8%BAArmv8.5%E6%8C%87%E4%BB%A4%E9%9B%86%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%E5%BC%95%E5%85%A5%E3%80%82%20MTE%E7%8E%B0%E5%9C%A8%E5%86%85%E7%BD%AE%E4%BA%8EArm%20%E6%9C%80%E8%BF%91%E5%AE%A3%E5%B8%83%E7%9A%84%E7%AC%A6%E5%90%88Armv9%20%E7%9A%84%20CPU%20%E4%B8%AD%EF%BC%8C%E4%BE%8B%E5%A6%82,Cortex-X2%E3%80%81Cortex-A710%20%E5%92%8CCortex-A510%E3%80%82%20%E6%9C%AA%E6%9D%A5%E5%9F%BA%E4%BA%8EArmv9%20%E7%9A%84%20CPU%20%E4%B9%9F%E5%B0%86%E9%9B%86%E6%88%90%20MTE%E3%80%82\"> å†…å­˜æ ‡ç­¾æ‰©å±• </a></li>\n<li>å·²åŠ æ ‡è®°æŒ‡é’ˆï¼š<a href=\"https://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn\">https://source.android.google.cn/devices/tech/debug/tagged-pointers?hl=zh-cn</a></li>\n</ul>\n"},{"title":"Android ç³»ç»Ÿ Homeï¼ˆä¸€ï¼‰","catalog":true,"date":"2022-09-29T14:57:44.000Z","subtitle":"å¯åŠ¨æ¡Œé¢å°±æ˜¯æŸ¥æ‰¾å¹¶å¯åŠ¨ Activity","header-img":"/img/220928/android_sysserver_bg.png","sticky":8,"_content":"\n\n# Ready go\nåœ¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œä¸Šä¸€ç« æˆ‘ä»¬å¯¹ `package` ç›®å½•ä¸‹çš„å†…å®¹æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæˆ‘ä»¬çŸ¥é“è®¾å¤‡ä¸Šçš„æ¡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ª`ç³»ç»Ÿåº”ç”¨`ï¼ŒAOSP åŸç”Ÿæœ‰æä¾›ï¼Œä½†æ˜¯å‚å•†å®šåˆ¶çš„ ROM å¾€å¾€ä¼šè‡ªå·±é‡å†™æˆ–é‡æ–°å®ç°ï¼Œæ‰©å±•åŠŸèƒ½ï¼›é‚£ä¹ˆç»§ç»­ Android ç³»ç»Ÿå¯åŠ¨æ€è€ƒå¾€ä¸‹èµ°ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥çœ‹çœ‹æ‰‹æœºæ¡Œé¢æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„â€”â€”â€”æ¡Œé¢ç¨‹åºæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ\n\nè™½ç„¶æˆ‘ä»¬çŸ¥é“æ¡Œé¢ç¨‹åºæ˜¯`Launcher`ï¼Œä½†æ˜¯æˆ‘ä»¬ä½œä¸ºåˆšé˜…è¯»æºç çš„å°ç™½ï¼Œ**å¦‚ä½•åœ¨æºç ä¸­å¿«é€Ÿæ‰¾åˆ°æ¡Œé¢ç¨‹åºå¯åŠ¨çš„å…¥å£ï¼Ÿ** è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ€è€ƒçš„é—®é¢˜ï¼Œ å½“ç„¶ï¼Œç«™åœ¨â€˜å·¨äººçš„è‚©è†€â€™ç›´æ¥ä½¿ç”¨ç™¾åº¦ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†è¿™é‡Œæˆ‘æƒ³åˆ°å¦å¤–ä¸€ç§æ–¹å¼â€”â€”â€”â€”`æ— éšœç¢æœåŠ¡ Accessebility`ï¼›åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæ— éšœç¢æœåŠ¡é™¤äº†æ»¡è¶³é¡¹ç›®éœ€æ±‚åº”ç”¨äºé¡¹ç›®ä¸­å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨è¯¥æœåŠ¡ä½œä¸ºæˆ‘ä»¬çš„è¾…åŠ©å·¥å…·ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä¸ªäººæœ€å¸¸ç”¨çš„å°±æ˜¯`æŸ¥çœ‹ç³»ç»Ÿå½“å‰æœ€é¡¶éƒ¨æ˜¾ç¤ºçš„ activity`ã€‚ä½œä¸ºè¾…åŠ©æ‰‹æ®µï¼Œæ—©å·²æœ‰æˆç†Ÿçš„è½¯ä»¶å·¥å…·ï¼Œè¿™é‡Œæ¨èä¸¤ä¸ªå·¥å…·ã€‚\n\n\n- å¼€å‘è€…åŠ©æ‰‹\n- Android å¼€å‘å·¥å…·ç®±\n- MT æ–‡ä»¶ç®¡ç†å™¨\n\n# systemReady\n\næˆ‘ä»¬çŸ¥é“ï¼ŒSystemServer åœ¨è¢«è°ƒç”¨æ—¶å…ˆæ‰§è¡Œ `main` å‡½æ•°ï¼Œç´§æ¥ç€æ‰§è¡Œå½“å‰ç±»çš„é™æ€æ–¹æ³• `run`ï¼Œç„¶ååˆ†ä¸‰ä¸ªé˜¶æ®µå¯åŠ¨ `å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡`ï¼Œæœ€åè¿›å…¥ `Looper().loop` å¾ªç¯å¿˜ä¸åœæ­‡çš„ ~~æ‰“å·¥~~ ç­‰å¾…æ¶ˆæ¯åˆ°æ¥å¹¶å¤„ç†ã€‚å¯åŠ¨æœåŠ¡æ˜¯ä¸€éƒ¨åˆ†ï¼Œéš¾é“ä¸åšç‚¹åˆ«çš„å—ï¼Ÿåˆšå¥½åœ¨å¯åŠ¨ **å…¶ä»–æœåŠ¡** è¿™é‡Œçœ‹åˆ°è¿™ä¸€æ®µæ³¨é‡Šï¼š\n\n```\n// We now tell the activity manager it is okay to run third party\n// code.  It will call back into us once it has gotten to the state\n// where third party code can really run (but before it has actually\n// started launching the initial applications), for us to complete our\n// initialization.\n\nSystemServerï¼šAMS ä½ æ‰€éœ€çš„ä¸€äº›æœåŠ¡å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨äº†ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œoverï¼overï¼\n\nAMSï¼šæ”¶åˆ°ï¼æ”¶åˆ°ï¼çœ‹æˆ‘å›è°ƒè¡Œäº‹ï¼Œoverï¼\n```\n\nå…ˆæ˜¯ AMS systemReady è¿›å…¥å‡†å¤‡é˜¶æ®µ\n\n```java\n//ActivityManagerService.java\npublic void systemReady(final Runnable goingCallback, @NonNull TimingsTraceAndSlog t) {\n\n    /*\n        1ã€ç®¡ç† activity çš„ä»»åŠ¡æ ˆã€è¿™ç§å†…å®¹å¤ªç»†äº†ï¼Œä»¥åé€ä¸ªçœ‹çœ‹ï¼Œå…ˆç•¥è¿‡ã€‘\n        2ã€åŒ…å« RecentTasks æœ€è¿‘è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨\n    */\n    mActivityTaskManager.onSystemReady();\n    mUserController.onSystemReady();\n    //è®¿é—®æ§åˆ¶ï¼Œä¸»è¦ä¸æƒé™ã€é™åˆ¶ç›¸å…³\n    mAppOpsService.systemReady();\n    mProcessList.onSystemReady();\n\n    /*\n        1ã€å¦‚æœè¿›ç¨‹æˆ–è¿›ç¨‹ç»„è¢«æ ‡è®°ä¸ºæ€æ­»ï¼Œå°†è°ƒç”¨ Process.killProcessQuiet(mPid);ProcessList.killProcessGroup(uid, mPid);æ€æ­»è¿›ç¨‹ï¼Œä¸ºå¯åŠ¨æ–°è¿›ç¨‹åšå‡†å¤‡\n        2ã€å½“ç„¶ï¼Œè¿›ç¨‹ä¹Ÿå¯èƒ½è¢«æ ‡è®°ä¸ºé‡å¯ï¼Œä¾¿ä¸ä¼šä»è¿›ç¨‹é˜Ÿåˆ—ä¸­ç§»é™¤       \n    */\n    mProcessList.removeProcessLocked\n    //æ³¨å†Œå¯åŠ¨ç›‘å¬ï¼ŒATMï¼šactivitTaskManager\n    mAtmInternal.getLaunchObserverRegistry().registerLaunchObserver(mActivityLaunchObserver);\n    //UGMï¼šuri global managerï¼Œuri ä½œä¸ºæ•°æ®è®¿é—®åœ°å€ã€æ•°æ®ä¼ é€’ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„\n    mUgmInternal.onSystemReady();\n    //pmiï¼špower manager internalï¼Œä½ç”µé‡ç›‘æ§\n    pmi.registerLowPowerModeObserver\n    \n    \n    //ğŸ˜“æ‰§è¡Œåˆ°ä¸€åŠå°±è¿”å›å»æ‰§è¡Œå›è°ƒã€è¯·å‚è€ƒ â€”â€” å›è°ƒ1ã€‘\n    if (goingCallback != null) goingCallback.run();\n        \n    /*\n        1ã€å¯åŠ¨æŒä¹…åº”ç”¨ï¼ˆä¸ä¼šä¼‘çœ çš„ã€å¯åŠ¨å”¤é†’ç¨‹åºï¼‰ï¼Œå¾…å¯åŠ¨çš„æ˜¯å“ªäº›åº”ç”¨ï¼Œåˆæ¥åˆ°äº† IPackageManager.aidl çš„ getPersistentApplicationsï¼Œ\n           å®ç°ç±»æ˜¯ PackageManagerService.java\n        2ã€getPersistentApplications å®é™…ä¸Šè·å–åˆ°çš„æ˜¯ä¸€ä¸ª ApplicationInfo åˆ—è¡¨\n        3ã€é€šè¿‡ applicationInfo åˆ›å»º processRecorderï¼Œæ¥ç€é€šè¿‡ ProcessList ä¸€é¡¿åˆ¤æ–­ã€è°ƒæ•´ processRecorder\n        4ã€æœ€åå¯èƒ½é€šè¿‡ wzygote æˆ– Process.start å¯åŠ¨\n    */\n    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);\n\n    //ActivityTaskManagerInternal.java å®ç°ç±»åœ¨ ActivityManagerService çš„ä¸€ä¸ªå†…éƒ¨ç±» LocalServiceï¼›\n    //â€¼ï¸å¯åŠ¨æ¡Œé¢ç¨‹åº\n    mAtmInternal.startHomeOnAllDisplays(currentUserId, \"systemReady\");\n    \n    mAtmInternal.resumeTopActivities(false /* scheduleIdle */);    \n}\n```\n\nAMS å‡†å¤‡å®Œæ¯•ï¼Œè¯·æ±‚ SystemServer è¶…çº§ç®¡å®¶æ‰§è¡Œå›è°ƒ\n\n```java\n//SystemServer.java ã€å›è°ƒ1ã€‘\nmActivityManagerService.systemReady(() -> {\n\n    //service.onBootPhase(mCurrentPhase=500); ç³»ç»ŸæœåŠ¡é‚£ä¹ˆå¤šåˆ°åº•è°åœ¨æ‰§è¡Œ 500 è¿™ä¸ªæ ‡è®°ï¼Ÿ\n    //ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œå›è°ƒå‘ŠçŸ¥å…¶ä»–æœåŠ¡ AMS å¯åŠ¨äº†ï¼Œä½ ä»¬å¯ä»¥ä½¿ç”¨ AMS åšåˆ«çš„äº‹æƒ…\n    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_ACTIVITY_MANAGER_READY);\n    \n    //AMS éœ€è¦ç›‘æ§ native å´©æºƒï¼Œé‡Œé¢å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ Threadï¼Œå†…éƒ¨ä½¿ç”¨é˜»å¡çš„ socket æ¥æ”¶å´©æºƒä¿¡æ¯å¹¶è¿”å›ç»™ä¸Šå±‚æˆ–è¾“å‡º\n    mActivityManagerService.startObservingNativeCrashes();\n\n    //çœ‹åˆ° ops å¾€å¾€æ˜¯è·Ÿé™åˆ¶ç­–ç•¥æœ‰å…³ğŸš«\n    mActivityManagerService.setAppOpsPolicy(new AppOpsPolicy(mSystemContext));\n\n    // Wait for all packages to be prepared\n    mPackageManagerService.waitForAppDataPrepared();\n    //ç¬¬ä¸‰æ–¹åº”ç”¨å‡†å¤‡å¥½äº†ï¼Œåˆå‘èµ·ä¸€ä¸ªå¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„å›è°ƒï¼Œè®©å„è‡ªå®ç°æ­¤çŠ¶æ€ç çš„æœåŠ¡æ‰§è¡Œç›¸åº”æ“ä½œã€è§å›¾1ã€‘\n    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);\n\n    ... etc\n    \n    //åˆ°è¿™é‡Œæˆ‘ä»¬ç®—æ˜¯å›è°ƒæ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬åˆè¦å›åˆ° systemReady é‡Œé¢å»ï¼Œç»§ç»­çœ‹æ‰§è¡Œ goingCallback.run(); ä¹‹åçš„ä»£ç \n    \n}, t);\n```\n\n# startHomeOnAllDisplays\n\næˆ‘ä»¬æƒ³çŸ¥é“ startHomeOnAllDisplays çš„å…·ä½“å®ç°åœ¨å“ªé‡Œï¼Ÿæœ‰è°æ‰§è¡Œçš„ï¼Ÿä¸å¦¨æ‰¾æ‰¾çœ‹ã€‚\n\n- ActivityManagerService#mAtmInternal.startHomeOnAllDisplays(currentUserId, \"systemReady\"); `AMS ä¸­è°ƒç”¨`\n- ActivityTaskManagerInternal#startHomeOnAllDisplays   `è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•`\n- ActivityTaskManagerService#LocalService            `å®ç°ç±»æ˜¯ ATMS çš„å†…éƒ¨ç±»`\n- ActivityTaskManagerService#mInternal; `å®ç°ç±»å®ä¾‹èµ‹ç»™äº† ATMS çš„æˆå‘˜`\n- ActivityTaskManagerService#LocalServices.addService(ActivityTaskManagerInternal.class, mInternal); `åœ¨ ATMS å¯åŠ¨å‘¨æœŸ onStart ä¸­è¢«ç¼“å­˜åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨`\n- com.android.server#private static final ArrayMap<Class<?>, Object> sLocalServiceObjects `æœ¬åœ°æœåŠ¡åˆ—è¡¨å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ•°ç»„`\n- ActivityTaskManagerService#mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class); `ä»æœ¬åœ°æœåŠ¡ç¼“å­˜åˆ—è¡¨ä¸­è·å–å®ä¾‹èµ‹ç»™ ATMS`\n\näº†è§£äº†ï¼Œç›´æ¥æ‰¾å®ç°ç±» `LocalService`ã€‚\n\n```java\n//ActivityTaskManagerService.java#LocalService\n@Override\npublic boolean startHomeOnAllDisplays(int userId, String reason) {\n    synchronized (mGlobalLock) {\n        return mRootWindowContainer.startHomeOnAllDisplays(userId, reason);\n    }\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnAllDisplays(int userId, String reason) {\n    //æ¡Œé¢ä¸»ç•Œé¢æ˜¯å¦å¯åŠ¨å®Œæ¯•\n    boolean homeStarted = false;\n    //è¿™é‡Œçš„å¾ªç¯è¡¨ç¤ºå¯¹åº” AllDisplaysï¼Œè®¾å¤‡æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªæ˜¾ç¤ºå™¨çš„\n    for (int i = getChildCount() - 1; i >= 0; i--) {\n        final int displayId = getChildAt(i).mDisplayId;\n        homeStarted |= startHomeOnDisplay(userId, reason, displayId);\n    }\n    return homeStarted;\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnDisplay(int userId, String reason, int displayId) {\n    return startHomeOnDisplay(userId, reason, displayId, false /* allowInstrumenting */,\n            false /* fromHomeKey */);\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnDisplay(int userId, String reason, int displayId, boolean allowInstrumenting,\n        boolean fromHomeKey) {\n    //å¦‚æœé‡åˆ°æ— æ•ˆçš„æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æˆ–å·²è·å¾—ç„¦ç‚¹çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºID\n    if (displayId == INVALID_DISPLAY) {\n        final Task rootTask = getTopDisplayFocusedRootTask();\n        displayId = rootTask != null ? rootTask.getDisplayId() : DEFAULT_DISPLAY;\n    }\n\n    final DisplayContent display = getDisplayContent(displayId);\n    return display.reduceOnAllTaskDisplayAreas((taskDisplayArea, result) ->\n                    result | startHomeOnTaskDisplayArea(userId, reason, taskDisplayArea,\n                            allowInstrumenting, fromHomeKey),\n            false /* initValue */);\n}\n```\n    \n```java\n//RootWindowContainer.java\nboolean startHomeOnTaskDisplayArea(int userId, String reason, TaskDisplayArea taskDisplayArea,\n        boolean allowInstrumenting, boolean fromHomeKey) {\n    //å¦‚æœæä¾›çš„ç°å®åŒºåŸŸæ— æ•ˆï¼ŒåŒæ ·çš„æ¢å¤é»˜è®¤\n    if (taskDisplayArea == null) {\n        final Task rootTask = getTopDisplayFocusedRootTask();\n        taskDisplayArea = rootTask != null ? rootTask.getDisplayArea()\n                : getDefaultTaskDisplayArea();\n    }\n\n    //â€¼ï¸é‡è¦çš„æ¥äº†ï¼Œæ¡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ª activityï¼Œå¯åŠ¨ä¸€ä¸ª activityï¼Œæœ€é‡è¦çš„ä¾¿æ˜¯å¯åŠ¨ç›®æ ‡ä¿¡æ¯\n    Intent homeIntent = null;\n    ActivityInfo aInfo = null;\n    //\n    if (taskDisplayArea == getDefaultTaskDisplayArea()) {\n        /*\n            1ã€mService æ˜¯ ActivityTaskManagerService\n            2ã€ã€é»˜è®¤ã€‘intent.addCategory(Intent.CATEGORY_HOME); mTopAction = Intent.ACTION_MAIN;\n        */\n        homeIntent = mService.getHomeIntent();\n        aInfo = resolveHomeActivity(userId, homeIntent);\n    } else if (shouldPlaceSecondaryHomeOnDisplayArea(taskDisplayArea)) {\n        Pair<ActivityInfo, Intent> info = resolveSecondaryHomeActivity(userId, taskDisplayArea);\n        aInfo = info.first;\n        homeIntent = info.second;\n    }\n    if (aInfo == null || homeIntent == null) {\n        return false;\n    }\n\n    //æ˜¾ç¤ºæ€»æ˜¯æœ‰ä¸€äº›æ˜¾ç¤º\n    if (!canStartHomeOnDisplayArea(aInfo, taskDisplayArea, allowInstrumenting)) {\n        return false;\n    }\n\n    homeIntent.setComponent(new ComponentName(aInfo.applicationInfo.packageName, aInfo.name));\n    homeIntent.setFlags(homeIntent.getFlags() | FLAG_ACTIVITY_NEW_TASK);\n    if (fromHomeKey) {\n        homeIntent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, true);\n        if (mWindowManager.getRecentsAnimationController() != null) {\n            mWindowManager.getRecentsAnimationController().cancelAnimationForHomeStart();\n        }\n    }\n    homeIntent.putExtra(WindowManagerPolicy.EXTRA_START_REASON, reason);\n\n    //å¯åŠ¨ activity è¿˜å¾—çœ‹ activityStartController\n    mService.getActivityStartController().startHomeActivity(homeIntent, aInfo, myReason,\n            taskDisplayArea);\n    return true;\n}\n```\n\n\n# activitStartController\n\n```java \n//ActivityStartController.java\n//âš ï¸ï¼šè¿™é‡Œå¯åŠ¨çš„æ˜¯ homeItent\nvoid startHomeActivity(Intent intent, ActivityInfo aInfo, String reason,\n        TaskDisplayArea taskDisplayArea) {\n    //æ²¡æœ‰ä»»ä½•é™„åŠ å±æ€§ï¼Œæ¯”å¦‚æ²¡æœ‰ activity åŠ¨ç”»\n    final ActivityOptions options = ActivityOptions.makeBasic();\n    //å…¨å±çª—å£æ¨¡å¼\n    options.setLaunchWindowingMode(WINDOWING_MODE_FULLSCREEN);\n    if (!ActivityRecord.isResolverActivity(aInfo.name)) {\n        //æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªæ¡Œé¢ activity \n        options.setLaunchActivityType(ACTIVITY_TYPE_HOME);\n    }\n\n    //æ˜¾ç¤ºè®¾å¤‡IDä¹ŸæŒ‡å®šï¼Œä¼¼ä¹ activity å¯åŠ¨éœ€è¦çš„å‚æ•°éƒ½å°†å°è£…åˆ° ActivitOptions \n    final int displayId = taskDisplayArea.getDisplayId();\n    options.setLaunchDisplayId(displayId);\n    options.setLaunchTaskDisplayArea(taskDisplayArea.mRemoteToken\n            .toWindowContainerToken());\n\n    //åªæ˜¯ä¸€ä¸ªå˜é‡é€’å¢ mDeferResumeCount++ï¼Œè¿™å¦‚ä½•ä½¿ç”¨ \n    mSupervisor.beginDeferResume();\n\n    final Task rootHomeTask;\n    try {\n        /*\n            1ã€activity éœ€è¦ä¾èµ– task å®¹å™¨ï¼Œæ‰€ä»¥å¯åŠ¨å‰å¿…é¡»ç¡®ä¿ Task å·²åˆ›å»º\n            2ã€TaskDisplayArea#createRootTask éœ€æŒ‡å®š activityType=home_activityï¼Œontop=true åœ¨æ˜¾ç¤ºå™¨çš„é¡¶éƒ¨åˆ›å»º rootTask\n            3ã€æœ€ç»ˆåˆ›å»ºæ˜¯é€šè¿‡ Task.Builder()......build();  è‡³æ­¤ï¼Œå­˜å‚¨æ¡Œé¢ activity çš„ Task å·²ç»æœ‰äº†\n            4ã€mRootWindowContainer è¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘ä»¬æ‰€è§åˆ°çš„ç•Œé¢éƒ½è¦ä¾é™„äºå®ƒ\n        */\n        rootHomeTask = taskDisplayArea.getOrCreateRootHomeTask(ON_TOP/*true*/);\n    } finally {\n        //è¿™ä¸ªè·Ÿ mDeferResumeCount++ å¯¹åº”ï¼Œè¿™é‡Œæ˜¯ mDeferResumeCount--\n        //å…³äºè¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šreadyToResume() {return mDeferResumeCount == 0;} \n        //true if resume can be calledï¼šé‚£ä¼°è®¡æ˜¯å“ªé‡Œè¿›è¡Œè½®è¯¢ç›‘å¬ readyToResume()\n        mSupervisor.endDeferResume();\n    }\n\n    /*\n        1ã€æœ‰äº†å¯æ‰¿è½½æ¡Œé¢ç¨‹åºçš„ä»»åŠ¡æ ˆï¼Œæ¥ç€å°±è¦å¯åŠ¨æ¡Œé¢ activity\n        2ã€è·å¾—ä¸€ä¸ª activity å¯åŠ¨å™¨ ActivitStarterï¼Œå¼€å§‹æ‰§è¡Œ excute()\n        3ã€å¯åŠ¨å™¨ä¼¼ä¹ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œé»˜è®¤å¯åŠ¨å™¨æ•°é‡ 3 ä¸ª\n        4ã€å¯åŠ¨å™¨ä¸»è¦æˆå‘˜æœ‰ ActivityStartControllerã€ActivityTaskManagerServiceã€ActivityTaskSupervisorã€ActivityStartInterceptor\n        5ã€åœ¨æ„å»ºè¯·æ±‚å™¨è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ„é€ å¯åŠ¨è¯·æ±‚å‚æ•° mRequest \n    */\n    mLastHomeActivityStartResult = obtainStarter(intent, \"startHomeActivity: \" + reason)\n            .setOutActivity(tmpOutRecord)\n            .setCallingUid(0)\n            .setActivityInfo(aInfo)\n            .setActivityOptions(options.toBundle())\n            .execute();\n    mLastHomeActivityStartRecord = tmpOutRecord[0];\n    if (rootHomeTask.mInResumeTopActivity) {\n        //å¼€å§‹è°ƒç”¨ onResume å£°æ˜å‘¨æœŸæ–¹æ³•ï¼Œå›åˆ° activity æœ€ç†Ÿæ‚‰çš„åœ°æ–¹\n        mSupervisor.scheduleResumeTopActivities();\n    }\n}\n```\n\nå…³äº `ActivityTaskSupervisor` è´Ÿè´£çš„ä»»åŠ¡å¤ªå¤šäº†ï¼Œä¼°è®¡åƒä¸ªç‰ˆæœ¬è¦åˆ†ç¦»éƒ¨åˆ†ä»£ç å§\n\n```java\n// TODO: This class has become a dumping ground. Let's\n// - Move things relating to the hierarchy to RootWindowContainer\n// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler\n// - Move interface things to ActivityTaskManagerService.\n// - All other little things to other files.\npublic class ActivityTaskSupervisor implements RecentTasks.Callbacks {\n\n}\n```\n\n\n# activityStarter\n\n```java\n//ActivityStarter.java\nint execute() {\n    try {\n        /*\n            1ã€å¦‚æœå¯åŠ¨è¯·æ±‚ä¿¡æ¯æ— æ•ˆï¼Œåˆ™é‡æ–°è§£æå¹¶å¡«å……å¯åŠ¨è¯·æ±‚å‚æ•°\n            2ã€è¯·æ±‚å‚æ•°åŒ…æ‹¬ pidã€uidã€resolveInfoã€activityInfo  .etc\n        */\n        if (mRequest.activityInfo == null) {\n            mRequest.resolveActivity(mSupervisor);\n        }\n\n        int res;\n        //mGlobalLock å…¨å±€æœåŠ¡é”ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡\n        synchronized (mService.mGlobalLock) {\n            final boolean globalConfigWillChange = mRequest.globalConfig != null\n                    && mService.getGlobalConfiguration().diff(mRequest.globalConfig) != 0;\n            final Task rootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();\n            if (rootTask != null) {\n                rootTask.mConfigWillChange = globalConfigWillChange;\n            }\n            final long origId = Binder.clearCallingIdentity();\n\n            /*\n                1ã€ä»€ä¹ˆé‡é‡çº§è¿›ç¨‹åˆ‡æ¢ï¼Œæˆ‘éƒ½æ‡µäº†ğŸ˜º\n                2ã€å¦‚æœæ‰¾ä¸åˆ°è°ƒç”¨è€… app è¿›ç¨‹ï¼Œåˆ™ç»ˆæ­¢å¯åŠ¨è¯·æ±‚ ATMS.getProcessController(request.caller) == null\n            */\n            res = resolveToHeavyWeightSwitcherIfNeeded();\n            if (res != START_SUCCESS) {\n                return res;\n            }\n\n            //â€¼ï¸æ‰§è¡Œå¯åŠ¨è¯·æ±‚\n            res = executeRequest(mRequest);\n\n            mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(launchingState, res,\n                    newActivityCreated, mLastStartActivityRecord, originalOptions);\n            if (mRequest.waitResult != null) {\n                mRequest.waitResult.result = res;\n                res = waitResultIfNeeded(mRequest.waitResult, mLastStartActivityRecord,\n                        launchingState);\n            }\n            return getExternalResult(res);\n        }\n    } finally {\n        //æ‰§è¡Œå®Œæˆæœ€åä¸€å®šè¦å›æ”¶ activity å¯åŠ¨å™¨\n        onExecutionComplete();\n    }\n}\n```\n\nactivity å¯åŠ¨è¯·æ±‚æ­£å¼å¼€å§‹ï¼Œè¿™é‡Œå°†ä¼šæœ‰å¾ˆå¤šçš„å¯åŠ¨é™åˆ¶ğŸš«ç­‰ã€‚\n\n```java\n//ActivitStarter.java\nprivate int executeRequest(Request request) {\n    //å¾ˆå¥½å¥‡è¿™ä¸ª reason è¿™ä¹ˆæ€»è¦å—ï¼Ÿå¹²ä»€ä¹ˆç”¨çš„\n    if (TextUtils.isEmpty(request.reason)) {\n        throw new IllegalArgumentException(\"Need to specify a reason.\");\n    }\n    \n    //å¦‚æœä¸­é€”æ£€æµ‹åˆ°æ˜¯éå¯åŠ¨æˆåŠŸï¼ˆè§¦å‘å¯åŠ¨é™åˆ¶ï¼‰ï¼Œé‚£ä¹ˆç«‹é©¬ç»“æŸè¯·æ±‚ï¼Œè¿”å›ç»“æœ\n    int err = ActivityManager.START_SUCCESS;\n    // Pull the optional Ephemeral Installer-only bundle out of the options early.\n    final Bundle verificationBundle =\n            options != null ? options.popAppVerificationBundle() : null;\n\n    //âŒé™åˆ¶1ï¼šæ ¹æ®å¯åŠ¨è¯·æ±‚è°ƒç”¨è€… caller å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯åŠ¨ app è¿›ç¨‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›æ‹¦æˆªè¯·æ±‚\n    WindowProcessController callerApp = null;\n    if (caller != null) {\n        callerApp = mService.getProcessController(caller);\n        if (callerApp != null) {\n            callingPid = callerApp.getPid();\n            callingUid = callerApp.mInfo.uid;\n        } else {\n            err = START_PERMISSION_DENIED;\n        }\n    }\n\n    final int launchFlags = intent.getFlags();\n    if ((launchFlags & Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 && sourceRecord != null) {\n        //âŒä»€ä¹ˆè¯·æ±‚å†²çªï¼Ÿï¼Ÿï¼Ÿ\n        if (requestCode >= 0) {\n            SafeActivityOptions.abort(options);\n            return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;\n        }\n    }\n\n    if (err == ActivityManager.START_SUCCESS && intent.getComponent() == null) {\n        //âŒå¯åŠ¨ç›®æ ‡ activity æœªçŸ¥ï¼Œå¤±è´¥\n        err = ActivityManager.START_INTENT_NOT_RESOLVED;\n    }\n\n    if (err == ActivityManager.START_SUCCESS && aInfo == null) {\n        //âŒåŒæ ·çš„ï¼Œè¯·æ±‚æ‰€éœ€è¦çš„åŸºç¡€ä¿¡æ¯éƒ½æœªçŸ¥ï¼Œè‡ªç„¶ä¸­æ–­æœ¬æ¬¡è¯·æ±‚\n        err = ActivityManager.START_CLASS_NOT_FOUND;\n    }\n\n    // voiceSession è¯­éŸ³äº¤äº’ç›¸å…³ activityã€è¿™é‡Œå…¶å®æ˜¯ activity å¯åŠ¨éƒ½ä¼šç»è¿‡çš„è·¯é€”ï¼Œåªæ˜¯æˆ‘ä»¬æœ¬æ¬¡åˆ†æçš„æ˜¯â€˜å¯åŠ¨æ¡Œé¢ activityâ€™ã€‘\n    if (err == ActivityManager.START_SUCCESS && sourceRecord != null\n            && sourceRecord.getTask().voiceSession != null) {\n        if ((launchFlags & FLAG_ACTIVITY_NEW_TASK) == 0\n                && sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) {\n            try {\n                intent.addCategory(Intent.CATEGORY_VOICE);\n                if (!mService.getPackageManager().activitySupportsIntent(\n                        intent.getComponent(), intent, resolvedType)) {\n                    //âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ\n                    err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n                }\n            } catch (RemoteException e) {\n                //âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ\n                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n            }\n        }\n    }\n\n    if (err == ActivityManager.START_SUCCESS && voiceSession != null) {\n        try {\n            if (!mService.getPackageManager().activitySupportsIntent(intent.getComponent(),\n                    intent, resolvedType)) {\n                //âŒä¸æ”¯æŒ\n                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n            }\n        } catch (RemoteException e) {\n            //âŒä¸æ”¯æŒ\n            err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n        }\n    }\n\n    if (err != START_SUCCESS) {\n        SafeActivityOptions.abort(options);\n        return err;\n    }\n\n    //æ£€æŸ¥ activity å¯åŠ¨æ˜¯å¦æ»¡è¶³æ¡ä»¶\n    boolean abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,\n            requestCode, callingPid, callingUid, callingPackage, callingFeatureId,\n            request.ignoreTargetSecurity, inTask != null, callerApp, resultRecord,\n            resultRootTask);\n    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,\n            callingPid, resolvedType, aInfo.applicationInfo);\n    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,\n            callingPackage);\n\n    boolean restrictedBgActivity = false;\n    if (!abort) {\n        try {\n            //ç»§ç»­æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯åŠ¨æ¡ä»¶\n            restrictedBgActivity = shouldAbortBackgroundActivityStart(callingUid,\n                    callingPid, callingPackage, realCallingUid, realCallingPid, callerApp,\n                    request.originatingPendingIntent, request.allowBackgroundActivityStart,\n                    intent);\n        } finally {\n\n        }\n    }\n\n     \n    //ç•¥ç•¥ç•¥ï½ï½ï½\n\n\n    //æ²¡æœ‰é€šè¿‡å¯åŠ¨æ£€æŸ¥å°±è¦ç»“æŸæ‰§è¡Œäº†\n    if (abort) {\n        ActivityOptions.abort(checkedOptions);\n        return START_ABORTED;\n    }\n\n    if (aInfo != null) {\n        if (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired(\n                aInfo.packageName, userId)) {\n            final IIntentSender target = mService.getIntentSenderLocked(\n                    ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage, callingFeatureId,\n                    callingUid, userId, null, null, 0, new Intent[]{intent},\n                    new String[]{resolvedType}, PendingIntent.FLAG_CANCEL_CURRENT\n                            | PendingIntent.FLAG_ONE_SHOT, null);\n\n            Intent newIntent = new Intent(Intent.ACTION_REVIEW_PERMISSIONS);\n\n            int flags = intent.getFlags();\n            flags |= Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS;\n\n            //è®¾ç½®å¯åŠ¨æ ‡è¯†ï¼Œä»…è®¾ç½® NEW_TASK æŸäº›åœºæ™¯ä¸ä¸€å®šä¼šçœŸçš„åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œä½†å¯ä»¥ç½®ä¸º MULTIPLE_TASK\n            if ((flags & (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_NEW_DOCUMENT)) != 0) {\n                flags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;\n            }\n            newIntent.setFlags(flags);\n\n            newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName);\n            newIntent.putExtra(Intent.EXTRA_INTENT, new IntentSender(target));\n            if (resultRecord != null) {\n                newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, true);\n            }\n            intent = newIntent;\n\n            //ä¸€å †æ•°æ®è§£æå’Œèµ‹å€¼å°±ä¸çœ‹äº†\n            intentGrants = null;\n            resolvedType = null;\n            callingUid = realCallingUid;\n            callingPid = realCallingPid;\n            rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, 0,\n                    computeResolveFilterUid(\n                            callingUid, realCallingUid, request.filterCallingUid));\n            aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags,\n                    null /*profilerInfo*/);\n        }\n    }\n\n    if (rInfo != null && rInfo.auxiliaryInfo != null) {\n        //ä¸‡äº‹ä¿±å¤‡ï¼Œå‡†å¤‡å¾…å‘ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥å¯åŠ¨çš„ intent ï¼ˆä¹Ÿå°±æ˜¯å¯åŠ¨æ•°æ®æ¯ä¸ªå¿…è¦çš„ä¸å¯å°‘ï¼‰\n        //åº”è¯¥æ˜¯æœ‰ç‰¹åˆ«ä¹‹å¤„çš„ï¼Œä¸ç„¶ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„ intentï¼Œå…·ä½“å°±ä¸çº ç»“äº†\n        intent = createLaunchIntent(rInfo.auxiliaryInfo, request.ephemeralIntent,\n                callingPackage, callingFeatureId, verificationBundle, resolvedType, userId);\n        resolvedType = null;\n        callingUid = realCallingUid;\n        callingPid = realCallingPid;\n        intentGrants = null;\n        aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, null /*profilerInfo*/);\n    }\n\n    //æ¯ä¸€ä¸ª activity çš„ä¿¡æ¯éƒ½å°†è®°å½•åœ¨ ActivityRecord ä¸­\n    final ActivityRecord r = new ActivityRecord.Builder(mService)\n            .setCaller(callerApp)\n            .setLaunchedFromPid(callingPid)\n            .setLaunchedFromUid(callingUid)\n            .setLaunchedFromPackage(callingPackage)\n            .setLaunchedFromFeature(callingFeatureId)\n            .setIntent(intent)\n            .setResolvedType(resolvedType)\n            .setActivityInfo(aInfo)\n            .setConfiguration(mService.getGlobalConfiguration())\n            .setResultTo(resultRecord)\n            .setResultWho(resultWho)\n            .setRequestCode(requestCode)\n            .setComponentSpecified(request.componentSpecified)\n            .setRootVoiceInteraction(voiceSession != null)\n            .setActivityOptions(checkedOptions)\n            .setSourceRecord(sourceRecord)\n            .build();\n\n    mLastStartActivityRecord = r;\n    //â€¼ï¸å¥½äº†ï¼Œåˆåˆ°ä¸‹ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ\n    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,\n            request.voiceInteractor, startFlags, true /* doResume */, checkedOptions,\n            inTask, inTaskFragment, restrictedBgActivity, intentGrants);\n\n    if (request.outActivity != null) {\n        request.outActivity[0] = mLastStartActivityRecord;\n    }\n    return mLastStartActivityResult;\n}\n```\n\n## checkStartAnyActivityPremission\n\nä»»ä½•ä¸€ä¸ª activity å¯åŠ¨éƒ½éœ€è¦æ£€æŸ¥æƒé™é—®é¢˜ã€‚\n\n```java\n//ActivitTaskSupervisor.java\nboolean checkStartAnyActivityPermission(Intent intent, ActivityInfo aInfo, String resultWho,\n        int requestCode, int callingPid, int callingUid, String callingPackage,\n        @Nullable String callingFeatureId, boolean ignoreTargetSecurity,\n        boolean launchingInTask, WindowProcessController callerApp, ActivityRecord resultRecord,\n        Task resultRootTask) {\n    //0ã€âœ…å¦‚æœæ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç»„ä»¶ å¹¶ä¸” æ˜¯å½“å‰æ ˆä¸­è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    final boolean isCallerRecents = mService.getRecentTasks() != null\n            && mService.getRecentTasks().isCallerRecents(callingUid);\n    /*\n        1ã€âœ…å¦‚æœæ˜¯å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™çš„åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.ROOT_UID\n        2ã€âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.SYSTEM_UID\n        3ã€âŒå¦‚æœæ˜¯ä¸åŒè¿›ç¨‹æ˜¯ä¸å…è®¸çš„ UserHandle.isIsolated(uid)\n        4ã€âœ…å¦‚æœæ˜¯è®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ UserHandle.isSameApp(uid, owningUid)\n        5ã€âŒå¦‚æœç›®æ ‡ activity exported=false æ˜¯ä¸è¢«å…è®¸å¯åŠ¨çš„\n        6ã€âŒå¦‚æœæ£€æŸ¥çš„æƒé™å­˜åœ¨ â€˜ç¦æ­¢æƒé™åˆ—è¡¨â€™ä¸­æ˜¯ä¸è¢«å…è®¸çš„  [è‡³äºåˆ—è¡¨ä¸­éƒ½æœ‰å“ªäº›æƒé™æˆ‘ä»¬ä»¥åè®¨è®º]\n    */\n    final int startAnyPerm = mService.checkPermission(START_ANY_ACTIVITY, callingPid,\n            callingUid);\n    if (startAnyPerm == PERMISSION_GRANTED || (isCallerRecents && launchingInTask)) {\n        return true;\n    }\n\n    //âŒcomponent é™åˆ¶ ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkComponentPermissionã€‘\n    final int componentRestriction = getComponentRestrictionForCallingPackage(aInfo,\n            callingPackage, callingFeatureId, callingPid, callingUid, ignoreTargetSecurity);\n    //âŒaction é™åˆ¶  ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkPermissionã€‘\n    final int actionRestriction = getActionRestrictionForCallingPackage(\n            intent.getAction(), callingPackage, callingFeatureId, callingPid, callingUid);\n    if (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION\n            || actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) {\n        if (resultRecord != null) {\n            resultRecord.sendResult(INVALID_UID, resultWho, requestCode,\n                    Activity.RESULT_CANCELED, null /* data */, null /* dataGrants */);\n        }\n        throw new SecurityException(msg);\n    }\n\n    if (actionRestriction == ACTIVITY_RESTRICTION_APPOP) {\n        return false;\n    } else if (componentRestriction == ACTIVITY_RESTRICTION_APPOP) {\n        return false;\n    }\n\n    return true;\n}\n```\n\n## checkIntent\n\nmService.mIntentFirewall.checkStartActivity æœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ intent è¿‡æ»¤ã€‚\n\n```java\n//IntentFirewall.java\npublic boolean checkIntent(FirewallIntentResolver resolver, ComponentName resolvedComponent,\n        int intentType, Intent intent, int callerUid, int callerPid, String resolvedType,\n        int receivingUid) {\n    boolean log = false;\n    boolean block = false;\n\n    List<Rule> candidateRules;\n    candidateRules = resolver.queryIntent(intent, resolvedType, false /*defaultOnly*/, 0);\n    if (candidateRules == null) {\n        candidateRules = new ArrayList<Rule>();\n    }\n    resolver.queryByComponent(resolvedComponent, candidateRules);\n\n    for (int i=0; i<candidateRules.size(); i++) {\n        Rule rule = candidateRules.get(i);\n        //intent è¿‡æ»¤è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œè§„åˆ™æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼Ÿä¸æ‡‚â€”â€”â€”â€”ç•¥ï¼\n        if (rule.matches(this, resolvedComponent, intent, callerUid, callerPid, resolvedType,\n                receivingUid)) {\n            block |= rule.getBlock();\n            log |= rule.getLog();\n            if (block && log) {\n                break;\n            }\n        }\n    }\n\n    if (log) {\n        logIntent(intentType, intent, callerUid, resolvedType);\n    }\n\n    return !block;\n}\n```\n\n\n## checkStartActivity\n\nPermissionPolicyInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PermissionPolicyService çš„ä¸€ä¸ªå†…éƒ¨ç±» `private class Internal extends PermissionPolicyInternal `\n\n```java\n//PermissionPolicyService.java\nprivate class Internal extends PermissionPolicyInternal {\n\n    @Override\n    public boolean checkStartActivity(@NonNull Intent intent, int callingUid,\n            @Nullable String callingPackage) {\n        if (callingPackage != null && isActionRemovedForCallingPackage(intent, callingUid,\n                callingPackage)) {\n            return false;\n        }\n        return true;\n    }\n```\n\n\n```java\n//PermissionPolicyService.java\nprivate boolean isActionRemovedForCallingPackage(@NonNull Intent intent, int callingUid,\n        @NonNull String callingPackage) {\n    String action = intent.getAction();\n    if (action == null) {\n        return false;\n    }\n    switch (action) {\n        case TelecomManager.ACTION_CHANGE_DEFAULT_DIALER:\n        case Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT: {\n            ApplicationInfo applicationInfo;\n            try {\n                applicationInfo = getContext().getPackageManager().getApplicationInfoAsUser(\n                        callingPackage, 0, UserHandle.getUserId(callingUid));\n                if (applicationInfo.targetSdkVersion >= Build.VERSION_CODES.Q) {\n                    //åªæœ‰é«˜ç‰ˆæœ¬æ‰ä¼šæ£€æŸ¥è¿™ä¸ªé—®é¢˜å’¯\n                    return true;\n                }\n            } catch (PackageManager.NameNotFoundException e) {\n                \n            }\n          \n            intent.putExtra(Intent.EXTRA_CALLING_PACKAGE, callingPackage);\n            return false;\n        }\n        default:\n            return false;\n    }\n}\n```\n\n## shouldAbortBackgroundActivityStart\n\n```java\nboolean shouldAbortBackgroundActivityStart(int callingUid, int callingPid,\n        final String callingPackage, int realCallingUid, int realCallingPid,\n        WindowProcessController callerApp, PendingIntentRecord originatingPendingIntent,\n        boolean allowBackgroundActivityStart, Intent intent) {\n    \n    //1ã€âœ…ç³»ç»Ÿç”¨æˆ·åº”ç”¨ã€å…·æœ‰ Root æƒé™çš„åº”ç”¨ã€NFC ï¼ˆä¸€èˆ¬æ˜¯ä¼´ç”Ÿè®¾å¤‡ï¼‰åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    final int callingAppId = UserHandle.getAppId(callingUid);\n    if (callingUid == Process.ROOT_UID || callingAppId == Process.SYSTEM_UID\n            || callingAppId == Process.NFC_UID) {\n        return false;\n    }\n\n    //2ã€âœ…å¦‚æœæ˜¯æ¡Œé¢ç¨‹åºå¯åŠ¨æ˜¯å…è®¸çš„  [æ­£å¸¸ç”¨æˆ·æ“ä½œä¸å°±æ˜¯ç‚¹å‡»æ¡Œé¢åº”ç”¨å›¾æ ‡ç„¶åå¯åŠ¨çš„å˜›]\n    if (isHomeApp(callingUid, callingPackage)) {\n        return false;\n    }\n\n    //3ã€âœ…è®¾å¤‡æ‰€æœ‰è€…æ˜¯å…è®¸çš„\n    final WindowState imeWindow = mRootWindowContainer.getCurrentInputMethodWindow();\n    if (imeWindow != null && callingAppId == imeWindow.mOwnerUid) {\n        return false;\n    }\n\n    //4ã€âœ…å¦‚æœæœ‰å‰å°åº”ç”¨æˆ–å¯è§ç•Œé¢å­˜åœ¨å‰å°ï¼Œè¿™ä¹Ÿæ˜¯å…è®¸çš„\n    final int appSwitchState = mService.getBalAppSwitchesState();\n    final int callingUidProcState = mService.mActiveUids.getUidState(callingUid);\n    final boolean callingUidHasAnyVisibleWindow = mService.hasActiveVisibleWindow(callingUid);\n    final boolean isCallingUidForeground = callingUidHasAnyVisibleWindow\n            || callingUidProcState == ActivityManager.PROCESS_STATE_TOP\n            || callingUidProcState == ActivityManager.PROCESS_STATE_BOUND_TOP;\n    final boolean isCallingUidPersistentSystemProcess =\n            callingUidProcState <= ActivityManager.PROCESS_STATE_PERSISTENT_UI;\n\n    //5ã€âœ…åœ¨åº”ç”¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„\n    final boolean appSwitchAllowedOrFg =\n            appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY;\n    if (((appSwitchAllowedOrFg || mService.mActiveUids.hasNonAppVisibleWindow(callingUid))\n            && callingUidHasAnyVisibleWindow)\n            || isCallingUidPersistentSystemProcess) {\n        return false;\n    }\n    \n    final int realCallingUidProcState = (callingUid == realCallingUid)\n            ? callingUidProcState\n            : mService.mActiveUids.getUidState(realCallingUid);\n    final boolean realCallingUidHasAnyVisibleWindow = (callingUid == realCallingUid)\n            ? callingUidHasAnyVisibleWindow\n            : mService.hasActiveVisibleWindow(realCallingUid);\n    final boolean isRealCallingUidForeground = (callingUid == realCallingUid)\n            ? isCallingUidForeground\n            : realCallingUidHasAnyVisibleWindow\n                    || realCallingUidProcState == ActivityManager.PROCESS_STATE_TOP;\n    final int realCallingAppId = UserHandle.getAppId(realCallingUid);\n    final boolean isRealCallingUidPersistentSystemProcess = (callingUid == realCallingUid)\n            ? isCallingUidPersistentSystemProcess\n            : (realCallingAppId == Process.SYSTEM_UID)\n                    || realCallingUidProcState <= ActivityManager.PROCESS_STATE_PERSISTENT_UI;\n    if (realCallingUid != callingUid) {\n        //6ã€âœ…å¦‚æœè°ƒç”¨çš„è¿›ç¨‹æœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„\n        if (realCallingUidHasAnyVisibleWindow) {\n            if (DEBUG_ACTIVITY_STARTS) {\n                Slog.d(TAG, \"Activity start allowed: realCallingUid (\" + realCallingUid\n                        + \") has visible (non-toast) window\");\n            }\n            return false;\n        }\n\n        //7ã€âœ…å¦‚æœæ˜¯â€˜ç³»ç»ŸæŒä¹…åº”ç”¨â€™å‘èµ·çš„è¯·æ±‚æ˜¯å…è®¸çš„\n        if (isRealCallingUidPersistentSystemProcess && allowBackgroundActivityStart) {\n            return false;\n        }\n\n        //8ã€âœ…å¦‚æœå­˜åœ¨ä¼´ç”Ÿè®¾å¤‡æˆ–è€…ç›¸å…³å¯è§åº”ç”¨è¿›ç¨‹æ˜¯å…è®¸çš„\n        if (mService.isAssociatedCompanionApp(UserHandle.getUserId(realCallingUid),\n                realCallingUid)) {\n            return false;\n        }\n    }\n\n    //9ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ START_ACTIVITIES_FROM_BACKGROUND æ˜¯å…è®¸çš„\n    if (mService.checkPermission(START_ACTIVITIES_FROM_BACKGROUND, callingPid, callingUid)\n            == PERMISSION_GRANTED) {\n        return false;\n    }\n\n    //10ã€âœ…å¦‚æœæœ€è¿‘å­˜åœ¨ç›¸åŒ uid è¿›ç¨‹å¯åŠ¨ç›¸å…³ç»„ä»¶æ˜¯å…è®¸çš„ï¼ˆåŒä¸€ä¸ªåº”ç”¨ï¼‰\n    if (mSupervisor.mRecentTasks.isCallerRecents(callingUid)) {\n        return false;\n    }\n\n    //11ã€âœ…å¯¹äºè®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    if (mService.isDeviceOwner(callingUid)) {\n        return false;\n    }\n\n    //12ã€âœ…å¯¹äºä¼´ç”Ÿè®¾å¤‡çš„è¯·æ±‚æ˜¯å…è®¸çš„\n    final int callingUserId = UserHandle.getUserId(callingUid);\n    if (mService.isAssociatedCompanionApp(callingUserId, callingUid)) {\n        return false;\n    }\n    \n    //13ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ SYSTEM_ALERT_WINDOW æ˜¯å…è®¸çš„\n    if (mService.hasSystemAlertWindowPermission(callingUid, callingPid, callingPackage)) {\n        return false;\n    }\n\n  \n    int callerAppUid = callingUid;\n    if (callerApp == null) {\n        callerApp = mService.getProcessController(realCallingPid, realCallingUid);\n        callerAppUid = realCallingUid;\n    }\n    if (callerApp != null) {\n        //â€¼ï¸æ¥åˆ°äº†æ–°çš„å¯åŠ¨æ§åˆ¶ç±»ï¼šBackgroundLaunchProcessController#areBackgroundActivityStartsAllowed\n        //å‚è€ƒä¸‹æ–‡\n        if (callerApp.areBackgroundActivityStartsAllowed(appSwitchState)) {\n            return false;\n        }\n\n        final ArraySet<WindowProcessController> uidProcesses =\n                mService.mProcessMap.getProcesses(callerAppUid);\n        if (uidProcesses != null) {\n            for (int i = uidProcesses.size() - 1; i >= 0; i--) {\n                final WindowProcessController proc = uidProcesses.valueAt(i);\n                //å‚çœ‹ä¸‹æ–‡\n                if (proc != callerApp\n                        && proc.areBackgroundActivityStartsAllowed(appSwitchState)) {\n                    return false;\n                }\n            }\n        }\n    }\n    \n    return true;\n}\n```\n\n## areBackgroundActivityStartsAllowed\n\n```java\n//BackgroundLaunchProcessController.java\nboolean areBackgroundActivityStartsAllowed(int pid, int uid, String packageName,\n        int appSwitchState, boolean isCheckingForFgsStart,\n        boolean hasActivityInVisibleTask, boolean hasBackgroundActivityStartPrivileges,\n        long lastStopAppSwitchesTime, long lastActivityLaunchTime,\n        long lastActivityFinishTime) {\n    if (appSwitchState == APP_SWITCH_ALLOW) {\n        final long now = SystemClock.uptimeMillis();\n        if (now - lastActivityLaunchTime < ACTIVITY_BG_START_GRACE_PERIOD_MS\n                || now - lastActivityFinishTime < ACTIVITY_BG_START_GRACE_PERIOD_MS) {\n            if (lastActivityLaunchTime > lastStopAppSwitchesTime\n                    || lastActivityFinishTime > lastStopAppSwitchesTime) {\n                return true;\n            }\n        }\n    }\n    if (hasBackgroundActivityStartPrivileges) {\n        return true;\n    }\n\n    if (hasActivityInVisibleTask\n            && (appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY)) {\n        return true;\n    }\n    if (isBoundByForegroundUid()) {\n        return true;\n    }\n    if (isBackgroundStartAllowedByToken(uid, packageName, isCheckingForFgsStart)) {\n        return true;\n    }\n    return false;\n}\n```\n\n# startActivityUnchecked\n\n```java\n//ActivityStarter.java\nprivate int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n}\n```\n\n\n# Reference\n\n- è¾“å…¥æ³•æ§ä»¶ IMEï¼šhttps://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn\n- [ å…³äºå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹çš„æ¦‚å¿µ ](https://baike.baidu.com/item/å­¤å„¿è¿›ç¨‹/16751450#:~:text=åœ¨æ“ä½œç³»ç»Ÿé¢†åŸŸä¸­ï¼Œå­¤å„¿è¿›ç¨‹æŒ‡çš„æ˜¯åœ¨å…¶çˆ¶è¿›ç¨‹æ‰§è¡Œå®Œæˆæˆ–è¢«ç»ˆæ­¢åä»ç»§ç»­è¿è¡Œçš„ä¸€ç±»è¿›ç¨‹%E3%80%82,è¿™äº›å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹%20%28è¿›ç¨‹å·ä¸º1%29æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œ%E3%80%82)\n- [ å…³äº UIDã€PID çš„äº†è§£](https://www.cnblogs.com/perseus/articles/2354173.html)\n- [AutofillManager å‚è€ƒé“¾æ¥ [1]](https://developer.android.google.cn/guide/topics/text/autofill?hl=zh-cn)","source":"_posts/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨ä¸€.md","raw":"---\ntitle: Android ç³»ç»Ÿ Homeï¼ˆä¸€ï¼‰\ncatalog: true\ndate: 2022-09-29 22:57:44\nsubtitle: å¯åŠ¨æ¡Œé¢å°±æ˜¯æŸ¥æ‰¾å¹¶å¯åŠ¨ Activity\nheader-img: /img/220928/android_sysserver_bg.png\ntags: AOSP\nsticky: 8\ncategories:\n---\n\n\n# Ready go\nåœ¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œä¸Šä¸€ç« æˆ‘ä»¬å¯¹ `package` ç›®å½•ä¸‹çš„å†…å®¹æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæˆ‘ä»¬çŸ¥é“è®¾å¤‡ä¸Šçš„æ¡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ª`ç³»ç»Ÿåº”ç”¨`ï¼ŒAOSP åŸç”Ÿæœ‰æä¾›ï¼Œä½†æ˜¯å‚å•†å®šåˆ¶çš„ ROM å¾€å¾€ä¼šè‡ªå·±é‡å†™æˆ–é‡æ–°å®ç°ï¼Œæ‰©å±•åŠŸèƒ½ï¼›é‚£ä¹ˆç»§ç»­ Android ç³»ç»Ÿå¯åŠ¨æ€è€ƒå¾€ä¸‹èµ°ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥çœ‹çœ‹æ‰‹æœºæ¡Œé¢æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„â€”â€”â€”æ¡Œé¢ç¨‹åºæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ\n\nè™½ç„¶æˆ‘ä»¬çŸ¥é“æ¡Œé¢ç¨‹åºæ˜¯`Launcher`ï¼Œä½†æ˜¯æˆ‘ä»¬ä½œä¸ºåˆšé˜…è¯»æºç çš„å°ç™½ï¼Œ**å¦‚ä½•åœ¨æºç ä¸­å¿«é€Ÿæ‰¾åˆ°æ¡Œé¢ç¨‹åºå¯åŠ¨çš„å…¥å£ï¼Ÿ** è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ€è€ƒçš„é—®é¢˜ï¼Œ å½“ç„¶ï¼Œç«™åœ¨â€˜å·¨äººçš„è‚©è†€â€™ç›´æ¥ä½¿ç”¨ç™¾åº¦ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†è¿™é‡Œæˆ‘æƒ³åˆ°å¦å¤–ä¸€ç§æ–¹å¼â€”â€”â€”â€”`æ— éšœç¢æœåŠ¡ Accessebility`ï¼›åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæ— éšœç¢æœåŠ¡é™¤äº†æ»¡è¶³é¡¹ç›®éœ€æ±‚åº”ç”¨äºé¡¹ç›®ä¸­å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨è¯¥æœåŠ¡ä½œä¸ºæˆ‘ä»¬çš„è¾…åŠ©å·¥å…·ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä¸ªäººæœ€å¸¸ç”¨çš„å°±æ˜¯`æŸ¥çœ‹ç³»ç»Ÿå½“å‰æœ€é¡¶éƒ¨æ˜¾ç¤ºçš„ activity`ã€‚ä½œä¸ºè¾…åŠ©æ‰‹æ®µï¼Œæ—©å·²æœ‰æˆç†Ÿçš„è½¯ä»¶å·¥å…·ï¼Œè¿™é‡Œæ¨èä¸¤ä¸ªå·¥å…·ã€‚\n\n\n- å¼€å‘è€…åŠ©æ‰‹\n- Android å¼€å‘å·¥å…·ç®±\n- MT æ–‡ä»¶ç®¡ç†å™¨\n\n# systemReady\n\næˆ‘ä»¬çŸ¥é“ï¼ŒSystemServer åœ¨è¢«è°ƒç”¨æ—¶å…ˆæ‰§è¡Œ `main` å‡½æ•°ï¼Œç´§æ¥ç€æ‰§è¡Œå½“å‰ç±»çš„é™æ€æ–¹æ³• `run`ï¼Œç„¶ååˆ†ä¸‰ä¸ªé˜¶æ®µå¯åŠ¨ `å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡`ï¼Œæœ€åè¿›å…¥ `Looper().loop` å¾ªç¯å¿˜ä¸åœæ­‡çš„ ~~æ‰“å·¥~~ ç­‰å¾…æ¶ˆæ¯åˆ°æ¥å¹¶å¤„ç†ã€‚å¯åŠ¨æœåŠ¡æ˜¯ä¸€éƒ¨åˆ†ï¼Œéš¾é“ä¸åšç‚¹åˆ«çš„å—ï¼Ÿåˆšå¥½åœ¨å¯åŠ¨ **å…¶ä»–æœåŠ¡** è¿™é‡Œçœ‹åˆ°è¿™ä¸€æ®µæ³¨é‡Šï¼š\n\n```\n// We now tell the activity manager it is okay to run third party\n// code.  It will call back into us once it has gotten to the state\n// where third party code can really run (but before it has actually\n// started launching the initial applications), for us to complete our\n// initialization.\n\nSystemServerï¼šAMS ä½ æ‰€éœ€çš„ä¸€äº›æœåŠ¡å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨äº†ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œoverï¼overï¼\n\nAMSï¼šæ”¶åˆ°ï¼æ”¶åˆ°ï¼çœ‹æˆ‘å›è°ƒè¡Œäº‹ï¼Œoverï¼\n```\n\nå…ˆæ˜¯ AMS systemReady è¿›å…¥å‡†å¤‡é˜¶æ®µ\n\n```java\n//ActivityManagerService.java\npublic void systemReady(final Runnable goingCallback, @NonNull TimingsTraceAndSlog t) {\n\n    /*\n        1ã€ç®¡ç† activity çš„ä»»åŠ¡æ ˆã€è¿™ç§å†…å®¹å¤ªç»†äº†ï¼Œä»¥åé€ä¸ªçœ‹çœ‹ï¼Œå…ˆç•¥è¿‡ã€‘\n        2ã€åŒ…å« RecentTasks æœ€è¿‘è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨\n    */\n    mActivityTaskManager.onSystemReady();\n    mUserController.onSystemReady();\n    //è®¿é—®æ§åˆ¶ï¼Œä¸»è¦ä¸æƒé™ã€é™åˆ¶ç›¸å…³\n    mAppOpsService.systemReady();\n    mProcessList.onSystemReady();\n\n    /*\n        1ã€å¦‚æœè¿›ç¨‹æˆ–è¿›ç¨‹ç»„è¢«æ ‡è®°ä¸ºæ€æ­»ï¼Œå°†è°ƒç”¨ Process.killProcessQuiet(mPid);ProcessList.killProcessGroup(uid, mPid);æ€æ­»è¿›ç¨‹ï¼Œä¸ºå¯åŠ¨æ–°è¿›ç¨‹åšå‡†å¤‡\n        2ã€å½“ç„¶ï¼Œè¿›ç¨‹ä¹Ÿå¯èƒ½è¢«æ ‡è®°ä¸ºé‡å¯ï¼Œä¾¿ä¸ä¼šä»è¿›ç¨‹é˜Ÿåˆ—ä¸­ç§»é™¤       \n    */\n    mProcessList.removeProcessLocked\n    //æ³¨å†Œå¯åŠ¨ç›‘å¬ï¼ŒATMï¼šactivitTaskManager\n    mAtmInternal.getLaunchObserverRegistry().registerLaunchObserver(mActivityLaunchObserver);\n    //UGMï¼šuri global managerï¼Œuri ä½œä¸ºæ•°æ®è®¿é—®åœ°å€ã€æ•°æ®ä¼ é€’ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„\n    mUgmInternal.onSystemReady();\n    //pmiï¼špower manager internalï¼Œä½ç”µé‡ç›‘æ§\n    pmi.registerLowPowerModeObserver\n    \n    \n    //ğŸ˜“æ‰§è¡Œåˆ°ä¸€åŠå°±è¿”å›å»æ‰§è¡Œå›è°ƒã€è¯·å‚è€ƒ â€”â€” å›è°ƒ1ã€‘\n    if (goingCallback != null) goingCallback.run();\n        \n    /*\n        1ã€å¯åŠ¨æŒä¹…åº”ç”¨ï¼ˆä¸ä¼šä¼‘çœ çš„ã€å¯åŠ¨å”¤é†’ç¨‹åºï¼‰ï¼Œå¾…å¯åŠ¨çš„æ˜¯å“ªäº›åº”ç”¨ï¼Œåˆæ¥åˆ°äº† IPackageManager.aidl çš„ getPersistentApplicationsï¼Œ\n           å®ç°ç±»æ˜¯ PackageManagerService.java\n        2ã€getPersistentApplications å®é™…ä¸Šè·å–åˆ°çš„æ˜¯ä¸€ä¸ª ApplicationInfo åˆ—è¡¨\n        3ã€é€šè¿‡ applicationInfo åˆ›å»º processRecorderï¼Œæ¥ç€é€šè¿‡ ProcessList ä¸€é¡¿åˆ¤æ–­ã€è°ƒæ•´ processRecorder\n        4ã€æœ€åå¯èƒ½é€šè¿‡ wzygote æˆ– Process.start å¯åŠ¨\n    */\n    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);\n\n    //ActivityTaskManagerInternal.java å®ç°ç±»åœ¨ ActivityManagerService çš„ä¸€ä¸ªå†…éƒ¨ç±» LocalServiceï¼›\n    //â€¼ï¸å¯åŠ¨æ¡Œé¢ç¨‹åº\n    mAtmInternal.startHomeOnAllDisplays(currentUserId, \"systemReady\");\n    \n    mAtmInternal.resumeTopActivities(false /* scheduleIdle */);    \n}\n```\n\nAMS å‡†å¤‡å®Œæ¯•ï¼Œè¯·æ±‚ SystemServer è¶…çº§ç®¡å®¶æ‰§è¡Œå›è°ƒ\n\n```java\n//SystemServer.java ã€å›è°ƒ1ã€‘\nmActivityManagerService.systemReady(() -> {\n\n    //service.onBootPhase(mCurrentPhase=500); ç³»ç»ŸæœåŠ¡é‚£ä¹ˆå¤šåˆ°åº•è°åœ¨æ‰§è¡Œ 500 è¿™ä¸ªæ ‡è®°ï¼Ÿ\n    //ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œå›è°ƒå‘ŠçŸ¥å…¶ä»–æœåŠ¡ AMS å¯åŠ¨äº†ï¼Œä½ ä»¬å¯ä»¥ä½¿ç”¨ AMS åšåˆ«çš„äº‹æƒ…\n    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_ACTIVITY_MANAGER_READY);\n    \n    //AMS éœ€è¦ç›‘æ§ native å´©æºƒï¼Œé‡Œé¢å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ Threadï¼Œå†…éƒ¨ä½¿ç”¨é˜»å¡çš„ socket æ¥æ”¶å´©æºƒä¿¡æ¯å¹¶è¿”å›ç»™ä¸Šå±‚æˆ–è¾“å‡º\n    mActivityManagerService.startObservingNativeCrashes();\n\n    //çœ‹åˆ° ops å¾€å¾€æ˜¯è·Ÿé™åˆ¶ç­–ç•¥æœ‰å…³ğŸš«\n    mActivityManagerService.setAppOpsPolicy(new AppOpsPolicy(mSystemContext));\n\n    // Wait for all packages to be prepared\n    mPackageManagerService.waitForAppDataPrepared();\n    //ç¬¬ä¸‰æ–¹åº”ç”¨å‡†å¤‡å¥½äº†ï¼Œåˆå‘èµ·ä¸€ä¸ªå¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„å›è°ƒï¼Œè®©å„è‡ªå®ç°æ­¤çŠ¶æ€ç çš„æœåŠ¡æ‰§è¡Œç›¸åº”æ“ä½œã€è§å›¾1ã€‘\n    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);\n\n    ... etc\n    \n    //åˆ°è¿™é‡Œæˆ‘ä»¬ç®—æ˜¯å›è°ƒæ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬åˆè¦å›åˆ° systemReady é‡Œé¢å»ï¼Œç»§ç»­çœ‹æ‰§è¡Œ goingCallback.run(); ä¹‹åçš„ä»£ç \n    \n}, t);\n```\n\n# startHomeOnAllDisplays\n\næˆ‘ä»¬æƒ³çŸ¥é“ startHomeOnAllDisplays çš„å…·ä½“å®ç°åœ¨å“ªé‡Œï¼Ÿæœ‰è°æ‰§è¡Œçš„ï¼Ÿä¸å¦¨æ‰¾æ‰¾çœ‹ã€‚\n\n- ActivityManagerService#mAtmInternal.startHomeOnAllDisplays(currentUserId, \"systemReady\"); `AMS ä¸­è°ƒç”¨`\n- ActivityTaskManagerInternal#startHomeOnAllDisplays   `è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•`\n- ActivityTaskManagerService#LocalService            `å®ç°ç±»æ˜¯ ATMS çš„å†…éƒ¨ç±»`\n- ActivityTaskManagerService#mInternal; `å®ç°ç±»å®ä¾‹èµ‹ç»™äº† ATMS çš„æˆå‘˜`\n- ActivityTaskManagerService#LocalServices.addService(ActivityTaskManagerInternal.class, mInternal); `åœ¨ ATMS å¯åŠ¨å‘¨æœŸ onStart ä¸­è¢«ç¼“å­˜åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨`\n- com.android.server#private static final ArrayMap<Class<?>, Object> sLocalServiceObjects `æœ¬åœ°æœåŠ¡åˆ—è¡¨å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ•°ç»„`\n- ActivityTaskManagerService#mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class); `ä»æœ¬åœ°æœåŠ¡ç¼“å­˜åˆ—è¡¨ä¸­è·å–å®ä¾‹èµ‹ç»™ ATMS`\n\näº†è§£äº†ï¼Œç›´æ¥æ‰¾å®ç°ç±» `LocalService`ã€‚\n\n```java\n//ActivityTaskManagerService.java#LocalService\n@Override\npublic boolean startHomeOnAllDisplays(int userId, String reason) {\n    synchronized (mGlobalLock) {\n        return mRootWindowContainer.startHomeOnAllDisplays(userId, reason);\n    }\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnAllDisplays(int userId, String reason) {\n    //æ¡Œé¢ä¸»ç•Œé¢æ˜¯å¦å¯åŠ¨å®Œæ¯•\n    boolean homeStarted = false;\n    //è¿™é‡Œçš„å¾ªç¯è¡¨ç¤ºå¯¹åº” AllDisplaysï¼Œè®¾å¤‡æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªæ˜¾ç¤ºå™¨çš„\n    for (int i = getChildCount() - 1; i >= 0; i--) {\n        final int displayId = getChildAt(i).mDisplayId;\n        homeStarted |= startHomeOnDisplay(userId, reason, displayId);\n    }\n    return homeStarted;\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnDisplay(int userId, String reason, int displayId) {\n    return startHomeOnDisplay(userId, reason, displayId, false /* allowInstrumenting */,\n            false /* fromHomeKey */);\n}\n```\n\n```java\n//RootWindowContainer.java\nboolean startHomeOnDisplay(int userId, String reason, int displayId, boolean allowInstrumenting,\n        boolean fromHomeKey) {\n    //å¦‚æœé‡åˆ°æ— æ•ˆçš„æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æˆ–å·²è·å¾—ç„¦ç‚¹çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºID\n    if (displayId == INVALID_DISPLAY) {\n        final Task rootTask = getTopDisplayFocusedRootTask();\n        displayId = rootTask != null ? rootTask.getDisplayId() : DEFAULT_DISPLAY;\n    }\n\n    final DisplayContent display = getDisplayContent(displayId);\n    return display.reduceOnAllTaskDisplayAreas((taskDisplayArea, result) ->\n                    result | startHomeOnTaskDisplayArea(userId, reason, taskDisplayArea,\n                            allowInstrumenting, fromHomeKey),\n            false /* initValue */);\n}\n```\n    \n```java\n//RootWindowContainer.java\nboolean startHomeOnTaskDisplayArea(int userId, String reason, TaskDisplayArea taskDisplayArea,\n        boolean allowInstrumenting, boolean fromHomeKey) {\n    //å¦‚æœæä¾›çš„ç°å®åŒºåŸŸæ— æ•ˆï¼ŒåŒæ ·çš„æ¢å¤é»˜è®¤\n    if (taskDisplayArea == null) {\n        final Task rootTask = getTopDisplayFocusedRootTask();\n        taskDisplayArea = rootTask != null ? rootTask.getDisplayArea()\n                : getDefaultTaskDisplayArea();\n    }\n\n    //â€¼ï¸é‡è¦çš„æ¥äº†ï¼Œæ¡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ª activityï¼Œå¯åŠ¨ä¸€ä¸ª activityï¼Œæœ€é‡è¦çš„ä¾¿æ˜¯å¯åŠ¨ç›®æ ‡ä¿¡æ¯\n    Intent homeIntent = null;\n    ActivityInfo aInfo = null;\n    //\n    if (taskDisplayArea == getDefaultTaskDisplayArea()) {\n        /*\n            1ã€mService æ˜¯ ActivityTaskManagerService\n            2ã€ã€é»˜è®¤ã€‘intent.addCategory(Intent.CATEGORY_HOME); mTopAction = Intent.ACTION_MAIN;\n        */\n        homeIntent = mService.getHomeIntent();\n        aInfo = resolveHomeActivity(userId, homeIntent);\n    } else if (shouldPlaceSecondaryHomeOnDisplayArea(taskDisplayArea)) {\n        Pair<ActivityInfo, Intent> info = resolveSecondaryHomeActivity(userId, taskDisplayArea);\n        aInfo = info.first;\n        homeIntent = info.second;\n    }\n    if (aInfo == null || homeIntent == null) {\n        return false;\n    }\n\n    //æ˜¾ç¤ºæ€»æ˜¯æœ‰ä¸€äº›æ˜¾ç¤º\n    if (!canStartHomeOnDisplayArea(aInfo, taskDisplayArea, allowInstrumenting)) {\n        return false;\n    }\n\n    homeIntent.setComponent(new ComponentName(aInfo.applicationInfo.packageName, aInfo.name));\n    homeIntent.setFlags(homeIntent.getFlags() | FLAG_ACTIVITY_NEW_TASK);\n    if (fromHomeKey) {\n        homeIntent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, true);\n        if (mWindowManager.getRecentsAnimationController() != null) {\n            mWindowManager.getRecentsAnimationController().cancelAnimationForHomeStart();\n        }\n    }\n    homeIntent.putExtra(WindowManagerPolicy.EXTRA_START_REASON, reason);\n\n    //å¯åŠ¨ activity è¿˜å¾—çœ‹ activityStartController\n    mService.getActivityStartController().startHomeActivity(homeIntent, aInfo, myReason,\n            taskDisplayArea);\n    return true;\n}\n```\n\n\n# activitStartController\n\n```java \n//ActivityStartController.java\n//âš ï¸ï¼šè¿™é‡Œå¯åŠ¨çš„æ˜¯ homeItent\nvoid startHomeActivity(Intent intent, ActivityInfo aInfo, String reason,\n        TaskDisplayArea taskDisplayArea) {\n    //æ²¡æœ‰ä»»ä½•é™„åŠ å±æ€§ï¼Œæ¯”å¦‚æ²¡æœ‰ activity åŠ¨ç”»\n    final ActivityOptions options = ActivityOptions.makeBasic();\n    //å…¨å±çª—å£æ¨¡å¼\n    options.setLaunchWindowingMode(WINDOWING_MODE_FULLSCREEN);\n    if (!ActivityRecord.isResolverActivity(aInfo.name)) {\n        //æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªæ¡Œé¢ activity \n        options.setLaunchActivityType(ACTIVITY_TYPE_HOME);\n    }\n\n    //æ˜¾ç¤ºè®¾å¤‡IDä¹ŸæŒ‡å®šï¼Œä¼¼ä¹ activity å¯åŠ¨éœ€è¦çš„å‚æ•°éƒ½å°†å°è£…åˆ° ActivitOptions \n    final int displayId = taskDisplayArea.getDisplayId();\n    options.setLaunchDisplayId(displayId);\n    options.setLaunchTaskDisplayArea(taskDisplayArea.mRemoteToken\n            .toWindowContainerToken());\n\n    //åªæ˜¯ä¸€ä¸ªå˜é‡é€’å¢ mDeferResumeCount++ï¼Œè¿™å¦‚ä½•ä½¿ç”¨ \n    mSupervisor.beginDeferResume();\n\n    final Task rootHomeTask;\n    try {\n        /*\n            1ã€activity éœ€è¦ä¾èµ– task å®¹å™¨ï¼Œæ‰€ä»¥å¯åŠ¨å‰å¿…é¡»ç¡®ä¿ Task å·²åˆ›å»º\n            2ã€TaskDisplayArea#createRootTask éœ€æŒ‡å®š activityType=home_activityï¼Œontop=true åœ¨æ˜¾ç¤ºå™¨çš„é¡¶éƒ¨åˆ›å»º rootTask\n            3ã€æœ€ç»ˆåˆ›å»ºæ˜¯é€šè¿‡ Task.Builder()......build();  è‡³æ­¤ï¼Œå­˜å‚¨æ¡Œé¢ activity çš„ Task å·²ç»æœ‰äº†\n            4ã€mRootWindowContainer è¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘ä»¬æ‰€è§åˆ°çš„ç•Œé¢éƒ½è¦ä¾é™„äºå®ƒ\n        */\n        rootHomeTask = taskDisplayArea.getOrCreateRootHomeTask(ON_TOP/*true*/);\n    } finally {\n        //è¿™ä¸ªè·Ÿ mDeferResumeCount++ å¯¹åº”ï¼Œè¿™é‡Œæ˜¯ mDeferResumeCount--\n        //å…³äºè¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šreadyToResume() {return mDeferResumeCount == 0;} \n        //true if resume can be calledï¼šé‚£ä¼°è®¡æ˜¯å“ªé‡Œè¿›è¡Œè½®è¯¢ç›‘å¬ readyToResume()\n        mSupervisor.endDeferResume();\n    }\n\n    /*\n        1ã€æœ‰äº†å¯æ‰¿è½½æ¡Œé¢ç¨‹åºçš„ä»»åŠ¡æ ˆï¼Œæ¥ç€å°±è¦å¯åŠ¨æ¡Œé¢ activity\n        2ã€è·å¾—ä¸€ä¸ª activity å¯åŠ¨å™¨ ActivitStarterï¼Œå¼€å§‹æ‰§è¡Œ excute()\n        3ã€å¯åŠ¨å™¨ä¼¼ä¹ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œé»˜è®¤å¯åŠ¨å™¨æ•°é‡ 3 ä¸ª\n        4ã€å¯åŠ¨å™¨ä¸»è¦æˆå‘˜æœ‰ ActivityStartControllerã€ActivityTaskManagerServiceã€ActivityTaskSupervisorã€ActivityStartInterceptor\n        5ã€åœ¨æ„å»ºè¯·æ±‚å™¨è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ„é€ å¯åŠ¨è¯·æ±‚å‚æ•° mRequest \n    */\n    mLastHomeActivityStartResult = obtainStarter(intent, \"startHomeActivity: \" + reason)\n            .setOutActivity(tmpOutRecord)\n            .setCallingUid(0)\n            .setActivityInfo(aInfo)\n            .setActivityOptions(options.toBundle())\n            .execute();\n    mLastHomeActivityStartRecord = tmpOutRecord[0];\n    if (rootHomeTask.mInResumeTopActivity) {\n        //å¼€å§‹è°ƒç”¨ onResume å£°æ˜å‘¨æœŸæ–¹æ³•ï¼Œå›åˆ° activity æœ€ç†Ÿæ‚‰çš„åœ°æ–¹\n        mSupervisor.scheduleResumeTopActivities();\n    }\n}\n```\n\nå…³äº `ActivityTaskSupervisor` è´Ÿè´£çš„ä»»åŠ¡å¤ªå¤šäº†ï¼Œä¼°è®¡åƒä¸ªç‰ˆæœ¬è¦åˆ†ç¦»éƒ¨åˆ†ä»£ç å§\n\n```java\n// TODO: This class has become a dumping ground. Let's\n// - Move things relating to the hierarchy to RootWindowContainer\n// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler\n// - Move interface things to ActivityTaskManagerService.\n// - All other little things to other files.\npublic class ActivityTaskSupervisor implements RecentTasks.Callbacks {\n\n}\n```\n\n\n# activityStarter\n\n```java\n//ActivityStarter.java\nint execute() {\n    try {\n        /*\n            1ã€å¦‚æœå¯åŠ¨è¯·æ±‚ä¿¡æ¯æ— æ•ˆï¼Œåˆ™é‡æ–°è§£æå¹¶å¡«å……å¯åŠ¨è¯·æ±‚å‚æ•°\n            2ã€è¯·æ±‚å‚æ•°åŒ…æ‹¬ pidã€uidã€resolveInfoã€activityInfo  .etc\n        */\n        if (mRequest.activityInfo == null) {\n            mRequest.resolveActivity(mSupervisor);\n        }\n\n        int res;\n        //mGlobalLock å…¨å±€æœåŠ¡é”ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡\n        synchronized (mService.mGlobalLock) {\n            final boolean globalConfigWillChange = mRequest.globalConfig != null\n                    && mService.getGlobalConfiguration().diff(mRequest.globalConfig) != 0;\n            final Task rootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();\n            if (rootTask != null) {\n                rootTask.mConfigWillChange = globalConfigWillChange;\n            }\n            final long origId = Binder.clearCallingIdentity();\n\n            /*\n                1ã€ä»€ä¹ˆé‡é‡çº§è¿›ç¨‹åˆ‡æ¢ï¼Œæˆ‘éƒ½æ‡µäº†ğŸ˜º\n                2ã€å¦‚æœæ‰¾ä¸åˆ°è°ƒç”¨è€… app è¿›ç¨‹ï¼Œåˆ™ç»ˆæ­¢å¯åŠ¨è¯·æ±‚ ATMS.getProcessController(request.caller) == null\n            */\n            res = resolveToHeavyWeightSwitcherIfNeeded();\n            if (res != START_SUCCESS) {\n                return res;\n            }\n\n            //â€¼ï¸æ‰§è¡Œå¯åŠ¨è¯·æ±‚\n            res = executeRequest(mRequest);\n\n            mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(launchingState, res,\n                    newActivityCreated, mLastStartActivityRecord, originalOptions);\n            if (mRequest.waitResult != null) {\n                mRequest.waitResult.result = res;\n                res = waitResultIfNeeded(mRequest.waitResult, mLastStartActivityRecord,\n                        launchingState);\n            }\n            return getExternalResult(res);\n        }\n    } finally {\n        //æ‰§è¡Œå®Œæˆæœ€åä¸€å®šè¦å›æ”¶ activity å¯åŠ¨å™¨\n        onExecutionComplete();\n    }\n}\n```\n\nactivity å¯åŠ¨è¯·æ±‚æ­£å¼å¼€å§‹ï¼Œè¿™é‡Œå°†ä¼šæœ‰å¾ˆå¤šçš„å¯åŠ¨é™åˆ¶ğŸš«ç­‰ã€‚\n\n```java\n//ActivitStarter.java\nprivate int executeRequest(Request request) {\n    //å¾ˆå¥½å¥‡è¿™ä¸ª reason è¿™ä¹ˆæ€»è¦å—ï¼Ÿå¹²ä»€ä¹ˆç”¨çš„\n    if (TextUtils.isEmpty(request.reason)) {\n        throw new IllegalArgumentException(\"Need to specify a reason.\");\n    }\n    \n    //å¦‚æœä¸­é€”æ£€æµ‹åˆ°æ˜¯éå¯åŠ¨æˆåŠŸï¼ˆè§¦å‘å¯åŠ¨é™åˆ¶ï¼‰ï¼Œé‚£ä¹ˆç«‹é©¬ç»“æŸè¯·æ±‚ï¼Œè¿”å›ç»“æœ\n    int err = ActivityManager.START_SUCCESS;\n    // Pull the optional Ephemeral Installer-only bundle out of the options early.\n    final Bundle verificationBundle =\n            options != null ? options.popAppVerificationBundle() : null;\n\n    //âŒé™åˆ¶1ï¼šæ ¹æ®å¯åŠ¨è¯·æ±‚è°ƒç”¨è€… caller å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯åŠ¨ app è¿›ç¨‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›æ‹¦æˆªè¯·æ±‚\n    WindowProcessController callerApp = null;\n    if (caller != null) {\n        callerApp = mService.getProcessController(caller);\n        if (callerApp != null) {\n            callingPid = callerApp.getPid();\n            callingUid = callerApp.mInfo.uid;\n        } else {\n            err = START_PERMISSION_DENIED;\n        }\n    }\n\n    final int launchFlags = intent.getFlags();\n    if ((launchFlags & Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 && sourceRecord != null) {\n        //âŒä»€ä¹ˆè¯·æ±‚å†²çªï¼Ÿï¼Ÿï¼Ÿ\n        if (requestCode >= 0) {\n            SafeActivityOptions.abort(options);\n            return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;\n        }\n    }\n\n    if (err == ActivityManager.START_SUCCESS && intent.getComponent() == null) {\n        //âŒå¯åŠ¨ç›®æ ‡ activity æœªçŸ¥ï¼Œå¤±è´¥\n        err = ActivityManager.START_INTENT_NOT_RESOLVED;\n    }\n\n    if (err == ActivityManager.START_SUCCESS && aInfo == null) {\n        //âŒåŒæ ·çš„ï¼Œè¯·æ±‚æ‰€éœ€è¦çš„åŸºç¡€ä¿¡æ¯éƒ½æœªçŸ¥ï¼Œè‡ªç„¶ä¸­æ–­æœ¬æ¬¡è¯·æ±‚\n        err = ActivityManager.START_CLASS_NOT_FOUND;\n    }\n\n    // voiceSession è¯­éŸ³äº¤äº’ç›¸å…³ activityã€è¿™é‡Œå…¶å®æ˜¯ activity å¯åŠ¨éƒ½ä¼šç»è¿‡çš„è·¯é€”ï¼Œåªæ˜¯æˆ‘ä»¬æœ¬æ¬¡åˆ†æçš„æ˜¯â€˜å¯åŠ¨æ¡Œé¢ activityâ€™ã€‘\n    if (err == ActivityManager.START_SUCCESS && sourceRecord != null\n            && sourceRecord.getTask().voiceSession != null) {\n        if ((launchFlags & FLAG_ACTIVITY_NEW_TASK) == 0\n                && sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) {\n            try {\n                intent.addCategory(Intent.CATEGORY_VOICE);\n                if (!mService.getPackageManager().activitySupportsIntent(\n                        intent.getComponent(), intent, resolvedType)) {\n                    //âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ\n                    err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n                }\n            } catch (RemoteException e) {\n                //âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ\n                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n            }\n        }\n    }\n\n    if (err == ActivityManager.START_SUCCESS && voiceSession != null) {\n        try {\n            if (!mService.getPackageManager().activitySupportsIntent(intent.getComponent(),\n                    intent, resolvedType)) {\n                //âŒä¸æ”¯æŒ\n                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n            }\n        } catch (RemoteException e) {\n            //âŒä¸æ”¯æŒ\n            err = ActivityManager.START_NOT_VOICE_COMPATIBLE;\n        }\n    }\n\n    if (err != START_SUCCESS) {\n        SafeActivityOptions.abort(options);\n        return err;\n    }\n\n    //æ£€æŸ¥ activity å¯åŠ¨æ˜¯å¦æ»¡è¶³æ¡ä»¶\n    boolean abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,\n            requestCode, callingPid, callingUid, callingPackage, callingFeatureId,\n            request.ignoreTargetSecurity, inTask != null, callerApp, resultRecord,\n            resultRootTask);\n    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,\n            callingPid, resolvedType, aInfo.applicationInfo);\n    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,\n            callingPackage);\n\n    boolean restrictedBgActivity = false;\n    if (!abort) {\n        try {\n            //ç»§ç»­æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯åŠ¨æ¡ä»¶\n            restrictedBgActivity = shouldAbortBackgroundActivityStart(callingUid,\n                    callingPid, callingPackage, realCallingUid, realCallingPid, callerApp,\n                    request.originatingPendingIntent, request.allowBackgroundActivityStart,\n                    intent);\n        } finally {\n\n        }\n    }\n\n     \n    //ç•¥ç•¥ç•¥ï½ï½ï½\n\n\n    //æ²¡æœ‰é€šè¿‡å¯åŠ¨æ£€æŸ¥å°±è¦ç»“æŸæ‰§è¡Œäº†\n    if (abort) {\n        ActivityOptions.abort(checkedOptions);\n        return START_ABORTED;\n    }\n\n    if (aInfo != null) {\n        if (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired(\n                aInfo.packageName, userId)) {\n            final IIntentSender target = mService.getIntentSenderLocked(\n                    ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage, callingFeatureId,\n                    callingUid, userId, null, null, 0, new Intent[]{intent},\n                    new String[]{resolvedType}, PendingIntent.FLAG_CANCEL_CURRENT\n                            | PendingIntent.FLAG_ONE_SHOT, null);\n\n            Intent newIntent = new Intent(Intent.ACTION_REVIEW_PERMISSIONS);\n\n            int flags = intent.getFlags();\n            flags |= Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS;\n\n            //è®¾ç½®å¯åŠ¨æ ‡è¯†ï¼Œä»…è®¾ç½® NEW_TASK æŸäº›åœºæ™¯ä¸ä¸€å®šä¼šçœŸçš„åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œä½†å¯ä»¥ç½®ä¸º MULTIPLE_TASK\n            if ((flags & (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_NEW_DOCUMENT)) != 0) {\n                flags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;\n            }\n            newIntent.setFlags(flags);\n\n            newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName);\n            newIntent.putExtra(Intent.EXTRA_INTENT, new IntentSender(target));\n            if (resultRecord != null) {\n                newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, true);\n            }\n            intent = newIntent;\n\n            //ä¸€å †æ•°æ®è§£æå’Œèµ‹å€¼å°±ä¸çœ‹äº†\n            intentGrants = null;\n            resolvedType = null;\n            callingUid = realCallingUid;\n            callingPid = realCallingPid;\n            rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, 0,\n                    computeResolveFilterUid(\n                            callingUid, realCallingUid, request.filterCallingUid));\n            aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags,\n                    null /*profilerInfo*/);\n        }\n    }\n\n    if (rInfo != null && rInfo.auxiliaryInfo != null) {\n        //ä¸‡äº‹ä¿±å¤‡ï¼Œå‡†å¤‡å¾…å‘ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥å¯åŠ¨çš„ intent ï¼ˆä¹Ÿå°±æ˜¯å¯åŠ¨æ•°æ®æ¯ä¸ªå¿…è¦çš„ä¸å¯å°‘ï¼‰\n        //åº”è¯¥æ˜¯æœ‰ç‰¹åˆ«ä¹‹å¤„çš„ï¼Œä¸ç„¶ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„ intentï¼Œå…·ä½“å°±ä¸çº ç»“äº†\n        intent = createLaunchIntent(rInfo.auxiliaryInfo, request.ephemeralIntent,\n                callingPackage, callingFeatureId, verificationBundle, resolvedType, userId);\n        resolvedType = null;\n        callingUid = realCallingUid;\n        callingPid = realCallingPid;\n        intentGrants = null;\n        aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, null /*profilerInfo*/);\n    }\n\n    //æ¯ä¸€ä¸ª activity çš„ä¿¡æ¯éƒ½å°†è®°å½•åœ¨ ActivityRecord ä¸­\n    final ActivityRecord r = new ActivityRecord.Builder(mService)\n            .setCaller(callerApp)\n            .setLaunchedFromPid(callingPid)\n            .setLaunchedFromUid(callingUid)\n            .setLaunchedFromPackage(callingPackage)\n            .setLaunchedFromFeature(callingFeatureId)\n            .setIntent(intent)\n            .setResolvedType(resolvedType)\n            .setActivityInfo(aInfo)\n            .setConfiguration(mService.getGlobalConfiguration())\n            .setResultTo(resultRecord)\n            .setResultWho(resultWho)\n            .setRequestCode(requestCode)\n            .setComponentSpecified(request.componentSpecified)\n            .setRootVoiceInteraction(voiceSession != null)\n            .setActivityOptions(checkedOptions)\n            .setSourceRecord(sourceRecord)\n            .build();\n\n    mLastStartActivityRecord = r;\n    //â€¼ï¸å¥½äº†ï¼Œåˆåˆ°ä¸‹ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ\n    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,\n            request.voiceInteractor, startFlags, true /* doResume */, checkedOptions,\n            inTask, inTaskFragment, restrictedBgActivity, intentGrants);\n\n    if (request.outActivity != null) {\n        request.outActivity[0] = mLastStartActivityRecord;\n    }\n    return mLastStartActivityResult;\n}\n```\n\n## checkStartAnyActivityPremission\n\nä»»ä½•ä¸€ä¸ª activity å¯åŠ¨éƒ½éœ€è¦æ£€æŸ¥æƒé™é—®é¢˜ã€‚\n\n```java\n//ActivitTaskSupervisor.java\nboolean checkStartAnyActivityPermission(Intent intent, ActivityInfo aInfo, String resultWho,\n        int requestCode, int callingPid, int callingUid, String callingPackage,\n        @Nullable String callingFeatureId, boolean ignoreTargetSecurity,\n        boolean launchingInTask, WindowProcessController callerApp, ActivityRecord resultRecord,\n        Task resultRootTask) {\n    //0ã€âœ…å¦‚æœæ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç»„ä»¶ å¹¶ä¸” æ˜¯å½“å‰æ ˆä¸­è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    final boolean isCallerRecents = mService.getRecentTasks() != null\n            && mService.getRecentTasks().isCallerRecents(callingUid);\n    /*\n        1ã€âœ…å¦‚æœæ˜¯å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™çš„åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.ROOT_UID\n        2ã€âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.SYSTEM_UID\n        3ã€âŒå¦‚æœæ˜¯ä¸åŒè¿›ç¨‹æ˜¯ä¸å…è®¸çš„ UserHandle.isIsolated(uid)\n        4ã€âœ…å¦‚æœæ˜¯è®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ UserHandle.isSameApp(uid, owningUid)\n        5ã€âŒå¦‚æœç›®æ ‡ activity exported=false æ˜¯ä¸è¢«å…è®¸å¯åŠ¨çš„\n        6ã€âŒå¦‚æœæ£€æŸ¥çš„æƒé™å­˜åœ¨ â€˜ç¦æ­¢æƒé™åˆ—è¡¨â€™ä¸­æ˜¯ä¸è¢«å…è®¸çš„  [è‡³äºåˆ—è¡¨ä¸­éƒ½æœ‰å“ªäº›æƒé™æˆ‘ä»¬ä»¥åè®¨è®º]\n    */\n    final int startAnyPerm = mService.checkPermission(START_ANY_ACTIVITY, callingPid,\n            callingUid);\n    if (startAnyPerm == PERMISSION_GRANTED || (isCallerRecents && launchingInTask)) {\n        return true;\n    }\n\n    //âŒcomponent é™åˆ¶ ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkComponentPermissionã€‘\n    final int componentRestriction = getComponentRestrictionForCallingPackage(aInfo,\n            callingPackage, callingFeatureId, callingPid, callingUid, ignoreTargetSecurity);\n    //âŒaction é™åˆ¶  ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkPermissionã€‘\n    final int actionRestriction = getActionRestrictionForCallingPackage(\n            intent.getAction(), callingPackage, callingFeatureId, callingPid, callingUid);\n    if (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION\n            || actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) {\n        if (resultRecord != null) {\n            resultRecord.sendResult(INVALID_UID, resultWho, requestCode,\n                    Activity.RESULT_CANCELED, null /* data */, null /* dataGrants */);\n        }\n        throw new SecurityException(msg);\n    }\n\n    if (actionRestriction == ACTIVITY_RESTRICTION_APPOP) {\n        return false;\n    } else if (componentRestriction == ACTIVITY_RESTRICTION_APPOP) {\n        return false;\n    }\n\n    return true;\n}\n```\n\n## checkIntent\n\nmService.mIntentFirewall.checkStartActivity æœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ intent è¿‡æ»¤ã€‚\n\n```java\n//IntentFirewall.java\npublic boolean checkIntent(FirewallIntentResolver resolver, ComponentName resolvedComponent,\n        int intentType, Intent intent, int callerUid, int callerPid, String resolvedType,\n        int receivingUid) {\n    boolean log = false;\n    boolean block = false;\n\n    List<Rule> candidateRules;\n    candidateRules = resolver.queryIntent(intent, resolvedType, false /*defaultOnly*/, 0);\n    if (candidateRules == null) {\n        candidateRules = new ArrayList<Rule>();\n    }\n    resolver.queryByComponent(resolvedComponent, candidateRules);\n\n    for (int i=0; i<candidateRules.size(); i++) {\n        Rule rule = candidateRules.get(i);\n        //intent è¿‡æ»¤è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œè§„åˆ™æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼Ÿä¸æ‡‚â€”â€”â€”â€”ç•¥ï¼\n        if (rule.matches(this, resolvedComponent, intent, callerUid, callerPid, resolvedType,\n                receivingUid)) {\n            block |= rule.getBlock();\n            log |= rule.getLog();\n            if (block && log) {\n                break;\n            }\n        }\n    }\n\n    if (log) {\n        logIntent(intentType, intent, callerUid, resolvedType);\n    }\n\n    return !block;\n}\n```\n\n\n## checkStartActivity\n\nPermissionPolicyInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PermissionPolicyService çš„ä¸€ä¸ªå†…éƒ¨ç±» `private class Internal extends PermissionPolicyInternal `\n\n```java\n//PermissionPolicyService.java\nprivate class Internal extends PermissionPolicyInternal {\n\n    @Override\n    public boolean checkStartActivity(@NonNull Intent intent, int callingUid,\n            @Nullable String callingPackage) {\n        if (callingPackage != null && isActionRemovedForCallingPackage(intent, callingUid,\n                callingPackage)) {\n            return false;\n        }\n        return true;\n    }\n```\n\n\n```java\n//PermissionPolicyService.java\nprivate boolean isActionRemovedForCallingPackage(@NonNull Intent intent, int callingUid,\n        @NonNull String callingPackage) {\n    String action = intent.getAction();\n    if (action == null) {\n        return false;\n    }\n    switch (action) {\n        case TelecomManager.ACTION_CHANGE_DEFAULT_DIALER:\n        case Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT: {\n            ApplicationInfo applicationInfo;\n            try {\n                applicationInfo = getContext().getPackageManager().getApplicationInfoAsUser(\n                        callingPackage, 0, UserHandle.getUserId(callingUid));\n                if (applicationInfo.targetSdkVersion >= Build.VERSION_CODES.Q) {\n                    //åªæœ‰é«˜ç‰ˆæœ¬æ‰ä¼šæ£€æŸ¥è¿™ä¸ªé—®é¢˜å’¯\n                    return true;\n                }\n            } catch (PackageManager.NameNotFoundException e) {\n                \n            }\n          \n            intent.putExtra(Intent.EXTRA_CALLING_PACKAGE, callingPackage);\n            return false;\n        }\n        default:\n            return false;\n    }\n}\n```\n\n## shouldAbortBackgroundActivityStart\n\n```java\nboolean shouldAbortBackgroundActivityStart(int callingUid, int callingPid,\n        final String callingPackage, int realCallingUid, int realCallingPid,\n        WindowProcessController callerApp, PendingIntentRecord originatingPendingIntent,\n        boolean allowBackgroundActivityStart, Intent intent) {\n    \n    //1ã€âœ…ç³»ç»Ÿç”¨æˆ·åº”ç”¨ã€å…·æœ‰ Root æƒé™çš„åº”ç”¨ã€NFC ï¼ˆä¸€èˆ¬æ˜¯ä¼´ç”Ÿè®¾å¤‡ï¼‰åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    final int callingAppId = UserHandle.getAppId(callingUid);\n    if (callingUid == Process.ROOT_UID || callingAppId == Process.SYSTEM_UID\n            || callingAppId == Process.NFC_UID) {\n        return false;\n    }\n\n    //2ã€âœ…å¦‚æœæ˜¯æ¡Œé¢ç¨‹åºå¯åŠ¨æ˜¯å…è®¸çš„  [æ­£å¸¸ç”¨æˆ·æ“ä½œä¸å°±æ˜¯ç‚¹å‡»æ¡Œé¢åº”ç”¨å›¾æ ‡ç„¶åå¯åŠ¨çš„å˜›]\n    if (isHomeApp(callingUid, callingPackage)) {\n        return false;\n    }\n\n    //3ã€âœ…è®¾å¤‡æ‰€æœ‰è€…æ˜¯å…è®¸çš„\n    final WindowState imeWindow = mRootWindowContainer.getCurrentInputMethodWindow();\n    if (imeWindow != null && callingAppId == imeWindow.mOwnerUid) {\n        return false;\n    }\n\n    //4ã€âœ…å¦‚æœæœ‰å‰å°åº”ç”¨æˆ–å¯è§ç•Œé¢å­˜åœ¨å‰å°ï¼Œè¿™ä¹Ÿæ˜¯å…è®¸çš„\n    final int appSwitchState = mService.getBalAppSwitchesState();\n    final int callingUidProcState = mService.mActiveUids.getUidState(callingUid);\n    final boolean callingUidHasAnyVisibleWindow = mService.hasActiveVisibleWindow(callingUid);\n    final boolean isCallingUidForeground = callingUidHasAnyVisibleWindow\n            || callingUidProcState == ActivityManager.PROCESS_STATE_TOP\n            || callingUidProcState == ActivityManager.PROCESS_STATE_BOUND_TOP;\n    final boolean isCallingUidPersistentSystemProcess =\n            callingUidProcState <= ActivityManager.PROCESS_STATE_PERSISTENT_UI;\n\n    //5ã€âœ…åœ¨åº”ç”¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„\n    final boolean appSwitchAllowedOrFg =\n            appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY;\n    if (((appSwitchAllowedOrFg || mService.mActiveUids.hasNonAppVisibleWindow(callingUid))\n            && callingUidHasAnyVisibleWindow)\n            || isCallingUidPersistentSystemProcess) {\n        return false;\n    }\n    \n    final int realCallingUidProcState = (callingUid == realCallingUid)\n            ? callingUidProcState\n            : mService.mActiveUids.getUidState(realCallingUid);\n    final boolean realCallingUidHasAnyVisibleWindow = (callingUid == realCallingUid)\n            ? callingUidHasAnyVisibleWindow\n            : mService.hasActiveVisibleWindow(realCallingUid);\n    final boolean isRealCallingUidForeground = (callingUid == realCallingUid)\n            ? isCallingUidForeground\n            : realCallingUidHasAnyVisibleWindow\n                    || realCallingUidProcState == ActivityManager.PROCESS_STATE_TOP;\n    final int realCallingAppId = UserHandle.getAppId(realCallingUid);\n    final boolean isRealCallingUidPersistentSystemProcess = (callingUid == realCallingUid)\n            ? isCallingUidPersistentSystemProcess\n            : (realCallingAppId == Process.SYSTEM_UID)\n                    || realCallingUidProcState <= ActivityManager.PROCESS_STATE_PERSISTENT_UI;\n    if (realCallingUid != callingUid) {\n        //6ã€âœ…å¦‚æœè°ƒç”¨çš„è¿›ç¨‹æœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„\n        if (realCallingUidHasAnyVisibleWindow) {\n            if (DEBUG_ACTIVITY_STARTS) {\n                Slog.d(TAG, \"Activity start allowed: realCallingUid (\" + realCallingUid\n                        + \") has visible (non-toast) window\");\n            }\n            return false;\n        }\n\n        //7ã€âœ…å¦‚æœæ˜¯â€˜ç³»ç»ŸæŒä¹…åº”ç”¨â€™å‘èµ·çš„è¯·æ±‚æ˜¯å…è®¸çš„\n        if (isRealCallingUidPersistentSystemProcess && allowBackgroundActivityStart) {\n            return false;\n        }\n\n        //8ã€âœ…å¦‚æœå­˜åœ¨ä¼´ç”Ÿè®¾å¤‡æˆ–è€…ç›¸å…³å¯è§åº”ç”¨è¿›ç¨‹æ˜¯å…è®¸çš„\n        if (mService.isAssociatedCompanionApp(UserHandle.getUserId(realCallingUid),\n                realCallingUid)) {\n            return false;\n        }\n    }\n\n    //9ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ START_ACTIVITIES_FROM_BACKGROUND æ˜¯å…è®¸çš„\n    if (mService.checkPermission(START_ACTIVITIES_FROM_BACKGROUND, callingPid, callingUid)\n            == PERMISSION_GRANTED) {\n        return false;\n    }\n\n    //10ã€âœ…å¦‚æœæœ€è¿‘å­˜åœ¨ç›¸åŒ uid è¿›ç¨‹å¯åŠ¨ç›¸å…³ç»„ä»¶æ˜¯å…è®¸çš„ï¼ˆåŒä¸€ä¸ªåº”ç”¨ï¼‰\n    if (mSupervisor.mRecentTasks.isCallerRecents(callingUid)) {\n        return false;\n    }\n\n    //11ã€âœ…å¯¹äºè®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„\n    if (mService.isDeviceOwner(callingUid)) {\n        return false;\n    }\n\n    //12ã€âœ…å¯¹äºä¼´ç”Ÿè®¾å¤‡çš„è¯·æ±‚æ˜¯å…è®¸çš„\n    final int callingUserId = UserHandle.getUserId(callingUid);\n    if (mService.isAssociatedCompanionApp(callingUserId, callingUid)) {\n        return false;\n    }\n    \n    //13ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ SYSTEM_ALERT_WINDOW æ˜¯å…è®¸çš„\n    if (mService.hasSystemAlertWindowPermission(callingUid, callingPid, callingPackage)) {\n        return false;\n    }\n\n  \n    int callerAppUid = callingUid;\n    if (callerApp == null) {\n        callerApp = mService.getProcessController(realCallingPid, realCallingUid);\n        callerAppUid = realCallingUid;\n    }\n    if (callerApp != null) {\n        //â€¼ï¸æ¥åˆ°äº†æ–°çš„å¯åŠ¨æ§åˆ¶ç±»ï¼šBackgroundLaunchProcessController#areBackgroundActivityStartsAllowed\n        //å‚è€ƒä¸‹æ–‡\n        if (callerApp.areBackgroundActivityStartsAllowed(appSwitchState)) {\n            return false;\n        }\n\n        final ArraySet<WindowProcessController> uidProcesses =\n                mService.mProcessMap.getProcesses(callerAppUid);\n        if (uidProcesses != null) {\n            for (int i = uidProcesses.size() - 1; i >= 0; i--) {\n                final WindowProcessController proc = uidProcesses.valueAt(i);\n                //å‚çœ‹ä¸‹æ–‡\n                if (proc != callerApp\n                        && proc.areBackgroundActivityStartsAllowed(appSwitchState)) {\n                    return false;\n                }\n            }\n        }\n    }\n    \n    return true;\n}\n```\n\n## areBackgroundActivityStartsAllowed\n\n```java\n//BackgroundLaunchProcessController.java\nboolean areBackgroundActivityStartsAllowed(int pid, int uid, String packageName,\n        int appSwitchState, boolean isCheckingForFgsStart,\n        boolean hasActivityInVisibleTask, boolean hasBackgroundActivityStartPrivileges,\n        long lastStopAppSwitchesTime, long lastActivityLaunchTime,\n        long lastActivityFinishTime) {\n    if (appSwitchState == APP_SWITCH_ALLOW) {\n        final long now = SystemClock.uptimeMillis();\n        if (now - lastActivityLaunchTime < ACTIVITY_BG_START_GRACE_PERIOD_MS\n                || now - lastActivityFinishTime < ACTIVITY_BG_START_GRACE_PERIOD_MS) {\n            if (lastActivityLaunchTime > lastStopAppSwitchesTime\n                    || lastActivityFinishTime > lastStopAppSwitchesTime) {\n                return true;\n            }\n        }\n    }\n    if (hasBackgroundActivityStartPrivileges) {\n        return true;\n    }\n\n    if (hasActivityInVisibleTask\n            && (appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY)) {\n        return true;\n    }\n    if (isBoundByForegroundUid()) {\n        return true;\n    }\n    if (isBackgroundStartAllowedByToken(uid, packageName, isCheckingForFgsStart)) {\n        return true;\n    }\n    return false;\n}\n```\n\n# startActivityUnchecked\n\n```java\n//ActivityStarter.java\nprivate int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n}\n```\n\n\n# Reference\n\n- è¾“å…¥æ³•æ§ä»¶ IMEï¼šhttps://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn\n- [ å…³äºå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹çš„æ¦‚å¿µ ](https://baike.baidu.com/item/å­¤å„¿è¿›ç¨‹/16751450#:~:text=åœ¨æ“ä½œç³»ç»Ÿé¢†åŸŸä¸­ï¼Œå­¤å„¿è¿›ç¨‹æŒ‡çš„æ˜¯åœ¨å…¶çˆ¶è¿›ç¨‹æ‰§è¡Œå®Œæˆæˆ–è¢«ç»ˆæ­¢åä»ç»§ç»­è¿è¡Œçš„ä¸€ç±»è¿›ç¨‹%E3%80%82,è¿™äº›å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹%20%28è¿›ç¨‹å·ä¸º1%29æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œ%E3%80%82)\n- [ å…³äº UIDã€PID çš„äº†è§£](https://www.cnblogs.com/perseus/articles/2354173.html)\n- [AutofillManager å‚è€ƒé“¾æ¥ [1]](https://developer.android.google.cn/guide/topics/text/autofill?hl=zh-cn)","slug":"Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨ä¸€","published":1,"lang":"undefined","updated":"2022-09-29T14:57:44.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignso000dgaqph4pu9be0","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>Ready go</h1>\n<p>åœ¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œä¸Šä¸€ç« æˆ‘ä»¬å¯¹ <code>package</code> ç›®å½•ä¸‹çš„å†…å®¹æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæˆ‘ä»¬çŸ¥é“è®¾å¤‡ä¸Šçš„æ¡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ª<code>ç³»ç»Ÿåº”ç”¨</code>ï¼ŒAOSP åŸç”Ÿæœ‰æä¾›ï¼Œä½†æ˜¯å‚å•†å®šåˆ¶çš„ ROM å¾€å¾€ä¼šè‡ªå·±é‡å†™æˆ–é‡æ–°å®ç°ï¼Œæ‰©å±•åŠŸèƒ½ï¼›é‚£ä¹ˆç»§ç»­ Android ç³»ç»Ÿå¯åŠ¨æ€è€ƒå¾€ä¸‹èµ°ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥çœ‹çœ‹æ‰‹æœºæ¡Œé¢æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„â€”â€”â€”æ¡Œé¢ç¨‹åºæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ</p>\n<p>è™½ç„¶æˆ‘ä»¬çŸ¥é“æ¡Œé¢ç¨‹åºæ˜¯<code>Launcher</code>ï¼Œä½†æ˜¯æˆ‘ä»¬ä½œä¸ºåˆšé˜…è¯»æºç çš„å°ç™½ï¼Œ<strong>å¦‚ä½•åœ¨æºç ä¸­å¿«é€Ÿæ‰¾åˆ°æ¡Œé¢ç¨‹åºå¯åŠ¨çš„å…¥å£ï¼Ÿ</strong> è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ€è€ƒçš„é—®é¢˜ï¼Œ å½“ç„¶ï¼Œç«™åœ¨â€˜å·¨äººçš„è‚©è†€â€™ç›´æ¥ä½¿ç”¨ç™¾åº¦ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†è¿™é‡Œæˆ‘æƒ³åˆ°å¦å¤–ä¸€ç§æ–¹å¼â€”â€”â€”â€”<code>æ— éšœç¢æœåŠ¡ Accessebility</code>ï¼›åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæ— éšœç¢æœåŠ¡é™¤äº†æ»¡è¶³é¡¹ç›®éœ€æ±‚åº”ç”¨äºé¡¹ç›®ä¸­å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨è¯¥æœåŠ¡ä½œä¸ºæˆ‘ä»¬çš„è¾…åŠ©å·¥å…·ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä¸ªäººæœ€å¸¸ç”¨çš„å°±æ˜¯<code>æŸ¥çœ‹ç³»ç»Ÿå½“å‰æœ€é¡¶éƒ¨æ˜¾ç¤ºçš„ activity</code>ã€‚ä½œä¸ºè¾…åŠ©æ‰‹æ®µï¼Œæ—©å·²æœ‰æˆç†Ÿçš„è½¯ä»¶å·¥å…·ï¼Œè¿™é‡Œæ¨èä¸¤ä¸ªå·¥å…·ã€‚</p>\n<ul>\n<li>å¼€å‘è€…åŠ©æ‰‹</li>\n<li>Android å¼€å‘å·¥å…·ç®±</li>\n<li>MT æ–‡ä»¶ç®¡ç†å™¨</li>\n</ul>\n<h1>systemReady</h1>\n<p>æˆ‘ä»¬çŸ¥é“ï¼ŒSystemServer åœ¨è¢«è°ƒç”¨æ—¶å…ˆæ‰§è¡Œ <code>main</code> å‡½æ•°ï¼Œç´§æ¥ç€æ‰§è¡Œå½“å‰ç±»çš„é™æ€æ–¹æ³• <code>run</code>ï¼Œç„¶ååˆ†ä¸‰ä¸ªé˜¶æ®µå¯åŠ¨ <code>å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡</code>ï¼Œæœ€åè¿›å…¥ <code>Looper().loop</code> å¾ªç¯å¿˜ä¸åœæ­‡çš„ <s>æ‰“å·¥</s> ç­‰å¾…æ¶ˆæ¯åˆ°æ¥å¹¶å¤„ç†ã€‚å¯åŠ¨æœåŠ¡æ˜¯ä¸€éƒ¨åˆ†ï¼Œéš¾é“ä¸åšç‚¹åˆ«çš„å—ï¼Ÿåˆšå¥½åœ¨å¯åŠ¨ <strong>å…¶ä»–æœåŠ¡</strong> è¿™é‡Œçœ‹åˆ°è¿™ä¸€æ®µæ³¨é‡Šï¼š</p>\n<figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// We now tell the activity manager it is okay to run third party</span></span><br><span class=\"line\"><span class=\"comment\">// code.  It will call back into us once it has gotten to the state</span></span><br><span class=\"line\"><span class=\"comment\">// where third party code can really run (but before it has actually</span></span><br><span class=\"line\"><span class=\"comment\">// started launching the initial applications), for us to complete our</span></span><br><span class=\"line\"><span class=\"comment\">// initialization.</span></span><br><span class=\"line\"></span><br><span class=\"line\">SystemServerï¼šAMS ä½ æ‰€éœ€çš„ä¸€äº›æœåŠ¡å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨äº†ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œ<span class=\"built_in\">over</span>ï¼<span class=\"built_in\">over</span>ï¼</span><br><span class=\"line\"></span><br><span class=\"line\">AMSï¼šæ”¶åˆ°ï¼æ”¶åˆ°ï¼çœ‹æˆ‘å›è°ƒè¡Œäº‹ï¼Œ<span class=\"built_in\">over</span>ï¼</span><br></pre></td></tr></table></figure>\n<p>å…ˆæ˜¯ AMS systemReady è¿›å…¥å‡†å¤‡é˜¶æ®µ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityManagerService.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">systemReady</span><span class=\"params\">(<span class=\"keyword\">final</span> Runnable goingCallback, <span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ç®¡ç† activity çš„ä»»åŠ¡æ ˆã€è¿™ç§å†…å®¹å¤ªç»†äº†ï¼Œä»¥åé€ä¸ªçœ‹çœ‹ï¼Œå…ˆç•¥è¿‡ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åŒ…å« RecentTasks æœ€è¿‘è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mActivityTaskManager.onSystemReady();</span><br><span class=\"line\">    mUserController.onSystemReady();</span><br><span class=\"line\">    <span class=\"comment\">//è®¿é—®æ§åˆ¶ï¼Œä¸»è¦ä¸æƒé™ã€é™åˆ¶ç›¸å…³</span></span><br><span class=\"line\">    mAppOpsService.systemReady();</span><br><span class=\"line\">    mProcessList.onSystemReady();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¦‚æœè¿›ç¨‹æˆ–è¿›ç¨‹ç»„è¢«æ ‡è®°ä¸ºæ€æ­»ï¼Œå°†è°ƒç”¨ Process.killProcessQuiet(mPid);ProcessList.killProcessGroup(uid, mPid);æ€æ­»è¿›ç¨‹ï¼Œä¸ºå¯åŠ¨æ–°è¿›ç¨‹åšå‡†å¤‡</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å½“ç„¶ï¼Œè¿›ç¨‹ä¹Ÿå¯èƒ½è¢«æ ‡è®°ä¸ºé‡å¯ï¼Œä¾¿ä¸ä¼šä»è¿›ç¨‹é˜Ÿåˆ—ä¸­ç§»é™¤       </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mProcessList.removeProcessLocked</span><br><span class=\"line\">    <span class=\"comment\">//æ³¨å†Œå¯åŠ¨ç›‘å¬ï¼ŒATMï¼šactivitTaskManager</span></span><br><span class=\"line\">    mAtmInternal.getLaunchObserverRegistry().registerLaunchObserver(mActivityLaunchObserver);</span><br><span class=\"line\">    <span class=\"comment\">//UGMï¼šuri global managerï¼Œuri ä½œä¸ºæ•°æ®è®¿é—®åœ°å€ã€æ•°æ®ä¼ é€’ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„</span></span><br><span class=\"line\">    mUgmInternal.onSystemReady();</span><br><span class=\"line\">    <span class=\"comment\">//pmiï¼špower manager internalï¼Œä½ç”µé‡ç›‘æ§</span></span><br><span class=\"line\">    pmi.registerLowPowerModeObserver</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ğŸ˜“æ‰§è¡Œåˆ°ä¸€åŠå°±è¿”å›å»æ‰§è¡Œå›è°ƒã€è¯·å‚è€ƒ â€”â€” å›è°ƒ1ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (goingCallback != <span class=\"keyword\">null</span>) goingCallback.run();</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¯åŠ¨æŒä¹…åº”ç”¨ï¼ˆä¸ä¼šä¼‘çœ çš„ã€å¯åŠ¨å”¤é†’ç¨‹åºï¼‰ï¼Œå¾…å¯åŠ¨çš„æ˜¯å“ªäº›åº”ç”¨ï¼Œåˆæ¥åˆ°äº† IPackageManager.aidl çš„ getPersistentApplicationsï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">           å®ç°ç±»æ˜¯ PackageManagerService.java</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€getPersistentApplications å®é™…ä¸Šè·å–åˆ°çš„æ˜¯ä¸€ä¸ª ApplicationInfo åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€é€šè¿‡ applicationInfo åˆ›å»º processRecorderï¼Œæ¥ç€é€šè¿‡ ProcessList ä¸€é¡¿åˆ¤æ–­ã€è°ƒæ•´ processRecorder</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€æœ€åå¯èƒ½é€šè¿‡ wzygote æˆ– Process.start å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ActivityTaskManagerInternal.java å®ç°ç±»åœ¨ ActivityManagerService çš„ä¸€ä¸ªå†…éƒ¨ç±» LocalServiceï¼›</span></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¯åŠ¨æ¡Œé¢ç¨‹åº</span></span><br><span class=\"line\">    mAtmInternal.startHomeOnAllDisplays(currentUserId, <span class=\"string\">&quot;systemReady&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    mAtmInternal.resumeTopActivities(<span class=\"keyword\">false</span> <span class=\"comment\">/* scheduleIdle */</span>);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>AMS å‡†å¤‡å®Œæ¯•ï¼Œè¯·æ±‚ SystemServer è¶…çº§ç®¡å®¶æ‰§è¡Œå›è°ƒ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java ã€å›è°ƒ1ã€‘</span></span><br><span class=\"line\">mActivityManagerService.systemReady(() -&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//service.onBootPhase(mCurrentPhase=500); ç³»ç»ŸæœåŠ¡é‚£ä¹ˆå¤šåˆ°åº•è°åœ¨æ‰§è¡Œ 500 è¿™ä¸ªæ ‡è®°ï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œå›è°ƒå‘ŠçŸ¥å…¶ä»–æœåŠ¡ AMS å¯åŠ¨äº†ï¼Œä½ ä»¬å¯ä»¥ä½¿ç”¨ AMS åšåˆ«çš„äº‹æƒ…</span></span><br><span class=\"line\">    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//AMS éœ€è¦ç›‘æ§ native å´©æºƒï¼Œé‡Œé¢å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ Threadï¼Œå†…éƒ¨ä½¿ç”¨é˜»å¡çš„ socket æ¥æ”¶å´©æºƒä¿¡æ¯å¹¶è¿”å›ç»™ä¸Šå±‚æˆ–è¾“å‡º</span></span><br><span class=\"line\">    mActivityManagerService.startObservingNativeCrashes();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœ‹åˆ° ops å¾€å¾€æ˜¯è·Ÿé™åˆ¶ç­–ç•¥æœ‰å…³ğŸš«</span></span><br><span class=\"line\">    mActivityManagerService.setAppOpsPolicy(<span class=\"keyword\">new</span> AppOpsPolicy(mSystemContext));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Wait for all packages to be prepared</span></span><br><span class=\"line\">    mPackageManagerService.waitForAppDataPrepared();</span><br><span class=\"line\">    <span class=\"comment\">//ç¬¬ä¸‰æ–¹åº”ç”¨å‡†å¤‡å¥½äº†ï¼Œåˆå‘èµ·ä¸€ä¸ªå¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„å›è°ƒï¼Œè®©å„è‡ªå®ç°æ­¤çŠ¶æ€ç çš„æœåŠ¡æ‰§è¡Œç›¸åº”æ“ä½œã€è§å›¾1ã€‘</span></span><br><span class=\"line\">    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class=\"line\"></span><br><span class=\"line\">    ... etc</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ°è¿™é‡Œæˆ‘ä»¬ç®—æ˜¯å›è°ƒæ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬åˆè¦å›åˆ° systemReady é‡Œé¢å»ï¼Œç»§ç»­çœ‹æ‰§è¡Œ goingCallback.run(); ä¹‹åçš„ä»£ç </span></span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;, t);</span><br></pre></td></tr></table></figure>\n<h1>startHomeOnAllDisplays</h1>\n<p>æˆ‘ä»¬æƒ³çŸ¥é“ startHomeOnAllDisplays çš„å…·ä½“å®ç°åœ¨å“ªé‡Œï¼Ÿæœ‰è°æ‰§è¡Œçš„ï¼Ÿä¸å¦¨æ‰¾æ‰¾çœ‹ã€‚</p>\n<ul>\n<li>ActivityManagerService#mAtmInternal.startHomeOnAllDisplays(currentUserId, â€œsystemReadyâ€); <code>AMS ä¸­è°ƒç”¨</code></li>\n<li>ActivityTaskManagerInternal#startHomeOnAllDisplays   <code>è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•</code></li>\n<li>ActivityTaskManagerService#LocalService            <code>å®ç°ç±»æ˜¯ ATMS çš„å†…éƒ¨ç±»</code></li>\n<li>ActivityTaskManagerService#mInternal; <code>å®ç°ç±»å®ä¾‹èµ‹ç»™äº† ATMS çš„æˆå‘˜</code></li>\n<li>ActivityTaskManagerService#LocalServices.addService(ActivityTaskManagerInternal.class, mInternal); <code>åœ¨ ATMS å¯åŠ¨å‘¨æœŸ onStart ä¸­è¢«ç¼“å­˜åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨</code></li>\n<li>com.android.server#private static final ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects <code>æœ¬åœ°æœåŠ¡åˆ—è¡¨å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ•°ç»„</code></li>\n<li>ActivityTaskManagerService#mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class); <code>ä»æœ¬åœ°æœåŠ¡ç¼“å­˜åˆ—è¡¨ä¸­è·å–å®ä¾‹èµ‹ç»™ ATMS</code></li>\n</ul>\n<p>äº†è§£äº†ï¼Œç›´æ¥æ‰¾å®ç°ç±» <code>LocalService</code>ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityTaskManagerService.java#LocalService</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnAllDisplays</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mGlobalLock) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mRootWindowContainer.startHomeOnAllDisplays(userId, reason);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnAllDisplays</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ¡Œé¢ä¸»ç•Œé¢æ˜¯å¦å¯åŠ¨å®Œæ¯•</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> homeStarted = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œçš„å¾ªç¯è¡¨ç¤ºå¯¹åº” AllDisplaysï¼Œè®¾å¤‡æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªæ˜¾ç¤ºå™¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = getChildCount() - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> displayId = getChildAt(i).mDisplayId;</span><br><span class=\"line\">        homeStarted |= startHomeOnDisplay(userId, reason, displayId);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> homeStarted;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnDisplay</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, <span class=\"keyword\">int</span> displayId)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> startHomeOnDisplay(userId, reason, displayId, <span class=\"keyword\">false</span> <span class=\"comment\">/* allowInstrumenting */</span>,</span><br><span class=\"line\">            <span class=\"keyword\">false</span> <span class=\"comment\">/* fromHomeKey */</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnDisplay</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, <span class=\"keyword\">int</span> displayId, <span class=\"keyword\">boolean</span> allowInstrumenting,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> fromHomeKey)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœé‡åˆ°æ— æ•ˆçš„æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æˆ–å·²è·å¾—ç„¦ç‚¹çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºID</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (displayId == INVALID_DISPLAY) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task rootTask = getTopDisplayFocusedRootTask();</span><br><span class=\"line\">        displayId = rootTask != <span class=\"keyword\">null</span> ? rootTask.getDisplayId() : DEFAULT_DISPLAY;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> DisplayContent display = getDisplayContent(displayId);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> display.reduceOnAllTaskDisplayAreas((taskDisplayArea, result) -&gt;</span><br><span class=\"line\">                    result | startHomeOnTaskDisplayArea(userId, reason, taskDisplayArea,</span><br><span class=\"line\">                            allowInstrumenting, fromHomeKey),</span><br><span class=\"line\">            <span class=\"keyword\">false</span> <span class=\"comment\">/* initValue */</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnTaskDisplayArea</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, TaskDisplayArea taskDisplayArea,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowInstrumenting, <span class=\"keyword\">boolean</span> fromHomeKey)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœæä¾›çš„ç°å®åŒºåŸŸæ— æ•ˆï¼ŒåŒæ ·çš„æ¢å¤é»˜è®¤</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (taskDisplayArea == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task rootTask = getTopDisplayFocusedRootTask();</span><br><span class=\"line\">        taskDisplayArea = rootTask != <span class=\"keyword\">null</span> ? rootTask.getDisplayArea()</span><br><span class=\"line\">                : getDefaultTaskDisplayArea();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸é‡è¦çš„æ¥äº†ï¼Œæ¡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ª activityï¼Œå¯åŠ¨ä¸€ä¸ª activityï¼Œæœ€é‡è¦çš„ä¾¿æ˜¯å¯åŠ¨ç›®æ ‡ä¿¡æ¯</span></span><br><span class=\"line\">    Intent homeIntent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    ActivityInfo aInfo = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (taskDisplayArea == getDefaultTaskDisplayArea()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€mService æ˜¯ ActivityTaskManagerService</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€ã€é»˜è®¤ã€‘intent.addCategory(Intent.CATEGORY_HOME); mTopAction = Intent.ACTION_MAIN;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        homeIntent = mService.getHomeIntent();</span><br><span class=\"line\">        aInfo = resolveHomeActivity(userId, homeIntent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (shouldPlaceSecondaryHomeOnDisplayArea(taskDisplayArea)) &#123;</span><br><span class=\"line\">        Pair&lt;ActivityInfo, Intent&gt; info = resolveSecondaryHomeActivity(userId, taskDisplayArea);</span><br><span class=\"line\">        aInfo = info.first;</span><br><span class=\"line\">        homeIntent = info.second;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (aInfo == <span class=\"keyword\">null</span> || homeIntent == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¾ç¤ºæ€»æ˜¯æœ‰ä¸€äº›æ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!canStartHomeOnDisplayArea(aInfo, taskDisplayArea, allowInstrumenting)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    homeIntent.setComponent(<span class=\"keyword\">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class=\"line\">    homeIntent.setFlags(homeIntent.getFlags() | FLAG_ACTIVITY_NEW_TASK);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fromHomeKey) &#123;</span><br><span class=\"line\">        homeIntent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mWindowManager.getRecentsAnimationController() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mWindowManager.getRecentsAnimationController().cancelAnimationForHomeStart();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    homeIntent.putExtra(WindowManagerPolicy.EXTRA_START_REASON, reason);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨ activity è¿˜å¾—çœ‹ activityStartController</span></span><br><span class=\"line\">    mService.getActivityStartController().startHomeActivity(homeIntent, aInfo, myReason,</span><br><span class=\"line\">            taskDisplayArea);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>activitStartController</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStartController.java</span></span><br><span class=\"line\"><span class=\"comment\">//âš ï¸ï¼šè¿™é‡Œå¯åŠ¨çš„æ˜¯ homeItent</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startHomeActivity</span><span class=\"params\">(Intent intent, ActivityInfo aInfo, String reason,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskDisplayArea taskDisplayArea)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ²¡æœ‰ä»»ä½•é™„åŠ å±æ€§ï¼Œæ¯”å¦‚æ²¡æœ‰ activity åŠ¨ç”»</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityOptions options = ActivityOptions.makeBasic();</span><br><span class=\"line\">    <span class=\"comment\">//å…¨å±çª—å£æ¨¡å¼</span></span><br><span class=\"line\">    options.setLaunchWindowingMode(WINDOWING_MODE_FULLSCREEN);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ActivityRecord.isResolverActivity(aInfo.name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªæ¡Œé¢ activity </span></span><br><span class=\"line\">        options.setLaunchActivityType(ACTIVITY_TYPE_HOME);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¾ç¤ºè®¾å¤‡IDä¹ŸæŒ‡å®šï¼Œä¼¼ä¹ activity å¯åŠ¨éœ€è¦çš„å‚æ•°éƒ½å°†å°è£…åˆ° ActivitOptions </span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> displayId = taskDisplayArea.getDisplayId();</span><br><span class=\"line\">    options.setLaunchDisplayId(displayId);</span><br><span class=\"line\">    options.setLaunchTaskDisplayArea(taskDisplayArea.mRemoteToken</span><br><span class=\"line\">            .toWindowContainerToken());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åªæ˜¯ä¸€ä¸ªå˜é‡é€’å¢ mDeferResumeCount++ï¼Œè¿™å¦‚ä½•ä½¿ç”¨ </span></span><br><span class=\"line\">    mSupervisor.beginDeferResume();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task rootHomeTask;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€activity éœ€è¦ä¾èµ– task å®¹å™¨ï¼Œæ‰€ä»¥å¯åŠ¨å‰å¿…é¡»ç¡®ä¿ Task å·²åˆ›å»º</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€TaskDisplayArea#createRootTask éœ€æŒ‡å®š activityType=home_activityï¼Œontop=true åœ¨æ˜¾ç¤ºå™¨çš„é¡¶éƒ¨åˆ›å»º rootTask</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æœ€ç»ˆåˆ›å»ºæ˜¯é€šè¿‡ Task.Builder()......build();  è‡³æ­¤ï¼Œå­˜å‚¨æ¡Œé¢ activity çš„ Task å·²ç»æœ‰äº†</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€mRootWindowContainer è¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘ä»¬æ‰€è§åˆ°çš„ç•Œé¢éƒ½è¦ä¾é™„äºå®ƒ</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        rootHomeTask = taskDisplayArea.getOrCreateRootHomeTask(ON_TOP<span class=\"comment\">/*true*/</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//è¿™ä¸ªè·Ÿ mDeferResumeCount++ å¯¹åº”ï¼Œè¿™é‡Œæ˜¯ mDeferResumeCount--</span></span><br><span class=\"line\">        <span class=\"comment\">//å…³äºè¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šreadyToResume() &#123;return mDeferResumeCount == 0;&#125; </span></span><br><span class=\"line\">        <span class=\"comment\">//true if resume can be calledï¼šé‚£ä¼°è®¡æ˜¯å“ªé‡Œè¿›è¡Œè½®è¯¢ç›‘å¬ readyToResume()</span></span><br><span class=\"line\">        mSupervisor.endDeferResume();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æœ‰äº†å¯æ‰¿è½½æ¡Œé¢ç¨‹åºçš„ä»»åŠ¡æ ˆï¼Œæ¥ç€å°±è¦å¯åŠ¨æ¡Œé¢ activity</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€è·å¾—ä¸€ä¸ª activity å¯åŠ¨å™¨ ActivitStarterï¼Œå¼€å§‹æ‰§è¡Œ excute()</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¯åŠ¨å™¨ä¼¼ä¹ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œé»˜è®¤å¯åŠ¨å™¨æ•°é‡ 3 ä¸ª</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€å¯åŠ¨å™¨ä¸»è¦æˆå‘˜æœ‰ ActivityStartControllerã€ActivityTaskManagerServiceã€ActivityTaskSupervisorã€ActivityStartInterceptor</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€åœ¨æ„å»ºè¯·æ±‚å™¨è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ„é€ å¯åŠ¨è¯·æ±‚å‚æ•° mRequest </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mLastHomeActivityStartResult = obtainStarter(intent, <span class=\"string\">&quot;startHomeActivity: &quot;</span> + reason)</span><br><span class=\"line\">            .setOutActivity(tmpOutRecord)</span><br><span class=\"line\">            .setCallingUid(<span class=\"number\">0</span>)</span><br><span class=\"line\">            .setActivityInfo(aInfo)</span><br><span class=\"line\">            .setActivityOptions(options.toBundle())</span><br><span class=\"line\">            .execute();</span><br><span class=\"line\">    mLastHomeActivityStartRecord = tmpOutRecord[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rootHomeTask.mInResumeTopActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¼€å§‹è°ƒç”¨ onResume å£°æ˜å‘¨æœŸæ–¹æ³•ï¼Œå›åˆ° activity æœ€ç†Ÿæ‚‰çš„åœ°æ–¹</span></span><br><span class=\"line\">        mSupervisor.scheduleResumeTopActivities();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å…³äº <code>ActivityTaskSupervisor</code> è´Ÿè´£çš„ä»»åŠ¡å¤ªå¤šäº†ï¼Œä¼°è®¡åƒä¸ªç‰ˆæœ¬è¦åˆ†ç¦»éƒ¨åˆ†ä»£ç å§</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// <span class=\"doctag\">TODO:</span> This class has become a dumping ground. Let&#x27;s</span></span><br><span class=\"line\"><span class=\"comment\">// - Move things relating to the hierarchy to RootWindowContainer</span></span><br><span class=\"line\"><span class=\"comment\">// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler</span></span><br><span class=\"line\"><span class=\"comment\">// - Move interface things to ActivityTaskManagerService.</span></span><br><span class=\"line\"><span class=\"comment\">// - All other little things to other files.</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ActivityTaskSupervisor</span> <span class=\"keyword\">implements</span> <span class=\"title\">RecentTasks</span>.<span class=\"title\">Callbacks</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>activityStarter</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">execute</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€å¦‚æœå¯åŠ¨è¯·æ±‚ä¿¡æ¯æ— æ•ˆï¼Œåˆ™é‡æ–°è§£æå¹¶å¡«å……å¯åŠ¨è¯·æ±‚å‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€è¯·æ±‚å‚æ•°åŒ…æ‹¬ pidã€uidã€resolveInfoã€activityInfo  .etc</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mRequest.activityInfo == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mRequest.resolveActivity(mSupervisor);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> res;</span><br><span class=\"line\">        <span class=\"comment\">//mGlobalLock å…¨å±€æœåŠ¡é”ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mService.mGlobalLock) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> globalConfigWillChange = mRequest.globalConfig != <span class=\"keyword\">null</span></span><br><span class=\"line\">                    &amp;&amp; mService.getGlobalConfiguration().diff(mRequest.globalConfig) != <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Task rootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (rootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                rootTask.mConfigWillChange = globalConfigWillChange;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> origId = Binder.clearCallingIdentity();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                1ã€ä»€ä¹ˆé‡é‡çº§è¿›ç¨‹åˆ‡æ¢ï¼Œæˆ‘éƒ½æ‡µäº†ğŸ˜º</span></span><br><span class=\"line\"><span class=\"comment\">                2ã€å¦‚æœæ‰¾ä¸åˆ°è°ƒç”¨è€… app è¿›ç¨‹ï¼Œåˆ™ç»ˆæ­¢å¯åŠ¨è¯·æ±‚ ATMS.getProcessController(request.caller) == null</span></span><br><span class=\"line\"><span class=\"comment\">            */</span></span><br><span class=\"line\">            res = resolveToHeavyWeightSwitcherIfNeeded();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (res != START_SUCCESS) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//â€¼ï¸æ‰§è¡Œå¯åŠ¨è¯·æ±‚</span></span><br><span class=\"line\">            res = executeRequest(mRequest);</span><br><span class=\"line\"></span><br><span class=\"line\">            mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(launchingState, res,</span><br><span class=\"line\">                    newActivityCreated, mLastStartActivityRecord, originalOptions);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mRequest.waitResult != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                mRequest.waitResult.result = res;</span><br><span class=\"line\">                res = waitResultIfNeeded(mRequest.waitResult, mLastStartActivityRecord,</span><br><span class=\"line\">                        launchingState);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> getExternalResult(res);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æ‰§è¡Œå®Œæˆæœ€åä¸€å®šè¦å›æ”¶ activity å¯åŠ¨å™¨</span></span><br><span class=\"line\">        onExecutionComplete();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>activity å¯åŠ¨è¯·æ±‚æ­£å¼å¼€å§‹ï¼Œè¿™é‡Œå°†ä¼šæœ‰å¾ˆå¤šçš„å¯åŠ¨é™åˆ¶ğŸš«ç­‰ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivitStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">executeRequest</span><span class=\"params\">(Request request)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¾ˆå¥½å¥‡è¿™ä¸ª reason è¿™ä¹ˆæ€»è¦å—ï¼Ÿå¹²ä»€ä¹ˆç”¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TextUtils.isEmpty(request.reason)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Need to specify a reason.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœä¸­é€”æ£€æµ‹åˆ°æ˜¯éå¯åŠ¨æˆåŠŸï¼ˆè§¦å‘å¯åŠ¨é™åˆ¶ï¼‰ï¼Œé‚£ä¹ˆç«‹é©¬ç»“æŸè¯·æ±‚ï¼Œè¿”å›ç»“æœ</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class=\"line\">    <span class=\"comment\">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Bundle verificationBundle =</span><br><span class=\"line\">            options != <span class=\"keyword\">null</span> ? options.popAppVerificationBundle() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒé™åˆ¶1ï¼šæ ¹æ®å¯åŠ¨è¯·æ±‚è°ƒç”¨è€… caller å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯åŠ¨ app è¿›ç¨‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›æ‹¦æˆªè¯·æ±‚</span></span><br><span class=\"line\">    WindowProcessController callerApp = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (caller != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        callerApp = mService.getProcessController(caller);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callerApp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            callingPid = callerApp.getPid();</span><br><span class=\"line\">            callingUid = callerApp.mInfo.uid;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            err = START_PERMISSION_DENIED;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> launchFlags = intent.getFlags();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class=\"number\">0</span> &amp;&amp; sourceRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒä»€ä¹ˆè¯·æ±‚å†²çªï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            SafeActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒå¯åŠ¨ç›®æ ‡ activity æœªçŸ¥ï¼Œå¤±è´¥</span></span><br><span class=\"line\">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒåŒæ ·çš„ï¼Œè¯·æ±‚æ‰€éœ€è¦çš„åŸºç¡€ä¿¡æ¯éƒ½æœªçŸ¥ï¼Œè‡ªç„¶ä¸­æ–­æœ¬æ¬¡è¯·æ±‚</span></span><br><span class=\"line\">        err = ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// voiceSession è¯­éŸ³äº¤äº’ç›¸å…³ activityã€è¿™é‡Œå…¶å®æ˜¯ activity å¯åŠ¨éƒ½ä¼šç»è¿‡çš„è·¯é€”ï¼Œåªæ˜¯æˆ‘ä»¬æœ¬æ¬¡åˆ†æçš„æ˜¯â€˜å¯åŠ¨æ¡Œé¢ activityâ€™ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; sourceRecord.getTask().voiceSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((launchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span></span><br><span class=\"line\">                &amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                intent.addCategory(Intent.CATEGORY_VOICE);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!mService.getPackageManager().activitySupportsIntent(</span><br><span class=\"line\">                        intent.getComponent(), intent, resolvedType)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ</span></span><br><span class=\"line\">                    err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ</span></span><br><span class=\"line\">                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!mService.getPackageManager().activitySupportsIntent(intent.getComponent(),</span><br><span class=\"line\">                    intent, resolvedType)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//âŒä¸æ”¯æŒ</span></span><br><span class=\"line\">                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//âŒä¸æ”¯æŒ</span></span><br><span class=\"line\">            err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err != START_SUCCESS) &#123;</span><br><span class=\"line\">        SafeActivityOptions.abort(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ£€æŸ¥ activity å¯åŠ¨æ˜¯å¦æ»¡è¶³æ¡ä»¶</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,</span><br><span class=\"line\">            requestCode, callingPid, callingUid, callingPackage, callingFeatureId,</span><br><span class=\"line\">            request.ignoreTargetSecurity, inTask != <span class=\"keyword\">null</span>, callerApp, resultRecord,</span><br><span class=\"line\">            resultRootTask);</span><br><span class=\"line\">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</span><br><span class=\"line\">            callingPid, resolvedType, aInfo.applicationInfo);</span><br><span class=\"line\">    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,</span><br><span class=\"line\">            callingPackage);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> restrictedBgActivity = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!abort) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//ç»§ç»­æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯åŠ¨æ¡ä»¶</span></span><br><span class=\"line\">            restrictedBgActivity = shouldAbortBackgroundActivityStart(callingUid,</span><br><span class=\"line\">                    callingPid, callingPackage, realCallingUid, realCallingPid, callerApp,</span><br><span class=\"line\">                    request.originatingPendingIntent, request.allowBackgroundActivityStart,</span><br><span class=\"line\">                    intent);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">//ç•¥ç•¥ç•¥ï½ï½ï½</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ²¡æœ‰é€šè¿‡å¯åŠ¨æ£€æŸ¥å°±è¦ç»“æŸæ‰§è¡Œäº†</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (abort) &#123;</span><br><span class=\"line\">        ActivityOptions.abort(checkedOptions);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_ABORTED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (aInfo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired(</span><br><span class=\"line\">                aInfo.packageName, userId)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> IIntentSender target = mService.getIntentSenderLocked(</span><br><span class=\"line\">                    ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage, callingFeatureId,</span><br><span class=\"line\">                    callingUid, userId, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, <span class=\"number\">0</span>, <span class=\"keyword\">new</span> Intent[]&#123;intent&#125;,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[]&#123;resolvedType&#125;, PendingIntent.FLAG_CANCEL_CURRENT</span><br><span class=\"line\">                            | PendingIntent.FLAG_ONE_SHOT, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            Intent newIntent = <span class=\"keyword\">new</span> Intent(Intent.ACTION_REVIEW_PERMISSIONS);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">int</span> flags = intent.getFlags();</span><br><span class=\"line\">            flags |= Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è®¾ç½®å¯åŠ¨æ ‡è¯†ï¼Œä»…è®¾ç½® NEW_TASK æŸäº›åœºæ™¯ä¸ä¸€å®šä¼šçœŸçš„åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œä½†å¯ä»¥ç½®ä¸º MULTIPLE_TASK</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((flags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_NEW_DOCUMENT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                flags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            newIntent.setFlags(flags);</span><br><span class=\"line\"></span><br><span class=\"line\">            newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName);</span><br><span class=\"line\">            newIntent.putExtra(Intent.EXTRA_INTENT, <span class=\"keyword\">new</span> IntentSender(target));</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (resultRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            intent = newIntent;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ä¸€å †æ•°æ®è§£æå’Œèµ‹å€¼å°±ä¸çœ‹äº†</span></span><br><span class=\"line\">            intentGrants = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            resolvedType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            callingUid = realCallingUid;</span><br><span class=\"line\">            callingPid = realCallingPid;</span><br><span class=\"line\">            rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, <span class=\"number\">0</span>,</span><br><span class=\"line\">                    computeResolveFilterUid(</span><br><span class=\"line\">                            callingUid, realCallingUid, request.filterCallingUid));</span><br><span class=\"line\">            aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags,</span><br><span class=\"line\">                    <span class=\"keyword\">null</span> <span class=\"comment\">/*profilerInfo*/</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rInfo != <span class=\"keyword\">null</span> &amp;&amp; rInfo.auxiliaryInfo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ä¸‡äº‹ä¿±å¤‡ï¼Œå‡†å¤‡å¾…å‘ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥å¯åŠ¨çš„ intent ï¼ˆä¹Ÿå°±æ˜¯å¯åŠ¨æ•°æ®æ¯ä¸ªå¿…è¦çš„ä¸å¯å°‘ï¼‰</span></span><br><span class=\"line\">        <span class=\"comment\">//åº”è¯¥æ˜¯æœ‰ç‰¹åˆ«ä¹‹å¤„çš„ï¼Œä¸ç„¶ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„ intentï¼Œå…·ä½“å°±ä¸çº ç»“äº†</span></span><br><span class=\"line\">        intent = createLaunchIntent(rInfo.auxiliaryInfo, request.ephemeralIntent,</span><br><span class=\"line\">                callingPackage, callingFeatureId, verificationBundle, resolvedType, userId);</span><br><span class=\"line\">        resolvedType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        callingUid = realCallingUid;</span><br><span class=\"line\">        callingPid = realCallingPid;</span><br><span class=\"line\">        intentGrants = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, <span class=\"keyword\">null</span> <span class=\"comment\">/*profilerInfo*/</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ¯ä¸€ä¸ª activity çš„ä¿¡æ¯éƒ½å°†è®°å½•åœ¨ ActivityRecord ä¸­</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityRecord r = <span class=\"keyword\">new</span> ActivityRecord.Builder(mService)</span><br><span class=\"line\">            .setCaller(callerApp)</span><br><span class=\"line\">            .setLaunchedFromPid(callingPid)</span><br><span class=\"line\">            .setLaunchedFromUid(callingUid)</span><br><span class=\"line\">            .setLaunchedFromPackage(callingPackage)</span><br><span class=\"line\">            .setLaunchedFromFeature(callingFeatureId)</span><br><span class=\"line\">            .setIntent(intent)</span><br><span class=\"line\">            .setResolvedType(resolvedType)</span><br><span class=\"line\">            .setActivityInfo(aInfo)</span><br><span class=\"line\">            .setConfiguration(mService.getGlobalConfiguration())</span><br><span class=\"line\">            .setResultTo(resultRecord)</span><br><span class=\"line\">            .setResultWho(resultWho)</span><br><span class=\"line\">            .setRequestCode(requestCode)</span><br><span class=\"line\">            .setComponentSpecified(request.componentSpecified)</span><br><span class=\"line\">            .setRootVoiceInteraction(voiceSession != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            .setActivityOptions(checkedOptions)</span><br><span class=\"line\">            .setSourceRecord(sourceRecord)</span><br><span class=\"line\">            .build();</span><br><span class=\"line\"></span><br><span class=\"line\">    mLastStartActivityRecord = r;</span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¥½äº†ï¼Œåˆåˆ°ä¸‹ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ</span></span><br><span class=\"line\">    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class=\"line\">            request.voiceInteractor, startFlags, <span class=\"keyword\">true</span> <span class=\"comment\">/* doResume */</span>, checkedOptions,</span><br><span class=\"line\">            inTask, inTaskFragment, restrictedBgActivity, intentGrants);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (request.outActivity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        request.outActivity[<span class=\"number\">0</span>] = mLastStartActivityRecord;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mLastStartActivityResult;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkStartAnyActivityPremission\">checkStartAnyActivityPremission</h2>\n<p>ä»»ä½•ä¸€ä¸ª activity å¯åŠ¨éƒ½éœ€è¦æ£€æŸ¥æƒé™é—®é¢˜ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivitTaskSupervisor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">checkStartAnyActivityPermission</span><span class=\"params\">(Intent intent, ActivityInfo aInfo, String resultWho,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> requestCode, <span class=\"keyword\">int</span> callingPid, <span class=\"keyword\">int</span> callingUid, String callingPackage,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> String callingFeatureId, <span class=\"keyword\">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> launchingInTask, WindowProcessController callerApp, ActivityRecord resultRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        Task resultRootTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//0ã€âœ…å¦‚æœæ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç»„ä»¶ å¹¶ä¸” æ˜¯å½“å‰æ ˆä¸­è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallerRecents = mService.getRecentTasks() != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; mService.getRecentTasks().isCallerRecents(callingUid);</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€âœ…å¦‚æœæ˜¯å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™çš„åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.ROOT_UID</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.SYSTEM_UID</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€âŒå¦‚æœæ˜¯ä¸åŒè¿›ç¨‹æ˜¯ä¸å…è®¸çš„ UserHandle.isIsolated(uid)</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€âœ…å¦‚æœæ˜¯è®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ UserHandle.isSameApp(uid, owningUid)</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€âŒå¦‚æœç›®æ ‡ activity exported=false æ˜¯ä¸è¢«å…è®¸å¯åŠ¨çš„</span></span><br><span class=\"line\"><span class=\"comment\">        6ã€âŒå¦‚æœæ£€æŸ¥çš„æƒé™å­˜åœ¨ â€˜ç¦æ­¢æƒé™åˆ—è¡¨â€™ä¸­æ˜¯ä¸è¢«å…è®¸çš„  [è‡³äºåˆ—è¡¨ä¸­éƒ½æœ‰å“ªäº›æƒé™æˆ‘ä»¬ä»¥åè®¨è®º]</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> startAnyPerm = mService.checkPermission(START_ANY_ACTIVITY, callingPid,</span><br><span class=\"line\">            callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (startAnyPerm == PERMISSION_GRANTED || (isCallerRecents &amp;&amp; launchingInTask)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒcomponent é™åˆ¶ ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkComponentPermissionã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> componentRestriction = getComponentRestrictionForCallingPackage(aInfo,</span><br><span class=\"line\">            callingPackage, callingFeatureId, callingPid, callingUid, ignoreTargetSecurity);</span><br><span class=\"line\">    <span class=\"comment\">//âŒaction é™åˆ¶  ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkPermissionã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> actionRestriction = getActionRestrictionForCallingPackage(</span><br><span class=\"line\">            intent.getAction(), callingPackage, callingFeatureId, callingPid, callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION</span><br><span class=\"line\">            || actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            resultRecord.sendResult(INVALID_UID, resultWho, requestCode,</span><br><span class=\"line\">                    Activity.RESULT_CANCELED, <span class=\"keyword\">null</span> <span class=\"comment\">/* data */</span>, <span class=\"keyword\">null</span> <span class=\"comment\">/* dataGrants */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SecurityException(msg);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (actionRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (componentRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkIntent\">checkIntent</h2>\n<p>mService.mIntentFirewall.checkStartActivity æœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ intent è¿‡æ»¤ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//IntentFirewall.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkIntent</span><span class=\"params\">(FirewallIntentResolver resolver, ComponentName resolvedComponent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> intentType, Intent intent, <span class=\"keyword\">int</span> callerUid, <span class=\"keyword\">int</span> callerPid, String resolvedType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> receivingUid)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> log = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> block = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;Rule&gt; candidateRules;</span><br><span class=\"line\">    candidateRules = resolver.queryIntent(intent, resolvedType, <span class=\"keyword\">false</span> <span class=\"comment\">/*defaultOnly*/</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (candidateRules == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        candidateRules = <span class=\"keyword\">new</span> ArrayList&lt;Rule&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resolver.queryByComponent(resolvedComponent, candidateRules);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;candidateRules.size(); i++) &#123;</span><br><span class=\"line\">        Rule rule = candidateRules.get(i);</span><br><span class=\"line\">        <span class=\"comment\">//intent è¿‡æ»¤è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œè§„åˆ™æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼Ÿä¸æ‡‚â€”â€”â€”â€”ç•¥ï¼</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rule.matches(<span class=\"keyword\">this</span>, resolvedComponent, intent, callerUid, callerPid, resolvedType,</span><br><span class=\"line\">                receivingUid)) &#123;</span><br><span class=\"line\">            block |= rule.getBlock();</span><br><span class=\"line\">            log |= rule.getLog();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (block &amp;&amp; log) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (log) &#123;</span><br><span class=\"line\">        logIntent(intentType, intent, callerUid, resolvedType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> !block;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkStartActivity\">checkStartActivity</h2>\n<p>PermissionPolicyInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PermissionPolicyService çš„ä¸€ä¸ªå†…éƒ¨ç±» <code>private class Internal extends PermissionPolicyInternal </code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//PermissionPolicyService.java</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Internal</span> <span class=\"keyword\">extends</span> <span class=\"title\">PermissionPolicyInternal</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkStartActivity</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent, <span class=\"keyword\">int</span> callingUid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            <span class=\"meta\">@Nullable</span> String callingPackage)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callingPackage != <span class=\"keyword\">null</span> &amp;&amp; isActionRemovedForCallingPackage(intent, callingUid,</span><br><span class=\"line\">                callingPackage)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//PermissionPolicyService.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isActionRemovedForCallingPackage</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent, <span class=\"keyword\">int</span> callingUid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> String callingPackage)</span> </span>&#123;</span><br><span class=\"line\">    String action = intent.getAction();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (action == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (action) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> TelecomManager.ACTION_CHANGE_DEFAULT_DIALER:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT: &#123;</span><br><span class=\"line\">            ApplicationInfo applicationInfo;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                applicationInfo = getContext().getPackageManager().getApplicationInfoAsUser(</span><br><span class=\"line\">                        callingPackage, <span class=\"number\">0</span>, UserHandle.getUserId(callingUid));</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//åªæœ‰é«˜ç‰ˆæœ¬æ‰ä¼šæ£€æŸ¥è¿™ä¸ªé—®é¢˜å’¯</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">            intent.putExtra(Intent.EXTRA_CALLING_PACKAGE, callingPackage);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"shouldAbortBackgroundActivityStart\">shouldAbortBackgroundActivityStart</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">shouldAbortBackgroundActivityStart</span><span class=\"params\">(<span class=\"keyword\">int</span> callingUid, <span class=\"keyword\">int</span> callingPid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">final</span> String callingPackage, <span class=\"keyword\">int</span> realCallingUid, <span class=\"keyword\">int</span> realCallingPid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        WindowProcessController callerApp, PendingIntentRecord originatingPendingIntent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowBackgroundActivityStart, Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//1ã€âœ…ç³»ç»Ÿç”¨æˆ·åº”ç”¨ã€å…·æœ‰ Root æƒé™çš„åº”ç”¨ã€NFC ï¼ˆä¸€èˆ¬æ˜¯ä¼´ç”Ÿè®¾å¤‡ï¼‰åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingAppId = UserHandle.getAppId(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callingUid == Process.ROOT_UID || callingAppId == Process.SYSTEM_UID</span><br><span class=\"line\">            || callingAppId == Process.NFC_UID) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//2ã€âœ…å¦‚æœæ˜¯æ¡Œé¢ç¨‹åºå¯åŠ¨æ˜¯å…è®¸çš„  [æ­£å¸¸ç”¨æˆ·æ“ä½œä¸å°±æ˜¯ç‚¹å‡»æ¡Œé¢åº”ç”¨å›¾æ ‡ç„¶åå¯åŠ¨çš„å˜›]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isHomeApp(callingUid, callingPackage)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//3ã€âœ…è®¾å¤‡æ‰€æœ‰è€…æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> WindowState imeWindow = mRootWindowContainer.getCurrentInputMethodWindow();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (imeWindow != <span class=\"keyword\">null</span> &amp;&amp; callingAppId == imeWindow.mOwnerUid) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//4ã€âœ…å¦‚æœæœ‰å‰å°åº”ç”¨æˆ–å¯è§ç•Œé¢å­˜åœ¨å‰å°ï¼Œè¿™ä¹Ÿæ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> appSwitchState = mService.getBalAppSwitchesState();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingUidProcState = mService.mActiveUids.getUidState(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> callingUidHasAnyVisibleWindow = mService.hasActiveVisibleWindow(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallingUidForeground = callingUidHasAnyVisibleWindow</span><br><span class=\"line\">            || callingUidProcState == ActivityManager.PROCESS_STATE_TOP</span><br><span class=\"line\">            || callingUidProcState == ActivityManager.PROCESS_STATE_BOUND_TOP;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallingUidPersistentSystemProcess =</span><br><span class=\"line\">            callingUidProcState &lt;= ActivityManager.PROCESS_STATE_PERSISTENT_UI;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//5ã€âœ…åœ¨åº”ç”¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> appSwitchAllowedOrFg =</span><br><span class=\"line\">            appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((appSwitchAllowedOrFg || mService.mActiveUids.hasNonAppVisibleWindow(callingUid))</span><br><span class=\"line\">            &amp;&amp; callingUidHasAnyVisibleWindow)</span><br><span class=\"line\">            || isCallingUidPersistentSystemProcess) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> realCallingUidProcState = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? callingUidProcState</span><br><span class=\"line\">            : mService.mActiveUids.getUidState(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> realCallingUidHasAnyVisibleWindow = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? callingUidHasAnyVisibleWindow</span><br><span class=\"line\">            : mService.hasActiveVisibleWindow(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isRealCallingUidForeground = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? isCallingUidForeground</span><br><span class=\"line\">            : realCallingUidHasAnyVisibleWindow</span><br><span class=\"line\">                    || realCallingUidProcState == ActivityManager.PROCESS_STATE_TOP;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> realCallingAppId = UserHandle.getAppId(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isRealCallingUidPersistentSystemProcess = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? isCallingUidPersistentSystemProcess</span><br><span class=\"line\">            : (realCallingAppId == Process.SYSTEM_UID)</span><br><span class=\"line\">                    || realCallingUidProcState &lt;= ActivityManager.PROCESS_STATE_PERSISTENT_UI;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (realCallingUid != callingUid) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//6ã€âœ…å¦‚æœè°ƒç”¨çš„è¿›ç¨‹æœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (realCallingUidHasAnyVisibleWindow) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (DEBUG_ACTIVITY_STARTS) &#123;</span><br><span class=\"line\">                Slog.d(TAG, <span class=\"string\">&quot;Activity start allowed: realCallingUid (&quot;</span> + realCallingUid</span><br><span class=\"line\">                        + <span class=\"string\">&quot;) has visible (non-toast) window&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//7ã€âœ…å¦‚æœæ˜¯â€˜ç³»ç»ŸæŒä¹…åº”ç”¨â€™å‘èµ·çš„è¯·æ±‚æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isRealCallingUidPersistentSystemProcess &amp;&amp; allowBackgroundActivityStart) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//8ã€âœ…å¦‚æœå­˜åœ¨ä¼´ç”Ÿè®¾å¤‡æˆ–è€…ç›¸å…³å¯è§åº”ç”¨è¿›ç¨‹æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.isAssociatedCompanionApp(UserHandle.getUserId(realCallingUid),</span><br><span class=\"line\">                realCallingUid)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//9ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ START_ACTIVITIES_FROM_BACKGROUND æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.checkPermission(START_ACTIVITIES_FROM_BACKGROUND, callingPid, callingUid)</span><br><span class=\"line\">            == PERMISSION_GRANTED) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//10ã€âœ…å¦‚æœæœ€è¿‘å­˜åœ¨ç›¸åŒ uid è¿›ç¨‹å¯åŠ¨ç›¸å…³ç»„ä»¶æ˜¯å…è®¸çš„ï¼ˆåŒä¸€ä¸ªåº”ç”¨ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mSupervisor.mRecentTasks.isCallerRecents(callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//11ã€âœ…å¯¹äºè®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isDeviceOwner(callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//12ã€âœ…å¯¹äºä¼´ç”Ÿè®¾å¤‡çš„è¯·æ±‚æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingUserId = UserHandle.getUserId(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isAssociatedCompanionApp(callingUserId, callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//13ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ SYSTEM_ALERT_WINDOW æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.hasSystemAlertWindowPermission(callingUid, callingPid, callingPackage)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> callerAppUid = callingUid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callerApp == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        callerApp = mService.getProcessController(realCallingPid, realCallingUid);</span><br><span class=\"line\">        callerAppUid = realCallingUid;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callerApp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸æ¥åˆ°äº†æ–°çš„å¯åŠ¨æ§åˆ¶ç±»ï¼šBackgroundLaunchProcessController#areBackgroundActivityStartsAllowed</span></span><br><span class=\"line\">        <span class=\"comment\">//å‚è€ƒä¸‹æ–‡</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callerApp.areBackgroundActivityStartsAllowed(appSwitchState)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> ArraySet&lt;WindowProcessController&gt; uidProcesses =</span><br><span class=\"line\">                mService.mProcessMap.getProcesses(callerAppUid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (uidProcesses != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = uidProcesses.size() - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">final</span> WindowProcessController proc = uidProcesses.valueAt(i);</span><br><span class=\"line\">                <span class=\"comment\">//å‚çœ‹ä¸‹æ–‡</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (proc != callerApp</span><br><span class=\"line\">                        &amp;&amp; proc.areBackgroundActivityStartsAllowed(appSwitchState)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"areBackgroundActivityStartsAllowed\">areBackgroundActivityStartsAllowed</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//BackgroundLaunchProcessController.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">areBackgroundActivityStartsAllowed</span><span class=\"params\">(<span class=\"keyword\">int</span> pid, <span class=\"keyword\">int</span> uid, String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> appSwitchState, <span class=\"keyword\">boolean</span> isCheckingForFgsStart,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> hasActivityInVisibleTask, <span class=\"keyword\">boolean</span> hasBackgroundActivityStartPrivileges,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> lastStopAppSwitchesTime, <span class=\"keyword\">long</span> lastActivityLaunchTime,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> lastActivityFinishTime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (appSwitchState == APP_SWITCH_ALLOW) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = SystemClock.uptimeMillis();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now - lastActivityLaunchTime &lt; ACTIVITY_BG_START_GRACE_PERIOD_MS</span><br><span class=\"line\">                || now - lastActivityFinishTime &lt; ACTIVITY_BG_START_GRACE_PERIOD_MS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (lastActivityLaunchTime &gt; lastStopAppSwitchesTime</span><br><span class=\"line\">                    || lastActivityFinishTime &gt; lastStopAppSwitchesTime) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasBackgroundActivityStartPrivileges) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasActivityInVisibleTask</span><br><span class=\"line\">            &amp;&amp; (appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isBoundByForegroundUid()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isBackgroundStartAllowedByToken(uid, packageName, isCheckingForFgsStart)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityUnchecked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">startActivityUnchecked</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>Reference</h1>\n<ul>\n<li>è¾“å…¥æ³•æ§ä»¶ IMEï¼š<a href=\"https://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn\">https://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn</a></li>\n<li><a href=\"https://baike.baidu.com/item/%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B/16751450#:~:text=%E5%9C%A8%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%A2%86%E5%9F%9F%E4%B8%AD%EF%BC%8C%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%E6%8C%87%E7%9A%84%E6%98%AF%E5%9C%A8%E5%85%B6%E7%88%B6%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E6%88%96%E8%A2%AB%E7%BB%88%E6%AD%A2%E5%90%8E%E4%BB%8D%E7%BB%A7%E7%BB%AD%E8%BF%90%E8%A1%8C%E7%9A%84%E4%B8%80%E7%B1%BB%E8%BF%9B%E7%A8%8B%E3%80%82,%E8%BF%99%E4%BA%9B%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%E5%B0%86%E8%A2%ABinit%E8%BF%9B%E7%A8%8B%20%28%E8%BF%9B%E7%A8%8B%E5%8F%B7%E4%B8%BA1%29%E6%89%80%E6%94%B6%E5%85%BB%EF%BC%8C%E5%B9%B6%E7%94%B1init%E8%BF%9B%E7%A8%8B%E5%AF%B9%E5%AE%83%E4%BB%AC%E5%AE%8C%E6%88%90%E7%8A%B6%E6%80%81%E6%94%B6%E9%9B%86%E5%B7%A5%E4%BD%9C%E3%80%82\"> å…³äºå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹çš„æ¦‚å¿µ </a></li>\n<li><a href=\"https://www.cnblogs.com/perseus/articles/2354173.html\"> å…³äº UIDã€PID çš„äº†è§£</a></li>\n<li><a href=\"https://developer.android.google.cn/guide/topics/text/autofill?hl=zh-cn\">AutofillManager å‚è€ƒé“¾æ¥ [1]</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>Ready go</h1>\n<p>åœ¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œä¸Šä¸€ç« æˆ‘ä»¬å¯¹ <code>package</code> ç›®å½•ä¸‹çš„å†…å®¹æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæˆ‘ä»¬çŸ¥é“è®¾å¤‡ä¸Šçš„æ¡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ª<code>ç³»ç»Ÿåº”ç”¨</code>ï¼ŒAOSP åŸç”Ÿæœ‰æä¾›ï¼Œä½†æ˜¯å‚å•†å®šåˆ¶çš„ ROM å¾€å¾€ä¼šè‡ªå·±é‡å†™æˆ–é‡æ–°å®ç°ï¼Œæ‰©å±•åŠŸèƒ½ï¼›é‚£ä¹ˆç»§ç»­ Android ç³»ç»Ÿå¯åŠ¨æ€è€ƒå¾€ä¸‹èµ°ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥çœ‹çœ‹æ‰‹æœºæ¡Œé¢æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„â€”â€”â€”æ¡Œé¢ç¨‹åºæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ</p>\n<p>è™½ç„¶æˆ‘ä»¬çŸ¥é“æ¡Œé¢ç¨‹åºæ˜¯<code>Launcher</code>ï¼Œä½†æ˜¯æˆ‘ä»¬ä½œä¸ºåˆšé˜…è¯»æºç çš„å°ç™½ï¼Œ<strong>å¦‚ä½•åœ¨æºç ä¸­å¿«é€Ÿæ‰¾åˆ°æ¡Œé¢ç¨‹åºå¯åŠ¨çš„å…¥å£ï¼Ÿ</strong> è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ€è€ƒçš„é—®é¢˜ï¼Œ å½“ç„¶ï¼Œç«™åœ¨â€˜å·¨äººçš„è‚©è†€â€™ç›´æ¥ä½¿ç”¨ç™¾åº¦ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†è¿™é‡Œæˆ‘æƒ³åˆ°å¦å¤–ä¸€ç§æ–¹å¼â€”â€”â€”â€”<code>æ— éšœç¢æœåŠ¡ Accessebility</code>ï¼›åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæ— éšœç¢æœåŠ¡é™¤äº†æ»¡è¶³é¡¹ç›®éœ€æ±‚åº”ç”¨äºé¡¹ç›®ä¸­å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨è¯¥æœåŠ¡ä½œä¸ºæˆ‘ä»¬çš„è¾…åŠ©å·¥å…·ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä¸ªäººæœ€å¸¸ç”¨çš„å°±æ˜¯<code>æŸ¥çœ‹ç³»ç»Ÿå½“å‰æœ€é¡¶éƒ¨æ˜¾ç¤ºçš„ activity</code>ã€‚ä½œä¸ºè¾…åŠ©æ‰‹æ®µï¼Œæ—©å·²æœ‰æˆç†Ÿçš„è½¯ä»¶å·¥å…·ï¼Œè¿™é‡Œæ¨èä¸¤ä¸ªå·¥å…·ã€‚</p>\n<ul>\n<li>å¼€å‘è€…åŠ©æ‰‹</li>\n<li>Android å¼€å‘å·¥å…·ç®±</li>\n<li>MT æ–‡ä»¶ç®¡ç†å™¨</li>\n</ul>\n<h1>systemReady</h1>\n<p>æˆ‘ä»¬çŸ¥é“ï¼ŒSystemServer åœ¨è¢«è°ƒç”¨æ—¶å…ˆæ‰§è¡Œ <code>main</code> å‡½æ•°ï¼Œç´§æ¥ç€æ‰§è¡Œå½“å‰ç±»çš„é™æ€æ–¹æ³• <code>run</code>ï¼Œç„¶ååˆ†ä¸‰ä¸ªé˜¶æ®µå¯åŠ¨ <code>å¯åŠ¨æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡</code>ï¼Œæœ€åè¿›å…¥ <code>Looper().loop</code> å¾ªç¯å¿˜ä¸åœæ­‡çš„ <s>æ‰“å·¥</s> ç­‰å¾…æ¶ˆæ¯åˆ°æ¥å¹¶å¤„ç†ã€‚å¯åŠ¨æœåŠ¡æ˜¯ä¸€éƒ¨åˆ†ï¼Œéš¾é“ä¸åšç‚¹åˆ«çš„å—ï¼Ÿåˆšå¥½åœ¨å¯åŠ¨ <strong>å…¶ä»–æœåŠ¡</strong> è¿™é‡Œçœ‹åˆ°è¿™ä¸€æ®µæ³¨é‡Šï¼š</p>\n<figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// We now tell the activity manager it is okay to run third party</span></span><br><span class=\"line\"><span class=\"comment\">// code.  It will call back into us once it has gotten to the state</span></span><br><span class=\"line\"><span class=\"comment\">// where third party code can really run (but before it has actually</span></span><br><span class=\"line\"><span class=\"comment\">// started launching the initial applications), for us to complete our</span></span><br><span class=\"line\"><span class=\"comment\">// initialization.</span></span><br><span class=\"line\"></span><br><span class=\"line\">SystemServerï¼šAMS ä½ æ‰€éœ€çš„ä¸€äº›æœåŠ¡å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨äº†ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œæ”¶åˆ°è¯·å›ç­”ï¼Œ<span class=\"built_in\">over</span>ï¼<span class=\"built_in\">over</span>ï¼</span><br><span class=\"line\"></span><br><span class=\"line\">AMSï¼šæ”¶åˆ°ï¼æ”¶åˆ°ï¼çœ‹æˆ‘å›è°ƒè¡Œäº‹ï¼Œ<span class=\"built_in\">over</span>ï¼</span><br></pre></td></tr></table></figure>\n<p>å…ˆæ˜¯ AMS systemReady è¿›å…¥å‡†å¤‡é˜¶æ®µ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityManagerService.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">systemReady</span><span class=\"params\">(<span class=\"keyword\">final</span> Runnable goingCallback, <span class=\"meta\">@NonNull</span> TimingsTraceAndSlog t)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€ç®¡ç† activity çš„ä»»åŠ¡æ ˆã€è¿™ç§å†…å®¹å¤ªç»†äº†ï¼Œä»¥åé€ä¸ªçœ‹çœ‹ï¼Œå…ˆç•¥è¿‡ã€‘</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€åŒ…å« RecentTasks æœ€è¿‘è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mActivityTaskManager.onSystemReady();</span><br><span class=\"line\">    mUserController.onSystemReady();</span><br><span class=\"line\">    <span class=\"comment\">//è®¿é—®æ§åˆ¶ï¼Œä¸»è¦ä¸æƒé™ã€é™åˆ¶ç›¸å…³</span></span><br><span class=\"line\">    mAppOpsService.systemReady();</span><br><span class=\"line\">    mProcessList.onSystemReady();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¦‚æœè¿›ç¨‹æˆ–è¿›ç¨‹ç»„è¢«æ ‡è®°ä¸ºæ€æ­»ï¼Œå°†è°ƒç”¨ Process.killProcessQuiet(mPid);ProcessList.killProcessGroup(uid, mPid);æ€æ­»è¿›ç¨‹ï¼Œä¸ºå¯åŠ¨æ–°è¿›ç¨‹åšå‡†å¤‡</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å½“ç„¶ï¼Œè¿›ç¨‹ä¹Ÿå¯èƒ½è¢«æ ‡è®°ä¸ºé‡å¯ï¼Œä¾¿ä¸ä¼šä»è¿›ç¨‹é˜Ÿåˆ—ä¸­ç§»é™¤       </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mProcessList.removeProcessLocked</span><br><span class=\"line\">    <span class=\"comment\">//æ³¨å†Œå¯åŠ¨ç›‘å¬ï¼ŒATMï¼šactivitTaskManager</span></span><br><span class=\"line\">    mAtmInternal.getLaunchObserverRegistry().registerLaunchObserver(mActivityLaunchObserver);</span><br><span class=\"line\">    <span class=\"comment\">//UGMï¼šuri global managerï¼Œuri ä½œä¸ºæ•°æ®è®¿é—®åœ°å€ã€æ•°æ®ä¼ é€’ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„</span></span><br><span class=\"line\">    mUgmInternal.onSystemReady();</span><br><span class=\"line\">    <span class=\"comment\">//pmiï¼špower manager internalï¼Œä½ç”µé‡ç›‘æ§</span></span><br><span class=\"line\">    pmi.registerLowPowerModeObserver</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//ğŸ˜“æ‰§è¡Œåˆ°ä¸€åŠå°±è¿”å›å»æ‰§è¡Œå›è°ƒã€è¯·å‚è€ƒ â€”â€” å›è°ƒ1ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (goingCallback != <span class=\"keyword\">null</span>) goingCallback.run();</span><br><span class=\"line\">        </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¯åŠ¨æŒä¹…åº”ç”¨ï¼ˆä¸ä¼šä¼‘çœ çš„ã€å¯åŠ¨å”¤é†’ç¨‹åºï¼‰ï¼Œå¾…å¯åŠ¨çš„æ˜¯å“ªäº›åº”ç”¨ï¼Œåˆæ¥åˆ°äº† IPackageManager.aidl çš„ getPersistentApplicationsï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">           å®ç°ç±»æ˜¯ PackageManagerService.java</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€getPersistentApplications å®é™…ä¸Šè·å–åˆ°çš„æ˜¯ä¸€ä¸ª ApplicationInfo åˆ—è¡¨</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€é€šè¿‡ applicationInfo åˆ›å»º processRecorderï¼Œæ¥ç€é€šè¿‡ ProcessList ä¸€é¡¿åˆ¤æ–­ã€è°ƒæ•´ processRecorder</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€æœ€åå¯èƒ½é€šè¿‡ wzygote æˆ– Process.start å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ActivityTaskManagerInternal.java å®ç°ç±»åœ¨ ActivityManagerService çš„ä¸€ä¸ªå†…éƒ¨ç±» LocalServiceï¼›</span></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¯åŠ¨æ¡Œé¢ç¨‹åº</span></span><br><span class=\"line\">    mAtmInternal.startHomeOnAllDisplays(currentUserId, <span class=\"string\">&quot;systemReady&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    mAtmInternal.resumeTopActivities(<span class=\"keyword\">false</span> <span class=\"comment\">/* scheduleIdle */</span>);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>AMS å‡†å¤‡å®Œæ¯•ï¼Œè¯·æ±‚ SystemServer è¶…çº§ç®¡å®¶æ‰§è¡Œå›è°ƒ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//SystemServer.java ã€å›è°ƒ1ã€‘</span></span><br><span class=\"line\">mActivityManagerService.systemReady(() -&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//service.onBootPhase(mCurrentPhase=500); ç³»ç»ŸæœåŠ¡é‚£ä¹ˆå¤šåˆ°åº•è°åœ¨æ‰§è¡Œ 500 è¿™ä¸ªæ ‡è®°ï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œå›è°ƒå‘ŠçŸ¥å…¶ä»–æœåŠ¡ AMS å¯åŠ¨äº†ï¼Œä½ ä»¬å¯ä»¥ä½¿ç”¨ AMS åšåˆ«çš„äº‹æƒ…</span></span><br><span class=\"line\">    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//AMS éœ€è¦ç›‘æ§ native å´©æºƒï¼Œé‡Œé¢å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ Threadï¼Œå†…éƒ¨ä½¿ç”¨é˜»å¡çš„ socket æ¥æ”¶å´©æºƒä¿¡æ¯å¹¶è¿”å›ç»™ä¸Šå±‚æˆ–è¾“å‡º</span></span><br><span class=\"line\">    mActivityManagerService.startObservingNativeCrashes();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//çœ‹åˆ° ops å¾€å¾€æ˜¯è·Ÿé™åˆ¶ç­–ç•¥æœ‰å…³ğŸš«</span></span><br><span class=\"line\">    mActivityManagerService.setAppOpsPolicy(<span class=\"keyword\">new</span> AppOpsPolicy(mSystemContext));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Wait for all packages to be prepared</span></span><br><span class=\"line\">    mPackageManagerService.waitForAppDataPrepared();</span><br><span class=\"line\">    <span class=\"comment\">//ç¬¬ä¸‰æ–¹åº”ç”¨å‡†å¤‡å¥½äº†ï¼Œåˆå‘èµ·ä¸€ä¸ªå¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„å›è°ƒï¼Œè®©å„è‡ªå®ç°æ­¤çŠ¶æ€ç çš„æœåŠ¡æ‰§è¡Œç›¸åº”æ“ä½œã€è§å›¾1ã€‘</span></span><br><span class=\"line\">    mSystemServiceManager.startBootPhase(t, SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class=\"line\"></span><br><span class=\"line\">    ... etc</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//åˆ°è¿™é‡Œæˆ‘ä»¬ç®—æ˜¯å›è°ƒæ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬åˆè¦å›åˆ° systemReady é‡Œé¢å»ï¼Œç»§ç»­çœ‹æ‰§è¡Œ goingCallback.run(); ä¹‹åçš„ä»£ç </span></span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;, t);</span><br></pre></td></tr></table></figure>\n<h1>startHomeOnAllDisplays</h1>\n<p>æˆ‘ä»¬æƒ³çŸ¥é“ startHomeOnAllDisplays çš„å…·ä½“å®ç°åœ¨å“ªé‡Œï¼Ÿæœ‰è°æ‰§è¡Œçš„ï¼Ÿä¸å¦¨æ‰¾æ‰¾çœ‹ã€‚</p>\n<ul>\n<li>ActivityManagerService#mAtmInternal.startHomeOnAllDisplays(currentUserId, â€œsystemReadyâ€); <code>AMS ä¸­è°ƒç”¨</code></li>\n<li>ActivityTaskManagerInternal#startHomeOnAllDisplays   <code>è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»çš„æŠ½è±¡æ–¹æ³•</code></li>\n<li>ActivityTaskManagerService#LocalService            <code>å®ç°ç±»æ˜¯ ATMS çš„å†…éƒ¨ç±»</code></li>\n<li>ActivityTaskManagerService#mInternal; <code>å®ç°ç±»å®ä¾‹èµ‹ç»™äº† ATMS çš„æˆå‘˜</code></li>\n<li>ActivityTaskManagerService#LocalServices.addService(ActivityTaskManagerInternal.class, mInternal); <code>åœ¨ ATMS å¯åŠ¨å‘¨æœŸ onStart ä¸­è¢«ç¼“å­˜åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨</code></li>\n<li>com.android.server#private static final ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects <code>æœ¬åœ°æœåŠ¡åˆ—è¡¨å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ•°ç»„</code></li>\n<li>ActivityTaskManagerService#mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class); <code>ä»æœ¬åœ°æœåŠ¡ç¼“å­˜åˆ—è¡¨ä¸­è·å–å®ä¾‹èµ‹ç»™ ATMS</code></li>\n</ul>\n<p>äº†è§£äº†ï¼Œç›´æ¥æ‰¾å®ç°ç±» <code>LocalService</code>ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityTaskManagerService.java#LocalService</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnAllDisplays</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (mGlobalLock) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mRootWindowContainer.startHomeOnAllDisplays(userId, reason);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnAllDisplays</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ¡Œé¢ä¸»ç•Œé¢æ˜¯å¦å¯åŠ¨å®Œæ¯•</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> homeStarted = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œçš„å¾ªç¯è¡¨ç¤ºå¯¹åº” AllDisplaysï¼Œè®¾å¤‡æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªæ˜¾ç¤ºå™¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = getChildCount() - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> displayId = getChildAt(i).mDisplayId;</span><br><span class=\"line\">        homeStarted |= startHomeOnDisplay(userId, reason, displayId);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> homeStarted;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnDisplay</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, <span class=\"keyword\">int</span> displayId)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> startHomeOnDisplay(userId, reason, displayId, <span class=\"keyword\">false</span> <span class=\"comment\">/* allowInstrumenting */</span>,</span><br><span class=\"line\">            <span class=\"keyword\">false</span> <span class=\"comment\">/* fromHomeKey */</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnDisplay</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, <span class=\"keyword\">int</span> displayId, <span class=\"keyword\">boolean</span> allowInstrumenting,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> fromHomeKey)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœé‡åˆ°æ— æ•ˆçš„æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æˆ–å·²è·å¾—ç„¦ç‚¹çš„æœ€é¡¶éƒ¨æ˜¾ç¤ºID</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (displayId == INVALID_DISPLAY) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task rootTask = getTopDisplayFocusedRootTask();</span><br><span class=\"line\">        displayId = rootTask != <span class=\"keyword\">null</span> ? rootTask.getDisplayId() : DEFAULT_DISPLAY;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> DisplayContent display = getDisplayContent(displayId);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> display.reduceOnAllTaskDisplayAreas((taskDisplayArea, result) -&gt;</span><br><span class=\"line\">                    result | startHomeOnTaskDisplayArea(userId, reason, taskDisplayArea,</span><br><span class=\"line\">                            allowInstrumenting, fromHomeKey),</span><br><span class=\"line\">            <span class=\"keyword\">false</span> <span class=\"comment\">/* initValue */</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//RootWindowContainer.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">startHomeOnTaskDisplayArea</span><span class=\"params\">(<span class=\"keyword\">int</span> userId, String reason, TaskDisplayArea taskDisplayArea,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowInstrumenting, <span class=\"keyword\">boolean</span> fromHomeKey)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœæä¾›çš„ç°å®åŒºåŸŸæ— æ•ˆï¼ŒåŒæ ·çš„æ¢å¤é»˜è®¤</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (taskDisplayArea == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task rootTask = getTopDisplayFocusedRootTask();</span><br><span class=\"line\">        taskDisplayArea = rootTask != <span class=\"keyword\">null</span> ? rootTask.getDisplayArea()</span><br><span class=\"line\">                : getDefaultTaskDisplayArea();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸é‡è¦çš„æ¥äº†ï¼Œæ¡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ª activityï¼Œå¯åŠ¨ä¸€ä¸ª activityï¼Œæœ€é‡è¦çš„ä¾¿æ˜¯å¯åŠ¨ç›®æ ‡ä¿¡æ¯</span></span><br><span class=\"line\">    Intent homeIntent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    ActivityInfo aInfo = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (taskDisplayArea == getDefaultTaskDisplayArea()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€mService æ˜¯ ActivityTaskManagerService</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€ã€é»˜è®¤ã€‘intent.addCategory(Intent.CATEGORY_HOME); mTopAction = Intent.ACTION_MAIN;</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        homeIntent = mService.getHomeIntent();</span><br><span class=\"line\">        aInfo = resolveHomeActivity(userId, homeIntent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (shouldPlaceSecondaryHomeOnDisplayArea(taskDisplayArea)) &#123;</span><br><span class=\"line\">        Pair&lt;ActivityInfo, Intent&gt; info = resolveSecondaryHomeActivity(userId, taskDisplayArea);</span><br><span class=\"line\">        aInfo = info.first;</span><br><span class=\"line\">        homeIntent = info.second;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (aInfo == <span class=\"keyword\">null</span> || homeIntent == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¾ç¤ºæ€»æ˜¯æœ‰ä¸€äº›æ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!canStartHomeOnDisplayArea(aInfo, taskDisplayArea, allowInstrumenting)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    homeIntent.setComponent(<span class=\"keyword\">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class=\"line\">    homeIntent.setFlags(homeIntent.getFlags() | FLAG_ACTIVITY_NEW_TASK);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fromHomeKey) &#123;</span><br><span class=\"line\">        homeIntent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mWindowManager.getRecentsAnimationController() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mWindowManager.getRecentsAnimationController().cancelAnimationForHomeStart();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    homeIntent.putExtra(WindowManagerPolicy.EXTRA_START_REASON, reason);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨ activity è¿˜å¾—çœ‹ activityStartController</span></span><br><span class=\"line\">    mService.getActivityStartController().startHomeActivity(homeIntent, aInfo, myReason,</span><br><span class=\"line\">            taskDisplayArea);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>activitStartController</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStartController.java</span></span><br><span class=\"line\"><span class=\"comment\">//âš ï¸ï¼šè¿™é‡Œå¯åŠ¨çš„æ˜¯ homeItent</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startHomeActivity</span><span class=\"params\">(Intent intent, ActivityInfo aInfo, String reason,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskDisplayArea taskDisplayArea)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ²¡æœ‰ä»»ä½•é™„åŠ å±æ€§ï¼Œæ¯”å¦‚æ²¡æœ‰ activity åŠ¨ç”»</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityOptions options = ActivityOptions.makeBasic();</span><br><span class=\"line\">    <span class=\"comment\">//å…¨å±çª—å£æ¨¡å¼</span></span><br><span class=\"line\">    options.setLaunchWindowingMode(WINDOWING_MODE_FULLSCREEN);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!ActivityRecord.isResolverActivity(aInfo.name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªæ¡Œé¢ activity </span></span><br><span class=\"line\">        options.setLaunchActivityType(ACTIVITY_TYPE_HOME);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¾ç¤ºè®¾å¤‡IDä¹ŸæŒ‡å®šï¼Œä¼¼ä¹ activity å¯åŠ¨éœ€è¦çš„å‚æ•°éƒ½å°†å°è£…åˆ° ActivitOptions </span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> displayId = taskDisplayArea.getDisplayId();</span><br><span class=\"line\">    options.setLaunchDisplayId(displayId);</span><br><span class=\"line\">    options.setLaunchTaskDisplayArea(taskDisplayArea.mRemoteToken</span><br><span class=\"line\">            .toWindowContainerToken());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åªæ˜¯ä¸€ä¸ªå˜é‡é€’å¢ mDeferResumeCount++ï¼Œè¿™å¦‚ä½•ä½¿ç”¨ </span></span><br><span class=\"line\">    mSupervisor.beginDeferResume();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task rootHomeTask;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€activity éœ€è¦ä¾èµ– task å®¹å™¨ï¼Œæ‰€ä»¥å¯åŠ¨å‰å¿…é¡»ç¡®ä¿ Task å·²åˆ›å»º</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€TaskDisplayArea#createRootTask éœ€æŒ‡å®š activityType=home_activityï¼Œontop=true åœ¨æ˜¾ç¤ºå™¨çš„é¡¶éƒ¨åˆ›å»º rootTask</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€æœ€ç»ˆåˆ›å»ºæ˜¯é€šè¿‡ Task.Builder()......build();  è‡³æ­¤ï¼Œå­˜å‚¨æ¡Œé¢ activity çš„ Task å·²ç»æœ‰äº†</span></span><br><span class=\"line\"><span class=\"comment\">            4ã€mRootWindowContainer è¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘ä»¬æ‰€è§åˆ°çš„ç•Œé¢éƒ½è¦ä¾é™„äºå®ƒ</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        rootHomeTask = taskDisplayArea.getOrCreateRootHomeTask(ON_TOP<span class=\"comment\">/*true*/</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//è¿™ä¸ªè·Ÿ mDeferResumeCount++ å¯¹åº”ï¼Œè¿™é‡Œæ˜¯ mDeferResumeCount--</span></span><br><span class=\"line\">        <span class=\"comment\">//å…³äºè¿™ä¸ªè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šreadyToResume() &#123;return mDeferResumeCount == 0;&#125; </span></span><br><span class=\"line\">        <span class=\"comment\">//true if resume can be calledï¼šé‚£ä¼°è®¡æ˜¯å“ªé‡Œè¿›è¡Œè½®è¯¢ç›‘å¬ readyToResume()</span></span><br><span class=\"line\">        mSupervisor.endDeferResume();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æœ‰äº†å¯æ‰¿è½½æ¡Œé¢ç¨‹åºçš„ä»»åŠ¡æ ˆï¼Œæ¥ç€å°±è¦å¯åŠ¨æ¡Œé¢ activity</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€è·å¾—ä¸€ä¸ª activity å¯åŠ¨å™¨ ActivitStarterï¼Œå¼€å§‹æ‰§è¡Œ excute()</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¯åŠ¨å™¨ä¼¼ä¹ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œé»˜è®¤å¯åŠ¨å™¨æ•°é‡ 3 ä¸ª</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€å¯åŠ¨å™¨ä¸»è¦æˆå‘˜æœ‰ ActivityStartControllerã€ActivityTaskManagerServiceã€ActivityTaskSupervisorã€ActivityStartInterceptor</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€åœ¨æ„å»ºè¯·æ±‚å™¨è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ„é€ å¯åŠ¨è¯·æ±‚å‚æ•° mRequest </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    mLastHomeActivityStartResult = obtainStarter(intent, <span class=\"string\">&quot;startHomeActivity: &quot;</span> + reason)</span><br><span class=\"line\">            .setOutActivity(tmpOutRecord)</span><br><span class=\"line\">            .setCallingUid(<span class=\"number\">0</span>)</span><br><span class=\"line\">            .setActivityInfo(aInfo)</span><br><span class=\"line\">            .setActivityOptions(options.toBundle())</span><br><span class=\"line\">            .execute();</span><br><span class=\"line\">    mLastHomeActivityStartRecord = tmpOutRecord[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rootHomeTask.mInResumeTopActivity) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å¼€å§‹è°ƒç”¨ onResume å£°æ˜å‘¨æœŸæ–¹æ³•ï¼Œå›åˆ° activity æœ€ç†Ÿæ‚‰çš„åœ°æ–¹</span></span><br><span class=\"line\">        mSupervisor.scheduleResumeTopActivities();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å…³äº <code>ActivityTaskSupervisor</code> è´Ÿè´£çš„ä»»åŠ¡å¤ªå¤šäº†ï¼Œä¼°è®¡åƒä¸ªç‰ˆæœ¬è¦åˆ†ç¦»éƒ¨åˆ†ä»£ç å§</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// <span class=\"doctag\">TODO:</span> This class has become a dumping ground. Let&#x27;s</span></span><br><span class=\"line\"><span class=\"comment\">// - Move things relating to the hierarchy to RootWindowContainer</span></span><br><span class=\"line\"><span class=\"comment\">// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler</span></span><br><span class=\"line\"><span class=\"comment\">// - Move interface things to ActivityTaskManagerService.</span></span><br><span class=\"line\"><span class=\"comment\">// - All other little things to other files.</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ActivityTaskSupervisor</span> <span class=\"keyword\">implements</span> <span class=\"title\">RecentTasks</span>.<span class=\"title\">Callbacks</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>activityStarter</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">execute</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€å¦‚æœå¯åŠ¨è¯·æ±‚ä¿¡æ¯æ— æ•ˆï¼Œåˆ™é‡æ–°è§£æå¹¶å¡«å……å¯åŠ¨è¯·æ±‚å‚æ•°</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€è¯·æ±‚å‚æ•°åŒ…æ‹¬ pidã€uidã€resolveInfoã€activityInfo  .etc</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mRequest.activityInfo == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mRequest.resolveActivity(mSupervisor);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> res;</span><br><span class=\"line\">        <span class=\"comment\">//mGlobalLock å…¨å±€æœåŠ¡é”ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡</span></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (mService.mGlobalLock) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> globalConfigWillChange = mRequest.globalConfig != <span class=\"keyword\">null</span></span><br><span class=\"line\">                    &amp;&amp; mService.getGlobalConfiguration().diff(mRequest.globalConfig) != <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Task rootTask = mRootWindowContainer.getTopDisplayFocusedRootTask();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (rootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                rootTask.mConfigWillChange = globalConfigWillChange;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> origId = Binder.clearCallingIdentity();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                1ã€ä»€ä¹ˆé‡é‡çº§è¿›ç¨‹åˆ‡æ¢ï¼Œæˆ‘éƒ½æ‡µäº†ğŸ˜º</span></span><br><span class=\"line\"><span class=\"comment\">                2ã€å¦‚æœæ‰¾ä¸åˆ°è°ƒç”¨è€… app è¿›ç¨‹ï¼Œåˆ™ç»ˆæ­¢å¯åŠ¨è¯·æ±‚ ATMS.getProcessController(request.caller) == null</span></span><br><span class=\"line\"><span class=\"comment\">            */</span></span><br><span class=\"line\">            res = resolveToHeavyWeightSwitcherIfNeeded();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (res != START_SUCCESS) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//â€¼ï¸æ‰§è¡Œå¯åŠ¨è¯·æ±‚</span></span><br><span class=\"line\">            res = executeRequest(mRequest);</span><br><span class=\"line\"></span><br><span class=\"line\">            mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(launchingState, res,</span><br><span class=\"line\">                    newActivityCreated, mLastStartActivityRecord, originalOptions);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mRequest.waitResult != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                mRequest.waitResult.result = res;</span><br><span class=\"line\">                res = waitResultIfNeeded(mRequest.waitResult, mLastStartActivityRecord,</span><br><span class=\"line\">                        launchingState);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> getExternalResult(res);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æ‰§è¡Œå®Œæˆæœ€åä¸€å®šè¦å›æ”¶ activity å¯åŠ¨å™¨</span></span><br><span class=\"line\">        onExecutionComplete();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>activity å¯åŠ¨è¯·æ±‚æ­£å¼å¼€å§‹ï¼Œè¿™é‡Œå°†ä¼šæœ‰å¾ˆå¤šçš„å¯åŠ¨é™åˆ¶ğŸš«ç­‰ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivitStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">executeRequest</span><span class=\"params\">(Request request)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//å¾ˆå¥½å¥‡è¿™ä¸ª reason è¿™ä¹ˆæ€»è¦å—ï¼Ÿå¹²ä»€ä¹ˆç”¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TextUtils.isEmpty(request.reason)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Need to specify a reason.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœä¸­é€”æ£€æµ‹åˆ°æ˜¯éå¯åŠ¨æˆåŠŸï¼ˆè§¦å‘å¯åŠ¨é™åˆ¶ï¼‰ï¼Œé‚£ä¹ˆç«‹é©¬ç»“æŸè¯·æ±‚ï¼Œè¿”å›ç»“æœ</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class=\"line\">    <span class=\"comment\">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Bundle verificationBundle =</span><br><span class=\"line\">            options != <span class=\"keyword\">null</span> ? options.popAppVerificationBundle() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒé™åˆ¶1ï¼šæ ¹æ®å¯åŠ¨è¯·æ±‚è°ƒç”¨è€… caller å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯åŠ¨ app è¿›ç¨‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›æ‹¦æˆªè¯·æ±‚</span></span><br><span class=\"line\">    WindowProcessController callerApp = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (caller != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        callerApp = mService.getProcessController(caller);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callerApp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            callingPid = callerApp.getPid();</span><br><span class=\"line\">            callingUid = callerApp.mInfo.uid;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            err = START_PERMISSION_DENIED;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> launchFlags = intent.getFlags();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class=\"number\">0</span> &amp;&amp; sourceRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒä»€ä¹ˆè¯·æ±‚å†²çªï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (requestCode &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            SafeActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒå¯åŠ¨ç›®æ ‡ activity æœªçŸ¥ï¼Œå¤±è´¥</span></span><br><span class=\"line\">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//âŒåŒæ ·çš„ï¼Œè¯·æ±‚æ‰€éœ€è¦çš„åŸºç¡€ä¿¡æ¯éƒ½æœªçŸ¥ï¼Œè‡ªç„¶ä¸­æ–­æœ¬æ¬¡è¯·æ±‚</span></span><br><span class=\"line\">        err = ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// voiceSession è¯­éŸ³äº¤äº’ç›¸å…³ activityã€è¿™é‡Œå…¶å®æ˜¯ activity å¯åŠ¨éƒ½ä¼šç»è¿‡çš„è·¯é€”ï¼Œåªæ˜¯æˆ‘ä»¬æœ¬æ¬¡åˆ†æçš„æ˜¯â€˜å¯åŠ¨æ¡Œé¢ activityâ€™ã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; sourceRecord.getTask().voiceSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((launchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class=\"number\">0</span></span><br><span class=\"line\">                &amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                intent.addCategory(Intent.CATEGORY_VOICE);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!mService.getPackageManager().activitySupportsIntent(</span><br><span class=\"line\">                        intent.getComponent(), intent, resolvedType)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ</span></span><br><span class=\"line\">                    err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//âŒä¸æ”¯æŒè¯­éŸ³äº¤äº’åŠŸèƒ½ï¼Ÿ</span></span><br><span class=\"line\">                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!mService.getPackageManager().activitySupportsIntent(intent.getComponent(),</span><br><span class=\"line\">                    intent, resolvedType)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//âŒä¸æ”¯æŒ</span></span><br><span class=\"line\">                err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//âŒä¸æ”¯æŒ</span></span><br><span class=\"line\">            err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err != START_SUCCESS) &#123;</span><br><span class=\"line\">        SafeActivityOptions.abort(options);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> err;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ£€æŸ¥ activity å¯åŠ¨æ˜¯å¦æ»¡è¶³æ¡ä»¶</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,</span><br><span class=\"line\">            requestCode, callingPid, callingUid, callingPackage, callingFeatureId,</span><br><span class=\"line\">            request.ignoreTargetSecurity, inTask != <span class=\"keyword\">null</span>, callerApp, resultRecord,</span><br><span class=\"line\">            resultRootTask);</span><br><span class=\"line\">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</span><br><span class=\"line\">            callingPid, resolvedType, aInfo.applicationInfo);</span><br><span class=\"line\">    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,</span><br><span class=\"line\">            callingPackage);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> restrictedBgActivity = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!abort) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//ç»§ç»­æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯åŠ¨æ¡ä»¶</span></span><br><span class=\"line\">            restrictedBgActivity = shouldAbortBackgroundActivityStart(callingUid,</span><br><span class=\"line\">                    callingPid, callingPackage, realCallingUid, realCallingPid, callerApp,</span><br><span class=\"line\">                    request.originatingPendingIntent, request.allowBackgroundActivityStart,</span><br><span class=\"line\">                    intent);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     </span><br><span class=\"line\">    <span class=\"comment\">//ç•¥ç•¥ç•¥ï½ï½ï½</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ²¡æœ‰é€šè¿‡å¯åŠ¨æ£€æŸ¥å°±è¦ç»“æŸæ‰§è¡Œäº†</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (abort) &#123;</span><br><span class=\"line\">        ActivityOptions.abort(checkedOptions);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_ABORTED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (aInfo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired(</span><br><span class=\"line\">                aInfo.packageName, userId)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> IIntentSender target = mService.getIntentSenderLocked(</span><br><span class=\"line\">                    ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage, callingFeatureId,</span><br><span class=\"line\">                    callingUid, userId, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, <span class=\"number\">0</span>, <span class=\"keyword\">new</span> Intent[]&#123;intent&#125;,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[]&#123;resolvedType&#125;, PendingIntent.FLAG_CANCEL_CURRENT</span><br><span class=\"line\">                            | PendingIntent.FLAG_ONE_SHOT, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            Intent newIntent = <span class=\"keyword\">new</span> Intent(Intent.ACTION_REVIEW_PERMISSIONS);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">int</span> flags = intent.getFlags();</span><br><span class=\"line\">            flags |= Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//è®¾ç½®å¯åŠ¨æ ‡è¯†ï¼Œä»…è®¾ç½® NEW_TASK æŸäº›åœºæ™¯ä¸ä¸€å®šä¼šçœŸçš„åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œä½†å¯ä»¥ç½®ä¸º MULTIPLE_TASK</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((flags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_NEW_DOCUMENT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                flags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            newIntent.setFlags(flags);</span><br><span class=\"line\"></span><br><span class=\"line\">            newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName);</span><br><span class=\"line\">            newIntent.putExtra(Intent.EXTRA_INTENT, <span class=\"keyword\">new</span> IntentSender(target));</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (resultRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            intent = newIntent;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//ä¸€å †æ•°æ®è§£æå’Œèµ‹å€¼å°±ä¸çœ‹äº†</span></span><br><span class=\"line\">            intentGrants = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            resolvedType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            callingUid = realCallingUid;</span><br><span class=\"line\">            callingPid = realCallingPid;</span><br><span class=\"line\">            rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, <span class=\"number\">0</span>,</span><br><span class=\"line\">                    computeResolveFilterUid(</span><br><span class=\"line\">                            callingUid, realCallingUid, request.filterCallingUid));</span><br><span class=\"line\">            aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags,</span><br><span class=\"line\">                    <span class=\"keyword\">null</span> <span class=\"comment\">/*profilerInfo*/</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rInfo != <span class=\"keyword\">null</span> &amp;&amp; rInfo.auxiliaryInfo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ä¸‡äº‹ä¿±å¤‡ï¼Œå‡†å¤‡å¾…å‘ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥å¯åŠ¨çš„ intent ï¼ˆä¹Ÿå°±æ˜¯å¯åŠ¨æ•°æ®æ¯ä¸ªå¿…è¦çš„ä¸å¯å°‘ï¼‰</span></span><br><span class=\"line\">        <span class=\"comment\">//åº”è¯¥æ˜¯æœ‰ç‰¹åˆ«ä¹‹å¤„çš„ï¼Œä¸ç„¶ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„ intentï¼Œå…·ä½“å°±ä¸çº ç»“äº†</span></span><br><span class=\"line\">        intent = createLaunchIntent(rInfo.auxiliaryInfo, request.ephemeralIntent,</span><br><span class=\"line\">                callingPackage, callingFeatureId, verificationBundle, resolvedType, userId);</span><br><span class=\"line\">        resolvedType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        callingUid = realCallingUid;</span><br><span class=\"line\">        callingPid = realCallingPid;</span><br><span class=\"line\">        intentGrants = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, <span class=\"keyword\">null</span> <span class=\"comment\">/*profilerInfo*/</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ¯ä¸€ä¸ª activity çš„ä¿¡æ¯éƒ½å°†è®°å½•åœ¨ ActivityRecord ä¸­</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityRecord r = <span class=\"keyword\">new</span> ActivityRecord.Builder(mService)</span><br><span class=\"line\">            .setCaller(callerApp)</span><br><span class=\"line\">            .setLaunchedFromPid(callingPid)</span><br><span class=\"line\">            .setLaunchedFromUid(callingUid)</span><br><span class=\"line\">            .setLaunchedFromPackage(callingPackage)</span><br><span class=\"line\">            .setLaunchedFromFeature(callingFeatureId)</span><br><span class=\"line\">            .setIntent(intent)</span><br><span class=\"line\">            .setResolvedType(resolvedType)</span><br><span class=\"line\">            .setActivityInfo(aInfo)</span><br><span class=\"line\">            .setConfiguration(mService.getGlobalConfiguration())</span><br><span class=\"line\">            .setResultTo(resultRecord)</span><br><span class=\"line\">            .setResultWho(resultWho)</span><br><span class=\"line\">            .setRequestCode(requestCode)</span><br><span class=\"line\">            .setComponentSpecified(request.componentSpecified)</span><br><span class=\"line\">            .setRootVoiceInteraction(voiceSession != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            .setActivityOptions(checkedOptions)</span><br><span class=\"line\">            .setSourceRecord(sourceRecord)</span><br><span class=\"line\">            .build();</span><br><span class=\"line\"></span><br><span class=\"line\">    mLastStartActivityRecord = r;</span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¥½äº†ï¼Œåˆåˆ°ä¸‹ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ</span></span><br><span class=\"line\">    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class=\"line\">            request.voiceInteractor, startFlags, <span class=\"keyword\">true</span> <span class=\"comment\">/* doResume */</span>, checkedOptions,</span><br><span class=\"line\">            inTask, inTaskFragment, restrictedBgActivity, intentGrants);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (request.outActivity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        request.outActivity[<span class=\"number\">0</span>] = mLastStartActivityRecord;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mLastStartActivityResult;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkStartAnyActivityPremission\">checkStartAnyActivityPremission</h2>\n<p>ä»»ä½•ä¸€ä¸ª activity å¯åŠ¨éƒ½éœ€è¦æ£€æŸ¥æƒé™é—®é¢˜ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivitTaskSupervisor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">checkStartAnyActivityPermission</span><span class=\"params\">(Intent intent, ActivityInfo aInfo, String resultWho,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> requestCode, <span class=\"keyword\">int</span> callingPid, <span class=\"keyword\">int</span> callingUid, String callingPackage,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> String callingFeatureId, <span class=\"keyword\">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> launchingInTask, WindowProcessController callerApp, ActivityRecord resultRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        Task resultRootTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//0ã€âœ…å¦‚æœæ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç»„ä»¶ å¹¶ä¸” æ˜¯å½“å‰æ ˆä¸­è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallerRecents = mService.getRecentTasks() != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; mService.getRecentTasks().isCallerRecents(callingUid);</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€âœ…å¦‚æœæ˜¯å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™çš„åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.ROOT_UID</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ appID=Process.SYSTEM_UID</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€âŒå¦‚æœæ˜¯ä¸åŒè¿›ç¨‹æ˜¯ä¸å…è®¸çš„ UserHandle.isIsolated(uid)</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€âœ…å¦‚æœæ˜¯è®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„ UserHandle.isSameApp(uid, owningUid)</span></span><br><span class=\"line\"><span class=\"comment\">        5ã€âŒå¦‚æœç›®æ ‡ activity exported=false æ˜¯ä¸è¢«å…è®¸å¯åŠ¨çš„</span></span><br><span class=\"line\"><span class=\"comment\">        6ã€âŒå¦‚æœæ£€æŸ¥çš„æƒé™å­˜åœ¨ â€˜ç¦æ­¢æƒé™åˆ—è¡¨â€™ä¸­æ˜¯ä¸è¢«å…è®¸çš„  [è‡³äºåˆ—è¡¨ä¸­éƒ½æœ‰å“ªäº›æƒé™æˆ‘ä»¬ä»¥åè®¨è®º]</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> startAnyPerm = mService.checkPermission(START_ANY_ACTIVITY, callingPid,</span><br><span class=\"line\">            callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (startAnyPerm == PERMISSION_GRANTED || (isCallerRecents &amp;&amp; launchingInTask)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒcomponent é™åˆ¶ ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkComponentPermissionã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> componentRestriction = getComponentRestrictionForCallingPackage(aInfo,</span><br><span class=\"line\">            callingPackage, callingFeatureId, callingPid, callingUid, ignoreTargetSecurity);</span><br><span class=\"line\">    <span class=\"comment\">//âŒaction é™åˆ¶  ã€è·Ÿä¸Šè¿°é™åˆ¶å·®ä¸å¤šï¼Œä¼šè°ƒç”¨åˆ° checkPermissionã€‘</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> actionRestriction = getActionRestrictionForCallingPackage(</span><br><span class=\"line\">            intent.getAction(), callingPackage, callingFeatureId, callingPid, callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION</span><br><span class=\"line\">            || actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultRecord != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            resultRecord.sendResult(INVALID_UID, resultWho, requestCode,</span><br><span class=\"line\">                    Activity.RESULT_CANCELED, <span class=\"keyword\">null</span> <span class=\"comment\">/* data */</span>, <span class=\"keyword\">null</span> <span class=\"comment\">/* dataGrants */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SecurityException(msg);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (actionRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (componentRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkIntent\">checkIntent</h2>\n<p>mService.mIntentFirewall.checkStartActivity æœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ intent è¿‡æ»¤ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//IntentFirewall.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkIntent</span><span class=\"params\">(FirewallIntentResolver resolver, ComponentName resolvedComponent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> intentType, Intent intent, <span class=\"keyword\">int</span> callerUid, <span class=\"keyword\">int</span> callerPid, String resolvedType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> receivingUid)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> log = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> block = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;Rule&gt; candidateRules;</span><br><span class=\"line\">    candidateRules = resolver.queryIntent(intent, resolvedType, <span class=\"keyword\">false</span> <span class=\"comment\">/*defaultOnly*/</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (candidateRules == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        candidateRules = <span class=\"keyword\">new</span> ArrayList&lt;Rule&gt;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resolver.queryByComponent(resolvedComponent, candidateRules);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;candidateRules.size(); i++) &#123;</span><br><span class=\"line\">        Rule rule = candidateRules.get(i);</span><br><span class=\"line\">        <span class=\"comment\">//intent è¿‡æ»¤è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œè§„åˆ™æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼Ÿä¸æ‡‚â€”â€”â€”â€”ç•¥ï¼</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rule.matches(<span class=\"keyword\">this</span>, resolvedComponent, intent, callerUid, callerPid, resolvedType,</span><br><span class=\"line\">                receivingUid)) &#123;</span><br><span class=\"line\">            block |= rule.getBlock();</span><br><span class=\"line\">            log |= rule.getLog();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (block &amp;&amp; log) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (log) &#123;</span><br><span class=\"line\">        logIntent(intentType, intent, callerUid, resolvedType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> !block;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"checkStartActivity\">checkStartActivity</h2>\n<p>PermissionPolicyInternal æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æ˜¯ PermissionPolicyService çš„ä¸€ä¸ªå†…éƒ¨ç±» <code>private class Internal extends PermissionPolicyInternal </code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//PermissionPolicyService.java</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Internal</span> <span class=\"keyword\">extends</span> <span class=\"title\">PermissionPolicyInternal</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">checkStartActivity</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent, <span class=\"keyword\">int</span> callingUid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            <span class=\"meta\">@Nullable</span> String callingPackage)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callingPackage != <span class=\"keyword\">null</span> &amp;&amp; isActionRemovedForCallingPackage(intent, callingUid,</span><br><span class=\"line\">                callingPackage)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//PermissionPolicyService.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isActionRemovedForCallingPackage</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent, <span class=\"keyword\">int</span> callingUid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@NonNull</span> String callingPackage)</span> </span>&#123;</span><br><span class=\"line\">    String action = intent.getAction();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (action == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (action) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> TelecomManager.ACTION_CHANGE_DEFAULT_DIALER:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT: &#123;</span><br><span class=\"line\">            ApplicationInfo applicationInfo;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                applicationInfo = getContext().getPackageManager().getApplicationInfoAsUser(</span><br><span class=\"line\">                        callingPackage, <span class=\"number\">0</span>, UserHandle.getUserId(callingUid));</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//åªæœ‰é«˜ç‰ˆæœ¬æ‰ä¼šæ£€æŸ¥è¿™ä¸ªé—®é¢˜å’¯</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">            intent.putExtra(Intent.EXTRA_CALLING_PACKAGE, callingPackage);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"shouldAbortBackgroundActivityStart\">shouldAbortBackgroundActivityStart</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">shouldAbortBackgroundActivityStart</span><span class=\"params\">(<span class=\"keyword\">int</span> callingUid, <span class=\"keyword\">int</span> callingPid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">final</span> String callingPackage, <span class=\"keyword\">int</span> realCallingUid, <span class=\"keyword\">int</span> realCallingPid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        WindowProcessController callerApp, PendingIntentRecord originatingPendingIntent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowBackgroundActivityStart, Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//1ã€âœ…ç³»ç»Ÿç”¨æˆ·åº”ç”¨ã€å…·æœ‰ Root æƒé™çš„åº”ç”¨ã€NFC ï¼ˆä¸€èˆ¬æ˜¯ä¼´ç”Ÿè®¾å¤‡ï¼‰åº”ç”¨è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingAppId = UserHandle.getAppId(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callingUid == Process.ROOT_UID || callingAppId == Process.SYSTEM_UID</span><br><span class=\"line\">            || callingAppId == Process.NFC_UID) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//2ã€âœ…å¦‚æœæ˜¯æ¡Œé¢ç¨‹åºå¯åŠ¨æ˜¯å…è®¸çš„  [æ­£å¸¸ç”¨æˆ·æ“ä½œä¸å°±æ˜¯ç‚¹å‡»æ¡Œé¢åº”ç”¨å›¾æ ‡ç„¶åå¯åŠ¨çš„å˜›]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isHomeApp(callingUid, callingPackage)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//3ã€âœ…è®¾å¤‡æ‰€æœ‰è€…æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> WindowState imeWindow = mRootWindowContainer.getCurrentInputMethodWindow();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (imeWindow != <span class=\"keyword\">null</span> &amp;&amp; callingAppId == imeWindow.mOwnerUid) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//4ã€âœ…å¦‚æœæœ‰å‰å°åº”ç”¨æˆ–å¯è§ç•Œé¢å­˜åœ¨å‰å°ï¼Œè¿™ä¹Ÿæ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> appSwitchState = mService.getBalAppSwitchesState();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingUidProcState = mService.mActiveUids.getUidState(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> callingUidHasAnyVisibleWindow = mService.hasActiveVisibleWindow(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallingUidForeground = callingUidHasAnyVisibleWindow</span><br><span class=\"line\">            || callingUidProcState == ActivityManager.PROCESS_STATE_TOP</span><br><span class=\"line\">            || callingUidProcState == ActivityManager.PROCESS_STATE_BOUND_TOP;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isCallingUidPersistentSystemProcess =</span><br><span class=\"line\">            callingUidProcState &lt;= ActivityManager.PROCESS_STATE_PERSISTENT_UI;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//5ã€âœ…åœ¨åº”ç”¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> appSwitchAllowedOrFg =</span><br><span class=\"line\">            appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((appSwitchAllowedOrFg || mService.mActiveUids.hasNonAppVisibleWindow(callingUid))</span><br><span class=\"line\">            &amp;&amp; callingUidHasAnyVisibleWindow)</span><br><span class=\"line\">            || isCallingUidPersistentSystemProcess) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> realCallingUidProcState = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? callingUidProcState</span><br><span class=\"line\">            : mService.mActiveUids.getUidState(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> realCallingUidHasAnyVisibleWindow = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? callingUidHasAnyVisibleWindow</span><br><span class=\"line\">            : mService.hasActiveVisibleWindow(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isRealCallingUidForeground = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? isCallingUidForeground</span><br><span class=\"line\">            : realCallingUidHasAnyVisibleWindow</span><br><span class=\"line\">                    || realCallingUidProcState == ActivityManager.PROCESS_STATE_TOP;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> realCallingAppId = UserHandle.getAppId(realCallingUid);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isRealCallingUidPersistentSystemProcess = (callingUid == realCallingUid)</span><br><span class=\"line\">            ? isCallingUidPersistentSystemProcess</span><br><span class=\"line\">            : (realCallingAppId == Process.SYSTEM_UID)</span><br><span class=\"line\">                    || realCallingUidProcState &lt;= ActivityManager.PROCESS_STATE_PERSISTENT_UI;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (realCallingUid != callingUid) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//6ã€âœ…å¦‚æœè°ƒç”¨çš„è¿›ç¨‹æœ‰å¯è§çš„çª—å£æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (realCallingUidHasAnyVisibleWindow) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (DEBUG_ACTIVITY_STARTS) &#123;</span><br><span class=\"line\">                Slog.d(TAG, <span class=\"string\">&quot;Activity start allowed: realCallingUid (&quot;</span> + realCallingUid</span><br><span class=\"line\">                        + <span class=\"string\">&quot;) has visible (non-toast) window&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//7ã€âœ…å¦‚æœæ˜¯â€˜ç³»ç»ŸæŒä¹…åº”ç”¨â€™å‘èµ·çš„è¯·æ±‚æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isRealCallingUidPersistentSystemProcess &amp;&amp; allowBackgroundActivityStart) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//8ã€âœ…å¦‚æœå­˜åœ¨ä¼´ç”Ÿè®¾å¤‡æˆ–è€…ç›¸å…³å¯è§åº”ç”¨è¿›ç¨‹æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.isAssociatedCompanionApp(UserHandle.getUserId(realCallingUid),</span><br><span class=\"line\">                realCallingUid)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//9ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ START_ACTIVITIES_FROM_BACKGROUND æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.checkPermission(START_ACTIVITIES_FROM_BACKGROUND, callingPid, callingUid)</span><br><span class=\"line\">            == PERMISSION_GRANTED) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//10ã€âœ…å¦‚æœæœ€è¿‘å­˜åœ¨ç›¸åŒ uid è¿›ç¨‹å¯åŠ¨ç›¸å…³ç»„ä»¶æ˜¯å…è®¸çš„ï¼ˆåŒä¸€ä¸ªåº”ç”¨ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mSupervisor.mRecentTasks.isCallerRecents(callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//11ã€âœ…å¯¹äºè®¾å¤‡æ‰€æœ‰è€…è¯·æ±‚å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isDeviceOwner(callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//12ã€âœ…å¯¹äºä¼´ç”Ÿè®¾å¤‡çš„è¯·æ±‚æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> callingUserId = UserHandle.getUserId(callingUid);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.isAssociatedCompanionApp(callingUserId, callingUid)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//13ã€âœ…å…·å¤‡ç³»ç»Ÿæƒé™ SYSTEM_ALERT_WINDOW æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mService.hasSystemAlertWindowPermission(callingUid, callingPid, callingPackage)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> callerAppUid = callingUid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callerApp == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        callerApp = mService.getProcessController(realCallingPid, realCallingUid);</span><br><span class=\"line\">        callerAppUid = realCallingUid;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (callerApp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸æ¥åˆ°äº†æ–°çš„å¯åŠ¨æ§åˆ¶ç±»ï¼šBackgroundLaunchProcessController#areBackgroundActivityStartsAllowed</span></span><br><span class=\"line\">        <span class=\"comment\">//å‚è€ƒä¸‹æ–‡</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callerApp.areBackgroundActivityStartsAllowed(appSwitchState)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> ArraySet&lt;WindowProcessController&gt; uidProcesses =</span><br><span class=\"line\">                mService.mProcessMap.getProcesses(callerAppUid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (uidProcesses != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = uidProcesses.size() - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">final</span> WindowProcessController proc = uidProcesses.valueAt(i);</span><br><span class=\"line\">                <span class=\"comment\">//å‚çœ‹ä¸‹æ–‡</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (proc != callerApp</span><br><span class=\"line\">                        &amp;&amp; proc.areBackgroundActivityStartsAllowed(appSwitchState)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"areBackgroundActivityStartsAllowed\">areBackgroundActivityStartsAllowed</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//BackgroundLaunchProcessController.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">areBackgroundActivityStartsAllowed</span><span class=\"params\">(<span class=\"keyword\">int</span> pid, <span class=\"keyword\">int</span> uid, String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> appSwitchState, <span class=\"keyword\">boolean</span> isCheckingForFgsStart,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> hasActivityInVisibleTask, <span class=\"keyword\">boolean</span> hasBackgroundActivityStartPrivileges,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> lastStopAppSwitchesTime, <span class=\"keyword\">long</span> lastActivityLaunchTime,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> lastActivityFinishTime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (appSwitchState == APP_SWITCH_ALLOW) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = SystemClock.uptimeMillis();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now - lastActivityLaunchTime &lt; ACTIVITY_BG_START_GRACE_PERIOD_MS</span><br><span class=\"line\">                || now - lastActivityFinishTime &lt; ACTIVITY_BG_START_GRACE_PERIOD_MS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (lastActivityLaunchTime &gt; lastStopAppSwitchesTime</span><br><span class=\"line\">                    || lastActivityFinishTime &gt; lastStopAppSwitchesTime) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasBackgroundActivityStartPrivileges) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasActivityInVisibleTask</span><br><span class=\"line\">            &amp;&amp; (appSwitchState == APP_SWITCH_ALLOW || appSwitchState == APP_SWITCH_FG_ONLY)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isBoundByForegroundUid()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isBackgroundStartAllowedByToken(uid, packageName, isCheckingForFgsStart)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityUnchecked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">startActivityUnchecked</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>Reference</h1>\n<ul>\n<li>è¾“å…¥æ³•æ§ä»¶ IMEï¼š<a href=\"https://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn\">https://developer.android.google.cn/guide/topics/text/creating-input-method?hl=zh-cn</a></li>\n<li><a href=\"https://baike.baidu.com/item/%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B/16751450#:~:text=%E5%9C%A8%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%A2%86%E5%9F%9F%E4%B8%AD%EF%BC%8C%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%E6%8C%87%E7%9A%84%E6%98%AF%E5%9C%A8%E5%85%B6%E7%88%B6%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E6%88%96%E8%A2%AB%E7%BB%88%E6%AD%A2%E5%90%8E%E4%BB%8D%E7%BB%A7%E7%BB%AD%E8%BF%90%E8%A1%8C%E7%9A%84%E4%B8%80%E7%B1%BB%E8%BF%9B%E7%A8%8B%E3%80%82,%E8%BF%99%E4%BA%9B%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%E5%B0%86%E8%A2%ABinit%E8%BF%9B%E7%A8%8B%20%28%E8%BF%9B%E7%A8%8B%E5%8F%B7%E4%B8%BA1%29%E6%89%80%E6%94%B6%E5%85%BB%EF%BC%8C%E5%B9%B6%E7%94%B1init%E8%BF%9B%E7%A8%8B%E5%AF%B9%E5%AE%83%E4%BB%AC%E5%AE%8C%E6%88%90%E7%8A%B6%E6%80%81%E6%94%B6%E9%9B%86%E5%B7%A5%E4%BD%9C%E3%80%82\"> å…³äºå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹çš„æ¦‚å¿µ </a></li>\n<li><a href=\"https://www.cnblogs.com/perseus/articles/2354173.html\"> å…³äº UIDã€PID çš„äº†è§£</a></li>\n<li><a href=\"https://developer.android.google.cn/guide/topics/text/autofill?hl=zh-cn\">AutofillManager å‚è€ƒé“¾æ¥ [1]</a></li>\n</ul>\n"},{"title":"Android ç³»ç»Ÿ Homeï¼ˆäºŒï¼‰","catalog":true,"date":"2022-09-29T14:58:04.000Z","subtitle":"å¯åŠ¨æ¡Œé¢å°±æ˜¯æŸ¥æ‰¾å¹¶å¯åŠ¨ Activity","header-img":"/img/220928/android_sysserver_bg.png","sticky":9,"_content":"\næ¡Œé¢å¯åŠ¨ç±»ä¼¼ Activity å¯åŠ¨ï¼Œæ¥ç€ä¸Šä¸€ç« èŠ‚ç»§ç»­æŸ¥é˜…å¯åŠ¨æµç¨‹ï¼Œå¯åŠ¨é™åˆ¶ã€å¯åŠ¨æ¡ä»¶æ£€æŸ¥æ˜¯é‡ç‚¹ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šé€æ­¥å›è°ƒç»™å¤–éƒ¨ï¼Œè¿™é‡Œåªæ˜¯ç²—ç•¥æè¿°å¯åŠ¨è¿‡ç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…æ‹¬çª—å£çš„åˆ›å»ºã€ç»˜åˆ¶ç­‰ç­‰ã€‚\n\n# startActivityUnchecked\n\n```java\n//ActivityStarter.java\nprivate int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n    int result = START_CANCELED;\n    boolean startResultSuccessful = false;\n    final Task startedActivityRootTask;\n\n    //TRANSIT_OPENï¼šåˆ›å»ºä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„æ–°çª—å£ï¼Œå¹¶ä¸”è®©çª—å£å¯è§\n    //transitType è¿˜ä¼šå½±å“çª—å£ç»˜åˆ¶æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤æ˜¯ 5ç§’ï¼Œå¦‚æœæ˜¯ chenge ç±»å‹å»¶æ—¶å°†ç¼©çŸ­åˆ° 2 ç§’\n    //ä¹Ÿä¼šæŠŠ windowContain æ·»åŠ åˆ°é›†åˆä¸­ï¼Œç­‰å¾…çª—å£ç»˜åˆ¶\n    final TransitionController transitionController = r.mTransitionController;\n    Transition newTransition = (!transitionController.isCollecting()\n            && transitionController.getTransitionPlayer() != null)\n            ? transitionController.createTransition(TRANSIT_OPEN) : null;\n    RemoteTransition remoteTransition = r.takeRemoteTransition();\n    if (newTransition != null && remoteTransition != null) {\n        newTransition.setRemoteTransition(remoteTransition);\n    }\n    transitionController.collect(r);\n    final boolean isTransient = r.getOptions() != null && r.getOptions().getTransientLaunch();\n    \n    \n    try {\n        //å»¶è¿Ÿçª—å£æµ‹é‡ï¼Œåˆä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å˜é‡ mDeferDepth++ï¼Œæ§åˆ¶æµ‹é‡ã€ç»˜åˆ¶æ¬¡æ•°ï¼Œé¿å…é€’å½’å¾ªç¯\n        mService.deferWindowLayout();\n        //â€¼ï¸åˆæ˜¯ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ\n        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,\n                startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,\n                intentGrants);\n        startResultSuccessful = ActivityManager.isStartResultSuccessful(result);\n        final boolean taskAlwaysOnTop = options != null && options.getTaskAlwaysOnTop();\n        // Apply setAlwaysOnTop when starting an Activity is successful regardless of creating\n        // a new Activity or recycling the existing Activity.\n        if (taskAlwaysOnTop && startResultSuccessful) {\n            final Task targetRootTask =\n                    mTargetRootTask != null ? mTargetRootTask : mTargetTask.getRootTask();\n            targetRootTask.setAlwaysOnTop(true);\n        }\n    } finally {\n        Trace.traceEnd(Trace.TRACE_TAG_WINDOW_MANAGER);\n        //â€¼ï¸æ— è®ºæˆåŠŸå¤±è´¥ä¸å¦ï¼Œå¯åŠ¨è§£é‡Šéƒ½åº”è¯¥åˆ†å‘å‡ºå»\n        startedActivityRootTask = handleStartResult(r, result);\n        //å»¶æ—¶çª—å£æµ‹é‡å°†è¢«æ¢å¤\n        mService.continueWindowLayout();\n        mSupervisor.mUserLeaving = false;\n    }\n\n    postStartActivityProcessing(r, result, startedActivityRootTask);\n\n    return result;\n}\n```\n\n## about TransitionType\n```\n@IntDef(prefix = { \"TRANSIT_\" }, value = {\n        TRANSIT_NONE,\n        TRANSIT_OPEN,                 //åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œå¹¶ä¸”ä½¿å…¶å¯è§\n        TRANSIT_CLOSE,                //å¯è§çš„çª—å£è¢«å…³é—­ï¼ˆfinished æˆ– destroyedï¼‰\n        TRANSIT_TO_FRONT,             //ä¸å¯è§çš„çª—å£å°†å˜ä¸ºå¯è§\n        TRANSIT_TO_BACK,              //å¯è§çš„çª—å£å˜ä¸ºä¸å¯è§\n        TRANSIT_RELAUNCH,\n        TRANSIT_CHANGE,               //å¯è§çª—å£å‘ç”Ÿæ”¹å˜ï¼ˆæ¯”å¦‚å±å¹•æ–¹å‘ã€å¤§å°æ”¹å˜ï¼‰\n        TRANSIT_KEYGUARD_GOING_AWAY,  //ï¼ˆå·²åºŸå¼ƒï¼‰\n        TRANSIT_KEYGUARD_OCCLUDE,     //é”®ç›˜é”å®š\n        TRANSIT_KEYGUARD_UNOCCLUDE,   //é”®ç›˜è§£é”\n        TRANSIT_PIP,                  //ç”»ä¸­ç”»\n        TRANSIT_WAKE,                 //ï¼ˆæ­£åœ¨æ‰“å¼€ï¼Ÿï¼‰\n        TRANSIT_FIRST_CUSTOM\n})\n@Retention(RetentionPolicy.SOURCE)\n@interface TransitionType {}\n```\n\n# startActivityInner\n\n```java\n//ActivityStarter.java\nint startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n    setInitialState(r, options, inTask, inTaskFragment, doResume, startFlags, sourceRecord,\n            voiceSession, voiceInteractor, restrictedBgActivity);\n\n    //ç¡®å®š activity æ‰€å¯åŠ¨çš„ä»»åŠ¡æ ˆåº”è¯¥æ˜¯ NEW_TASK è¿˜æ˜¯åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆå¯åŠ¨\n    computeLaunchingTaskFlags();\n    computeSourceRootTask();\n    mIntent.setFlags(mLaunchFlags);\n\n    //å¦‚æœè¯·æ±‚å·²ç»å¼€å§‹ï¼Œåº”è¯¥å†»ç»“æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ï¼Œç­‰å¾…ä¸‹æ¬¡æ›´æ–°\n    final Task prevTopTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    final Task reusedTask = getReusableTask();\n    if (mOptions != null && mOptions.freezeRecentTasksReordering()\n            && mSupervisor.mRecentTasks.isCallerRecents(r.launchedFromUid)\n            && !mSupervisor.mRecentTasks.isFreezeTaskListReorderingSet()) {\n        mFrozeTaskList = true;\n        mSupervisor.mRecentTasks.setFreezeTaskListReordering();\n    }\n\n    //è®¡ç®—æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡æ ˆå¯ä»¥å¤ç”¨ï¼Œå¦åˆ™åº”è¯¥åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆ\n    final Task targetTask = reusedTask != null ? reusedTask : computeTargetTask();\n    final boolean newTask = targetTask == null;\n    mTargetTask = targetTask;\n\n    //ç¡®å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚ windowType\n    computeLaunchParams(r, sourceRecord, targetTask);\n\n    //åˆæ˜¯ä¸€ç•ªå¯åŠ¨é™åˆ¶ï¼Œåœ¨ä»»åŠ¡æ ˆå±‚é¢é™åˆ¶å¯åŠ¨ğŸš«\n    int startResult = isAllowedToStart(r, newTask, targetTask);\n    if (startResult != START_SUCCESS) {\n        return startResult;\n    }\n\n    //å¤ç”¨ä»»åŠ¡æ ˆ\n    final ActivityRecord targetTaskTop = newTask\n            ? null : targetTask.getTopNonFinishingActivity();\n    if (targetTaskTop != null) {\n        /*\n            1ã€resumeTargetRootTaskIfNeeded\n            2ã€mRootWindowContainer.resumeFocusedTasksTopActivities\n        */\n        startResult = recycleTask(targetTask, targetTaskTop, reusedTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    } else {\n        mAddingToTask = true;\n    }\n\n    /*\n        1ã€å¦‚æœå¯åŠ¨çš„ activity æ˜¯åœ¨ä»»åŠ¡æ ˆä¸­å·²å­˜åœ¨ï¼Œåˆ™åªéœ€å¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶è°ƒç”¨ activity çš„ onNewIntent æ–¹æ³•å³å¯\n        2ã€å›è°ƒæ–¹æ³• deliverNewIntent(top, intentGrants); ActivityRecorder#deliverNewIntentLocked\n        3ã€mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,\n        NewIntentItem.obtain(ar, mState == RESUMED));\n    */\n    final Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    if (topRootTask != null) {\n        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    }\n\n    //è¿˜æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨\n    if (mTargetRootTask == null) {\n        mTargetRootTask = getLaunchRootTask(mStartActivity, mLaunchFlags, targetTask, mOptions);\n    }\n    if (newTask) {\n        final Task taskToAffiliate = (mLaunchTaskBehind && mSourceRecord != null)\n                ? mSourceRecord.getTask() : null;\n        setNewTask(taskToAffiliate);\n    } else if (mAddingToTask) {\n        addOrReparentStartingActivity(targetTask, \"adding to task\");\n    }\n\n    //å¯åŠ¨çš„ç›®æ ‡ä»»åŠ¡æ ˆæœ‰äº†ï¼Œç›´æ¥çœ‹ activity å¯åŠ¨\n    final Task startedTask = mStartActivity.getTask();\n    final boolean isTaskSwitch = startedTask != prevTopTask && !startedTask.isEmbedded();\n    \n    //å¯åŠ¨\n    mTargetRootTask.startActivityLocked(mStartActivity,\n            topRootTask != null ? topRootTask.getTopNonFinishingActivity() : null, newTask,\n            isTaskSwitch, mOptions, sourceRecord);\n    if (mDoResume) {\n        final ActivityRecord topTaskActivity = startedTask.topRunningActivityLocked();\n        //å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶æ²¡æœ‰è·å¾—ç„¦ç‚¹ï¼Œå¹¶ä¸”å½“å‰å¯åŠ¨çš„ä¸æ˜¯æœ¬æ¬¡æƒ³å¯åŠ¨çš„ï¼Œä¹Ÿè¦ç¡®ä¿å®ƒæ˜¾ç¤ºï¼ˆå®ƒå¯èƒ½æ˜¯æ›´é‡è¦çš„ activity æŠ¢å…ˆæ˜¾ç¤ºå‘¢ï¼‰\n        if (!mTargetRootTask.isTopActivityFocusable()\n                || (topTaskActivity != null && topTaskActivity.isTaskOverlay()\n                && mStartActivity != topTaskActivity)) {\n                \n            mTargetRootTask.ensureActivitiesVisible(null /* starting */,\n            mTargetRootTask.mDisplayContent.executeAppTransition();\n        } else {\n            //å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶å·²è·å¾—ç„¦ç‚¹ï¼Œå¦‚æœè¯¥ä»»åŠ¡æ ˆæ²¡æœ‰æ˜¾ç¤ºåœ¨æœ€å‰åˆ™ moveToFront\n            if (mTargetRootTask.isTopActivityFocusable()\n                    && !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) {\n                mTargetRootTask.moveToFront(\"startActivityInner\");\n            }\n            \n            //è¿™é‡Œå’Œä¸Šè¿° recycleTask ç›¸ä¼¼ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ã€‚ï¼ˆæŠŠ activity è½¬ç§»ä¸ºå¯è§çŠ¶æ€ï¼‰\n            mRootWindowContainer.resumeFocusedTasksTopActivities(\n                    mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);\n        }\n    }\n    \n    //å¯åŠ¨å®Œæ¯•éœ€è¦æ›´æ–°æœ€è¿‘ä»»åŠ¡æ ˆç­‰\n    mRootWindowContainer.updateUserRootTask(mStartActivity.mUserId, mTargetRootTask);\n    mSupervisor.mRecentTasks.add(startedTask);\n    mSupervisor.handleNonResizableTaskIfNeeded(startedTask,\n            mPreferredWindowingMode, mPreferredTaskDisplayArea, mTargetRootTask);\n\n    return START_SUCCESS;\n}\n```\n\n## isAllowedToStart\n\næ£€æŸ¥ activity æ˜¯å¦å¯ä»¥åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆæˆ–è€…æ–°çš„ä»»åŠ¡æ ˆä¸­å¯åŠ¨ã€‚\n\n```java\n//ActivityStarter.java\nprivate int isAllowedToStart(ActivityRecord r, boolean newTask, Task targetTask) {\n    //âŒ1ã€æ²¡æœ‰åŒ…åæ˜¯ä¸å…è®¸çš„ï¼ˆæ¯ä¸ª activity éƒ½æœ‰æ‰€å±çš„åŒ…ï¼‰\n    if (mStartActivity.packageName == null) {\n        if (mStartActivity.resultTo != null) {\n            mStartActivity.resultTo.sendResult(INVALID_UID, mStartActivity.resultWho,\n                    mStartActivity.requestCode, RESULT_CANCELED,\n                    null /* data */, null /* dataGrants */);\n        }\n        ActivityOptions.abort(mOptions);\n        return START_CLASS_NOT_FOUND;\n    }\n\n    /*\n        1ã€åº”ç”¨å¤„äº instrument çŠ¶æ€æ—¶ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨\n        2ã€å¦‚æœæ˜¯ VR æ˜¾ç¤ºIDæˆ–è€…é»˜è®¤æ˜¾ç¤ºIDï¼Œå…è®¸å¯åŠ¨\n        3ã€launchMode != SINGLE_TASK && launchMode != SINGLE_INSTANCE å±äºå·²æœ‰å¯åŠ¨çŠ¶æ€ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨\n    */\n    if (r.isActivityTypeHome()) {\n        if (!mRootWindowContainer.canStartHomeOnDisplayArea(r.info, mPreferredTaskDisplayArea,\n                true /* allowInstrumenting */)) {\n            return START_CANCELED;\n        }\n    }\n\n    /*\n        1ã€âŒå¦‚æœæ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„\n        2ã€âŒå¦‚æœè°ƒç”¨è€… uid ä¸æ˜¯å½“å‰ç¨‹åºï¼ˆå½“å‰ä»»åŠ¡æ ˆï¼‰ï¼Œå¯åŠ¨æ—¶ä¸å…è®¸çš„\n        3ã€âŒå¦‚æœæ˜¯éœ€è¦åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„\n    */\n    boolean blockBalInTask = (newTask\n            || !targetTask.isUidPresent(mCallingUid)\n            || (LAUNCH_SINGLE_INSTANCE == mLaunchMode && targetTask.inPinnedWindowingMode()));\n    // mRestrictedBgActivityï¼šä¸¥æ ¼æŠŠæ§ activity çš„å¯åŠ¨ğŸš«ï¼ˆè¯¥æ¡ä»¶å‰ä¸€ç¯‡æœ‰æåˆ°ï¼‰\n    if (mRestrictedBgActivity && blockBalInTask\n            && handleBackgroundActivityAbort(mStartActivity)) {\n        return START_ABORTED;\n    }\n\n    //è¿˜æ˜¯åœ¨ä¸æ–­é™åˆ¶å¯åŠ¨ï¼Œæ¡ä»¶è‹›åˆ»å•Š\n    final boolean isNewClearTask =\n            (mLaunchFlags & (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))\n                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK);\n    if (!newTask) {\n        if (mService.getLockTaskController().isLockTaskModeViolation(targetTask,\n                isNewClearTask)) {\n            return START_RETURN_LOCK_TASK_MODE_VIOLATION;\n        }\n    } else {\n        if (mService.getLockTaskController().isNewTaskLockTaskModeViolation(mStartActivity)) {\n            return START_RETURN_LOCK_TASK_MODE_VIOLATION;\n        }\n    }\n\n    if (mInTaskFragment != null && !canEmbedActivity(mInTaskFragment, r, newTask, targetTask)) {\n        return START_PERMISSION_DENIED;\n    }\n\n    //âœ…å¦åˆ™ï¼Œæ˜¯å¯åŠ¨æ˜¯å…è®¸çš„\n    return START_SUCCESS;\n}\n```\n\n## canEmbedActivity\n\næ˜¯å¦å¯ä»¥åµŒå…¥ï¼Ÿactivity åµŒå…¥ï¼Ÿ\n\n```java\n//ActivityStarter.java\nprivate boolean canEmbedActivity(@NonNull TaskFragment taskFragment, ActivityRecord starting,\n        boolean newTask, Task targetTask) {\n    final Task hostTask = taskFragment.getTask();\n    if (hostTask == null) {\n        return false;\n    }\n\n    //âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ˜¯å…è®¸åµŒå…¥å¯åŠ¨çš„\n    final int hostUid = hostTask.effectiveUid;\n    if (UserHandle.getAppId(hostUid) == Process.SYSTEM_UID) {\n        return true;\n    }\n\n    //âŒå¦‚æœä¸æ˜¯å½“å‰åº”ç”¨è¿›ç¨‹å¯åŠ¨ï¼Œæ˜¯ä¸å…è®¸çš„\n    if (hostUid != starting.getUid()) {\n        return false;\n    }\n\n    //âŒå¦‚æœä¸æ˜¯åŒä¸€ä¸ªä»»åŠ¡æ ˆï¼ˆä¸»ä»»åŠ¡æ ˆï¼‰ä¸­å¯åŠ¨ï¼Œä¹Ÿæ˜¯ä¸å…è®¸çš„\n    return !newTask && (targetTask == null || targetTask == hostTask);\n}\n```\n\n# startActivityLocked\n```java\n//Task.java\nvoid startActivityLocked(ActivityRecord r, @Nullable ActivityRecord focusedTopActivity,\n        boolean newTask, boolean isTaskSwitch, ActivityOptions options,\n        @Nullable ActivityRecord sourceRecord) {\n    Task rTask = r.getTask();\n    \n    final boolean allowMoveToFront = options == null || !options.getAvoidMoveToFront();\n    final boolean isOrhasTask = rTask == this || hasChild(rTask);\n    \n    //å¯åŠ¨çš„ activity ä¸èƒ½æ˜¯é˜»å¡çš„ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸\n    Task task = null;\n    if (!newTask && isOrhasTask) {\n        final ActivityRecord occludingActivity = getOccludingActivityAbove(r);\n        if (occludingActivity != null) {\n            rTask.positionChildAtTop(r);\n            ActivityOptions.abort(options);\n            return;\n        }\n    }\n\n    //å…è®¸ç§»åŠ¨åˆ°å‰å°ï¼Œå¹¶ä¸”ä¸æ˜¯æ¡Œé¢ç¨‹åºã€æ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä»»åŠ¡æ ˆã€ä»»åŠ¡æ ˆå·²æœ‰activity\n    if ((!isHomeOrRecentsRootTask() || hasActivity()) && allowMoveToFront) {\n        boolean doShow = true;\n        if (newTask) {\n            if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {\n                resetTaskIfNeeded(r, r);\n                doShow = topRunningNonDelayedActivityLocked(null) == r;\n            }\n        } else if (options != null && options.getAnimationType()\n                == ActivityOptions.ANIM_SCENE_TRANSITION) {\n            doShow = false;\n        }\n        if (r.mLaunchTaskBehind) {\n            r.setVisibility(true);\n            ensureActivitiesVisible(null, 0, !PRESERVE_WINDOWS);\n            mDisplayContent.executeAppTransition();\n        } else if (SHOW_APP_STARTING_PREVIEW && doShow) {\n            Task baseTask = r.getTask();\n            //â€¼ï¸å¯åŠ¨\n            final ActivityRecord prev = baseTask.getActivity(\n                    a -> a.mStartingData != null && a.showToCurrentUser());\n            r.showStartingWindow(prev, newTask, isTaskSwitch,\n                    true /* startActivity */, sourceRecord);\n        }\n    } else {\n        //ç¬¬ä¸€ä¸ªå¯åŠ¨çš„ activity æ— éœ€èŠ±é‡Œèƒ¡å“¨çš„åŠ¨ç”»\n        ActivityOptions.abort(options);\n    }\n}\n```\n\n# showStartingWindow\n```java\n//ActivityRecord.java\nvoid showStartingWindow(ActivityRecord prev, boolean newTask, boolean taskSwitch,\n        boolean startActivity, ActivityRecord sourceRecord) {\n    //è¦†ç›–æ—¶ï¼Œä¸ä¼šæ˜¾ç¤º\n    if (mTaskOverlay) {\n        return;\n    }\n    \n    //å…±äº«å…ƒç´ è½¬æ¢æ—¶ï¼Œä¸é™åˆ¶ï¼ˆå…±äº«å…ƒç´ ï¼šAndroid åŠ¨ç”»éƒ¨åˆ†ï¼‰\n    if (mPendingOptions != null\n            && mPendingOptions.getAnimationType() == ActivityOptions.ANIM_SCENE_TRANSITION) {\n        return;\n    }\n\n    final CompatibilityInfo compatInfo =\n            mAtmService.compatibilityInfoForPackageLocked(info.applicationInfo);\n\n    //æ˜¯å¦ä½¿ç”¨å¯åŠ¨é¡µæ ·å¼\n    mSplashScreenStyleEmpty = shouldUseEmptySplashScreen(sourceRecord, startActivity);\n\n    /*\n        1ã€æˆ‘ä»¬è¿™å°±æ˜¯å¯åŠ¨ activityï¼Œæ‰€ä»¥ startActivit = trueï¼Œé‚£ä¹ˆå°†ä¼šè·å–å¯åŠ¨ä¸»é¢˜\n        ï¼ˆä¹Ÿå°±æ˜¯ Android é«˜ç‰ˆæœ¬æ¯ä¸ªåº”ç”¨å¯åŠ¨éƒ½ä¼šæ˜¾ç¤ºçš„å¼€å±é¡µï¼Ÿï¼‰\n        2ã€å¼€å±ä¸»é¢˜æ˜¯å¯ä»¥é‡å†™çš„ï¼Œé¦–å…ˆå°è¯•è·å–æ˜¯å¦é‡æ–°äº†å¼€å±ä¸»é¢˜ï¼Œå°†è·å–ä¸»é¢˜èµ„æºåç§°\n        3ã€å¦‚æœæ²¡æœ‰é‡å†™ï¼Œå°†ä¼šé€šè¿‡ ATMS æ ¹æ®åŒ…åå’Œç”¨æˆ·IDè·å–ä¸»é¢˜èµ„æºåç§°\n        4ã€å¦‚æœè·å–åˆ°å¼€å±ä¸»é¢˜èµ„æºåç§°ï¼Œé‚£ä¹ˆå°†æ ¹æ®åŒ…åé€šè¿‡ createPackageContext åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œ\n           æ¥ç€æ ¹æ®ä¸Šä¸‹æ–‡å’Œä¸»é¢˜åç§°è·å–èµ„æºIDï¼ˆ0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„å¼€å±ä¸»é¢˜ï¼‰\n    */\n    final int splashScreenTheme = startActivity ? getSplashscreenTheme() : 0;\n    \n    //è¿™é‡Œä¼šè¯„ä¼°åº”è¯¥ä½¿ç”¨ theme ä¸»é¢˜è¿˜æ˜¯ splashScreenTheme ä¸»é¢˜\n    final int resolvedTheme = evaluateStartingWindowTheme(prev, packageName, theme,\n            splashScreenTheme);\n\n\n    final boolean activityCreated =\n            mState.ordinal() >= STARTED.ordinal() && mState.ordinal() <= STOPPED.ordinal();\n    //å¦‚æœä¸æ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œactivity ä¹Ÿè¿˜æ²¡åˆ›å»ºï¼Œé‚£ä¹ˆæœ¬æ¬¡æ˜¯çƒ­å¯åŠ¨\n    final boolean newSingleActivity = !newTask && !activityCreated\n            && task.getActivity((r) -> !r.finishing && r != this) == null;\n\n    //â€¼ï¸å¯åŠ¨\n    final boolean scheduled = addStartingWindow(packageName, resolvedTheme,\n            compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,\n            prev, newTask || newSingleActivity, taskSwitch, isProcessRunning(),\n            allowTaskSnapshot(), activityCreated, mSplashScreenStyleEmpty);\n}\n```\n\n# addStartingWindow\n\n```java\n//ActivityRecord.java\nboolean addStartingWindow(String pkg, int resolvedTheme, CompatibilityInfo compatInfo,\n        CharSequence nonLocalizedLabel, int labelRes, int icon, int logo, int windowFlags,\n        ActivityRecord from, boolean newTask, boolean taskSwitch, boolean processRunning,\n        boolean allowTaskSnapshot, boolean activityCreated, boolean useEmpty) {\n    //çª—å£è¢«å†»ç»“ï¼Œä¸èƒ½æ˜¾ç¤º\n    if (!okToDisplay()) {\n        return false;\n    }\n\n    if (mStartingData != null) {\n        return false;\n    }\n\n    //å·²æœ‰çª—å£åœ¨æ˜¾ç¤ºï¼Œä¸èƒ½å†æ˜¾ç¤ºäº†\n    final WindowState mainWin = findMainWindow();\n    if (mainWin != null && mainWin.mWinAnimator.getShown()) {\n        return false;\n    }\n\n    final TaskSnapshot snapshot =\n            mWmService.mTaskSnapshotController.getSnapshot(task.mTaskId, task.mUserId,\n                    false /* restoreFromDisk */, false /* isLowResolution */);\n                    \n     //STARTING_WINDOW_TYPE_NONEã€STARTING_WINDOW_TYPE_SNAPSHOTã€STARTING_WINDOW_TYPE_SPLASH_SCREEN\n    final int type = getStartingWindowType(newTask, taskSwitch, processRunning,\n            allowTaskSnapshot, activityCreated, snapshot);\n\n    //é€æ¸çš„ï¼Œè¿™é‡Œä¼¼ä¹æ›´å¤šçš„æ˜¯å’Œ window çª—å£ç›¸å…³ï¼ˆéº»äº†éº»äº†ï¼Œæˆ‘åªæƒ³çœ‹ activity ç›¸å…³ï¼Œç»†èŠ‚å¤ªéš¾äº†ï¼‰\n    if (type == STARTING_WINDOW_TYPE_SNAPSHOT) {\n        if (isActivityTypeHome()) {\n            mWmService.mTaskSnapshotController.removeSnapshotCache(task.mTaskId);\n            if ((mDisplayContent.mAppTransition.getTransitFlags()\n                    & WindowManager.TRANSIT_FLAG_KEYGUARD_GOING_AWAY_NO_ANIMATION) == 0) {\n                return false;\n            }\n        }\n        \n        //ã€åˆ†æ”¯ä¸€ã€‘\n        return createSnapshot(snapshot, typeParameter);\n    }\n\n\n    ProtoLog.v(WM_DEBUG_STARTING_WINDOW, \"Creating SplashScreenStartingData\");\n    mStartingData = new SplashScreenStartingData(mWmService, pkg,\n            resolvedTheme, compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,\n            getMergedOverrideConfiguration(), typeParameter);\n            \n    //ã€åˆ†æ”¯äºŒã€‘\n    scheduleAddStartingWindow();\n    return true;\n}\n```\n\nä¸Šè¿°æ— è®ºæ˜¯**åˆ†æ”¯ä¸€ã€åˆ†æ”¯äºŒ**ï¼Œéƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•`scheduleAddStartingWindow`ã€‚\n\n# scheduleAddStartingWindow\n\n```java\n//ActivityRecord.java\nvoid scheduleAddStartingWindow() {\n    if (StartingSurfaceController.DEBUG_ENABLE_SHELL_DRAWER) {\n        mAddStartingWindow.run();\n    } else {\n        //æŠŠæ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—æœ€å‰é¢ä¼˜å…ˆå¤„ç†ï¼Ÿ\n        if (!mWmService.mAnimationHandler.hasCallbacks(mAddStartingWindow)) {\n            //mWmServiceï¼šWindowManagerService\n            //mAnimationHandlerï¼šfinal Handler mAnimationHandler = new Handler(AnimationThread.getHandler().getLooper());\n            mWmService.mAnimationHandler.postAtFrontOfQueue(mAddStartingWindow);\n        }\n    }\n}\n```\n\nè¿™é‡Œçš„äº‹æƒ…å’Œ window çª—å£å…³ç³»å¯†åˆ‡ï¼Œsurface çœ‹ç€ç»˜åˆ¶ç›¸å…³ã€‚\n\n```java\n//ActivityRecord.java\n\nprivate final AddStartingWindow mAddStartingWindow = new AddStartingWindow();\n\nprivate class AddStartingWindow implements Runnable {\n\n    @Override\n    public void run() {\n        //ç•¥ç•¥ç•¥ï¼Œçœ‹ä¸å‡ºå®ƒå¹²äº†å•¥\n    }\n}\n```\n\nçª—å£ç›¸å…³çš„åˆ°æ­¤ä¸ºæ­¢å§ï¼Œå†è¿›å…¥çœ‹ä¸æ‡‚äº†ã€‚æˆ‘æ›´å…³æ³¨çš„æ˜¯ activity å£°æ˜å‘¨æœŸå›è°ƒï¼Œå¯è¿Ÿè¿Ÿæ²¡æœ‰çœ‹è§ğŸ’”\n\n---\n\né‚£ä¹ˆè¿™æˆ‘ä»¬å§‘ä¸”ä»–æˆåŠŸåœ°æŠŠ activity æ·»åŠ åˆ° window ä¸Šï¼Œç°åœ¨æ˜¯æ—¶å€™å›å¤´çœ‹çœ‹**å¯åŠ¨æˆåŠŸååšäº†äº›ä»€ä¹ˆï¼Ÿ** æ‰€ä»¥æˆ‘ä»¬å›åˆ° `ActivityStarter.java`ï¼Œè‡ªç„¶è¿˜æ˜¯å›åˆ°è¿™é‡Œ ~~ï¼ˆä»å“ªæ¥ï¼Œå›å“ªå»å§ï¼‰~~\n\n\n# The callback [onNewIntent]\n\nè¿™é‡Œè®² `Activity onNewIntent(Intent intent)` ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå…¶å®åƒ onCreatã€onResume ç­‰ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œå…¶ä»–çš„ä¸é‡å¤ã€‚\n\n## deliverToCurrentTopIfNeeded\n\n```java\n//ActivityStarter.java\nint startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n        \n\n    //å¦‚æœæ­£åœ¨å¯åŠ¨çš„ activity å’Œä»»åŠ¡æ ˆé¡¶éƒ¨çš„ activity ç›¸åŒ\n    final Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    if (topRootTask != null) {\n        //é¡¶éƒ¨æ˜¯åŒä¸€ä¸ª activityï¼Œæ— éœ€é‡å¤åˆ›å»ºï¼Œå¯åŠ¨ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„åº”è¯¥å›è°ƒ onNewIntent\n        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    }       \n}\n```\n\n## deliverToCurrentTopIfNeeded\n\n```\nprivate int deliverToCurrentTopIfNeeded(Task topRootTask, NeededUriGrants intentGrants) {\n    //è·å–å½“å‰æ ˆé¡¶ activity\n    final ActivityRecord top = topRootTask.topRunningNonDelayedActivityLocked(mNotTop);\n    \n    //activity ç›¸åŒã€å¯åŠ¨ç”¨æˆ·ç›¸åŒã€æ ˆé¡¶å¤ç”¨ã€å¯åŠ¨ç›®æ ‡\n    final boolean dontStart = top != null\n            && top.mActivityComponent.equals(mStartActivity.mActivityComponent)\n            && top.mUserId == mStartActivity.mUserId\n            && top.attachedToProcess()\n            && ((mLaunchFlags & FLAG_ACTIVITY_SINGLE_TOP) != 0\n            || LAUNCH_SINGLE_TOP == mLaunchMode)\n            && (!top.isActivityTypeHome() || top.getDisplayArea() == mPreferredTaskDisplayArea);\n    if (!dontStart) {\n        return START_SUCCESS;\n    }\n\n    top.getTaskFragment().clearLastPausedActivity();\n    //activity æ˜¾ç¤ºï¼Œåé¢çœ‹\n    if (mDoResume) {\n        mRootWindowContainer.resumeFocusedTasksTopActivities();\n    }\n    \n    //è¿™é‡Œä¼šè¿›å…¥ ActivitRecord\n    deliverNewIntent(top, intentGrants);\n    return START_DELIVERED_TO_TOP;\n}\n```\n\n## deliverNewIntentLocked\n\n```java\n//ActivityRecord.java\nfinal void deliverNewIntentLocked(int callingUid, Intent intent, NeededUriGrants intentGrants,\n\n    if ((mState == RESUMED || mState == PAUSED || isTopActivityWhileSleeping)\n            && attachedToProcess()) {\n        try {\n            ArrayList<ReferrerIntent> ar = new ArrayList<>(1);\n            ar.add(rintent);\n            //å¼€å§‹è°ƒç”¨å£°æ˜å‘¨æœŸç›¸å…³ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡ ClientTransaction\n            //getLifecycleManager -> ClientLifecycleManager å£°æ˜å‘¨æœŸç›¸å…³å›è°ƒéƒ½ä¼šé€šè¿‡å®ƒ\n            mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,\n                    NewIntentItem.obtain(ar, mState == RESUMED));\n            unsent = false;\n        } catch (RemoteException e) {\n            Slog.w(TAG, \"Exception thrown sending new intent to \" + this, e);\n        } catch (NullPointerException e) {\n            Slog.w(TAG, \"Exception thrown sending new intent to \" + this, e);\n        }\n    }\n    \n    if (unsent) {\n        addNewIntentLocked(rintent);\n    }\n}\n```\n\n\n```java\n//ClientLfecycleManager.java\nvoid scheduleTransaction(ClientTransaction transaction) throws RemoteException {\n    //åˆ›å»ºä¸€ä¸ªäº‹ç‰©ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œå…³é”®æ˜¯è¿™ä¸ªæ˜¯äº‹åŠ¡ï¼ˆbinder)äº‹åŠ¡ä¼ é€’æ•°æ®çš„ï¼Œæˆ–åˆ™äº‹åŠ¡å‘é€åå°†åœ¨å“ªé‡Œå¤„ç†äº‹åŠ¡ï¼Ÿï¼Ÿï¼Ÿ\n    final IApplicationThread client = transaction.getClient();\n    transaction.schedule();\n    if (!(client instanceof Binder)) {\n        transaction.recycle();\n    }\n}\n```\n\n## ClientTransaction.schedule\n\n`ClientTransaction`: A container that holds a sequence of messages, which may be sent to a client. This includes a list of callbacks and a final lifecycle state.\n\n\n```java\n//ClientTransaction.java\n\n/*\n    1ã€IApplicationThread è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ aidl æ¥å£ï¼Œæ¥å£å®ç°è‡ªç„¶æ˜¯ IApplicationThread.Sub\n    2ã€å®ç°ç±»åœ¨ ActivityThreadï¼Œprivate class ApplicationThread extends IApplicationThread.Stub \n*/\nprivate IApplicationThread mClient;\n\n\n/**\n * Schedule the transaction after it was initialized. It will be send to client and all its\n * individual parts will be applied in the following sequence:\n * 1. The client calls {@link #preExecute(ClientTransactionHandler)}, which triggers all work\n *    that needs to be done before actually scheduling the transaction for callbacks and\n *    lifecycle state request.\n * 2. The transaction message is scheduled.\n * 3. The client calls {@link TransactionExecutor#execute(ClientTransaction)}, which executes\n *    all callbacks and necessary lifecycle transitions.\n */\npublic void schedule() throws RemoteException \n    mClient.scheduleTransaction(this);\n}\n```\n\n\n## ApplicationThread.scheduleTransaction\n\n```java\n//ActivityThread.java\nprivate class ApplicationThread extends IApplicationThread.Stub{\n\n    @Override\n    public void scheduleTransaction(ClientTransaction transaction) throws RemoteException {\n        //åœ¨å½“å‰ç±»æ–‡ä»¶æœç´¢æ²¡çœ‹åˆ°æ–¹æ³•å®šä¹‰ï¼Œå·®ç‚¹æ€€ç–‘äººç”Ÿï¼›ç„¶åçœ‹çœ‹ ActivitThread è¿˜æœ‰çˆ¶ç±»ï¼Œé‚£æ–¹æ³•å®šä¹‰å°±åœ¨çˆ¶ç±»äº†\n        ActivityThread.this.scheduleTransaction(transaction);\n    }\n}\n```\n\n```java\npublic final class ActivityThread extends ClientTransactionHandler\n        implements ActivityThreadInternal {  \n}\n```\n\n```java\npublic abstract class ClientTransactionHandler {\n\n    void scheduleTransaction(ClientTransaction transaction) {\n        transaction.preExecute(this);\n        //å‘é€æ¶ˆæ¯ï¼Œé‚£è€…å°±æ˜ç¡®å¾ˆå¤šäº†\n        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);\n    }\n```\n\n```java\n//ActivityThread.java\nclass H extends Handler {\n    \n    public static final int EXECUTE_TRANSACTION = 159;\n\n    public void handleMessage(Message msg) {\n        switch (msg.what) {\n            case EXECUTE_TRANSACTION:\n                //å›å¤´çœ‹çœ‹ schedule çš„æ³¨é‡Šï¼Œä¸‹ä¸€æ­¥åº”è¯¥ä¼šåˆ°å“ªé‡Œå»æ‰§è¡Œï¼Œå…¶å®åˆ«äººæ˜¯å†™å¾—å¾ˆæ¸…æ¥šçš„ï¼ˆç†Ÿèƒ½ç”Ÿå·§ï¼Œåˆçœ‹ç¡®å®ä¸€å¤´é›¾æ°´ï¼‰\n                final ClientTransaction transaction = (ClientTransaction) msg.obj;\n                mTransactionExecutor.execute(transaction);\n                if (isSystem()) {\n                    transaction.recycle();\n                }\n            break;\n        }\n     }\n}\n```\n\n## TransactionExecutor.excute\n\n```java\n//TransactionExecutor.java\npublic void execute(ClientTransaction transaction) {\n    if (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + \"Start resolving transaction\");\n\n    //ä¼¼ä¹æ¯ä¸€ä¸ª activity éƒ½æœ‰ä¸€ä¸ª tokenï¼Œè¿˜ä¸æ¸…æ¥šä»ä½•è€Œæ¥\n    //åˆå­¦ Android æ—¶ï¼Œå…³äº activity token çš„æŠ¥é”™ä¼°è®¡ä½ ä¹Ÿé‡åˆ°è¿‡\n    final IBinder token = transaction.getActivityToken();\n    if (token != null) {\n        final Map<IBinder, ClientTransactionItem> activitiesToBeDestroyed =\n                mTransactionHandler.getActivitiesToBeDestroyed();\n        final ClientTransactionItem destroyItem = activitiesToBeDestroyed.get(token);\n        if (destroyItem != null) {\n            if (transaction.getLifecycleStateRequest() == destroyItem) {\n                activitiesToBeDestroyed.remove(token);\n            }\n            if (mTransactionHandler.getActivityClient(token) == null) {\n                return;\n            }\n        }\n    }\n    \n    //è¿™ä¸ªæš‚ä¸å…³æ³¨ï¼Œé‡ç‚¹çœ‹çœ‹ä¸‹é¢çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒå§\n    executeCallbacks(transaction);\n    \n    /*\n        1ã€cycleToPath(r, lifecycleItem.getTargetState(), true , transaction);  -> performLifecycleSequence\n        \n        //çœ‹äº†ä¸€åœˆï¼Œç€ä¸¤ä¸ªå®ç°åº”è¯¥æ˜¯åœ¨å­ç±»\n        2ã€lifecycleItem.execute(mTransactionHandler, token, mPendingActions);\n        3ã€lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);\n    */\n    executeLifecycleState(transaction);\n    mPendingActions.clear();\n    if (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + \"End resolving transaction\");\n}\n```\n\n\n```java\n//TransactionExecutor.java\nprivate void performLifecycleSequence(ActivityClientRecord r, IntArray path,\n        ClientTransaction transaction) {\n    final int size = path.size();\n    for (int i = 0, state; i < size; i++) {\n        state = path.get(i);\n        \n        //æ˜¯å§ï¼Œå‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒéƒ½æœ‰ï¼›é‚£å°±å¥‡æ€ªäº†æ€ä¹ˆæ²¡æœ‰ onNewIntentï¼Œä»–ä¸ç®—æ˜¯ç”Ÿå‘½å‘¨æœŸå‡½æ•°å—ï¼Ÿ\n        //å’šå’šå’šå’šï¼ˆæ•²é»‘æ¿ï½ï¼‰\n        /*\n            1ã€onNewIntent ä¸æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œåªæ˜¯å£°æ˜å‘¨æœŸå›è°ƒè¿‡ç¨‹ä¸­å¯èƒ½è¢«æ‰§è¡Œçš„ä¸€ä¸ªæ–¹æ³•\n            2ã€å¦‚æœæ»¡è¶³æŸäº›æ¡ä»¶ï¼Œæ ¹æ®ç»éªŒæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•åœ¨ onResume ä¹‹å‰ä¼šæ‰§è¡Œ\n            3ã€é‚£ä¹ˆæˆ‘ä»¬çŒœæµ‹ï¼ˆæˆ‘çœ‹äº†ä»£ç å†æ¥çŒœæµ‹çš„ğŸ˜ï¼‰ï¼Œè¯¥æ–¹æ³•çš„å›è°ƒæœ‰æ²¡æœ‰å¯èƒ½åœ¨ handleResumeActivity é‡Œé¢æ‰§è¡Œï¼Ÿé‚£å°±å»çœ‹çœ‹å§ï¼\n        */\n        switch (state) {\n            case ON_CREATE:\n                mTransactionHandler.handleLaunchActivity(r, mPendingActions,\n                        null /* customIntent */);\n                break;\n            case ON_START:\n                mTransactionHandler.handleStartActivity(r, mPendingActions,\n                        null /* activityOptions */);\n                break;\n            case ON_RESUME:\n                mTransactionHandler.handleResumeActivity(r, false /* finalStateRequest */,\n                        r.isForward, \"LIFECYCLER_RESUME_ACTIVITY\");\n                break;\n            case ON_PAUSE:\n                mTransactionHandler.handlePauseActivity(r, false /* finished */,\n                        false /* userLeaving */, 0 /* configChanges */, mPendingActions,\n                        \"LIFECYCLER_PAUSE_ACTIVITY\");\n                break;\n            case ON_STOP:\n                mTransactionHandler.handleStopActivity(r, 0 /* configChanges */,\n                        mPendingActions, false /* finalStateRequest */,\n                        \"LIFECYCLER_STOP_ACTIVITY\");\n                break;\n            case ON_DESTROY:\n                mTransactionHandler.handleDestroyActivity(r, false /* finishing */,\n                        0 /* configChanges */, false /* getNonConfigInstance */,\n                        \"performLifecycleSequence. cycling to:\" + path.get(size - 1));\n                break;\n            case ON_RESTART:\n                mTransactionHandler.performRestartActivity(r, false /* start */);\n                break;\n            default:\n                throw new IllegalArgumentException(\"Unexpected lifecycle state: \" + state);\n        }\n    }\n}\n```\n\nClientTransactionHandler æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥å£°æ˜å‘¨æœŸå›è°ƒè¿˜å¾—æ‰¾ ClientTransactionHandler çš„å®ç°ç±» `ActivitThread`ã€‚\n\nç»•ä¸€åœˆåˆå›æ¥ï¼Œè¿™è¿™è¿™ï½ï½ï½\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69c055d008d74b45bd1205352739f8b9~tplv-k3u1fbpfcp-watermark.image?)\n\n\n## ActivitThread.performResumeActivity\n\n```java\n//ActivityThread.java\npublic boolean performResumeActivity(ActivityClientRecord r, boolean finalStateRequest,\n        String reason) {\n\n    if (r.activity.mFinished) {\n        return false;\n    }\n    \n    //å·²ç» resumed å°±ä¸é‡å¤äº†\n    if (r.getLifecycleState() == ON_RESUME) {\n        if (!finalStateRequest) {\n            final RuntimeException e = new IllegalStateException(\n                    \"Trying to resume activity which is already resumed\");\n        }\n        return false;\n    }\n    \n    if (finalStateRequest) {\n        r.hideForNow = false;\n        r.activity.mStartedActivity = false;\n    }\n    \n    try {\n        r.activity.onStateNotSaved();\n        r.activity.mFragments.noteStateNotSaved();\n        checkAndBlockForNetworkAccess();\n        //çœ‹åˆ°æ²¡ï¼Œæ»¡è¶³æŸäº›æ¡ä»¶æƒ…å†µä¸‹æ˜¯ä¼šèµ° onNewIntent \n        if (r.pendingIntents != null) {\n            deliverNewIntents(r, r.pendingIntents);\n            r.pendingIntents = null;\n        }\n        \n        if (r.pendingResults != null) {\n            deliverResults(r, r.pendingResults, reason);\n            r.pendingResults = null;\n        }\n        \n        //onResume å›è°ƒåœ¨è¿™é‡Œï¼Œæœ¬æ¬¡æˆ‘ä»¬æš‚ä¸å…³æ³¨\n        r.activity.performResume(r.startsNotResumed, reason);\n\n        //æŠŠçŠ¶æ€è®¾ç½®ä¸€ä¸‹\n        r.state = null;\n        r.persistentState = null;\n        r.setState(ON_RESUME);\n\n        reportTopResumedActivityChanged(r, r.isTopResumedActivity, \"topWhenResuming\");\n    } catch (Exception e) {\n        if (!mInstrumentation.onException(r.activity, e)) {\n            throw new RuntimeException(\"Unable to resume activity \"\n                    + r.intent.getComponent().toShortString() + \": \" + e.toString(), e);\n        }\n    }\n    return true;\n}\n```\n\n```java\n//ActivityThread.java\nprivate void deliverNewIntents(ActivityClientRecord r, List<ReferrerIntent> intents) {\n    final int N = intents.size();\n    for (int i=0; i<N; i++) {\n        ReferrerIntent intent = intents.get(i);\n        intent.setExtrasClassLoader(r.activity.getClassLoader());\n        intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),\n                r.activity.getAttributionSource());\n        r.activity.mFragments.noteStateNotSaved();\n        //æœ€åè¿˜æ˜¯äº¤ç»™ â€˜å¤§ç®¡å®¶â€™ æ‰§è¡Œå•Šï¼Œå›åˆ°äº†é‚£ä¸ªç†Ÿæ‚‰çš„å¯¹è±¡\n        mInstrumentation.callActivityOnNewIntent(r.activity, intent);\n    }\n}\n```\n\n## Instrumentation.callActivityOnNewIntent\n\n```java\n//Instrumentation.java\npublic void callActivityOnNewIntent(Activity activity, ReferrerIntent intent) {\n    final String oldReferrer = activity.mReferrer;\n    try {\n        if (intent != null) {\n            activity.mReferrer = intent.mReferrer;\n        }\n        callActivityOnNewIntent(activity, intent != null ? new Intent(intent) : null);\n    } finally {\n        activity.mReferrer = oldReferrer;\n    }\n}\n```\n\n```java\n//Instrumentation.java\npublic void callActivityOnNewIntent(Activity activity, Intent intent) {\n    //ä»€ä¹ˆï¼ŸInstrumentation ä¸ç†Ÿæ‚‰ï¼Ÿ\n    //é‚£ activity æ€»è¯¥ç†Ÿæ‚‰äº†å§\n    activity.performNewIntent(intent);\n}\n```\n\n```java\n//Activity.java\nfinal void performNewIntent(@NonNull Intent intent) {\n    mCanEnterPictureInPicture = true;\n    onNewIntent(intent);\n}\n```\n\n```java\n//Activity.java\nprotected void onNewIntent(Intent intent) {\n}\n```\n\nå°±åˆ°è¿™é‡Œç»“æŸå§ï¼Œçœ‹èµ·æ¥æ²¡é‚£ä¹ˆåƒæ ·ã€‚è™½ç„¶æ˜¯ `æ¡Œé¢å¯åŠ¨`ï¼Œåæ¥è¶Šæ„Ÿè§‰åƒæ˜¯ `Activity å¯åŠ¨`ã€‚~~éƒ½ä¹±å¥—äº†~~ ï¼Œå¯æ˜¯ï¼Œæ¡Œé¢ä¸ä¹Ÿæ˜¯ä¸€ä¸ª activity å—ğŸ¤”ï¸","source":"_posts/undefined/Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨äºŒ.md","raw":"---\ntitle: Android ç³»ç»Ÿ Homeï¼ˆäºŒï¼‰\ncatalog: true\ndate: 2022-09-29 22:58:04\nsubtitle: å¯åŠ¨æ¡Œé¢å°±æ˜¯æŸ¥æ‰¾å¹¶å¯åŠ¨ Activity\nheader-img: /img/220928/android_sysserver_bg.png\ntags: AOSP\nsticky: 9\ncategories:\n---\n\næ¡Œé¢å¯åŠ¨ç±»ä¼¼ Activity å¯åŠ¨ï¼Œæ¥ç€ä¸Šä¸€ç« èŠ‚ç»§ç»­æŸ¥é˜…å¯åŠ¨æµç¨‹ï¼Œå¯åŠ¨é™åˆ¶ã€å¯åŠ¨æ¡ä»¶æ£€æŸ¥æ˜¯é‡ç‚¹ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šé€æ­¥å›è°ƒç»™å¤–éƒ¨ï¼Œè¿™é‡Œåªæ˜¯ç²—ç•¥æè¿°å¯åŠ¨è¿‡ç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…æ‹¬çª—å£çš„åˆ›å»ºã€ç»˜åˆ¶ç­‰ç­‰ã€‚\n\n# startActivityUnchecked\n\n```java\n//ActivityStarter.java\nprivate int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n    int result = START_CANCELED;\n    boolean startResultSuccessful = false;\n    final Task startedActivityRootTask;\n\n    //TRANSIT_OPENï¼šåˆ›å»ºä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„æ–°çª—å£ï¼Œå¹¶ä¸”è®©çª—å£å¯è§\n    //transitType è¿˜ä¼šå½±å“çª—å£ç»˜åˆ¶æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤æ˜¯ 5ç§’ï¼Œå¦‚æœæ˜¯ chenge ç±»å‹å»¶æ—¶å°†ç¼©çŸ­åˆ° 2 ç§’\n    //ä¹Ÿä¼šæŠŠ windowContain æ·»åŠ åˆ°é›†åˆä¸­ï¼Œç­‰å¾…çª—å£ç»˜åˆ¶\n    final TransitionController transitionController = r.mTransitionController;\n    Transition newTransition = (!transitionController.isCollecting()\n            && transitionController.getTransitionPlayer() != null)\n            ? transitionController.createTransition(TRANSIT_OPEN) : null;\n    RemoteTransition remoteTransition = r.takeRemoteTransition();\n    if (newTransition != null && remoteTransition != null) {\n        newTransition.setRemoteTransition(remoteTransition);\n    }\n    transitionController.collect(r);\n    final boolean isTransient = r.getOptions() != null && r.getOptions().getTransientLaunch();\n    \n    \n    try {\n        //å»¶è¿Ÿçª—å£æµ‹é‡ï¼Œåˆä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å˜é‡ mDeferDepth++ï¼Œæ§åˆ¶æµ‹é‡ã€ç»˜åˆ¶æ¬¡æ•°ï¼Œé¿å…é€’å½’å¾ªç¯\n        mService.deferWindowLayout();\n        //â€¼ï¸åˆæ˜¯ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ\n        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,\n                startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,\n                intentGrants);\n        startResultSuccessful = ActivityManager.isStartResultSuccessful(result);\n        final boolean taskAlwaysOnTop = options != null && options.getTaskAlwaysOnTop();\n        // Apply setAlwaysOnTop when starting an Activity is successful regardless of creating\n        // a new Activity or recycling the existing Activity.\n        if (taskAlwaysOnTop && startResultSuccessful) {\n            final Task targetRootTask =\n                    mTargetRootTask != null ? mTargetRootTask : mTargetTask.getRootTask();\n            targetRootTask.setAlwaysOnTop(true);\n        }\n    } finally {\n        Trace.traceEnd(Trace.TRACE_TAG_WINDOW_MANAGER);\n        //â€¼ï¸æ— è®ºæˆåŠŸå¤±è´¥ä¸å¦ï¼Œå¯åŠ¨è§£é‡Šéƒ½åº”è¯¥åˆ†å‘å‡ºå»\n        startedActivityRootTask = handleStartResult(r, result);\n        //å»¶æ—¶çª—å£æµ‹é‡å°†è¢«æ¢å¤\n        mService.continueWindowLayout();\n        mSupervisor.mUserLeaving = false;\n    }\n\n    postStartActivityProcessing(r, result, startedActivityRootTask);\n\n    return result;\n}\n```\n\n## about TransitionType\n```\n@IntDef(prefix = { \"TRANSIT_\" }, value = {\n        TRANSIT_NONE,\n        TRANSIT_OPEN,                 //åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œå¹¶ä¸”ä½¿å…¶å¯è§\n        TRANSIT_CLOSE,                //å¯è§çš„çª—å£è¢«å…³é—­ï¼ˆfinished æˆ– destroyedï¼‰\n        TRANSIT_TO_FRONT,             //ä¸å¯è§çš„çª—å£å°†å˜ä¸ºå¯è§\n        TRANSIT_TO_BACK,              //å¯è§çš„çª—å£å˜ä¸ºä¸å¯è§\n        TRANSIT_RELAUNCH,\n        TRANSIT_CHANGE,               //å¯è§çª—å£å‘ç”Ÿæ”¹å˜ï¼ˆæ¯”å¦‚å±å¹•æ–¹å‘ã€å¤§å°æ”¹å˜ï¼‰\n        TRANSIT_KEYGUARD_GOING_AWAY,  //ï¼ˆå·²åºŸå¼ƒï¼‰\n        TRANSIT_KEYGUARD_OCCLUDE,     //é”®ç›˜é”å®š\n        TRANSIT_KEYGUARD_UNOCCLUDE,   //é”®ç›˜è§£é”\n        TRANSIT_PIP,                  //ç”»ä¸­ç”»\n        TRANSIT_WAKE,                 //ï¼ˆæ­£åœ¨æ‰“å¼€ï¼Ÿï¼‰\n        TRANSIT_FIRST_CUSTOM\n})\n@Retention(RetentionPolicy.SOURCE)\n@interface TransitionType {}\n```\n\n# startActivityInner\n\n```java\n//ActivityStarter.java\nint startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n    setInitialState(r, options, inTask, inTaskFragment, doResume, startFlags, sourceRecord,\n            voiceSession, voiceInteractor, restrictedBgActivity);\n\n    //ç¡®å®š activity æ‰€å¯åŠ¨çš„ä»»åŠ¡æ ˆåº”è¯¥æ˜¯ NEW_TASK è¿˜æ˜¯åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆå¯åŠ¨\n    computeLaunchingTaskFlags();\n    computeSourceRootTask();\n    mIntent.setFlags(mLaunchFlags);\n\n    //å¦‚æœè¯·æ±‚å·²ç»å¼€å§‹ï¼Œåº”è¯¥å†»ç»“æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ï¼Œç­‰å¾…ä¸‹æ¬¡æ›´æ–°\n    final Task prevTopTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    final Task reusedTask = getReusableTask();\n    if (mOptions != null && mOptions.freezeRecentTasksReordering()\n            && mSupervisor.mRecentTasks.isCallerRecents(r.launchedFromUid)\n            && !mSupervisor.mRecentTasks.isFreezeTaskListReorderingSet()) {\n        mFrozeTaskList = true;\n        mSupervisor.mRecentTasks.setFreezeTaskListReordering();\n    }\n\n    //è®¡ç®—æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡æ ˆå¯ä»¥å¤ç”¨ï¼Œå¦åˆ™åº”è¯¥åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆ\n    final Task targetTask = reusedTask != null ? reusedTask : computeTargetTask();\n    final boolean newTask = targetTask == null;\n    mTargetTask = targetTask;\n\n    //ç¡®å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚ windowType\n    computeLaunchParams(r, sourceRecord, targetTask);\n\n    //åˆæ˜¯ä¸€ç•ªå¯åŠ¨é™åˆ¶ï¼Œåœ¨ä»»åŠ¡æ ˆå±‚é¢é™åˆ¶å¯åŠ¨ğŸš«\n    int startResult = isAllowedToStart(r, newTask, targetTask);\n    if (startResult != START_SUCCESS) {\n        return startResult;\n    }\n\n    //å¤ç”¨ä»»åŠ¡æ ˆ\n    final ActivityRecord targetTaskTop = newTask\n            ? null : targetTask.getTopNonFinishingActivity();\n    if (targetTaskTop != null) {\n        /*\n            1ã€resumeTargetRootTaskIfNeeded\n            2ã€mRootWindowContainer.resumeFocusedTasksTopActivities\n        */\n        startResult = recycleTask(targetTask, targetTaskTop, reusedTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    } else {\n        mAddingToTask = true;\n    }\n\n    /*\n        1ã€å¦‚æœå¯åŠ¨çš„ activity æ˜¯åœ¨ä»»åŠ¡æ ˆä¸­å·²å­˜åœ¨ï¼Œåˆ™åªéœ€å¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶è°ƒç”¨ activity çš„ onNewIntent æ–¹æ³•å³å¯\n        2ã€å›è°ƒæ–¹æ³• deliverNewIntent(top, intentGrants); ActivityRecorder#deliverNewIntentLocked\n        3ã€mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,\n        NewIntentItem.obtain(ar, mState == RESUMED));\n    */\n    final Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    if (topRootTask != null) {\n        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    }\n\n    //è¿˜æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨\n    if (mTargetRootTask == null) {\n        mTargetRootTask = getLaunchRootTask(mStartActivity, mLaunchFlags, targetTask, mOptions);\n    }\n    if (newTask) {\n        final Task taskToAffiliate = (mLaunchTaskBehind && mSourceRecord != null)\n                ? mSourceRecord.getTask() : null;\n        setNewTask(taskToAffiliate);\n    } else if (mAddingToTask) {\n        addOrReparentStartingActivity(targetTask, \"adding to task\");\n    }\n\n    //å¯åŠ¨çš„ç›®æ ‡ä»»åŠ¡æ ˆæœ‰äº†ï¼Œç›´æ¥çœ‹ activity å¯åŠ¨\n    final Task startedTask = mStartActivity.getTask();\n    final boolean isTaskSwitch = startedTask != prevTopTask && !startedTask.isEmbedded();\n    \n    //å¯åŠ¨\n    mTargetRootTask.startActivityLocked(mStartActivity,\n            topRootTask != null ? topRootTask.getTopNonFinishingActivity() : null, newTask,\n            isTaskSwitch, mOptions, sourceRecord);\n    if (mDoResume) {\n        final ActivityRecord topTaskActivity = startedTask.topRunningActivityLocked();\n        //å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶æ²¡æœ‰è·å¾—ç„¦ç‚¹ï¼Œå¹¶ä¸”å½“å‰å¯åŠ¨çš„ä¸æ˜¯æœ¬æ¬¡æƒ³å¯åŠ¨çš„ï¼Œä¹Ÿè¦ç¡®ä¿å®ƒæ˜¾ç¤ºï¼ˆå®ƒå¯èƒ½æ˜¯æ›´é‡è¦çš„ activity æŠ¢å…ˆæ˜¾ç¤ºå‘¢ï¼‰\n        if (!mTargetRootTask.isTopActivityFocusable()\n                || (topTaskActivity != null && topTaskActivity.isTaskOverlay()\n                && mStartActivity != topTaskActivity)) {\n                \n            mTargetRootTask.ensureActivitiesVisible(null /* starting */,\n            mTargetRootTask.mDisplayContent.executeAppTransition();\n        } else {\n            //å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶å·²è·å¾—ç„¦ç‚¹ï¼Œå¦‚æœè¯¥ä»»åŠ¡æ ˆæ²¡æœ‰æ˜¾ç¤ºåœ¨æœ€å‰åˆ™ moveToFront\n            if (mTargetRootTask.isTopActivityFocusable()\n                    && !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) {\n                mTargetRootTask.moveToFront(\"startActivityInner\");\n            }\n            \n            //è¿™é‡Œå’Œä¸Šè¿° recycleTask ç›¸ä¼¼ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ã€‚ï¼ˆæŠŠ activity è½¬ç§»ä¸ºå¯è§çŠ¶æ€ï¼‰\n            mRootWindowContainer.resumeFocusedTasksTopActivities(\n                    mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);\n        }\n    }\n    \n    //å¯åŠ¨å®Œæ¯•éœ€è¦æ›´æ–°æœ€è¿‘ä»»åŠ¡æ ˆç­‰\n    mRootWindowContainer.updateUserRootTask(mStartActivity.mUserId, mTargetRootTask);\n    mSupervisor.mRecentTasks.add(startedTask);\n    mSupervisor.handleNonResizableTaskIfNeeded(startedTask,\n            mPreferredWindowingMode, mPreferredTaskDisplayArea, mTargetRootTask);\n\n    return START_SUCCESS;\n}\n```\n\n## isAllowedToStart\n\næ£€æŸ¥ activity æ˜¯å¦å¯ä»¥åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆæˆ–è€…æ–°çš„ä»»åŠ¡æ ˆä¸­å¯åŠ¨ã€‚\n\n```java\n//ActivityStarter.java\nprivate int isAllowedToStart(ActivityRecord r, boolean newTask, Task targetTask) {\n    //âŒ1ã€æ²¡æœ‰åŒ…åæ˜¯ä¸å…è®¸çš„ï¼ˆæ¯ä¸ª activity éƒ½æœ‰æ‰€å±çš„åŒ…ï¼‰\n    if (mStartActivity.packageName == null) {\n        if (mStartActivity.resultTo != null) {\n            mStartActivity.resultTo.sendResult(INVALID_UID, mStartActivity.resultWho,\n                    mStartActivity.requestCode, RESULT_CANCELED,\n                    null /* data */, null /* dataGrants */);\n        }\n        ActivityOptions.abort(mOptions);\n        return START_CLASS_NOT_FOUND;\n    }\n\n    /*\n        1ã€åº”ç”¨å¤„äº instrument çŠ¶æ€æ—¶ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨\n        2ã€å¦‚æœæ˜¯ VR æ˜¾ç¤ºIDæˆ–è€…é»˜è®¤æ˜¾ç¤ºIDï¼Œå…è®¸å¯åŠ¨\n        3ã€launchMode != SINGLE_TASK && launchMode != SINGLE_INSTANCE å±äºå·²æœ‰å¯åŠ¨çŠ¶æ€ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨\n    */\n    if (r.isActivityTypeHome()) {\n        if (!mRootWindowContainer.canStartHomeOnDisplayArea(r.info, mPreferredTaskDisplayArea,\n                true /* allowInstrumenting */)) {\n            return START_CANCELED;\n        }\n    }\n\n    /*\n        1ã€âŒå¦‚æœæ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„\n        2ã€âŒå¦‚æœè°ƒç”¨è€… uid ä¸æ˜¯å½“å‰ç¨‹åºï¼ˆå½“å‰ä»»åŠ¡æ ˆï¼‰ï¼Œå¯åŠ¨æ—¶ä¸å…è®¸çš„\n        3ã€âŒå¦‚æœæ˜¯éœ€è¦åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„\n    */\n    boolean blockBalInTask = (newTask\n            || !targetTask.isUidPresent(mCallingUid)\n            || (LAUNCH_SINGLE_INSTANCE == mLaunchMode && targetTask.inPinnedWindowingMode()));\n    // mRestrictedBgActivityï¼šä¸¥æ ¼æŠŠæ§ activity çš„å¯åŠ¨ğŸš«ï¼ˆè¯¥æ¡ä»¶å‰ä¸€ç¯‡æœ‰æåˆ°ï¼‰\n    if (mRestrictedBgActivity && blockBalInTask\n            && handleBackgroundActivityAbort(mStartActivity)) {\n        return START_ABORTED;\n    }\n\n    //è¿˜æ˜¯åœ¨ä¸æ–­é™åˆ¶å¯åŠ¨ï¼Œæ¡ä»¶è‹›åˆ»å•Š\n    final boolean isNewClearTask =\n            (mLaunchFlags & (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))\n                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK);\n    if (!newTask) {\n        if (mService.getLockTaskController().isLockTaskModeViolation(targetTask,\n                isNewClearTask)) {\n            return START_RETURN_LOCK_TASK_MODE_VIOLATION;\n        }\n    } else {\n        if (mService.getLockTaskController().isNewTaskLockTaskModeViolation(mStartActivity)) {\n            return START_RETURN_LOCK_TASK_MODE_VIOLATION;\n        }\n    }\n\n    if (mInTaskFragment != null && !canEmbedActivity(mInTaskFragment, r, newTask, targetTask)) {\n        return START_PERMISSION_DENIED;\n    }\n\n    //âœ…å¦åˆ™ï¼Œæ˜¯å¯åŠ¨æ˜¯å…è®¸çš„\n    return START_SUCCESS;\n}\n```\n\n## canEmbedActivity\n\næ˜¯å¦å¯ä»¥åµŒå…¥ï¼Ÿactivity åµŒå…¥ï¼Ÿ\n\n```java\n//ActivityStarter.java\nprivate boolean canEmbedActivity(@NonNull TaskFragment taskFragment, ActivityRecord starting,\n        boolean newTask, Task targetTask) {\n    final Task hostTask = taskFragment.getTask();\n    if (hostTask == null) {\n        return false;\n    }\n\n    //âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ˜¯å…è®¸åµŒå…¥å¯åŠ¨çš„\n    final int hostUid = hostTask.effectiveUid;\n    if (UserHandle.getAppId(hostUid) == Process.SYSTEM_UID) {\n        return true;\n    }\n\n    //âŒå¦‚æœä¸æ˜¯å½“å‰åº”ç”¨è¿›ç¨‹å¯åŠ¨ï¼Œæ˜¯ä¸å…è®¸çš„\n    if (hostUid != starting.getUid()) {\n        return false;\n    }\n\n    //âŒå¦‚æœä¸æ˜¯åŒä¸€ä¸ªä»»åŠ¡æ ˆï¼ˆä¸»ä»»åŠ¡æ ˆï¼‰ä¸­å¯åŠ¨ï¼Œä¹Ÿæ˜¯ä¸å…è®¸çš„\n    return !newTask && (targetTask == null || targetTask == hostTask);\n}\n```\n\n# startActivityLocked\n```java\n//Task.java\nvoid startActivityLocked(ActivityRecord r, @Nullable ActivityRecord focusedTopActivity,\n        boolean newTask, boolean isTaskSwitch, ActivityOptions options,\n        @Nullable ActivityRecord sourceRecord) {\n    Task rTask = r.getTask();\n    \n    final boolean allowMoveToFront = options == null || !options.getAvoidMoveToFront();\n    final boolean isOrhasTask = rTask == this || hasChild(rTask);\n    \n    //å¯åŠ¨çš„ activity ä¸èƒ½æ˜¯é˜»å¡çš„ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸\n    Task task = null;\n    if (!newTask && isOrhasTask) {\n        final ActivityRecord occludingActivity = getOccludingActivityAbove(r);\n        if (occludingActivity != null) {\n            rTask.positionChildAtTop(r);\n            ActivityOptions.abort(options);\n            return;\n        }\n    }\n\n    //å…è®¸ç§»åŠ¨åˆ°å‰å°ï¼Œå¹¶ä¸”ä¸æ˜¯æ¡Œé¢ç¨‹åºã€æ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä»»åŠ¡æ ˆã€ä»»åŠ¡æ ˆå·²æœ‰activity\n    if ((!isHomeOrRecentsRootTask() || hasActivity()) && allowMoveToFront) {\n        boolean doShow = true;\n        if (newTask) {\n            if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {\n                resetTaskIfNeeded(r, r);\n                doShow = topRunningNonDelayedActivityLocked(null) == r;\n            }\n        } else if (options != null && options.getAnimationType()\n                == ActivityOptions.ANIM_SCENE_TRANSITION) {\n            doShow = false;\n        }\n        if (r.mLaunchTaskBehind) {\n            r.setVisibility(true);\n            ensureActivitiesVisible(null, 0, !PRESERVE_WINDOWS);\n            mDisplayContent.executeAppTransition();\n        } else if (SHOW_APP_STARTING_PREVIEW && doShow) {\n            Task baseTask = r.getTask();\n            //â€¼ï¸å¯åŠ¨\n            final ActivityRecord prev = baseTask.getActivity(\n                    a -> a.mStartingData != null && a.showToCurrentUser());\n            r.showStartingWindow(prev, newTask, isTaskSwitch,\n                    true /* startActivity */, sourceRecord);\n        }\n    } else {\n        //ç¬¬ä¸€ä¸ªå¯åŠ¨çš„ activity æ— éœ€èŠ±é‡Œèƒ¡å“¨çš„åŠ¨ç”»\n        ActivityOptions.abort(options);\n    }\n}\n```\n\n# showStartingWindow\n```java\n//ActivityRecord.java\nvoid showStartingWindow(ActivityRecord prev, boolean newTask, boolean taskSwitch,\n        boolean startActivity, ActivityRecord sourceRecord) {\n    //è¦†ç›–æ—¶ï¼Œä¸ä¼šæ˜¾ç¤º\n    if (mTaskOverlay) {\n        return;\n    }\n    \n    //å…±äº«å…ƒç´ è½¬æ¢æ—¶ï¼Œä¸é™åˆ¶ï¼ˆå…±äº«å…ƒç´ ï¼šAndroid åŠ¨ç”»éƒ¨åˆ†ï¼‰\n    if (mPendingOptions != null\n            && mPendingOptions.getAnimationType() == ActivityOptions.ANIM_SCENE_TRANSITION) {\n        return;\n    }\n\n    final CompatibilityInfo compatInfo =\n            mAtmService.compatibilityInfoForPackageLocked(info.applicationInfo);\n\n    //æ˜¯å¦ä½¿ç”¨å¯åŠ¨é¡µæ ·å¼\n    mSplashScreenStyleEmpty = shouldUseEmptySplashScreen(sourceRecord, startActivity);\n\n    /*\n        1ã€æˆ‘ä»¬è¿™å°±æ˜¯å¯åŠ¨ activityï¼Œæ‰€ä»¥ startActivit = trueï¼Œé‚£ä¹ˆå°†ä¼šè·å–å¯åŠ¨ä¸»é¢˜\n        ï¼ˆä¹Ÿå°±æ˜¯ Android é«˜ç‰ˆæœ¬æ¯ä¸ªåº”ç”¨å¯åŠ¨éƒ½ä¼šæ˜¾ç¤ºçš„å¼€å±é¡µï¼Ÿï¼‰\n        2ã€å¼€å±ä¸»é¢˜æ˜¯å¯ä»¥é‡å†™çš„ï¼Œé¦–å…ˆå°è¯•è·å–æ˜¯å¦é‡æ–°äº†å¼€å±ä¸»é¢˜ï¼Œå°†è·å–ä¸»é¢˜èµ„æºåç§°\n        3ã€å¦‚æœæ²¡æœ‰é‡å†™ï¼Œå°†ä¼šé€šè¿‡ ATMS æ ¹æ®åŒ…åå’Œç”¨æˆ·IDè·å–ä¸»é¢˜èµ„æºåç§°\n        4ã€å¦‚æœè·å–åˆ°å¼€å±ä¸»é¢˜èµ„æºåç§°ï¼Œé‚£ä¹ˆå°†æ ¹æ®åŒ…åé€šè¿‡ createPackageContext åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œ\n           æ¥ç€æ ¹æ®ä¸Šä¸‹æ–‡å’Œä¸»é¢˜åç§°è·å–èµ„æºIDï¼ˆ0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„å¼€å±ä¸»é¢˜ï¼‰\n    */\n    final int splashScreenTheme = startActivity ? getSplashscreenTheme() : 0;\n    \n    //è¿™é‡Œä¼šè¯„ä¼°åº”è¯¥ä½¿ç”¨ theme ä¸»é¢˜è¿˜æ˜¯ splashScreenTheme ä¸»é¢˜\n    final int resolvedTheme = evaluateStartingWindowTheme(prev, packageName, theme,\n            splashScreenTheme);\n\n\n    final boolean activityCreated =\n            mState.ordinal() >= STARTED.ordinal() && mState.ordinal() <= STOPPED.ordinal();\n    //å¦‚æœä¸æ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œactivity ä¹Ÿè¿˜æ²¡åˆ›å»ºï¼Œé‚£ä¹ˆæœ¬æ¬¡æ˜¯çƒ­å¯åŠ¨\n    final boolean newSingleActivity = !newTask && !activityCreated\n            && task.getActivity((r) -> !r.finishing && r != this) == null;\n\n    //â€¼ï¸å¯åŠ¨\n    final boolean scheduled = addStartingWindow(packageName, resolvedTheme,\n            compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,\n            prev, newTask || newSingleActivity, taskSwitch, isProcessRunning(),\n            allowTaskSnapshot(), activityCreated, mSplashScreenStyleEmpty);\n}\n```\n\n# addStartingWindow\n\n```java\n//ActivityRecord.java\nboolean addStartingWindow(String pkg, int resolvedTheme, CompatibilityInfo compatInfo,\n        CharSequence nonLocalizedLabel, int labelRes, int icon, int logo, int windowFlags,\n        ActivityRecord from, boolean newTask, boolean taskSwitch, boolean processRunning,\n        boolean allowTaskSnapshot, boolean activityCreated, boolean useEmpty) {\n    //çª—å£è¢«å†»ç»“ï¼Œä¸èƒ½æ˜¾ç¤º\n    if (!okToDisplay()) {\n        return false;\n    }\n\n    if (mStartingData != null) {\n        return false;\n    }\n\n    //å·²æœ‰çª—å£åœ¨æ˜¾ç¤ºï¼Œä¸èƒ½å†æ˜¾ç¤ºäº†\n    final WindowState mainWin = findMainWindow();\n    if (mainWin != null && mainWin.mWinAnimator.getShown()) {\n        return false;\n    }\n\n    final TaskSnapshot snapshot =\n            mWmService.mTaskSnapshotController.getSnapshot(task.mTaskId, task.mUserId,\n                    false /* restoreFromDisk */, false /* isLowResolution */);\n                    \n     //STARTING_WINDOW_TYPE_NONEã€STARTING_WINDOW_TYPE_SNAPSHOTã€STARTING_WINDOW_TYPE_SPLASH_SCREEN\n    final int type = getStartingWindowType(newTask, taskSwitch, processRunning,\n            allowTaskSnapshot, activityCreated, snapshot);\n\n    //é€æ¸çš„ï¼Œè¿™é‡Œä¼¼ä¹æ›´å¤šçš„æ˜¯å’Œ window çª—å£ç›¸å…³ï¼ˆéº»äº†éº»äº†ï¼Œæˆ‘åªæƒ³çœ‹ activity ç›¸å…³ï¼Œç»†èŠ‚å¤ªéš¾äº†ï¼‰\n    if (type == STARTING_WINDOW_TYPE_SNAPSHOT) {\n        if (isActivityTypeHome()) {\n            mWmService.mTaskSnapshotController.removeSnapshotCache(task.mTaskId);\n            if ((mDisplayContent.mAppTransition.getTransitFlags()\n                    & WindowManager.TRANSIT_FLAG_KEYGUARD_GOING_AWAY_NO_ANIMATION) == 0) {\n                return false;\n            }\n        }\n        \n        //ã€åˆ†æ”¯ä¸€ã€‘\n        return createSnapshot(snapshot, typeParameter);\n    }\n\n\n    ProtoLog.v(WM_DEBUG_STARTING_WINDOW, \"Creating SplashScreenStartingData\");\n    mStartingData = new SplashScreenStartingData(mWmService, pkg,\n            resolvedTheme, compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,\n            getMergedOverrideConfiguration(), typeParameter);\n            \n    //ã€åˆ†æ”¯äºŒã€‘\n    scheduleAddStartingWindow();\n    return true;\n}\n```\n\nä¸Šè¿°æ— è®ºæ˜¯**åˆ†æ”¯ä¸€ã€åˆ†æ”¯äºŒ**ï¼Œéƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•`scheduleAddStartingWindow`ã€‚\n\n# scheduleAddStartingWindow\n\n```java\n//ActivityRecord.java\nvoid scheduleAddStartingWindow() {\n    if (StartingSurfaceController.DEBUG_ENABLE_SHELL_DRAWER) {\n        mAddStartingWindow.run();\n    } else {\n        //æŠŠæ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—æœ€å‰é¢ä¼˜å…ˆå¤„ç†ï¼Ÿ\n        if (!mWmService.mAnimationHandler.hasCallbacks(mAddStartingWindow)) {\n            //mWmServiceï¼šWindowManagerService\n            //mAnimationHandlerï¼šfinal Handler mAnimationHandler = new Handler(AnimationThread.getHandler().getLooper());\n            mWmService.mAnimationHandler.postAtFrontOfQueue(mAddStartingWindow);\n        }\n    }\n}\n```\n\nè¿™é‡Œçš„äº‹æƒ…å’Œ window çª—å£å…³ç³»å¯†åˆ‡ï¼Œsurface çœ‹ç€ç»˜åˆ¶ç›¸å…³ã€‚\n\n```java\n//ActivityRecord.java\n\nprivate final AddStartingWindow mAddStartingWindow = new AddStartingWindow();\n\nprivate class AddStartingWindow implements Runnable {\n\n    @Override\n    public void run() {\n        //ç•¥ç•¥ç•¥ï¼Œçœ‹ä¸å‡ºå®ƒå¹²äº†å•¥\n    }\n}\n```\n\nçª—å£ç›¸å…³çš„åˆ°æ­¤ä¸ºæ­¢å§ï¼Œå†è¿›å…¥çœ‹ä¸æ‡‚äº†ã€‚æˆ‘æ›´å…³æ³¨çš„æ˜¯ activity å£°æ˜å‘¨æœŸå›è°ƒï¼Œå¯è¿Ÿè¿Ÿæ²¡æœ‰çœ‹è§ğŸ’”\n\n---\n\né‚£ä¹ˆè¿™æˆ‘ä»¬å§‘ä¸”ä»–æˆåŠŸåœ°æŠŠ activity æ·»åŠ åˆ° window ä¸Šï¼Œç°åœ¨æ˜¯æ—¶å€™å›å¤´çœ‹çœ‹**å¯åŠ¨æˆåŠŸååšäº†äº›ä»€ä¹ˆï¼Ÿ** æ‰€ä»¥æˆ‘ä»¬å›åˆ° `ActivityStarter.java`ï¼Œè‡ªç„¶è¿˜æ˜¯å›åˆ°è¿™é‡Œ ~~ï¼ˆä»å“ªæ¥ï¼Œå›å“ªå»å§ï¼‰~~\n\n\n# The callback [onNewIntent]\n\nè¿™é‡Œè®² `Activity onNewIntent(Intent intent)` ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå…¶å®åƒ onCreatã€onResume ç­‰ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œå…¶ä»–çš„ä¸é‡å¤ã€‚\n\n## deliverToCurrentTopIfNeeded\n\n```java\n//ActivityStarter.java\nint startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,\n        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,\n        int startFlags, boolean doResume, ActivityOptions options, Task inTask,\n        TaskFragment inTaskFragment, boolean restrictedBgActivity,\n        NeededUriGrants intentGrants) {\n        \n\n    //å¦‚æœæ­£åœ¨å¯åŠ¨çš„ activity å’Œä»»åŠ¡æ ˆé¡¶éƒ¨çš„ activity ç›¸åŒ\n    final Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();\n    if (topRootTask != null) {\n        //é¡¶éƒ¨æ˜¯åŒä¸€ä¸ª activityï¼Œæ— éœ€é‡å¤åˆ›å»ºï¼Œå¯åŠ¨ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„åº”è¯¥å›è°ƒ onNewIntent\n        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);\n        if (startResult != START_SUCCESS) {\n            return startResult;\n        }\n    }       \n}\n```\n\n## deliverToCurrentTopIfNeeded\n\n```\nprivate int deliverToCurrentTopIfNeeded(Task topRootTask, NeededUriGrants intentGrants) {\n    //è·å–å½“å‰æ ˆé¡¶ activity\n    final ActivityRecord top = topRootTask.topRunningNonDelayedActivityLocked(mNotTop);\n    \n    //activity ç›¸åŒã€å¯åŠ¨ç”¨æˆ·ç›¸åŒã€æ ˆé¡¶å¤ç”¨ã€å¯åŠ¨ç›®æ ‡\n    final boolean dontStart = top != null\n            && top.mActivityComponent.equals(mStartActivity.mActivityComponent)\n            && top.mUserId == mStartActivity.mUserId\n            && top.attachedToProcess()\n            && ((mLaunchFlags & FLAG_ACTIVITY_SINGLE_TOP) != 0\n            || LAUNCH_SINGLE_TOP == mLaunchMode)\n            && (!top.isActivityTypeHome() || top.getDisplayArea() == mPreferredTaskDisplayArea);\n    if (!dontStart) {\n        return START_SUCCESS;\n    }\n\n    top.getTaskFragment().clearLastPausedActivity();\n    //activity æ˜¾ç¤ºï¼Œåé¢çœ‹\n    if (mDoResume) {\n        mRootWindowContainer.resumeFocusedTasksTopActivities();\n    }\n    \n    //è¿™é‡Œä¼šè¿›å…¥ ActivitRecord\n    deliverNewIntent(top, intentGrants);\n    return START_DELIVERED_TO_TOP;\n}\n```\n\n## deliverNewIntentLocked\n\n```java\n//ActivityRecord.java\nfinal void deliverNewIntentLocked(int callingUid, Intent intent, NeededUriGrants intentGrants,\n\n    if ((mState == RESUMED || mState == PAUSED || isTopActivityWhileSleeping)\n            && attachedToProcess()) {\n        try {\n            ArrayList<ReferrerIntent> ar = new ArrayList<>(1);\n            ar.add(rintent);\n            //å¼€å§‹è°ƒç”¨å£°æ˜å‘¨æœŸç›¸å…³ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡ ClientTransaction\n            //getLifecycleManager -> ClientLifecycleManager å£°æ˜å‘¨æœŸç›¸å…³å›è°ƒéƒ½ä¼šé€šè¿‡å®ƒ\n            mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,\n                    NewIntentItem.obtain(ar, mState == RESUMED));\n            unsent = false;\n        } catch (RemoteException e) {\n            Slog.w(TAG, \"Exception thrown sending new intent to \" + this, e);\n        } catch (NullPointerException e) {\n            Slog.w(TAG, \"Exception thrown sending new intent to \" + this, e);\n        }\n    }\n    \n    if (unsent) {\n        addNewIntentLocked(rintent);\n    }\n}\n```\n\n\n```java\n//ClientLfecycleManager.java\nvoid scheduleTransaction(ClientTransaction transaction) throws RemoteException {\n    //åˆ›å»ºä¸€ä¸ªäº‹ç‰©ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œå…³é”®æ˜¯è¿™ä¸ªæ˜¯äº‹åŠ¡ï¼ˆbinder)äº‹åŠ¡ä¼ é€’æ•°æ®çš„ï¼Œæˆ–åˆ™äº‹åŠ¡å‘é€åå°†åœ¨å“ªé‡Œå¤„ç†äº‹åŠ¡ï¼Ÿï¼Ÿï¼Ÿ\n    final IApplicationThread client = transaction.getClient();\n    transaction.schedule();\n    if (!(client instanceof Binder)) {\n        transaction.recycle();\n    }\n}\n```\n\n## ClientTransaction.schedule\n\n`ClientTransaction`: A container that holds a sequence of messages, which may be sent to a client. This includes a list of callbacks and a final lifecycle state.\n\n\n```java\n//ClientTransaction.java\n\n/*\n    1ã€IApplicationThread è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ aidl æ¥å£ï¼Œæ¥å£å®ç°è‡ªç„¶æ˜¯ IApplicationThread.Sub\n    2ã€å®ç°ç±»åœ¨ ActivityThreadï¼Œprivate class ApplicationThread extends IApplicationThread.Stub \n*/\nprivate IApplicationThread mClient;\n\n\n/**\n * Schedule the transaction after it was initialized. It will be send to client and all its\n * individual parts will be applied in the following sequence:\n * 1. The client calls {@link #preExecute(ClientTransactionHandler)}, which triggers all work\n *    that needs to be done before actually scheduling the transaction for callbacks and\n *    lifecycle state request.\n * 2. The transaction message is scheduled.\n * 3. The client calls {@link TransactionExecutor#execute(ClientTransaction)}, which executes\n *    all callbacks and necessary lifecycle transitions.\n */\npublic void schedule() throws RemoteException \n    mClient.scheduleTransaction(this);\n}\n```\n\n\n## ApplicationThread.scheduleTransaction\n\n```java\n//ActivityThread.java\nprivate class ApplicationThread extends IApplicationThread.Stub{\n\n    @Override\n    public void scheduleTransaction(ClientTransaction transaction) throws RemoteException {\n        //åœ¨å½“å‰ç±»æ–‡ä»¶æœç´¢æ²¡çœ‹åˆ°æ–¹æ³•å®šä¹‰ï¼Œå·®ç‚¹æ€€ç–‘äººç”Ÿï¼›ç„¶åçœ‹çœ‹ ActivitThread è¿˜æœ‰çˆ¶ç±»ï¼Œé‚£æ–¹æ³•å®šä¹‰å°±åœ¨çˆ¶ç±»äº†\n        ActivityThread.this.scheduleTransaction(transaction);\n    }\n}\n```\n\n```java\npublic final class ActivityThread extends ClientTransactionHandler\n        implements ActivityThreadInternal {  \n}\n```\n\n```java\npublic abstract class ClientTransactionHandler {\n\n    void scheduleTransaction(ClientTransaction transaction) {\n        transaction.preExecute(this);\n        //å‘é€æ¶ˆæ¯ï¼Œé‚£è€…å°±æ˜ç¡®å¾ˆå¤šäº†\n        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);\n    }\n```\n\n```java\n//ActivityThread.java\nclass H extends Handler {\n    \n    public static final int EXECUTE_TRANSACTION = 159;\n\n    public void handleMessage(Message msg) {\n        switch (msg.what) {\n            case EXECUTE_TRANSACTION:\n                //å›å¤´çœ‹çœ‹ schedule çš„æ³¨é‡Šï¼Œä¸‹ä¸€æ­¥åº”è¯¥ä¼šåˆ°å“ªé‡Œå»æ‰§è¡Œï¼Œå…¶å®åˆ«äººæ˜¯å†™å¾—å¾ˆæ¸…æ¥šçš„ï¼ˆç†Ÿèƒ½ç”Ÿå·§ï¼Œåˆçœ‹ç¡®å®ä¸€å¤´é›¾æ°´ï¼‰\n                final ClientTransaction transaction = (ClientTransaction) msg.obj;\n                mTransactionExecutor.execute(transaction);\n                if (isSystem()) {\n                    transaction.recycle();\n                }\n            break;\n        }\n     }\n}\n```\n\n## TransactionExecutor.excute\n\n```java\n//TransactionExecutor.java\npublic void execute(ClientTransaction transaction) {\n    if (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + \"Start resolving transaction\");\n\n    //ä¼¼ä¹æ¯ä¸€ä¸ª activity éƒ½æœ‰ä¸€ä¸ª tokenï¼Œè¿˜ä¸æ¸…æ¥šä»ä½•è€Œæ¥\n    //åˆå­¦ Android æ—¶ï¼Œå…³äº activity token çš„æŠ¥é”™ä¼°è®¡ä½ ä¹Ÿé‡åˆ°è¿‡\n    final IBinder token = transaction.getActivityToken();\n    if (token != null) {\n        final Map<IBinder, ClientTransactionItem> activitiesToBeDestroyed =\n                mTransactionHandler.getActivitiesToBeDestroyed();\n        final ClientTransactionItem destroyItem = activitiesToBeDestroyed.get(token);\n        if (destroyItem != null) {\n            if (transaction.getLifecycleStateRequest() == destroyItem) {\n                activitiesToBeDestroyed.remove(token);\n            }\n            if (mTransactionHandler.getActivityClient(token) == null) {\n                return;\n            }\n        }\n    }\n    \n    //è¿™ä¸ªæš‚ä¸å…³æ³¨ï¼Œé‡ç‚¹çœ‹çœ‹ä¸‹é¢çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒå§\n    executeCallbacks(transaction);\n    \n    /*\n        1ã€cycleToPath(r, lifecycleItem.getTargetState(), true , transaction);  -> performLifecycleSequence\n        \n        //çœ‹äº†ä¸€åœˆï¼Œç€ä¸¤ä¸ªå®ç°åº”è¯¥æ˜¯åœ¨å­ç±»\n        2ã€lifecycleItem.execute(mTransactionHandler, token, mPendingActions);\n        3ã€lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);\n    */\n    executeLifecycleState(transaction);\n    mPendingActions.clear();\n    if (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + \"End resolving transaction\");\n}\n```\n\n\n```java\n//TransactionExecutor.java\nprivate void performLifecycleSequence(ActivityClientRecord r, IntArray path,\n        ClientTransaction transaction) {\n    final int size = path.size();\n    for (int i = 0, state; i < size; i++) {\n        state = path.get(i);\n        \n        //æ˜¯å§ï¼Œå‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒéƒ½æœ‰ï¼›é‚£å°±å¥‡æ€ªäº†æ€ä¹ˆæ²¡æœ‰ onNewIntentï¼Œä»–ä¸ç®—æ˜¯ç”Ÿå‘½å‘¨æœŸå‡½æ•°å—ï¼Ÿ\n        //å’šå’šå’šå’šï¼ˆæ•²é»‘æ¿ï½ï¼‰\n        /*\n            1ã€onNewIntent ä¸æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œåªæ˜¯å£°æ˜å‘¨æœŸå›è°ƒè¿‡ç¨‹ä¸­å¯èƒ½è¢«æ‰§è¡Œçš„ä¸€ä¸ªæ–¹æ³•\n            2ã€å¦‚æœæ»¡è¶³æŸäº›æ¡ä»¶ï¼Œæ ¹æ®ç»éªŒæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•åœ¨ onResume ä¹‹å‰ä¼šæ‰§è¡Œ\n            3ã€é‚£ä¹ˆæˆ‘ä»¬çŒœæµ‹ï¼ˆæˆ‘çœ‹äº†ä»£ç å†æ¥çŒœæµ‹çš„ğŸ˜ï¼‰ï¼Œè¯¥æ–¹æ³•çš„å›è°ƒæœ‰æ²¡æœ‰å¯èƒ½åœ¨ handleResumeActivity é‡Œé¢æ‰§è¡Œï¼Ÿé‚£å°±å»çœ‹çœ‹å§ï¼\n        */\n        switch (state) {\n            case ON_CREATE:\n                mTransactionHandler.handleLaunchActivity(r, mPendingActions,\n                        null /* customIntent */);\n                break;\n            case ON_START:\n                mTransactionHandler.handleStartActivity(r, mPendingActions,\n                        null /* activityOptions */);\n                break;\n            case ON_RESUME:\n                mTransactionHandler.handleResumeActivity(r, false /* finalStateRequest */,\n                        r.isForward, \"LIFECYCLER_RESUME_ACTIVITY\");\n                break;\n            case ON_PAUSE:\n                mTransactionHandler.handlePauseActivity(r, false /* finished */,\n                        false /* userLeaving */, 0 /* configChanges */, mPendingActions,\n                        \"LIFECYCLER_PAUSE_ACTIVITY\");\n                break;\n            case ON_STOP:\n                mTransactionHandler.handleStopActivity(r, 0 /* configChanges */,\n                        mPendingActions, false /* finalStateRequest */,\n                        \"LIFECYCLER_STOP_ACTIVITY\");\n                break;\n            case ON_DESTROY:\n                mTransactionHandler.handleDestroyActivity(r, false /* finishing */,\n                        0 /* configChanges */, false /* getNonConfigInstance */,\n                        \"performLifecycleSequence. cycling to:\" + path.get(size - 1));\n                break;\n            case ON_RESTART:\n                mTransactionHandler.performRestartActivity(r, false /* start */);\n                break;\n            default:\n                throw new IllegalArgumentException(\"Unexpected lifecycle state: \" + state);\n        }\n    }\n}\n```\n\nClientTransactionHandler æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥å£°æ˜å‘¨æœŸå›è°ƒè¿˜å¾—æ‰¾ ClientTransactionHandler çš„å®ç°ç±» `ActivitThread`ã€‚\n\nç»•ä¸€åœˆåˆå›æ¥ï¼Œè¿™è¿™è¿™ï½ï½ï½\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69c055d008d74b45bd1205352739f8b9~tplv-k3u1fbpfcp-watermark.image?)\n\n\n## ActivitThread.performResumeActivity\n\n```java\n//ActivityThread.java\npublic boolean performResumeActivity(ActivityClientRecord r, boolean finalStateRequest,\n        String reason) {\n\n    if (r.activity.mFinished) {\n        return false;\n    }\n    \n    //å·²ç» resumed å°±ä¸é‡å¤äº†\n    if (r.getLifecycleState() == ON_RESUME) {\n        if (!finalStateRequest) {\n            final RuntimeException e = new IllegalStateException(\n                    \"Trying to resume activity which is already resumed\");\n        }\n        return false;\n    }\n    \n    if (finalStateRequest) {\n        r.hideForNow = false;\n        r.activity.mStartedActivity = false;\n    }\n    \n    try {\n        r.activity.onStateNotSaved();\n        r.activity.mFragments.noteStateNotSaved();\n        checkAndBlockForNetworkAccess();\n        //çœ‹åˆ°æ²¡ï¼Œæ»¡è¶³æŸäº›æ¡ä»¶æƒ…å†µä¸‹æ˜¯ä¼šèµ° onNewIntent \n        if (r.pendingIntents != null) {\n            deliverNewIntents(r, r.pendingIntents);\n            r.pendingIntents = null;\n        }\n        \n        if (r.pendingResults != null) {\n            deliverResults(r, r.pendingResults, reason);\n            r.pendingResults = null;\n        }\n        \n        //onResume å›è°ƒåœ¨è¿™é‡Œï¼Œæœ¬æ¬¡æˆ‘ä»¬æš‚ä¸å…³æ³¨\n        r.activity.performResume(r.startsNotResumed, reason);\n\n        //æŠŠçŠ¶æ€è®¾ç½®ä¸€ä¸‹\n        r.state = null;\n        r.persistentState = null;\n        r.setState(ON_RESUME);\n\n        reportTopResumedActivityChanged(r, r.isTopResumedActivity, \"topWhenResuming\");\n    } catch (Exception e) {\n        if (!mInstrumentation.onException(r.activity, e)) {\n            throw new RuntimeException(\"Unable to resume activity \"\n                    + r.intent.getComponent().toShortString() + \": \" + e.toString(), e);\n        }\n    }\n    return true;\n}\n```\n\n```java\n//ActivityThread.java\nprivate void deliverNewIntents(ActivityClientRecord r, List<ReferrerIntent> intents) {\n    final int N = intents.size();\n    for (int i=0; i<N; i++) {\n        ReferrerIntent intent = intents.get(i);\n        intent.setExtrasClassLoader(r.activity.getClassLoader());\n        intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),\n                r.activity.getAttributionSource());\n        r.activity.mFragments.noteStateNotSaved();\n        //æœ€åè¿˜æ˜¯äº¤ç»™ â€˜å¤§ç®¡å®¶â€™ æ‰§è¡Œå•Šï¼Œå›åˆ°äº†é‚£ä¸ªç†Ÿæ‚‰çš„å¯¹è±¡\n        mInstrumentation.callActivityOnNewIntent(r.activity, intent);\n    }\n}\n```\n\n## Instrumentation.callActivityOnNewIntent\n\n```java\n//Instrumentation.java\npublic void callActivityOnNewIntent(Activity activity, ReferrerIntent intent) {\n    final String oldReferrer = activity.mReferrer;\n    try {\n        if (intent != null) {\n            activity.mReferrer = intent.mReferrer;\n        }\n        callActivityOnNewIntent(activity, intent != null ? new Intent(intent) : null);\n    } finally {\n        activity.mReferrer = oldReferrer;\n    }\n}\n```\n\n```java\n//Instrumentation.java\npublic void callActivityOnNewIntent(Activity activity, Intent intent) {\n    //ä»€ä¹ˆï¼ŸInstrumentation ä¸ç†Ÿæ‚‰ï¼Ÿ\n    //é‚£ activity æ€»è¯¥ç†Ÿæ‚‰äº†å§\n    activity.performNewIntent(intent);\n}\n```\n\n```java\n//Activity.java\nfinal void performNewIntent(@NonNull Intent intent) {\n    mCanEnterPictureInPicture = true;\n    onNewIntent(intent);\n}\n```\n\n```java\n//Activity.java\nprotected void onNewIntent(Intent intent) {\n}\n```\n\nå°±åˆ°è¿™é‡Œç»“æŸå§ï¼Œçœ‹èµ·æ¥æ²¡é‚£ä¹ˆåƒæ ·ã€‚è™½ç„¶æ˜¯ `æ¡Œé¢å¯åŠ¨`ï¼Œåæ¥è¶Šæ„Ÿè§‰åƒæ˜¯ `Activity å¯åŠ¨`ã€‚~~éƒ½ä¹±å¥—äº†~~ ï¼Œå¯æ˜¯ï¼Œæ¡Œé¢ä¸ä¹Ÿæ˜¯ä¸€ä¸ª activity å—ğŸ¤”ï¸","slug":"Androidç³»ç»Ÿæ¡Œé¢å¯åŠ¨äºŒ","published":1,"lang":"undefined","updated":"2022-09-29T14:58:04.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsp000egaqphqsi1vr9","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p>æ¡Œé¢å¯åŠ¨ç±»ä¼¼ Activity å¯åŠ¨ï¼Œæ¥ç€ä¸Šä¸€ç« èŠ‚ç»§ç»­æŸ¥é˜…å¯åŠ¨æµç¨‹ï¼Œå¯åŠ¨é™åˆ¶ã€å¯åŠ¨æ¡ä»¶æ£€æŸ¥æ˜¯é‡ç‚¹ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šé€æ­¥å›è°ƒç»™å¤–éƒ¨ï¼Œè¿™é‡Œåªæ˜¯ç²—ç•¥æè¿°å¯åŠ¨è¿‡ç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…æ‹¬çª—å£çš„åˆ›å»ºã€ç»˜åˆ¶ç­‰ç­‰ã€‚</p>\n<h1>startActivityUnchecked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">startActivityUnchecked</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> result = START_CANCELED;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> startResultSuccessful = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task startedActivityRootTask;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//TRANSIT_OPENï¼šåˆ›å»ºä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„æ–°çª—å£ï¼Œå¹¶ä¸”è®©çª—å£å¯è§</span></span><br><span class=\"line\">    <span class=\"comment\">//transitType è¿˜ä¼šå½±å“çª—å£ç»˜åˆ¶æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤æ˜¯ 5ç§’ï¼Œå¦‚æœæ˜¯ chenge ç±»å‹å»¶æ—¶å°†ç¼©çŸ­åˆ° 2 ç§’</span></span><br><span class=\"line\">    <span class=\"comment\">//ä¹Ÿä¼šæŠŠ windowContain æ·»åŠ åˆ°é›†åˆä¸­ï¼Œç­‰å¾…çª—å£ç»˜åˆ¶</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> TransitionController transitionController = r.mTransitionController;</span><br><span class=\"line\">    Transition newTransition = (!transitionController.isCollecting()</span><br><span class=\"line\">            &amp;&amp; transitionController.getTransitionPlayer() != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            ? transitionController.createTransition(TRANSIT_OPEN) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    RemoteTransition remoteTransition = r.takeRemoteTransition();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newTransition != <span class=\"keyword\">null</span> &amp;&amp; remoteTransition != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        newTransition.setRemoteTransition(remoteTransition);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    transitionController.collect(r);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isTransient = r.getOptions() != <span class=\"keyword\">null</span> &amp;&amp; r.getOptions().getTransientLaunch();</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å»¶è¿Ÿçª—å£æµ‹é‡ï¼Œåˆä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å˜é‡ mDeferDepth++ï¼Œæ§åˆ¶æµ‹é‡ã€ç»˜åˆ¶æ¬¡æ•°ï¼Œé¿å…é€’å½’å¾ªç¯</span></span><br><span class=\"line\">        mService.deferWindowLayout();</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸åˆæ˜¯ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ</span></span><br><span class=\"line\">        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class=\"line\">                startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,</span><br><span class=\"line\">                intentGrants);</span><br><span class=\"line\">        startResultSuccessful = ActivityManager.isStartResultSuccessful(result);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> taskAlwaysOnTop = options != <span class=\"keyword\">null</span> &amp;&amp; options.getTaskAlwaysOnTop();</span><br><span class=\"line\">        <span class=\"comment\">// Apply setAlwaysOnTop when starting an Activity is successful regardless of creating</span></span><br><span class=\"line\">        <span class=\"comment\">// a new Activity or recycling the existing Activity.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (taskAlwaysOnTop &amp;&amp; startResultSuccessful) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Task targetRootTask =</span><br><span class=\"line\">                    mTargetRootTask != <span class=\"keyword\">null</span> ? mTargetRootTask : mTargetTask.getRootTask();</span><br><span class=\"line\">            targetRootTask.setAlwaysOnTop(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        Trace.traceEnd(Trace.TRACE_TAG_WINDOW_MANAGER);</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸æ— è®ºæˆåŠŸå¤±è´¥ä¸å¦ï¼Œå¯åŠ¨è§£é‡Šéƒ½åº”è¯¥åˆ†å‘å‡ºå»</span></span><br><span class=\"line\">        startedActivityRootTask = handleStartResult(r, result);</span><br><span class=\"line\">        <span class=\"comment\">//å»¶æ—¶çª—å£æµ‹é‡å°†è¢«æ¢å¤</span></span><br><span class=\"line\">        mService.continueWindowLayout();</span><br><span class=\"line\">        mSupervisor.mUserLeaving = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    postStartActivityProcessing(r, result, startedActivityRootTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"about-TransitionType\">about TransitionType</h2>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">@IntDef</span>(prefix = &#123; <span class=\"string\">&quot;TRANSIT_&quot;</span> &#125;, value = &#123;</span><br><span class=\"line\">        TRANSIT_NONE,</span><br><span class=\"line\">        TRANSIT_OPEN,                 <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œå¹¶ä¸”ä½¿å…¶å¯è§</span></span><br><span class=\"line\">        TRANSIT_CLOSE,                <span class=\"comment\">//å¯è§çš„çª—å£è¢«å…³é—­ï¼ˆfinished æˆ– destroyedï¼‰</span></span><br><span class=\"line\">        TRANSIT_TO_FRONT,             <span class=\"comment\">//ä¸å¯è§çš„çª—å£å°†å˜ä¸ºå¯è§</span></span><br><span class=\"line\">        TRANSIT_TO_BACK,              <span class=\"comment\">//å¯è§çš„çª—å£å˜ä¸ºä¸å¯è§</span></span><br><span class=\"line\">        TRANSIT_RELAUNCH,</span><br><span class=\"line\">        TRANSIT_CHANGE,               <span class=\"comment\">//å¯è§çª—å£å‘ç”Ÿæ”¹å˜ï¼ˆæ¯”å¦‚å±å¹•æ–¹å‘ã€å¤§å°æ”¹å˜ï¼‰</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_GOING_AWAY,  <span class=\"comment\">//ï¼ˆå·²åºŸå¼ƒï¼‰</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_OCCLUDE,     <span class=\"comment\">//é”®ç›˜é”å®š</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_UNOCCLUDE,   <span class=\"comment\">//é”®ç›˜è§£é”</span></span><br><span class=\"line\">        TRANSIT_PIP,                  <span class=\"comment\">//ç”»ä¸­ç”»</span></span><br><span class=\"line\">        TRANSIT_WAKE,                 <span class=\"comment\">//ï¼ˆæ­£åœ¨æ‰“å¼€ï¼Ÿï¼‰</span></span><br><span class=\"line\">        TRANSIT_FIRST_CUSTOM</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"variable\">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class=\"line\"><span class=\"variable\">@interface</span> TransitionType &#123;&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityInner</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">startActivityInner</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">    setInitialState(r, options, inTask, inTaskFragment, doResume, startFlags, sourceRecord,</span><br><span class=\"line\">            voiceSession, voiceInteractor, restrictedBgActivity);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ç¡®å®š activity æ‰€å¯åŠ¨çš„ä»»åŠ¡æ ˆåº”è¯¥æ˜¯ NEW_TASK è¿˜æ˜¯åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆå¯åŠ¨</span></span><br><span class=\"line\">    computeLaunchingTaskFlags();</span><br><span class=\"line\">    computeSourceRootTask();</span><br><span class=\"line\">    mIntent.setFlags(mLaunchFlags);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœè¯·æ±‚å·²ç»å¼€å§‹ï¼Œåº”è¯¥å†»ç»“æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ï¼Œç­‰å¾…ä¸‹æ¬¡æ›´æ–°</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task prevTopTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task reusedTask = getReusableTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mOptions != <span class=\"keyword\">null</span> &amp;&amp; mOptions.freezeRecentTasksReordering()</span><br><span class=\"line\">            &amp;&amp; mSupervisor.mRecentTasks.isCallerRecents(r.launchedFromUid)</span><br><span class=\"line\">            &amp;&amp; !mSupervisor.mRecentTasks.isFreezeTaskListReorderingSet()) &#123;</span><br><span class=\"line\">        mFrozeTaskList = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        mSupervisor.mRecentTasks.setFreezeTaskListReordering();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è®¡ç®—æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡æ ˆå¯ä»¥å¤ç”¨ï¼Œå¦åˆ™åº”è¯¥åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task targetTask = reusedTask != <span class=\"keyword\">null</span> ? reusedTask : computeTargetTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> newTask = targetTask == <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    mTargetTask = targetTask;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ç¡®å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚ windowType</span></span><br><span class=\"line\">    computeLaunchParams(r, sourceRecord, targetTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆæ˜¯ä¸€ç•ªå¯åŠ¨é™åˆ¶ï¼Œåœ¨ä»»åŠ¡æ ˆå±‚é¢é™åˆ¶å¯åŠ¨ğŸš«</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> startResult = isAllowedToStart(r, newTask, targetTask);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¤ç”¨ä»»åŠ¡æ ˆ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityRecord targetTaskTop = newTask</span><br><span class=\"line\">            ? <span class=\"keyword\">null</span> : targetTask.getTopNonFinishingActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetTaskTop != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€resumeTargetRootTaskIfNeeded</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€mRootWindowContainer.resumeFocusedTasksTopActivities</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        startResult = recycleTask(targetTask, targetTaskTop, reusedTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        mAddingToTask = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¦‚æœå¯åŠ¨çš„ activity æ˜¯åœ¨ä»»åŠ¡æ ˆä¸­å·²å­˜åœ¨ï¼Œåˆ™åªéœ€å¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶è°ƒç”¨ activity çš„ onNewIntent æ–¹æ³•å³å¯</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å›è°ƒæ–¹æ³• deliverNewIntent(top, intentGrants); ActivityRecorder#deliverNewIntentLocked</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,</span></span><br><span class=\"line\"><span class=\"comment\">        NewIntentItem.obtain(ar, mState == RESUMED));</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topRootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTargetRootTask == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mTargetRootTask = getLaunchRootTask(mStartActivity, mLaunchFlags, targetTask, mOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                ? mSourceRecord.getTask() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        setNewTask(taskToAffiliate);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mAddingToTask) &#123;</span><br><span class=\"line\">        addOrReparentStartingActivity(targetTask, <span class=\"string\">&quot;adding to task&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨çš„ç›®æ ‡ä»»åŠ¡æ ˆæœ‰äº†ï¼Œç›´æ¥çœ‹ activity å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task startedTask = mStartActivity.getTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isTaskSwitch = startedTask != prevTopTask &amp;&amp; !startedTask.isEmbedded();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨</span></span><br><span class=\"line\">    mTargetRootTask.startActivityLocked(mStartActivity,</span><br><span class=\"line\">            topRootTask != <span class=\"keyword\">null</span> ? topRootTask.getTopNonFinishingActivity() : <span class=\"keyword\">null</span>, newTask,</span><br><span class=\"line\">            isTaskSwitch, mOptions, sourceRecord);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord topTaskActivity = startedTask.topRunningActivityLocked();</span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶æ²¡æœ‰è·å¾—ç„¦ç‚¹ï¼Œå¹¶ä¸”å½“å‰å¯åŠ¨çš„ä¸æ˜¯æœ¬æ¬¡æƒ³å¯åŠ¨çš„ï¼Œä¹Ÿè¦ç¡®ä¿å®ƒæ˜¾ç¤ºï¼ˆå®ƒå¯èƒ½æ˜¯æ›´é‡è¦çš„ activity æŠ¢å…ˆæ˜¾ç¤ºå‘¢ï¼‰</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mTargetRootTask.isTopActivityFocusable()</span><br><span class=\"line\">                || (topTaskActivity != <span class=\"keyword\">null</span> &amp;&amp; topTaskActivity.isTaskOverlay()</span><br><span class=\"line\">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            mTargetRootTask.ensureActivitiesVisible(<span class=\"keyword\">null</span> <span class=\"comment\">/* starting */</span>,</span><br><span class=\"line\">            mTargetRootTask.mDisplayContent.executeAppTransition();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶å·²è·å¾—ç„¦ç‚¹ï¼Œå¦‚æœè¯¥ä»»åŠ¡æ ˆæ²¡æœ‰æ˜¾ç¤ºåœ¨æœ€å‰åˆ™ moveToFront</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mTargetRootTask.isTopActivityFocusable()</span><br><span class=\"line\">                    &amp;&amp; !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) &#123;</span><br><span class=\"line\">                mTargetRootTask.moveToFront(<span class=\"string\">&quot;startActivityInner&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//è¿™é‡Œå’Œä¸Šè¿° recycleTask ç›¸ä¼¼ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ã€‚ï¼ˆæŠŠ activity è½¬ç§»ä¸ºå¯è§çŠ¶æ€ï¼‰</span></span><br><span class=\"line\">            mRootWindowContainer.resumeFocusedTasksTopActivities(</span><br><span class=\"line\">                    mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å®Œæ¯•éœ€è¦æ›´æ–°æœ€è¿‘ä»»åŠ¡æ ˆç­‰</span></span><br><span class=\"line\">    mRootWindowContainer.updateUserRootTask(mStartActivity.mUserId, mTargetRootTask);</span><br><span class=\"line\">    mSupervisor.mRecentTasks.add(startedTask);</span><br><span class=\"line\">    mSupervisor.handleNonResizableTaskIfNeeded(startedTask,</span><br><span class=\"line\">            mPreferredWindowingMode, mPreferredTaskDisplayArea, mTargetRootTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"isAllowedToStart\">isAllowedToStart</h2>\n<p>æ£€æŸ¥ activity æ˜¯å¦å¯ä»¥åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆæˆ–è€…æ–°çš„ä»»åŠ¡æ ˆä¸­å¯åŠ¨ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">isAllowedToStart</span><span class=\"params\">(ActivityRecord r, <span class=\"keyword\">boolean</span> newTask, Task targetTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//âŒ1ã€æ²¡æœ‰åŒ…åæ˜¯ä¸å…è®¸çš„ï¼ˆæ¯ä¸ª activity éƒ½æœ‰æ‰€å±çš„åŒ…ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.packageName == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mStartActivity.resultTo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mStartActivity.resultTo.sendResult(INVALID_UID, mStartActivity.resultWho,</span><br><span class=\"line\">                    mStartActivity.requestCode, RESULT_CANCELED,</span><br><span class=\"line\">                    <span class=\"keyword\">null</span> <span class=\"comment\">/* data */</span>, <span class=\"keyword\">null</span> <span class=\"comment\">/* dataGrants */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ActivityOptions.abort(mOptions);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€åº”ç”¨å¤„äº instrument çŠ¶æ€æ—¶ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¦‚æœæ˜¯ VR æ˜¾ç¤ºIDæˆ–è€…é»˜è®¤æ˜¾ç¤ºIDï¼Œå…è®¸å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€launchMode != SINGLE_TASK &amp;&amp; launchMode != SINGLE_INSTANCE å±äºå·²æœ‰å¯åŠ¨çŠ¶æ€ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.isActivityTypeHome()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mRootWindowContainer.canStartHomeOnDisplayArea(r.info, mPreferredTaskDisplayArea,</span><br><span class=\"line\">                <span class=\"keyword\">true</span> <span class=\"comment\">/* allowInstrumenting */</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_CANCELED;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€âŒå¦‚æœæ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€âŒå¦‚æœè°ƒç”¨è€… uid ä¸æ˜¯å½“å‰ç¨‹åºï¼ˆå½“å‰ä»»åŠ¡æ ˆï¼‰ï¼Œå¯åŠ¨æ—¶ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€âŒå¦‚æœæ˜¯éœ€è¦åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> blockBalInTask = (newTask</span><br><span class=\"line\">            || !targetTask.isUidPresent(mCallingUid)</span><br><span class=\"line\">            || (LAUNCH_SINGLE_INSTANCE == mLaunchMode &amp;&amp; targetTask.inPinnedWindowingMode()));</span><br><span class=\"line\">    <span class=\"comment\">// mRestrictedBgActivityï¼šä¸¥æ ¼æŠŠæ§ activity çš„å¯åŠ¨ğŸš«ï¼ˆè¯¥æ¡ä»¶å‰ä¸€ç¯‡æœ‰æåˆ°ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mRestrictedBgActivity &amp;&amp; blockBalInTask</span><br><span class=\"line\">            &amp;&amp; handleBackgroundActivityAbort(mStartActivity)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_ABORTED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜æ˜¯åœ¨ä¸æ–­é™åˆ¶å¯åŠ¨ï¼Œæ¡ä»¶è‹›åˆ»å•Š</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isNewClearTask =</span><br><span class=\"line\">            (mLaunchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</span><br><span class=\"line\">                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!newTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getLockTaskController().isLockTaskModeViolation(targetTask,</span><br><span class=\"line\">                isNewClearTask)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getLockTaskController().isNewTaskLockTaskModeViolation(mStartActivity)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mInTaskFragment != <span class=\"keyword\">null</span> &amp;&amp; !canEmbedActivity(mInTaskFragment, r, newTask, targetTask)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_PERMISSION_DENIED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âœ…å¦åˆ™ï¼Œæ˜¯å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"canEmbedActivity\">canEmbedActivity</h2>\n<p>æ˜¯å¦å¯ä»¥åµŒå…¥ï¼Ÿactivity åµŒå…¥ï¼Ÿ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canEmbedActivity</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TaskFragment taskFragment, ActivityRecord starting,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> newTask, Task targetTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task hostTask = taskFragment.getTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hostTask == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ˜¯å…è®¸åµŒå…¥å¯åŠ¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> hostUid = hostTask.effectiveUid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (UserHandle.getAppId(hostUid) == Process.SYSTEM_UID) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒå¦‚æœä¸æ˜¯å½“å‰åº”ç”¨è¿›ç¨‹å¯åŠ¨ï¼Œæ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hostUid != starting.getUid()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒå¦‚æœä¸æ˜¯åŒä¸€ä¸ªä»»åŠ¡æ ˆï¼ˆä¸»ä»»åŠ¡æ ˆï¼‰ä¸­å¯åŠ¨ï¼Œä¹Ÿæ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> !newTask &amp;&amp; (targetTask == <span class=\"keyword\">null</span> || targetTask == hostTask);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityLocked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Task.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startActivityLocked</span><span class=\"params\">(ActivityRecord r, <span class=\"meta\">@Nullable</span> ActivityRecord focusedTopActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> isTaskSwitch, ActivityOptions options,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> ActivityRecord sourceRecord)</span> </span>&#123;</span><br><span class=\"line\">    Task rTask = r.getTask();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> allowMoveToFront = options == <span class=\"keyword\">null</span> || !options.getAvoidMoveToFront();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrhasTask = rTask == <span class=\"keyword\">this</span> || hasChild(rTask);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨çš„ activity ä¸èƒ½æ˜¯é˜»å¡çš„ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class=\"line\">    Task task = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!newTask &amp;&amp; isOrhasTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord occludingActivity = getOccludingActivityAbove(r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (occludingActivity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            rTask.positionChildAtTop(r);</span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…è®¸ç§»åŠ¨åˆ°å‰å°ï¼Œå¹¶ä¸”ä¸æ˜¯æ¡Œé¢ç¨‹åºã€æ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä»»åŠ¡æ ˆã€ä»»åŠ¡æ ˆå·²æœ‰activity</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((!isHomeOrRecentsRootTask() || hasActivity()) &amp;&amp; allowMoveToFront) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> doShow = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                resetTaskIfNeeded(r, r);</span><br><span class=\"line\">                doShow = topRunningNonDelayedActivityLocked(<span class=\"keyword\">null</span>) == r;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options != <span class=\"keyword\">null</span> &amp;&amp; options.getAnimationType()</span><br><span class=\"line\">                == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">            doShow = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class=\"line\">            r.setVisibility(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            ensureActivitiesVisible(<span class=\"keyword\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">            mDisplayContent.executeAppTransition();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class=\"line\">            Task baseTask = r.getTask();</span><br><span class=\"line\">            <span class=\"comment\">//â€¼ï¸å¯åŠ¨</span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> ActivityRecord prev = baseTask.getActivity(</span><br><span class=\"line\">                    a -&gt; a.mStartingData != <span class=\"keyword\">null</span> &amp;&amp; a.showToCurrentUser());</span><br><span class=\"line\">            r.showStartingWindow(prev, newTask, isTaskSwitch,</span><br><span class=\"line\">                    <span class=\"keyword\">true</span> <span class=\"comment\">/* startActivity */</span>, sourceRecord);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ç¬¬ä¸€ä¸ªå¯åŠ¨çš„ activity æ— éœ€èŠ±é‡Œèƒ¡å“¨çš„åŠ¨ç”»</span></span><br><span class=\"line\">        ActivityOptions.abort(options);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>showStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showStartingWindow</span><span class=\"params\">(ActivityRecord prev, <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> taskSwitch,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> startActivity, ActivityRecord sourceRecord)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//è¦†ç›–æ—¶ï¼Œä¸ä¼šæ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTaskOverlay) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å…±äº«å…ƒç´ è½¬æ¢æ—¶ï¼Œä¸é™åˆ¶ï¼ˆå…±äº«å…ƒç´ ï¼šAndroid åŠ¨ç”»éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mPendingOptions != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; mPendingOptions.getAnimationType() == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> CompatibilityInfo compatInfo =</span><br><span class=\"line\">            mAtmService.compatibilityInfoForPackageLocked(info.applicationInfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¯å¦ä½¿ç”¨å¯åŠ¨é¡µæ ·å¼</span></span><br><span class=\"line\">    mSplashScreenStyleEmpty = shouldUseEmptySplashScreen(sourceRecord, startActivity);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æˆ‘ä»¬è¿™å°±æ˜¯å¯åŠ¨ activityï¼Œæ‰€ä»¥ startActivit = trueï¼Œé‚£ä¹ˆå°†ä¼šè·å–å¯åŠ¨ä¸»é¢˜</span></span><br><span class=\"line\"><span class=\"comment\">        ï¼ˆä¹Ÿå°±æ˜¯ Android é«˜ç‰ˆæœ¬æ¯ä¸ªåº”ç”¨å¯åŠ¨éƒ½ä¼šæ˜¾ç¤ºçš„å¼€å±é¡µï¼Ÿï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¼€å±ä¸»é¢˜æ˜¯å¯ä»¥é‡å†™çš„ï¼Œé¦–å…ˆå°è¯•è·å–æ˜¯å¦é‡æ–°äº†å¼€å±ä¸»é¢˜ï¼Œå°†è·å–ä¸»é¢˜èµ„æºåç§°</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¦‚æœæ²¡æœ‰é‡å†™ï¼Œå°†ä¼šé€šè¿‡ ATMS æ ¹æ®åŒ…åå’Œç”¨æˆ·IDè·å–ä¸»é¢˜èµ„æºåç§°</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€å¦‚æœè·å–åˆ°å¼€å±ä¸»é¢˜èµ„æºåç§°ï¼Œé‚£ä¹ˆå°†æ ¹æ®åŒ…åé€šè¿‡ createPackageContext åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">           æ¥ç€æ ¹æ®ä¸Šä¸‹æ–‡å’Œä¸»é¢˜åç§°è·å–èµ„æºIDï¼ˆ0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„å¼€å±ä¸»é¢˜ï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> splashScreenTheme = startActivity ? getSplashscreenTheme() : <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œä¼šè¯„ä¼°åº”è¯¥ä½¿ç”¨ theme ä¸»é¢˜è¿˜æ˜¯ splashScreenTheme ä¸»é¢˜</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> resolvedTheme = evaluateStartingWindowTheme(prev, packageName, theme,</span><br><span class=\"line\">            splashScreenTheme);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> activityCreated =</span><br><span class=\"line\">            mState.ordinal() &gt;= STARTED.ordinal() &amp;&amp; mState.ordinal() &lt;= STOPPED.ordinal();</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœä¸æ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œactivity ä¹Ÿè¿˜æ²¡åˆ›å»ºï¼Œé‚£ä¹ˆæœ¬æ¬¡æ˜¯çƒ­å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> newSingleActivity = !newTask &amp;&amp; !activityCreated</span><br><span class=\"line\">            &amp;&amp; task.getActivity((r) -&gt; !r.finishing &amp;&amp; r != <span class=\"keyword\">this</span>) == <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> scheduled = addStartingWindow(packageName, resolvedTheme,</span><br><span class=\"line\">            compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,</span><br><span class=\"line\">            prev, newTask || newSingleActivity, taskSwitch, isProcessRunning(),</span><br><span class=\"line\">            allowTaskSnapshot(), activityCreated, mSplashScreenStyleEmpty);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>addStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">addStartingWindow</span><span class=\"params\">(String pkg, <span class=\"keyword\">int</span> resolvedTheme, CompatibilityInfo compatInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        CharSequence nonLocalizedLabel, <span class=\"keyword\">int</span> labelRes, <span class=\"keyword\">int</span> icon, <span class=\"keyword\">int</span> logo, <span class=\"keyword\">int</span> windowFlags,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ActivityRecord from, <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> taskSwitch, <span class=\"keyword\">boolean</span> processRunning,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowTaskSnapshot, <span class=\"keyword\">boolean</span> activityCreated, <span class=\"keyword\">boolean</span> useEmpty)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//çª—å£è¢«å†»ç»“ï¼Œä¸èƒ½æ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!okToDisplay()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartingData != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å·²æœ‰çª—å£åœ¨æ˜¾ç¤ºï¼Œä¸èƒ½å†æ˜¾ç¤ºäº†</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> WindowState mainWin = findMainWindow();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mainWin != <span class=\"keyword\">null</span> &amp;&amp; mainWin.mWinAnimator.getShown()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> TaskSnapshot snapshot =</span><br><span class=\"line\">            mWmService.mTaskSnapshotController.getSnapshot(task.mTaskId, task.mUserId,</span><br><span class=\"line\">                    <span class=\"keyword\">false</span> <span class=\"comment\">/* restoreFromDisk */</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* isLowResolution */</span>);</span><br><span class=\"line\">                    </span><br><span class=\"line\">     <span class=\"comment\">//STARTING_WINDOW_TYPE_NONEã€STARTING_WINDOW_TYPE_SNAPSHOTã€STARTING_WINDOW_TYPE_SPLASH_SCREEN</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type = getStartingWindowType(newTask, taskSwitch, processRunning,</span><br><span class=\"line\">            allowTaskSnapshot, activityCreated, snapshot);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//é€æ¸çš„ï¼Œè¿™é‡Œä¼¼ä¹æ›´å¤šçš„æ˜¯å’Œ window çª—å£ç›¸å…³ï¼ˆéº»äº†éº»äº†ï¼Œæˆ‘åªæƒ³çœ‹ activity ç›¸å…³ï¼Œç»†èŠ‚å¤ªéš¾äº†ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (type == STARTING_WINDOW_TYPE_SNAPSHOT) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isActivityTypeHome()) &#123;</span><br><span class=\"line\">            mWmService.mTaskSnapshotController.removeSnapshotCache(task.mTaskId);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((mDisplayContent.mAppTransition.getTransitFlags()</span><br><span class=\"line\">                    &amp; WindowManager.TRANSIT_FLAG_KEYGUARD_GOING_AWAY_NO_ANIMATION) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€åˆ†æ”¯ä¸€ã€‘</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> createSnapshot(snapshot, typeParameter);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    ProtoLog.v(WM_DEBUG_STARTING_WINDOW, <span class=\"string\">&quot;Creating SplashScreenStartingData&quot;</span>);</span><br><span class=\"line\">    mStartingData = <span class=\"keyword\">new</span> SplashScreenStartingData(mWmService, pkg,</span><br><span class=\"line\">            resolvedTheme, compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,</span><br><span class=\"line\">            getMergedOverrideConfiguration(), typeParameter);</span><br><span class=\"line\">            </span><br><span class=\"line\">    <span class=\"comment\">//ã€åˆ†æ”¯äºŒã€‘</span></span><br><span class=\"line\">    scheduleAddStartingWindow();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¸Šè¿°æ— è®ºæ˜¯<strong>åˆ†æ”¯ä¸€ã€åˆ†æ”¯äºŒ</strong>ï¼Œéƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•<code>scheduleAddStartingWindow</code>ã€‚</p>\n<h1>scheduleAddStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleAddStartingWindow</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (StartingSurfaceController.DEBUG_ENABLE_SHELL_DRAWER) &#123;</span><br><span class=\"line\">        mAddStartingWindow.run();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æŠŠæ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—æœ€å‰é¢ä¼˜å…ˆå¤„ç†ï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mWmService.mAnimationHandler.hasCallbacks(mAddStartingWindow)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//mWmServiceï¼šWindowManagerService</span></span><br><span class=\"line\">            <span class=\"comment\">//mAnimationHandlerï¼šfinal Handler mAnimationHandler = new Handler(AnimationThread.getHandler().getLooper());</span></span><br><span class=\"line\">            mWmService.mAnimationHandler.postAtFrontOfQueue(mAddStartingWindow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œçš„äº‹æƒ…å’Œ window çª—å£å…³ç³»å¯†åˆ‡ï¼Œsurface çœ‹ç€ç»˜åˆ¶ç›¸å…³ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AddStartingWindow mAddStartingWindow = <span class=\"keyword\">new</span> AddStartingWindow();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddStartingWindow</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//ç•¥ç•¥ç•¥ï¼Œçœ‹ä¸å‡ºå®ƒå¹²äº†å•¥</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>çª—å£ç›¸å…³çš„åˆ°æ­¤ä¸ºæ­¢å§ï¼Œå†è¿›å…¥çœ‹ä¸æ‡‚äº†ã€‚æˆ‘æ›´å…³æ³¨çš„æ˜¯ activity å£°æ˜å‘¨æœŸå›è°ƒï¼Œå¯è¿Ÿè¿Ÿæ²¡æœ‰çœ‹è§ğŸ’”</p>\n<hr>\n<p>é‚£ä¹ˆè¿™æˆ‘ä»¬å§‘ä¸”ä»–æˆåŠŸåœ°æŠŠ activity æ·»åŠ åˆ° window ä¸Šï¼Œç°åœ¨æ˜¯æ—¶å€™å›å¤´çœ‹çœ‹<strong>å¯åŠ¨æˆåŠŸååšäº†äº›ä»€ä¹ˆï¼Ÿ</strong> æ‰€ä»¥æˆ‘ä»¬å›åˆ° <code>ActivityStarter.java</code>ï¼Œè‡ªç„¶è¿˜æ˜¯å›åˆ°è¿™é‡Œ <s>ï¼ˆä»å“ªæ¥ï¼Œå›å“ªå»å§ï¼‰</s></p>\n<h1>The callback [onNewIntent]</h1>\n<p>è¿™é‡Œè®² <code>Activity onNewIntent(Intent intent)</code> ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå…¶å®åƒ onCreatã€onResume ç­‰ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œå…¶ä»–çš„ä¸é‡å¤ã€‚</p>\n<h2 id=\"deliverToCurrentTopIfNeeded\">deliverToCurrentTopIfNeeded</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">startActivityInner</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœæ­£åœ¨å¯åŠ¨çš„ activity å’Œä»»åŠ¡æ ˆé¡¶éƒ¨çš„ activity ç›¸åŒ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topRootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//é¡¶éƒ¨æ˜¯åŒä¸€ä¸ª activityï¼Œæ— éœ€é‡å¤åˆ›å»ºï¼Œå¯åŠ¨ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„åº”è¯¥å›è°ƒ onNewIntent</span></span><br><span class=\"line\">        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;       </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"deliverToCurrentTopIfNeeded-2\">deliverToCurrentTopIfNeeded</h2>\n<figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> deliver<span class=\"constructor\">ToCurrentTopIfNeeded(Task <span class=\"params\">topRootTask</span>, NeededUriGrants <span class=\"params\">intentGrants</span>)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//è·å–å½“å‰æ ˆé¡¶ activity</span></span><br><span class=\"line\">    final ActivityRecord top = topRootTask.top<span class=\"constructor\">RunningNonDelayedActivityLocked(<span class=\"params\">mNotTop</span>)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//activity ç›¸åŒã€å¯åŠ¨ç”¨æˆ·ç›¸åŒã€æ ˆé¡¶å¤ç”¨ã€å¯åŠ¨ç›®æ ‡</span></span><br><span class=\"line\">    final boolean dontStart = top != null</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.mActivityComponent.equals(mStartActivity.mActivityComponent)</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.mUserId<span class=\"operator\"> == </span>mStartActivity.mUserId</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.attached<span class=\"constructor\">ToProcess()</span></span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"operator\">            || </span>LAUNCH_SINGLE_TOP<span class=\"operator\"> == </span>mLaunchMode)</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>(!top.is<span class=\"constructor\">ActivityTypeHome()</span><span class=\"operator\"> || </span>top.get<span class=\"constructor\">DisplayArea()</span><span class=\"operator\"> == </span>mPreferredTaskDisplayArea);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!dontStart) &#123;</span><br><span class=\"line\">        return START_SUCCESS;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    top.get<span class=\"constructor\">TaskFragment()</span>.clear<span class=\"constructor\">LastPausedActivity()</span>;</span><br><span class=\"line\">    <span class=\"comment\">//activity æ˜¾ç¤ºï¼Œåé¢çœ‹</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        mRootWindowContainer.resume<span class=\"constructor\">FocusedTasksTopActivities()</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œä¼šè¿›å…¥ ActivitRecord</span></span><br><span class=\"line\">    deliver<span class=\"constructor\">NewIntent(<span class=\"params\">top</span>, <span class=\"params\">intentGrants</span>)</span>;</span><br><span class=\"line\">    return START_DELIVERED_TO_TOP;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"deliverNewIntentLocked\">deliverNewIntentLocked</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">deliverNewIntentLocked</span><span class=\"params\">(<span class=\"keyword\">int</span> callingUid, Intent intent, NeededUriGrants intentGrants,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">if</span> ((mState == RESUMED || mState == PAUSED || isTopActivityWhileSleeping)</span></span></span><br><span class=\"line\"><span class=\"function\">            &amp;&amp; <span class=\"title\">attachedToProcess</span><span class=\"params\">()</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ArrayList&lt;ReferrerIntent&gt; ar = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(<span class=\"number\">1</span>);</span><br><span class=\"line\">            ar.add(rintent);</span><br><span class=\"line\">            <span class=\"comment\">//å¼€å§‹è°ƒç”¨å£°æ˜å‘¨æœŸç›¸å…³ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡ ClientTransaction</span></span><br><span class=\"line\">            <span class=\"comment\">//getLifecycleManager -&gt; ClientLifecycleManager å£°æ˜å‘¨æœŸç›¸å…³å›è°ƒéƒ½ä¼šé€šè¿‡å®ƒ</span></span><br><span class=\"line\">            mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,</span><br><span class=\"line\">                    NewIntentItem.obtain(ar, mState == RESUMED));</span><br><span class=\"line\">            unsent = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">            Slog.w(TAG, <span class=\"string\">&quot;Exception thrown sending new intent to &quot;</span> + <span class=\"keyword\">this</span>, e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NullPointerException e) &#123;</span><br><span class=\"line\">            Slog.w(TAG, <span class=\"string\">&quot;Exception thrown sending new intent to &quot;</span> + <span class=\"keyword\">this</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (unsent) &#123;</span><br><span class=\"line\">        addNewIntentLocked(rintent);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ClientLfecycleManager.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> <span class=\"keyword\">throws</span> RemoteException </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªäº‹ç‰©ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œå…³é”®æ˜¯è¿™ä¸ªæ˜¯äº‹åŠ¡ï¼ˆbinder)äº‹åŠ¡ä¼ é€’æ•°æ®çš„ï¼Œæˆ–åˆ™äº‹åŠ¡å‘é€åå°†åœ¨å“ªé‡Œå¤„ç†äº‹åŠ¡ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> IApplicationThread client = transaction.getClient();</span><br><span class=\"line\">    transaction.schedule();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(client <span class=\"keyword\">instanceof</span> Binder)) &#123;</span><br><span class=\"line\">        transaction.recycle();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ClientTransaction-schedule\">ClientTransaction.schedule</h2>\n<p><code>ClientTransaction</code>: A container that holds a sequence of messages, which may be sent to a client. This includes a list of callbacks and a final lifecycle state.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ClientTransaction.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    1ã€IApplicationThread è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ aidl æ¥å£ï¼Œæ¥å£å®ç°è‡ªç„¶æ˜¯ IApplicationThread.Sub</span></span><br><span class=\"line\"><span class=\"comment\">    2ã€å®ç°ç±»åœ¨ ActivityThreadï¼Œprivate class ApplicationThread extends IApplicationThread.Stub </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> IApplicationThread mClient;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Schedule the transaction after it was initialized. It will be send to client and all its</span></span><br><span class=\"line\"><span class=\"comment\"> * individual parts will be applied in the following sequence:</span></span><br><span class=\"line\"><span class=\"comment\"> * 1. The client calls &#123;<span class=\"doctag\">@link</span> #preExecute(ClientTransactionHandler)&#125;, which triggers all work</span></span><br><span class=\"line\"><span class=\"comment\"> *    that needs to be done before actually scheduling the transaction for callbacks and</span></span><br><span class=\"line\"><span class=\"comment\"> *    lifecycle state request.</span></span><br><span class=\"line\"><span class=\"comment\"> * 2. The transaction message is scheduled.</span></span><br><span class=\"line\"><span class=\"comment\"> * 3. The client calls &#123;<span class=\"doctag\">@link</span> TransactionExecutor#execute(ClientTransaction)&#125;, which executes</span></span><br><span class=\"line\"><span class=\"comment\"> *    all callbacks and necessary lifecycle transitions.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">schedule</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> RemoteException </span></span><br><span class=\"line\"><span class=\"function\">    mClient.<span class=\"title\">scheduleTransaction</span><span class=\"params\">(<span class=\"keyword\">this</span>)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ApplicationThread-scheduleTransaction\">ApplicationThread.scheduleTransaction</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ApplicationThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">IApplicationThread</span>.<span class=\"title\">Stub</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> <span class=\"keyword\">throws</span> RemoteException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//åœ¨å½“å‰ç±»æ–‡ä»¶æœç´¢æ²¡çœ‹åˆ°æ–¹æ³•å®šä¹‰ï¼Œå·®ç‚¹æ€€ç–‘äººç”Ÿï¼›ç„¶åçœ‹çœ‹ ActivitThread è¿˜æœ‰çˆ¶ç±»ï¼Œé‚£æ–¹æ³•å®šä¹‰å°±åœ¨çˆ¶ç±»äº†</span></span><br><span class=\"line\">        ActivityThread.<span class=\"keyword\">this</span>.scheduleTransaction(transaction);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ActivityThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">ClientTransactionHandler</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"keyword\">implements</span> <span class=\"title\">ActivityThreadInternal</span> </span>&#123;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClientTransactionHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        transaction.preExecute(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">//å‘é€æ¶ˆæ¯ï¼Œé‚£è€…å°±æ˜ç¡®å¾ˆå¤šäº†</span></span><br><span class=\"line\">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">H</span> <span class=\"keyword\">extends</span> <span class=\"title\">Handler</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> EXECUTE_TRANSACTION = <span class=\"number\">159</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleMessage</span><span class=\"params\">(Message msg)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (msg.what) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> EXECUTE_TRANSACTION:</span><br><span class=\"line\">                <span class=\"comment\">//å›å¤´çœ‹çœ‹ schedule çš„æ³¨é‡Šï¼Œä¸‹ä¸€æ­¥åº”è¯¥ä¼šåˆ°å“ªé‡Œå»æ‰§è¡Œï¼Œå…¶å®åˆ«äººæ˜¯å†™å¾—å¾ˆæ¸…æ¥šçš„ï¼ˆç†Ÿèƒ½ç”Ÿå·§ï¼Œåˆçœ‹ç¡®å®ä¸€å¤´é›¾æ°´ï¼‰</span></span><br><span class=\"line\">                <span class=\"keyword\">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class=\"line\">                mTransactionExecutor.execute(transaction);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (isSystem()) &#123;</span><br><span class=\"line\">                    transaction.recycle();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"TransactionExecutor-excute\">TransactionExecutor.excute</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//TransactionExecutor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class=\"string\">&quot;Start resolving transaction&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ä¼¼ä¹æ¯ä¸€ä¸ª activity éƒ½æœ‰ä¸€ä¸ª tokenï¼Œè¿˜ä¸æ¸…æ¥šä»ä½•è€Œæ¥</span></span><br><span class=\"line\">    <span class=\"comment\">//åˆå­¦ Android æ—¶ï¼Œå…³äº activity token çš„æŠ¥é”™ä¼°è®¡ä½ ä¹Ÿé‡åˆ°è¿‡</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> IBinder token = transaction.getActivityToken();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (token != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Map&lt;IBinder, ClientTransactionItem&gt; activitiesToBeDestroyed =</span><br><span class=\"line\">                mTransactionHandler.getActivitiesToBeDestroyed();</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ClientTransactionItem destroyItem = activitiesToBeDestroyed.get(token);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (destroyItem != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (transaction.getLifecycleStateRequest() == destroyItem) &#123;</span><br><span class=\"line\">                activitiesToBeDestroyed.remove(token);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mTransactionHandler.getActivityClient(token) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™ä¸ªæš‚ä¸å…³æ³¨ï¼Œé‡ç‚¹çœ‹çœ‹ä¸‹é¢çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒå§</span></span><br><span class=\"line\">    executeCallbacks(transaction);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€cycleToPath(r, lifecycleItem.getTargetState(), true , transaction);  -&gt; performLifecycleSequence</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">        //çœ‹äº†ä¸€åœˆï¼Œç€ä¸¤ä¸ªå®ç°åº”è¯¥æ˜¯åœ¨å­ç±»</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    executeLifecycleState(transaction);</span><br><span class=\"line\">    mPendingActions.clear();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class=\"string\">&quot;End resolving transaction&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//TransactionExecutor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">performLifecycleSequence</span><span class=\"params\">(ActivityClientRecord r, IntArray path,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size = path.size();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>, state; i &lt; size; i++) &#123;</span><br><span class=\"line\">        state = path.get(i);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//æ˜¯å§ï¼Œå‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒéƒ½æœ‰ï¼›é‚£å°±å¥‡æ€ªäº†æ€ä¹ˆæ²¡æœ‰ onNewIntentï¼Œä»–ä¸ç®—æ˜¯ç”Ÿå‘½å‘¨æœŸå‡½æ•°å—ï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"comment\">//å’šå’šå’šå’šï¼ˆæ•²é»‘æ¿ï½ï¼‰</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€onNewIntent ä¸æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œåªæ˜¯å£°æ˜å‘¨æœŸå›è°ƒè¿‡ç¨‹ä¸­å¯èƒ½è¢«æ‰§è¡Œçš„ä¸€ä¸ªæ–¹æ³•</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€å¦‚æœæ»¡è¶³æŸäº›æ¡ä»¶ï¼Œæ ¹æ®ç»éªŒæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•åœ¨ onResume ä¹‹å‰ä¼šæ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€é‚£ä¹ˆæˆ‘ä»¬çŒœæµ‹ï¼ˆæˆ‘çœ‹äº†ä»£ç å†æ¥çŒœæµ‹çš„ğŸ˜ï¼‰ï¼Œè¯¥æ–¹æ³•çš„å›è°ƒæœ‰æ²¡æœ‰å¯èƒ½åœ¨ handleResumeActivity é‡Œé¢æ‰§è¡Œï¼Ÿé‚£å°±å»çœ‹çœ‹å§ï¼</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_CREATE:</span><br><span class=\"line\">                mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class=\"line\">                        <span class=\"keyword\">null</span> <span class=\"comment\">/* customIntent */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_START:</span><br><span class=\"line\">                mTransactionHandler.handleStartActivity(r, mPendingActions,</span><br><span class=\"line\">                        <span class=\"keyword\">null</span> <span class=\"comment\">/* activityOptions */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_RESUME:</span><br><span class=\"line\">                mTransactionHandler.handleResumeActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finalStateRequest */</span>,</span><br><span class=\"line\">                        r.isForward, <span class=\"string\">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_PAUSE:</span><br><span class=\"line\">                mTransactionHandler.handlePauseActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finished */</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">false</span> <span class=\"comment\">/* userLeaving */</span>, <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>, mPendingActions,</span><br><span class=\"line\">                        <span class=\"string\">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_STOP:</span><br><span class=\"line\">                mTransactionHandler.handleStopActivity(r, <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>,</span><br><span class=\"line\">                        mPendingActions, <span class=\"keyword\">false</span> <span class=\"comment\">/* finalStateRequest */</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_DESTROY:</span><br><span class=\"line\">                mTransactionHandler.handleDestroyActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finishing */</span>,</span><br><span class=\"line\">                        <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* getNonConfigInstance */</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class=\"number\">1</span>));</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_RESTART:</span><br><span class=\"line\">                mTransactionHandler.performRestartActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* start */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Unexpected lifecycle state: &quot;</span> + state);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ClientTransactionHandler æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥å£°æ˜å‘¨æœŸå›è°ƒè¿˜å¾—æ‰¾ ClientTransactionHandler çš„å®ç°ç±» <code>ActivitThread</code>ã€‚</p>\n<p>ç»•ä¸€åœˆåˆå›æ¥ï¼Œè¿™è¿™è¿™ï½ï½ï½</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69c055d008d74b45bd1205352739f8b9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h2 id=\"ActivitThread-performResumeActivity\">ActivitThread.performResumeActivity</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">performResumeActivity</span><span class=\"params\">(ActivityClientRecord r, <span class=\"keyword\">boolean</span> finalStateRequest,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String reason)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.activity.mFinished) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å·²ç» resumed å°±ä¸é‡å¤äº†</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.getLifecycleState() == ON_RESUME) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!finalStateRequest) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> RuntimeException e = <span class=\"keyword\">new</span> IllegalStateException(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Trying to resume activity which is already resumed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (finalStateRequest) &#123;</span><br><span class=\"line\">        r.hideForNow = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        r.activity.mStartedActivity = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        r.activity.onStateNotSaved();</span><br><span class=\"line\">        r.activity.mFragments.noteStateNotSaved();</span><br><span class=\"line\">        checkAndBlockForNetworkAccess();</span><br><span class=\"line\">        <span class=\"comment\">//çœ‹åˆ°æ²¡ï¼Œæ»¡è¶³æŸäº›æ¡ä»¶æƒ…å†µä¸‹æ˜¯ä¼šèµ° onNewIntent </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.pendingIntents != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            deliverNewIntents(r, r.pendingIntents);</span><br><span class=\"line\">            r.pendingIntents = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.pendingResults != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            deliverResults(r, r.pendingResults, reason);</span><br><span class=\"line\">            r.pendingResults = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//onResume å›è°ƒåœ¨è¿™é‡Œï¼Œæœ¬æ¬¡æˆ‘ä»¬æš‚ä¸å…³æ³¨</span></span><br><span class=\"line\">        r.activity.performResume(r.startsNotResumed, reason);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//æŠŠçŠ¶æ€è®¾ç½®ä¸€ä¸‹</span></span><br><span class=\"line\">        r.state = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        r.persistentState = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        r.setState(ON_RESUME);</span><br><span class=\"line\"></span><br><span class=\"line\">        reportTopResumedActivityChanged(r, r.isTopResumedActivity, <span class=\"string\">&quot;topWhenResuming&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Unable to resume activity &quot;</span></span><br><span class=\"line\">                    + r.intent.getComponent().toShortString() + <span class=\"string\">&quot;: &quot;</span> + e.toString(), e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">deliverNewIntents</span><span class=\"params\">(ActivityClientRecord r, List&lt;ReferrerIntent&gt; intents)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> N = intents.size();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;N; i++) &#123;</span><br><span class=\"line\">        ReferrerIntent intent = intents.get(i);</span><br><span class=\"line\">        intent.setExtrasClassLoader(r.activity.getClassLoader());</span><br><span class=\"line\">        intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),</span><br><span class=\"line\">                r.activity.getAttributionSource());</span><br><span class=\"line\">        r.activity.mFragments.noteStateNotSaved();</span><br><span class=\"line\">        <span class=\"comment\">//æœ€åè¿˜æ˜¯äº¤ç»™ â€˜å¤§ç®¡å®¶â€™ æ‰§è¡Œå•Šï¼Œå›åˆ°äº†é‚£ä¸ªç†Ÿæ‚‰çš„å¯¹è±¡</span></span><br><span class=\"line\">        mInstrumentation.callActivityOnNewIntent(r.activity, intent);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Instrumentation-callActivityOnNewIntent\">Instrumentation.callActivityOnNewIntent</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Instrumentation.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">callActivityOnNewIntent</span><span class=\"params\">(Activity activity, ReferrerIntent intent)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> String oldReferrer = activity.mReferrer;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (intent != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            activity.mReferrer = intent.mReferrer;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        callActivityOnNewIntent(activity, intent != <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> Intent(intent) : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        activity.mReferrer = oldReferrer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Instrumentation.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">callActivityOnNewIntent</span><span class=\"params\">(Activity activity, Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//ä»€ä¹ˆï¼ŸInstrumentation ä¸ç†Ÿæ‚‰ï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//é‚£ activity æ€»è¯¥ç†Ÿæ‚‰äº†å§</span></span><br><span class=\"line\">    activity.performNewIntent(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Activity.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">performNewIntent</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    mCanEnterPictureInPicture = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    onNewIntent(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Activity.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onNewIntent</span><span class=\"params\">(Intent intent)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å°±åˆ°è¿™é‡Œç»“æŸå§ï¼Œçœ‹èµ·æ¥æ²¡é‚£ä¹ˆåƒæ ·ã€‚è™½ç„¶æ˜¯ <code>æ¡Œé¢å¯åŠ¨</code>ï¼Œåæ¥è¶Šæ„Ÿè§‰åƒæ˜¯ <code>Activity å¯åŠ¨</code>ã€‚<s>éƒ½ä¹±å¥—äº†</s> ï¼Œå¯æ˜¯ï¼Œæ¡Œé¢ä¸ä¹Ÿæ˜¯ä¸€ä¸ª activity å—ğŸ¤”ï¸</p>\n","site":{"data":{}},"excerpt":"","more":"<p>æ¡Œé¢å¯åŠ¨ç±»ä¼¼ Activity å¯åŠ¨ï¼Œæ¥ç€ä¸Šä¸€ç« èŠ‚ç»§ç»­æŸ¥é˜…å¯åŠ¨æµç¨‹ï¼Œå¯åŠ¨é™åˆ¶ã€å¯åŠ¨æ¡ä»¶æ£€æŸ¥æ˜¯é‡ç‚¹ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šé€æ­¥å›è°ƒç»™å¤–éƒ¨ï¼Œè¿™é‡Œåªæ˜¯ç²—ç•¥æè¿°å¯åŠ¨è¿‡ç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…æ‹¬çª—å£çš„åˆ›å»ºã€ç»˜åˆ¶ç­‰ç­‰ã€‚</p>\n<h1>startActivityUnchecked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">startActivityUnchecked</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> result = START_CANCELED;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> startResultSuccessful = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task startedActivityRootTask;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//TRANSIT_OPENï¼šåˆ›å»ºä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„æ–°çª—å£ï¼Œå¹¶ä¸”è®©çª—å£å¯è§</span></span><br><span class=\"line\">    <span class=\"comment\">//transitType è¿˜ä¼šå½±å“çª—å£ç»˜åˆ¶æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤æ˜¯ 5ç§’ï¼Œå¦‚æœæ˜¯ chenge ç±»å‹å»¶æ—¶å°†ç¼©çŸ­åˆ° 2 ç§’</span></span><br><span class=\"line\">    <span class=\"comment\">//ä¹Ÿä¼šæŠŠ windowContain æ·»åŠ åˆ°é›†åˆä¸­ï¼Œç­‰å¾…çª—å£ç»˜åˆ¶</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> TransitionController transitionController = r.mTransitionController;</span><br><span class=\"line\">    Transition newTransition = (!transitionController.isCollecting()</span><br><span class=\"line\">            &amp;&amp; transitionController.getTransitionPlayer() != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            ? transitionController.createTransition(TRANSIT_OPEN) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    RemoteTransition remoteTransition = r.takeRemoteTransition();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newTransition != <span class=\"keyword\">null</span> &amp;&amp; remoteTransition != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        newTransition.setRemoteTransition(remoteTransition);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    transitionController.collect(r);</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isTransient = r.getOptions() != <span class=\"keyword\">null</span> &amp;&amp; r.getOptions().getTransientLaunch();</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//å»¶è¿Ÿçª—å£æµ‹é‡ï¼Œåˆä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å˜é‡ mDeferDepth++ï¼Œæ§åˆ¶æµ‹é‡ã€ç»˜åˆ¶æ¬¡æ•°ï¼Œé¿å…é€’å½’å¾ªç¯</span></span><br><span class=\"line\">        mService.deferWindowLayout();</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸åˆæ˜¯ä¸€ä¸ªå¯åŠ¨é˜¶æ®µ</span></span><br><span class=\"line\">        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class=\"line\">                startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,</span><br><span class=\"line\">                intentGrants);</span><br><span class=\"line\">        startResultSuccessful = ActivityManager.isStartResultSuccessful(result);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> taskAlwaysOnTop = options != <span class=\"keyword\">null</span> &amp;&amp; options.getTaskAlwaysOnTop();</span><br><span class=\"line\">        <span class=\"comment\">// Apply setAlwaysOnTop when starting an Activity is successful regardless of creating</span></span><br><span class=\"line\">        <span class=\"comment\">// a new Activity or recycling the existing Activity.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (taskAlwaysOnTop &amp;&amp; startResultSuccessful) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> Task targetRootTask =</span><br><span class=\"line\">                    mTargetRootTask != <span class=\"keyword\">null</span> ? mTargetRootTask : mTargetTask.getRootTask();</span><br><span class=\"line\">            targetRootTask.setAlwaysOnTop(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        Trace.traceEnd(Trace.TRACE_TAG_WINDOW_MANAGER);</span><br><span class=\"line\">        <span class=\"comment\">//â€¼ï¸æ— è®ºæˆåŠŸå¤±è´¥ä¸å¦ï¼Œå¯åŠ¨è§£é‡Šéƒ½åº”è¯¥åˆ†å‘å‡ºå»</span></span><br><span class=\"line\">        startedActivityRootTask = handleStartResult(r, result);</span><br><span class=\"line\">        <span class=\"comment\">//å»¶æ—¶çª—å£æµ‹é‡å°†è¢«æ¢å¤</span></span><br><span class=\"line\">        mService.continueWindowLayout();</span><br><span class=\"line\">        mSupervisor.mUserLeaving = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    postStartActivityProcessing(r, result, startedActivityRootTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"about-TransitionType\">about TransitionType</h2>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">@IntDef</span>(prefix = &#123; <span class=\"string\">&quot;TRANSIT_&quot;</span> &#125;, value = &#123;</span><br><span class=\"line\">        TRANSIT_NONE,</span><br><span class=\"line\">        TRANSIT_OPEN,                 <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œå¹¶ä¸”ä½¿å…¶å¯è§</span></span><br><span class=\"line\">        TRANSIT_CLOSE,                <span class=\"comment\">//å¯è§çš„çª—å£è¢«å…³é—­ï¼ˆfinished æˆ– destroyedï¼‰</span></span><br><span class=\"line\">        TRANSIT_TO_FRONT,             <span class=\"comment\">//ä¸å¯è§çš„çª—å£å°†å˜ä¸ºå¯è§</span></span><br><span class=\"line\">        TRANSIT_TO_BACK,              <span class=\"comment\">//å¯è§çš„çª—å£å˜ä¸ºä¸å¯è§</span></span><br><span class=\"line\">        TRANSIT_RELAUNCH,</span><br><span class=\"line\">        TRANSIT_CHANGE,               <span class=\"comment\">//å¯è§çª—å£å‘ç”Ÿæ”¹å˜ï¼ˆæ¯”å¦‚å±å¹•æ–¹å‘ã€å¤§å°æ”¹å˜ï¼‰</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_GOING_AWAY,  <span class=\"comment\">//ï¼ˆå·²åºŸå¼ƒï¼‰</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_OCCLUDE,     <span class=\"comment\">//é”®ç›˜é”å®š</span></span><br><span class=\"line\">        TRANSIT_KEYGUARD_UNOCCLUDE,   <span class=\"comment\">//é”®ç›˜è§£é”</span></span><br><span class=\"line\">        TRANSIT_PIP,                  <span class=\"comment\">//ç”»ä¸­ç”»</span></span><br><span class=\"line\">        TRANSIT_WAKE,                 <span class=\"comment\">//ï¼ˆæ­£åœ¨æ‰“å¼€ï¼Ÿï¼‰</span></span><br><span class=\"line\">        TRANSIT_FIRST_CUSTOM</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"variable\">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class=\"line\"><span class=\"variable\">@interface</span> TransitionType &#123;&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityInner</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">startActivityInner</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">    setInitialState(r, options, inTask, inTaskFragment, doResume, startFlags, sourceRecord,</span><br><span class=\"line\">            voiceSession, voiceInteractor, restrictedBgActivity);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ç¡®å®š activity æ‰€å¯åŠ¨çš„ä»»åŠ¡æ ˆåº”è¯¥æ˜¯ NEW_TASK è¿˜æ˜¯åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆå¯åŠ¨</span></span><br><span class=\"line\">    computeLaunchingTaskFlags();</span><br><span class=\"line\">    computeSourceRootTask();</span><br><span class=\"line\">    mIntent.setFlags(mLaunchFlags);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœè¯·æ±‚å·²ç»å¼€å§‹ï¼Œåº”è¯¥å†»ç»“æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ï¼Œç­‰å¾…ä¸‹æ¬¡æ›´æ–°</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task prevTopTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task reusedTask = getReusableTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mOptions != <span class=\"keyword\">null</span> &amp;&amp; mOptions.freezeRecentTasksReordering()</span><br><span class=\"line\">            &amp;&amp; mSupervisor.mRecentTasks.isCallerRecents(r.launchedFromUid)</span><br><span class=\"line\">            &amp;&amp; !mSupervisor.mRecentTasks.isFreezeTaskListReorderingSet()) &#123;</span><br><span class=\"line\">        mFrozeTaskList = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        mSupervisor.mRecentTasks.setFreezeTaskListReordering();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è®¡ç®—æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡æ ˆå¯ä»¥å¤ç”¨ï¼Œå¦åˆ™åº”è¯¥åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task targetTask = reusedTask != <span class=\"keyword\">null</span> ? reusedTask : computeTargetTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> newTask = targetTask == <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    mTargetTask = targetTask;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ç¡®å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚ windowType</span></span><br><span class=\"line\">    computeLaunchParams(r, sourceRecord, targetTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//åˆæ˜¯ä¸€ç•ªå¯åŠ¨é™åˆ¶ï¼Œåœ¨ä»»åŠ¡æ ˆå±‚é¢é™åˆ¶å¯åŠ¨ğŸš«</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> startResult = isAllowedToStart(r, newTask, targetTask);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¤ç”¨ä»»åŠ¡æ ˆ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> ActivityRecord targetTaskTop = newTask</span><br><span class=\"line\">            ? <span class=\"keyword\">null</span> : targetTask.getTopNonFinishingActivity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (targetTaskTop != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€resumeTargetRootTaskIfNeeded</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€mRootWindowContainer.resumeFocusedTasksTopActivities</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        startResult = recycleTask(targetTask, targetTaskTop, reusedTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        mAddingToTask = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€å¦‚æœå¯åŠ¨çš„ activity æ˜¯åœ¨ä»»åŠ¡æ ˆä¸­å·²å­˜åœ¨ï¼Œåˆ™åªéœ€å¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶è°ƒç”¨ activity çš„ onNewIntent æ–¹æ³•å³å¯</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å›è°ƒæ–¹æ³• deliverNewIntent(top, intentGrants); ActivityRecorder#deliverNewIntentLocked</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,</span></span><br><span class=\"line\"><span class=\"comment\">        NewIntentItem.obtain(ar, mState == RESUMED));</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topRootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨åˆ™å¤ç”¨</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTargetRootTask == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mTargetRootTask = getLaunchRootTask(mStartActivity, mLaunchFlags, targetTask, mOptions);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Task taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                ? mSourceRecord.getTask() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        setNewTask(taskToAffiliate);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mAddingToTask) &#123;</span><br><span class=\"line\">        addOrReparentStartingActivity(targetTask, <span class=\"string\">&quot;adding to task&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨çš„ç›®æ ‡ä»»åŠ¡æ ˆæœ‰äº†ï¼Œç›´æ¥çœ‹ activity å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task startedTask = mStartActivity.getTask();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isTaskSwitch = startedTask != prevTopTask &amp;&amp; !startedTask.isEmbedded();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨</span></span><br><span class=\"line\">    mTargetRootTask.startActivityLocked(mStartActivity,</span><br><span class=\"line\">            topRootTask != <span class=\"keyword\">null</span> ? topRootTask.getTopNonFinishingActivity() : <span class=\"keyword\">null</span>, newTask,</span><br><span class=\"line\">            isTaskSwitch, mOptions, sourceRecord);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord topTaskActivity = startedTask.topRunningActivityLocked();</span><br><span class=\"line\">        <span class=\"comment\">//å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶æ²¡æœ‰è·å¾—ç„¦ç‚¹ï¼Œå¹¶ä¸”å½“å‰å¯åŠ¨çš„ä¸æ˜¯æœ¬æ¬¡æƒ³å¯åŠ¨çš„ï¼Œä¹Ÿè¦ç¡®ä¿å®ƒæ˜¾ç¤ºï¼ˆå®ƒå¯èƒ½æ˜¯æ›´é‡è¦çš„ activity æŠ¢å…ˆæ˜¾ç¤ºå‘¢ï¼‰</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mTargetRootTask.isTopActivityFocusable()</span><br><span class=\"line\">                || (topTaskActivity != <span class=\"keyword\">null</span> &amp;&amp; topTaskActivity.isTaskOverlay()</span><br><span class=\"line\">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class=\"line\">                </span><br><span class=\"line\">            mTargetRootTask.ensureActivitiesVisible(<span class=\"keyword\">null</span> <span class=\"comment\">/* starting */</span>,</span><br><span class=\"line\">            mTargetRootTask.mDisplayContent.executeAppTransition();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//å¦‚æœæœ¬æ¬¡å¯åŠ¨çš„ activity æ‰€åœ¨ä»»åŠ¡æ ˆä¸­å¹¶å·²è·å¾—ç„¦ç‚¹ï¼Œå¦‚æœè¯¥ä»»åŠ¡æ ˆæ²¡æœ‰æ˜¾ç¤ºåœ¨æœ€å‰åˆ™ moveToFront</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mTargetRootTask.isTopActivityFocusable()</span><br><span class=\"line\">                    &amp;&amp; !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) &#123;</span><br><span class=\"line\">                mTargetRootTask.moveToFront(<span class=\"string\">&quot;startActivityInner&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//è¿™é‡Œå’Œä¸Šè¿° recycleTask ç›¸ä¼¼ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ã€‚ï¼ˆæŠŠ activity è½¬ç§»ä¸ºå¯è§çŠ¶æ€ï¼‰</span></span><br><span class=\"line\">            mRootWindowContainer.resumeFocusedTasksTopActivities(</span><br><span class=\"line\">                    mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨å®Œæ¯•éœ€è¦æ›´æ–°æœ€è¿‘ä»»åŠ¡æ ˆç­‰</span></span><br><span class=\"line\">    mRootWindowContainer.updateUserRootTask(mStartActivity.mUserId, mTargetRootTask);</span><br><span class=\"line\">    mSupervisor.mRecentTasks.add(startedTask);</span><br><span class=\"line\">    mSupervisor.handleNonResizableTaskIfNeeded(startedTask,</span><br><span class=\"line\">            mPreferredWindowingMode, mPreferredTaskDisplayArea, mTargetRootTask);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"isAllowedToStart\">isAllowedToStart</h2>\n<p>æ£€æŸ¥ activity æ˜¯å¦å¯ä»¥åœ¨å·²æœ‰çš„ä»»åŠ¡æ ˆæˆ–è€…æ–°çš„ä»»åŠ¡æ ˆä¸­å¯åŠ¨ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">isAllowedToStart</span><span class=\"params\">(ActivityRecord r, <span class=\"keyword\">boolean</span> newTask, Task targetTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//âŒ1ã€æ²¡æœ‰åŒ…åæ˜¯ä¸å…è®¸çš„ï¼ˆæ¯ä¸ª activity éƒ½æœ‰æ‰€å±çš„åŒ…ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartActivity.packageName == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mStartActivity.resultTo != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mStartActivity.resultTo.sendResult(INVALID_UID, mStartActivity.resultWho,</span><br><span class=\"line\">                    mStartActivity.requestCode, RESULT_CANCELED,</span><br><span class=\"line\">                    <span class=\"keyword\">null</span> <span class=\"comment\">/* data */</span>, <span class=\"keyword\">null</span> <span class=\"comment\">/* dataGrants */</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ActivityOptions.abort(mOptions);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_CLASS_NOT_FOUND;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€åº”ç”¨å¤„äº instrument çŠ¶æ€æ—¶ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¦‚æœæ˜¯ VR æ˜¾ç¤ºIDæˆ–è€…é»˜è®¤æ˜¾ç¤ºIDï¼Œå…è®¸å¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€launchMode != SINGLE_TASK &amp;&amp; launchMode != SINGLE_INSTANCE å±äºå·²æœ‰å¯åŠ¨çŠ¶æ€ï¼Œåº”è¯¥å–æ¶ˆå¯åŠ¨</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.isActivityTypeHome()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mRootWindowContainer.canStartHomeOnDisplayArea(r.info, mPreferredTaskDisplayArea,</span><br><span class=\"line\">                <span class=\"keyword\">true</span> <span class=\"comment\">/* allowInstrumenting */</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_CANCELED;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€âŒå¦‚æœæ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€âŒå¦‚æœè°ƒç”¨è€… uid ä¸æ˜¯å½“å‰ç¨‹åºï¼ˆå½“å‰ä»»åŠ¡æ ˆï¼‰ï¼Œå¯åŠ¨æ—¶ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€âŒå¦‚æœæ˜¯éœ€è¦åˆ›å»ºæ–°çš„ä»»åŠ¡æ ˆï¼Œä»åå°å¯åŠ¨çš„ activity æ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> blockBalInTask = (newTask</span><br><span class=\"line\">            || !targetTask.isUidPresent(mCallingUid)</span><br><span class=\"line\">            || (LAUNCH_SINGLE_INSTANCE == mLaunchMode &amp;&amp; targetTask.inPinnedWindowingMode()));</span><br><span class=\"line\">    <span class=\"comment\">// mRestrictedBgActivityï¼šä¸¥æ ¼æŠŠæ§ activity çš„å¯åŠ¨ğŸš«ï¼ˆè¯¥æ¡ä»¶å‰ä¸€ç¯‡æœ‰æåˆ°ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mRestrictedBgActivity &amp;&amp; blockBalInTask</span><br><span class=\"line\">            &amp;&amp; handleBackgroundActivityAbort(mStartActivity)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_ABORTED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//è¿˜æ˜¯åœ¨ä¸æ–­é™åˆ¶å¯åŠ¨ï¼Œæ¡ä»¶è‹›åˆ»å•Š</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isNewClearTask =</span><br><span class=\"line\">            (mLaunchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</span><br><span class=\"line\">                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!newTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getLockTaskController().isLockTaskModeViolation(targetTask,</span><br><span class=\"line\">                isNewClearTask)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mService.getLockTaskController().isNewTaskLockTaskModeViolation(mStartActivity)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mInTaskFragment != <span class=\"keyword\">null</span> &amp;&amp; !canEmbedActivity(mInTaskFragment, r, newTask, targetTask)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> START_PERMISSION_DENIED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âœ…å¦åˆ™ï¼Œæ˜¯å¯åŠ¨æ˜¯å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> START_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"canEmbedActivity\">canEmbedActivity</h2>\n<p>æ˜¯å¦å¯ä»¥åµŒå…¥ï¼Ÿactivity åµŒå…¥ï¼Ÿ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canEmbedActivity</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> TaskFragment taskFragment, ActivityRecord starting,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> newTask, Task targetTask)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task hostTask = taskFragment.getTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hostTask == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âœ…å¦‚æœæ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ˜¯å…è®¸åµŒå…¥å¯åŠ¨çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> hostUid = hostTask.effectiveUid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (UserHandle.getAppId(hostUid) == Process.SYSTEM_UID) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒå¦‚æœä¸æ˜¯å½“å‰åº”ç”¨è¿›ç¨‹å¯åŠ¨ï¼Œæ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hostUid != starting.getUid()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//âŒå¦‚æœä¸æ˜¯åŒä¸€ä¸ªä»»åŠ¡æ ˆï¼ˆä¸»ä»»åŠ¡æ ˆï¼‰ä¸­å¯åŠ¨ï¼Œä¹Ÿæ˜¯ä¸å…è®¸çš„</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> !newTask &amp;&amp; (targetTask == <span class=\"keyword\">null</span> || targetTask == hostTask);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>startActivityLocked</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Task.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startActivityLocked</span><span class=\"params\">(ActivityRecord r, <span class=\"meta\">@Nullable</span> ActivityRecord focusedTopActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> isTaskSwitch, ActivityOptions options,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"meta\">@Nullable</span> ActivityRecord sourceRecord)</span> </span>&#123;</span><br><span class=\"line\">    Task rTask = r.getTask();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> allowMoveToFront = options == <span class=\"keyword\">null</span> || !options.getAvoidMoveToFront();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isOrhasTask = rTask == <span class=\"keyword\">this</span> || hasChild(rTask);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å¯åŠ¨çš„ activity ä¸èƒ½æ˜¯é˜»å¡çš„ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class=\"line\">    Task task = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!newTask &amp;&amp; isOrhasTask) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ActivityRecord occludingActivity = getOccludingActivityAbove(r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (occludingActivity != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            rTask.positionChildAtTop(r);</span><br><span class=\"line\">            ActivityOptions.abort(options);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å…è®¸ç§»åŠ¨åˆ°å‰å°ï¼Œå¹¶ä¸”ä¸æ˜¯æ¡Œé¢ç¨‹åºã€æ˜¯æœ€è¿‘ä»»åŠ¡åˆ—è¡¨ä»»åŠ¡æ ˆã€ä»»åŠ¡æ ˆå·²æœ‰activity</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((!isHomeOrRecentsRootTask() || hasActivity()) &amp;&amp; allowMoveToFront) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> doShow = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newTask) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                resetTaskIfNeeded(r, r);</span><br><span class=\"line\">                doShow = topRunningNonDelayedActivityLocked(<span class=\"keyword\">null</span>) == r;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options != <span class=\"keyword\">null</span> &amp;&amp; options.getAnimationType()</span><br><span class=\"line\">                == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">            doShow = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class=\"line\">            r.setVisibility(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            ensureActivitiesVisible(<span class=\"keyword\">null</span>, <span class=\"number\">0</span>, !PRESERVE_WINDOWS);</span><br><span class=\"line\">            mDisplayContent.executeAppTransition();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class=\"line\">            Task baseTask = r.getTask();</span><br><span class=\"line\">            <span class=\"comment\">//â€¼ï¸å¯åŠ¨</span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> ActivityRecord prev = baseTask.getActivity(</span><br><span class=\"line\">                    a -&gt; a.mStartingData != <span class=\"keyword\">null</span> &amp;&amp; a.showToCurrentUser());</span><br><span class=\"line\">            r.showStartingWindow(prev, newTask, isTaskSwitch,</span><br><span class=\"line\">                    <span class=\"keyword\">true</span> <span class=\"comment\">/* startActivity */</span>, sourceRecord);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//ç¬¬ä¸€ä¸ªå¯åŠ¨çš„ activity æ— éœ€èŠ±é‡Œèƒ¡å“¨çš„åŠ¨ç”»</span></span><br><span class=\"line\">        ActivityOptions.abort(options);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>showStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showStartingWindow</span><span class=\"params\">(ActivityRecord prev, <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> taskSwitch,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> startActivity, ActivityRecord sourceRecord)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//è¦†ç›–æ—¶ï¼Œä¸ä¼šæ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTaskOverlay) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å…±äº«å…ƒç´ è½¬æ¢æ—¶ï¼Œä¸é™åˆ¶ï¼ˆå…±äº«å…ƒç´ ï¼šAndroid åŠ¨ç”»éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mPendingOptions != <span class=\"keyword\">null</span></span><br><span class=\"line\">            &amp;&amp; mPendingOptions.getAnimationType() == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> CompatibilityInfo compatInfo =</span><br><span class=\"line\">            mAtmService.compatibilityInfoForPackageLocked(info.applicationInfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//æ˜¯å¦ä½¿ç”¨å¯åŠ¨é¡µæ ·å¼</span></span><br><span class=\"line\">    mSplashScreenStyleEmpty = shouldUseEmptySplashScreen(sourceRecord, startActivity);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€æˆ‘ä»¬è¿™å°±æ˜¯å¯åŠ¨ activityï¼Œæ‰€ä»¥ startActivit = trueï¼Œé‚£ä¹ˆå°†ä¼šè·å–å¯åŠ¨ä¸»é¢˜</span></span><br><span class=\"line\"><span class=\"comment\">        ï¼ˆä¹Ÿå°±æ˜¯ Android é«˜ç‰ˆæœ¬æ¯ä¸ªåº”ç”¨å¯åŠ¨éƒ½ä¼šæ˜¾ç¤ºçš„å¼€å±é¡µï¼Ÿï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€å¼€å±ä¸»é¢˜æ˜¯å¯ä»¥é‡å†™çš„ï¼Œé¦–å…ˆå°è¯•è·å–æ˜¯å¦é‡æ–°äº†å¼€å±ä¸»é¢˜ï¼Œå°†è·å–ä¸»é¢˜èµ„æºåç§°</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€å¦‚æœæ²¡æœ‰é‡å†™ï¼Œå°†ä¼šé€šè¿‡ ATMS æ ¹æ®åŒ…åå’Œç”¨æˆ·IDè·å–ä¸»é¢˜èµ„æºåç§°</span></span><br><span class=\"line\"><span class=\"comment\">        4ã€å¦‚æœè·å–åˆ°å¼€å±ä¸»é¢˜èµ„æºåç§°ï¼Œé‚£ä¹ˆå°†æ ¹æ®åŒ…åé€šè¿‡ createPackageContext åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">           æ¥ç€æ ¹æ®ä¸Šä¸‹æ–‡å’Œä¸»é¢˜åç§°è·å–èµ„æºIDï¼ˆ0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„å¼€å±ä¸»é¢˜ï¼‰</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> splashScreenTheme = startActivity ? getSplashscreenTheme() : <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œä¼šè¯„ä¼°åº”è¯¥ä½¿ç”¨ theme ä¸»é¢˜è¿˜æ˜¯ splashScreenTheme ä¸»é¢˜</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> resolvedTheme = evaluateStartingWindowTheme(prev, packageName, theme,</span><br><span class=\"line\">            splashScreenTheme);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> activityCreated =</span><br><span class=\"line\">            mState.ordinal() &gt;= STARTED.ordinal() &amp;&amp; mState.ordinal() &lt;= STOPPED.ordinal();</span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœä¸æ˜¯æ–°çš„ä»»åŠ¡æ ˆï¼Œactivity ä¹Ÿè¿˜æ²¡åˆ›å»ºï¼Œé‚£ä¹ˆæœ¬æ¬¡æ˜¯çƒ­å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> newSingleActivity = !newTask &amp;&amp; !activityCreated</span><br><span class=\"line\">            &amp;&amp; task.getActivity((r) -&gt; !r.finishing &amp;&amp; r != <span class=\"keyword\">this</span>) == <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//â€¼ï¸å¯åŠ¨</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> scheduled = addStartingWindow(packageName, resolvedTheme,</span><br><span class=\"line\">            compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,</span><br><span class=\"line\">            prev, newTask || newSingleActivity, taskSwitch, isProcessRunning(),</span><br><span class=\"line\">            allowTaskSnapshot(), activityCreated, mSplashScreenStyleEmpty);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>addStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">addStartingWindow</span><span class=\"params\">(String pkg, <span class=\"keyword\">int</span> resolvedTheme, CompatibilityInfo compatInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        CharSequence nonLocalizedLabel, <span class=\"keyword\">int</span> labelRes, <span class=\"keyword\">int</span> icon, <span class=\"keyword\">int</span> logo, <span class=\"keyword\">int</span> windowFlags,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ActivityRecord from, <span class=\"keyword\">boolean</span> newTask, <span class=\"keyword\">boolean</span> taskSwitch, <span class=\"keyword\">boolean</span> processRunning,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">boolean</span> allowTaskSnapshot, <span class=\"keyword\">boolean</span> activityCreated, <span class=\"keyword\">boolean</span> useEmpty)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//çª—å£è¢«å†»ç»“ï¼Œä¸èƒ½æ˜¾ç¤º</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!okToDisplay()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mStartingData != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å·²æœ‰çª—å£åœ¨æ˜¾ç¤ºï¼Œä¸èƒ½å†æ˜¾ç¤ºäº†</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> WindowState mainWin = findMainWindow();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mainWin != <span class=\"keyword\">null</span> &amp;&amp; mainWin.mWinAnimator.getShown()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> TaskSnapshot snapshot =</span><br><span class=\"line\">            mWmService.mTaskSnapshotController.getSnapshot(task.mTaskId, task.mUserId,</span><br><span class=\"line\">                    <span class=\"keyword\">false</span> <span class=\"comment\">/* restoreFromDisk */</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* isLowResolution */</span>);</span><br><span class=\"line\">                    </span><br><span class=\"line\">     <span class=\"comment\">//STARTING_WINDOW_TYPE_NONEã€STARTING_WINDOW_TYPE_SNAPSHOTã€STARTING_WINDOW_TYPE_SPLASH_SCREEN</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> type = getStartingWindowType(newTask, taskSwitch, processRunning,</span><br><span class=\"line\">            allowTaskSnapshot, activityCreated, snapshot);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//é€æ¸çš„ï¼Œè¿™é‡Œä¼¼ä¹æ›´å¤šçš„æ˜¯å’Œ window çª—å£ç›¸å…³ï¼ˆéº»äº†éº»äº†ï¼Œæˆ‘åªæƒ³çœ‹ activity ç›¸å…³ï¼Œç»†èŠ‚å¤ªéš¾äº†ï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (type == STARTING_WINDOW_TYPE_SNAPSHOT) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isActivityTypeHome()) &#123;</span><br><span class=\"line\">            mWmService.mTaskSnapshotController.removeSnapshotCache(task.mTaskId);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((mDisplayContent.mAppTransition.getTransitFlags()</span><br><span class=\"line\">                    &amp; WindowManager.TRANSIT_FLAG_KEYGUARD_GOING_AWAY_NO_ANIMATION) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//ã€åˆ†æ”¯ä¸€ã€‘</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> createSnapshot(snapshot, typeParameter);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    ProtoLog.v(WM_DEBUG_STARTING_WINDOW, <span class=\"string\">&quot;Creating SplashScreenStartingData&quot;</span>);</span><br><span class=\"line\">    mStartingData = <span class=\"keyword\">new</span> SplashScreenStartingData(mWmService, pkg,</span><br><span class=\"line\">            resolvedTheme, compatInfo, nonLocalizedLabel, labelRes, icon, logo, windowFlags,</span><br><span class=\"line\">            getMergedOverrideConfiguration(), typeParameter);</span><br><span class=\"line\">            </span><br><span class=\"line\">    <span class=\"comment\">//ã€åˆ†æ”¯äºŒã€‘</span></span><br><span class=\"line\">    scheduleAddStartingWindow();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¸Šè¿°æ— è®ºæ˜¯<strong>åˆ†æ”¯ä¸€ã€åˆ†æ”¯äºŒ</strong>ï¼Œéƒ½ä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•<code>scheduleAddStartingWindow</code>ã€‚</p>\n<h1>scheduleAddStartingWindow</h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleAddStartingWindow</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (StartingSurfaceController.DEBUG_ENABLE_SHELL_DRAWER) &#123;</span><br><span class=\"line\">        mAddStartingWindow.run();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//æŠŠæ¶ˆæ¯æ·»åŠ åˆ°é˜Ÿåˆ—æœ€å‰é¢ä¼˜å…ˆå¤„ç†ï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mWmService.mAnimationHandler.hasCallbacks(mAddStartingWindow)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//mWmServiceï¼šWindowManagerService</span></span><br><span class=\"line\">            <span class=\"comment\">//mAnimationHandlerï¼šfinal Handler mAnimationHandler = new Handler(AnimationThread.getHandler().getLooper());</span></span><br><span class=\"line\">            mWmService.mAnimationHandler.postAtFrontOfQueue(mAddStartingWindow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œçš„äº‹æƒ…å’Œ window çª—å£å…³ç³»å¯†åˆ‡ï¼Œsurface çœ‹ç€ç»˜åˆ¶ç›¸å…³ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AddStartingWindow mAddStartingWindow = <span class=\"keyword\">new</span> AddStartingWindow();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddStartingWindow</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//ç•¥ç•¥ç•¥ï¼Œçœ‹ä¸å‡ºå®ƒå¹²äº†å•¥</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>çª—å£ç›¸å…³çš„åˆ°æ­¤ä¸ºæ­¢å§ï¼Œå†è¿›å…¥çœ‹ä¸æ‡‚äº†ã€‚æˆ‘æ›´å…³æ³¨çš„æ˜¯ activity å£°æ˜å‘¨æœŸå›è°ƒï¼Œå¯è¿Ÿè¿Ÿæ²¡æœ‰çœ‹è§ğŸ’”</p>\n<hr>\n<p>é‚£ä¹ˆè¿™æˆ‘ä»¬å§‘ä¸”ä»–æˆåŠŸåœ°æŠŠ activity æ·»åŠ åˆ° window ä¸Šï¼Œç°åœ¨æ˜¯æ—¶å€™å›å¤´çœ‹çœ‹<strong>å¯åŠ¨æˆåŠŸååšäº†äº›ä»€ä¹ˆï¼Ÿ</strong> æ‰€ä»¥æˆ‘ä»¬å›åˆ° <code>ActivityStarter.java</code>ï¼Œè‡ªç„¶è¿˜æ˜¯å›åˆ°è¿™é‡Œ <s>ï¼ˆä»å“ªæ¥ï¼Œå›å“ªå»å§ï¼‰</s></p>\n<h1>The callback [onNewIntent]</h1>\n<p>è¿™é‡Œè®² <code>Activity onNewIntent(Intent intent)</code> ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå…¶å®åƒ onCreatã€onResume ç­‰ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œå…¶ä»–çš„ä¸é‡å¤ã€‚</p>\n<h2 id=\"deliverToCurrentTopIfNeeded\">deliverToCurrentTopIfNeeded</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityStarter.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">startActivityInner</span><span class=\"params\">(<span class=\"keyword\">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">int</span> startFlags, <span class=\"keyword\">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        TaskFragment inTaskFragment, <span class=\"keyword\">boolean</span> restrictedBgActivity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å¦‚æœæ­£åœ¨å¯åŠ¨çš„ activity å’Œä»»åŠ¡æ ˆé¡¶éƒ¨çš„ activity ç›¸åŒ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Task topRootTask = mPreferredTaskDisplayArea.getFocusedRootTask();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topRootTask != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//é¡¶éƒ¨æ˜¯åŒä¸€ä¸ª activityï¼Œæ— éœ€é‡å¤åˆ›å»ºï¼Œå¯åŠ¨ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„åº”è¯¥å›è°ƒ onNewIntent</span></span><br><span class=\"line\">        startResult = deliverToCurrentTopIfNeeded(topRootTask, intentGrants);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startResult != START_SUCCESS) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;       </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"deliverToCurrentTopIfNeeded-2\">deliverToCurrentTopIfNeeded</h2>\n<figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> deliver<span class=\"constructor\">ToCurrentTopIfNeeded(Task <span class=\"params\">topRootTask</span>, NeededUriGrants <span class=\"params\">intentGrants</span>)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//è·å–å½“å‰æ ˆé¡¶ activity</span></span><br><span class=\"line\">    final ActivityRecord top = topRootTask.top<span class=\"constructor\">RunningNonDelayedActivityLocked(<span class=\"params\">mNotTop</span>)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//activity ç›¸åŒã€å¯åŠ¨ç”¨æˆ·ç›¸åŒã€æ ˆé¡¶å¤ç”¨ã€å¯åŠ¨ç›®æ ‡</span></span><br><span class=\"line\">    final boolean dontStart = top != null</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.mActivityComponent.equals(mStartActivity.mActivityComponent)</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.mUserId<span class=\"operator\"> == </span>mStartActivity.mUserId</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>top.attached<span class=\"constructor\">ToProcess()</span></span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"operator\">            || </span>LAUNCH_SINGLE_TOP<span class=\"operator\"> == </span>mLaunchMode)</span><br><span class=\"line\"><span class=\"operator\">            &amp;&amp; </span>(!top.is<span class=\"constructor\">ActivityTypeHome()</span><span class=\"operator\"> || </span>top.get<span class=\"constructor\">DisplayArea()</span><span class=\"operator\"> == </span>mPreferredTaskDisplayArea);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!dontStart) &#123;</span><br><span class=\"line\">        return START_SUCCESS;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    top.get<span class=\"constructor\">TaskFragment()</span>.clear<span class=\"constructor\">LastPausedActivity()</span>;</span><br><span class=\"line\">    <span class=\"comment\">//activity æ˜¾ç¤ºï¼Œåé¢çœ‹</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mDoResume) &#123;</span><br><span class=\"line\">        mRootWindowContainer.resume<span class=\"constructor\">FocusedTasksTopActivities()</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™é‡Œä¼šè¿›å…¥ ActivitRecord</span></span><br><span class=\"line\">    deliver<span class=\"constructor\">NewIntent(<span class=\"params\">top</span>, <span class=\"params\">intentGrants</span>)</span>;</span><br><span class=\"line\">    return START_DELIVERED_TO_TOP;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"deliverNewIntentLocked\">deliverNewIntentLocked</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityRecord.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">deliverNewIntentLocked</span><span class=\"params\">(<span class=\"keyword\">int</span> callingUid, Intent intent, NeededUriGrants intentGrants,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">if</span> ((mState == RESUMED || mState == PAUSED || isTopActivityWhileSleeping)</span></span></span><br><span class=\"line\"><span class=\"function\">            &amp;&amp; <span class=\"title\">attachedToProcess</span><span class=\"params\">()</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ArrayList&lt;ReferrerIntent&gt; ar = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(<span class=\"number\">1</span>);</span><br><span class=\"line\">            ar.add(rintent);</span><br><span class=\"line\">            <span class=\"comment\">//å¼€å§‹è°ƒç”¨å£°æ˜å‘¨æœŸç›¸å…³ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡ ClientTransaction</span></span><br><span class=\"line\">            <span class=\"comment\">//getLifecycleManager -&gt; ClientLifecycleManager å£°æ˜å‘¨æœŸç›¸å…³å›è°ƒéƒ½ä¼šé€šè¿‡å®ƒ</span></span><br><span class=\"line\">            mAtmService.getLifecycleManager().scheduleTransaction(app.getThread(), appToken,</span><br><span class=\"line\">                    NewIntentItem.obtain(ar, mState == RESUMED));</span><br><span class=\"line\">            unsent = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RemoteException e) &#123;</span><br><span class=\"line\">            Slog.w(TAG, <span class=\"string\">&quot;Exception thrown sending new intent to &quot;</span> + <span class=\"keyword\">this</span>, e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NullPointerException e) &#123;</span><br><span class=\"line\">            Slog.w(TAG, <span class=\"string\">&quot;Exception thrown sending new intent to &quot;</span> + <span class=\"keyword\">this</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (unsent) &#123;</span><br><span class=\"line\">        addNewIntentLocked(rintent);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ClientLfecycleManager.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> <span class=\"keyword\">throws</span> RemoteException </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºä¸€ä¸ªäº‹ç‰©ä¹‹åå¼€å§‹æ‰§è¡Œï¼Œå…³é”®æ˜¯è¿™ä¸ªæ˜¯äº‹åŠ¡ï¼ˆbinder)äº‹åŠ¡ä¼ é€’æ•°æ®çš„ï¼Œæˆ–åˆ™äº‹åŠ¡å‘é€åå°†åœ¨å“ªé‡Œå¤„ç†äº‹åŠ¡ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> IApplicationThread client = transaction.getClient();</span><br><span class=\"line\">    transaction.schedule();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(client <span class=\"keyword\">instanceof</span> Binder)) &#123;</span><br><span class=\"line\">        transaction.recycle();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ClientTransaction-schedule\">ClientTransaction.schedule</h2>\n<p><code>ClientTransaction</code>: A container that holds a sequence of messages, which may be sent to a client. This includes a list of callbacks and a final lifecycle state.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ClientTransaction.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    1ã€IApplicationThread è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ aidl æ¥å£ï¼Œæ¥å£å®ç°è‡ªç„¶æ˜¯ IApplicationThread.Sub</span></span><br><span class=\"line\"><span class=\"comment\">    2ã€å®ç°ç±»åœ¨ ActivityThreadï¼Œprivate class ApplicationThread extends IApplicationThread.Stub </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> IApplicationThread mClient;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Schedule the transaction after it was initialized. It will be send to client and all its</span></span><br><span class=\"line\"><span class=\"comment\"> * individual parts will be applied in the following sequence:</span></span><br><span class=\"line\"><span class=\"comment\"> * 1. The client calls &#123;<span class=\"doctag\">@link</span> #preExecute(ClientTransactionHandler)&#125;, which triggers all work</span></span><br><span class=\"line\"><span class=\"comment\"> *    that needs to be done before actually scheduling the transaction for callbacks and</span></span><br><span class=\"line\"><span class=\"comment\"> *    lifecycle state request.</span></span><br><span class=\"line\"><span class=\"comment\"> * 2. The transaction message is scheduled.</span></span><br><span class=\"line\"><span class=\"comment\"> * 3. The client calls &#123;<span class=\"doctag\">@link</span> TransactionExecutor#execute(ClientTransaction)&#125;, which executes</span></span><br><span class=\"line\"><span class=\"comment\"> *    all callbacks and necessary lifecycle transitions.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">schedule</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> RemoteException </span></span><br><span class=\"line\"><span class=\"function\">    mClient.<span class=\"title\">scheduleTransaction</span><span class=\"params\">(<span class=\"keyword\">this</span>)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ApplicationThread-scheduleTransaction\">ApplicationThread.scheduleTransaction</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ApplicationThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">IApplicationThread</span>.<span class=\"title\">Stub</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> <span class=\"keyword\">throws</span> RemoteException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//åœ¨å½“å‰ç±»æ–‡ä»¶æœç´¢æ²¡çœ‹åˆ°æ–¹æ³•å®šä¹‰ï¼Œå·®ç‚¹æ€€ç–‘äººç”Ÿï¼›ç„¶åçœ‹çœ‹ ActivitThread è¿˜æœ‰çˆ¶ç±»ï¼Œé‚£æ–¹æ³•å®šä¹‰å°±åœ¨çˆ¶ç±»äº†</span></span><br><span class=\"line\">        ActivityThread.<span class=\"keyword\">this</span>.scheduleTransaction(transaction);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ActivityThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">ClientTransactionHandler</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"keyword\">implements</span> <span class=\"title\">ActivityThreadInternal</span> </span>&#123;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClientTransactionHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTransaction</span><span class=\"params\">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        transaction.preExecute(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">//å‘é€æ¶ˆæ¯ï¼Œé‚£è€…å°±æ˜ç¡®å¾ˆå¤šäº†</span></span><br><span class=\"line\">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">H</span> <span class=\"keyword\">extends</span> <span class=\"title\">Handler</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> EXECUTE_TRANSACTION = <span class=\"number\">159</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleMessage</span><span class=\"params\">(Message msg)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (msg.what) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> EXECUTE_TRANSACTION:</span><br><span class=\"line\">                <span class=\"comment\">//å›å¤´çœ‹çœ‹ schedule çš„æ³¨é‡Šï¼Œä¸‹ä¸€æ­¥åº”è¯¥ä¼šåˆ°å“ªé‡Œå»æ‰§è¡Œï¼Œå…¶å®åˆ«äººæ˜¯å†™å¾—å¾ˆæ¸…æ¥šçš„ï¼ˆç†Ÿèƒ½ç”Ÿå·§ï¼Œåˆçœ‹ç¡®å®ä¸€å¤´é›¾æ°´ï¼‰</span></span><br><span class=\"line\">                <span class=\"keyword\">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class=\"line\">                mTransactionExecutor.execute(transaction);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (isSystem()) &#123;</span><br><span class=\"line\">                    transaction.recycle();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"TransactionExecutor-excute\">TransactionExecutor.excute</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//TransactionExecutor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class=\"string\">&quot;Start resolving transaction&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//ä¼¼ä¹æ¯ä¸€ä¸ª activity éƒ½æœ‰ä¸€ä¸ª tokenï¼Œè¿˜ä¸æ¸…æ¥šä»ä½•è€Œæ¥</span></span><br><span class=\"line\">    <span class=\"comment\">//åˆå­¦ Android æ—¶ï¼Œå…³äº activity token çš„æŠ¥é”™ä¼°è®¡ä½ ä¹Ÿé‡åˆ°è¿‡</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> IBinder token = transaction.getActivityToken();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (token != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Map&lt;IBinder, ClientTransactionItem&gt; activitiesToBeDestroyed =</span><br><span class=\"line\">                mTransactionHandler.getActivitiesToBeDestroyed();</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ClientTransactionItem destroyItem = activitiesToBeDestroyed.get(token);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (destroyItem != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (transaction.getLifecycleStateRequest() == destroyItem) &#123;</span><br><span class=\"line\">                activitiesToBeDestroyed.remove(token);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mTransactionHandler.getActivityClient(token) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//è¿™ä¸ªæš‚ä¸å…³æ³¨ï¼Œé‡ç‚¹çœ‹çœ‹ä¸‹é¢çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒå§</span></span><br><span class=\"line\">    executeCallbacks(transaction);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        1ã€cycleToPath(r, lifecycleItem.getTargetState(), true , transaction);  -&gt; performLifecycleSequence</span></span><br><span class=\"line\"><span class=\"comment\">        </span></span><br><span class=\"line\"><span class=\"comment\">        //çœ‹äº†ä¸€åœˆï¼Œç€ä¸¤ä¸ªå®ç°åº”è¯¥æ˜¯åœ¨å­ç±»</span></span><br><span class=\"line\"><span class=\"comment\">        2ã€lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span></span><br><span class=\"line\"><span class=\"comment\">        3ã€lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    executeLifecycleState(transaction);</span><br><span class=\"line\">    mPendingActions.clear();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class=\"string\">&quot;End resolving transaction&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//TransactionExecutor.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">performLifecycleSequence</span><span class=\"params\">(ActivityClientRecord r, IntArray path,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ClientTransaction transaction)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size = path.size();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>, state; i &lt; size; i++) &#123;</span><br><span class=\"line\">        state = path.get(i);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//æ˜¯å§ï¼Œå‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒéƒ½æœ‰ï¼›é‚£å°±å¥‡æ€ªäº†æ€ä¹ˆæ²¡æœ‰ onNewIntentï¼Œä»–ä¸ç®—æ˜¯ç”Ÿå‘½å‘¨æœŸå‡½æ•°å—ï¼Ÿ</span></span><br><span class=\"line\">        <span class=\"comment\">//å’šå’šå’šå’šï¼ˆæ•²é»‘æ¿ï½ï¼‰</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">            1ã€onNewIntent ä¸æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•ï¼Œåªæ˜¯å£°æ˜å‘¨æœŸå›è°ƒè¿‡ç¨‹ä¸­å¯èƒ½è¢«æ‰§è¡Œçš„ä¸€ä¸ªæ–¹æ³•</span></span><br><span class=\"line\"><span class=\"comment\">            2ã€å¦‚æœæ»¡è¶³æŸäº›æ¡ä»¶ï¼Œæ ¹æ®ç»éªŒæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•åœ¨ onResume ä¹‹å‰ä¼šæ‰§è¡Œ</span></span><br><span class=\"line\"><span class=\"comment\">            3ã€é‚£ä¹ˆæˆ‘ä»¬çŒœæµ‹ï¼ˆæˆ‘çœ‹äº†ä»£ç å†æ¥çŒœæµ‹çš„ğŸ˜ï¼‰ï¼Œè¯¥æ–¹æ³•çš„å›è°ƒæœ‰æ²¡æœ‰å¯èƒ½åœ¨ handleResumeActivity é‡Œé¢æ‰§è¡Œï¼Ÿé‚£å°±å»çœ‹çœ‹å§ï¼</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_CREATE:</span><br><span class=\"line\">                mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class=\"line\">                        <span class=\"keyword\">null</span> <span class=\"comment\">/* customIntent */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_START:</span><br><span class=\"line\">                mTransactionHandler.handleStartActivity(r, mPendingActions,</span><br><span class=\"line\">                        <span class=\"keyword\">null</span> <span class=\"comment\">/* activityOptions */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_RESUME:</span><br><span class=\"line\">                mTransactionHandler.handleResumeActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finalStateRequest */</span>,</span><br><span class=\"line\">                        r.isForward, <span class=\"string\">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_PAUSE:</span><br><span class=\"line\">                mTransactionHandler.handlePauseActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finished */</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">false</span> <span class=\"comment\">/* userLeaving */</span>, <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>, mPendingActions,</span><br><span class=\"line\">                        <span class=\"string\">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_STOP:</span><br><span class=\"line\">                mTransactionHandler.handleStopActivity(r, <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>,</span><br><span class=\"line\">                        mPendingActions, <span class=\"keyword\">false</span> <span class=\"comment\">/* finalStateRequest */</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_DESTROY:</span><br><span class=\"line\">                mTransactionHandler.handleDestroyActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* finishing */</span>,</span><br><span class=\"line\">                        <span class=\"number\">0</span> <span class=\"comment\">/* configChanges */</span>, <span class=\"keyword\">false</span> <span class=\"comment\">/* getNonConfigInstance */</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class=\"number\">1</span>));</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> ON_RESTART:</span><br><span class=\"line\">                mTransactionHandler.performRestartActivity(r, <span class=\"keyword\">false</span> <span class=\"comment\">/* start */</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Unexpected lifecycle state: &quot;</span> + state);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ClientTransactionHandler æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥å£°æ˜å‘¨æœŸå›è°ƒè¿˜å¾—æ‰¾ ClientTransactionHandler çš„å®ç°ç±» <code>ActivitThread</code>ã€‚</p>\n<p>ç»•ä¸€åœˆåˆå›æ¥ï¼Œè¿™è¿™è¿™ï½ï½ï½</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69c055d008d74b45bd1205352739f8b9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h2 id=\"ActivitThread-performResumeActivity\">ActivitThread.performResumeActivity</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">performResumeActivity</span><span class=\"params\">(ActivityClientRecord r, <span class=\"keyword\">boolean</span> finalStateRequest,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String reason)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.activity.mFinished) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//å·²ç» resumed å°±ä¸é‡å¤äº†</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (r.getLifecycleState() == ON_RESUME) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!finalStateRequest) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> RuntimeException e = <span class=\"keyword\">new</span> IllegalStateException(</span><br><span class=\"line\">                    <span class=\"string\">&quot;Trying to resume activity which is already resumed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (finalStateRequest) &#123;</span><br><span class=\"line\">        r.hideForNow = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        r.activity.mStartedActivity = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        r.activity.onStateNotSaved();</span><br><span class=\"line\">        r.activity.mFragments.noteStateNotSaved();</span><br><span class=\"line\">        checkAndBlockForNetworkAccess();</span><br><span class=\"line\">        <span class=\"comment\">//çœ‹åˆ°æ²¡ï¼Œæ»¡è¶³æŸäº›æ¡ä»¶æƒ…å†µä¸‹æ˜¯ä¼šèµ° onNewIntent </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.pendingIntents != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            deliverNewIntents(r, r.pendingIntents);</span><br><span class=\"line\">            r.pendingIntents = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r.pendingResults != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            deliverResults(r, r.pendingResults, reason);</span><br><span class=\"line\">            r.pendingResults = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//onResume å›è°ƒåœ¨è¿™é‡Œï¼Œæœ¬æ¬¡æˆ‘ä»¬æš‚ä¸å…³æ³¨</span></span><br><span class=\"line\">        r.activity.performResume(r.startsNotResumed, reason);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//æŠŠçŠ¶æ€è®¾ç½®ä¸€ä¸‹</span></span><br><span class=\"line\">        r.state = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        r.persistentState = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        r.setState(ON_RESUME);</span><br><span class=\"line\"></span><br><span class=\"line\">        reportTopResumedActivityChanged(r, r.isTopResumedActivity, <span class=\"string\">&quot;topWhenResuming&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Unable to resume activity &quot;</span></span><br><span class=\"line\">                    + r.intent.getComponent().toShortString() + <span class=\"string\">&quot;: &quot;</span> + e.toString(), e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ActivityThread.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">deliverNewIntents</span><span class=\"params\">(ActivityClientRecord r, List&lt;ReferrerIntent&gt; intents)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> N = intents.size();</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; i&lt;N; i++) &#123;</span><br><span class=\"line\">        ReferrerIntent intent = intents.get(i);</span><br><span class=\"line\">        intent.setExtrasClassLoader(r.activity.getClassLoader());</span><br><span class=\"line\">        intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),</span><br><span class=\"line\">                r.activity.getAttributionSource());</span><br><span class=\"line\">        r.activity.mFragments.noteStateNotSaved();</span><br><span class=\"line\">        <span class=\"comment\">//æœ€åè¿˜æ˜¯äº¤ç»™ â€˜å¤§ç®¡å®¶â€™ æ‰§è¡Œå•Šï¼Œå›åˆ°äº†é‚£ä¸ªç†Ÿæ‚‰çš„å¯¹è±¡</span></span><br><span class=\"line\">        mInstrumentation.callActivityOnNewIntent(r.activity, intent);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Instrumentation-callActivityOnNewIntent\">Instrumentation.callActivityOnNewIntent</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Instrumentation.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">callActivityOnNewIntent</span><span class=\"params\">(Activity activity, ReferrerIntent intent)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> String oldReferrer = activity.mReferrer;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (intent != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            activity.mReferrer = intent.mReferrer;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        callActivityOnNewIntent(activity, intent != <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> Intent(intent) : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        activity.mReferrer = oldReferrer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Instrumentation.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">callActivityOnNewIntent</span><span class=\"params\">(Activity activity, Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//ä»€ä¹ˆï¼ŸInstrumentation ä¸ç†Ÿæ‚‰ï¼Ÿ</span></span><br><span class=\"line\">    <span class=\"comment\">//é‚£ activity æ€»è¯¥ç†Ÿæ‚‰äº†å§</span></span><br><span class=\"line\">    activity.performNewIntent(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Activity.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">performNewIntent</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> Intent intent)</span> </span>&#123;</span><br><span class=\"line\">    mCanEnterPictureInPicture = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    onNewIntent(intent);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Activity.java</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onNewIntent</span><span class=\"params\">(Intent intent)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å°±åˆ°è¿™é‡Œç»“æŸå§ï¼Œçœ‹èµ·æ¥æ²¡é‚£ä¹ˆåƒæ ·ã€‚è™½ç„¶æ˜¯ <code>æ¡Œé¢å¯åŠ¨</code>ï¼Œåæ¥è¶Šæ„Ÿè§‰åƒæ˜¯ <code>Activity å¯åŠ¨</code>ã€‚<s>éƒ½ä¹±å¥—äº†</s> ï¼Œå¯æ˜¯ï¼Œæ¡Œé¢ä¸ä¹Ÿæ˜¯ä¸€ä¸ª activity å—ğŸ¤”ï¸</p>\n"},{"title":"å†æ¢ jclasslib ä¿®æ”¹å­—èŠ‚ç ","catalog":true,"date":"2022-09-25T15:11:20.000Z","subtitle":"å¤å¤©çš„æµ·è¾¹ï¼Œå†ç¾ä¸è¿‡è½æ—¥ä½™æ™–","header-img":"/img/220923_classmodify/ymclass_bg.png","sticky":3,"_content":"\n\n# ä» jclasslib è®¤è¯† Hello world\n\né‚£å¹´ï¼Œå†ç†Ÿæ‚‰ä¸è¿‡çš„ Hello worldã€‚\n\nå¯èƒ½å¾ˆå¤šäººçš„ç¬¬ä¸€ä¸ª java ç¨‹åºéƒ½ä»â€˜ä½ å¥½ä¸–ç•Œâ€™å¼€å§‹ï¼Œä»æ­¤è¸ä¸Šäº†ä¸€æ¡***ä¸å½’è·¯***ï¼Œå¤šå¹´ä»¥åï¼ˆå¤§æ¦‚æ¯•ä¸šåŠå¹´ï¼‰ï¼Œæˆ‘ä»¥å¦ä¸€ç§æ–¹å¼é‡æ–°è®¤è¯†å®ƒï¼Œè¿™ç§æ–¹å¼å«**å­—èŠ‚ç **ã€‚\n\n> Test.java\n\n```java\npackage primer;\n\n//æ¯”å¦‚ Test ç±»çš„ç»„æˆï¼š\n//ä¸»ç‰ˆæœ¬å· + å¸¸é‡æ±  + è®¿é—®æ ‡è¯† + å½“å‰ç±»ç­¾å + çˆ¶ç±»ç­¾å + æ¥å£é›†åˆ + æ–¹æ³•é›†åˆ + å­—æ®µé›†åˆ + å±æ€§é›†åˆï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰\npublic class Test{\n    //æ–¹æ³•ä¸€ï¼š<init>()V   ã€é»˜è®¤æ„é€ å™¨ã€‘\n    \n    //æ–¹æ³•äºŒï¼šmain([Ljava/lang/String;)V   ã€main æ–¹æ³•ã€V è¡¨ç¤º voidã€L è¡¨ç¤ºæ•°ç»„ã€String å˜æˆç±»çš„å…¨è·¯å¾„ã€‘ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼›String ä½œä¸ºå¯¹è±¡ç»“å°¾å¿…é¡»æ˜¯é€—å·ï¼‰\n    \n    //æ¯”å¦‚ main æ–¹æ³•ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰\n    // ç»„æˆï¼š \n    //    - æ–¹æ³•å + æ–¹æ³•ç­¾å + è®¿é—®æ ‡è¯†ï¼ˆmain + ([Ljava/lang/String;)V + public staticï¼‰\n    //    - å¼‚å¸¸è¡¨\n    //    - å­—èŠ‚ç ã€æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‘\n    \n    public static void main(String[] args) {\n        System.out.println(\"Hello World\");\n    }\n}\n```\n\n> `javac Test.java` ç¼–è¯‘å¾—åˆ° Test.class å­—èŠ‚ç æ–‡ä»¶\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/6fd777b8a85ec867a59fdb307082595b.png)\n\nä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `java <ç±»å…¨è·¯å¾„>` ç›´æ¥è¿è¡ŒæŸ¥çœ‹æ•ˆæœï¼Œç±»å…¨è·¯å¾„ï¼šåŒ…å + ç±»å\n\n\n**ä¸¾ä¸ªä¾‹å­ï¼š**\n\nTest å¯åŠ¨ç±»çš„åŒ…åæ˜¯ `package primer`ï¼Œæˆ‘æœ¬åœ°ç›®å½•æ˜¯`primer/primer/Test.class`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec87c8988833fd4f5d34a8f9edb76d8c.png)\n\n1ã€åœ¨ class æ‰€åœ¨ç›®å½•ä¸‹è¿è¡Œ âŒ\n\nå¦‚æœä½ åœ¨ Test.class åŒçº§ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤è¿è¡Œï¼Œå¯æƒœæŠ¥é”™äº†ï¼Œå¤§æ¦‚æ„æ€æ˜¯ä½ çš„ Test ç±»å…¨è·¯å¾„ä¸å¯¹ï¼Œå½“å­˜åœ¨ä¸»ç±»å­˜åœ¨åŒ…åæ—¶ï¼Œä¸èƒ½åœ¨å½“å‰ class æ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦åœ¨åŒ…åæ‰€åœ¨ç›®å½•æ‰§è¡Œï¼Œå¦åˆ™æŠ¥é”™ï¼Œjava å‘½ä»¤è®¤ä¸ºåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾***åŒ…åè·¯å¾„***ï¼Œå¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ ¹æ®åŒ…åå¾€ä¸‹æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»ç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/421255941965168858b22ae04aebe4d6.png)\n\nå‰é¢æåˆ°ï¼Œç›´æ¥æ‰§è¡Œå­—èŠ‚ç æ˜¯è¿™æ · **`java <ç±»å…¨è·¯å¾„>`**ï¼Œå…¨è·¯å¾„æ˜¯è¦åŒ…å«åŒ…ååœ¨å†…ï¼Œæ¯”å¦‚ `com.tencent.mmkv.MMKV`ï¼Œå¦‚æœ MMKV ç±»æœ‰æ‰§è¡Œå…¥å£ï¼Œæƒ³è¦é€šè¿‡ java å‘½ä»¤æ‰§è¡Œå®ƒå¿…é¡»ç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚**JVM åœ¨åŠ è½½ç±»è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•ç¡®å®šå”¯ä¸€ä¸ªç±»çš„ï¼Ÿ**æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªç±»åç›¸åŒä½†åŒ…åï¼ˆå…¨è·¯å¾„ï¼‰ä¸åŒçš„ Test ç±»ï¼ŒJVM é€šè¿‡`åŒ…åé™å®šç¬¦ + æ˜¯å¦åŒä¸€ä¸ªè™šæ‹Ÿæœº`å”¯ä¸€ç¡®å®šä¸€ä¸ªç±»ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œçš„ç¨‹åºåªæœ‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼‰\n\n2ã€åœ¨ class å¯åŠ¨ç±»æœ€å¤–å±‚åŒ…åçš„ä¸Šä¸€å±‚ç›®å½•è¿è¡Œ â˜‘ï¸\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec6fbd643ecb13cd555200dc4ab5fbd2.png)\n\n## é‚‚é€…çš„ jclasslib\n\nè¿™é‡Œå¼€å§‹æ¶‰åŠåˆ°å…·ä½“çš„ JVM æŒ‡ä»¤ï¼Œå…ˆå¥‰ä¸Šå®˜æ–¹æ–‡æ¡£ [ORACLE - JVM æŒ‡ä»¤é›† ](https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.getstatic)ï¼Œå…¨éƒ¨æŒ‡ä»¤è®°ä½ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²ï¼Œé€šå¸¸æ˜¯ç”¨æ—¶æŸ¥é˜…ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼›å¯¹äº jclasslib å·¥å…·å¯ä»¥å³å‡»è·³è½¬åˆ°å®˜æ–¹æ–‡æ¡£ç‰¹å®šæŒ‡ä»¤ä½ç½®`show JVM spec`ã€‚ä»¥ä¸Šé¢çš„`Hello World`ä¸ºä¾‹å­è¿›è¡Œæ“ä½œã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/160147efe7c8029f9f254df0e0d853e1.png)\n\n**1ã€ä¿®æ”¹å­—ç¬¦ä¸²å¸¸é‡**\n\nå…ˆçœ‹ main æ–¹æ³•çš„ java ä»£ç ï¼Œè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ˜¯ `Hello World`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/cceaaf6bd80b26ff3667900fc47cb4cc.png)\n\nå†çœ‹ main æ–¹æ³•çš„ class å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ javap å‘½ä»¤æŸ¥çœ‹å­—èŠ‚ç \n\n![image.png](https://img-blog.csdnimg.cn/img_convert/34699591dd1e5ae793d6b15d803951c0.png)\n\n```java\ngetstaticï¼š     è·å–é™æ€å­—æ®µ outï¼ˆSystem ç±»ä¸­çš„ out å£°æ˜æ˜¯ `public final static PrintStream out = null;`ï¼‰\nldcï¼š           ä»å¸¸é‡æ± ä¸­è·å–å€¼å¹¶å‹å…¥æ“ä½œæ•°æ ˆï¼ˆæ­¤å¤„å¸¸é‡æ˜¯ `Hello World`ï¼‰\ninvokevirtualï¼š ç±»çº§åˆ«çš„æ–¹æ³•è°ƒç”¨ï¼ˆå¯ä»¥æ˜¯é€šè¿‡ç±»åè°ƒç”¨æ–¹æ³• `System.out.println()`ï¼‰\nnewï¼š           åˆ›å»º Hello ç±»çš„å®ä¾‹\ndupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°\ninvokespecialï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•\nastore_1ï¼š      æŠŠåˆ›å»ºçš„ Hello å¯¹è±¡å­˜å‚¨åˆ° hello æœ¬åœ°å˜é‡\naload_1ï¼š       åŠ è½½ hello æœ¬åœ°å˜é‡çš„å¯¹è±¡\ninvokevirtualï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•\nreturnï¼š        æ–¹æ³•é€€å‡º\n```\n\nåœ¨å·¥å…·ä¸Šå¯¹å­—èŠ‚ç ç›´æ¥è¿›è¡Œä¿®æ”¹`ldc`è¯»å–çš„å¸¸é‡å€¼ï¼Œä¿å­˜å¹¶é‡æ–°ç¼–è¯‘è¿è¡Œï¼ˆæˆ‘åœ¨æƒ³ä¸€ä¸ªç–‘æƒ‘ï¼šæˆ‘ä¿®æ”¹çš„å­—ç¬¦ä¸²ä¹‹å‰åœ¨å¸¸é‡æ± ä¸­æ²¡æœ‰ï¼Œæ˜¯å¦åœ¨æˆ‘ä¿®æ”¹å¹¶ä¿å­˜åä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²çº³å…¥å¸¸é‡æ± ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/76d48e2e9a414d6ec3651e6550891099.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/61b1f79282b2c1a44d998b702f129ae1.png)\n\n\n# è·³è·³è™ï¼šç°åœ¨ä¸€èµ·æƒ³æƒ³æƒ³\n\nåœ¨æˆ‘ä»¬çš„è®°å¿†ä¸­ï¼Œå­—é¢é‡ç›¸åŒçš„å­—ç¬¦ä¸²å¸¸é‡åœ¨å¸¸é‡æ± ä¸­æ˜¯ä»…å­˜ä¸€ä»½ã€‚å¦‚ä¸‹ä»£ç `\"å¼ ä¸‰\"`å­—ç¬¦ä¸²åœ¨å¸¸é‡æ± ä¸­æœ‰ä¸”åªæœ‰ä¸€ä»½ï¼Œä½†æ˜¯ç¨‹åºä¸­å¤šå¤„å¼•ç”¨ï¼Œç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸­çš„å€¼é‚£ä¹ˆè¿™ä¸¤ä¸ªè¾“å‡ºçš„éƒ½ä¼šæ”¹å˜äº†ï¼Œæˆ‘å¸Œæœ›åªæ”¹å˜`name`çš„è¾“å‡ºï¼Œä¿æŒåŸå…ˆ`aliasName`çš„å€¼ã€‚\n\nç›´æ¥ä¿®æ”¹å¸¸é‡æ± ï¼Œç¡®å®ä¸¤ä¸ªéƒ½å—å½±å“ï¼Œä¸ç¬¦åˆæœŸæœ›\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a49ef4afa4cd0c272c09965ce5d0d947.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/1ca7b5055306fd77c67fd1674eac168d.png)\n\nç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ï¼Œé‚£å¦‚ä½•æ“ä½œæ»¡è¶³éœ€æ±‚å‘¢ï¼Ÿå¦‚æœä½ æœ‰æ›´å¥½çš„ç‰ˆæœ¬æ¬¢è¿è¯„è®ºã€‚\n\n\næˆ‘åªå¥½å¦¥å`åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¼•ç”¨`ï¼Œé€šè¿‡ jd-gui æŠŠ classæ–‡ä»¶è½¬æ¢æˆ java æ–‡ä»¶ï¼Œä¿®æ”¹å®Œæ¯•ä¹‹åå† javac ç¼–è¯‘æˆ class æ–‡ä»¶ç„¶åè¿è¡Œï¼›å¦‚æœä½ æœ‰å…¶ä»–æ–¹æ³•ï¼Œæ¬¢è¿è¯„è®ºã€‚\n\n1ã€ä½¿ç”¨ JD-GUI å·¥å…·æ‰“å¼€ class æ–‡ä»¶ï¼Œå¹¶å¯¼å‡ºä¸º java æ–‡ä»¶\n2ã€ä¿®æ”¹å®Œæ¯•ï¼Œé‡æ–°ä½¿ç”¨ javac ç¼–è¯‘\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/9f9269cbfec4b34850bee93a0a6b192d.png)\n\n\n## ä¿®æ”¹ for å¾ªç¯æ¬¡æ•°\n\n\n**1ã€ç¬¬ä¸€ç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a76f00397b0fce18876026f6829738f5.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/7b81844c00d775820b56c6f0b9ac1961.png)\n\n```java\niconst_<`n`>ï¼š  æŠŠå€¼å‹å…¥æ“ä½œæ•°å †æ ˆ\nistore_<`n`>ï¼š  å¼¹å‡ºå¹¶è·å–æ“ä½œæ•°å †æ ˆæ ˆé¡¶é¡¶çš„å€¼ï¼Œå¹¶å°†å…¶å€¼å­˜å‚¨åˆ°æœ¬åœ°å˜é‡\niload_<`n`>ï¼š   ä»æœ¬åœ°å˜é‡è·å–å€¼\nif_icmpï¼š       å¦‚æœæ¯”è¾ƒæˆåŠŸåˆ™æ‰§è¡Œåç»­æŒ‡ä»¤\ndupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°\niinc `index` by `value`: æŒ‰ç…§ value è‡ªå¢\n\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è‡ªå¢é‡`value`æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n\n**2ã€ç¬¬äºŒç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/d5b54400c909e17de7eeac8fdbcbec4b.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/67ea8692acc97de294a5fd5624d0496a.png)\n\n```java\nbipushï¼š    å°†å€¼å‹å…¥åˆ°æ“ä½œæ•°å †æ ˆ\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`final int MAX_COUNTï¼ˆbipush çš„å€¼ï¼‰`æ¥è·³è¿‡æˆ–å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n**3ã€ç¬¬ä¸‰ç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/bea551ae82ec1340deb4802f0d2d26a4.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/8c7203dfd3cd59c3eaefcb2c0f867dd3.png)\n\n```java\nanewarrayï¼š åˆ›å»ºæ•°ç»„å¼•ç”¨\naastoreï¼š   æŠŠå€¼å­˜å‚¨åˆ°æ•°ç»„åˆ—è¡¨ä¸­\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`iinc`è‡ªå¢é‡`value`æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n# ä¿®æ”¹ smail æŸä¸ªå˜é‡\n\nä¸Šè¿°ç®—æ˜¯å®ç°äº†å¦‚ä½•ç®€å•ä¿®æ”¹ class æ–‡ä»¶ä¸­çš„æŸä¸ªå¸¸é‡ï¼Œååˆ†ç®€å•ã€‚ä½†æ˜¯å‘¢ï¼Ÿæœ‰æ—¶å€™åç¼–è¯‘ apk æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨ `apktool` å·¥å…·ï¼Œåç¼–è¯‘å¾—åˆ°çš„æ˜¯ `smail` ä»£ç ï¼Œéš¾ä¸æˆè¿˜æƒ³æŠŠ `smail` è½¬æ¢æˆ class å†ä¿®æ”¹ï¼Œå¯éº»çƒ¦äº†ã€‚\n\n## ç¯å¢ƒã€å·¥å…·å‡†å¤‡\n\n> å·¥æ¬²å–„å…¶ï¼Œäº‹å¿…å…ˆåˆ©å…¶å™¨\n\n1ã€[apktool ä¸‹è½½](https://ibotpeaches.github.io/Apktool/)\n2ã€[JADX åç¼–è¯‘åˆ©å™¨ä¸‹è½½](https://github.com/skylot/jadx)\n3ã€[VSCode ä¸‹è½½](https://code.visualstudio.com/)\n4ã€[VSCode smali2Java æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=ooooonly.smali2java)\n\nåœ¨ vscode ä¸º smali2Java é…ç½® jadx.bat è·¯å¾„ï¼š`Decompile failed: The jadx executable path has not been configured`\n\n**1ã€é…ç½® vscode**\n\n1ã€æ‰¾åˆ° vscode æ’ä»¶é…ç½®æ–‡ä»¶ï¼š`C:\\Users\\YTS\\.vscode\\extensions`ï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°çš„ smali2java é…ç½®æ˜¯åœ¨ï¼š`C:\\Users\\YTS\\.vscode\\extensions\\ooooonly.smali2java-1.0.1\\pachage.json`\n\n2ã€æ‰¾åˆ° jadxPathï¼š\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f55e99d21c69e4130e01c16b9f2bb3a3.png)\n\n**2ã€è·å¾— smail**\n\nå½“é‡åˆ° dex åç¼–è¯‘é”™è¯¯æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° `--only-main-classes`\n\n```java\njava -jar apktool_2.6.1.jar d <apk æ–‡ä»¶> --only-main-classes\n````\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/0148a4cc70f2c26b68184431306d67b4.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b1241ca7c38bc50d143ffa67d80c5933.png)\n\n**3ã€ç®€çº¦åˆ†æ**\næˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ sayHello() å»¶æ—¶æ‰§è¡Œæ—¶é—´ï¼Œç›®å‰æ˜¯ 1000 æ¯«ç§’ï¼Œ1000 çš„åå…­è¿›åˆ¶æ˜¯ x03e8ï¼ŒsayHello() æ‰€åœ¨ç±»æ˜¯ GameDemoActivityï¼›åœ¨ smail ä»£ç ä¸­æœç´¢ç±»åã€æ–¹æ³•åã€x03e8 ç­‰å¯å®šä½ä»£ç ï¼›å¦‚æœæˆ‘æƒ³ä¿®æ”¹æˆå»¶æ—¶ 5000 æ¯«ç§’åæ‰§è¡Œï¼Œé‚£æŠŠ 5000ï¼ˆx01388ï¼‰ çš„åå…­è¿›åˆ¶æ›¿æ¢æ‰ x03e8 å³å¯ã€‚\n\n```java\nprivate Handler mHandle = new Handler();\n\nprivate void sayHello() {\n    System.out.println(\"invoke sayHello time = \" + System.currentTimeMillis());\n    mHandle.postDelayed(new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"execute sayHello time = \" + System.currentTimeMillis());\n            System.out.println(\"ä½ å¥½ï¼Œæ‘é•¿\");\n        }\n    }, 1000);\n}\n\nè¾“å‡ºï¼š\n2022-05-23 18:14:20.134 32431-32431/com.primer.comment I/System.out: invoke sayHello time = 1653300860134\n2022-05-23 18:14:21.135 32431-32431/com.primer.comment I/System.out: execute sayHello time = 1653300861135\n```\n\n> smail æºç \n\n![image.png](https://img-blog.csdnimg.cn/img_convert/c3849a7c84f328e728c7c3ad6b929736.png)\n\n```java\n2022-05-23 18:21:48.473 1333-1333/com.primer.comment I/System.out: invoke sayHello time = 1653301308473\n2022-05-23 18:21:53.478 1333-1333/com.primer.comment I/System.out: execute sayHello time = 1653301313478\n```\n\n> æœ€åæ‰“åŒ…ã€ç­¾å\n\n```java\njava -jar apktool_2.6.1.jar b <æ‰“åŒ…ç›®å½•> \n\napksigner sign --ks ****.jks --ks-key-alias <åˆ«å> --out <æ–°ç”Ÿæˆ apk> <å¾…ç­¾å apk>\n```\n\n\n","source":"_posts/undefined/ä½ æˆ‘å­—èŠ‚ç .md","raw":"---\ntitle: å†æ¢ jclasslib ä¿®æ”¹å­—èŠ‚ç \ncatalog: true\ndate: 2022-09-25 23:11:20\nsubtitle: å¤å¤©çš„æµ·è¾¹ï¼Œå†ç¾ä¸è¿‡è½æ—¥ä½™æ™–\nheader-img: /img/220923_classmodify/ymclass_bg.png\ntags: å­—èŠ‚ç \ncategories:\nsticky: 3\n---\n\n\n# ä» jclasslib è®¤è¯† Hello world\n\né‚£å¹´ï¼Œå†ç†Ÿæ‚‰ä¸è¿‡çš„ Hello worldã€‚\n\nå¯èƒ½å¾ˆå¤šäººçš„ç¬¬ä¸€ä¸ª java ç¨‹åºéƒ½ä»â€˜ä½ å¥½ä¸–ç•Œâ€™å¼€å§‹ï¼Œä»æ­¤è¸ä¸Šäº†ä¸€æ¡***ä¸å½’è·¯***ï¼Œå¤šå¹´ä»¥åï¼ˆå¤§æ¦‚æ¯•ä¸šåŠå¹´ï¼‰ï¼Œæˆ‘ä»¥å¦ä¸€ç§æ–¹å¼é‡æ–°è®¤è¯†å®ƒï¼Œè¿™ç§æ–¹å¼å«**å­—èŠ‚ç **ã€‚\n\n> Test.java\n\n```java\npackage primer;\n\n//æ¯”å¦‚ Test ç±»çš„ç»„æˆï¼š\n//ä¸»ç‰ˆæœ¬å· + å¸¸é‡æ±  + è®¿é—®æ ‡è¯† + å½“å‰ç±»ç­¾å + çˆ¶ç±»ç­¾å + æ¥å£é›†åˆ + æ–¹æ³•é›†åˆ + å­—æ®µé›†åˆ + å±æ€§é›†åˆï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰\npublic class Test{\n    //æ–¹æ³•ä¸€ï¼š<init>()V   ã€é»˜è®¤æ„é€ å™¨ã€‘\n    \n    //æ–¹æ³•äºŒï¼šmain([Ljava/lang/String;)V   ã€main æ–¹æ³•ã€V è¡¨ç¤º voidã€L è¡¨ç¤ºæ•°ç»„ã€String å˜æˆç±»çš„å…¨è·¯å¾„ã€‘ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼›String ä½œä¸ºå¯¹è±¡ç»“å°¾å¿…é¡»æ˜¯é€—å·ï¼‰\n    \n    //æ¯”å¦‚ main æ–¹æ³•ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰\n    // ç»„æˆï¼š \n    //    - æ–¹æ³•å + æ–¹æ³•ç­¾å + è®¿é—®æ ‡è¯†ï¼ˆmain + ([Ljava/lang/String;)V + public staticï¼‰\n    //    - å¼‚å¸¸è¡¨\n    //    - å­—èŠ‚ç ã€æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‘\n    \n    public static void main(String[] args) {\n        System.out.println(\"Hello World\");\n    }\n}\n```\n\n> `javac Test.java` ç¼–è¯‘å¾—åˆ° Test.class å­—èŠ‚ç æ–‡ä»¶\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/6fd777b8a85ec867a59fdb307082595b.png)\n\nä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `java <ç±»å…¨è·¯å¾„>` ç›´æ¥è¿è¡ŒæŸ¥çœ‹æ•ˆæœï¼Œç±»å…¨è·¯å¾„ï¼šåŒ…å + ç±»å\n\n\n**ä¸¾ä¸ªä¾‹å­ï¼š**\n\nTest å¯åŠ¨ç±»çš„åŒ…åæ˜¯ `package primer`ï¼Œæˆ‘æœ¬åœ°ç›®å½•æ˜¯`primer/primer/Test.class`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec87c8988833fd4f5d34a8f9edb76d8c.png)\n\n1ã€åœ¨ class æ‰€åœ¨ç›®å½•ä¸‹è¿è¡Œ âŒ\n\nå¦‚æœä½ åœ¨ Test.class åŒçº§ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤è¿è¡Œï¼Œå¯æƒœæŠ¥é”™äº†ï¼Œå¤§æ¦‚æ„æ€æ˜¯ä½ çš„ Test ç±»å…¨è·¯å¾„ä¸å¯¹ï¼Œå½“å­˜åœ¨ä¸»ç±»å­˜åœ¨åŒ…åæ—¶ï¼Œä¸èƒ½åœ¨å½“å‰ class æ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦åœ¨åŒ…åæ‰€åœ¨ç›®å½•æ‰§è¡Œï¼Œå¦åˆ™æŠ¥é”™ï¼Œjava å‘½ä»¤è®¤ä¸ºåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾***åŒ…åè·¯å¾„***ï¼Œå¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ ¹æ®åŒ…åå¾€ä¸‹æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»ç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/421255941965168858b22ae04aebe4d6.png)\n\nå‰é¢æåˆ°ï¼Œç›´æ¥æ‰§è¡Œå­—èŠ‚ç æ˜¯è¿™æ · **`java <ç±»å…¨è·¯å¾„>`**ï¼Œå…¨è·¯å¾„æ˜¯è¦åŒ…å«åŒ…ååœ¨å†…ï¼Œæ¯”å¦‚ `com.tencent.mmkv.MMKV`ï¼Œå¦‚æœ MMKV ç±»æœ‰æ‰§è¡Œå…¥å£ï¼Œæƒ³è¦é€šè¿‡ java å‘½ä»¤æ‰§è¡Œå®ƒå¿…é¡»ç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚**JVM åœ¨åŠ è½½ç±»è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•ç¡®å®šå”¯ä¸€ä¸ªç±»çš„ï¼Ÿ**æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªç±»åç›¸åŒä½†åŒ…åï¼ˆå…¨è·¯å¾„ï¼‰ä¸åŒçš„ Test ç±»ï¼ŒJVM é€šè¿‡`åŒ…åé™å®šç¬¦ + æ˜¯å¦åŒä¸€ä¸ªè™šæ‹Ÿæœº`å”¯ä¸€ç¡®å®šä¸€ä¸ªç±»ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œçš„ç¨‹åºåªæœ‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼‰\n\n2ã€åœ¨ class å¯åŠ¨ç±»æœ€å¤–å±‚åŒ…åçš„ä¸Šä¸€å±‚ç›®å½•è¿è¡Œ â˜‘ï¸\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/ec6fbd643ecb13cd555200dc4ab5fbd2.png)\n\n## é‚‚é€…çš„ jclasslib\n\nè¿™é‡Œå¼€å§‹æ¶‰åŠåˆ°å…·ä½“çš„ JVM æŒ‡ä»¤ï¼Œå…ˆå¥‰ä¸Šå®˜æ–¹æ–‡æ¡£ [ORACLE - JVM æŒ‡ä»¤é›† ](https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.getstatic)ï¼Œå…¨éƒ¨æŒ‡ä»¤è®°ä½ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²ï¼Œé€šå¸¸æ˜¯ç”¨æ—¶æŸ¥é˜…ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼›å¯¹äº jclasslib å·¥å…·å¯ä»¥å³å‡»è·³è½¬åˆ°å®˜æ–¹æ–‡æ¡£ç‰¹å®šæŒ‡ä»¤ä½ç½®`show JVM spec`ã€‚ä»¥ä¸Šé¢çš„`Hello World`ä¸ºä¾‹å­è¿›è¡Œæ“ä½œã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/160147efe7c8029f9f254df0e0d853e1.png)\n\n**1ã€ä¿®æ”¹å­—ç¬¦ä¸²å¸¸é‡**\n\nå…ˆçœ‹ main æ–¹æ³•çš„ java ä»£ç ï¼Œè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ˜¯ `Hello World`\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/cceaaf6bd80b26ff3667900fc47cb4cc.png)\n\nå†çœ‹ main æ–¹æ³•çš„ class å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ javap å‘½ä»¤æŸ¥çœ‹å­—èŠ‚ç \n\n![image.png](https://img-blog.csdnimg.cn/img_convert/34699591dd1e5ae793d6b15d803951c0.png)\n\n```java\ngetstaticï¼š     è·å–é™æ€å­—æ®µ outï¼ˆSystem ç±»ä¸­çš„ out å£°æ˜æ˜¯ `public final static PrintStream out = null;`ï¼‰\nldcï¼š           ä»å¸¸é‡æ± ä¸­è·å–å€¼å¹¶å‹å…¥æ“ä½œæ•°æ ˆï¼ˆæ­¤å¤„å¸¸é‡æ˜¯ `Hello World`ï¼‰\ninvokevirtualï¼š ç±»çº§åˆ«çš„æ–¹æ³•è°ƒç”¨ï¼ˆå¯ä»¥æ˜¯é€šè¿‡ç±»åè°ƒç”¨æ–¹æ³• `System.out.println()`ï¼‰\nnewï¼š           åˆ›å»º Hello ç±»çš„å®ä¾‹\ndupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°\ninvokespecialï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•\nastore_1ï¼š      æŠŠåˆ›å»ºçš„ Hello å¯¹è±¡å­˜å‚¨åˆ° hello æœ¬åœ°å˜é‡\naload_1ï¼š       åŠ è½½ hello æœ¬åœ°å˜é‡çš„å¯¹è±¡\ninvokevirtualï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•\nreturnï¼š        æ–¹æ³•é€€å‡º\n```\n\nåœ¨å·¥å…·ä¸Šå¯¹å­—èŠ‚ç ç›´æ¥è¿›è¡Œä¿®æ”¹`ldc`è¯»å–çš„å¸¸é‡å€¼ï¼Œä¿å­˜å¹¶é‡æ–°ç¼–è¯‘è¿è¡Œï¼ˆæˆ‘åœ¨æƒ³ä¸€ä¸ªç–‘æƒ‘ï¼šæˆ‘ä¿®æ”¹çš„å­—ç¬¦ä¸²ä¹‹å‰åœ¨å¸¸é‡æ± ä¸­æ²¡æœ‰ï¼Œæ˜¯å¦åœ¨æˆ‘ä¿®æ”¹å¹¶ä¿å­˜åä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²çº³å…¥å¸¸é‡æ± ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/76d48e2e9a414d6ec3651e6550891099.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/61b1f79282b2c1a44d998b702f129ae1.png)\n\n\n# è·³è·³è™ï¼šç°åœ¨ä¸€èµ·æƒ³æƒ³æƒ³\n\nåœ¨æˆ‘ä»¬çš„è®°å¿†ä¸­ï¼Œå­—é¢é‡ç›¸åŒçš„å­—ç¬¦ä¸²å¸¸é‡åœ¨å¸¸é‡æ± ä¸­æ˜¯ä»…å­˜ä¸€ä»½ã€‚å¦‚ä¸‹ä»£ç `\"å¼ ä¸‰\"`å­—ç¬¦ä¸²åœ¨å¸¸é‡æ± ä¸­æœ‰ä¸”åªæœ‰ä¸€ä»½ï¼Œä½†æ˜¯ç¨‹åºä¸­å¤šå¤„å¼•ç”¨ï¼Œç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸­çš„å€¼é‚£ä¹ˆè¿™ä¸¤ä¸ªè¾“å‡ºçš„éƒ½ä¼šæ”¹å˜äº†ï¼Œæˆ‘å¸Œæœ›åªæ”¹å˜`name`çš„è¾“å‡ºï¼Œä¿æŒåŸå…ˆ`aliasName`çš„å€¼ã€‚\n\nç›´æ¥ä¿®æ”¹å¸¸é‡æ± ï¼Œç¡®å®ä¸¤ä¸ªéƒ½å—å½±å“ï¼Œä¸ç¬¦åˆæœŸæœ›\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a49ef4afa4cd0c272c09965ce5d0d947.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/1ca7b5055306fd77c67fd1674eac168d.png)\n\nç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ï¼Œé‚£å¦‚ä½•æ“ä½œæ»¡è¶³éœ€æ±‚å‘¢ï¼Ÿå¦‚æœä½ æœ‰æ›´å¥½çš„ç‰ˆæœ¬æ¬¢è¿è¯„è®ºã€‚\n\n\næˆ‘åªå¥½å¦¥å`åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¼•ç”¨`ï¼Œé€šè¿‡ jd-gui æŠŠ classæ–‡ä»¶è½¬æ¢æˆ java æ–‡ä»¶ï¼Œä¿®æ”¹å®Œæ¯•ä¹‹åå† javac ç¼–è¯‘æˆ class æ–‡ä»¶ç„¶åè¿è¡Œï¼›å¦‚æœä½ æœ‰å…¶ä»–æ–¹æ³•ï¼Œæ¬¢è¿è¯„è®ºã€‚\n\n1ã€ä½¿ç”¨ JD-GUI å·¥å…·æ‰“å¼€ class æ–‡ä»¶ï¼Œå¹¶å¯¼å‡ºä¸º java æ–‡ä»¶\n2ã€ä¿®æ”¹å®Œæ¯•ï¼Œé‡æ–°ä½¿ç”¨ javac ç¼–è¯‘\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/9f9269cbfec4b34850bee93a0a6b192d.png)\n\n\n## ä¿®æ”¹ for å¾ªç¯æ¬¡æ•°\n\n\n**1ã€ç¬¬ä¸€ç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/a76f00397b0fce18876026f6829738f5.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/7b81844c00d775820b56c6f0b9ac1961.png)\n\n```java\niconst_<`n`>ï¼š  æŠŠå€¼å‹å…¥æ“ä½œæ•°å †æ ˆ\nistore_<`n`>ï¼š  å¼¹å‡ºå¹¶è·å–æ“ä½œæ•°å †æ ˆæ ˆé¡¶é¡¶çš„å€¼ï¼Œå¹¶å°†å…¶å€¼å­˜å‚¨åˆ°æœ¬åœ°å˜é‡\niload_<`n`>ï¼š   ä»æœ¬åœ°å˜é‡è·å–å€¼\nif_icmpï¼š       å¦‚æœæ¯”è¾ƒæˆåŠŸåˆ™æ‰§è¡Œåç»­æŒ‡ä»¤\ndupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°\niinc `index` by `value`: æŒ‰ç…§ value è‡ªå¢\n\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è‡ªå¢é‡`value`æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n\n**2ã€ç¬¬äºŒç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/d5b54400c909e17de7eeac8fdbcbec4b.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/67ea8692acc97de294a5fd5624d0496a.png)\n\n```java\nbipushï¼š    å°†å€¼å‹å…¥åˆ°æ“ä½œæ•°å †æ ˆ\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`final int MAX_COUNTï¼ˆbipush çš„å€¼ï¼‰`æ¥è·³è¿‡æˆ–å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n**3ã€ç¬¬ä¸‰ç§ç±»å‹çš„ for å¾ªç¯**\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/bea551ae82ec1340deb4802f0d2d26a4.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/8c7203dfd3cd59c3eaefcb2c0f867dd3.png)\n\n```java\nanewarrayï¼š åˆ›å»ºæ•°ç»„å¼•ç”¨\naastoreï¼š   æŠŠå€¼å­˜å‚¨åˆ°æ•°ç»„åˆ—è¡¨ä¸­\n```\n\nå¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹`iinc`è‡ªå¢é‡`value`æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°\n\n# ä¿®æ”¹ smail æŸä¸ªå˜é‡\n\nä¸Šè¿°ç®—æ˜¯å®ç°äº†å¦‚ä½•ç®€å•ä¿®æ”¹ class æ–‡ä»¶ä¸­çš„æŸä¸ªå¸¸é‡ï¼Œååˆ†ç®€å•ã€‚ä½†æ˜¯å‘¢ï¼Ÿæœ‰æ—¶å€™åç¼–è¯‘ apk æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨ `apktool` å·¥å…·ï¼Œåç¼–è¯‘å¾—åˆ°çš„æ˜¯ `smail` ä»£ç ï¼Œéš¾ä¸æˆè¿˜æƒ³æŠŠ `smail` è½¬æ¢æˆ class å†ä¿®æ”¹ï¼Œå¯éº»çƒ¦äº†ã€‚\n\n## ç¯å¢ƒã€å·¥å…·å‡†å¤‡\n\n> å·¥æ¬²å–„å…¶ï¼Œäº‹å¿…å…ˆåˆ©å…¶å™¨\n\n1ã€[apktool ä¸‹è½½](https://ibotpeaches.github.io/Apktool/)\n2ã€[JADX åç¼–è¯‘åˆ©å™¨ä¸‹è½½](https://github.com/skylot/jadx)\n3ã€[VSCode ä¸‹è½½](https://code.visualstudio.com/)\n4ã€[VSCode smali2Java æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=ooooonly.smali2java)\n\nåœ¨ vscode ä¸º smali2Java é…ç½® jadx.bat è·¯å¾„ï¼š`Decompile failed: The jadx executable path has not been configured`\n\n**1ã€é…ç½® vscode**\n\n1ã€æ‰¾åˆ° vscode æ’ä»¶é…ç½®æ–‡ä»¶ï¼š`C:\\Users\\YTS\\.vscode\\extensions`ï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°çš„ smali2java é…ç½®æ˜¯åœ¨ï¼š`C:\\Users\\YTS\\.vscode\\extensions\\ooooonly.smali2java-1.0.1\\pachage.json`\n\n2ã€æ‰¾åˆ° jadxPathï¼š\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f55e99d21c69e4130e01c16b9f2bb3a3.png)\n\n**2ã€è·å¾— smail**\n\nå½“é‡åˆ° dex åç¼–è¯‘é”™è¯¯æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° `--only-main-classes`\n\n```java\njava -jar apktool_2.6.1.jar d <apk æ–‡ä»¶> --only-main-classes\n````\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/0148a4cc70f2c26b68184431306d67b4.png)\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b1241ca7c38bc50d143ffa67d80c5933.png)\n\n**3ã€ç®€çº¦åˆ†æ**\næˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ sayHello() å»¶æ—¶æ‰§è¡Œæ—¶é—´ï¼Œç›®å‰æ˜¯ 1000 æ¯«ç§’ï¼Œ1000 çš„åå…­è¿›åˆ¶æ˜¯ x03e8ï¼ŒsayHello() æ‰€åœ¨ç±»æ˜¯ GameDemoActivityï¼›åœ¨ smail ä»£ç ä¸­æœç´¢ç±»åã€æ–¹æ³•åã€x03e8 ç­‰å¯å®šä½ä»£ç ï¼›å¦‚æœæˆ‘æƒ³ä¿®æ”¹æˆå»¶æ—¶ 5000 æ¯«ç§’åæ‰§è¡Œï¼Œé‚£æŠŠ 5000ï¼ˆx01388ï¼‰ çš„åå…­è¿›åˆ¶æ›¿æ¢æ‰ x03e8 å³å¯ã€‚\n\n```java\nprivate Handler mHandle = new Handler();\n\nprivate void sayHello() {\n    System.out.println(\"invoke sayHello time = \" + System.currentTimeMillis());\n    mHandle.postDelayed(new Runnable() {\n        @Override\n        public void run() {\n            System.out.println(\"execute sayHello time = \" + System.currentTimeMillis());\n            System.out.println(\"ä½ å¥½ï¼Œæ‘é•¿\");\n        }\n    }, 1000);\n}\n\nè¾“å‡ºï¼š\n2022-05-23 18:14:20.134 32431-32431/com.primer.comment I/System.out: invoke sayHello time = 1653300860134\n2022-05-23 18:14:21.135 32431-32431/com.primer.comment I/System.out: execute sayHello time = 1653300861135\n```\n\n> smail æºç \n\n![image.png](https://img-blog.csdnimg.cn/img_convert/c3849a7c84f328e728c7c3ad6b929736.png)\n\n```java\n2022-05-23 18:21:48.473 1333-1333/com.primer.comment I/System.out: invoke sayHello time = 1653301308473\n2022-05-23 18:21:53.478 1333-1333/com.primer.comment I/System.out: execute sayHello time = 1653301313478\n```\n\n> æœ€åæ‰“åŒ…ã€ç­¾å\n\n```java\njava -jar apktool_2.6.1.jar b <æ‰“åŒ…ç›®å½•> \n\napksigner sign --ks ****.jks --ks-key-alias <åˆ«å> --out <æ–°ç”Ÿæˆ apk> <å¾…ç­¾å apk>\n```\n\n\n","slug":"ä½ æˆ‘å­—èŠ‚ç ","published":1,"lang":"undefined","updated":"2022-09-25T15:11:20.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsp000ggaqp3m782xx9","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>ä» jclasslib è®¤è¯† Hello world</h1>\n<p>é‚£å¹´ï¼Œå†ç†Ÿæ‚‰ä¸è¿‡çš„ Hello worldã€‚</p>\n<p>å¯èƒ½å¾ˆå¤šäººçš„ç¬¬ä¸€ä¸ª java ç¨‹åºéƒ½ä»â€˜ä½ å¥½ä¸–ç•Œâ€™å¼€å§‹ï¼Œä»æ­¤è¸ä¸Šäº†ä¸€æ¡<em><strong>ä¸å½’è·¯</strong></em>ï¼Œå¤šå¹´ä»¥åï¼ˆå¤§æ¦‚æ¯•ä¸šåŠå¹´ï¼‰ï¼Œæˆ‘ä»¥å¦ä¸€ç§æ–¹å¼é‡æ–°è®¤è¯†å®ƒï¼Œè¿™ç§æ–¹å¼å«<strong>å­—èŠ‚ç </strong>ã€‚</p>\n<blockquote>\n<p>Test.java</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> primer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ¯”å¦‚ Test ç±»çš„ç»„æˆï¼š</span></span><br><span class=\"line\"><span class=\"comment\">//ä¸»ç‰ˆæœ¬å· + å¸¸é‡æ±  + è®¿é—®æ ‡è¯† + å½“å‰ç±»ç­¾å + çˆ¶ç±»ç­¾å + æ¥å£é›†åˆ + æ–¹æ³•é›†åˆ + å­—æ®µé›†åˆ + å±æ€§é›†åˆï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ–¹æ³•ä¸€ï¼š&lt;init&gt;()V   ã€é»˜è®¤æ„é€ å™¨ã€‘</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ–¹æ³•äºŒï¼šmain([Ljava/lang/String;)V   ã€main æ–¹æ³•ã€V è¡¨ç¤º voidã€L è¡¨ç¤ºæ•°ç»„ã€String å˜æˆç±»çš„å…¨è·¯å¾„ã€‘ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼›String ä½œä¸ºå¯¹è±¡ç»“å°¾å¿…é¡»æ˜¯é€—å·ï¼‰</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ¯”å¦‚ main æ–¹æ³•ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">// ç»„æˆï¼š </span></span><br><span class=\"line\">    <span class=\"comment\">//    - æ–¹æ³•å + æ–¹æ³•ç­¾å + è®¿é—®æ ‡è¯†ï¼ˆmain + ([Ljava/lang/String;)V + public staticï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">//    - å¼‚å¸¸è¡¨</span></span><br><span class=\"line\">    <span class=\"comment\">//    - å­—èŠ‚ç ã€æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‘</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello World&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>javac Test.java</code> ç¼–è¯‘å¾—åˆ° Test.class å­—èŠ‚ç æ–‡ä»¶</p>\n</blockquote>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/6fd777b8a85ec867a59fdb307082595b.png\" alt=\"image.png\"></p>\n<p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>java &lt;ç±»å…¨è·¯å¾„&gt;</code> ç›´æ¥è¿è¡ŒæŸ¥çœ‹æ•ˆæœï¼Œç±»å…¨è·¯å¾„ï¼šåŒ…å + ç±»å</p>\n<p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p>\n<p>Test å¯åŠ¨ç±»çš„åŒ…åæ˜¯ <code>package primer</code>ï¼Œæˆ‘æœ¬åœ°ç›®å½•æ˜¯<code>primer/primer/Test.class</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec87c8988833fd4f5d34a8f9edb76d8c.png\" alt=\"image.png\"></p>\n<p>1ã€åœ¨ class æ‰€åœ¨ç›®å½•ä¸‹è¿è¡Œ âŒ</p>\n<p>å¦‚æœä½ åœ¨ Test.class åŒçº§ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤è¿è¡Œï¼Œå¯æƒœæŠ¥é”™äº†ï¼Œå¤§æ¦‚æ„æ€æ˜¯ä½ çš„ Test ç±»å…¨è·¯å¾„ä¸å¯¹ï¼Œå½“å­˜åœ¨ä¸»ç±»å­˜åœ¨åŒ…åæ—¶ï¼Œä¸èƒ½åœ¨å½“å‰ class æ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦åœ¨åŒ…åæ‰€åœ¨ç›®å½•æ‰§è¡Œï¼Œå¦åˆ™æŠ¥é”™ï¼Œjava å‘½ä»¤è®¤ä¸ºåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾<em><strong>åŒ…åè·¯å¾„</strong></em>ï¼Œå¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ ¹æ®åŒ…åå¾€ä¸‹æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»ç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/421255941965168858b22ae04aebe4d6.png\" alt=\"image.png\"></p>\n<p>å‰é¢æåˆ°ï¼Œç›´æ¥æ‰§è¡Œå­—èŠ‚ç æ˜¯è¿™æ · <strong><code>java &lt;ç±»å…¨è·¯å¾„&gt;</code></strong>ï¼Œå…¨è·¯å¾„æ˜¯è¦åŒ…å«åŒ…ååœ¨å†…ï¼Œæ¯”å¦‚ <code>com.tencent.mmkv.MMKV</code>ï¼Œå¦‚æœ MMKV ç±»æœ‰æ‰§è¡Œå…¥å£ï¼Œæƒ³è¦é€šè¿‡ java å‘½ä»¤æ‰§è¡Œå®ƒå¿…é¡»ç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚**JVM åœ¨åŠ è½½ç±»è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•ç¡®å®šå”¯ä¸€ä¸ªç±»çš„ï¼Ÿ**æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªç±»åç›¸åŒä½†åŒ…åï¼ˆå…¨è·¯å¾„ï¼‰ä¸åŒçš„ Test ç±»ï¼ŒJVM é€šè¿‡<code>åŒ…åé™å®šç¬¦ + æ˜¯å¦åŒä¸€ä¸ªè™šæ‹Ÿæœº</code>å”¯ä¸€ç¡®å®šä¸€ä¸ªç±»ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œçš„ç¨‹åºåªæœ‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼‰</p>\n<p>2ã€åœ¨ class å¯åŠ¨ç±»æœ€å¤–å±‚åŒ…åçš„ä¸Šä¸€å±‚ç›®å½•è¿è¡Œ â˜‘ï¸</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec6fbd643ecb13cd555200dc4ab5fbd2.png\" alt=\"image.png\"></p>\n<h2 id=\"é‚‚é€…çš„-jclasslib\">é‚‚é€…çš„ jclasslib</h2>\n<p>è¿™é‡Œå¼€å§‹æ¶‰åŠåˆ°å…·ä½“çš„ JVM æŒ‡ä»¤ï¼Œå…ˆå¥‰ä¸Šå®˜æ–¹æ–‡æ¡£ <a href=\"https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.getstatic\">ORACLE - JVM æŒ‡ä»¤é›† </a>ï¼Œå…¨éƒ¨æŒ‡ä»¤è®°ä½ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²ï¼Œé€šå¸¸æ˜¯ç”¨æ—¶æŸ¥é˜…ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼›å¯¹äº jclasslib å·¥å…·å¯ä»¥å³å‡»è·³è½¬åˆ°å®˜æ–¹æ–‡æ¡£ç‰¹å®šæŒ‡ä»¤ä½ç½®<code>show JVM spec</code>ã€‚ä»¥ä¸Šé¢çš„<code>Hello World</code>ä¸ºä¾‹å­è¿›è¡Œæ“ä½œã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/160147efe7c8029f9f254df0e0d853e1.png\" alt=\"image.png\"></p>\n<p><strong>1ã€ä¿®æ”¹å­—ç¬¦ä¸²å¸¸é‡</strong></p>\n<p>å…ˆçœ‹ main æ–¹æ³•çš„ java ä»£ç ï¼Œè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ˜¯ <code>Hello World</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/cceaaf6bd80b26ff3667900fc47cb4cc.png\" alt=\"image.png\"></p>\n<p>å†çœ‹ main æ–¹æ³•çš„ class å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ javap å‘½ä»¤æŸ¥çœ‹å­—èŠ‚ç </p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/34699591dd1e5ae793d6b15d803951c0.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">getstaticï¼š     è·å–é™æ€å­—æ®µ outï¼ˆSystem ç±»ä¸­çš„ out å£°æ˜æ˜¯ `<span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> PrintStream out = <span class=\"keyword\">null</span>;`ï¼‰</span><br><span class=\"line\">ldcï¼š           ä»å¸¸é‡æ± ä¸­è·å–å€¼å¹¶å‹å…¥æ“ä½œæ•°æ ˆï¼ˆæ­¤å¤„å¸¸é‡æ˜¯ `Hello World`ï¼‰</span><br><span class=\"line\">invokevirtualï¼š ç±»çº§åˆ«çš„æ–¹æ³•è°ƒç”¨ï¼ˆå¯ä»¥æ˜¯é€šè¿‡ç±»åè°ƒç”¨æ–¹æ³• `System.out.println()`ï¼‰</span><br><span class=\"line\"><span class=\"keyword\">new</span>ï¼š           åˆ›å»º Hello ç±»çš„å®ä¾‹</span><br><span class=\"line\">dupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°</span><br><span class=\"line\">invokespecialï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br><span class=\"line\">astore_1ï¼š      æŠŠåˆ›å»ºçš„ Hello å¯¹è±¡å­˜å‚¨åˆ° hello æœ¬åœ°å˜é‡</span><br><span class=\"line\">aload_1ï¼š       åŠ è½½ hello æœ¬åœ°å˜é‡çš„å¯¹è±¡</span><br><span class=\"line\">invokevirtualï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br><span class=\"line\"><span class=\"keyword\">return</span>ï¼š        æ–¹æ³•é€€å‡º</span><br></pre></td></tr></table></figure>\n<p>åœ¨å·¥å…·ä¸Šå¯¹å­—èŠ‚ç ç›´æ¥è¿›è¡Œä¿®æ”¹<code>ldc</code>è¯»å–çš„å¸¸é‡å€¼ï¼Œä¿å­˜å¹¶é‡æ–°ç¼–è¯‘è¿è¡Œï¼ˆæˆ‘åœ¨æƒ³ä¸€ä¸ªç–‘æƒ‘ï¼šæˆ‘ä¿®æ”¹çš„å­—ç¬¦ä¸²ä¹‹å‰åœ¨å¸¸é‡æ± ä¸­æ²¡æœ‰ï¼Œæ˜¯å¦åœ¨æˆ‘ä¿®æ”¹å¹¶ä¿å­˜åä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²çº³å…¥å¸¸é‡æ± ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/76d48e2e9a414d6ec3651e6550891099.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/61b1f79282b2c1a44d998b702f129ae1.png\" alt=\"image.png\"></p>\n<h1>è·³è·³è™ï¼šç°åœ¨ä¸€èµ·æƒ³æƒ³æƒ³</h1>\n<p>åœ¨æˆ‘ä»¬çš„è®°å¿†ä¸­ï¼Œå­—é¢é‡ç›¸åŒçš„å­—ç¬¦ä¸²å¸¸é‡åœ¨å¸¸é‡æ± ä¸­æ˜¯ä»…å­˜ä¸€ä»½ã€‚å¦‚ä¸‹ä»£ç <code>&quot;å¼ ä¸‰&quot;</code>å­—ç¬¦ä¸²åœ¨å¸¸é‡æ± ä¸­æœ‰ä¸”åªæœ‰ä¸€ä»½ï¼Œä½†æ˜¯ç¨‹åºä¸­å¤šå¤„å¼•ç”¨ï¼Œç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸­çš„å€¼é‚£ä¹ˆè¿™ä¸¤ä¸ªè¾“å‡ºçš„éƒ½ä¼šæ”¹å˜äº†ï¼Œæˆ‘å¸Œæœ›åªæ”¹å˜<code>name</code>çš„è¾“å‡ºï¼Œä¿æŒåŸå…ˆ<code>aliasName</code>çš„å€¼ã€‚</p>\n<p>ç›´æ¥ä¿®æ”¹å¸¸é‡æ± ï¼Œç¡®å®ä¸¤ä¸ªéƒ½å—å½±å“ï¼Œä¸ç¬¦åˆæœŸæœ›</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a49ef4afa4cd0c272c09965ce5d0d947.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/1ca7b5055306fd77c67fd1674eac168d.png\" alt=\"image.png\"></p>\n<p>ç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ï¼Œé‚£å¦‚ä½•æ“ä½œæ»¡è¶³éœ€æ±‚å‘¢ï¼Ÿå¦‚æœä½ æœ‰æ›´å¥½çš„ç‰ˆæœ¬æ¬¢è¿è¯„è®ºã€‚</p>\n<p>æˆ‘åªå¥½å¦¥å<code>åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¼•ç”¨</code>ï¼Œé€šè¿‡ jd-gui æŠŠ classæ–‡ä»¶è½¬æ¢æˆ java æ–‡ä»¶ï¼Œä¿®æ”¹å®Œæ¯•ä¹‹åå† javac ç¼–è¯‘æˆ class æ–‡ä»¶ç„¶åè¿è¡Œï¼›å¦‚æœä½ æœ‰å…¶ä»–æ–¹æ³•ï¼Œæ¬¢è¿è¯„è®ºã€‚</p>\n<p>1ã€ä½¿ç”¨ JD-GUI å·¥å…·æ‰“å¼€ class æ–‡ä»¶ï¼Œå¹¶å¯¼å‡ºä¸º java æ–‡ä»¶<br>\n2ã€ä¿®æ”¹å®Œæ¯•ï¼Œé‡æ–°ä½¿ç”¨ javac ç¼–è¯‘</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/9f9269cbfec4b34850bee93a0a6b192d.png\" alt=\"image.png\"></p>\n<h2 id=\"ä¿®æ”¹-for-å¾ªç¯æ¬¡æ•°\">ä¿®æ”¹ for å¾ªç¯æ¬¡æ•°</h2>\n<p><strong>1ã€ç¬¬ä¸€ç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a76f00397b0fce18876026f6829738f5.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/7b81844c00d775820b56c6f0b9ac1961.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconst_&lt;`n`&gt;ï¼š  æŠŠå€¼å‹å…¥æ“ä½œæ•°å †æ ˆ</span><br><span class=\"line\">istore_&lt;`n`&gt;ï¼š  å¼¹å‡ºå¹¶è·å–æ“ä½œæ•°å †æ ˆæ ˆé¡¶é¡¶çš„å€¼ï¼Œå¹¶å°†å…¶å€¼å­˜å‚¨åˆ°æœ¬åœ°å˜é‡</span><br><span class=\"line\">iload_&lt;`n`&gt;ï¼š   ä»æœ¬åœ°å˜é‡è·å–å€¼</span><br><span class=\"line\">if_icmpï¼š       å¦‚æœæ¯”è¾ƒæˆåŠŸåˆ™æ‰§è¡Œåç»­æŒ‡ä»¤</span><br><span class=\"line\">dupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°</span><br><span class=\"line\">iinc `index` by `value`: æŒ‰ç…§ value è‡ªå¢</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è‡ªå¢é‡<code>value</code>æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<p><strong>2ã€ç¬¬äºŒç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/d5b54400c909e17de7eeac8fdbcbec4b.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/67ea8692acc97de294a5fd5624d0496a.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bipushï¼š    å°†å€¼å‹å…¥åˆ°æ“ä½œæ•°å †æ ˆ</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>final int MAX_COUNTï¼ˆbipush çš„å€¼ï¼‰</code>æ¥è·³è¿‡æˆ–å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<p><strong>3ã€ç¬¬ä¸‰ç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/bea551ae82ec1340deb4802f0d2d26a4.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/8c7203dfd3cd59c3eaefcb2c0f867dd3.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">anewarrayï¼š åˆ›å»ºæ•°ç»„å¼•ç”¨</span><br><span class=\"line\">aastoreï¼š   æŠŠå€¼å­˜å‚¨åˆ°æ•°ç»„åˆ—è¡¨ä¸­</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>iinc</code>è‡ªå¢é‡<code>value</code>æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<h1>ä¿®æ”¹ smail æŸä¸ªå˜é‡</h1>\n<p>ä¸Šè¿°ç®—æ˜¯å®ç°äº†å¦‚ä½•ç®€å•ä¿®æ”¹ class æ–‡ä»¶ä¸­çš„æŸä¸ªå¸¸é‡ï¼Œååˆ†ç®€å•ã€‚ä½†æ˜¯å‘¢ï¼Ÿæœ‰æ—¶å€™åç¼–è¯‘ apk æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨ <code>apktool</code> å·¥å…·ï¼Œåç¼–è¯‘å¾—åˆ°çš„æ˜¯ <code>smail</code> ä»£ç ï¼Œéš¾ä¸æˆè¿˜æƒ³æŠŠ <code>smail</code> è½¬æ¢æˆ class å†ä¿®æ”¹ï¼Œå¯éº»çƒ¦äº†ã€‚</p>\n<h2 id=\"ç¯å¢ƒã€å·¥å…·å‡†å¤‡\">ç¯å¢ƒã€å·¥å…·å‡†å¤‡</h2>\n<blockquote>\n<p>å·¥æ¬²å–„å…¶ï¼Œäº‹å¿…å…ˆåˆ©å…¶å™¨</p>\n</blockquote>\n<p>1ã€<a href=\"https://ibotpeaches.github.io/Apktool/\">apktool ä¸‹è½½</a><br>\n2ã€<a href=\"https://github.com/skylot/jadx\">JADX åç¼–è¯‘åˆ©å™¨ä¸‹è½½</a><br>\n3ã€<a href=\"https://code.visualstudio.com/\">VSCode ä¸‹è½½</a><br>\n4ã€<a href=\"https://marketplace.visualstudio.com/items?itemName=ooooonly.smali2java\">VSCode smali2Java æ’ä»¶</a></p>\n<p>åœ¨ vscode ä¸º smali2Java é…ç½® jadx.bat è·¯å¾„ï¼š<code>Decompile failed: The jadx executable path has not been configured</code></p>\n<p><strong>1ã€é…ç½® vscode</strong></p>\n<p>1ã€æ‰¾åˆ° vscode æ’ä»¶é…ç½®æ–‡ä»¶ï¼š<code>C:\\Users\\YTS\\.vscode\\extensions</code>ï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°çš„ smali2java é…ç½®æ˜¯åœ¨ï¼š<code>C:\\Users\\YTS\\.vscode\\extensions\\ooooonly.smali2java-1.0.1\\pachage.json</code></p>\n<p>2ã€æ‰¾åˆ° jadxPathï¼š</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f55e99d21c69e4130e01c16b9f2bb3a3.png\" alt=\"image.png\"></p>\n<p><strong>2ã€è·å¾— smail</strong></p>\n<p>å½“é‡åˆ° dex åç¼–è¯‘é”™è¯¯æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° <code>--only-main-classes</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.1</span>.jar d &lt;apk æ–‡ä»¶&gt; --only-main-classes</span><br><span class=\"line\">````</span><br><span class=\"line\"></span><br><span class=\"line\">![image.png](https:<span class=\"comment\">//img-blog.csdnimg.cn/img_convert/0148a4cc70f2c26b68184431306d67b4.png)</span></span><br><span class=\"line\"></span><br><span class=\"line\">![image.png](https:<span class=\"comment\">//img-blog.csdnimg.cn/img_convert/b1241ca7c38bc50d143ffa67d80c5933.png)</span></span><br><span class=\"line\"></span><br><span class=\"line\">**<span class=\"number\">3</span>ã€ç®€çº¦åˆ†æ**</span><br><span class=\"line\">æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ sayHello() å»¶æ—¶æ‰§è¡Œæ—¶é—´ï¼Œç›®å‰æ˜¯ <span class=\"number\">1000</span> æ¯«ç§’ï¼Œ<span class=\"number\">1000</span> çš„åå…­è¿›åˆ¶æ˜¯ x03e8ï¼ŒsayHello() æ‰€åœ¨ç±»æ˜¯ GameDemoActivityï¼›åœ¨ smail ä»£ç ä¸­æœç´¢ç±»åã€æ–¹æ³•åã€x03e8 ç­‰å¯å®šä½ä»£ç ï¼›å¦‚æœæˆ‘æƒ³ä¿®æ”¹æˆå»¶æ—¶ <span class=\"number\">5000</span> æ¯«ç§’åæ‰§è¡Œï¼Œé‚£æŠŠ <span class=\"number\">5000</span>ï¼ˆx01388ï¼‰ çš„åå…­è¿›åˆ¶æ›¿æ¢æ‰ x03e8 å³å¯ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">```java</span><br><span class=\"line\"><span class=\"keyword\">private</span> Handler mHandle = <span class=\"keyword\">new</span> Handler();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">sayHello</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;invoke sayHello time = &quot;</span> + System.currentTimeMillis());</span><br><span class=\"line\">    mHandle.postDelayed(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;execute sayHello time = &quot;</span> + System.currentTimeMillis());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;ä½ å¥½ï¼Œæ‘é•¿&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">è¾“å‡ºï¼š</span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">14</span>:<span class=\"number\">20.134</span> <span class=\"number\">32431</span>-<span class=\"number\">32431</span>/com.primer.comment I/System.out: invoke sayHello time = <span class=\"number\">1653300860134</span></span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">14</span>:<span class=\"number\">21.135</span> <span class=\"number\">32431</span>-<span class=\"number\">32431</span>/com.primer.comment I/System.out: execute sayHello time = <span class=\"number\">1653300861135</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>smail æºç </p>\n</blockquote>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/c3849a7c84f328e728c7c3ad6b929736.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">21</span>:<span class=\"number\">48.473</span> <span class=\"number\">1333</span>-<span class=\"number\">1333</span>/com.primer.comment I/System.out: invoke sayHello time = <span class=\"number\">1653301308473</span></span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">21</span>:<span class=\"number\">53.478</span> <span class=\"number\">1333</span>-<span class=\"number\">1333</span>/com.primer.comment I/System.out: execute sayHello time = <span class=\"number\">1653301313478</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>æœ€åæ‰“åŒ…ã€ç­¾å</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.1</span>.jar b &lt;æ‰“åŒ…ç›®å½•&gt; </span><br><span class=\"line\"></span><br><span class=\"line\">apksigner sign --ks ****.jks --ks-key-alias &lt;åˆ«å&gt; --out &lt;æ–°ç”Ÿæˆ apk&gt; &lt;å¾…ç­¾å apk&gt;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1>ä» jclasslib è®¤è¯† Hello world</h1>\n<p>é‚£å¹´ï¼Œå†ç†Ÿæ‚‰ä¸è¿‡çš„ Hello worldã€‚</p>\n<p>å¯èƒ½å¾ˆå¤šäººçš„ç¬¬ä¸€ä¸ª java ç¨‹åºéƒ½ä»â€˜ä½ å¥½ä¸–ç•Œâ€™å¼€å§‹ï¼Œä»æ­¤è¸ä¸Šäº†ä¸€æ¡<em><strong>ä¸å½’è·¯</strong></em>ï¼Œå¤šå¹´ä»¥åï¼ˆå¤§æ¦‚æ¯•ä¸šåŠå¹´ï¼‰ï¼Œæˆ‘ä»¥å¦ä¸€ç§æ–¹å¼é‡æ–°è®¤è¯†å®ƒï¼Œè¿™ç§æ–¹å¼å«<strong>å­—èŠ‚ç </strong>ã€‚</p>\n<blockquote>\n<p>Test.java</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> primer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ¯”å¦‚ Test ç±»çš„ç»„æˆï¼š</span></span><br><span class=\"line\"><span class=\"comment\">//ä¸»ç‰ˆæœ¬å· + å¸¸é‡æ±  + è®¿é—®æ ‡è¯† + å½“å‰ç±»ç­¾å + çˆ¶ç±»ç­¾å + æ¥å£é›†åˆ + æ–¹æ³•é›†åˆ + å­—æ®µé›†åˆ + å±æ€§é›†åˆï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//æ–¹æ³•ä¸€ï¼š&lt;init&gt;()V   ã€é»˜è®¤æ„é€ å™¨ã€‘</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ–¹æ³•äºŒï¼šmain([Ljava/lang/String;)V   ã€main æ–¹æ³•ã€V è¡¨ç¤º voidã€L è¡¨ç¤ºæ•°ç»„ã€String å˜æˆç±»çš„å…¨è·¯å¾„ã€‘ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼›String ä½œä¸ºå¯¹è±¡ç»“å°¾å¿…é¡»æ˜¯é€—å·ï¼‰</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//æ¯”å¦‚ main æ–¹æ³•ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†ï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">// ç»„æˆï¼š </span></span><br><span class=\"line\">    <span class=\"comment\">//    - æ–¹æ³•å + æ–¹æ³•ç­¾å + è®¿é—®æ ‡è¯†ï¼ˆmain + ([Ljava/lang/String;)V + public staticï¼‰</span></span><br><span class=\"line\">    <span class=\"comment\">//    - å¼‚å¸¸è¡¨</span></span><br><span class=\"line\">    <span class=\"comment\">//    - å­—èŠ‚ç ã€æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‘</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Hello World&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>javac Test.java</code> ç¼–è¯‘å¾—åˆ° Test.class å­—èŠ‚ç æ–‡ä»¶</p>\n</blockquote>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/6fd777b8a85ec867a59fdb307082595b.png\" alt=\"image.png\"></p>\n<p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>java &lt;ç±»å…¨è·¯å¾„&gt;</code> ç›´æ¥è¿è¡ŒæŸ¥çœ‹æ•ˆæœï¼Œç±»å…¨è·¯å¾„ï¼šåŒ…å + ç±»å</p>\n<p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p>\n<p>Test å¯åŠ¨ç±»çš„åŒ…åæ˜¯ <code>package primer</code>ï¼Œæˆ‘æœ¬åœ°ç›®å½•æ˜¯<code>primer/primer/Test.class</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec87c8988833fd4f5d34a8f9edb76d8c.png\" alt=\"image.png\"></p>\n<p>1ã€åœ¨ class æ‰€åœ¨ç›®å½•ä¸‹è¿è¡Œ âŒ</p>\n<p>å¦‚æœä½ åœ¨ Test.class åŒçº§ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤è¿è¡Œï¼Œå¯æƒœæŠ¥é”™äº†ï¼Œå¤§æ¦‚æ„æ€æ˜¯ä½ çš„ Test ç±»å…¨è·¯å¾„ä¸å¯¹ï¼Œå½“å­˜åœ¨ä¸»ç±»å­˜åœ¨åŒ…åæ—¶ï¼Œä¸èƒ½åœ¨å½“å‰ class æ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦åœ¨åŒ…åæ‰€åœ¨ç›®å½•æ‰§è¡Œï¼Œå¦åˆ™æŠ¥é”™ï¼Œjava å‘½ä»¤è®¤ä¸ºåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾<em><strong>åŒ…åè·¯å¾„</strong></em>ï¼Œå¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ ¹æ®åŒ…åå¾€ä¸‹æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»ç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/421255941965168858b22ae04aebe4d6.png\" alt=\"image.png\"></p>\n<p>å‰é¢æåˆ°ï¼Œç›´æ¥æ‰§è¡Œå­—èŠ‚ç æ˜¯è¿™æ · <strong><code>java &lt;ç±»å…¨è·¯å¾„&gt;</code></strong>ï¼Œå…¨è·¯å¾„æ˜¯è¦åŒ…å«åŒ…ååœ¨å†…ï¼Œæ¯”å¦‚ <code>com.tencent.mmkv.MMKV</code>ï¼Œå¦‚æœ MMKV ç±»æœ‰æ‰§è¡Œå…¥å£ï¼Œæƒ³è¦é€šè¿‡ java å‘½ä»¤æ‰§è¡Œå®ƒå¿…é¡»ç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚**JVM åœ¨åŠ è½½ç±»è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•ç¡®å®šå”¯ä¸€ä¸ªç±»çš„ï¼Ÿ**æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªç±»åç›¸åŒä½†åŒ…åï¼ˆå…¨è·¯å¾„ï¼‰ä¸åŒçš„ Test ç±»ï¼ŒJVM é€šè¿‡<code>åŒ…åé™å®šç¬¦ + æ˜¯å¦åŒä¸€ä¸ªè™šæ‹Ÿæœº</code>å”¯ä¸€ç¡®å®šä¸€ä¸ªç±»ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œçš„ç¨‹åºåªæœ‰ä¸€ä¸ªè™šæ‹Ÿæœºï¼‰</p>\n<p>2ã€åœ¨ class å¯åŠ¨ç±»æœ€å¤–å±‚åŒ…åçš„ä¸Šä¸€å±‚ç›®å½•è¿è¡Œ â˜‘ï¸</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/ec6fbd643ecb13cd555200dc4ab5fbd2.png\" alt=\"image.png\"></p>\n<h2 id=\"é‚‚é€…çš„-jclasslib\">é‚‚é€…çš„ jclasslib</h2>\n<p>è¿™é‡Œå¼€å§‹æ¶‰åŠåˆ°å…·ä½“çš„ JVM æŒ‡ä»¤ï¼Œå…ˆå¥‰ä¸Šå®˜æ–¹æ–‡æ¡£ <a href=\"https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.getstatic\">ORACLE - JVM æŒ‡ä»¤é›† </a>ï¼Œå…¨éƒ¨æŒ‡ä»¤è®°ä½ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²ï¼Œé€šå¸¸æ˜¯ç”¨æ—¶æŸ¥é˜…ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼›å¯¹äº jclasslib å·¥å…·å¯ä»¥å³å‡»è·³è½¬åˆ°å®˜æ–¹æ–‡æ¡£ç‰¹å®šæŒ‡ä»¤ä½ç½®<code>show JVM spec</code>ã€‚ä»¥ä¸Šé¢çš„<code>Hello World</code>ä¸ºä¾‹å­è¿›è¡Œæ“ä½œã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/160147efe7c8029f9f254df0e0d853e1.png\" alt=\"image.png\"></p>\n<p><strong>1ã€ä¿®æ”¹å­—ç¬¦ä¸²å¸¸é‡</strong></p>\n<p>å…ˆçœ‹ main æ–¹æ³•çš„ java ä»£ç ï¼Œè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ˜¯ <code>Hello World</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/cceaaf6bd80b26ff3667900fc47cb4cc.png\" alt=\"image.png\"></p>\n<p>å†çœ‹ main æ–¹æ³•çš„ class å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ javap å‘½ä»¤æŸ¥çœ‹å­—èŠ‚ç </p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/34699591dd1e5ae793d6b15d803951c0.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">getstaticï¼š     è·å–é™æ€å­—æ®µ outï¼ˆSystem ç±»ä¸­çš„ out å£°æ˜æ˜¯ `<span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> PrintStream out = <span class=\"keyword\">null</span>;`ï¼‰</span><br><span class=\"line\">ldcï¼š           ä»å¸¸é‡æ± ä¸­è·å–å€¼å¹¶å‹å…¥æ“ä½œæ•°æ ˆï¼ˆæ­¤å¤„å¸¸é‡æ˜¯ `Hello World`ï¼‰</span><br><span class=\"line\">invokevirtualï¼š ç±»çº§åˆ«çš„æ–¹æ³•è°ƒç”¨ï¼ˆå¯ä»¥æ˜¯é€šè¿‡ç±»åè°ƒç”¨æ–¹æ³• `System.out.println()`ï¼‰</span><br><span class=\"line\"><span class=\"keyword\">new</span>ï¼š           åˆ›å»º Hello ç±»çš„å®ä¾‹</span><br><span class=\"line\">dupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°</span><br><span class=\"line\">invokespecialï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br><span class=\"line\">astore_1ï¼š      æŠŠåˆ›å»ºçš„ Hello å¯¹è±¡å­˜å‚¨åˆ° hello æœ¬åœ°å˜é‡</span><br><span class=\"line\">aload_1ï¼š       åŠ è½½ hello æœ¬åœ°å˜é‡çš„å¯¹è±¡</span><br><span class=\"line\">invokevirtualï¼š è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br><span class=\"line\"><span class=\"keyword\">return</span>ï¼š        æ–¹æ³•é€€å‡º</span><br></pre></td></tr></table></figure>\n<p>åœ¨å·¥å…·ä¸Šå¯¹å­—èŠ‚ç ç›´æ¥è¿›è¡Œä¿®æ”¹<code>ldc</code>è¯»å–çš„å¸¸é‡å€¼ï¼Œä¿å­˜å¹¶é‡æ–°ç¼–è¯‘è¿è¡Œï¼ˆæˆ‘åœ¨æƒ³ä¸€ä¸ªç–‘æƒ‘ï¼šæˆ‘ä¿®æ”¹çš„å­—ç¬¦ä¸²ä¹‹å‰åœ¨å¸¸é‡æ± ä¸­æ²¡æœ‰ï¼Œæ˜¯å¦åœ¨æˆ‘ä¿®æ”¹å¹¶ä¿å­˜åä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²çº³å…¥å¸¸é‡æ± ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/76d48e2e9a414d6ec3651e6550891099.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/61b1f79282b2c1a44d998b702f129ae1.png\" alt=\"image.png\"></p>\n<h1>è·³è·³è™ï¼šç°åœ¨ä¸€èµ·æƒ³æƒ³æƒ³</h1>\n<p>åœ¨æˆ‘ä»¬çš„è®°å¿†ä¸­ï¼Œå­—é¢é‡ç›¸åŒçš„å­—ç¬¦ä¸²å¸¸é‡åœ¨å¸¸é‡æ± ä¸­æ˜¯ä»…å­˜ä¸€ä»½ã€‚å¦‚ä¸‹ä»£ç <code>&quot;å¼ ä¸‰&quot;</code>å­—ç¬¦ä¸²åœ¨å¸¸é‡æ± ä¸­æœ‰ä¸”åªæœ‰ä¸€ä»½ï¼Œä½†æ˜¯ç¨‹åºä¸­å¤šå¤„å¼•ç”¨ï¼Œç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸­çš„å€¼é‚£ä¹ˆè¿™ä¸¤ä¸ªè¾“å‡ºçš„éƒ½ä¼šæ”¹å˜äº†ï¼Œæˆ‘å¸Œæœ›åªæ”¹å˜<code>name</code>çš„è¾“å‡ºï¼Œä¿æŒåŸå…ˆ<code>aliasName</code>çš„å€¼ã€‚</p>\n<p>ç›´æ¥ä¿®æ”¹å¸¸é‡æ± ï¼Œç¡®å®ä¸¤ä¸ªéƒ½å—å½±å“ï¼Œä¸ç¬¦åˆæœŸæœ›</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a49ef4afa4cd0c272c09965ce5d0d947.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/1ca7b5055306fd77c67fd1674eac168d.png\" alt=\"image.png\"></p>\n<p>ç›´æ¥ä¿®æ”¹å¸¸é‡æ± ä¸ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ï¼Œé‚£å¦‚ä½•æ“ä½œæ»¡è¶³éœ€æ±‚å‘¢ï¼Ÿå¦‚æœä½ æœ‰æ›´å¥½çš„ç‰ˆæœ¬æ¬¢è¿è¯„è®ºã€‚</p>\n<p>æˆ‘åªå¥½å¦¥å<code>åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¼•ç”¨</code>ï¼Œé€šè¿‡ jd-gui æŠŠ classæ–‡ä»¶è½¬æ¢æˆ java æ–‡ä»¶ï¼Œä¿®æ”¹å®Œæ¯•ä¹‹åå† javac ç¼–è¯‘æˆ class æ–‡ä»¶ç„¶åè¿è¡Œï¼›å¦‚æœä½ æœ‰å…¶ä»–æ–¹æ³•ï¼Œæ¬¢è¿è¯„è®ºã€‚</p>\n<p>1ã€ä½¿ç”¨ JD-GUI å·¥å…·æ‰“å¼€ class æ–‡ä»¶ï¼Œå¹¶å¯¼å‡ºä¸º java æ–‡ä»¶<br>\n2ã€ä¿®æ”¹å®Œæ¯•ï¼Œé‡æ–°ä½¿ç”¨ javac ç¼–è¯‘</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/9f9269cbfec4b34850bee93a0a6b192d.png\" alt=\"image.png\"></p>\n<h2 id=\"ä¿®æ”¹-for-å¾ªç¯æ¬¡æ•°\">ä¿®æ”¹ for å¾ªç¯æ¬¡æ•°</h2>\n<p><strong>1ã€ç¬¬ä¸€ç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/a76f00397b0fce18876026f6829738f5.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/7b81844c00d775820b56c6f0b9ac1961.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconst_&lt;`n`&gt;ï¼š  æŠŠå€¼å‹å…¥æ“ä½œæ•°å †æ ˆ</span><br><span class=\"line\">istore_&lt;`n`&gt;ï¼š  å¼¹å‡ºå¹¶è·å–æ“ä½œæ•°å †æ ˆæ ˆé¡¶é¡¶çš„å€¼ï¼Œå¹¶å°†å…¶å€¼å­˜å‚¨åˆ°æœ¬åœ°å˜é‡</span><br><span class=\"line\">iload_&lt;`n`&gt;ï¼š   ä»æœ¬åœ°å˜é‡è·å–å€¼</span><br><span class=\"line\">if_icmpï¼š       å¦‚æœæ¯”è¾ƒæˆåŠŸåˆ™æ‰§è¡Œåç»­æŒ‡ä»¤</span><br><span class=\"line\">dupï¼š           å¤åˆ¶æ ˆé¡¶æ“ä½œæ•°</span><br><span class=\"line\">iinc `index` by `value`: æŒ‰ç…§ value è‡ªå¢</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è‡ªå¢é‡<code>value</code>æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<p><strong>2ã€ç¬¬äºŒç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/d5b54400c909e17de7eeac8fdbcbec4b.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/67ea8692acc97de294a5fd5624d0496a.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bipushï¼š    å°†å€¼å‹å…¥åˆ°æ“ä½œæ•°å †æ ˆ</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>final int MAX_COUNTï¼ˆbipush çš„å€¼ï¼‰</code>æ¥è·³è¿‡æˆ–å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<p><strong>3ã€ç¬¬ä¸‰ç§ç±»å‹çš„ for å¾ªç¯</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/bea551ae82ec1340deb4802f0d2d26a4.png\" alt=\"image.png\"></p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/8c7203dfd3cd59c3eaefcb2c0f867dd3.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">anewarrayï¼š åˆ›å»ºæ•°ç»„å¼•ç”¨</span><br><span class=\"line\">aastoreï¼š   æŠŠå€¼å­˜å‚¨åˆ°æ•°ç»„åˆ—è¡¨ä¸­</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºæ­¤ç§æ–¹å¼çš„ for å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>iinc</code>è‡ªå¢é‡<code>value</code>æ¥å‡å°‘å¾ªç¯æ‰§è¡Œæ¬¡æ•°</p>\n<h1>ä¿®æ”¹ smail æŸä¸ªå˜é‡</h1>\n<p>ä¸Šè¿°ç®—æ˜¯å®ç°äº†å¦‚ä½•ç®€å•ä¿®æ”¹ class æ–‡ä»¶ä¸­çš„æŸä¸ªå¸¸é‡ï¼Œååˆ†ç®€å•ã€‚ä½†æ˜¯å‘¢ï¼Ÿæœ‰æ—¶å€™åç¼–è¯‘ apk æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨ <code>apktool</code> å·¥å…·ï¼Œåç¼–è¯‘å¾—åˆ°çš„æ˜¯ <code>smail</code> ä»£ç ï¼Œéš¾ä¸æˆè¿˜æƒ³æŠŠ <code>smail</code> è½¬æ¢æˆ class å†ä¿®æ”¹ï¼Œå¯éº»çƒ¦äº†ã€‚</p>\n<h2 id=\"ç¯å¢ƒã€å·¥å…·å‡†å¤‡\">ç¯å¢ƒã€å·¥å…·å‡†å¤‡</h2>\n<blockquote>\n<p>å·¥æ¬²å–„å…¶ï¼Œäº‹å¿…å…ˆåˆ©å…¶å™¨</p>\n</blockquote>\n<p>1ã€<a href=\"https://ibotpeaches.github.io/Apktool/\">apktool ä¸‹è½½</a><br>\n2ã€<a href=\"https://github.com/skylot/jadx\">JADX åç¼–è¯‘åˆ©å™¨ä¸‹è½½</a><br>\n3ã€<a href=\"https://code.visualstudio.com/\">VSCode ä¸‹è½½</a><br>\n4ã€<a href=\"https://marketplace.visualstudio.com/items?itemName=ooooonly.smali2java\">VSCode smali2Java æ’ä»¶</a></p>\n<p>åœ¨ vscode ä¸º smali2Java é…ç½® jadx.bat è·¯å¾„ï¼š<code>Decompile failed: The jadx executable path has not been configured</code></p>\n<p><strong>1ã€é…ç½® vscode</strong></p>\n<p>1ã€æ‰¾åˆ° vscode æ’ä»¶é…ç½®æ–‡ä»¶ï¼š<code>C:\\Users\\YTS\\.vscode\\extensions</code>ï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°çš„ smali2java é…ç½®æ˜¯åœ¨ï¼š<code>C:\\Users\\YTS\\.vscode\\extensions\\ooooonly.smali2java-1.0.1\\pachage.json</code></p>\n<p>2ã€æ‰¾åˆ° jadxPathï¼š</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f55e99d21c69e4130e01c16b9f2bb3a3.png\" alt=\"image.png\"></p>\n<p><strong>2ã€è·å¾— smail</strong></p>\n<p>å½“é‡åˆ° dex åç¼–è¯‘é”™è¯¯æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° <code>--only-main-classes</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.1</span>.jar d &lt;apk æ–‡ä»¶&gt; --only-main-classes</span><br><span class=\"line\">````</span><br><span class=\"line\"></span><br><span class=\"line\">![image.png](https:<span class=\"comment\">//img-blog.csdnimg.cn/img_convert/0148a4cc70f2c26b68184431306d67b4.png)</span></span><br><span class=\"line\"></span><br><span class=\"line\">![image.png](https:<span class=\"comment\">//img-blog.csdnimg.cn/img_convert/b1241ca7c38bc50d143ffa67d80c5933.png)</span></span><br><span class=\"line\"></span><br><span class=\"line\">**<span class=\"number\">3</span>ã€ç®€çº¦åˆ†æ**</span><br><span class=\"line\">æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ sayHello() å»¶æ—¶æ‰§è¡Œæ—¶é—´ï¼Œç›®å‰æ˜¯ <span class=\"number\">1000</span> æ¯«ç§’ï¼Œ<span class=\"number\">1000</span> çš„åå…­è¿›åˆ¶æ˜¯ x03e8ï¼ŒsayHello() æ‰€åœ¨ç±»æ˜¯ GameDemoActivityï¼›åœ¨ smail ä»£ç ä¸­æœç´¢ç±»åã€æ–¹æ³•åã€x03e8 ç­‰å¯å®šä½ä»£ç ï¼›å¦‚æœæˆ‘æƒ³ä¿®æ”¹æˆå»¶æ—¶ <span class=\"number\">5000</span> æ¯«ç§’åæ‰§è¡Œï¼Œé‚£æŠŠ <span class=\"number\">5000</span>ï¼ˆx01388ï¼‰ çš„åå…­è¿›åˆ¶æ›¿æ¢æ‰ x03e8 å³å¯ã€‚</span><br><span class=\"line\"></span><br><span class=\"line\">```java</span><br><span class=\"line\"><span class=\"keyword\">private</span> Handler mHandle = <span class=\"keyword\">new</span> Handler();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">sayHello</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;invoke sayHello time = &quot;</span> + System.currentTimeMillis());</span><br><span class=\"line\">    mHandle.postDelayed(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;execute sayHello time = &quot;</span> + System.currentTimeMillis());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;ä½ å¥½ï¼Œæ‘é•¿&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">è¾“å‡ºï¼š</span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">14</span>:<span class=\"number\">20.134</span> <span class=\"number\">32431</span>-<span class=\"number\">32431</span>/com.primer.comment I/System.out: invoke sayHello time = <span class=\"number\">1653300860134</span></span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">14</span>:<span class=\"number\">21.135</span> <span class=\"number\">32431</span>-<span class=\"number\">32431</span>/com.primer.comment I/System.out: execute sayHello time = <span class=\"number\">1653300861135</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>smail æºç </p>\n</blockquote>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/c3849a7c84f328e728c7c3ad6b929736.png\" alt=\"image.png\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">21</span>:<span class=\"number\">48.473</span> <span class=\"number\">1333</span>-<span class=\"number\">1333</span>/com.primer.comment I/System.out: invoke sayHello time = <span class=\"number\">1653301308473</span></span><br><span class=\"line\"><span class=\"number\">2022</span>-<span class=\"number\">05</span>-<span class=\"number\">23</span> <span class=\"number\">18</span>:<span class=\"number\">21</span>:<span class=\"number\">53.478</span> <span class=\"number\">1333</span>-<span class=\"number\">1333</span>/com.primer.comment I/System.out: execute sayHello time = <span class=\"number\">1653301313478</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>æœ€åæ‰“åŒ…ã€ç­¾å</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.1</span>.jar b &lt;æ‰“åŒ…ç›®å½•&gt; </span><br><span class=\"line\"></span><br><span class=\"line\">apksigner sign --ks ****.jks --ks-key-alias &lt;åˆ«å&gt; --out &lt;æ–°ç”Ÿæˆ apk&gt; &lt;å¾…ç­¾å apk&gt;</span><br></pre></td></tr></table></figure>\n"},{"title":"Android æºç ä¹‹ç­¾å Apksign","catalog":true,"date":"2022-10-10T13:40:18.000Z","subtitle":"åº”ç”¨ç­¾å V1ã€V2ã€V3ã€V4","header-img":"/img/220928/wuaipojie.jpeg","sticky":10,"_content":"\n# é¢„å¤‡çŸ¥è¯†\n- apksigï¼šç­¾åæºç å·¥ç¨‹\n- apksignerï¼šå‘½ä»¤è¡Œç­¾åå·¥å…·\n- ç­¾å SchemeSignerï¼ŒéªŒè¯ SchemeVerifier\n- ç­¾åç±»å‹ï¼šV1ï½V4\n- ç­¾åç®—æ³•ï¼š\n\n# é”™è¯¯å¤„ç†\n- å‹ç¼©æ–‡ä»¶æ ¼å¼å¼‚å¸¸ï¼ˆå®‰è£…åŒ…æœ¬æ¥å°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼‰\n- å®‰è£…åŒ…æ ¼å¼å¼‚å¸¸\n- æ²¡æœ‰æ‰¾åˆ°å®‰è£…åŒ…ç­¾åå—å¼‚å¸¸\n- ç­¾åèƒ½å¤Ÿæ”¯æŒçš„æœ€å° Android ç‰ˆæœ¬å¼‚å¸¸\n\n# å®‰è£…åŒ…ç»“æ„\n","source":"_posts/undefined/å¾çˆ±ç ´è§£.md","raw":"---\ntitle: Android æºç ä¹‹ç­¾å Apksign\ncatalog: true\ndate: 2022-10-10 21:40:18\nsubtitle: åº”ç”¨ç­¾å V1ã€V2ã€V3ã€V4\nheader-img: /img/220928/wuaipojie.jpeg\ntags: AOSP\ncategories:\nsticky: 10\n---\n\n# é¢„å¤‡çŸ¥è¯†\n- apksigï¼šç­¾åæºç å·¥ç¨‹\n- apksignerï¼šå‘½ä»¤è¡Œç­¾åå·¥å…·\n- ç­¾å SchemeSignerï¼ŒéªŒè¯ SchemeVerifier\n- ç­¾åç±»å‹ï¼šV1ï½V4\n- ç­¾åç®—æ³•ï¼š\n\n# é”™è¯¯å¤„ç†\n- å‹ç¼©æ–‡ä»¶æ ¼å¼å¼‚å¸¸ï¼ˆå®‰è£…åŒ…æœ¬æ¥å°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼‰\n- å®‰è£…åŒ…æ ¼å¼å¼‚å¸¸\n- æ²¡æœ‰æ‰¾åˆ°å®‰è£…åŒ…ç­¾åå—å¼‚å¸¸\n- ç­¾åèƒ½å¤Ÿæ”¯æŒçš„æœ€å° Android ç‰ˆæœ¬å¼‚å¸¸\n\n# å®‰è£…åŒ…ç»“æ„\n","slug":"å¾çˆ±ç ´è§£","published":1,"lang":"undefined","updated":"2022-10-10T13:40:18.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsr000igaqpaa094qj1","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>é¢„å¤‡çŸ¥è¯†</h1>\n<ul>\n<li>apksigï¼šç­¾åæºç å·¥ç¨‹</li>\n<li>apksignerï¼šå‘½ä»¤è¡Œç­¾åå·¥å…·</li>\n<li>ç­¾å SchemeSignerï¼ŒéªŒè¯ SchemeVerifier</li>\n<li>ç­¾åç±»å‹ï¼šV1ï½V4</li>\n<li>ç­¾åç®—æ³•ï¼š</li>\n</ul>\n<h1>é”™è¯¯å¤„ç†</h1>\n<ul>\n<li>å‹ç¼©æ–‡ä»¶æ ¼å¼å¼‚å¸¸ï¼ˆå®‰è£…åŒ…æœ¬æ¥å°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼‰</li>\n<li>å®‰è£…åŒ…æ ¼å¼å¼‚å¸¸</li>\n<li>æ²¡æœ‰æ‰¾åˆ°å®‰è£…åŒ…ç­¾åå—å¼‚å¸¸</li>\n<li>ç­¾åèƒ½å¤Ÿæ”¯æŒçš„æœ€å° Android ç‰ˆæœ¬å¼‚å¸¸</li>\n</ul>\n<h1>å®‰è£…åŒ…ç»“æ„</h1>\n","site":{"data":{}},"excerpt":"","more":"<h1>é¢„å¤‡çŸ¥è¯†</h1>\n<ul>\n<li>apksigï¼šç­¾åæºç å·¥ç¨‹</li>\n<li>apksignerï¼šå‘½ä»¤è¡Œç­¾åå·¥å…·</li>\n<li>ç­¾å SchemeSignerï¼ŒéªŒè¯ SchemeVerifier</li>\n<li>ç­¾åç±»å‹ï¼šV1ï½V4</li>\n<li>ç­¾åç®—æ³•ï¼š</li>\n</ul>\n<h1>é”™è¯¯å¤„ç†</h1>\n<ul>\n<li>å‹ç¼©æ–‡ä»¶æ ¼å¼å¼‚å¸¸ï¼ˆå®‰è£…åŒ…æœ¬æ¥å°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼‰</li>\n<li>å®‰è£…åŒ…æ ¼å¼å¼‚å¸¸</li>\n<li>æ²¡æœ‰æ‰¾åˆ°å®‰è£…åŒ…ç­¾åå—å¼‚å¸¸</li>\n<li>ç­¾åèƒ½å¤Ÿæ”¯æŒçš„æœ€å° Android ç‰ˆæœ¬å¼‚å¸¸</li>\n</ul>\n<h1>å®‰è£…åŒ…ç»“æ„</h1>\n"},{"title":"æˆ‘çš„å•è¯æœ¬","catalog":true,"date":"2022-10-15T05:08:46.000Z","subtitle":"è®²çœŸï¼Œæˆ‘è®¤è¯†ä¸€ä¸ªäººï¼Œå¥¹æ¯å¤©éƒ½ä¼šå­¦ä¹ ã€å·©å›ºå•è¯","header-img":"/img/2210/mine-englishbook.jpg","_content":"\n# è®¡ç®—æœºä¸“ä¸š\n\n> ç¼–ç¨‹å…¥é—¨é‚£ä¼šï¼Œæˆ‘ä»¬å¯èƒ½éƒ½æœ‰è¿‡è¿™ä¸ªç–‘æƒ‘ï¼šå­¦ä¹ ç¼–ç¨‹å¯¹è‹±æ–‡æ°´å¹³æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿä¸€å®šè¦è‹±è¯­å¾ˆå¥½å—ï¼Ÿä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¤šå¤šç›Šå–„\n\n- sinksï¼šè¾“å…¥å™¨\n- sinkï¼šä¸‹æ²‰ã€è¾“å…¥\n- utilityï¼šå®ç”¨ç¨‹åº\n- stampï¼šç±»å‹\n- akaï¼šäº¦ç§°ã€åˆå","source":"_posts/undefined/æˆ‘çš„å•è¯æœ¬.md","raw":"---\ntitle: æˆ‘çš„å•è¯æœ¬\ncatalog: true\ndate: 2022-10-15 13:08:46\nsubtitle: è®²çœŸï¼Œæˆ‘è®¤è¯†ä¸€ä¸ªäººï¼Œå¥¹æ¯å¤©éƒ½ä¼šå­¦ä¹ ã€å·©å›ºå•è¯\nheader-img: /img/2210/mine-englishbook.jpg\ntags: å·¥å…·\ncategories:\n---\n\n# è®¡ç®—æœºä¸“ä¸š\n\n> ç¼–ç¨‹å…¥é—¨é‚£ä¼šï¼Œæˆ‘ä»¬å¯èƒ½éƒ½æœ‰è¿‡è¿™ä¸ªç–‘æƒ‘ï¼šå­¦ä¹ ç¼–ç¨‹å¯¹è‹±æ–‡æ°´å¹³æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿä¸€å®šè¦è‹±è¯­å¾ˆå¥½å—ï¼Ÿä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¤šå¤šç›Šå–„\n\n- sinksï¼šè¾“å…¥å™¨\n- sinkï¼šä¸‹æ²‰ã€è¾“å…¥\n- utilityï¼šå®ç”¨ç¨‹åº\n- stampï¼šç±»å‹\n- akaï¼šäº¦ç§°ã€åˆå","slug":"æˆ‘çš„å•è¯æœ¬","published":1,"lang":"undefined","updated":"2022-10-15T05:08:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignss000lgaqpfz0scezr","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>è®¡ç®—æœºä¸“ä¸š</h1>\n<blockquote>\n<p>ç¼–ç¨‹å…¥é—¨é‚£ä¼šï¼Œæˆ‘ä»¬å¯èƒ½éƒ½æœ‰è¿‡è¿™ä¸ªç–‘æƒ‘ï¼šå­¦ä¹ ç¼–ç¨‹å¯¹è‹±æ–‡æ°´å¹³æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿä¸€å®šè¦è‹±è¯­å¾ˆå¥½å—ï¼Ÿä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¤šå¤šç›Šå–„</p>\n</blockquote>\n<ul>\n<li>sinksï¼šè¾“å…¥å™¨</li>\n<li>sinkï¼šä¸‹æ²‰ã€è¾“å…¥</li>\n<li>utilityï¼šå®ç”¨ç¨‹åº</li>\n<li>stampï¼šç±»å‹</li>\n<li>akaï¼šäº¦ç§°ã€åˆå</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>è®¡ç®—æœºä¸“ä¸š</h1>\n<blockquote>\n<p>ç¼–ç¨‹å…¥é—¨é‚£ä¼šï¼Œæˆ‘ä»¬å¯èƒ½éƒ½æœ‰è¿‡è¿™ä¸ªç–‘æƒ‘ï¼šå­¦ä¹ ç¼–ç¨‹å¯¹è‹±æ–‡æ°´å¹³æœ‰ä»€ä¹ˆè¦æ±‚ï¼Ÿä¸€å®šè¦è‹±è¯­å¾ˆå¥½å—ï¼Ÿä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¤šå¤šç›Šå–„</p>\n</blockquote>\n<ul>\n<li>sinksï¼šè¾“å…¥å™¨</li>\n<li>sinkï¼šä¸‹æ²‰ã€è¾“å…¥</li>\n<li>utilityï¼šå®ç”¨ç¨‹åº</li>\n<li>stampï¼šç±»å‹</li>\n<li>akaï¼šäº¦ç§°ã€åˆå</li>\n</ul>\n"},{"title":"ä» smail æ¥å…¥ç¬¬ä¸‰æ–¹ SDK","catalog":true,"date":"2022-09-26T12:56:19.000Z","subtitle":"æœ‰æ—¶é€šè¿‡æŸ¥çœ‹ã€ä¿®æ”¹ç¬¬ä¸‰æ–¹åº“èƒ½æ›´å¥½è§£å†³é—®é¢˜","header-img":"/img/220926_smailsdk/smail_bg.webp","sticky":3,"_content":"\n# é‡åˆ°è¿‡è¿™ç§åœºæ™¯å—\n\nä»€ä¹ˆæ—¶å€™è¦åˆ©ç”¨ smali è¯­è¨€å±‚é¢æ¥å…¥ç¬¬ä¸‰æ–¹ sdk ï¼Ÿä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ java æ¥å£ï¼Œä¸€ç›®äº†ç„¶ï¼Œæä¸ª smali ä¸æ˜¯æ²¡äº‹æ‰¾äº‹ï¼Ÿåœºæ™¯ä¸åŒï¼Œåœ¨æ²¡æœ‰åŠæ³•çš„æ—¶å€™è¿™å°±æ˜¯ä¸€ç§æ–¹æ³•ã€‚\n\nprogramer Aï¼š   å‘ä½ ä¸€ä¸ª apk æ–‡ä»¶ï¼Œå¸®æˆ‘çœ‹ä¸‹\nprogramer Aï¼š   å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŸå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª APKï¼Œæˆ‘æƒ³æŠŠå’‹ä»¬çš„ sdk æ¥å…¥åˆ°é‡Œé¢ï¼Œæ€ä¹ˆæï¼Ÿ\nprogramer Bï¼š   åº”è¯¥å¯ä»¥ï¼Œå¯ä»¥è¯•è¯•ä»¥å­—èŠ‚ç ã€smail å½¢å¼æ¥å…¥\nprogramer Aï¼š   smail ï¼Ÿè¿™æ˜¯å•¥å•Šï¼\nprogramer Bï¼š   è‡ªå·±æŸ¥èµ„æ–™ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\n\n\n**å—¯ï¼Ÿæ²¡æœ‰æ€è·¯ï¼Œä¸ç„¶å†™ä¸ª Demo çœ‹çœ‹å§**\n\n1ã€å‡†å¤‡ä¸€ä¸ª sdk: `gcsdk-1.0.0.jar`\n2ã€å‡†å¤‡ä¸€ä¸ª apk: `app-0.apk`ï¼ˆå‡è®¾æ˜¯æˆ‘ä»¬çš„åº”ç”¨ï¼‰\n3ã€åˆ›å»ºä¸€ä¸ªç©ºç™½ Android é¡¹ç›®ï¼Œé¢„å¤‡æ¥å…¥ sdk: `app-1.apk`ï¼ˆå¤‡ç”¨ï¼‰ \n\næ¨¡æ‹Ÿå‡ ä¸ªå¯¹å¤–çš„æ¥å£ç®€å•ç”Ÿæˆä¸€ä¸ª jarï¼Œå®é™…ä¸­æ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ¥å£ä¹Ÿä¸ä¼šå¾ˆå¤æ‚ã€‚\n\n---\n\n> gcsdk-1.0.0ï¼ˆç¤ºä¾‹ï¼‰ \n\n```java\n// åˆå§‹åŒ–\nGCSDK.getInstance().init(new InitCallback() {\n            @Override\n            public void initSuccess() {\n                System.out.println(\"gcsdk-åˆå§‹åŒ–æˆåŠŸ\");\n            }\n            @Override\n            public void initFail(int code, String error) {\n                System.out.println(\"gcsdk-åˆå§‹åŒ–å¤±è´¥ï¼šcode = \" + code + \"  error = \" + error);\n            }\n});\n\n//ç™»å½•\nGCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                System.out.println(\"ç™»å½•-æˆåŠŸ\");\n            }\n            @Override\n            public void inLoginFail(int code, String error) {\n                System.out.println(\"ç™»å½•-å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n});\n\n//å¹¿å‘Š        \nAdParams adParams = new AdParams();\nGCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                System.out.println(\"å¹¿å‘Š-ç‚¹å‡»\");\n            }\n            @Override\n            public void onClickSkip() {\n                System.out.println(\"å¹¿å‘Š-ç‚¹å‡»è·³è¿‡\");\n            }\n            @Override\n            public void onClose() {\n                System.out.println(\"å¹¿å‘Š-å…³é—­\");\n            }\n            @Override\n            public void onOpenFaild(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-æ‰“å¼€å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n            @Override\n            public void onOpenSuccess() {\n                System.out.println(\"å¹¿å‘Š-æ‰“å¼€æˆåŠŸ\");\n            }\n            @Override\n            public void onLoadBegin() {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å¼€å§‹\");\n            }\n            @Override\n            public void onLoadFaild(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n            @Override\n            public void onLoadComplete() {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å®Œæˆ\");\n            }\n            @Override\n            public void onDownloadBegin() {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å¼€å§‹\");\n            }\n            @Override\n            public void onDownloadFail(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å¤±è´¥ï¼šcode =\" + code + \" error = \" + error);\n            }\n\n            @Override\n            public void onDownloadComplete() {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å®Œæˆ\");\n            }\n});\n\n//æ”¯ä»˜\nPayParams payParams = new PayParams();\nPayManager.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                System.out.println(\"æ”¯ä»˜-æˆåŠŸ\");\n            }\n            @Override\n            public void onPayFail(int code, String error) {\n                System.out.println(\"æ”¯ä»˜-å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n});\n```\n\n> ç©ºç™½ Android é¡¹ç›®ï¼Œæ¨¡æ‹Ÿæ¥å…¥ gcsdkï¼Œæ¥å…¥å®Œæˆåæ‰“åŒ…å¤‡ç”¨ï¼Œç”Ÿæˆçš„ apk ç”¨äºè·å– smali ä»£ç \n\n```java\n// App.java\npackage com.example.gcsdkdemo;\nimport android.app.Application;\nimport android.util.Log;\nimport com.primer.jsonlili.callback.InitCallback;\nimport com.primer.jsonlili.core.GCSDK;\n\npublic class App extends Application {\n    private final String TAG = \"cunzhang\";\n    //åˆå§‹åŒ–å›è°ƒ\n    private InitCallback mInitCallback = new InitCallback() {\n        @Override\n        public void initSuccess() {\n            Log.d(TAG, \"initSuccess: \");\n        }\n\n        @Override\n        public void initFail(int i, String s) {\n            Log.d(TAG, \"initFail: \");\n        }\n    };\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        //gcsdk åˆå§‹åŒ–\n        GCSDK.getInstance().init(mInitCallback);\n    }\n}\n```\n```java\n//MainActivity.java\npackage com.example.gcsdkdemo;\nimport androidx.appcompat.app.AppCompatActivity;\nimport android.os.Bundle;\nimport android.util.Log;\nimport android.view.View;\nimport com.primer.jsonlili.callback.AdCallback;\nimport com.primer.jsonlili.callback.LoginCallback;\nimport com.primer.jsonlili.callback.PayCallback;\nimport com.primer.jsonlili.core.GCSDK;\nimport com.primer.jsonlili.params.AdParams;\nimport com.primer.jsonlili.params.PayParams;\n\npublic class MainActivity extends AppCompatActivity {\n    private final String TAG = \"cunzhang\";\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n    }\n\n    public void onPay(View view) {\n        Log.d(TAG, \"onPay: \");\n        //æ”¯ä»˜æ¥å£\n        PayParams payParams = new PayParams();\n        GCSDK.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                Log.d(TAG, \"onPaySuccess: \");\n            }\n            @Override\n            public void onPayFail(int i, String s) {\n                Log.d(TAG, \"onPayFail: \");\n            }\n        });\n    }\n\n    public void onLogin(View view) {\n        Log.d(TAG, \"onLogin: \");\n        //ç™»å½•æ¥å£\n        GCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                Log.d(TAG, \"onLoginSuccess: \");\n            }\n            @Override\n            public void inLoginFail(int i, String s) {\n                Log.d(TAG, \"inLoginFail: \");\n            }\n        });\n    }\n    \n    public void onOpenAd(View view) {\n        Log.d(TAG, \"onOpenAd: \");\n        //å¹¿å‘Šæ¥å£\n        AdParams adParams = new AdParams();\n        GCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                Log.d(TAG, \"onClick: \");\n            }\n            @Override\n            public void onClickSkip() {\n                Log.d(TAG, \"onClickSkip: \");\n            }\n            @Override\n            public void onClose() {\n                Log.d(TAG, \"onClose: \");\n            }\n            @Override\n            public void onOpenFaild(int i, String s) {\n                Log.d(TAG, \"onOpenFaild: \");\n            }\n            @Override\n            public void onOpenSuccess() {\n                Log.d(TAG, \"onOpenSuccess: \");\n            }\n            @Override\n            public void onLoadBegin() {\n                Log.d(TAG, \"onLoadBegin: \");\n            }\n            @Override\n            public void onLoadFaild(int i, String s) {\n                Log.d(TAG, \"onLoadFaild: \");\n            }\n            @Override\n            public void onLoadComplete() {\n                Log.d(TAG, \"onLoadComplete: \");\n            }\n            @Override\n            public void onDownloadBegin() {\n                Log.d(TAG, \"onDownloadBegin: \");\n            }\n            @Override\n            public void onDownloadFail(int i, String s) {\n                Log.d(TAG, \"onDownloadFail: \");\n            }\n            @Override\n            public void onDownloadComplete() {\n                Log.d(TAG, \"onDownloadComplete: \");\n            }\n        });\n    }\n}\n```\n\nä¾æ¬¡è§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f13a6793367598f0a03c93cb84c3a781.png)\n\nå‡è®¾è¿™æ˜¯å’‹ä»¬çš„åº”ç”¨ï¼Œæ¥ç€è¦é¢„å¤‡æ¥å…¥\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/c999c536a59d0ae7df378a1c36b140f6.png)\n\n\n# äº†è§£ä¸‹ smali\n\n**1ã€è·å¾— smali**\nä¸¤ä¸ªå®‰è£…åŒ…çš„ä»£ç éƒ½è¦åç¼–è¯‘è·å¾— \n\n```java\njava -jar apktool_2.6.0.jar [-r] d app-0.apk\n\njava -jar apktool_2.6.0.jar [-r] d app-1.apk\n```\n\næˆ‘ä»¬çš„åº”ç”¨\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f45e85873cea6435fddc0548f82af6ee.png)\n\nç©ºç™½é¡¹ç›®æ¨¡æ‹Ÿ Java æ¥å£æ¨¡æ‹Ÿæ¥å…¥\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b6ff5a0f01ab90cb1132849cb6d138f0.png)\n\n**2ã€äº†è§£é¡¹ç›®çš„ smali**\n\nå¯ä»¥ä½¿ç”¨ VSCode æ’ä»¶ smaliã€smali2java æ–¹ä¾¿æŸ¥çœ‹ smali ä»£ç ï¼Œä»¥ä¸‹ smali ä¸»è¦æ˜¯åˆ—ä¸¾ä¸ sdk ç›¸å…³ï¼Œäº†è§£ smali å…·ä½“å®ç°\n\n```java\n//App.java & App.smal\npackage com.example.gcsdkdemo;\nimport android.app.Application;\nimport android.util.Log;\nimport com.primer.jsonlili.callback.InitCallback;\nimport com.primer.jsonlili.core.GCSDK;\n\npublic class App extends Application {\n    private final String TAG = \"cunzhang\"; \n\n    //å®šä¹‰å±æ€§ mInitCallbackï¼š      .field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n    //åˆ›å»ºå¯¹è±¡ï¼š                    new-instance v0, Lcom/example/gcsdkdemo/App$1;\n    //è°ƒç”¨ç±»éšè—åˆå§‹åŒ–æ–¹æ³• <init>ï¼š   invoke-direct {v0, p0}, Lcom/example/gcsdkdemo/App$1;-><init>(Lcom/example/gcsdkdemo/App;)V\n    //æŠŠåˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™æœ¬åœ°å˜é‡ï¼š     iput-object v0, p0, Lcom/example/gcsdkdemo/App;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n    private InitCallback mInitCallback = new InitCallback() {\n        @Override\n        public void initSuccess() {\n            Log.d(TAG, \"initSuccess: \");\n        }\n        @Override\n        public void initFail(int i, String s) {\n            Log.d(TAG, \"initFail: \");\n        }\n    };\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        \n        //è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ï¼š         invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //ç§»åŠ¨æ“ä½œæ•°ï¼š              move-result-object v0\n        //ä»æ“ä½œæ•°æ ˆè·å–ä¸¤ä¸ªæ“ä½œæ•°ï¼š  iget-object v1, p0, Lcom/example/gcsdkdemo/App;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n        //è°ƒç”¨å®ç°æ–¹æ³•ï¼š            invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->init(Lcom/primer/jsonlili/callback/InitCallback;)V\n        GCSDK.getInstance().init(mInitCallback);\n    }\n}\n```\n\nInitCallback å†…éƒ¨ç±»å®ç°\n\n```java\n# è¡¨æ˜ç±»é™å®šå\n.class Lcom/example/gcsdkdemo/App$1;\n# çˆ¶ç±»\n.super Ljava/lang/Object;\n# æºæ–‡ä»¶åç§°\n.source \"App.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/InitCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingClass;\nvalue = Lcom/example/gcsdkdemo/App;\n.end annotation\n\n# å†…éƒ¨ç±»\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±» this å¼•ç”¨\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/App;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/App;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/App;\n# è¡Œæ•°ï¼Œåˆ é™¤ä¸å½±å“ä»£ç æ‰§è¡Œ\n.line 13\niput-object p1, p0, Lcom/example/gcsdkdemo/App$1;->this$0:Lcom/example/gcsdkdemo/App;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public initFail(ILjava/lang/String;)V\n\n# æŒ‡å®šæ–¹æ³•ä¸­å¯ç”¨çš„éå‚å¯„å­˜å™¨æ•°é‡\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 21\nconst-string v0, \"cunzhang\"\nconst-string v1, \"initFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 22\nreturn-void\n.end method\n\n.method public initSuccess()V\n.locals 2\n.line 16\nconst-string v0, \"cunzhang\"\nconst-string v1, \"initSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 17\nreturn-void\n.end method\n```\n\n```java\n//MainActivity.java $ MainActivity.smali\npackage com.example.gcsdkdemo;\nimport androidx.appcompat.app.AppCompatActivity;\nimport android.os.Bundle;\nimport android.util.Log;\nimport android.view.View;\nimport com.primer.jsonlili.callback.AdCallback;\nimport com.primer.jsonlili.callback.LoginCallback;\nimport com.primer.jsonlili.callback.PayCallback;\nimport com.primer.jsonlili.core.GCSDK;\nimport com.primer.jsonlili.params.AdParams;\nimport com.primer.jsonlili.params.PayParams;\n\npublic class MainActivity extends AppCompatActivity {\n    private final String TAG = \"cunzhang\";\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n    }\n\n    public void onPay(View view) {\n        Log.d(TAG, \"onPay: \");\n        //åˆ›å»º PayParams å¯¹è±¡å¹¶å­˜å‚¨åˆ° v0ï¼Œ\n        //new-instance v0, Lcom/primer/jsonlili/params/PayParams;\n        //invoke-direct {v0}, Lcom/primer/jsonlili/params/PayParams;-><init>()V\n        \n        //.local v0, \"payParams\":Lcom/primer/jsonlili/params/PayParams;\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v1\n        //new-instance v2, Lcom/example/gcsdkdemo/MainActivity$1;\n        //invoke-direct {v2, p0}, Lcom/example/gcsdkdemo/MainActivity$1;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v1, v0, v2}, Lcom/primer/jsonlili/core/GCSDK;->pay(Lcom/primer/jsonlili/params/PayParams;Lcom/primer/jsonlili/callback/PayCallback;)V\n        \n        PayParams payParams = new PayParams();\n        GCSDK.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                Log.d(TAG, \"onPaySuccess: \");\n            }\n\n            @Override\n            public void onPayFail(int i, String s) {\n                Log.d(TAG, \"onPayFail: \");\n            }\n        });\n    }\n\n    public void onLogin(View view) {\n        Log.d(TAG, \"onLogin: \");\n        //è°ƒç”¨ getInstanceï¼ŒæŠŠ getInstance è¿”å›çš„å¯¹è±¡å­˜å‚¨åˆ° v0ï¼Œåˆ›å»ºå†…éƒ¨ç±» LoginCallback å¯¹è±¡ï¼Œè°ƒç”¨å†…éƒ¨ç±»åˆå§‹åŒ–ï¼Œè°ƒç”¨ç™»å½•æ–¹æ³•\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v0\n        //new-instance v1, Lcom/example/gcsdkdemo/MainActivity$2;\n        //invoke-direct {v1, p0}, Lcom/example/gcsdkdemo/MainActivity$2;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->login(Lcom/primer/jsonlili/callback/LoginCallback;)V\n        \n        GCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                Log.d(TAG, \"onLoginSuccess: \");\n            }\n\n            @Override\n            public void inLoginFail(int i, String s) {\n                Log.d(TAG, \"inLoginFail: \");\n            }\n        });\n    }\n    \n\n    public void onOpenAd(View view) {\n        Log.d(TAG, \"onOpenAd: \");\n        \n        //new-instance v0, Lcom/primer/jsonlili/params/AdParams;\n        //invoke-direct {v0}, Lcom/primer/jsonlili/params/AdParams;-><init>()V\n        //.line 60\n        //.local v0, \"adParams\":Lcom/primer/jsonlili/params/AdParams;\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v1\n        //new-instance v2, Lcom/example/gcsdkdemo/MainActivity$3;\n        //invoke-direct {v2, p0}, Lcom/example/gcsdkdemo/MainActivity$3;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v1, v0, v2}, Lcom/primer/jsonlili/core/GCSDK;->openAd(Lcom/primer/jsonlili/params/AdParams;Lcom/primer/jsonlili/callback/AdCallback;)V\n\n        AdParams adParams = new AdParams();\n        GCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                Log.d(TAG, \"onClick: \");\n            }\n            @Override\n            public void onClickSkip() {\n                Log.d(TAG, \"onClickSkip: \");\n            }\n            @Override\n            public void onClose() {\n                Log.d(TAG, \"onClose: \");\n            }\n            @Override\n            public void onOpenFaild(int i, String s) {\n                Log.d(TAG, \"onOpenFaild: \");\n            }\n            @Override\n            public void onOpenSuccess() {\n                Log.d(TAG, \"onOpenSuccess: \");\n            }\n            @Override\n            public void onLoadBegin() {\n                Log.d(TAG, \"onLoadBegin: \");\n            }\n            @Override\n            public void onLoadFaild(int i, String s) {\n                Log.d(TAG, \"onLoadFaild: \");\n            }\n            @Override\n            public void onLoadComplete() {\n                Log.d(TAG, \"onLoadComplete: \");\n            }\n            @Override\n            public void onDownloadBegin() {\n                Log.d(TAG, \"onDownloadBegin: \");\n            }\n            @Override\n            public void onDownloadFail(int i, String s) {\n                Log.d(TAG, \"onDownloadFail: \");\n            }\n            @Override\n            public void onDownloadComplete() {\n                Log.d(TAG, \"onDownloadComplete: \");\n            }\n        });\n    }\n}\n```\n\nPayCallback å†…éƒ¨ç±»å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$1;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/PayCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onPay(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 28\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$1;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public onPayFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 36\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onPayFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 37\nreturn-void\n.end method\n\n.method public onPaySuccess()V\n.locals 2\n.line 31\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onPaySuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 32\nreturn-void\n.end method\n```\n\nå†…éƒ¨ç±» LoginCallback å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$2;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/LoginCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onLogin(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 43\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$2;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public inLoginFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 51\nconst-string v0, \"cunzhang\"\nconst-string v1, \"inLoginFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 52\nreturn-void\n.end method\n\n.method public onLoginSuccess()V\n.locals 2\n.line 46\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoginSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 47\nreturn-void\n.end method\n```\n\nAdCallback å†…éƒ¨ç±»å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$3;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/AdCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onOpenAd(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 60\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$3;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public onClick()V\n.locals 2\n.line 63\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClick: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 64\nreturn-void\n.end method\n\n.method public onClickSkip()V\n.locals 2\n.line 68\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClickSkip: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 69\nreturn-void\n.end method\n\n.method public onClose()V\n.locals 2\n.line 73\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClose: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 74\nreturn-void\n.end method\n\n.method public onDownloadBegin()V\n.locals 2\n.line 103\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadBegin: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 104\nreturn-void\n.end method\n\n.method public onDownloadComplete()V\n.locals 2\n.line 113\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadComplete: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 114\nreturn-void\n.end method\n\n.method public onDownloadFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 108\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 109\nreturn-void\n.end method\n\n.method public onLoadBegin()V\n.locals 2\n.line 88\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadBegin: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 89\nreturn-void\n.end method\n\n.method public onLoadComplete()V\n.locals 2\n.line 98\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadComplete: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 99\nreturn-void\n.end method\n\n.method public onLoadFaild(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 93\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadFaild: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 94\nreturn-void\n.end method\n\n.method public onOpenFaild(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 78\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onOpenFaild: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 79\nreturn-void\n.end method\n\n.method public onOpenSuccess()V\n.locals 2\n.line 83\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onOpenSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 84\nreturn-void\n.end method\n```\n\nç†Ÿèƒ½ç”Ÿå·§ï¼Œè¿™æ ·çš„ä»£ç çœ‹å¤šäº†è‡ªç„¶äº†è§£å’Œè®¤è¯†çš„è¯­æ³•ç­‰ä¹Ÿä¼šè¶Šå¤šï¼Œè¯»å–æ¥å°±æ²¡é‚£ä¹ˆè´¹åŠ²\n\n\n**æˆ‘ä»¬çš„åº”ç”¨**\n\nå‡å¦‚æˆ‘ä»¬å·²çŸ¥ä»£ç æ’å…¥ç‚¹ä½ç½®â€”â€”â€”â€”å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨çš„æ˜¯`æ‰¾åˆ°å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶æ‰€åœ¨ä½ç½®å¹¶æ’å…¥æ–°çš„ smali ä»£ç `ï¼Œæ’å…¥ä»£ç ä¸èƒ½å¼•å…¥æ–°çš„ç¼–è¯‘å™¨ç­‰é”™è¯¯\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/44d85c0db3e3955ffbe9fb8d82b82f72.png)\n\n# è¯•ç€æ¥å…¥ smali \n\n**1ã€æŠŠ sdk ç›¸å…³çš„ smali ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬åº”ç”¨åç¼–è¯‘åçš„å·¥ç¨‹ç›®å½•ä¸‹**\n\nè¿™é‡Œæˆ‘æ–°å»º `smali_classes9` ç›®å½•ï¼Œgcsdk æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä»£ç æ²¡æœ‰èµ„æºã€so æ–‡ä»¶ç­‰ï¼›å¦‚æœæœ‰ï¼Œä¹Ÿéœ€è¦å¤åˆ¶åˆ°å·¥ç¨‹çš„ç›¸åº”ç›®å½•ä¸‹ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿç¼–è¯‘æˆåŠŸã€è¿è¡ŒæœŸé—´èƒ½æ‰¾åˆ°è·¯å¾„æ­£ç¡®åŠ è½½ä»£ç ï¼Œè¿™æ˜¯é¡¹ç›®èƒ½å¤Ÿè¿è¡Œçš„å‰æã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/42ce50c1f4987d6caf1dadbb4b1ba80a.png)\n\nä¸‹é¢å°±å¼€å§‹å¾€åº”ç”¨ä¸­æ’å…¥ç‚¹å¤„æ’å…¥ sdk smali ä»£ç ã€‚\n\n**2ã€LeaderApp.java & LeaderApp.smali**\n```java\n.class public Lcom/example/leaderapp/ui/LeaderApp;\n.super Landroid/app/Application;\n.source \"LeaderApp.java\"\n\n# instance fields\n.field private final TAG:Ljava/lang/String;\n# 1ã€å®šä¹‰åˆå§‹åŒ–å›è°ƒå­—æ®µ \n.field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n\n# direct methods\n.method public constructor <init>()V\n .locals 1\n .line 6\n invoke-direct {p0}, Landroid/app/Application;-><init>()V\n .line 7\n const-string v0, \"leader\"\n iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;->TAG:Ljava/lang/String;\n# 2ã€åˆå§‹åŒ–æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»å¯¹è±¡\n new-instance v0, Lcom/example/leaderapp/ui/LeaderApp$1;\n invoke-direct {v0, p0}, Lcom/example/leaderapp/ui/LeaderApp$1;-><init>(Lcom/example/leaderapp/ui/LeaderApp;)V\n iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n return-void\n.end method\n\n# virtual methods\n.method public onCreate()V\n .locals 2\n .line 11\n invoke-super {p0}, Landroid/app/Application;->onCreate()V\n .line 12\n const-string v0, \"leader\"\n const-string v1, \"onCreate: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n# 3ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•\n invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n move-result-object v0\n iget-object v1, p0, Lcom/example/leaderapp/ui/LeaderApp;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->init(Lcom/primer/jsonlili/callback/InitCallback;)V\n return-void\n.end method\n# 4ã€åˆ›å»º LeaderApp$1.smaliï¼Œå¹¶æ›´æ–°è·¯å¾„ã€ç±»ç­‰\n```\n\næ£€éªŒæ’å…¥æ˜¯å¦æ­£ç¡®å¹¶ç¬¦åˆæœŸæœ›ï¼Œå¯ä½¿ç”¨ VSCODE smali æ’ä»¶é€šè¿‡ä»£ç è½¬æ¢éªŒè¯\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/4c945faf21ac85feb9392dbba3f9f527.png)\n\nå¯¹æ¯”åŸå§‹é¡¹ç›®å’Œæ’å…¥åçš„æ•ˆæœæ˜¯å¦ä¸€è‡´\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/36199a2e95b678da1afe678f4f9ed9f3.png)\n\nå¯¹å®‰è£…åŒ…æ‰‹åŠ¨ç­¾åï¼Œè¿è¡ŒæŸ¥çœ‹æ—¥å¿—ï¼Œèƒ½çœ‹åˆ° sdk åˆå§‹åŒ–æ­£ç¡®ï¼Œè¯´æ˜ä¸Šè¿°æ¥å…¥æ˜¯æ— è¯¯çš„ã€‚\n\njarsigner -verbose -keystore [aa.keystore] [sign-app0.apk] [app-0.apk] key0\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/d9a2aa7640b31bea5158a5c79d08c34b.png)\n\n\n**æ³¨æ„âš ï¸ï¼š**\n\nåç¼–è¯‘ä½¿ç”¨ `java -jar apktool.jar d ***.apk`ï¼Œåœ¨å›ç¼–è¯‘æ—¶å€™å¯èƒ½å‡ºç°é”™è¯¯ï¼Œæ—¥å¿—ä¸­å‘ç° `res/` ç›®å½•åƒæ˜¯èµ„æºé—®é¢˜ã€‚\n\n```java\nW: invalid resource directory name: >/Users/jsonli/Desktop/demo/0603/app-0/app-0/res navigation\nbrut.androlib.AndrolibException: brut.common.BrutException: could not exec (exit code = 1):\n/Users/jsonli/Library/apktool/framework/1.apk, -S, \n/Users/jsonli/Desktop/demo/0603/app-0/app-0/res, -M, \n/Users/jsonli/Desktop/demo/0603/app-0/app-0/AndroidManifest.xml]\n```\n\nå°è¯•åœ¨åç¼–è¯‘æ—¶ä¸å¤„ç†èµ„æºå‘½ä»¤åŠ ä¸Š -r å‚æ•°`java -jar apktool.jar -r d ***.apk` æœç„¶èƒ½å¤Ÿæ­£å¸¸æ‰“åŒ…ï¼Œç»§ç»­å®Œæˆå‰©ä¸‹çš„æ¥å…¥å§ :)\n\n**3ã€HomeFragment$1.smaliã€HomeFrgment$2.smali**\n\n`HomeFragment$1.smali`: button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œç™»å½•è°ƒç”¨å¤„\n`HomeFragment$2.smali`: gcsdk ç™»å½•å›è°ƒ\n\n```java\n.class Lcom/example/leaderapp/ui/home/HomeFragment$1;\n.super Ljava/lang/Object;\n.source \"HomeFragment.java\"\n\n# interfaces\n.implements Landroid/view/View$OnClickListener;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\n value = Lcom/example/leaderapp/ui/home/HomeFragment;->onCreateView(Landroid/view/LayoutInflater;Landroid/view/ViewGroup;Landroid/os/Bundle;)Landroid/view/View;\n.end annotation\n.annotation system Ldalvik/annotation/InnerClass;\n accessFlags = 0x0\n name = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/leaderapp/ui/home/HomeFragment;\n\n# direct methods\n.method constructor <init>(Lcom/example/leaderapp/ui/home/HomeFragment;)V\n .locals 0\n .param p1, \"this$0\" # Lcom/example/leaderapp/ui/home/HomeFragment;\n .line 40\n iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$1;->this$0:Lcom/example/leaderapp/ui/home/HomeFragment;\n invoke-direct {p0}, Ljava/lang/Object;-><init>()V\n return-void\n.end method\n\n# virtual methods\n.method public onClick(Landroid/view/View;)V\n .locals 3\n .param p1, \"view\" # Landroid/view/View;\n .line 43\n invoke-virtual {p1}, Landroid/view/View;->getContext()Landroid/content/Context;\n move-result-object v0\n const-string v1, \"\\u767b\\u5f55\"\n const/4 v2, 0x0\n invoke-static {v0, v1, v2}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;\n move-result-object v0\n invoke-virtual {v0}, Landroid/widget/Toast;->show()V\n .line 44\n const-string v0, \"leader\"\n const-string v1, \"onClick: login\"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n\n# 1ã€è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¿®æ”¹ç±»è·¯å¾„ã€å†…éƒ¨ç±»ï¼ˆç™»å½•å›è°ƒå®ç°ç±»ï¼‰\n invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n move-result-object v0\n new-instance v1, Lcom/example/leaderapp/ui/home/HomeFragment$2;\n \n# å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œè¿™é‡Œçš„å¤–éƒ¨ç±»æ˜¯ button çš„ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤ä¼ å…¥ HomeFragment$1ï¼Œè€Œä¸æ˜¯ HomeFragment\n invoke-direct {v1, p0}, Lcom/example/leaderapp/ui/home/HomeFragment$2;-><init>(Lcom/example/leaderapp/ui/home/HomeFragment$1;)V\n invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->login(Lcom/primer/jsonlili/callback/LoginCallback;)V\n return-void\n.end method\n```\n```java\n.class Lcom/example/leaderapp/ui/home/HomeFragment$2;\n.super Ljava/lang/Object;\n.source \"HomeFragment.java\"\n\n# 2ã€åˆ›å»ºå†…éƒ¨ç±»æ–‡ä»¶ï¼Œå¹¶æŠŠå¯¹åº”çš„ç™»å½•å›è°ƒä»£ç å¤åˆ¶è¿‡æ¥\n# 3ã€ä¿®æ”¹ç±»è·¯å¾„ .classã€.sourceã€\n# interfaces\n.implements Lcom/primer/jsonlili/callback/LoginCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\n value = Lcom/example/leaderapp/ui/home/HomeFragment;->onLogin(Landroid/view/View;)V\n.end annotation\n.annotation system Ldalvik/annotation/InnerClass;\n accessFlags = 0x0\n name = null\n.end annotation\n\n# è¿™é‡Œä¼ å…¥çš„å¤–éƒ¨ç±»æ˜¯ button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤åˆå§‹åŒ–å‡½æ•°å’Œ this ç±»å‹åº”è¯¥æ˜¯ \n# instance fields\n.field final synthetic this$0:Lcom/example/leaderapp/ui/home/HomeFragment$1;\n\n# direct methods\n.method constructor <init>(Lcom/example/leaderapp/ui/home/HomeFragment$1;)V\n .locals 0\n .param p1, \"this$0\"\n \n# è¿™é‡Œä¹Ÿæ˜¯ HomeFragment$1\n iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$2;->this$0:Lcom/example/leaderapp/ui/home/HomeFragment$1;\n invoke-direct {p0}, Ljava/lang/Object;-><init>()V\n return-void\n.end method\n\n# virtual methods\n.method public inLoginFail(ILjava/lang/String;)V\n .locals 2\n .param p1, \"i\" # I\n .param p2, \"s\" # Ljava/lang/String;\n .line 51\n const-string v0, \"cunzhang\"\n const-string v1, \"inLoginFail: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n .line 52\n return-void\n.end method\n\n.method public onLoginSuccess()V\n .locals 2\n .line 46\n const-string v0, \"cunzhang\"\n const-string v1, \"onLoginSuccess: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n .line 47\n return-void\n.end method\n```\n\n**4ã€NotificationsFragment.smaliã€DashboardFragment.smali**\n\nå› ä¸ºä»£ç ç®€å•ï¼Œä¸”é€»è¾‘ä¸€è‡´ï¼Œå‰©ä¸‹çš„æ”¯ä»˜å’Œå¹¿å‘Šæ¥å£ä»£ç å°±ä¸è´´äº†\n\n# æœ€åçš„æœ€å\n\n`0ã€`è·å– smail ä»£ç ï¼ˆä¸€èˆ¬æ˜¯æ ¹æ® java ä»£ç è·å– smail ä»£ç ï¼ŒåŒç†æ ¹æ® java ä»£ç è·å–å­—èŠ‚ç ï¼Œåœ¨ä»£ç é‡å¤šçš„æ—¶å€™è¾ƒéš¾ç›´æ¥å†™å‡ºå®Œæ•´çš„ smailã€å­—èŠ‚ç ï¼‰\n`1ã€`å¯»æ‰¾æ’å…¥ç‚¹ï¼Œsmali ä»£ç æ’å…¥ã€ä¿å­˜ã€æ’å…¥æ£€éªŒ\n`2ã€`æ‰“åŒ…ã€ç­¾åã€è¿è¡Œè°ƒè¯•æŸ¥çœ‹æ•ˆæœï¼ˆä¾æ­¤ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œè¿è¡Œç»“æœå’Œé¢„æœŸä¸€è‡´ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/831157f13e5c535bafa42839e3f80257.png)\n\n\næ€è€ƒï¼š\n\nAï¼šä¸ºä»€ä¹ˆæ smali æ¥å…¥ï¼Œè¿™ä¸æ˜¯ç»™è‡ªå·±æ‰¾å‘å˜›\nBï¼šè¿™æ˜¯éœ€æ±‚ï¼Œä¸ºäº†è§£å†³é—®é¢˜ï¼›æˆ‘è§‰å¾—é‡ç‚¹æ˜¯å¯ä»¥æ‰©å±•çŸ¥è¯†\nAï¼šæ—¢ç„¶ä½ å·²æœ‰ apkï¼Œå¯ä»¥æŠŠå®ƒè½¬æ¢ä¸º java ä»£ç ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥ä¸æ›´æ¸…æ™°ã€çœäº‹ï¼Œé¿å…ç›²åŒºä¸å¥½å—ï¼Œè¿˜æ˜¯ä¸æ–¹ä¾¿\nBï¼šå¥½åƒ...ä¹Ÿ å¯ ä»¥â“\nAï¼šæˆ‘è§‰å¾—å¯ä»¥ï¼ŒAndroidFk å·¥å…·å¯ä»¥æŠŠ apk ç›´æ¥åç¼–è¯‘ä¸º android é¡¹ç›®ï¼ˆè‹¥åŠ å›ºã€åŠ å¯†çš„ apk å¯èƒ½å°±æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼‰\nBï¼šä¹Ÿæ˜¯ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥æ–¹ä¾¿å¤šäº†\nAï¼šæˆ‘åˆæœ‰ç–‘é—®äº†ï¼šå¦‚æœæ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ˜¯ä¸€ä¸ª aarèµ„æºæ–‡ä»¶ï¼ˆåŒ…å«èµ„æºç­‰æ–‡ä»¶ï¼‰ è€Œä¸æ˜¯ jarï¼ˆçº¯ Java ä»£ç ï¼‰ï¼Œæ¥å…¥ä¼šä¸ä¼šé‡åˆ°å…¶ä»–é—®é¢˜\nBï¼šåŒºåˆ«è‚¯å®šæ˜¯æœ‰ï¼Œå®æ“æ–¹çŸ¥æ™“\nAï¼šä¸‹æ¬¡ä½ æ¥ä¸€ä¸ªè¯•è¯•\nBï¼š... ...\nAï¼šè¿™ä¸å¯æ€•å•Šï¼ŒæŒç»­å­¦ä¹ ï¼Œæå‡å¹¿åº¦åŠæ³•æ€»æ¯”å›°éš¾å¤š\n","source":"_posts/undefined/ä»smailæ¥å…¥ç¬¬ä¸‰æ–¹.md","raw":"---\ntitle: ä» smail æ¥å…¥ç¬¬ä¸‰æ–¹ SDK\ncatalog: true\ndate: 2022-09-26 20:56:19\nsubtitle: æœ‰æ—¶é€šè¿‡æŸ¥çœ‹ã€ä¿®æ”¹ç¬¬ä¸‰æ–¹åº“èƒ½æ›´å¥½è§£å†³é—®é¢˜\nheader-img: /img/220926_smailsdk/smail_bg.webp\ntags: SDK\nsticky: 3\ncategories:\n---\n\n# é‡åˆ°è¿‡è¿™ç§åœºæ™¯å—\n\nä»€ä¹ˆæ—¶å€™è¦åˆ©ç”¨ smali è¯­è¨€å±‚é¢æ¥å…¥ç¬¬ä¸‰æ–¹ sdk ï¼Ÿä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ java æ¥å£ï¼Œä¸€ç›®äº†ç„¶ï¼Œæä¸ª smali ä¸æ˜¯æ²¡äº‹æ‰¾äº‹ï¼Ÿåœºæ™¯ä¸åŒï¼Œåœ¨æ²¡æœ‰åŠæ³•çš„æ—¶å€™è¿™å°±æ˜¯ä¸€ç§æ–¹æ³•ã€‚\n\nprogramer Aï¼š   å‘ä½ ä¸€ä¸ª apk æ–‡ä»¶ï¼Œå¸®æˆ‘çœ‹ä¸‹\nprogramer Aï¼š   å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŸå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª APKï¼Œæˆ‘æƒ³æŠŠå’‹ä»¬çš„ sdk æ¥å…¥åˆ°é‡Œé¢ï¼Œæ€ä¹ˆæï¼Ÿ\nprogramer Bï¼š   åº”è¯¥å¯ä»¥ï¼Œå¯ä»¥è¯•è¯•ä»¥å­—èŠ‚ç ã€smail å½¢å¼æ¥å…¥\nprogramer Aï¼š   smail ï¼Ÿè¿™æ˜¯å•¥å•Šï¼\nprogramer Bï¼š   è‡ªå·±æŸ¥èµ„æ–™ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\n\n\n**å—¯ï¼Ÿæ²¡æœ‰æ€è·¯ï¼Œä¸ç„¶å†™ä¸ª Demo çœ‹çœ‹å§**\n\n1ã€å‡†å¤‡ä¸€ä¸ª sdk: `gcsdk-1.0.0.jar`\n2ã€å‡†å¤‡ä¸€ä¸ª apk: `app-0.apk`ï¼ˆå‡è®¾æ˜¯æˆ‘ä»¬çš„åº”ç”¨ï¼‰\n3ã€åˆ›å»ºä¸€ä¸ªç©ºç™½ Android é¡¹ç›®ï¼Œé¢„å¤‡æ¥å…¥ sdk: `app-1.apk`ï¼ˆå¤‡ç”¨ï¼‰ \n\næ¨¡æ‹Ÿå‡ ä¸ªå¯¹å¤–çš„æ¥å£ç®€å•ç”Ÿæˆä¸€ä¸ª jarï¼Œå®é™…ä¸­æ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ¥å£ä¹Ÿä¸ä¼šå¾ˆå¤æ‚ã€‚\n\n---\n\n> gcsdk-1.0.0ï¼ˆç¤ºä¾‹ï¼‰ \n\n```java\n// åˆå§‹åŒ–\nGCSDK.getInstance().init(new InitCallback() {\n            @Override\n            public void initSuccess() {\n                System.out.println(\"gcsdk-åˆå§‹åŒ–æˆåŠŸ\");\n            }\n            @Override\n            public void initFail(int code, String error) {\n                System.out.println(\"gcsdk-åˆå§‹åŒ–å¤±è´¥ï¼šcode = \" + code + \"  error = \" + error);\n            }\n});\n\n//ç™»å½•\nGCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                System.out.println(\"ç™»å½•-æˆåŠŸ\");\n            }\n            @Override\n            public void inLoginFail(int code, String error) {\n                System.out.println(\"ç™»å½•-å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n});\n\n//å¹¿å‘Š        \nAdParams adParams = new AdParams();\nGCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                System.out.println(\"å¹¿å‘Š-ç‚¹å‡»\");\n            }\n            @Override\n            public void onClickSkip() {\n                System.out.println(\"å¹¿å‘Š-ç‚¹å‡»è·³è¿‡\");\n            }\n            @Override\n            public void onClose() {\n                System.out.println(\"å¹¿å‘Š-å…³é—­\");\n            }\n            @Override\n            public void onOpenFaild(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-æ‰“å¼€å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n            @Override\n            public void onOpenSuccess() {\n                System.out.println(\"å¹¿å‘Š-æ‰“å¼€æˆåŠŸ\");\n            }\n            @Override\n            public void onLoadBegin() {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å¼€å§‹\");\n            }\n            @Override\n            public void onLoadFaild(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n            @Override\n            public void onLoadComplete() {\n                System.out.println(\"å¹¿å‘Š-åŠ è½½å®Œæˆ\");\n            }\n            @Override\n            public void onDownloadBegin() {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å¼€å§‹\");\n            }\n            @Override\n            public void onDownloadFail(int code, String error) {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å¤±è´¥ï¼šcode =\" + code + \" error = \" + error);\n            }\n\n            @Override\n            public void onDownloadComplete() {\n                System.out.println(\"å¹¿å‘Š-ä¸‹è½½å®Œæˆ\");\n            }\n});\n\n//æ”¯ä»˜\nPayParams payParams = new PayParams();\nPayManager.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                System.out.println(\"æ”¯ä»˜-æˆåŠŸ\");\n            }\n            @Override\n            public void onPayFail(int code, String error) {\n                System.out.println(\"æ”¯ä»˜-å¤±è´¥ï¼šcode = \" + code + \" error = \" + error);\n            }\n});\n```\n\n> ç©ºç™½ Android é¡¹ç›®ï¼Œæ¨¡æ‹Ÿæ¥å…¥ gcsdkï¼Œæ¥å…¥å®Œæˆåæ‰“åŒ…å¤‡ç”¨ï¼Œç”Ÿæˆçš„ apk ç”¨äºè·å– smali ä»£ç \n\n```java\n// App.java\npackage com.example.gcsdkdemo;\nimport android.app.Application;\nimport android.util.Log;\nimport com.primer.jsonlili.callback.InitCallback;\nimport com.primer.jsonlili.core.GCSDK;\n\npublic class App extends Application {\n    private final String TAG = \"cunzhang\";\n    //åˆå§‹åŒ–å›è°ƒ\n    private InitCallback mInitCallback = new InitCallback() {\n        @Override\n        public void initSuccess() {\n            Log.d(TAG, \"initSuccess: \");\n        }\n\n        @Override\n        public void initFail(int i, String s) {\n            Log.d(TAG, \"initFail: \");\n        }\n    };\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        //gcsdk åˆå§‹åŒ–\n        GCSDK.getInstance().init(mInitCallback);\n    }\n}\n```\n```java\n//MainActivity.java\npackage com.example.gcsdkdemo;\nimport androidx.appcompat.app.AppCompatActivity;\nimport android.os.Bundle;\nimport android.util.Log;\nimport android.view.View;\nimport com.primer.jsonlili.callback.AdCallback;\nimport com.primer.jsonlili.callback.LoginCallback;\nimport com.primer.jsonlili.callback.PayCallback;\nimport com.primer.jsonlili.core.GCSDK;\nimport com.primer.jsonlili.params.AdParams;\nimport com.primer.jsonlili.params.PayParams;\n\npublic class MainActivity extends AppCompatActivity {\n    private final String TAG = \"cunzhang\";\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n    }\n\n    public void onPay(View view) {\n        Log.d(TAG, \"onPay: \");\n        //æ”¯ä»˜æ¥å£\n        PayParams payParams = new PayParams();\n        GCSDK.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                Log.d(TAG, \"onPaySuccess: \");\n            }\n            @Override\n            public void onPayFail(int i, String s) {\n                Log.d(TAG, \"onPayFail: \");\n            }\n        });\n    }\n\n    public void onLogin(View view) {\n        Log.d(TAG, \"onLogin: \");\n        //ç™»å½•æ¥å£\n        GCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                Log.d(TAG, \"onLoginSuccess: \");\n            }\n            @Override\n            public void inLoginFail(int i, String s) {\n                Log.d(TAG, \"inLoginFail: \");\n            }\n        });\n    }\n    \n    public void onOpenAd(View view) {\n        Log.d(TAG, \"onOpenAd: \");\n        //å¹¿å‘Šæ¥å£\n        AdParams adParams = new AdParams();\n        GCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                Log.d(TAG, \"onClick: \");\n            }\n            @Override\n            public void onClickSkip() {\n                Log.d(TAG, \"onClickSkip: \");\n            }\n            @Override\n            public void onClose() {\n                Log.d(TAG, \"onClose: \");\n            }\n            @Override\n            public void onOpenFaild(int i, String s) {\n                Log.d(TAG, \"onOpenFaild: \");\n            }\n            @Override\n            public void onOpenSuccess() {\n                Log.d(TAG, \"onOpenSuccess: \");\n            }\n            @Override\n            public void onLoadBegin() {\n                Log.d(TAG, \"onLoadBegin: \");\n            }\n            @Override\n            public void onLoadFaild(int i, String s) {\n                Log.d(TAG, \"onLoadFaild: \");\n            }\n            @Override\n            public void onLoadComplete() {\n                Log.d(TAG, \"onLoadComplete: \");\n            }\n            @Override\n            public void onDownloadBegin() {\n                Log.d(TAG, \"onDownloadBegin: \");\n            }\n            @Override\n            public void onDownloadFail(int i, String s) {\n                Log.d(TAG, \"onDownloadFail: \");\n            }\n            @Override\n            public void onDownloadComplete() {\n                Log.d(TAG, \"onDownloadComplete: \");\n            }\n        });\n    }\n}\n```\n\nä¾æ¬¡è§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f13a6793367598f0a03c93cb84c3a781.png)\n\nå‡è®¾è¿™æ˜¯å’‹ä»¬çš„åº”ç”¨ï¼Œæ¥ç€è¦é¢„å¤‡æ¥å…¥\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/c999c536a59d0ae7df378a1c36b140f6.png)\n\n\n# äº†è§£ä¸‹ smali\n\n**1ã€è·å¾— smali**\nä¸¤ä¸ªå®‰è£…åŒ…çš„ä»£ç éƒ½è¦åç¼–è¯‘è·å¾— \n\n```java\njava -jar apktool_2.6.0.jar [-r] d app-0.apk\n\njava -jar apktool_2.6.0.jar [-r] d app-1.apk\n```\n\næˆ‘ä»¬çš„åº”ç”¨\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/f45e85873cea6435fddc0548f82af6ee.png)\n\nç©ºç™½é¡¹ç›®æ¨¡æ‹Ÿ Java æ¥å£æ¨¡æ‹Ÿæ¥å…¥\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/b6ff5a0f01ab90cb1132849cb6d138f0.png)\n\n**2ã€äº†è§£é¡¹ç›®çš„ smali**\n\nå¯ä»¥ä½¿ç”¨ VSCode æ’ä»¶ smaliã€smali2java æ–¹ä¾¿æŸ¥çœ‹ smali ä»£ç ï¼Œä»¥ä¸‹ smali ä¸»è¦æ˜¯åˆ—ä¸¾ä¸ sdk ç›¸å…³ï¼Œäº†è§£ smali å…·ä½“å®ç°\n\n```java\n//App.java & App.smal\npackage com.example.gcsdkdemo;\nimport android.app.Application;\nimport android.util.Log;\nimport com.primer.jsonlili.callback.InitCallback;\nimport com.primer.jsonlili.core.GCSDK;\n\npublic class App extends Application {\n    private final String TAG = \"cunzhang\"; \n\n    //å®šä¹‰å±æ€§ mInitCallbackï¼š      .field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n    //åˆ›å»ºå¯¹è±¡ï¼š                    new-instance v0, Lcom/example/gcsdkdemo/App$1;\n    //è°ƒç”¨ç±»éšè—åˆå§‹åŒ–æ–¹æ³• <init>ï¼š   invoke-direct {v0, p0}, Lcom/example/gcsdkdemo/App$1;-><init>(Lcom/example/gcsdkdemo/App;)V\n    //æŠŠåˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™æœ¬åœ°å˜é‡ï¼š     iput-object v0, p0, Lcom/example/gcsdkdemo/App;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n    private InitCallback mInitCallback = new InitCallback() {\n        @Override\n        public void initSuccess() {\n            Log.d(TAG, \"initSuccess: \");\n        }\n        @Override\n        public void initFail(int i, String s) {\n            Log.d(TAG, \"initFail: \");\n        }\n    };\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        \n        //è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ï¼š         invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //ç§»åŠ¨æ“ä½œæ•°ï¼š              move-result-object v0\n        //ä»æ“ä½œæ•°æ ˆè·å–ä¸¤ä¸ªæ“ä½œæ•°ï¼š  iget-object v1, p0, Lcom/example/gcsdkdemo/App;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n        //è°ƒç”¨å®ç°æ–¹æ³•ï¼š            invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->init(Lcom/primer/jsonlili/callback/InitCallback;)V\n        GCSDK.getInstance().init(mInitCallback);\n    }\n}\n```\n\nInitCallback å†…éƒ¨ç±»å®ç°\n\n```java\n# è¡¨æ˜ç±»é™å®šå\n.class Lcom/example/gcsdkdemo/App$1;\n# çˆ¶ç±»\n.super Ljava/lang/Object;\n# æºæ–‡ä»¶åç§°\n.source \"App.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/InitCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingClass;\nvalue = Lcom/example/gcsdkdemo/App;\n.end annotation\n\n# å†…éƒ¨ç±»\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±» this å¼•ç”¨\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/App;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/App;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/App;\n# è¡Œæ•°ï¼Œåˆ é™¤ä¸å½±å“ä»£ç æ‰§è¡Œ\n.line 13\niput-object p1, p0, Lcom/example/gcsdkdemo/App$1;->this$0:Lcom/example/gcsdkdemo/App;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public initFail(ILjava/lang/String;)V\n\n# æŒ‡å®šæ–¹æ³•ä¸­å¯ç”¨çš„éå‚å¯„å­˜å™¨æ•°é‡\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 21\nconst-string v0, \"cunzhang\"\nconst-string v1, \"initFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 22\nreturn-void\n.end method\n\n.method public initSuccess()V\n.locals 2\n.line 16\nconst-string v0, \"cunzhang\"\nconst-string v1, \"initSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 17\nreturn-void\n.end method\n```\n\n```java\n//MainActivity.java $ MainActivity.smali\npackage com.example.gcsdkdemo;\nimport androidx.appcompat.app.AppCompatActivity;\nimport android.os.Bundle;\nimport android.util.Log;\nimport android.view.View;\nimport com.primer.jsonlili.callback.AdCallback;\nimport com.primer.jsonlili.callback.LoginCallback;\nimport com.primer.jsonlili.callback.PayCallback;\nimport com.primer.jsonlili.core.GCSDK;\nimport com.primer.jsonlili.params.AdParams;\nimport com.primer.jsonlili.params.PayParams;\n\npublic class MainActivity extends AppCompatActivity {\n    private final String TAG = \"cunzhang\";\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n    }\n\n    public void onPay(View view) {\n        Log.d(TAG, \"onPay: \");\n        //åˆ›å»º PayParams å¯¹è±¡å¹¶å­˜å‚¨åˆ° v0ï¼Œ\n        //new-instance v0, Lcom/primer/jsonlili/params/PayParams;\n        //invoke-direct {v0}, Lcom/primer/jsonlili/params/PayParams;-><init>()V\n        \n        //.local v0, \"payParams\":Lcom/primer/jsonlili/params/PayParams;\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v1\n        //new-instance v2, Lcom/example/gcsdkdemo/MainActivity$1;\n        //invoke-direct {v2, p0}, Lcom/example/gcsdkdemo/MainActivity$1;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v1, v0, v2}, Lcom/primer/jsonlili/core/GCSDK;->pay(Lcom/primer/jsonlili/params/PayParams;Lcom/primer/jsonlili/callback/PayCallback;)V\n        \n        PayParams payParams = new PayParams();\n        GCSDK.getInstance().pay(payParams, new PayCallback() {\n            @Override\n            public void onPaySuccess() {\n                Log.d(TAG, \"onPaySuccess: \");\n            }\n\n            @Override\n            public void onPayFail(int i, String s) {\n                Log.d(TAG, \"onPayFail: \");\n            }\n        });\n    }\n\n    public void onLogin(View view) {\n        Log.d(TAG, \"onLogin: \");\n        //è°ƒç”¨ getInstanceï¼ŒæŠŠ getInstance è¿”å›çš„å¯¹è±¡å­˜å‚¨åˆ° v0ï¼Œåˆ›å»ºå†…éƒ¨ç±» LoginCallback å¯¹è±¡ï¼Œè°ƒç”¨å†…éƒ¨ç±»åˆå§‹åŒ–ï¼Œè°ƒç”¨ç™»å½•æ–¹æ³•\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v0\n        //new-instance v1, Lcom/example/gcsdkdemo/MainActivity$2;\n        //invoke-direct {v1, p0}, Lcom/example/gcsdkdemo/MainActivity$2;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->login(Lcom/primer/jsonlili/callback/LoginCallback;)V\n        \n        GCSDK.getInstance().login(new LoginCallback() {\n            @Override\n            public void onLoginSuccess() {\n                Log.d(TAG, \"onLoginSuccess: \");\n            }\n\n            @Override\n            public void inLoginFail(int i, String s) {\n                Log.d(TAG, \"inLoginFail: \");\n            }\n        });\n    }\n    \n\n    public void onOpenAd(View view) {\n        Log.d(TAG, \"onOpenAd: \");\n        \n        //new-instance v0, Lcom/primer/jsonlili/params/AdParams;\n        //invoke-direct {v0}, Lcom/primer/jsonlili/params/AdParams;-><init>()V\n        //.line 60\n        //.local v0, \"adParams\":Lcom/primer/jsonlili/params/AdParams;\n        //invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n        //move-result-object v1\n        //new-instance v2, Lcom/example/gcsdkdemo/MainActivity$3;\n        //invoke-direct {v2, p0}, Lcom/example/gcsdkdemo/MainActivity$3;-><init>(Lcom/example/gcsdkdemo/MainActivity;)V\n        //invoke-virtual {v1, v0, v2}, Lcom/primer/jsonlili/core/GCSDK;->openAd(Lcom/primer/jsonlili/params/AdParams;Lcom/primer/jsonlili/callback/AdCallback;)V\n\n        AdParams adParams = new AdParams();\n        GCSDK.getInstance().openAd(adParams, new AdCallback() {\n            @Override\n            public void onClick() {\n                Log.d(TAG, \"onClick: \");\n            }\n            @Override\n            public void onClickSkip() {\n                Log.d(TAG, \"onClickSkip: \");\n            }\n            @Override\n            public void onClose() {\n                Log.d(TAG, \"onClose: \");\n            }\n            @Override\n            public void onOpenFaild(int i, String s) {\n                Log.d(TAG, \"onOpenFaild: \");\n            }\n            @Override\n            public void onOpenSuccess() {\n                Log.d(TAG, \"onOpenSuccess: \");\n            }\n            @Override\n            public void onLoadBegin() {\n                Log.d(TAG, \"onLoadBegin: \");\n            }\n            @Override\n            public void onLoadFaild(int i, String s) {\n                Log.d(TAG, \"onLoadFaild: \");\n            }\n            @Override\n            public void onLoadComplete() {\n                Log.d(TAG, \"onLoadComplete: \");\n            }\n            @Override\n            public void onDownloadBegin() {\n                Log.d(TAG, \"onDownloadBegin: \");\n            }\n            @Override\n            public void onDownloadFail(int i, String s) {\n                Log.d(TAG, \"onDownloadFail: \");\n            }\n            @Override\n            public void onDownloadComplete() {\n                Log.d(TAG, \"onDownloadComplete: \");\n            }\n        });\n    }\n}\n```\n\nPayCallback å†…éƒ¨ç±»å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$1;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/PayCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onPay(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 28\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$1;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public onPayFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 36\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onPayFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 37\nreturn-void\n.end method\n\n.method public onPaySuccess()V\n.locals 2\n.line 31\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onPaySuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 32\nreturn-void\n.end method\n```\n\nå†…éƒ¨ç±» LoginCallback å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$2;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/LoginCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onLogin(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 43\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$2;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public inLoginFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 51\nconst-string v0, \"cunzhang\"\nconst-string v1, \"inLoginFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 52\nreturn-void\n.end method\n\n.method public onLoginSuccess()V\n.locals 2\n.line 46\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoginSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 47\nreturn-void\n.end method\n```\n\nAdCallback å†…éƒ¨ç±»å®ç°\n\n```java\n.class Lcom/example/gcsdkdemo/MainActivity$3;\n.super Ljava/lang/Object;\n.source \"MainActivity.java\"\n\n# interfaces\n.implements Lcom/primer/jsonlili/callback/AdCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\nvalue = Lcom/example/gcsdkdemo/MainActivity;->onOpenAd(Landroid/view/View;)V\n.end annotation\n\n.annotation system Ldalvik/annotation/InnerClass;\naccessFlags = 0x0\nname = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/gcsdkdemo/MainActivity;\n\n# direct methods\n.method constructor <init>(Lcom/example/gcsdkdemo/MainActivity;)V\n.locals 0\n.param p1, \"this$0\" # Lcom/example/gcsdkdemo/MainActivity;\n.line 60\niput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$3;->this$0:Lcom/example/gcsdkdemo/MainActivity;\ninvoke-direct {p0}, Ljava/lang/Object;-><init>()V\nreturn-void\n.end method\n\n# virtual methods\n.method public onClick()V\n.locals 2\n.line 63\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClick: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 64\nreturn-void\n.end method\n\n.method public onClickSkip()V\n.locals 2\n.line 68\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClickSkip: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 69\nreturn-void\n.end method\n\n.method public onClose()V\n.locals 2\n.line 73\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onClose: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 74\nreturn-void\n.end method\n\n.method public onDownloadBegin()V\n.locals 2\n.line 103\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadBegin: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 104\nreturn-void\n.end method\n\n.method public onDownloadComplete()V\n.locals 2\n.line 113\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadComplete: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 114\nreturn-void\n.end method\n\n.method public onDownloadFail(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 108\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onDownloadFail: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 109\nreturn-void\n.end method\n\n.method public onLoadBegin()V\n.locals 2\n.line 88\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadBegin: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 89\nreturn-void\n.end method\n\n.method public onLoadComplete()V\n.locals 2\n.line 98\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadComplete: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 99\nreturn-void\n.end method\n\n.method public onLoadFaild(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 93\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onLoadFaild: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 94\nreturn-void\n.end method\n\n.method public onOpenFaild(ILjava/lang/String;)V\n.locals 2\n.param p1, \"i\" # I\n.param p2, \"s\" # Ljava/lang/String;\n.line 78\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onOpenFaild: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 79\nreturn-void\n.end method\n\n.method public onOpenSuccess()V\n.locals 2\n.line 83\nconst-string v0, \"cunzhang\"\nconst-string v1, \"onOpenSuccess: \"\ninvoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n.line 84\nreturn-void\n.end method\n```\n\nç†Ÿèƒ½ç”Ÿå·§ï¼Œè¿™æ ·çš„ä»£ç çœ‹å¤šäº†è‡ªç„¶äº†è§£å’Œè®¤è¯†çš„è¯­æ³•ç­‰ä¹Ÿä¼šè¶Šå¤šï¼Œè¯»å–æ¥å°±æ²¡é‚£ä¹ˆè´¹åŠ²\n\n\n**æˆ‘ä»¬çš„åº”ç”¨**\n\nå‡å¦‚æˆ‘ä»¬å·²çŸ¥ä»£ç æ’å…¥ç‚¹ä½ç½®â€”â€”â€”â€”å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨çš„æ˜¯`æ‰¾åˆ°å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶æ‰€åœ¨ä½ç½®å¹¶æ’å…¥æ–°çš„ smali ä»£ç `ï¼Œæ’å…¥ä»£ç ä¸èƒ½å¼•å…¥æ–°çš„ç¼–è¯‘å™¨ç­‰é”™è¯¯\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/44d85c0db3e3955ffbe9fb8d82b82f72.png)\n\n# è¯•ç€æ¥å…¥ smali \n\n**1ã€æŠŠ sdk ç›¸å…³çš„ smali ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬åº”ç”¨åç¼–è¯‘åçš„å·¥ç¨‹ç›®å½•ä¸‹**\n\nè¿™é‡Œæˆ‘æ–°å»º `smali_classes9` ç›®å½•ï¼Œgcsdk æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä»£ç æ²¡æœ‰èµ„æºã€so æ–‡ä»¶ç­‰ï¼›å¦‚æœæœ‰ï¼Œä¹Ÿéœ€è¦å¤åˆ¶åˆ°å·¥ç¨‹çš„ç›¸åº”ç›®å½•ä¸‹ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿç¼–è¯‘æˆåŠŸã€è¿è¡ŒæœŸé—´èƒ½æ‰¾åˆ°è·¯å¾„æ­£ç¡®åŠ è½½ä»£ç ï¼Œè¿™æ˜¯é¡¹ç›®èƒ½å¤Ÿè¿è¡Œçš„å‰æã€‚\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/42ce50c1f4987d6caf1dadbb4b1ba80a.png)\n\nä¸‹é¢å°±å¼€å§‹å¾€åº”ç”¨ä¸­æ’å…¥ç‚¹å¤„æ’å…¥ sdk smali ä»£ç ã€‚\n\n**2ã€LeaderApp.java & LeaderApp.smali**\n```java\n.class public Lcom/example/leaderapp/ui/LeaderApp;\n.super Landroid/app/Application;\n.source \"LeaderApp.java\"\n\n# instance fields\n.field private final TAG:Ljava/lang/String;\n# 1ã€å®šä¹‰åˆå§‹åŒ–å›è°ƒå­—æ®µ \n.field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n\n# direct methods\n.method public constructor <init>()V\n .locals 1\n .line 6\n invoke-direct {p0}, Landroid/app/Application;-><init>()V\n .line 7\n const-string v0, \"leader\"\n iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;->TAG:Ljava/lang/String;\n# 2ã€åˆå§‹åŒ–æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»å¯¹è±¡\n new-instance v0, Lcom/example/leaderapp/ui/LeaderApp$1;\n invoke-direct {v0, p0}, Lcom/example/leaderapp/ui/LeaderApp$1;-><init>(Lcom/example/leaderapp/ui/LeaderApp;)V\n iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n return-void\n.end method\n\n# virtual methods\n.method public onCreate()V\n .locals 2\n .line 11\n invoke-super {p0}, Landroid/app/Application;->onCreate()V\n .line 12\n const-string v0, \"leader\"\n const-string v1, \"onCreate: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n# 3ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•\n invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n move-result-object v0\n iget-object v1, p0, Lcom/example/leaderapp/ui/LeaderApp;->mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;\n invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->init(Lcom/primer/jsonlili/callback/InitCallback;)V\n return-void\n.end method\n# 4ã€åˆ›å»º LeaderApp$1.smaliï¼Œå¹¶æ›´æ–°è·¯å¾„ã€ç±»ç­‰\n```\n\næ£€éªŒæ’å…¥æ˜¯å¦æ­£ç¡®å¹¶ç¬¦åˆæœŸæœ›ï¼Œå¯ä½¿ç”¨ VSCODE smali æ’ä»¶é€šè¿‡ä»£ç è½¬æ¢éªŒè¯\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/4c945faf21ac85feb9392dbba3f9f527.png)\n\nå¯¹æ¯”åŸå§‹é¡¹ç›®å’Œæ’å…¥åçš„æ•ˆæœæ˜¯å¦ä¸€è‡´\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/36199a2e95b678da1afe678f4f9ed9f3.png)\n\nå¯¹å®‰è£…åŒ…æ‰‹åŠ¨ç­¾åï¼Œè¿è¡ŒæŸ¥çœ‹æ—¥å¿—ï¼Œèƒ½çœ‹åˆ° sdk åˆå§‹åŒ–æ­£ç¡®ï¼Œè¯´æ˜ä¸Šè¿°æ¥å…¥æ˜¯æ— è¯¯çš„ã€‚\n\njarsigner -verbose -keystore [aa.keystore] [sign-app0.apk] [app-0.apk] key0\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/d9a2aa7640b31bea5158a5c79d08c34b.png)\n\n\n**æ³¨æ„âš ï¸ï¼š**\n\nåç¼–è¯‘ä½¿ç”¨ `java -jar apktool.jar d ***.apk`ï¼Œåœ¨å›ç¼–è¯‘æ—¶å€™å¯èƒ½å‡ºç°é”™è¯¯ï¼Œæ—¥å¿—ä¸­å‘ç° `res/` ç›®å½•åƒæ˜¯èµ„æºé—®é¢˜ã€‚\n\n```java\nW: invalid resource directory name: >/Users/jsonli/Desktop/demo/0603/app-0/app-0/res navigation\nbrut.androlib.AndrolibException: brut.common.BrutException: could not exec (exit code = 1):\n/Users/jsonli/Library/apktool/framework/1.apk, -S, \n/Users/jsonli/Desktop/demo/0603/app-0/app-0/res, -M, \n/Users/jsonli/Desktop/demo/0603/app-0/app-0/AndroidManifest.xml]\n```\n\nå°è¯•åœ¨åç¼–è¯‘æ—¶ä¸å¤„ç†èµ„æºå‘½ä»¤åŠ ä¸Š -r å‚æ•°`java -jar apktool.jar -r d ***.apk` æœç„¶èƒ½å¤Ÿæ­£å¸¸æ‰“åŒ…ï¼Œç»§ç»­å®Œæˆå‰©ä¸‹çš„æ¥å…¥å§ :)\n\n**3ã€HomeFragment$1.smaliã€HomeFrgment$2.smali**\n\n`HomeFragment$1.smali`: button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œç™»å½•è°ƒç”¨å¤„\n`HomeFragment$2.smali`: gcsdk ç™»å½•å›è°ƒ\n\n```java\n.class Lcom/example/leaderapp/ui/home/HomeFragment$1;\n.super Ljava/lang/Object;\n.source \"HomeFragment.java\"\n\n# interfaces\n.implements Landroid/view/View$OnClickListener;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\n value = Lcom/example/leaderapp/ui/home/HomeFragment;->onCreateView(Landroid/view/LayoutInflater;Landroid/view/ViewGroup;Landroid/os/Bundle;)Landroid/view/View;\n.end annotation\n.annotation system Ldalvik/annotation/InnerClass;\n accessFlags = 0x0\n name = null\n.end annotation\n\n# instance fields\n.field final synthetic this$0:Lcom/example/leaderapp/ui/home/HomeFragment;\n\n# direct methods\n.method constructor <init>(Lcom/example/leaderapp/ui/home/HomeFragment;)V\n .locals 0\n .param p1, \"this$0\" # Lcom/example/leaderapp/ui/home/HomeFragment;\n .line 40\n iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$1;->this$0:Lcom/example/leaderapp/ui/home/HomeFragment;\n invoke-direct {p0}, Ljava/lang/Object;-><init>()V\n return-void\n.end method\n\n# virtual methods\n.method public onClick(Landroid/view/View;)V\n .locals 3\n .param p1, \"view\" # Landroid/view/View;\n .line 43\n invoke-virtual {p1}, Landroid/view/View;->getContext()Landroid/content/Context;\n move-result-object v0\n const-string v1, \"\\u767b\\u5f55\"\n const/4 v2, 0x0\n invoke-static {v0, v1, v2}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;\n move-result-object v0\n invoke-virtual {v0}, Landroid/widget/Toast;->show()V\n .line 44\n const-string v0, \"leader\"\n const-string v1, \"onClick: login\"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n\n# 1ã€è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¿®æ”¹ç±»è·¯å¾„ã€å†…éƒ¨ç±»ï¼ˆç™»å½•å›è°ƒå®ç°ç±»ï¼‰\n invoke-static {}, Lcom/primer/jsonlili/core/GCSDK;->getInstance()Lcom/primer/jsonlili/core/GCSDK;\n move-result-object v0\n new-instance v1, Lcom/example/leaderapp/ui/home/HomeFragment$2;\n \n# å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œè¿™é‡Œçš„å¤–éƒ¨ç±»æ˜¯ button çš„ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤ä¼ å…¥ HomeFragment$1ï¼Œè€Œä¸æ˜¯ HomeFragment\n invoke-direct {v1, p0}, Lcom/example/leaderapp/ui/home/HomeFragment$2;-><init>(Lcom/example/leaderapp/ui/home/HomeFragment$1;)V\n invoke-virtual {v0, v1}, Lcom/primer/jsonlili/core/GCSDK;->login(Lcom/primer/jsonlili/callback/LoginCallback;)V\n return-void\n.end method\n```\n```java\n.class Lcom/example/leaderapp/ui/home/HomeFragment$2;\n.super Ljava/lang/Object;\n.source \"HomeFragment.java\"\n\n# 2ã€åˆ›å»ºå†…éƒ¨ç±»æ–‡ä»¶ï¼Œå¹¶æŠŠå¯¹åº”çš„ç™»å½•å›è°ƒä»£ç å¤åˆ¶è¿‡æ¥\n# 3ã€ä¿®æ”¹ç±»è·¯å¾„ .classã€.sourceã€\n# interfaces\n.implements Lcom/primer/jsonlili/callback/LoginCallback;\n\n# annotations\n.annotation system Ldalvik/annotation/EnclosingMethod;\n value = Lcom/example/leaderapp/ui/home/HomeFragment;->onLogin(Landroid/view/View;)V\n.end annotation\n.annotation system Ldalvik/annotation/InnerClass;\n accessFlags = 0x0\n name = null\n.end annotation\n\n# è¿™é‡Œä¼ å…¥çš„å¤–éƒ¨ç±»æ˜¯ button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤åˆå§‹åŒ–å‡½æ•°å’Œ this ç±»å‹åº”è¯¥æ˜¯ \n# instance fields\n.field final synthetic this$0:Lcom/example/leaderapp/ui/home/HomeFragment$1;\n\n# direct methods\n.method constructor <init>(Lcom/example/leaderapp/ui/home/HomeFragment$1;)V\n .locals 0\n .param p1, \"this$0\"\n \n# è¿™é‡Œä¹Ÿæ˜¯ HomeFragment$1\n iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$2;->this$0:Lcom/example/leaderapp/ui/home/HomeFragment$1;\n invoke-direct {p0}, Ljava/lang/Object;-><init>()V\n return-void\n.end method\n\n# virtual methods\n.method public inLoginFail(ILjava/lang/String;)V\n .locals 2\n .param p1, \"i\" # I\n .param p2, \"s\" # Ljava/lang/String;\n .line 51\n const-string v0, \"cunzhang\"\n const-string v1, \"inLoginFail: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n .line 52\n return-void\n.end method\n\n.method public onLoginSuccess()V\n .locals 2\n .line 46\n const-string v0, \"cunzhang\"\n const-string v1, \"onLoginSuccess: \"\n invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I\n .line 47\n return-void\n.end method\n```\n\n**4ã€NotificationsFragment.smaliã€DashboardFragment.smali**\n\nå› ä¸ºä»£ç ç®€å•ï¼Œä¸”é€»è¾‘ä¸€è‡´ï¼Œå‰©ä¸‹çš„æ”¯ä»˜å’Œå¹¿å‘Šæ¥å£ä»£ç å°±ä¸è´´äº†\n\n# æœ€åçš„æœ€å\n\n`0ã€`è·å– smail ä»£ç ï¼ˆä¸€èˆ¬æ˜¯æ ¹æ® java ä»£ç è·å– smail ä»£ç ï¼ŒåŒç†æ ¹æ® java ä»£ç è·å–å­—èŠ‚ç ï¼Œåœ¨ä»£ç é‡å¤šçš„æ—¶å€™è¾ƒéš¾ç›´æ¥å†™å‡ºå®Œæ•´çš„ smailã€å­—èŠ‚ç ï¼‰\n`1ã€`å¯»æ‰¾æ’å…¥ç‚¹ï¼Œsmali ä»£ç æ’å…¥ã€ä¿å­˜ã€æ’å…¥æ£€éªŒ\n`2ã€`æ‰“åŒ…ã€ç­¾åã€è¿è¡Œè°ƒè¯•æŸ¥çœ‹æ•ˆæœï¼ˆä¾æ­¤ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œè¿è¡Œç»“æœå’Œé¢„æœŸä¸€è‡´ï¼‰\n\n![image.png](https://img-blog.csdnimg.cn/img_convert/831157f13e5c535bafa42839e3f80257.png)\n\n\næ€è€ƒï¼š\n\nAï¼šä¸ºä»€ä¹ˆæ smali æ¥å…¥ï¼Œè¿™ä¸æ˜¯ç»™è‡ªå·±æ‰¾å‘å˜›\nBï¼šè¿™æ˜¯éœ€æ±‚ï¼Œä¸ºäº†è§£å†³é—®é¢˜ï¼›æˆ‘è§‰å¾—é‡ç‚¹æ˜¯å¯ä»¥æ‰©å±•çŸ¥è¯†\nAï¼šæ—¢ç„¶ä½ å·²æœ‰ apkï¼Œå¯ä»¥æŠŠå®ƒè½¬æ¢ä¸º java ä»£ç ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥ä¸æ›´æ¸…æ™°ã€çœäº‹ï¼Œé¿å…ç›²åŒºä¸å¥½å—ï¼Œè¿˜æ˜¯ä¸æ–¹ä¾¿\nBï¼šå¥½åƒ...ä¹Ÿ å¯ ä»¥â“\nAï¼šæˆ‘è§‰å¾—å¯ä»¥ï¼ŒAndroidFk å·¥å…·å¯ä»¥æŠŠ apk ç›´æ¥åç¼–è¯‘ä¸º android é¡¹ç›®ï¼ˆè‹¥åŠ å›ºã€åŠ å¯†çš„ apk å¯èƒ½å°±æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼‰\nBï¼šä¹Ÿæ˜¯ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥æ–¹ä¾¿å¤šäº†\nAï¼šæˆ‘åˆæœ‰ç–‘é—®äº†ï¼šå¦‚æœæ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ˜¯ä¸€ä¸ª aarèµ„æºæ–‡ä»¶ï¼ˆåŒ…å«èµ„æºç­‰æ–‡ä»¶ï¼‰ è€Œä¸æ˜¯ jarï¼ˆçº¯ Java ä»£ç ï¼‰ï¼Œæ¥å…¥ä¼šä¸ä¼šé‡åˆ°å…¶ä»–é—®é¢˜\nBï¼šåŒºåˆ«è‚¯å®šæ˜¯æœ‰ï¼Œå®æ“æ–¹çŸ¥æ™“\nAï¼šä¸‹æ¬¡ä½ æ¥ä¸€ä¸ªè¯•è¯•\nBï¼š... ...\nAï¼šè¿™ä¸å¯æ€•å•Šï¼ŒæŒç»­å­¦ä¹ ï¼Œæå‡å¹¿åº¦åŠæ³•æ€»æ¯”å›°éš¾å¤š\n","slug":"ä»smailæ¥å…¥ç¬¬ä¸‰æ–¹","published":1,"lang":"undefined","updated":"2022-09-26T12:56:19.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignst000ngaqp3o3phl19","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>é‡åˆ°è¿‡è¿™ç§åœºæ™¯å—</h1>\n<p>ä»€ä¹ˆæ—¶å€™è¦åˆ©ç”¨ smali è¯­è¨€å±‚é¢æ¥å…¥ç¬¬ä¸‰æ–¹ sdk ï¼Ÿä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ java æ¥å£ï¼Œä¸€ç›®äº†ç„¶ï¼Œæä¸ª smali ä¸æ˜¯æ²¡äº‹æ‰¾äº‹ï¼Ÿåœºæ™¯ä¸åŒï¼Œåœ¨æ²¡æœ‰åŠæ³•çš„æ—¶å€™è¿™å°±æ˜¯ä¸€ç§æ–¹æ³•ã€‚</p>\n<p>programer Aï¼š   å‘ä½ ä¸€ä¸ª apk æ–‡ä»¶ï¼Œå¸®æˆ‘çœ‹ä¸‹<br>\nprogramer Aï¼š   å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŸå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª APKï¼Œæˆ‘æƒ³æŠŠå’‹ä»¬çš„ sdk æ¥å…¥åˆ°é‡Œé¢ï¼Œæ€ä¹ˆæï¼Ÿ<br>\nprogramer Bï¼š   åº”è¯¥å¯ä»¥ï¼Œå¯ä»¥è¯•è¯•ä»¥å­—èŠ‚ç ã€smail å½¢å¼æ¥å…¥<br>\nprogramer Aï¼š   smail ï¼Ÿè¿™æ˜¯å•¥å•Šï¼<br>\nprogramer Bï¼š   è‡ªå·±æŸ¥èµ„æ–™ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>\n<p><strong>å—¯ï¼Ÿæ²¡æœ‰æ€è·¯ï¼Œä¸ç„¶å†™ä¸ª Demo çœ‹çœ‹å§</strong></p>\n<p>1ã€å‡†å¤‡ä¸€ä¸ª sdk: <code>gcsdk-1.0.0.jar</code><br>\n2ã€å‡†å¤‡ä¸€ä¸ª apk: <code>app-0.apk</code>ï¼ˆå‡è®¾æ˜¯æˆ‘ä»¬çš„åº”ç”¨ï¼‰<br>\n3ã€åˆ›å»ºä¸€ä¸ªç©ºç™½ Android é¡¹ç›®ï¼Œé¢„å¤‡æ¥å…¥ sdk: <code>app-1.apk</code>ï¼ˆå¤‡ç”¨ï¼‰</p>\n<p>æ¨¡æ‹Ÿå‡ ä¸ªå¯¹å¤–çš„æ¥å£ç®€å•ç”Ÿæˆä¸€ä¸ª jarï¼Œå®é™…ä¸­æ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ¥å£ä¹Ÿä¸ä¼šå¾ˆå¤æ‚ã€‚</p>\n<hr>\n<blockquote>\n<p>gcsdk-1.0.0ï¼ˆç¤ºä¾‹ï¼‰</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// åˆå§‹åŒ–</span></span><br><span class=\"line\">GCSDK.getInstance().init(<span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;gcsdk-åˆå§‹åŒ–æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;gcsdk-åˆå§‹åŒ–å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot;  error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//ç™»å½•</span></span><br><span class=\"line\">GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;ç™»å½•-æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;ç™»å½•-å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//å¹¿å‘Š        </span></span><br><span class=\"line\">AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ç‚¹å‡»&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ç‚¹å‡»è·³è¿‡&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-å…³é—­&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-æ‰“å¼€å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-æ‰“å¼€æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å¼€å§‹&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å®Œæˆ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å¼€å§‹&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å¤±è´¥ï¼šcode =&quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å®Œæˆ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ”¯ä»˜</span></span><br><span class=\"line\">PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">PayManager.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;æ”¯ä»˜-æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;æ”¯ä»˜-å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ç©ºç™½ Android é¡¹ç›®ï¼Œæ¨¡æ‹Ÿæ¥å…¥ gcsdkï¼Œæ¥å…¥å®Œæˆåæ‰“åŒ…å¤‡ç”¨ï¼Œç”Ÿæˆçš„ apk ç”¨äºè·å– smali ä»£ç </p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// App.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.app.Application;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.InitCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">App</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//åˆå§‹åŒ–å›è°ƒ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> InitCallback mInitCallback = <span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initSuccess: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initFail: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate();</span><br><span class=\"line\">        <span class=\"comment\">//gcsdk åˆå§‹åŒ–</span></span><br><span class=\"line\">        GCSDK.getInstance().init(mInitCallback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//MainActivity.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.os.Bundle;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.view.View;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.AdCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.LoginCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.PayCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.AdParams;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.PayParams;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">        setContentView(R.layout.activity_main);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPay</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onPay: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//æ”¯ä»˜æ¥å£</span></span><br><span class=\"line\">        PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">        GCSDK.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPaySuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPayFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLogin</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onLogin: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//ç™»å½•æ¥å£</span></span><br><span class=\"line\">        GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoginSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;inLoginFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenAd</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onOpenAd: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//å¹¿å‘Šæ¥å£</span></span><br><span class=\"line\">        AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">        GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClick: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClickSkip: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClose: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¾æ¬¡è§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f13a6793367598f0a03c93cb84c3a781.png\" alt=\"image.png\"></p>\n<p>å‡è®¾è¿™æ˜¯å’‹ä»¬çš„åº”ç”¨ï¼Œæ¥ç€è¦é¢„å¤‡æ¥å…¥</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/c999c536a59d0ae7df378a1c36b140f6.png\" alt=\"image.png\"></p>\n<h1>äº†è§£ä¸‹ smali</h1>\n<p><strong>1ã€è·å¾— smali</strong><br>\nä¸¤ä¸ªå®‰è£…åŒ…çš„ä»£ç éƒ½è¦åç¼–è¯‘è·å¾—</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.0</span>.jar [-r] d app-<span class=\"number\">0.</span>apk</span><br><span class=\"line\"></span><br><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.0</span>.jar [-r] d app-<span class=\"number\">1.</span>apk</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬çš„åº”ç”¨</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f45e85873cea6435fddc0548f82af6ee.png\" alt=\"image.png\"></p>\n<p>ç©ºç™½é¡¹ç›®æ¨¡æ‹Ÿ Java æ¥å£æ¨¡æ‹Ÿæ¥å…¥</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b6ff5a0f01ab90cb1132849cb6d138f0.png\" alt=\"image.png\"></p>\n<p><strong>2ã€äº†è§£é¡¹ç›®çš„ smali</strong></p>\n<p>å¯ä»¥ä½¿ç”¨ VSCode æ’ä»¶ smaliã€smali2java æ–¹ä¾¿æŸ¥çœ‹ smali ä»£ç ï¼Œä»¥ä¸‹ smali ä¸»è¦æ˜¯åˆ—ä¸¾ä¸ sdk ç›¸å…³ï¼Œäº†è§£ smali å…·ä½“å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//App.java &amp; App.smal</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.app.Application;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.InitCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">App</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å®šä¹‰å±æ€§ mInitCallbackï¼š      .field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºå¯¹è±¡ï¼š                    new-instance v0, Lcom/example/gcsdkdemo/App$1;</span></span><br><span class=\"line\">    <span class=\"comment\">//è°ƒç”¨ç±»éšè—åˆå§‹åŒ–æ–¹æ³• &lt;init&gt;ï¼š   invoke-direct &#123;v0, p0&#125;, Lcom/example/gcsdkdemo/App$1;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/App;)V</span></span><br><span class=\"line\">    <span class=\"comment\">//æŠŠåˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™æœ¬åœ°å˜é‡ï¼š     iput-object v0, p0, Lcom/example/gcsdkdemo/App;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> InitCallback mInitCallback = <span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initSuccess: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initFail: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ï¼š         invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//ç§»åŠ¨æ“ä½œæ•°ï¼š              move-result-object v0</span></span><br><span class=\"line\">        <span class=\"comment\">//ä»æ“ä½œæ•°æ ˆè·å–ä¸¤ä¸ªæ“ä½œæ•°ï¼š  iget-object v1, p0, Lcom/example/gcsdkdemo/App;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨å®ç°æ–¹æ³•ï¼š            invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;init(Lcom/primer/jsonlili/callback/InitCallback;)V</span></span><br><span class=\"line\">        GCSDK.getInstance().init(mInitCallback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>InitCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># è¡¨æ˜ç±»é™å®šå</span><br><span class=\"line\">.class Lcom/example/gcsdkdemo/App$<span class=\"number\">1</span>;</span><br><span class=\"line\"># çˆ¶ç±»</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\"># æºæ–‡ä»¶åç§°</span><br><span class=\"line\">.source <span class=\"string\">&quot;App.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingClass;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># å†…éƒ¨ç±»</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±» this å¼•ç”¨</span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/App;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\"># è¡Œæ•°ï¼Œåˆ é™¤ä¸å½±å“ä»£ç æ‰§è¡Œ</span><br><span class=\"line\">.line <span class=\"number\">13</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/App$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">initFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"># æŒ‡å®šæ–¹æ³•ä¸­å¯ç”¨çš„éå‚å¯„å­˜å™¨æ•°é‡</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;initFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 16</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;initSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">17</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//MainActivity.java $ MainActivity.smali</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.os.Bundle;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.view.View;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.AdCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.LoginCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.PayCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.AdParams;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.PayParams;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">        setContentView(R.layout.activity_main);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPay</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onPay: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//åˆ›å»º PayParams å¯¹è±¡å¹¶å­˜å‚¨åˆ° v0ï¼Œ</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v0, Lcom/primer/jsonlili/params/PayParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v0&#125;, Lcom/primer/jsonlili/params/PayParams;-&gt;&lt;init&gt;()V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//.local v0, &quot;payParams&quot;:Lcom/primer/jsonlili/params/PayParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v1</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v2, Lcom/example/gcsdkdemo/MainActivity$1;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v2, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$1;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v1, v0, v2&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;pay(Lcom/primer/jsonlili/params/PayParams;Lcom/primer/jsonlili/callback/PayCallback;)V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">        GCSDK.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPaySuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPayFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLogin</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onLogin: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨ getInstanceï¼ŒæŠŠ getInstance è¿”å›çš„å¯¹è±¡å­˜å‚¨åˆ° v0ï¼Œåˆ›å»ºå†…éƒ¨ç±» LoginCallback å¯¹è±¡ï¼Œè°ƒç”¨å†…éƒ¨ç±»åˆå§‹åŒ–ï¼Œè°ƒç”¨ç™»å½•æ–¹æ³•</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v0</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v1, Lcom/example/gcsdkdemo/MainActivity$2;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v1, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$2;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;login(Lcom/primer/jsonlili/callback/LoginCallback;)V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoginSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;inLoginFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenAd</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onOpenAd: &quot;</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//new-instance v0, Lcom/primer/jsonlili/params/AdParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v0&#125;, Lcom/primer/jsonlili/params/AdParams;-&gt;&lt;init&gt;()V</span></span><br><span class=\"line\">        <span class=\"comment\">//.line 60</span></span><br><span class=\"line\">        <span class=\"comment\">//.local v0, &quot;adParams&quot;:Lcom/primer/jsonlili/params/AdParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v1</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v2, Lcom/example/gcsdkdemo/MainActivity$3;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v2, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$3;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v1, v0, v2&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;openAd(Lcom/primer/jsonlili/params/AdParams;Lcom/primer/jsonlili/callback/AdCallback;)V</span></span><br><span class=\"line\"></span><br><span class=\"line\">        AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">        GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClick: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClickSkip: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClose: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PayCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">1</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/PayCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onPay(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">28</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onPayFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">36</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onPayFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">37</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 31</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onPaySuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>å†…éƒ¨ç±» LoginCallback å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">2</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/LoginCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onLogin(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">43</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">2</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">51</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;inLoginFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">52</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 46</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoginSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">47</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>AdCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">3</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/AdCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onOpenAd(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">60</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">3</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClick</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 63</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClick: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 68</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClickSkip: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">69</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClose</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 73</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClose: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">74</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 103</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onDownloadBegin: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">104</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 113</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onDownloadComplete: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">114</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">108</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onDownloadFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">109</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 88</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoadBegin: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">89</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 98</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoadComplete: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">99</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">93</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onLoadFaild: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">94</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">78</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onOpenFaild: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">79</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 83</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onOpenSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">84</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>ç†Ÿèƒ½ç”Ÿå·§ï¼Œè¿™æ ·çš„ä»£ç çœ‹å¤šäº†è‡ªç„¶äº†è§£å’Œè®¤è¯†çš„è¯­æ³•ç­‰ä¹Ÿä¼šè¶Šå¤šï¼Œè¯»å–æ¥å°±æ²¡é‚£ä¹ˆè´¹åŠ²</p>\n<p><strong>æˆ‘ä»¬çš„åº”ç”¨</strong></p>\n<p>å‡å¦‚æˆ‘ä»¬å·²çŸ¥ä»£ç æ’å…¥ç‚¹ä½ç½®â€”â€”â€”â€”å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨çš„æ˜¯<code>æ‰¾åˆ°å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶æ‰€åœ¨ä½ç½®å¹¶æ’å…¥æ–°çš„ smali ä»£ç </code>ï¼Œæ’å…¥ä»£ç ä¸èƒ½å¼•å…¥æ–°çš„ç¼–è¯‘å™¨ç­‰é”™è¯¯</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/44d85c0db3e3955ffbe9fb8d82b82f72.png\" alt=\"image.png\"></p>\n<h1>è¯•ç€æ¥å…¥ smali</h1>\n<p><strong>1ã€æŠŠ sdk ç›¸å…³çš„ smali ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬åº”ç”¨åç¼–è¯‘åçš„å·¥ç¨‹ç›®å½•ä¸‹</strong></p>\n<p>è¿™é‡Œæˆ‘æ–°å»º <code>smali_classes9</code> ç›®å½•ï¼Œgcsdk æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä»£ç æ²¡æœ‰èµ„æºã€so æ–‡ä»¶ç­‰ï¼›å¦‚æœæœ‰ï¼Œä¹Ÿéœ€è¦å¤åˆ¶åˆ°å·¥ç¨‹çš„ç›¸åº”ç›®å½•ä¸‹ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿç¼–è¯‘æˆåŠŸã€è¿è¡ŒæœŸé—´èƒ½æ‰¾åˆ°è·¯å¾„æ­£ç¡®åŠ è½½ä»£ç ï¼Œè¿™æ˜¯é¡¹ç›®èƒ½å¤Ÿè¿è¡Œçš„å‰æã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/42ce50c1f4987d6caf1dadbb4b1ba80a.png\" alt=\"image.png\"></p>\n<p>ä¸‹é¢å°±å¼€å§‹å¾€åº”ç”¨ä¸­æ’å…¥ç‚¹å¤„æ’å…¥ sdk smali ä»£ç ã€‚</p>\n<p><strong>2ã€LeaderApp.java &amp; LeaderApp.smali</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class <span class=\"keyword\">public</span> Lcom/example/leaderapp/ui/LeaderApp;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Landroid/app/Application;</span><br><span class=\"line\">.source <span class=\"string\">&quot;LeaderApp.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TAG:Ljava/lang/String;</span><br><span class=\"line\"># 1ã€å®šä¹‰åˆå§‹åŒ–å›è°ƒå­—æ®µ </span><br><span class=\"line\">.field <span class=\"keyword\">private</span> mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method <span class=\"keyword\">public</span> constructor &lt;init&gt;()V</span><br><span class=\"line\"> .locals <span class=\"number\">1</span></span><br><span class=\"line\"> .line <span class=\"number\">6</span></span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Landroid/app/Application;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> .line <span class=\"number\">7</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;TAG:Ljava/lang/String;</span><br><span class=\"line\"># 2ã€åˆå§‹åŒ–æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»å¯¹è±¡</span><br><span class=\"line\"> <span class=\"keyword\">new</span>-instance v0, Lcom/example/leaderapp/ui/LeaderApp$<span class=\"number\">1</span>;</span><br><span class=\"line\"> invoke-direct &#123;v0, p0&#125;, Lcom/example/leaderapp/ui/LeaderApp$<span class=\"number\">1</span>;-&gt;&lt;init&gt;(Lcom/example/leaderapp/ui/LeaderApp;)V</span><br><span class=\"line\"> iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .line 11</span></span><br><span class=\"line\"><span class=\"function\"> invoke-<span class=\"keyword\">super</span> </span>&#123;p0&#125;, Landroid/app/Application;-&gt;onCreate()V</span><br><span class=\"line\"> .line <span class=\"number\">12</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onCreate: &quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"># 3ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> iget-object v1, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"> invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;init(Lcom/primer/jsonlili/callback/InitCallback;)V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"># 4ã€åˆ›å»º LeaderApp$1.smaliï¼Œå¹¶æ›´æ–°è·¯å¾„ã€ç±»ç­‰</span><br></pre></td></tr></table></figure>\n<p>æ£€éªŒæ’å…¥æ˜¯å¦æ­£ç¡®å¹¶ç¬¦åˆæœŸæœ›ï¼Œå¯ä½¿ç”¨ VSCODE smali æ’ä»¶é€šè¿‡ä»£ç è½¬æ¢éªŒè¯</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/4c945faf21ac85feb9392dbba3f9f527.png\" alt=\"image.png\"></p>\n<p>å¯¹æ¯”åŸå§‹é¡¹ç›®å’Œæ’å…¥åçš„æ•ˆæœæ˜¯å¦ä¸€è‡´</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/36199a2e95b678da1afe678f4f9ed9f3.png\" alt=\"image.png\"></p>\n<p>å¯¹å®‰è£…åŒ…æ‰‹åŠ¨ç­¾åï¼Œè¿è¡ŒæŸ¥çœ‹æ—¥å¿—ï¼Œèƒ½çœ‹åˆ° sdk åˆå§‹åŒ–æ­£ç¡®ï¼Œè¯´æ˜ä¸Šè¿°æ¥å…¥æ˜¯æ— è¯¯çš„ã€‚</p>\n<p>jarsigner -verbose -keystore [aa.keystore] [sign-app0.apk] [app-0.apk] key0</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/d9a2aa7640b31bea5158a5c79d08c34b.png\" alt=\"image.png\"></p>\n<p><strong>æ³¨æ„âš ï¸ï¼š</strong></p>\n<p>åç¼–è¯‘ä½¿ç”¨ <code>java -jar apktool.jar d ***.apk</code>ï¼Œåœ¨å›ç¼–è¯‘æ—¶å€™å¯èƒ½å‡ºç°é”™è¯¯ï¼Œæ—¥å¿—ä¸­å‘ç° <code>res/</code> ç›®å½•åƒæ˜¯èµ„æºé—®é¢˜ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">W: invalid resource directory name: &gt;/Users/jsonli/Desktop/demo/<span class=\"number\">0603</span>/app-<span class=\"number\">0</span>/app-<span class=\"number\">0</span>/res navigation</span><br><span class=\"line\">brut.androlib.AndrolibException: brut.common.BrutException: <span class=\"function\">could not <span class=\"title\">exec</span> <span class=\"params\">(exit code = <span class=\"number\">1</span>)</span>:</span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Library/apktool/framework/1.apk, -S, </span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Desktop/demo/0603/app-0/app-0/res, -M, </span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Desktop/demo/0603/app-0/app-0/AndroidManifest.xml]</span></span><br></pre></td></tr></table></figure>\n<p>å°è¯•åœ¨åç¼–è¯‘æ—¶ä¸å¤„ç†èµ„æºå‘½ä»¤åŠ ä¸Š -r å‚æ•°<code>java -jar apktool.jar -r d ***.apk</code> æœç„¶èƒ½å¤Ÿæ­£å¸¸æ‰“åŒ…ï¼Œç»§ç»­å®Œæˆå‰©ä¸‹çš„æ¥å…¥å§ :)</p>\n<p><strong>3ã€HomeFragment$1.smaliã€HomeFrgment$2.smali</strong></p>\n<p><code>HomeFragment$1.smali</code>: button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œç™»å½•è°ƒç”¨å¤„<br>\n<code>HomeFragment$2.smali</code>: gcsdk ç™»å½•å›è°ƒ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;HomeFragment.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Landroid/view/View$OnClickListener;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\"> value = Lcom/example/leaderapp/ui/home/HomeFragment;-&gt;onCreateView(Landroid/view/LayoutInflater;Landroid/view/ViewGroup;Landroid/os/Bundle;)Landroid/view/View;</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\"> accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\"> name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment;)V</span><br><span class=\"line\"> .locals <span class=\"number\">0</span></span><br><span class=\"line\"> .param p1, &quot;this$0&quot; # Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"> .line <span class=\"number\">40</span></span><br><span class=\"line\"> iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClick</span><span class=\"params\">(Landroid/view/View;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 3</span></span><br><span class=\"line\"><span class=\"function\"> .param p1, &quot;view&quot; # Landroid/view/View</span>;</span><br><span class=\"line\"> .line <span class=\"number\">43</span></span><br><span class=\"line\"> invoke-virtual &#123;p1&#125;, Landroid/view/View;-&gt;getContext()Landroid/content/Context;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;\\u767b\\u5f55&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>/<span class=\"number\">4</span> v2, <span class=\"number\">0x0</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1, v2&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class=\"line\"> .line <span class=\"number\">44</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onClick: login&quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"></span><br><span class=\"line\"># 1ã€è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¿®æ”¹ç±»è·¯å¾„ã€å†…éƒ¨ç±»ï¼ˆç™»å½•å›è°ƒå®ç°ç±»ï¼‰</span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> <span class=\"keyword\">new</span>-instance v1, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"># å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œè¿™é‡Œçš„å¤–éƒ¨ç±»æ˜¯ button çš„ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤ä¼ å…¥ HomeFragment$1ï¼Œè€Œä¸æ˜¯ HomeFragment</span><br><span class=\"line\"> invoke-direct &#123;v1, p0&#125;, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;-&gt;&lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;)V</span><br><span class=\"line\"> invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;login(Lcom/primer/jsonlili/callback/LoginCallback;)V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;HomeFragment.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 2ã€åˆ›å»ºå†…éƒ¨ç±»æ–‡ä»¶ï¼Œå¹¶æŠŠå¯¹åº”çš„ç™»å½•å›è°ƒä»£ç å¤åˆ¶è¿‡æ¥</span><br><span class=\"line\"># 3ã€ä¿®æ”¹ç±»è·¯å¾„ .classã€.sourceã€</span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/LoginCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\"> value = Lcom/example/leaderapp/ui/home/HomeFragment;-&gt;onLogin(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\"> accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\"> name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># è¿™é‡Œä¼ å…¥çš„å¤–éƒ¨ç±»æ˜¯ button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤åˆå§‹åŒ–å‡½æ•°å’Œ this ç±»å‹åº”è¯¥æ˜¯ </span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;)V</span><br><span class=\"line\"> .locals <span class=\"number\">0</span></span><br><span class=\"line\"> .param p1, <span class=\"string\">&quot;this$0&quot;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"># è¿™é‡Œä¹Ÿæ˜¯ HomeFragment$1</span><br><span class=\"line\"> iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\"> .param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\"> .line <span class=\"number\">51</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;inLoginFail: &quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"> .line <span class=\"number\">52</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .line 46</span></span><br><span class=\"line\"><span class=\"function\"> <span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"> <span class=\"keyword\">const</span>-string v1, &quot;onLoginSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\"> invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"> .line <span class=\"number\">47</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p><strong>4ã€NotificationsFragment.smaliã€DashboardFragment.smali</strong></p>\n<p>å› ä¸ºä»£ç ç®€å•ï¼Œä¸”é€»è¾‘ä¸€è‡´ï¼Œå‰©ä¸‹çš„æ”¯ä»˜å’Œå¹¿å‘Šæ¥å£ä»£ç å°±ä¸è´´äº†</p>\n<h1>æœ€åçš„æœ€å</h1>\n<p><code>0ã€</code>è·å– smail ä»£ç ï¼ˆä¸€èˆ¬æ˜¯æ ¹æ® java ä»£ç è·å– smail ä»£ç ï¼ŒåŒç†æ ¹æ® java ä»£ç è·å–å­—èŠ‚ç ï¼Œåœ¨ä»£ç é‡å¤šçš„æ—¶å€™è¾ƒéš¾ç›´æ¥å†™å‡ºå®Œæ•´çš„ smailã€å­—èŠ‚ç ï¼‰<br>\n<code>1ã€</code>å¯»æ‰¾æ’å…¥ç‚¹ï¼Œsmali ä»£ç æ’å…¥ã€ä¿å­˜ã€æ’å…¥æ£€éªŒ<br>\n<code>2ã€</code>æ‰“åŒ…ã€ç­¾åã€è¿è¡Œè°ƒè¯•æŸ¥çœ‹æ•ˆæœï¼ˆä¾æ­¤ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œè¿è¡Œç»“æœå’Œé¢„æœŸä¸€è‡´ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/831157f13e5c535bafa42839e3f80257.png\" alt=\"image.png\"></p>\n<p>æ€è€ƒï¼š</p>\n<p>Aï¼šä¸ºä»€ä¹ˆæ smali æ¥å…¥ï¼Œè¿™ä¸æ˜¯ç»™è‡ªå·±æ‰¾å‘å˜›<br>\nBï¼šè¿™æ˜¯éœ€æ±‚ï¼Œä¸ºäº†è§£å†³é—®é¢˜ï¼›æˆ‘è§‰å¾—é‡ç‚¹æ˜¯å¯ä»¥æ‰©å±•çŸ¥è¯†<br>\nAï¼šæ—¢ç„¶ä½ å·²æœ‰ apkï¼Œå¯ä»¥æŠŠå®ƒè½¬æ¢ä¸º java ä»£ç ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥ä¸æ›´æ¸…æ™°ã€çœäº‹ï¼Œé¿å…ç›²åŒºä¸å¥½å—ï¼Œè¿˜æ˜¯ä¸æ–¹ä¾¿<br>\nBï¼šå¥½åƒâ€¦ä¹Ÿ å¯ ä»¥â“<br>\nAï¼šæˆ‘è§‰å¾—å¯ä»¥ï¼ŒAndroidFk å·¥å…·å¯ä»¥æŠŠ apk ç›´æ¥åç¼–è¯‘ä¸º android é¡¹ç›®ï¼ˆè‹¥åŠ å›ºã€åŠ å¯†çš„ apk å¯èƒ½å°±æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼‰<br>\nBï¼šä¹Ÿæ˜¯ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥æ–¹ä¾¿å¤šäº†<br>\nAï¼šæˆ‘åˆæœ‰ç–‘é—®äº†ï¼šå¦‚æœæ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ˜¯ä¸€ä¸ª aarèµ„æºæ–‡ä»¶ï¼ˆåŒ…å«èµ„æºç­‰æ–‡ä»¶ï¼‰ è€Œä¸æ˜¯ jarï¼ˆçº¯ Java ä»£ç ï¼‰ï¼Œæ¥å…¥ä¼šä¸ä¼šé‡åˆ°å…¶ä»–é—®é¢˜<br>\nBï¼šåŒºåˆ«è‚¯å®šæ˜¯æœ‰ï¼Œå®æ“æ–¹çŸ¥æ™“<br>\nAï¼šä¸‹æ¬¡ä½ æ¥ä¸€ä¸ªè¯•è¯•<br>\nBï¼šâ€¦ â€¦<br>\nAï¼šè¿™ä¸å¯æ€•å•Šï¼ŒæŒç»­å­¦ä¹ ï¼Œæå‡å¹¿åº¦åŠæ³•æ€»æ¯”å›°éš¾å¤š</p>\n","site":{"data":{}},"excerpt":"","more":"<h1>é‡åˆ°è¿‡è¿™ç§åœºæ™¯å—</h1>\n<p>ä»€ä¹ˆæ—¶å€™è¦åˆ©ç”¨ smali è¯­è¨€å±‚é¢æ¥å…¥ç¬¬ä¸‰æ–¹ sdk ï¼Ÿä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ java æ¥å£ï¼Œä¸€ç›®äº†ç„¶ï¼Œæä¸ª smali ä¸æ˜¯æ²¡äº‹æ‰¾äº‹ï¼Ÿåœºæ™¯ä¸åŒï¼Œåœ¨æ²¡æœ‰åŠæ³•çš„æ—¶å€™è¿™å°±æ˜¯ä¸€ç§æ–¹æ³•ã€‚</p>\n<p>programer Aï¼š   å‘ä½ ä¸€ä¸ª apk æ–‡ä»¶ï¼Œå¸®æˆ‘çœ‹ä¸‹<br>\nprogramer Aï¼š   å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŸå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª APKï¼Œæˆ‘æƒ³æŠŠå’‹ä»¬çš„ sdk æ¥å…¥åˆ°é‡Œé¢ï¼Œæ€ä¹ˆæï¼Ÿ<br>\nprogramer Bï¼š   åº”è¯¥å¯ä»¥ï¼Œå¯ä»¥è¯•è¯•ä»¥å­—èŠ‚ç ã€smail å½¢å¼æ¥å…¥<br>\nprogramer Aï¼š   smail ï¼Ÿè¿™æ˜¯å•¥å•Šï¼<br>\nprogramer Bï¼š   è‡ªå·±æŸ¥èµ„æ–™ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>\n<p><strong>å—¯ï¼Ÿæ²¡æœ‰æ€è·¯ï¼Œä¸ç„¶å†™ä¸ª Demo çœ‹çœ‹å§</strong></p>\n<p>1ã€å‡†å¤‡ä¸€ä¸ª sdk: <code>gcsdk-1.0.0.jar</code><br>\n2ã€å‡†å¤‡ä¸€ä¸ª apk: <code>app-0.apk</code>ï¼ˆå‡è®¾æ˜¯æˆ‘ä»¬çš„åº”ç”¨ï¼‰<br>\n3ã€åˆ›å»ºä¸€ä¸ªç©ºç™½ Android é¡¹ç›®ï¼Œé¢„å¤‡æ¥å…¥ sdk: <code>app-1.apk</code>ï¼ˆå¤‡ç”¨ï¼‰</p>\n<p>æ¨¡æ‹Ÿå‡ ä¸ªå¯¹å¤–çš„æ¥å£ç®€å•ç”Ÿæˆä¸€ä¸ª jarï¼Œå®é™…ä¸­æ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ¥å£ä¹Ÿä¸ä¼šå¾ˆå¤æ‚ã€‚</p>\n<hr>\n<blockquote>\n<p>gcsdk-1.0.0ï¼ˆç¤ºä¾‹ï¼‰</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// åˆå§‹åŒ–</span></span><br><span class=\"line\">GCSDK.getInstance().init(<span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;gcsdk-åˆå§‹åŒ–æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;gcsdk-åˆå§‹åŒ–å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot;  error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//ç™»å½•</span></span><br><span class=\"line\">GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;ç™»å½•-æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;ç™»å½•-å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//å¹¿å‘Š        </span></span><br><span class=\"line\">AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ç‚¹å‡»&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ç‚¹å‡»è·³è¿‡&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-å…³é—­&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-æ‰“å¼€å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-æ‰“å¼€æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å¼€å§‹&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-åŠ è½½å®Œæˆ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å¼€å§‹&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å¤±è´¥ï¼šcode =&quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;å¹¿å‘Š-ä¸‹è½½å®Œæˆ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//æ”¯ä»˜</span></span><br><span class=\"line\">PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">PayManager.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;æ”¯ä»˜-æˆåŠŸ&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> code, String error)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;æ”¯ä»˜-å¤±è´¥ï¼šcode = &quot;</span> + code + <span class=\"string\">&quot; error = &quot;</span> + error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ç©ºç™½ Android é¡¹ç›®ï¼Œæ¨¡æ‹Ÿæ¥å…¥ gcsdkï¼Œæ¥å…¥å®Œæˆåæ‰“åŒ…å¤‡ç”¨ï¼Œç”Ÿæˆçš„ apk ç”¨äºè·å– smali ä»£ç </p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// App.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.app.Application;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.InitCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">App</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//åˆå§‹åŒ–å›è°ƒ</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> InitCallback mInitCallback = <span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initSuccess: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initFail: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate();</span><br><span class=\"line\">        <span class=\"comment\">//gcsdk åˆå§‹åŒ–</span></span><br><span class=\"line\">        GCSDK.getInstance().init(mInitCallback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//MainActivity.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.os.Bundle;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.view.View;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.AdCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.LoginCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.PayCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.AdParams;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.PayParams;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">        setContentView(R.layout.activity_main);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPay</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onPay: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//æ”¯ä»˜æ¥å£</span></span><br><span class=\"line\">        PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">        GCSDK.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPaySuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPayFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLogin</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onLogin: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//ç™»å½•æ¥å£</span></span><br><span class=\"line\">        GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoginSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;inLoginFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenAd</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onOpenAd: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//å¹¿å‘Šæ¥å£</span></span><br><span class=\"line\">        AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">        GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClick: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClickSkip: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClose: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¾æ¬¡è§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f13a6793367598f0a03c93cb84c3a781.png\" alt=\"image.png\"></p>\n<p>å‡è®¾è¿™æ˜¯å’‹ä»¬çš„åº”ç”¨ï¼Œæ¥ç€è¦é¢„å¤‡æ¥å…¥</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/c999c536a59d0ae7df378a1c36b140f6.png\" alt=\"image.png\"></p>\n<h1>äº†è§£ä¸‹ smali</h1>\n<p><strong>1ã€è·å¾— smali</strong><br>\nä¸¤ä¸ªå®‰è£…åŒ…çš„ä»£ç éƒ½è¦åç¼–è¯‘è·å¾—</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.0</span>.jar [-r] d app-<span class=\"number\">0.</span>apk</span><br><span class=\"line\"></span><br><span class=\"line\">java -jar apktool_2<span class=\"number\">.6</span><span class=\"number\">.0</span>.jar [-r] d app-<span class=\"number\">1.</span>apk</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬çš„åº”ç”¨</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/f45e85873cea6435fddc0548f82af6ee.png\" alt=\"image.png\"></p>\n<p>ç©ºç™½é¡¹ç›®æ¨¡æ‹Ÿ Java æ¥å£æ¨¡æ‹Ÿæ¥å…¥</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/b6ff5a0f01ab90cb1132849cb6d138f0.png\" alt=\"image.png\"></p>\n<p><strong>2ã€äº†è§£é¡¹ç›®çš„ smali</strong></p>\n<p>å¯ä»¥ä½¿ç”¨ VSCode æ’ä»¶ smaliã€smali2java æ–¹ä¾¿æŸ¥çœ‹ smali ä»£ç ï¼Œä»¥ä¸‹ smali ä¸»è¦æ˜¯åˆ—ä¸¾ä¸ sdk ç›¸å…³ï¼Œäº†è§£ smali å…·ä½“å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//App.java &amp; App.smal</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.app.Application;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.InitCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">App</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//å®šä¹‰å±æ€§ mInitCallbackï¼š      .field private mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">    <span class=\"comment\">//åˆ›å»ºå¯¹è±¡ï¼š                    new-instance v0, Lcom/example/gcsdkdemo/App$1;</span></span><br><span class=\"line\">    <span class=\"comment\">//è°ƒç”¨ç±»éšè—åˆå§‹åŒ–æ–¹æ³• &lt;init&gt;ï¼š   invoke-direct &#123;v0, p0&#125;, Lcom/example/gcsdkdemo/App$1;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/App;)V</span></span><br><span class=\"line\">    <span class=\"comment\">//æŠŠåˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™æœ¬åœ°å˜é‡ï¼š     iput-object v0, p0, Lcom/example/gcsdkdemo/App;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> InitCallback mInitCallback = <span class=\"keyword\">new</span> InitCallback() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initSuccess: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">            Log.d(TAG, <span class=\"string\">&quot;initFail: &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ï¼š         invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//ç§»åŠ¨æ“ä½œæ•°ï¼š              move-result-object v0</span></span><br><span class=\"line\">        <span class=\"comment\">//ä»æ“ä½œæ•°æ ˆè·å–ä¸¤ä¸ªæ“ä½œæ•°ï¼š  iget-object v1, p0, Lcom/example/gcsdkdemo/App;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span></span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨å®ç°æ–¹æ³•ï¼š            invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;init(Lcom/primer/jsonlili/callback/InitCallback;)V</span></span><br><span class=\"line\">        GCSDK.getInstance().init(mInitCallback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>InitCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># è¡¨æ˜ç±»é™å®šå</span><br><span class=\"line\">.class Lcom/example/gcsdkdemo/App$<span class=\"number\">1</span>;</span><br><span class=\"line\"># çˆ¶ç±»</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\"># æºæ–‡ä»¶åç§°</span><br><span class=\"line\">.source <span class=\"string\">&quot;App.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingClass;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># å†…éƒ¨ç±»</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±» this å¼•ç”¨</span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/App;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\"># è¡Œæ•°ï¼Œåˆ é™¤ä¸å½±å“ä»£ç æ‰§è¡Œ</span><br><span class=\"line\">.line <span class=\"number\">13</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/App$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/App;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">initFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"># æŒ‡å®šæ–¹æ³•ä¸­å¯ç”¨çš„éå‚å¯„å­˜å™¨æ•°é‡</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;initFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">initSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 16</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;initSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">17</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//MainActivity.java $ MainActivity.smali</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.example.gcsdkdemo;</span><br><span class=\"line\"><span class=\"keyword\">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.os.Bundle;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.util.Log;</span><br><span class=\"line\"><span class=\"keyword\">import</span> android.view.View;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.AdCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.LoginCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.callback.PayCallback;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.core.GCSDK;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.AdParams;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.primer.jsonlili.params.PayParams;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;cunzhang&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">        setContentView(R.layout.activity_main);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPay</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onPay: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//åˆ›å»º PayParams å¯¹è±¡å¹¶å­˜å‚¨åˆ° v0ï¼Œ</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v0, Lcom/primer/jsonlili/params/PayParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v0&#125;, Lcom/primer/jsonlili/params/PayParams;-&gt;&lt;init&gt;()V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//.local v0, &quot;payParams&quot;:Lcom/primer/jsonlili/params/PayParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v1</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v2, Lcom/example/gcsdkdemo/MainActivity$1;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v2, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$1;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v1, v0, v2&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;pay(Lcom/primer/jsonlili/params/PayParams;Lcom/primer/jsonlili/callback/PayCallback;)V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        PayParams payParams = <span class=\"keyword\">new</span> PayParams();</span><br><span class=\"line\">        GCSDK.getInstance().pay(payParams, <span class=\"keyword\">new</span> PayCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPaySuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPayFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onPayFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLogin</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onLogin: &quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//è°ƒç”¨ getInstanceï¼ŒæŠŠ getInstance è¿”å›çš„å¯¹è±¡å­˜å‚¨åˆ° v0ï¼Œåˆ›å»ºå†…éƒ¨ç±» LoginCallback å¯¹è±¡ï¼Œè°ƒç”¨å†…éƒ¨ç±»åˆå§‹åŒ–ï¼Œè°ƒç”¨ç™»å½•æ–¹æ³•</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v0</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v1, Lcom/example/gcsdkdemo/MainActivity$2;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v1, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$2;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;login(Lcom/primer/jsonlili/callback/LoginCallback;)V</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        GCSDK.getInstance().login(<span class=\"keyword\">new</span> LoginCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoginSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;inLoginFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenAd</span><span class=\"params\">(View view)</span> </span>&#123;</span><br><span class=\"line\">        Log.d(TAG, <span class=\"string\">&quot;onOpenAd: &quot;</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//new-instance v0, Lcom/primer/jsonlili/params/AdParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v0&#125;, Lcom/primer/jsonlili/params/AdParams;-&gt;&lt;init&gt;()V</span></span><br><span class=\"line\">        <span class=\"comment\">//.line 60</span></span><br><span class=\"line\">        <span class=\"comment\">//.local v0, &quot;adParams&quot;:Lcom/primer/jsonlili/params/AdParams;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-static &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span></span><br><span class=\"line\">        <span class=\"comment\">//move-result-object v1</span></span><br><span class=\"line\">        <span class=\"comment\">//new-instance v2, Lcom/example/gcsdkdemo/MainActivity$3;</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-direct &#123;v2, p0&#125;, Lcom/example/gcsdkdemo/MainActivity$3;-&gt;&lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span></span><br><span class=\"line\">        <span class=\"comment\">//invoke-virtual &#123;v1, v0, v2&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;openAd(Lcom/primer/jsonlili/params/AdParams;Lcom/primer/jsonlili/callback/AdCallback;)V</span></span><br><span class=\"line\"></span><br><span class=\"line\">        AdParams adParams = <span class=\"keyword\">new</span> AdParams();</span><br><span class=\"line\">        GCSDK.getInstance().openAd(adParams, <span class=\"keyword\">new</span> AdCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClick: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClickSkip: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onClose: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onOpenSuccess: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadFaild: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onLoadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadBegin: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(<span class=\"keyword\">int</span> i, String s)</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadFail: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                Log.d(TAG, <span class=\"string\">&quot;onDownloadComplete: &quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PayCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">1</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/PayCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onPay(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">28</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onPayFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">36</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onPayFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">37</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onPaySuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 31</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onPaySuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>å†…éƒ¨ç±» LoginCallback å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">2</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/LoginCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onLogin(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">43</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">2</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">51</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;inLoginFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">52</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 46</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoginSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">47</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>AdCallback å†…éƒ¨ç±»å®ç°</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">3</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;MainActivity.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/AdCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\">value = Lcom/example/gcsdkdemo/MainActivity;-&gt;onOpenAd(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\">accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\">name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/gcsdkdemo/MainActivity;)V</span><br><span class=\"line\">.locals <span class=\"number\">0</span></span><br><span class=\"line\">.param p1, &quot;this$0&quot; # Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">.line <span class=\"number\">60</span></span><br><span class=\"line\">iput-object p1, p0, Lcom/example/gcsdkdemo/MainActivity$<span class=\"number\">3</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/gcsdkdemo/MainActivity;</span><br><span class=\"line\">invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClick</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 63</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClick: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClickSkip</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 68</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClickSkip: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">69</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClose</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 73</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onClose: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">74</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadBegin</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 103</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onDownloadBegin: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">104</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadComplete</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 113</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onDownloadComplete: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">114</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onDownloadFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">108</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onDownloadFail: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">109</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadBegin</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 88</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoadBegin: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">89</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadComplete</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 98</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onLoadComplete: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">99</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoadFaild</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">93</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onLoadFaild: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">94</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onOpenFaild</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\">.param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\">.line <span class=\"number\">78</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onOpenFaild: &quot;</span></span><br><span class=\"line\">invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">79</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onOpenSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\">.locals 2</span></span><br><span class=\"line\"><span class=\"function\">.line 83</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">const</span>-string v1, &quot;onOpenSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\">invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\">.line <span class=\"number\">84</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p>ç†Ÿèƒ½ç”Ÿå·§ï¼Œè¿™æ ·çš„ä»£ç çœ‹å¤šäº†è‡ªç„¶äº†è§£å’Œè®¤è¯†çš„è¯­æ³•ç­‰ä¹Ÿä¼šè¶Šå¤šï¼Œè¯»å–æ¥å°±æ²¡é‚£ä¹ˆè´¹åŠ²</p>\n<p><strong>æˆ‘ä»¬çš„åº”ç”¨</strong></p>\n<p>å‡å¦‚æˆ‘ä»¬å·²çŸ¥ä»£ç æ’å…¥ç‚¹ä½ç½®â€”â€”â€”â€”å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨çš„æ˜¯<code>æ‰¾åˆ°å¯¹åº”æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶æ‰€åœ¨ä½ç½®å¹¶æ’å…¥æ–°çš„ smali ä»£ç </code>ï¼Œæ’å…¥ä»£ç ä¸èƒ½å¼•å…¥æ–°çš„ç¼–è¯‘å™¨ç­‰é”™è¯¯</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/44d85c0db3e3955ffbe9fb8d82b82f72.png\" alt=\"image.png\"></p>\n<h1>è¯•ç€æ¥å…¥ smali</h1>\n<p><strong>1ã€æŠŠ sdk ç›¸å…³çš„ smali ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬åº”ç”¨åç¼–è¯‘åçš„å·¥ç¨‹ç›®å½•ä¸‹</strong></p>\n<p>è¿™é‡Œæˆ‘æ–°å»º <code>smali_classes9</code> ç›®å½•ï¼Œgcsdk æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä»£ç æ²¡æœ‰èµ„æºã€so æ–‡ä»¶ç­‰ï¼›å¦‚æœæœ‰ï¼Œä¹Ÿéœ€è¦å¤åˆ¶åˆ°å·¥ç¨‹çš„ç›¸åº”ç›®å½•ä¸‹ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿç¼–è¯‘æˆåŠŸã€è¿è¡ŒæœŸé—´èƒ½æ‰¾åˆ°è·¯å¾„æ­£ç¡®åŠ è½½ä»£ç ï¼Œè¿™æ˜¯é¡¹ç›®èƒ½å¤Ÿè¿è¡Œçš„å‰æã€‚</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/42ce50c1f4987d6caf1dadbb4b1ba80a.png\" alt=\"image.png\"></p>\n<p>ä¸‹é¢å°±å¼€å§‹å¾€åº”ç”¨ä¸­æ’å…¥ç‚¹å¤„æ’å…¥ sdk smali ä»£ç ã€‚</p>\n<p><strong>2ã€LeaderApp.java &amp; LeaderApp.smali</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class <span class=\"keyword\">public</span> Lcom/example/leaderapp/ui/LeaderApp;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Landroid/app/Application;</span><br><span class=\"line\">.source <span class=\"string\">&quot;LeaderApp.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TAG:Ljava/lang/String;</span><br><span class=\"line\"># 1ã€å®šä¹‰åˆå§‹åŒ–å›è°ƒå­—æ®µ </span><br><span class=\"line\">.field <span class=\"keyword\">private</span> mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method <span class=\"keyword\">public</span> constructor &lt;init&gt;()V</span><br><span class=\"line\"> .locals <span class=\"number\">1</span></span><br><span class=\"line\"> .line <span class=\"number\">6</span></span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Landroid/app/Application;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> .line <span class=\"number\">7</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;TAG:Ljava/lang/String;</span><br><span class=\"line\"># 2ã€åˆå§‹åŒ–æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»å¯¹è±¡</span><br><span class=\"line\"> <span class=\"keyword\">new</span>-instance v0, Lcom/example/leaderapp/ui/LeaderApp$<span class=\"number\">1</span>;</span><br><span class=\"line\"> invoke-direct &#123;v0, p0&#125;, Lcom/example/leaderapp/ui/LeaderApp$<span class=\"number\">1</span>;-&gt;&lt;init&gt;(Lcom/example/leaderapp/ui/LeaderApp;)V</span><br><span class=\"line\"> iput-object v0, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .line 11</span></span><br><span class=\"line\"><span class=\"function\"> invoke-<span class=\"keyword\">super</span> </span>&#123;p0&#125;, Landroid/app/Application;-&gt;onCreate()V</span><br><span class=\"line\"> .line <span class=\"number\">12</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onCreate: &quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"># 3ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> iget-object v1, p0, Lcom/example/leaderapp/ui/LeaderApp;-&gt;mInitCallback:Lcom/primer/jsonlili/callback/InitCallback;</span><br><span class=\"line\"> invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;init(Lcom/primer/jsonlili/callback/InitCallback;)V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"># 4ã€åˆ›å»º LeaderApp$1.smaliï¼Œå¹¶æ›´æ–°è·¯å¾„ã€ç±»ç­‰</span><br></pre></td></tr></table></figure>\n<p>æ£€éªŒæ’å…¥æ˜¯å¦æ­£ç¡®å¹¶ç¬¦åˆæœŸæœ›ï¼Œå¯ä½¿ç”¨ VSCODE smali æ’ä»¶é€šè¿‡ä»£ç è½¬æ¢éªŒè¯</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/4c945faf21ac85feb9392dbba3f9f527.png\" alt=\"image.png\"></p>\n<p>å¯¹æ¯”åŸå§‹é¡¹ç›®å’Œæ’å…¥åçš„æ•ˆæœæ˜¯å¦ä¸€è‡´</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/36199a2e95b678da1afe678f4f9ed9f3.png\" alt=\"image.png\"></p>\n<p>å¯¹å®‰è£…åŒ…æ‰‹åŠ¨ç­¾åï¼Œè¿è¡ŒæŸ¥çœ‹æ—¥å¿—ï¼Œèƒ½çœ‹åˆ° sdk åˆå§‹åŒ–æ­£ç¡®ï¼Œè¯´æ˜ä¸Šè¿°æ¥å…¥æ˜¯æ— è¯¯çš„ã€‚</p>\n<p>jarsigner -verbose -keystore [aa.keystore] [sign-app0.apk] [app-0.apk] key0</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/d9a2aa7640b31bea5158a5c79d08c34b.png\" alt=\"image.png\"></p>\n<p><strong>æ³¨æ„âš ï¸ï¼š</strong></p>\n<p>åç¼–è¯‘ä½¿ç”¨ <code>java -jar apktool.jar d ***.apk</code>ï¼Œåœ¨å›ç¼–è¯‘æ—¶å€™å¯èƒ½å‡ºç°é”™è¯¯ï¼Œæ—¥å¿—ä¸­å‘ç° <code>res/</code> ç›®å½•åƒæ˜¯èµ„æºé—®é¢˜ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">W: invalid resource directory name: &gt;/Users/jsonli/Desktop/demo/<span class=\"number\">0603</span>/app-<span class=\"number\">0</span>/app-<span class=\"number\">0</span>/res navigation</span><br><span class=\"line\">brut.androlib.AndrolibException: brut.common.BrutException: <span class=\"function\">could not <span class=\"title\">exec</span> <span class=\"params\">(exit code = <span class=\"number\">1</span>)</span>:</span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Library/apktool/framework/1.apk, -S, </span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Desktop/demo/0603/app-0/app-0/res, -M, </span></span><br><span class=\"line\"><span class=\"function\">/Users/jsonli/Desktop/demo/0603/app-0/app-0/AndroidManifest.xml]</span></span><br></pre></td></tr></table></figure>\n<p>å°è¯•åœ¨åç¼–è¯‘æ—¶ä¸å¤„ç†èµ„æºå‘½ä»¤åŠ ä¸Š -r å‚æ•°<code>java -jar apktool.jar -r d ***.apk</code> æœç„¶èƒ½å¤Ÿæ­£å¸¸æ‰“åŒ…ï¼Œç»§ç»­å®Œæˆå‰©ä¸‹çš„æ¥å…¥å§ :)</p>\n<p><strong>3ã€HomeFragment$1.smaliã€HomeFrgment$2.smali</strong></p>\n<p><code>HomeFragment$1.smali</code>: button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œç™»å½•è°ƒç”¨å¤„<br>\n<code>HomeFragment$2.smali</code>: gcsdk ç™»å½•å›è°ƒ</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;HomeFragment.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Landroid/view/View$OnClickListener;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\"> value = Lcom/example/leaderapp/ui/home/HomeFragment;-&gt;onCreateView(Landroid/view/LayoutInflater;Landroid/view/ViewGroup;Landroid/os/Bundle;)Landroid/view/View;</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\"> accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\"> name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment;)V</span><br><span class=\"line\"> .locals <span class=\"number\">0</span></span><br><span class=\"line\"> .param p1, &quot;this$0&quot; # Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"> .line <span class=\"number\">40</span></span><br><span class=\"line\"> iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment;</span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onClick</span><span class=\"params\">(Landroid/view/View;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 3</span></span><br><span class=\"line\"><span class=\"function\"> .param p1, &quot;view&quot; # Landroid/view/View</span>;</span><br><span class=\"line\"> .line <span class=\"number\">43</span></span><br><span class=\"line\"> invoke-virtual &#123;p1&#125;, Landroid/view/View;-&gt;getContext()Landroid/content/Context;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;\\u767b\\u5f55&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>/<span class=\"number\">4</span> v2, <span class=\"number\">0x0</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1, v2&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class=\"line\"> .line <span class=\"number\">44</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;leader&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;onClick: login&quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"></span><br><span class=\"line\"># 1ã€è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¿®æ”¹ç±»è·¯å¾„ã€å†…éƒ¨ç±»ï¼ˆç™»å½•å›è°ƒå®ç°ç±»ï¼‰</span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;getInstance()Lcom/primer/jsonlili/core/GCSDK;</span><br><span class=\"line\"> move-result-object v0</span><br><span class=\"line\"> <span class=\"keyword\">new</span>-instance v1, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"># å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œè¿™é‡Œçš„å¤–éƒ¨ç±»æ˜¯ button çš„ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤ä¼ å…¥ HomeFragment$1ï¼Œè€Œä¸æ˜¯ HomeFragment</span><br><span class=\"line\"> invoke-direct &#123;v1, p0&#125;, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;-&gt;&lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;)V</span><br><span class=\"line\"> invoke-virtual &#123;v0, v1&#125;, Lcom/primer/jsonlili/core/GCSDK;-&gt;login(Lcom/primer/jsonlili/callback/LoginCallback;)V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.class Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;</span><br><span class=\"line\">.<span class=\"keyword\">super</span> Ljava/lang/Object;</span><br><span class=\"line\">.source <span class=\"string\">&quot;HomeFragment.java&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 2ã€åˆ›å»ºå†…éƒ¨ç±»æ–‡ä»¶ï¼Œå¹¶æŠŠå¯¹åº”çš„ç™»å½•å›è°ƒä»£ç å¤åˆ¶è¿‡æ¥</span><br><span class=\"line\"># 3ã€ä¿®æ”¹ç±»è·¯å¾„ .classã€.sourceã€</span><br><span class=\"line\"># interfaces</span><br><span class=\"line\">.implements Lcom/primer/jsonlili/callback/LoginCallback;</span><br><span class=\"line\"></span><br><span class=\"line\"># annotations</span><br><span class=\"line\">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class=\"line\"> value = Lcom/example/leaderapp/ui/home/HomeFragment;-&gt;onLogin(Landroid/view/View;)V</span><br><span class=\"line\">.end annotation</span><br><span class=\"line\">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class=\"line\"> accessFlags = <span class=\"number\">0x0</span></span><br><span class=\"line\"> name = <span class=\"keyword\">null</span></span><br><span class=\"line\">.end annotation</span><br><span class=\"line\"></span><br><span class=\"line\"># è¿™é‡Œä¼ å…¥çš„å¤–éƒ¨ç±»æ˜¯ button ç‚¹å‡»äº‹ä»¶å®ç°ç±»ï¼Œå› æ­¤åˆå§‹åŒ–å‡½æ•°å’Œ this ç±»å‹åº”è¯¥æ˜¯ </span><br><span class=\"line\"># instance fields</span><br><span class=\"line\">.field <span class=\"keyword\">final</span> synthetic <span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"># direct methods</span><br><span class=\"line\">.method constructor &lt;init&gt;(Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;)V</span><br><span class=\"line\"> .locals <span class=\"number\">0</span></span><br><span class=\"line\"> .param p1, <span class=\"string\">&quot;this$0&quot;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"># è¿™é‡Œä¹Ÿæ˜¯ HomeFragment$1</span><br><span class=\"line\"> iput-object p1, p0, Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">2</span>;-&gt;<span class=\"keyword\">this</span>$<span class=\"number\">0</span>:Lcom/example/leaderapp/ui/home/HomeFragment$<span class=\"number\">1</span>;</span><br><span class=\"line\"> invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\"># virtual methods</span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">inLoginFail</span><span class=\"params\">(ILjava/lang/String;)</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .param p1, &quot;i&quot; # I</span></span><br><span class=\"line\"><span class=\"function\"> .param p2, &quot;s&quot; # Ljava/lang/String</span>;</span><br><span class=\"line\"> .line <span class=\"number\">51</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v0, <span class=\"string\">&quot;cunzhang&quot;</span></span><br><span class=\"line\"> <span class=\"keyword\">const</span>-string v1, <span class=\"string\">&quot;inLoginFail: &quot;</span></span><br><span class=\"line\"> invoke-<span class=\"keyword\">static</span> &#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"> .line <span class=\"number\">52</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br><span class=\"line\"></span><br><span class=\"line\">.<span class=\"function\">method <span class=\"keyword\">public</span> <span class=\"title\">onLoginSuccess</span><span class=\"params\">()</span>V</span></span><br><span class=\"line\"><span class=\"function\"> .locals 2</span></span><br><span class=\"line\"><span class=\"function\"> .line 46</span></span><br><span class=\"line\"><span class=\"function\"> <span class=\"keyword\">const</span>-string v0, &quot;cunzhang&quot;</span></span><br><span class=\"line\"><span class=\"function\"> <span class=\"keyword\">const</span>-string v1, &quot;onLoginSuccess: &quot;</span></span><br><span class=\"line\"><span class=\"function\"> invoke-<span class=\"keyword\">static</span> </span>&#123;v0, v1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</span><br><span class=\"line\"> .line <span class=\"number\">47</span></span><br><span class=\"line\"> <span class=\"keyword\">return</span>-<span class=\"keyword\">void</span></span><br><span class=\"line\">.end method</span><br></pre></td></tr></table></figure>\n<p><strong>4ã€NotificationsFragment.smaliã€DashboardFragment.smali</strong></p>\n<p>å› ä¸ºä»£ç ç®€å•ï¼Œä¸”é€»è¾‘ä¸€è‡´ï¼Œå‰©ä¸‹çš„æ”¯ä»˜å’Œå¹¿å‘Šæ¥å£ä»£ç å°±ä¸è´´äº†</p>\n<h1>æœ€åçš„æœ€å</h1>\n<p><code>0ã€</code>è·å– smail ä»£ç ï¼ˆä¸€èˆ¬æ˜¯æ ¹æ® java ä»£ç è·å– smail ä»£ç ï¼ŒåŒç†æ ¹æ® java ä»£ç è·å–å­—èŠ‚ç ï¼Œåœ¨ä»£ç é‡å¤šçš„æ—¶å€™è¾ƒéš¾ç›´æ¥å†™å‡ºå®Œæ•´çš„ smailã€å­—èŠ‚ç ï¼‰<br>\n<code>1ã€</code>å¯»æ‰¾æ’å…¥ç‚¹ï¼Œsmali ä»£ç æ’å…¥ã€ä¿å­˜ã€æ’å…¥æ£€éªŒ<br>\n<code>2ã€</code>æ‰“åŒ…ã€ç­¾åã€è¿è¡Œè°ƒè¯•æŸ¥çœ‹æ•ˆæœï¼ˆä¾æ­¤ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œè¿è¡Œç»“æœå’Œé¢„æœŸä¸€è‡´ï¼‰</p>\n<p><img src=\"https://img-blog.csdnimg.cn/img_convert/831157f13e5c535bafa42839e3f80257.png\" alt=\"image.png\"></p>\n<p>æ€è€ƒï¼š</p>\n<p>Aï¼šä¸ºä»€ä¹ˆæ smali æ¥å…¥ï¼Œè¿™ä¸æ˜¯ç»™è‡ªå·±æ‰¾å‘å˜›<br>\nBï¼šè¿™æ˜¯éœ€æ±‚ï¼Œä¸ºäº†è§£å†³é—®é¢˜ï¼›æˆ‘è§‰å¾—é‡ç‚¹æ˜¯å¯ä»¥æ‰©å±•çŸ¥è¯†<br>\nAï¼šæ—¢ç„¶ä½ å·²æœ‰ apkï¼Œå¯ä»¥æŠŠå®ƒè½¬æ¢ä¸º java ä»£ç ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥ä¸æ›´æ¸…æ™°ã€çœäº‹ï¼Œé¿å…ç›²åŒºä¸å¥½å—ï¼Œè¿˜æ˜¯ä¸æ–¹ä¾¿<br>\nBï¼šå¥½åƒâ€¦ä¹Ÿ å¯ ä»¥â“<br>\nAï¼šæˆ‘è§‰å¾—å¯ä»¥ï¼ŒAndroidFk å·¥å…·å¯ä»¥æŠŠ apk ç›´æ¥åç¼–è¯‘ä¸º android é¡¹ç›®ï¼ˆè‹¥åŠ å›ºã€åŠ å¯†çš„ apk å¯èƒ½å°±æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼‰<br>\nBï¼šä¹Ÿæ˜¯ï¼Œåœ¨ java ä»£ç ä¸Šæ¥å…¥æ–¹ä¾¿å¤šäº†<br>\nAï¼šæˆ‘åˆæœ‰ç–‘é—®äº†ï¼šå¦‚æœæ¥å…¥çš„ç¬¬ä¸‰æ–¹ sdk æ˜¯ä¸€ä¸ª aarèµ„æºæ–‡ä»¶ï¼ˆåŒ…å«èµ„æºç­‰æ–‡ä»¶ï¼‰ è€Œä¸æ˜¯ jarï¼ˆçº¯ Java ä»£ç ï¼‰ï¼Œæ¥å…¥ä¼šä¸ä¼šé‡åˆ°å…¶ä»–é—®é¢˜<br>\nBï¼šåŒºåˆ«è‚¯å®šæ˜¯æœ‰ï¼Œå®æ“æ–¹çŸ¥æ™“<br>\nAï¼šä¸‹æ¬¡ä½ æ¥ä¸€ä¸ªè¯•è¯•<br>\nBï¼šâ€¦ â€¦<br>\nAï¼šè¿™ä¸å¯æ€•å•Šï¼ŒæŒç»­å­¦ä¹ ï¼Œæå‡å¹¿åº¦åŠæ³•æ€»æ¯”å›°éš¾å¤š</p>\n"},{"title":"æˆ‘çš„ Tools for daily","catalog":true,"date":"2022-10-15T04:27:58.000Z","subtitle":"å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨","header-img":"/img/2210/mine_bookmark.jpg","sticky":12,"_content":"\n# æºç \n\n- [å®˜æ–¹ Android æºç ](https://android.googlesource.com/platform/)\n\n\n# Github\n\n> æˆ‘ä¸ä¼šé€ è½®å­ï¼Œä½†å¸Œæœ›å¯¹æ­¤æœ‰ç‚¹äº†è§£\n\n- [å·¥å…·ç±» AndroidUtilCode](https://github.com/Blankj/AndroidUtilCode/blob/master/lib/utilcode/README-CN.md)\n- [å­—èŠ‚ç ç¼–è¾‘å·¥å…· Recaf](https://github.com/Col-E/Recaf)\n- [å·¥å…· smali](https://github.com/JesusFreke/smali)\n- [æ­å»ºæœ¬åœ° Json Server](https://github.com/typicode/json-server)\n- [è¶…çº§æƒé™ Magisk](https://github.com/topjohnwu/Magisk)\n- [å­—èŠ‚ç æ“ä½œåº“ ASM](https://gitlab.ow2.org/asm/asm)\n- [ä½ ä¹Ÿå¯ç¼–å†™ hook Xposted](https://github.com/asLody/SandHook)\n- [è¶…çº§æƒé™ VitualXposted](https://github.com/android-hacker/VirtualXposed)\n- [Unity èµ„æºä¿®æ”¹ UABE](https://github.com/SeriousCache/UABE)\n- [æ–‡å­—è¯†åˆ« Android tess-tow](https://github.com/rmtheis/tess-two)\n- [åŠ¨ç”» Android lottie](https://lottiefiles.com/search?q=file%20conversion&category=animations&type=free)\n- [dex2jar è½¬æ¢](https://github.com/pxb1988/dex2jar)\n- [jadx](https://github.com/skylot/jadx)\n- [å†…æ ¸ epic](https://github.com/tiann/epic/blob/master/README_cn.md)\n- [ä½ ä¹Ÿå¯ä»¥ hook LSPosted](https://github.com/LSPosed/LSPosed)\n- [dex æ§åˆ¶æµæ··æ·† - BlackObfuscator](https://github.com/Familyye/BlackObfuscator)\n\n\n# Android å­¦ä¹ \n\n- [Android åŸºç¡€çŸ¥è¯†](https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode)\n- [ç© Android](https://www.wanandroid.com)\n- [å®˜ç½‘çŸ¥è¯†ç‚¹](https://developer.android.com/training/system-ui/immersive?hl=zh-cn)\n- [å¤§ä½¬åšå®¢ Gityuan](http://gityuan.com)\n\n\n# Java å­¦ä¹ \n\n- [å®˜ç½‘æ–‡æ¡£ JVM](https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-2.html)\n- [zip æ–‡ä»¶æ ¼å¼](https://thismj.cn/2019/02/14/qian-xi-zip-ge-shi/)\n\n\n# é€†å‘\n\n- [å¾çˆ±ç ´è§£](https://www.52pojie.cn)\n- [å®‰è£…åŒ…åˆ†æ - é­”ç›¾å®‰å…¨](https://www.maldun.com)\n- [å®‰è£…åŒ…æŠ¥æ¯’åˆ†æ - Virustotal](https://www.virustotal.com/gui/home/upload)\n- [å®‰è£…åŒ…åç¼–è¯‘åˆ†æ - æ‘¸ç“œ](https://mogua.co)\n- [é€†å‘åŸºç¡€çŸ¥è¯†](https://github.com/crifan/android_app_security_crack)\n- [å®‰è£…åŒ…åç¼–è¯‘æˆ Android å·¥ç¨‹ - Faker](https://github.com/Efaker/FakerAndroid)\n\n\n# å›¾ç‰‡\n\n> å›¾ç‰‡å¯ä»¥ä½œä¸ºç‚¹ç¼€ï¼Œç¾å›¾å¯ä»¥æ¬£èµ\n\n- [å…è´¹æ­£ç‰ˆé«˜æ¸…å›¾ç‰‡](https://pixabay.com/zh/)\n- [4K å½¼å²¸å›¾ç½‘](http://pic.netbian.com)\n\n# å…¶ä»–\n\n- [æ¶ˆé™¤å›¾ç‰‡èƒŒæ™¯](https://www.remove.bg/zh/upload)\n- [åœ¨çº¿å­—ç¬¦ä¸ªæ•°ç»Ÿè®¡](https://www.eteste.com)\n- [åœ¨çº¿æ—¥å¿—è¿‡æ»¤](https://tilipa.zlsam.com/#/tool?id=199&name=æ—¥å¿—åˆ†æå·¥å…·)\n","source":"_posts/undefined/æˆ‘çš„å·¥å…·.md","raw":"---\ntitle: æˆ‘çš„ Tools for daily\ncatalog: true\ndate: 2022-10-15 12:27:58\nsubtitle: å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨\nheader-img: /img/2210/mine_bookmark.jpg\ntags: å·¥å…·\ncategories:\nsticky: 12\n---\n\n# æºç \n\n- [å®˜æ–¹ Android æºç ](https://android.googlesource.com/platform/)\n\n\n# Github\n\n> æˆ‘ä¸ä¼šé€ è½®å­ï¼Œä½†å¸Œæœ›å¯¹æ­¤æœ‰ç‚¹äº†è§£\n\n- [å·¥å…·ç±» AndroidUtilCode](https://github.com/Blankj/AndroidUtilCode/blob/master/lib/utilcode/README-CN.md)\n- [å­—èŠ‚ç ç¼–è¾‘å·¥å…· Recaf](https://github.com/Col-E/Recaf)\n- [å·¥å…· smali](https://github.com/JesusFreke/smali)\n- [æ­å»ºæœ¬åœ° Json Server](https://github.com/typicode/json-server)\n- [è¶…çº§æƒé™ Magisk](https://github.com/topjohnwu/Magisk)\n- [å­—èŠ‚ç æ“ä½œåº“ ASM](https://gitlab.ow2.org/asm/asm)\n- [ä½ ä¹Ÿå¯ç¼–å†™ hook Xposted](https://github.com/asLody/SandHook)\n- [è¶…çº§æƒé™ VitualXposted](https://github.com/android-hacker/VirtualXposed)\n- [Unity èµ„æºä¿®æ”¹ UABE](https://github.com/SeriousCache/UABE)\n- [æ–‡å­—è¯†åˆ« Android tess-tow](https://github.com/rmtheis/tess-two)\n- [åŠ¨ç”» Android lottie](https://lottiefiles.com/search?q=file%20conversion&category=animations&type=free)\n- [dex2jar è½¬æ¢](https://github.com/pxb1988/dex2jar)\n- [jadx](https://github.com/skylot/jadx)\n- [å†…æ ¸ epic](https://github.com/tiann/epic/blob/master/README_cn.md)\n- [ä½ ä¹Ÿå¯ä»¥ hook LSPosted](https://github.com/LSPosed/LSPosed)\n- [dex æ§åˆ¶æµæ··æ·† - BlackObfuscator](https://github.com/Familyye/BlackObfuscator)\n\n\n# Android å­¦ä¹ \n\n- [Android åŸºç¡€çŸ¥è¯†](https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode)\n- [ç© Android](https://www.wanandroid.com)\n- [å®˜ç½‘çŸ¥è¯†ç‚¹](https://developer.android.com/training/system-ui/immersive?hl=zh-cn)\n- [å¤§ä½¬åšå®¢ Gityuan](http://gityuan.com)\n\n\n# Java å­¦ä¹ \n\n- [å®˜ç½‘æ–‡æ¡£ JVM](https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-2.html)\n- [zip æ–‡ä»¶æ ¼å¼](https://thismj.cn/2019/02/14/qian-xi-zip-ge-shi/)\n\n\n# é€†å‘\n\n- [å¾çˆ±ç ´è§£](https://www.52pojie.cn)\n- [å®‰è£…åŒ…åˆ†æ - é­”ç›¾å®‰å…¨](https://www.maldun.com)\n- [å®‰è£…åŒ…æŠ¥æ¯’åˆ†æ - Virustotal](https://www.virustotal.com/gui/home/upload)\n- [å®‰è£…åŒ…åç¼–è¯‘åˆ†æ - æ‘¸ç“œ](https://mogua.co)\n- [é€†å‘åŸºç¡€çŸ¥è¯†](https://github.com/crifan/android_app_security_crack)\n- [å®‰è£…åŒ…åç¼–è¯‘æˆ Android å·¥ç¨‹ - Faker](https://github.com/Efaker/FakerAndroid)\n\n\n# å›¾ç‰‡\n\n> å›¾ç‰‡å¯ä»¥ä½œä¸ºç‚¹ç¼€ï¼Œç¾å›¾å¯ä»¥æ¬£èµ\n\n- [å…è´¹æ­£ç‰ˆé«˜æ¸…å›¾ç‰‡](https://pixabay.com/zh/)\n- [4K å½¼å²¸å›¾ç½‘](http://pic.netbian.com)\n\n# å…¶ä»–\n\n- [æ¶ˆé™¤å›¾ç‰‡èƒŒæ™¯](https://www.remove.bg/zh/upload)\n- [åœ¨çº¿å­—ç¬¦ä¸ªæ•°ç»Ÿè®¡](https://www.eteste.com)\n- [åœ¨çº¿æ—¥å¿—è¿‡æ»¤](https://tilipa.zlsam.com/#/tool?id=199&name=æ—¥å¿—åˆ†æå·¥å…·)\n","slug":"æˆ‘çš„å·¥å…·","published":1,"lang":"undefined","updated":"2022-10-15T04:27:58.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignst000qgaqp2on65nh8","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>æºç </h1>\n<ul>\n<li><a href=\"https://android.googlesource.com/platform/\">å®˜æ–¹ Android æºç </a></li>\n</ul>\n<h1>Github</h1>\n<blockquote>\n<p>æˆ‘ä¸ä¼šé€ è½®å­ï¼Œä½†å¸Œæœ›å¯¹æ­¤æœ‰ç‚¹äº†è§£</p>\n</blockquote>\n<ul>\n<li><a href=\"https://github.com/Blankj/AndroidUtilCode/blob/master/lib/utilcode/README-CN.md\">å·¥å…·ç±» AndroidUtilCode</a></li>\n<li><a href=\"https://github.com/Col-E/Recaf\">å­—èŠ‚ç ç¼–è¾‘å·¥å…· Recaf</a></li>\n<li><a href=\"https://github.com/JesusFreke/smali\">å·¥å…· smali</a></li>\n<li><a href=\"https://github.com/typicode/json-server\">æ­å»ºæœ¬åœ° Json Server</a></li>\n<li><a href=\"https://github.com/topjohnwu/Magisk\">è¶…çº§æƒé™ Magisk</a></li>\n<li><a href=\"https://gitlab.ow2.org/asm/asm\">å­—èŠ‚ç æ“ä½œåº“ ASM</a></li>\n<li><a href=\"https://github.com/asLody/SandHook\">ä½ ä¹Ÿå¯ç¼–å†™ hook Xposted</a></li>\n<li><a href=\"https://github.com/android-hacker/VirtualXposed\">è¶…çº§æƒé™ VitualXposted</a></li>\n<li><a href=\"https://github.com/SeriousCache/UABE\">Unity èµ„æºä¿®æ”¹ UABE</a></li>\n<li><a href=\"https://github.com/rmtheis/tess-two\">æ–‡å­—è¯†åˆ« Android tess-tow</a></li>\n<li><a href=\"https://lottiefiles.com/search?q=file%20conversion&amp;category=animations&amp;type=free\">åŠ¨ç”» Android lottie</a></li>\n<li><a href=\"https://github.com/pxb1988/dex2jar\">dex2jar è½¬æ¢</a></li>\n<li><a href=\"https://github.com/skylot/jadx\">jadx</a></li>\n<li><a href=\"https://github.com/tiann/epic/blob/master/README_cn.md\">å†…æ ¸ epic</a></li>\n<li><a href=\"https://github.com/LSPosed/LSPosed\">ä½ ä¹Ÿå¯ä»¥ hook LSPosted</a></li>\n<li><a href=\"https://github.com/Familyye/BlackObfuscator\">dex æ§åˆ¶æµæ··æ·† - BlackObfuscator</a></li>\n</ul>\n<h1>Android å­¦ä¹ </h1>\n<ul>\n<li><a href=\"https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode\">Android åŸºç¡€çŸ¥è¯†</a></li>\n<li><a href=\"https://www.wanandroid.com\">ç© Android</a></li>\n<li><a href=\"https://developer.android.com/training/system-ui/immersive?hl=zh-cn\">å®˜ç½‘çŸ¥è¯†ç‚¹</a></li>\n<li><a href=\"http://gityuan.com\">å¤§ä½¬åšå®¢ Gityuan</a></li>\n</ul>\n<h1>Java å­¦ä¹ </h1>\n<ul>\n<li><a href=\"https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-2.html\">å®˜ç½‘æ–‡æ¡£ JVM</a></li>\n<li><a href=\"https://thismj.cn/2019/02/14/qian-xi-zip-ge-shi/\">zip æ–‡ä»¶æ ¼å¼</a></li>\n</ul>\n<h1>é€†å‘</h1>\n<ul>\n<li><a href=\"https://www.52pojie.cn\">å¾çˆ±ç ´è§£</a></li>\n<li><a href=\"https://www.maldun.com\">å®‰è£…åŒ…åˆ†æ - é­”ç›¾å®‰å…¨</a></li>\n<li><a href=\"https://www.virustotal.com/gui/home/upload\">å®‰è£…åŒ…æŠ¥æ¯’åˆ†æ - Virustotal</a></li>\n<li><a href=\"https://mogua.co\">å®‰è£…åŒ…åç¼–è¯‘åˆ†æ - æ‘¸ç“œ</a></li>\n<li><a href=\"https://github.com/crifan/android_app_security_crack\">é€†å‘åŸºç¡€çŸ¥è¯†</a></li>\n<li><a href=\"https://github.com/Efaker/FakerAndroid\">å®‰è£…åŒ…åç¼–è¯‘æˆ Android å·¥ç¨‹ - Faker</a></li>\n</ul>\n<h1>å›¾ç‰‡</h1>\n<blockquote>\n<p>å›¾ç‰‡å¯ä»¥ä½œä¸ºç‚¹ç¼€ï¼Œç¾å›¾å¯ä»¥æ¬£èµ</p>\n</blockquote>\n<ul>\n<li><a href=\"https://pixabay.com/zh/\">å…è´¹æ­£ç‰ˆé«˜æ¸…å›¾ç‰‡</a></li>\n<li><a href=\"http://pic.netbian.com\">4K å½¼å²¸å›¾ç½‘</a></li>\n</ul>\n<h1>å…¶ä»–</h1>\n<ul>\n<li><a href=\"https://www.remove.bg/zh/upload\">æ¶ˆé™¤å›¾ç‰‡èƒŒæ™¯</a></li>\n<li><a href=\"https://www.eteste.com\">åœ¨çº¿å­—ç¬¦ä¸ªæ•°ç»Ÿè®¡</a></li>\n<li><a href=\"https://tilipa.zlsam.com/#/tool?id=199&amp;name=%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7\">åœ¨çº¿æ—¥å¿—è¿‡æ»¤</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>æºç </h1>\n<ul>\n<li><a href=\"https://android.googlesource.com/platform/\">å®˜æ–¹ Android æºç </a></li>\n</ul>\n<h1>Github</h1>\n<blockquote>\n<p>æˆ‘ä¸ä¼šé€ è½®å­ï¼Œä½†å¸Œæœ›å¯¹æ­¤æœ‰ç‚¹äº†è§£</p>\n</blockquote>\n<ul>\n<li><a href=\"https://github.com/Blankj/AndroidUtilCode/blob/master/lib/utilcode/README-CN.md\">å·¥å…·ç±» AndroidUtilCode</a></li>\n<li><a href=\"https://github.com/Col-E/Recaf\">å­—èŠ‚ç ç¼–è¾‘å·¥å…· Recaf</a></li>\n<li><a href=\"https://github.com/JesusFreke/smali\">å·¥å…· smali</a></li>\n<li><a href=\"https://github.com/typicode/json-server\">æ­å»ºæœ¬åœ° Json Server</a></li>\n<li><a href=\"https://github.com/topjohnwu/Magisk\">è¶…çº§æƒé™ Magisk</a></li>\n<li><a href=\"https://gitlab.ow2.org/asm/asm\">å­—èŠ‚ç æ“ä½œåº“ ASM</a></li>\n<li><a href=\"https://github.com/asLody/SandHook\">ä½ ä¹Ÿå¯ç¼–å†™ hook Xposted</a></li>\n<li><a href=\"https://github.com/android-hacker/VirtualXposed\">è¶…çº§æƒé™ VitualXposted</a></li>\n<li><a href=\"https://github.com/SeriousCache/UABE\">Unity èµ„æºä¿®æ”¹ UABE</a></li>\n<li><a href=\"https://github.com/rmtheis/tess-two\">æ–‡å­—è¯†åˆ« Android tess-tow</a></li>\n<li><a href=\"https://lottiefiles.com/search?q=file%20conversion&amp;category=animations&amp;type=free\">åŠ¨ç”» Android lottie</a></li>\n<li><a href=\"https://github.com/pxb1988/dex2jar\">dex2jar è½¬æ¢</a></li>\n<li><a href=\"https://github.com/skylot/jadx\">jadx</a></li>\n<li><a href=\"https://github.com/tiann/epic/blob/master/README_cn.md\">å†…æ ¸ epic</a></li>\n<li><a href=\"https://github.com/LSPosed/LSPosed\">ä½ ä¹Ÿå¯ä»¥ hook LSPosted</a></li>\n<li><a href=\"https://github.com/Familyye/BlackObfuscator\">dex æ§åˆ¶æµæ··æ·† - BlackObfuscator</a></li>\n</ul>\n<h1>Android å­¦ä¹ </h1>\n<ul>\n<li><a href=\"https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode\">Android åŸºç¡€çŸ¥è¯†</a></li>\n<li><a href=\"https://www.wanandroid.com\">ç© Android</a></li>\n<li><a href=\"https://developer.android.com/training/system-ui/immersive?hl=zh-cn\">å®˜ç½‘çŸ¥è¯†ç‚¹</a></li>\n<li><a href=\"http://gityuan.com\">å¤§ä½¬åšå®¢ Gityuan</a></li>\n</ul>\n<h1>Java å­¦ä¹ </h1>\n<ul>\n<li><a href=\"https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-2.html\">å®˜ç½‘æ–‡æ¡£ JVM</a></li>\n<li><a href=\"https://thismj.cn/2019/02/14/qian-xi-zip-ge-shi/\">zip æ–‡ä»¶æ ¼å¼</a></li>\n</ul>\n<h1>é€†å‘</h1>\n<ul>\n<li><a href=\"https://www.52pojie.cn\">å¾çˆ±ç ´è§£</a></li>\n<li><a href=\"https://www.maldun.com\">å®‰è£…åŒ…åˆ†æ - é­”ç›¾å®‰å…¨</a></li>\n<li><a href=\"https://www.virustotal.com/gui/home/upload\">å®‰è£…åŒ…æŠ¥æ¯’åˆ†æ - Virustotal</a></li>\n<li><a href=\"https://mogua.co\">å®‰è£…åŒ…åç¼–è¯‘åˆ†æ - æ‘¸ç“œ</a></li>\n<li><a href=\"https://github.com/crifan/android_app_security_crack\">é€†å‘åŸºç¡€çŸ¥è¯†</a></li>\n<li><a href=\"https://github.com/Efaker/FakerAndroid\">å®‰è£…åŒ…åç¼–è¯‘æˆ Android å·¥ç¨‹ - Faker</a></li>\n</ul>\n<h1>å›¾ç‰‡</h1>\n<blockquote>\n<p>å›¾ç‰‡å¯ä»¥ä½œä¸ºç‚¹ç¼€ï¼Œç¾å›¾å¯ä»¥æ¬£èµ</p>\n</blockquote>\n<ul>\n<li><a href=\"https://pixabay.com/zh/\">å…è´¹æ­£ç‰ˆé«˜æ¸…å›¾ç‰‡</a></li>\n<li><a href=\"http://pic.netbian.com\">4K å½¼å²¸å›¾ç½‘</a></li>\n</ul>\n<h1>å…¶ä»–</h1>\n<ul>\n<li><a href=\"https://www.remove.bg/zh/upload\">æ¶ˆé™¤å›¾ç‰‡èƒŒæ™¯</a></li>\n<li><a href=\"https://www.eteste.com\">åœ¨çº¿å­—ç¬¦ä¸ªæ•°ç»Ÿè®¡</a></li>\n<li><a href=\"https://tilipa.zlsam.com/#/tool?id=199&amp;name=%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7\">åœ¨çº¿æ—¥å¿—è¿‡æ»¤</a></li>\n</ul>\n"},{"title":"æˆ‘çš„ BookMarks","catalog":true,"date":"2022-10-15T02:54:15.000Z","subtitle":"æ”¶è—ä»æœªåœæ­¢ï¼Œå­¦ä¹ ä»æœªå¼€å§‹","header-img":"/img/2210/mine_bookmark.jpg","sticky":11,"_content":"\n\n# çƒ­ä¿®å¤\n\n## ä»‹ç»\n\n**èƒŒæ™¯ï¼š** dex æ–¹æ³•ä¸ªæ•°é™åˆ¶ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 65536\n\n**æ–¹æ¡ˆï¼š** å°†ç¼–è¯‘å¥½çš„ class æ–‡ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ª dex æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½å…¶ä»–çš„ dex æ–‡ä»¶ï¼›dex æ–‡ä»¶æ‹†åˆ†å®˜æ–¹æ—©æœ‰æ–¹æ¡ˆ multidexã€‚\n\n**åŸç†ï¼š** ä½¿ç”¨ DexClassLoader åŠ è½½å­—èŠ‚ç å…ƒç´ ï¼Œï¼ˆé€šè¿‡åå°„ï¼‰æŠŠå­—èŠ‚ç å…ƒç´ è¿½åŠ åˆ° dexElements æ•°ç»„ï¼›å¯¹äºçƒ­ä¿®å¤ï¼ŒåŒåå­—èŠ‚ç æ–‡ä»¶åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«åŠ è½½ï¼Œåé¢çš„åŒåæ–‡ä»¶è¢«èˆå¼ƒï¼ˆä¹Ÿå°±æ˜¯è¡¥ä¸ dex æ–‡ä»¶åº”è¯¥æ”¾åœ¨æ¯”é—®é¢˜å…ƒç´ æ›´é å‰çš„ dexElements æ•°ç»„ä½ç½®ä¸­ï¼‰ã€‚\n\nç±»ç»“æ„ï¼š\nâ€”â€” ClassLoader\n&emsp;â€”â€” BaseDexClassLoader\n&emsp;&emsp;â€”â€” DexClassLoader&emsp;&emsp; [åŠ è½½ jarã€æœªå®‰è£… apk dex]\n&emsp;&emsp;â€”â€” PathClassLoader&emsp;&emsp;[åŠ è½½ç³»ç»Ÿç±»ã€å·²å®‰è£… apk dex]\n\n\n## path ç”Ÿæˆ\n\n1ã€ä¿®å¤é—®é¢˜ï¼Œæ„å»ºã€æ‰“åŒ…è·å¾— class æ–‡ä»¶\n2ã€åˆ©ç”¨ jar å‘½ä»¤å°† class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶\n3ã€åˆ©ç”¨ dx å‘½ä»¤å°† jar è½¬æ¢æˆ dex æ–‡ä»¶\n\n## path åŠ è½½\n1ã€åˆ›å»º DexClassLoader åŠ è½½è¡¥ä¸æ–‡ä»¶\n2ã€ä½¿ç”¨åå°„è·å¾— dexElements æ•°æ®ï¼Œè¡¥ä¸æ•°æ®åˆå¹¶åˆ°åå°„è·å–åˆ°çš„æ•°ç»„ï¼Œæ–°åˆå¹¶å¾—åˆ°çš„æ•°ç»„æ›´æ–°åˆ°åº”ç”¨å†…éƒ¨çš„ ClassLoader çš„ dexElements\n\næ˜¯çš„ï¼Œå¯¹äºç®€å•çš„çƒ­ä¿®å¤åˆ°è¿™é‡Œå°±ç®—å®Œæˆäº†ï¼Œè‡³äºå¤æ‚çš„éœ€æ±‚ã€æ›´å¥½çš„ä½¿ç”¨ä½“éªŒè¿˜éœ€è¦ä¸æ–­é›•ç¢ã€‚æ¯”å¦‚å¯ä»¥è¿›ä¸€æ­¥ç»“åˆ ASMã€Gradle Transfrom ç­‰å·¥å…·ä¼˜åŒ–ä½¿ç”¨ä½“éªŒã€‚\n","source":"_posts/undefined/æ¯•ä¸šä¸€å¹´.md","raw":"---\ntitle: æˆ‘çš„ BookMarks \ncatalog: true\ndate: 2022-10-15 10:54:15\nsubtitle: æ”¶è—ä»æœªåœæ­¢ï¼Œå­¦ä¹ ä»æœªå¼€å§‹\nheader-img: /img/2210/mine_bookmark.jpg\ntags: ç¬”è®°\ncategories:\nsticky: 11\n---\n\n\n# çƒ­ä¿®å¤\n\n## ä»‹ç»\n\n**èƒŒæ™¯ï¼š** dex æ–¹æ³•ä¸ªæ•°é™åˆ¶ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 65536\n\n**æ–¹æ¡ˆï¼š** å°†ç¼–è¯‘å¥½çš„ class æ–‡ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ª dex æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½å…¶ä»–çš„ dex æ–‡ä»¶ï¼›dex æ–‡ä»¶æ‹†åˆ†å®˜æ–¹æ—©æœ‰æ–¹æ¡ˆ multidexã€‚\n\n**åŸç†ï¼š** ä½¿ç”¨ DexClassLoader åŠ è½½å­—èŠ‚ç å…ƒç´ ï¼Œï¼ˆé€šè¿‡åå°„ï¼‰æŠŠå­—èŠ‚ç å…ƒç´ è¿½åŠ åˆ° dexElements æ•°ç»„ï¼›å¯¹äºçƒ­ä¿®å¤ï¼ŒåŒåå­—èŠ‚ç æ–‡ä»¶åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«åŠ è½½ï¼Œåé¢çš„åŒåæ–‡ä»¶è¢«èˆå¼ƒï¼ˆä¹Ÿå°±æ˜¯è¡¥ä¸ dex æ–‡ä»¶åº”è¯¥æ”¾åœ¨æ¯”é—®é¢˜å…ƒç´ æ›´é å‰çš„ dexElements æ•°ç»„ä½ç½®ä¸­ï¼‰ã€‚\n\nç±»ç»“æ„ï¼š\nâ€”â€” ClassLoader\n&emsp;â€”â€” BaseDexClassLoader\n&emsp;&emsp;â€”â€” DexClassLoader&emsp;&emsp; [åŠ è½½ jarã€æœªå®‰è£… apk dex]\n&emsp;&emsp;â€”â€” PathClassLoader&emsp;&emsp;[åŠ è½½ç³»ç»Ÿç±»ã€å·²å®‰è£… apk dex]\n\n\n## path ç”Ÿæˆ\n\n1ã€ä¿®å¤é—®é¢˜ï¼Œæ„å»ºã€æ‰“åŒ…è·å¾— class æ–‡ä»¶\n2ã€åˆ©ç”¨ jar å‘½ä»¤å°† class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶\n3ã€åˆ©ç”¨ dx å‘½ä»¤å°† jar è½¬æ¢æˆ dex æ–‡ä»¶\n\n## path åŠ è½½\n1ã€åˆ›å»º DexClassLoader åŠ è½½è¡¥ä¸æ–‡ä»¶\n2ã€ä½¿ç”¨åå°„è·å¾— dexElements æ•°æ®ï¼Œè¡¥ä¸æ•°æ®åˆå¹¶åˆ°åå°„è·å–åˆ°çš„æ•°ç»„ï¼Œæ–°åˆå¹¶å¾—åˆ°çš„æ•°ç»„æ›´æ–°åˆ°åº”ç”¨å†…éƒ¨çš„ ClassLoader çš„ dexElements\n\næ˜¯çš„ï¼Œå¯¹äºç®€å•çš„çƒ­ä¿®å¤åˆ°è¿™é‡Œå°±ç®—å®Œæˆäº†ï¼Œè‡³äºå¤æ‚çš„éœ€æ±‚ã€æ›´å¥½çš„ä½¿ç”¨ä½“éªŒè¿˜éœ€è¦ä¸æ–­é›•ç¢ã€‚æ¯”å¦‚å¯ä»¥è¿›ä¸€æ­¥ç»“åˆ ASMã€Gradle Transfrom ç­‰å·¥å…·ä¼˜åŒ–ä½¿ç”¨ä½“éªŒã€‚\n","slug":"æ¯•ä¸šä¸€å¹´","published":1,"lang":"undefined","updated":"2022-10-15T02:54:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsu000sgaqp9aqdb9bb","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>çƒ­ä¿®å¤</h1>\n<h2 id=\"ä»‹ç»\">ä»‹ç»</h2>\n<p><strong>èƒŒæ™¯ï¼š</strong> dex æ–¹æ³•ä¸ªæ•°é™åˆ¶ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 65536</p>\n<p><strong>æ–¹æ¡ˆï¼š</strong> å°†ç¼–è¯‘å¥½çš„ class æ–‡ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ª dex æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½å…¶ä»–çš„ dex æ–‡ä»¶ï¼›dex æ–‡ä»¶æ‹†åˆ†å®˜æ–¹æ—©æœ‰æ–¹æ¡ˆ multidexã€‚</p>\n<p><strong>åŸç†ï¼š</strong> ä½¿ç”¨ DexClassLoader åŠ è½½å­—èŠ‚ç å…ƒç´ ï¼Œï¼ˆé€šè¿‡åå°„ï¼‰æŠŠå­—èŠ‚ç å…ƒç´ è¿½åŠ åˆ° dexElements æ•°ç»„ï¼›å¯¹äºçƒ­ä¿®å¤ï¼ŒåŒåå­—èŠ‚ç æ–‡ä»¶åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«åŠ è½½ï¼Œåé¢çš„åŒåæ–‡ä»¶è¢«èˆå¼ƒï¼ˆä¹Ÿå°±æ˜¯è¡¥ä¸ dex æ–‡ä»¶åº”è¯¥æ”¾åœ¨æ¯”é—®é¢˜å…ƒç´ æ›´é å‰çš„ dexElements æ•°ç»„ä½ç½®ä¸­ï¼‰ã€‚</p>\n<p>ç±»ç»“æ„ï¼š<br>\nâ€”â€” ClassLoader<br>\nâ€ƒâ€”â€” BaseDexClassLoader<br>\nâ€ƒâ€ƒâ€”â€” DexClassLoaderâ€ƒâ€ƒ [åŠ è½½ jarã€æœªå®‰è£… apk dex]<br>\nâ€ƒâ€ƒâ€”â€” PathClassLoaderâ€ƒâ€ƒ[åŠ è½½ç³»ç»Ÿç±»ã€å·²å®‰è£… apk dex]</p>\n<h2 id=\"path-ç”Ÿæˆ\">path ç”Ÿæˆ</h2>\n<p>1ã€ä¿®å¤é—®é¢˜ï¼Œæ„å»ºã€æ‰“åŒ…è·å¾— class æ–‡ä»¶<br>\n2ã€åˆ©ç”¨ jar å‘½ä»¤å°† class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶<br>\n3ã€åˆ©ç”¨ dx å‘½ä»¤å°† jar è½¬æ¢æˆ dex æ–‡ä»¶</p>\n<h2 id=\"path-åŠ è½½\">path åŠ è½½</h2>\n<p>1ã€åˆ›å»º DexClassLoader åŠ è½½è¡¥ä¸æ–‡ä»¶<br>\n2ã€ä½¿ç”¨åå°„è·å¾— dexElements æ•°æ®ï¼Œè¡¥ä¸æ•°æ®åˆå¹¶åˆ°åå°„è·å–åˆ°çš„æ•°ç»„ï¼Œæ–°åˆå¹¶å¾—åˆ°çš„æ•°ç»„æ›´æ–°åˆ°åº”ç”¨å†…éƒ¨çš„ ClassLoader çš„ dexElements</p>\n<p>æ˜¯çš„ï¼Œå¯¹äºç®€å•çš„çƒ­ä¿®å¤åˆ°è¿™é‡Œå°±ç®—å®Œæˆäº†ï¼Œè‡³äºå¤æ‚çš„éœ€æ±‚ã€æ›´å¥½çš„ä½¿ç”¨ä½“éªŒè¿˜éœ€è¦ä¸æ–­é›•ç¢ã€‚æ¯”å¦‚å¯ä»¥è¿›ä¸€æ­¥ç»“åˆ ASMã€Gradle Transfrom ç­‰å·¥å…·ä¼˜åŒ–ä½¿ç”¨ä½“éªŒã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<h1>çƒ­ä¿®å¤</h1>\n<h2 id=\"ä»‹ç»\">ä»‹ç»</h2>\n<p><strong>èƒŒæ™¯ï¼š</strong> dex æ–¹æ³•ä¸ªæ•°é™åˆ¶ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 65536</p>\n<p><strong>æ–¹æ¡ˆï¼š</strong> å°†ç¼–è¯‘å¥½çš„ class æ–‡ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ª dex æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½å…¶ä»–çš„ dex æ–‡ä»¶ï¼›dex æ–‡ä»¶æ‹†åˆ†å®˜æ–¹æ—©æœ‰æ–¹æ¡ˆ multidexã€‚</p>\n<p><strong>åŸç†ï¼š</strong> ä½¿ç”¨ DexClassLoader åŠ è½½å­—èŠ‚ç å…ƒç´ ï¼Œï¼ˆé€šè¿‡åå°„ï¼‰æŠŠå­—èŠ‚ç å…ƒç´ è¿½åŠ åˆ° dexElements æ•°ç»„ï¼›å¯¹äºçƒ­ä¿®å¤ï¼ŒåŒåå­—èŠ‚ç æ–‡ä»¶åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«åŠ è½½ï¼Œåé¢çš„åŒåæ–‡ä»¶è¢«èˆå¼ƒï¼ˆä¹Ÿå°±æ˜¯è¡¥ä¸ dex æ–‡ä»¶åº”è¯¥æ”¾åœ¨æ¯”é—®é¢˜å…ƒç´ æ›´é å‰çš„ dexElements æ•°ç»„ä½ç½®ä¸­ï¼‰ã€‚</p>\n<p>ç±»ç»“æ„ï¼š<br>\nâ€”â€” ClassLoader<br>\nâ€ƒâ€”â€” BaseDexClassLoader<br>\nâ€ƒâ€ƒâ€”â€” DexClassLoaderâ€ƒâ€ƒ [åŠ è½½ jarã€æœªå®‰è£… apk dex]<br>\nâ€ƒâ€ƒâ€”â€” PathClassLoaderâ€ƒâ€ƒ[åŠ è½½ç³»ç»Ÿç±»ã€å·²å®‰è£… apk dex]</p>\n<h2 id=\"path-ç”Ÿæˆ\">path ç”Ÿæˆ</h2>\n<p>1ã€ä¿®å¤é—®é¢˜ï¼Œæ„å»ºã€æ‰“åŒ…è·å¾— class æ–‡ä»¶<br>\n2ã€åˆ©ç”¨ jar å‘½ä»¤å°† class æ–‡ä»¶æ‰“åŒ…æˆ jar æ–‡ä»¶<br>\n3ã€åˆ©ç”¨ dx å‘½ä»¤å°† jar è½¬æ¢æˆ dex æ–‡ä»¶</p>\n<h2 id=\"path-åŠ è½½\">path åŠ è½½</h2>\n<p>1ã€åˆ›å»º DexClassLoader åŠ è½½è¡¥ä¸æ–‡ä»¶<br>\n2ã€ä½¿ç”¨åå°„è·å¾— dexElements æ•°æ®ï¼Œè¡¥ä¸æ•°æ®åˆå¹¶åˆ°åå°„è·å–åˆ°çš„æ•°ç»„ï¼Œæ–°åˆå¹¶å¾—åˆ°çš„æ•°ç»„æ›´æ–°åˆ°åº”ç”¨å†…éƒ¨çš„ ClassLoader çš„ dexElements</p>\n<p>æ˜¯çš„ï¼Œå¯¹äºç®€å•çš„çƒ­ä¿®å¤åˆ°è¿™é‡Œå°±ç®—å®Œæˆäº†ï¼Œè‡³äºå¤æ‚çš„éœ€æ±‚ã€æ›´å¥½çš„ä½¿ç”¨ä½“éªŒè¿˜éœ€è¦ä¸æ–­é›•ç¢ã€‚æ¯”å¦‚å¯ä»¥è¿›ä¸€æ­¥ç»“åˆ ASMã€Gradle Transfrom ç­‰å·¥å…·ä¼˜åŒ–ä½¿ç”¨ä½“éªŒã€‚</p>\n"},{"title":"Xposted æ£€æµ‹è·å–è®¾å¤‡ä¿¡æ¯","catalog":true,"date":"2022-09-29T14:59:00.000Z","subtitle":"æ‹’ç»åº”ç”¨ä¸åˆç†è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸º","header-img":"/img/220928/xposted_bg.png","sticky":4,"_content":"\n\n# å‰è¨€ \n\nè®¾å¤‡çš„ä¸ªäººä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè”ç³»äººä¿¡æ¯ã€çŸ­ä¿¡å†…å®¹ç­‰ï¼‰å±äºç”¨æˆ·éšç§ï¼Œè¿è§„è·å–ä¸ªäººä¿¡æ¯è¢«è§†ä¸ºä¾µçŠ¯ç”¨æˆ·æƒç›Šï¼›åœ¨è®¾å¤‡ä¸Šè·å–ä¸ªäººä¿¡æ¯ä¸€èˆ¬éœ€å…ˆè·å–åˆ°ç›¸åº”çš„æƒé™æ‰èƒ½è¿›è¡Œè·å–ï¼Œä¾‹å¦‚æƒ³è·å–ç›¸å†Œå›¾ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦ç”³è¯·è¯»å†™æƒé™ï¼Œç”¨æˆ·åŒæ„æƒé™ç”³è¯·ä¹‹åå¯è¯»å–ç›¸å†Œå›¾ç‰‡ã€‚åº”ç”¨å­˜åœ¨è¿è§„è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºï¼Œä¸ä¸ºç½•è§ï¼Œä½•ä¸ºè¿è§„è¡Œä¸ºï¼Ÿ\n\nä¸ªäººç†è§£ï¼š\n- åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…ä¸‹è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·åŒæ„éšç§æ”¿ç­–å‰è·å–ä¸ªäººä¿¡æ¯\n- æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾ã€‚æ¯”å¦‚ï¼Œéšç§æ”¿ç­–æˆ–è¯´æ˜æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾\n- è¶…èŒƒå›´è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå£çº¸ App ç”³è¯·å½•éŸ³æƒé™\n\næ­¤å‰ï¼Œéƒ¨åˆ†åº”ç”¨å­˜åœ¨å¯¹ç”¨æˆ·ä¸ªäººä¿¡æ¯è¿è§„è·å–çš„è¡Œä¸ºï¼Œä¸ªäººéšç§æƒç›Šä¿æŠ¤æ„è¯†è–„å¼±ï¼Œè¿è§„è·å–çš„è¡Œä¸ºæœªå¾—åˆ°æœ‰æ•ˆè§£å†³ï¼Œç›´åˆ° 2019 å¹´ä½ï¼Œå·¥ä¿¡éƒ¨å‘å¸ƒå…³äºå°å‘ã€ŠAppè¿æ³•è¿è§„æ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯è¡Œä¸ºè®¤å®šæ–¹æ³•ã€‹é€šçŸ¥ï¼Œåº”ç”¨å•†åº—é€æ¸å¼€å§‹å¯¹è¿è§„è·å–è¡Œä¸ºè¦æ±‚æ•´æ”¹ã€‚\n\n```java\n- æœªå…¬å¼€æ”¶é›†ä½¿ç”¨è§„åˆ™çš„è¡Œä¸º\n- æœªæ˜ç¤ºæ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯çš„ç›®çš„ã€æ–¹å¼å’ŒèŒƒå›´çš„è¡Œä¸º\n- æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºã€è¯¥ç‚¹ä¸ºæœ¬æ–‡è®¨è®ºå’Œè§£å†³çš„é‡ç‚¹ã€‘\n- æ”¶é›†ä¸å…¶æä¾›æœåŠ¡æ— å…³çš„ä¸ªäººä¿¡æ¯çš„è¡Œä¸º\n- æœªç»åŒæ„å‘ä»–äººæä¾›ä¸ªäººä¿¡æ¯çš„è¡Œä¸º\n- æœªæŒ‰æ³•å¾‹è§„å®šæä¾›åˆ é™¤æˆ–æ›´æ­£ä¸ªäººä¿¡æ¯åŠŸèƒ½çš„\n\né™¤æ­¤ä¹‹å¤–ï¼Œå›½å†…å•†åº—æ¸ é“è¿˜æœ‰å…¶ä»–è¦æ±‚ï¼Œæ¯”å¦‚ï¼š\n- ä¸å…è®¸é¢‘ç¹è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆIMEIã€SSIDã€AndroidID ç­‰ï¼‰\n```\n\n![origin_img_v2_640fd02b-1194-4342-9ed9-200b1e9bf7ag.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0f36e7ad9b4293b24fc5afcc4bc7a8~tplv-k3u1fbpfcp-watermark.image?)\n\nä»¥ä¸‹å›´ç»•å¦‚ä½•æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜åœ¨**æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯**çš„è¡Œä¸ºï¼Œä»¥åŠ**æ˜¯å¦å­˜åœ¨é¢‘ç¹è·å–ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯**çš„è¡Œä¸ºã€‚\n\n\n# Xposted æ¨¡å—\n\n## ä»‹ç» â˜•ï¸\n\nè¯¥æ¨¡æ¿ç¼–å†™ä¸»è¦æ˜¯ Hook çŸ¥è¯†ç‚¹ï¼ŒHook ä½œä¸ºâ€˜é’©å­â€™å¯ä»¥ç²—ç•¥ç†è§£ä¸ºæ‹¦æˆªæŸæ®µä»£ç çš„æ‰§è¡Œï¼Œå¹¶åœ¨ä»£ç æ®µå‰åæ’å…¥ç›‘æ§äº‹ä»¶ï¼Œç¨‹åºæ‰§è¡Œæ­¤ä»£ç æ®µåŒæ—¶ä¹Ÿå°†è§¦å‘ç›‘æ§äº‹ä»¶ï¼Œå°†ç›‘æ§äº‹ä»¶è¿”å›ç»™å¤–å±‚ç”¨äºè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸ªäººç†è§£ï¼Œä½¿ç”¨ Hook å·¥å…·è¾ƒä¸ºå…³é”®çš„ä¸€ç‚¹å°±æ˜¯æ‰¾åˆ°è¾ƒä¸ºå‡†ç¡®çš„ Hook ç‚¹ã€‚\n\n## Hook æ¡†æ¶ ğŸ¤”\n\nAndroid ä¸Šçš„ Hook æ¡†æ¶ï¼Œæƒ³å¿…å¾ˆå¤šäººéƒ½ç•¥æœ‰è€³é—»ï¼Œå½“å¹´ç‹‚çƒ­çš„ **Xposted**ï¼Œåé¢ç¼–å†™çš„æ£€æµ‹å·¥å…·ä¾¿æ˜¯åŸºäº Xposted åº“ï¼ŒXposted æ¨¡å—ç¼–å†™æ•™ç¨‹åœ¨ç½‘ä¸Šæ˜¯æ»¡å¤©é£ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘è§‰å¾—æè¿°å¾—æ¯”è¾ƒæ¸…æ™°ï¼š[æ–°æ‰‹ä¸è¦å†è¢«è¯¯å¯¼ï¼è¿™æ˜¯ä¸€ç¯‡æœ€æ–°çš„Xposedæ¨¡å—ç¼–å†™æ•™ç¨‹](https://www.freebuf.com/articles/terminal/189021.html)ã€‚çœ‹å®Œå¼•ç”¨çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“ xposted åº“ä½¿ç”¨çš„ hook æ¨¡æ¿ï¼Œæ£€æµ‹å·¥å…·æ ¹æ®æ¨¡æ¿ç¼–å†™ä»£ç ï¼Œæ•´åˆå¤šä¸ªæ£€æµ‹ç‚¹å°±å¯ä»¥ï¼ˆæ¯”å¦‚æˆ‘éœ€è¦æ£€æµ‹ AndroidIdã€MACã€IMEI ç­‰çš„è·å–ï¼‰ã€‚\n\n```java\n//æ¨¡æ¿\nXposedHelpers.findAndHookMethod(\nclassName,      //éœ€è¦ hook çš„ç±»åï¼Œå› ä¸ºä½¿ç”¨åå°„ï¼Œéœ€è¦ç±»çš„å…¨é™å®šå\nmethondName,    //éœ€è¦ hook çš„æ–¹æ³•ç­¾å\nparams1.class,  //éœ€è¦ hook çš„æ–¹æ³•çš„å‚æ•°ï¼ˆå‚æ•°å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œå‚æ•°ç±»å‹éœ€å’Œæ–¹æ³•ç­¾åä¿æŒä¸€è‡´ï¼‰\nparams2.class,\n...\nnew XC_MethodHook() {\n\n    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {\n      //hook before\n    }\n    protected void afterHookedMethod(MethodHookParam param) throws Throwable {\n      //hook after\n    }});\n\n```\n\n## ä¸¾ä¸ªæ —å­ğŸŒ°\n\nAndroid Java å±‚è·å– AndroidID çš„ä»£ç é€šå¸¸æ˜¯ï¼š\n\n```java\nSettings.Secure.getString(context.getContentResolver(), \nSettings.Secure.ANDROID_ID);\n```\n\né‚£ä¹ˆï¼Œæ ¹æ®ä¸Šè¿°çš„ hook æ¨¡ç‰ˆï¼Œæ‰¾åˆ°ä»¥ä¸‹å‚æ•°åªå€¼ï¼š\n\n- classNameï¼šandroid.provider.Settings\n- methodNameï¼šgetString ï¼ˆæœ‰å‚æ–¹æ³•ï¼Œæ³¨æ„åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°å¯æ ¹æ®ä¸åŒçš„ä¼ å€¼è·å–ä¸åŒçš„è®¾å¤‡ä¿¡æ¯ï¼‰\n- params1ï¼šContentResolver.class\n- params2ï¼šString.class\n\nç”±æ­¤å¯å¾— androidId è·å–æ£€æµ‹ä»£ç ï¼š\n\n```java\n// æ£€æµ‹ AndroidID è·å–\nXposedHelpers.findAndHookMethod(\n\"android.provider.Settings\",\n\"getString\",\nContentResolver.class,\nString.class,\nnew XC_MethodHook() {\n\n    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {\n      //hook before\n    }\n    protected void afterHookedMethod(MethodHookParam param) throws Throwable {\n      //hook after\n      if(param == null)return;\n      //æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåˆ—è¡¨\n      Object[] args = param.args;\n      if(args == null || args.lenght <= 0)return;\n      //getString æ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“ç¬¬äºŒä¸ªå‚æ•°å€¼æ‰æœ‰æ„ä¹‰ï¼Œæ‰èƒ½ç»§ç»­åˆ¤æ–­æ˜¯è·å– androidid è¿˜æ˜¯åˆ«çš„ä¿¡æ¯\n      if(args.lenght >= 2){\n          String params2 = (String)args[1];\n          //æ³¨æ„ï¼špublic static final String ANDROID_ID = \"android_id\";\n          if(\"android_id\".equal(params2)){\n              Log.d(\"TAG\",\"æ£€æµ‹åˆ°è·å– androidid\")\n          }\n      }\n    }});\n\n```\n\nå°±è¿™æ ·ï¼Œæ£€æµ‹ androidid è·å–çš„ä»£ç å°±å†™å¥½äº†ï¼Œç®€å•å§ã€‚å¦‚æœä½ å¯¹ xposted å®ç°æ„Ÿå…´è¶£å¯ä»¥çœ‹æºç [ï¼šandroid-hacker-VirtualXposted](https://github.com/android-hacker/VirtualXposed)ã€‚æŸ¥çœ‹ android æºç å¯çŸ¥ï¼Œè·å– androidid çš„ getString æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å¯é€‰å€¼\n\n```java\n//æ‰€ä»¥ï¼Œå½“ä½  Hook è¿™ä¸ªæ–¹æ³•æ—¶å€™ï¼Œä¸ä»…ä»…å¯ä»¥ Hook AndroidID çš„è·å–ï¼Œä¹Ÿå¯ä»¥æ£€æµ‹å…¶ä»–ä¿¡æ¯çš„è·å–æƒ…å†µ\n//public static final String ANDROID_ID = \"android_id\";\nstatic {\n    MOVED_TO_SECURE = new HashSet<>(30);\n    MOVED_TO_SECURE.add(Secure.ADAPTIVE_SLEEP);\n    MOVED_TO_SECURE.add(Secure.ANDROID_ID);\n    MOVED_TO_SECURE.add(Secure.HTTP_PROXY);\n    MOVED_TO_SECURE.add(Secure.LOCATION_PROVIDERS_ALLOWED);\n    MOVED_TO_SECURE.add(Secure.LOCK_BIOMETRIC_WEAK_FLAGS);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_ENABLED);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_VISIBLE);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_TACTILE_FEEDBACK_ENABLED);\n    MOVED_TO_SECURE.add(Secure.LOGGING_ID);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_ENABLED);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_LAST_UPDATE);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_REDIRECT_URL);\n    MOVED_TO_SECURE.add(Secure.SETTINGS_CLASSNAME);\n    MOVED_TO_SECURE.add(Secure.USE_GOOGLE_MAIL);\n    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY);\n    MOVED_TO_SECURE.add(Secure.WIFI_NUM_OPEN_NETWORKS_KEPT);\n    MOVED_TO_SECURE.add(Secure.WIFI_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ACCEPTABLE_PACKET_LOSS_PERCENTAGE);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_AP_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_DELAY_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_ENABLED);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_TIMEOUT_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_INITIAL_IGNORED_PING_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_MAX_AP_CHECKS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_DELAY_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_TIMEOUT_MS);\n\n    // At one time in System, then Global, but now back in Secure\n    MOVED_TO_SECURE.add(Secure.INSTALL_NON_MARKET_APPS);\n}\n```\n\n## æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç  ğŸ¤”ï¸\n\nè¯»åˆ°è¿™é‡Œï¼Œæ ¹æ®ä¸Šé¢çš„ xposted hook æ¨¡æ¿ï¼Œæ€ç»´å‘æ•£ï¼Œä½ å·²ç»å…·å¤‡å†™ä¸€ä¸ªåˆè§„æ£€ Xposted æ’ä»¶çš„èƒ½åŠ›ã€‚é€šå¸¸ï¼Œåˆè§„æ£€æµ‹æ’ä»¶åº”è¯¥ hook å“ªäº›åœ°æ–¹ï¼Ÿåº”è¯¥æ£€æµ‹å“ªäº›ä¿¡æ¯çš„è·å–è¡Œä¸ºï¼Ÿå…¶å®ä½ å¯ä»¥å‚è€ƒæ¸ é“å®¡æ ¸è¦æ±‚ç»¼åˆè€ƒè™‘ï¼Œå½’çº³æ€»ç»“ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹å‡ ç‚¹ï¼š\n- androidID æ£€æµ‹\n- IMEI æ£€æµ‹\n- SSID æ£€æµ‹\n- IMSI æ£€æµ‹\n- MAC æ£€æµ‹\n- OAID æ£€æµ‹ã€å› ä¸ºè·å– IMEI çš„é—®é¢˜ï¼Œç°åœ¨å›½å†…å¾ˆå¤šéƒ½åœ¨ä½¿ç”¨ OAIDã€‘\n- å®šä½ä¿¡æ¯è¯»å–æ£€æµ‹\n- è”ç³»äººåˆ—è¡¨è¯»å–æ£€æµ‹\n- çŸ­ä¿¡å†…å®¹æ£€æµ‹\n- ç›¸å†Œè¯»å–æ£€æµ‹\n- è½¯ä»¶å®‰è£…åˆ—è¡¨è¯»å–æ£€æµ‹\n- åº”ç”¨ä¿¡æ¯è¯»å–æ£€æµ‹\n\n\nç¼–å†™åˆè§„æ£€æµ‹æ’ä»¶å¯èƒ½é‡åˆ°æˆ–éœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ\n- åº”ç”¨çš„å¤šè¿›ç¨‹ç¯å¢ƒã€‚é¿å…æŸäº›æ“ä½œé‡å¤æ‰§è¡Œï¼Œæ£€æµ‹æ•°æ®é‡å¤\n- ä¿¡æ¯è·å–è·å–è¡Œä¸ºæ•°æ®å¤„ç†ã€‚æ˜¯å¦éœ€å¼•å…¥æ•°æ®æŒä¹…åŒ–æ¡†æ¶ï¼Œå¯¹æ•°æ®å­˜å‚¨åç»Ÿä¸€å¤„ç†\n- Android å¹³å°æ•°æ®åº“æ¡†æ¶åˆå§‹åŒ–ä¾èµ– contextã€‚æ˜¯å¦éœ€è¦ hook application è·å– context\n- ç­‰ç­‰ï¼ˆéœ€æ±‚é©±åŠ¨å¼€å‘ï¼‰\n\n\n# Use VirtualXposted ğŸ’”\n\n**æ–¹æ¡ˆå¯è¡Œä½†ä¸æ¨èï¼Œå­˜åœ¨ä¸€å®šçš„å±€é™**\n\nä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿæœ‰ä»€ä¹ˆå±€é™ï¼Ÿéœ€æ£€æŸ¥åº”ç”¨è¿è¡Œç¯å¢ƒä»¥æ¥ VirtualXpostedAppï¼Œä¾µå…¥æ€§å¼ºï¼Œæ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹åˆ°å­˜åœ¨ xposted ç¯å¢ƒï¼Œxposted hook ç‰¹å¾æ˜æ˜¾ï¼Œå®¹æ˜“è¢«æ£€æµ‹ã€‚æ¯”å¦‚æŸäº›åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹ SDK æœ‰åš xposted é˜²æŠ¤ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è¿è¡Œç¯å¢ƒå­˜åœ¨ xpostedï¼Œå¯èƒ½ä¼šåšç›¸åº”å¤„ç†â€”â€”â€”â€”ç»ˆæ­¢ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¸åˆ©äºæ£€æµ‹åº”ç”¨ä¸ªäººä¿¡æ¯è·å–æƒ…å†µã€‚ä¼˜ç‚¹æ˜¯ç¯å¢ƒå‡†å¤‡ç®€å•ã€‚\n\n## å¦‚ä½•ä½¿ç”¨\n\n1ã€ä¸‹è½½å®‰è£… virtualXposted\n\n[android-hacker-VirtualXposted](https://github.com/android-hacker/VirtualXposed)\n\n2ã€æ¿€æ´» xposted \n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca83e472c58447ce84f6eb4f1aad5b2e~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b53d5cd381f419ba50e4eea9f9f8a39~tplv-k3u1fbpfcp-watermark.image?)\n\n3ã€æ·»åŠ æ¨¡æ¿å’Œå¾…æ£€æµ‹åº”ç”¨\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e93823fe3fe14092a287bb6ac95c3310~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39273c5ee0534cc4b705ee3de92d9fc0~tplv-k3u1fbpfcp-watermark.image?)\n\n4ã€å¯åŠ¨æ¨¡å—\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5bc1c3afd294c378d5cb57d7f7dda1b~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/798cac0dc3e2428699a16d74bfab6d44~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7748fbdc0e24f12bc2148383117e9b8~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5622c01867c64155a5cae84c6a57be57~tplv-k3u1fbpfcp-watermark.image?)\n\næœ€åå°±æ˜¯è¿è¡Œåº”ç”¨ï¼ŒæŸ¥çœ‹è‡ªå®šä¹‰è¾“å‡ºæ—¥å¿—ã€‚ç”±äº xposted é˜²æŠ¤çš„å±€é™ï¼Œè‹¥ä¸èƒ½æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿˜éœ€å¦å¯»ä»–æ³•ã€‚\n\n# Use Taichi ğŸ’”\n\n**æ–¹æ¡ˆä¸å¯è¡Œä½†ä¸æ¨èï¼Œå†™å¥½çš„æ¨¡æ¿æ— æ³•ä½¿ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰**\n\nä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿå†™å¥½çš„æ£€æµ‹æ¨¡æ¿è¢«é™åˆ¶ä½¿ç”¨ï¼Œå®˜ç½‘ï¼šhttps://github.com/taichi-framework/TaiChi\n\nå¦‚ä½•ä½¿ç”¨å¤ªæå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼Œè¿™é‡Œæä¸‹é‡åˆ°çš„é—®é¢˜ï¼š\n\n**é—®é¢˜ä¸€ï¼šæš‚ä¸æ”¯æŒ**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ef794ca6102471bb11b702f6f062a1f~tplv-k3u1fbpfcp-watermark.image?)\n\n**çœ‹ä¸‹å®˜ç½‘æœ‰å¯¹â€˜æš‚æ—¶ä¸æ”¯æŒâ€™çš„æè¿°ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š**\n\n- å½“å‰å¤ªææ˜¯å¤ªæé˜´æ¨¡å¼ï¼ˆæœ‰é˜´ã€é˜³ä¸¤ç§æ¨¡å¼ï¼Œè‡ªè¡Œå®˜ç½‘äº†è§£ï¼‰\n- å½“å‰æ¨¡å—ä¸å­˜åœ¨ç™½åå•ä¸­\n\næš‚æ—¶æ²¡åŠæ³•ï¼Œè¯•è¯•æŠŠå¤ªææ¿€æ´»ä¸ºâ€˜å¤ªæé˜³â€™æ¨¡å¼ï¼Œç„¶è€Œå‘¢è¿˜æ˜¯æ˜¾ç¤ºæš‚ä¸æ”¯æŒï¼›çŒœæµ‹æ˜¯å¦ä¸€ç§å¯èƒ½ï¼Œæ¨¡æ¿ä¸å­˜åœ¨ç™½åå•ä¸­ï¼Œè¦åŠ å…¥ç™½åå•è¦è”ç³»ä½œè€…ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜æ˜¯å¦å¯»ä»–æ³•å§ã€‚åæ¥å‘ç°äº†å¦ä¸€ä¸ªæ¡†æ¶ LSP ã€‚ï¼ˆå¦‚ä½•å¼€å¯å¤ªæé˜³ï¼Œå®˜ç½‘æœ‰æ•™ç¨‹ï¼Œéœ€è¦å€ŸåŠ© Magiskï¼Œä¸‹æ–‡ä¼šç”¨åˆ°è¿™ä¸ªå·¥å…·ï¼‰\n\n# Use Lsposted â¤ï¸\n\n**æ–¹æ¡ˆå¯è¡Œï¼Œæ¨èä½¿ç”¨**\nä¸ºä»€ä¹ˆæ¨èï¼ŸLSP ä¾µå…¥æ€§å¼±ï¼Œä¸æ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿé¿å… xposted é˜²æŠ¤ã€‚\n\n## æ³¨æ„äº‹é¡¹\n\n- BootLoader è§£é”å°†æ¸…é™¤è®¾å¤‡æ•°æ®ï¼Œé‡è¦æ•°æ®è¯·æ³¨æ„å¤‡ä»½\n- æ­¤æ“ä½œéœ€è¦è®¾å¤‡è§£é” Bootloader ï¼ˆåˆ·æœºï¼‰ï¼Œè‹¥BootLoader è§£é”å¤±è´¥ï¼Œå…¶ä»–æ“ä½œå·²æ— æ„ä¹‰ï¼Œæ²¡æœ‰ç»§ç»­æ“ä½œçš„å¿…è¦ï¼Œå»ºè®®æ›´æ¢è®¾å¤‡ã€‚\n- å„å‚å•†è®¾å¤‡ BootLoader è§£é”æ–¹å¼å¯èƒ½ä¸å°½ç›¸åŒã€‚\n    - å°ç±³å®˜ç½‘ä»ç„¶å¼€æ”¾ BL è§£é”å·¥å…·ï¼ˆå»ºè®®ä½¿ç”¨å°ç±³æ‰‹æœºæµ‹è¯•ï¼‰\n    - è´­ä¹°ç¬¬ä¸‰æ–¹è§£é”å·¥å…· UAndroid\n    - OPPO å®˜æ–¹ä¹Ÿæœ‰â€˜æ·±åº¦æµ‹è¯•â€™è§£é”å·¥å…·ï¼Œä½†ç”³è¯·åé¢æœ‰é™ï¼Œå®¡æ ¸æ—¶é—´é•¿ï¼Œä¸æ¨è\n\n## å¦‚ä½•ä½¿ç”¨\n\nä»¥å°ç±³æ‰‹æœºä¸ºä¾‹ï¼ˆå› ä¸º BL è§£é”æ–¹ä¾¿ï¼‰\n\n**1ã€è®¾å¤‡ Bootloader è§£é”**\n\n[å®˜æ–¹ï¼šç”³è¯·è§£é”å°ç±³æ‰‹æœº](http://www.miui.com/unlock/download.html)\n\nå°ç±³çš„ BL è§£é”å¯¹è®¾å¤‡çš„ä»¥åŠè´¦å·ç»‘å®šä¹Ÿæœ‰è¦æ±‚ï¼Œæ¯”å¦‚è´¦å·ä¸è®¾å¤‡ç»‘å®šæ—¶é—´ç­‰ã€‚å®˜ç½‘ä¸‹è½½å¾—åˆ°çš„å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚\n\n**2ã€ä¸‹è½½å®‰è£… Magisk**\n\nå®˜ç½‘ï¼šhttps://github.com/topjohnwu/Magisk\n\n**3ã€ä¸‹è½½å¤‡ç”¨ adb-fastboot**\n\né“¾æ¥ï¼šhttps://mrzzoxo.lanzouw.com/iMbPYz63p6f\n\n**4ã€å‡†å¤‡å¯¹åº”è®¾å¤‡å‹å·çš„åˆ·æœºåŒ…**\n\nå°ç±³åˆ·æœºåŒ…ï¼šhttps://mirom.ezbox.idv.tw/phone/\n\nä¸€èˆ¬å»ºè®®ä¸‹è½½å¤§é™†ç¨³å®šç‰ˆï¼ˆè‹¥æ˜¯å…¶ä»–å‚å•†åˆ·æœºåŒ…ï¼Œè‡ªè¡Œå¯»æ‰¾ï¼‰\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87a8268965d648df8775781e37f77679~tplv-k3u1fbpfcp-watermark.image?)\n\n**5ã€åˆ·å…¥ Magisk**\n\nå°½é‡æŒ‰é¡ºåºæ“ä½œ\n\n5.1 ä»åˆ·æœºåŒ…ä¸­è§£å‹è·å–Â Â **boot.img** æ–‡ä»¶ï¼ˆè‹¥æ— æ­¤æ–‡ä»¶å»ºè®®æ›´æ¢åˆ·æœºåŒ…ï¼Œä¹Ÿå¯ä»¥å¦å¯»ä»–æ³•ä»åˆ·æœºåŒ…ä¸­è§£æè·å¾—æ­¤æ–‡ä»¶ï¼‰\n5.2 æ‰“å¼€ Magisk é€‰æ‹© boot.img å®‰è£…è¡¥ä¸ï¼Œç­‰å¾…åˆ·å…¥å®Œæˆï¼ˆæ­¤æˆªå›¾æ˜¯å·²å®‰è£…å®Œæˆçš„ï¼Œä»¥å®é™…ä¸ºå‡†ï¼‰\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6b1f76ad8845d98bf1f2c901286ed9~tplv-k3u1fbpfcp-watermark.image?)\n\n5.3 åˆ·å…¥å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—è·å¾—ç”Ÿæˆçš„ img æ–‡ä»¶\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0d9d3a707544199a1b8e5f5518b4e4f~tplv-k3u1fbpfcp-zoom-1.image)\n\n5.4 å¤åˆ¶ç”Ÿæˆçš„Â img æ–‡ä»¶å’Œ boot.img æ–‡ä»¶åˆ° adb-fastboot ç›®å½•ä¸‹ï¼Œæ‰“å¼€Â æ‰“å¼€CMDå‘½ä»¤è¡Œ.batï¼ˆè‹¥ boot.img ä¸å­˜åœ¨æ­¤ç›®å½•ä¸‹ï¼Œåˆ·å…¥ magisk æ— æ•ˆï¼‰\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c3c9d8aa38426294d85cfdd38255a4~tplv-k3u1fbpfcp-zoom-1.image)\n\n5.5 è®¾å¤‡è¿›å…¥ BootLoader æ¨¡å¼\n    æ–¹å¼ä¸€ï¼šæ‰§è¡Œ adb reboot bootloader\n    æ–¹å¼äºŒï¼šå…³æœºçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶æŒ‰ä½Â éŸ³é‡â€”Â +Â ç”µæºé”®\n\næ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç­‰å¾…å®Œæˆï¼Œä½¿ç”¨å‘½ä»¤é‡å¯è®¾å¤‡ï¼›é‡å¯åé‡æ–°æ‰“å¼€ magisk æ˜¾ç¤ºç‰ˆæœ¬å·è¡¨ç¤ºæˆåŠŸã€‚Â \n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0cf7cae60c44815b1127984face396c~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe997317c794ad08d6c1242a54bf9a5~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35d48af81574b27bfba0c5eca5cfdc0~tplv-k3u1fbpfcp-zoom-1.image)\n\n**6ã€åˆ·å…¥ LSPosted**\n\nå®˜ç½‘ï¼šhttps://github.com/LSPosed/LSPosedã€https://github.com/RikkaApps/Riru/tags\n\n6.1 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c329e61e1fc48e5945863ce1a1f8cda~tplv-k3u1fbpfcp-zoom-1.image)\n\n6.2 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d948643a1a3f4bf79cb1ee7dd8075ea1~tplv-k3u1fbpfcp-zoom-1.image)\n\n6.3 ä¸‹è½½**LSPosted-zygisk**å¤‡ç”¨ï¼ˆå¿…é€‰ï¼‰\n\nå¦‚æœè®¾å¤‡æ”¯æŒ Zygiskï¼Œrituã€LSPosted-ritu æ¨¡å—å¯ä¸éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨æ”¯æŒ Zygisk çš„è®¾å¤‡\n\n6.4 æ‰“å¼€ Magisk å¼€å§‹åˆ·å…¥å¿…é€‰æ¨¡å—ï¼ŒæŒ‰ç…§æç¤ºé‡å¯è®¾å¤‡åæ˜¾ç¤ºÂ Zygisk æ˜¯ï¼Œæ¡Œé¢å‡ºç° LSPosted\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8e39c410d444628be03c7f83adaf92a~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b73cb22078b4610a4fac35e369b8eea~tplv-k3u1fbpfcp-zoom-1.image)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90ae1ca939964ce68b0e56331bd50b63~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baffbe16b1d04a1899ba2c4caee9b37b~tplv-k3u1fbpfcp-watermark.image?)\n\n**7ã€å®‰è£…æ£€æµ‹æ¨¡å—**\n\nå¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…æˆ‘ä»¬çš„Â **åˆè§„æ£€æµ‹æ¨¡å—**ï¼Œé‚£ä¹ˆç°åœ¨è¦å®‰è£…å•¦ï¼ï¼ï¼å¯åŠ¨æ¨¡å—ï¼Œå‹¾é€‰è¦æ£€æµ‹çš„åº”ç”¨ï¼Œè¿”å›æ¡Œé¢æ‰§è¡Œåº”ç”¨å°±å¯ä»¥çœ‹æ—¥å¿—\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5196bdc80d84b64b8fd752e47285651~tplv-k3u1fbpfcp-watermark.image?)\n\n# å…¶ä»–\n\n- âš ï¸ Android 9 åŠå…¶ä»¥ä¸‹è®¾å¤‡æ‰æ”¯æŒ IMEI è·å–ï¼Œåœ¨æµ‹è¯•è®¾å¤‡é€‰æ‹©ä¸Šéœ€æ³¨æ„\n- [å­¦ä¹ ç½‘ç«™ï¼šXDA Forums](https://forum.xda-developers.com/) è¯¥ç½‘ç«™çš„ä¸»è¦è®¨è®ºæ‰‹æœºç³»ç»Ÿï¼Œå¹¶æä¾›ç›¸å…³è®¾å¤‡çš„æŠ€æœ¯ä¿¡æ¯ã€[ROM](https://zh.m.wikipedia.org/wiki/ROM)å‡çº§ã€æŠ€æœ¯æ”¯æŒã€Qï¼†A\n- [ææœºç½‘ç«™ï¼šUAæ‰‹æœºç»´ä¿®äº¤æµ - Powered by Discuz!](https://bbs.gsmua.cn/)\n    å¯æä¾› UAndroid å·¥å…·ï¼Œç”¨äºå„å‚å•†è®¾å¤‡ BootLoader è§£é”\n    ä»˜è´¹å·¥å…·ã€ä¹Ÿå¯ä»¥è´¦å·ç§Ÿç”¨æ–¹å¼ä½¿ç”¨ï¼ˆä¸“ä¸šææœºï¼ŒæŸå®ä¹Ÿæœ‰ç›¸å…³æŠ€æœ¯æœåŠ¡ï¼‰\n","source":"_posts/undefined/è®¾å¤‡ä¿¡æ¯è·å–æ£€æµ‹.md","raw":"---\ntitle: Xposted æ£€æµ‹è·å–è®¾å¤‡ä¿¡æ¯\ncatalog: true\ndate: 2022-09-29 22:59:00\nsubtitle: æ‹’ç»åº”ç”¨ä¸åˆç†è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸º\nheader-img: /img/220928/xposted_bg.png\ntags: åˆ·æœº\nsticky: 4\ncategories:\n---\n\n\n# å‰è¨€ \n\nè®¾å¤‡çš„ä¸ªäººä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè”ç³»äººä¿¡æ¯ã€çŸ­ä¿¡å†…å®¹ç­‰ï¼‰å±äºç”¨æˆ·éšç§ï¼Œè¿è§„è·å–ä¸ªäººä¿¡æ¯è¢«è§†ä¸ºä¾µçŠ¯ç”¨æˆ·æƒç›Šï¼›åœ¨è®¾å¤‡ä¸Šè·å–ä¸ªäººä¿¡æ¯ä¸€èˆ¬éœ€å…ˆè·å–åˆ°ç›¸åº”çš„æƒé™æ‰èƒ½è¿›è¡Œè·å–ï¼Œä¾‹å¦‚æƒ³è·å–ç›¸å†Œå›¾ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦ç”³è¯·è¯»å†™æƒé™ï¼Œç”¨æˆ·åŒæ„æƒé™ç”³è¯·ä¹‹åå¯è¯»å–ç›¸å†Œå›¾ç‰‡ã€‚åº”ç”¨å­˜åœ¨è¿è§„è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºï¼Œä¸ä¸ºç½•è§ï¼Œä½•ä¸ºè¿è§„è¡Œä¸ºï¼Ÿ\n\nä¸ªäººç†è§£ï¼š\n- åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…ä¸‹è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·åŒæ„éšç§æ”¿ç­–å‰è·å–ä¸ªäººä¿¡æ¯\n- æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾ã€‚æ¯”å¦‚ï¼Œéšç§æ”¿ç­–æˆ–è¯´æ˜æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾\n- è¶…èŒƒå›´è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå£çº¸ App ç”³è¯·å½•éŸ³æƒé™\n\næ­¤å‰ï¼Œéƒ¨åˆ†åº”ç”¨å­˜åœ¨å¯¹ç”¨æˆ·ä¸ªäººä¿¡æ¯è¿è§„è·å–çš„è¡Œä¸ºï¼Œä¸ªäººéšç§æƒç›Šä¿æŠ¤æ„è¯†è–„å¼±ï¼Œè¿è§„è·å–çš„è¡Œä¸ºæœªå¾—åˆ°æœ‰æ•ˆè§£å†³ï¼Œç›´åˆ° 2019 å¹´ä½ï¼Œå·¥ä¿¡éƒ¨å‘å¸ƒå…³äºå°å‘ã€ŠAppè¿æ³•è¿è§„æ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯è¡Œä¸ºè®¤å®šæ–¹æ³•ã€‹é€šçŸ¥ï¼Œåº”ç”¨å•†åº—é€æ¸å¼€å§‹å¯¹è¿è§„è·å–è¡Œä¸ºè¦æ±‚æ•´æ”¹ã€‚\n\n```java\n- æœªå…¬å¼€æ”¶é›†ä½¿ç”¨è§„åˆ™çš„è¡Œä¸º\n- æœªæ˜ç¤ºæ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯çš„ç›®çš„ã€æ–¹å¼å’ŒèŒƒå›´çš„è¡Œä¸º\n- æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºã€è¯¥ç‚¹ä¸ºæœ¬æ–‡è®¨è®ºå’Œè§£å†³çš„é‡ç‚¹ã€‘\n- æ”¶é›†ä¸å…¶æä¾›æœåŠ¡æ— å…³çš„ä¸ªäººä¿¡æ¯çš„è¡Œä¸º\n- æœªç»åŒæ„å‘ä»–äººæä¾›ä¸ªäººä¿¡æ¯çš„è¡Œä¸º\n- æœªæŒ‰æ³•å¾‹è§„å®šæä¾›åˆ é™¤æˆ–æ›´æ­£ä¸ªäººä¿¡æ¯åŠŸèƒ½çš„\n\né™¤æ­¤ä¹‹å¤–ï¼Œå›½å†…å•†åº—æ¸ é“è¿˜æœ‰å…¶ä»–è¦æ±‚ï¼Œæ¯”å¦‚ï¼š\n- ä¸å…è®¸é¢‘ç¹è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆIMEIã€SSIDã€AndroidID ç­‰ï¼‰\n```\n\n![origin_img_v2_640fd02b-1194-4342-9ed9-200b1e9bf7ag.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0f36e7ad9b4293b24fc5afcc4bc7a8~tplv-k3u1fbpfcp-watermark.image?)\n\nä»¥ä¸‹å›´ç»•å¦‚ä½•æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜åœ¨**æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯**çš„è¡Œä¸ºï¼Œä»¥åŠ**æ˜¯å¦å­˜åœ¨é¢‘ç¹è·å–ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯**çš„è¡Œä¸ºã€‚\n\n\n# Xposted æ¨¡å—\n\n## ä»‹ç» â˜•ï¸\n\nè¯¥æ¨¡æ¿ç¼–å†™ä¸»è¦æ˜¯ Hook çŸ¥è¯†ç‚¹ï¼ŒHook ä½œä¸ºâ€˜é’©å­â€™å¯ä»¥ç²—ç•¥ç†è§£ä¸ºæ‹¦æˆªæŸæ®µä»£ç çš„æ‰§è¡Œï¼Œå¹¶åœ¨ä»£ç æ®µå‰åæ’å…¥ç›‘æ§äº‹ä»¶ï¼Œç¨‹åºæ‰§è¡Œæ­¤ä»£ç æ®µåŒæ—¶ä¹Ÿå°†è§¦å‘ç›‘æ§äº‹ä»¶ï¼Œå°†ç›‘æ§äº‹ä»¶è¿”å›ç»™å¤–å±‚ç”¨äºè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸ªäººç†è§£ï¼Œä½¿ç”¨ Hook å·¥å…·è¾ƒä¸ºå…³é”®çš„ä¸€ç‚¹å°±æ˜¯æ‰¾åˆ°è¾ƒä¸ºå‡†ç¡®çš„ Hook ç‚¹ã€‚\n\n## Hook æ¡†æ¶ ğŸ¤”\n\nAndroid ä¸Šçš„ Hook æ¡†æ¶ï¼Œæƒ³å¿…å¾ˆå¤šäººéƒ½ç•¥æœ‰è€³é—»ï¼Œå½“å¹´ç‹‚çƒ­çš„ **Xposted**ï¼Œåé¢ç¼–å†™çš„æ£€æµ‹å·¥å…·ä¾¿æ˜¯åŸºäº Xposted åº“ï¼ŒXposted æ¨¡å—ç¼–å†™æ•™ç¨‹åœ¨ç½‘ä¸Šæ˜¯æ»¡å¤©é£ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘è§‰å¾—æè¿°å¾—æ¯”è¾ƒæ¸…æ™°ï¼š[æ–°æ‰‹ä¸è¦å†è¢«è¯¯å¯¼ï¼è¿™æ˜¯ä¸€ç¯‡æœ€æ–°çš„Xposedæ¨¡å—ç¼–å†™æ•™ç¨‹](https://www.freebuf.com/articles/terminal/189021.html)ã€‚çœ‹å®Œå¼•ç”¨çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“ xposted åº“ä½¿ç”¨çš„ hook æ¨¡æ¿ï¼Œæ£€æµ‹å·¥å…·æ ¹æ®æ¨¡æ¿ç¼–å†™ä»£ç ï¼Œæ•´åˆå¤šä¸ªæ£€æµ‹ç‚¹å°±å¯ä»¥ï¼ˆæ¯”å¦‚æˆ‘éœ€è¦æ£€æµ‹ AndroidIdã€MACã€IMEI ç­‰çš„è·å–ï¼‰ã€‚\n\n```java\n//æ¨¡æ¿\nXposedHelpers.findAndHookMethod(\nclassName,      //éœ€è¦ hook çš„ç±»åï¼Œå› ä¸ºä½¿ç”¨åå°„ï¼Œéœ€è¦ç±»çš„å…¨é™å®šå\nmethondName,    //éœ€è¦ hook çš„æ–¹æ³•ç­¾å\nparams1.class,  //éœ€è¦ hook çš„æ–¹æ³•çš„å‚æ•°ï¼ˆå‚æ•°å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œå‚æ•°ç±»å‹éœ€å’Œæ–¹æ³•ç­¾åä¿æŒä¸€è‡´ï¼‰\nparams2.class,\n...\nnew XC_MethodHook() {\n\n    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {\n      //hook before\n    }\n    protected void afterHookedMethod(MethodHookParam param) throws Throwable {\n      //hook after\n    }});\n\n```\n\n## ä¸¾ä¸ªæ —å­ğŸŒ°\n\nAndroid Java å±‚è·å– AndroidID çš„ä»£ç é€šå¸¸æ˜¯ï¼š\n\n```java\nSettings.Secure.getString(context.getContentResolver(), \nSettings.Secure.ANDROID_ID);\n```\n\né‚£ä¹ˆï¼Œæ ¹æ®ä¸Šè¿°çš„ hook æ¨¡ç‰ˆï¼Œæ‰¾åˆ°ä»¥ä¸‹å‚æ•°åªå€¼ï¼š\n\n- classNameï¼šandroid.provider.Settings\n- methodNameï¼šgetString ï¼ˆæœ‰å‚æ–¹æ³•ï¼Œæ³¨æ„åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°å¯æ ¹æ®ä¸åŒçš„ä¼ å€¼è·å–ä¸åŒçš„è®¾å¤‡ä¿¡æ¯ï¼‰\n- params1ï¼šContentResolver.class\n- params2ï¼šString.class\n\nç”±æ­¤å¯å¾— androidId è·å–æ£€æµ‹ä»£ç ï¼š\n\n```java\n// æ£€æµ‹ AndroidID è·å–\nXposedHelpers.findAndHookMethod(\n\"android.provider.Settings\",\n\"getString\",\nContentResolver.class,\nString.class,\nnew XC_MethodHook() {\n\n    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {\n      //hook before\n    }\n    protected void afterHookedMethod(MethodHookParam param) throws Throwable {\n      //hook after\n      if(param == null)return;\n      //æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåˆ—è¡¨\n      Object[] args = param.args;\n      if(args == null || args.lenght <= 0)return;\n      //getString æ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“ç¬¬äºŒä¸ªå‚æ•°å€¼æ‰æœ‰æ„ä¹‰ï¼Œæ‰èƒ½ç»§ç»­åˆ¤æ–­æ˜¯è·å– androidid è¿˜æ˜¯åˆ«çš„ä¿¡æ¯\n      if(args.lenght >= 2){\n          String params2 = (String)args[1];\n          //æ³¨æ„ï¼špublic static final String ANDROID_ID = \"android_id\";\n          if(\"android_id\".equal(params2)){\n              Log.d(\"TAG\",\"æ£€æµ‹åˆ°è·å– androidid\")\n          }\n      }\n    }});\n\n```\n\nå°±è¿™æ ·ï¼Œæ£€æµ‹ androidid è·å–çš„ä»£ç å°±å†™å¥½äº†ï¼Œç®€å•å§ã€‚å¦‚æœä½ å¯¹ xposted å®ç°æ„Ÿå…´è¶£å¯ä»¥çœ‹æºç [ï¼šandroid-hacker-VirtualXposted](https://github.com/android-hacker/VirtualXposed)ã€‚æŸ¥çœ‹ android æºç å¯çŸ¥ï¼Œè·å– androidid çš„ getString æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å¯é€‰å€¼\n\n```java\n//æ‰€ä»¥ï¼Œå½“ä½  Hook è¿™ä¸ªæ–¹æ³•æ—¶å€™ï¼Œä¸ä»…ä»…å¯ä»¥ Hook AndroidID çš„è·å–ï¼Œä¹Ÿå¯ä»¥æ£€æµ‹å…¶ä»–ä¿¡æ¯çš„è·å–æƒ…å†µ\n//public static final String ANDROID_ID = \"android_id\";\nstatic {\n    MOVED_TO_SECURE = new HashSet<>(30);\n    MOVED_TO_SECURE.add(Secure.ADAPTIVE_SLEEP);\n    MOVED_TO_SECURE.add(Secure.ANDROID_ID);\n    MOVED_TO_SECURE.add(Secure.HTTP_PROXY);\n    MOVED_TO_SECURE.add(Secure.LOCATION_PROVIDERS_ALLOWED);\n    MOVED_TO_SECURE.add(Secure.LOCK_BIOMETRIC_WEAK_FLAGS);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_ENABLED);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_VISIBLE);\n    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_TACTILE_FEEDBACK_ENABLED);\n    MOVED_TO_SECURE.add(Secure.LOGGING_ID);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_ENABLED);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_LAST_UPDATE);\n    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_REDIRECT_URL);\n    MOVED_TO_SECURE.add(Secure.SETTINGS_CLASSNAME);\n    MOVED_TO_SECURE.add(Secure.USE_GOOGLE_MAIL);\n    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY);\n    MOVED_TO_SECURE.add(Secure.WIFI_NUM_OPEN_NETWORKS_KEPT);\n    MOVED_TO_SECURE.add(Secure.WIFI_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ACCEPTABLE_PACKET_LOSS_PERCENTAGE);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_AP_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_DELAY_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_ENABLED);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_TIMEOUT_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_INITIAL_IGNORED_PING_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_MAX_AP_CHECKS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ON);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_COUNT);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_DELAY_MS);\n    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_TIMEOUT_MS);\n\n    // At one time in System, then Global, but now back in Secure\n    MOVED_TO_SECURE.add(Secure.INSTALL_NON_MARKET_APPS);\n}\n```\n\n## æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç  ğŸ¤”ï¸\n\nè¯»åˆ°è¿™é‡Œï¼Œæ ¹æ®ä¸Šé¢çš„ xposted hook æ¨¡æ¿ï¼Œæ€ç»´å‘æ•£ï¼Œä½ å·²ç»å…·å¤‡å†™ä¸€ä¸ªåˆè§„æ£€ Xposted æ’ä»¶çš„èƒ½åŠ›ã€‚é€šå¸¸ï¼Œåˆè§„æ£€æµ‹æ’ä»¶åº”è¯¥ hook å“ªäº›åœ°æ–¹ï¼Ÿåº”è¯¥æ£€æµ‹å“ªäº›ä¿¡æ¯çš„è·å–è¡Œä¸ºï¼Ÿå…¶å®ä½ å¯ä»¥å‚è€ƒæ¸ é“å®¡æ ¸è¦æ±‚ç»¼åˆè€ƒè™‘ï¼Œå½’çº³æ€»ç»“ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹å‡ ç‚¹ï¼š\n- androidID æ£€æµ‹\n- IMEI æ£€æµ‹\n- SSID æ£€æµ‹\n- IMSI æ£€æµ‹\n- MAC æ£€æµ‹\n- OAID æ£€æµ‹ã€å› ä¸ºè·å– IMEI çš„é—®é¢˜ï¼Œç°åœ¨å›½å†…å¾ˆå¤šéƒ½åœ¨ä½¿ç”¨ OAIDã€‘\n- å®šä½ä¿¡æ¯è¯»å–æ£€æµ‹\n- è”ç³»äººåˆ—è¡¨è¯»å–æ£€æµ‹\n- çŸ­ä¿¡å†…å®¹æ£€æµ‹\n- ç›¸å†Œè¯»å–æ£€æµ‹\n- è½¯ä»¶å®‰è£…åˆ—è¡¨è¯»å–æ£€æµ‹\n- åº”ç”¨ä¿¡æ¯è¯»å–æ£€æµ‹\n\n\nç¼–å†™åˆè§„æ£€æµ‹æ’ä»¶å¯èƒ½é‡åˆ°æˆ–éœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ\n- åº”ç”¨çš„å¤šè¿›ç¨‹ç¯å¢ƒã€‚é¿å…æŸäº›æ“ä½œé‡å¤æ‰§è¡Œï¼Œæ£€æµ‹æ•°æ®é‡å¤\n- ä¿¡æ¯è·å–è·å–è¡Œä¸ºæ•°æ®å¤„ç†ã€‚æ˜¯å¦éœ€å¼•å…¥æ•°æ®æŒä¹…åŒ–æ¡†æ¶ï¼Œå¯¹æ•°æ®å­˜å‚¨åç»Ÿä¸€å¤„ç†\n- Android å¹³å°æ•°æ®åº“æ¡†æ¶åˆå§‹åŒ–ä¾èµ– contextã€‚æ˜¯å¦éœ€è¦ hook application è·å– context\n- ç­‰ç­‰ï¼ˆéœ€æ±‚é©±åŠ¨å¼€å‘ï¼‰\n\n\n# Use VirtualXposted ğŸ’”\n\n**æ–¹æ¡ˆå¯è¡Œä½†ä¸æ¨èï¼Œå­˜åœ¨ä¸€å®šçš„å±€é™**\n\nä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿæœ‰ä»€ä¹ˆå±€é™ï¼Ÿéœ€æ£€æŸ¥åº”ç”¨è¿è¡Œç¯å¢ƒä»¥æ¥ VirtualXpostedAppï¼Œä¾µå…¥æ€§å¼ºï¼Œæ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹åˆ°å­˜åœ¨ xposted ç¯å¢ƒï¼Œxposted hook ç‰¹å¾æ˜æ˜¾ï¼Œå®¹æ˜“è¢«æ£€æµ‹ã€‚æ¯”å¦‚æŸäº›åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹ SDK æœ‰åš xposted é˜²æŠ¤ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è¿è¡Œç¯å¢ƒå­˜åœ¨ xpostedï¼Œå¯èƒ½ä¼šåšç›¸åº”å¤„ç†â€”â€”â€”â€”ç»ˆæ­¢ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¸åˆ©äºæ£€æµ‹åº”ç”¨ä¸ªäººä¿¡æ¯è·å–æƒ…å†µã€‚ä¼˜ç‚¹æ˜¯ç¯å¢ƒå‡†å¤‡ç®€å•ã€‚\n\n## å¦‚ä½•ä½¿ç”¨\n\n1ã€ä¸‹è½½å®‰è£… virtualXposted\n\n[android-hacker-VirtualXposted](https://github.com/android-hacker/VirtualXposed)\n\n2ã€æ¿€æ´» xposted \n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca83e472c58447ce84f6eb4f1aad5b2e~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b53d5cd381f419ba50e4eea9f9f8a39~tplv-k3u1fbpfcp-watermark.image?)\n\n3ã€æ·»åŠ æ¨¡æ¿å’Œå¾…æ£€æµ‹åº”ç”¨\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e93823fe3fe14092a287bb6ac95c3310~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39273c5ee0534cc4b705ee3de92d9fc0~tplv-k3u1fbpfcp-watermark.image?)\n\n4ã€å¯åŠ¨æ¨¡å—\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5bc1c3afd294c378d5cb57d7f7dda1b~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/798cac0dc3e2428699a16d74bfab6d44~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7748fbdc0e24f12bc2148383117e9b8~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5622c01867c64155a5cae84c6a57be57~tplv-k3u1fbpfcp-watermark.image?)\n\næœ€åå°±æ˜¯è¿è¡Œåº”ç”¨ï¼ŒæŸ¥çœ‹è‡ªå®šä¹‰è¾“å‡ºæ—¥å¿—ã€‚ç”±äº xposted é˜²æŠ¤çš„å±€é™ï¼Œè‹¥ä¸èƒ½æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿˜éœ€å¦å¯»ä»–æ³•ã€‚\n\n# Use Taichi ğŸ’”\n\n**æ–¹æ¡ˆä¸å¯è¡Œä½†ä¸æ¨èï¼Œå†™å¥½çš„æ¨¡æ¿æ— æ³•ä½¿ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰**\n\nä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿå†™å¥½çš„æ£€æµ‹æ¨¡æ¿è¢«é™åˆ¶ä½¿ç”¨ï¼Œå®˜ç½‘ï¼šhttps://github.com/taichi-framework/TaiChi\n\nå¦‚ä½•ä½¿ç”¨å¤ªæå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼Œè¿™é‡Œæä¸‹é‡åˆ°çš„é—®é¢˜ï¼š\n\n**é—®é¢˜ä¸€ï¼šæš‚ä¸æ”¯æŒ**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ef794ca6102471bb11b702f6f062a1f~tplv-k3u1fbpfcp-watermark.image?)\n\n**çœ‹ä¸‹å®˜ç½‘æœ‰å¯¹â€˜æš‚æ—¶ä¸æ”¯æŒâ€™çš„æè¿°ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š**\n\n- å½“å‰å¤ªææ˜¯å¤ªæé˜´æ¨¡å¼ï¼ˆæœ‰é˜´ã€é˜³ä¸¤ç§æ¨¡å¼ï¼Œè‡ªè¡Œå®˜ç½‘äº†è§£ï¼‰\n- å½“å‰æ¨¡å—ä¸å­˜åœ¨ç™½åå•ä¸­\n\næš‚æ—¶æ²¡åŠæ³•ï¼Œè¯•è¯•æŠŠå¤ªææ¿€æ´»ä¸ºâ€˜å¤ªæé˜³â€™æ¨¡å¼ï¼Œç„¶è€Œå‘¢è¿˜æ˜¯æ˜¾ç¤ºæš‚ä¸æ”¯æŒï¼›çŒœæµ‹æ˜¯å¦ä¸€ç§å¯èƒ½ï¼Œæ¨¡æ¿ä¸å­˜åœ¨ç™½åå•ä¸­ï¼Œè¦åŠ å…¥ç™½åå•è¦è”ç³»ä½œè€…ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜æ˜¯å¦å¯»ä»–æ³•å§ã€‚åæ¥å‘ç°äº†å¦ä¸€ä¸ªæ¡†æ¶ LSP ã€‚ï¼ˆå¦‚ä½•å¼€å¯å¤ªæé˜³ï¼Œå®˜ç½‘æœ‰æ•™ç¨‹ï¼Œéœ€è¦å€ŸåŠ© Magiskï¼Œä¸‹æ–‡ä¼šç”¨åˆ°è¿™ä¸ªå·¥å…·ï¼‰\n\n# Use Lsposted â¤ï¸\n\n**æ–¹æ¡ˆå¯è¡Œï¼Œæ¨èä½¿ç”¨**\nä¸ºä»€ä¹ˆæ¨èï¼ŸLSP ä¾µå…¥æ€§å¼±ï¼Œä¸æ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿé¿å… xposted é˜²æŠ¤ã€‚\n\n## æ³¨æ„äº‹é¡¹\n\n- BootLoader è§£é”å°†æ¸…é™¤è®¾å¤‡æ•°æ®ï¼Œé‡è¦æ•°æ®è¯·æ³¨æ„å¤‡ä»½\n- æ­¤æ“ä½œéœ€è¦è®¾å¤‡è§£é” Bootloader ï¼ˆåˆ·æœºï¼‰ï¼Œè‹¥BootLoader è§£é”å¤±è´¥ï¼Œå…¶ä»–æ“ä½œå·²æ— æ„ä¹‰ï¼Œæ²¡æœ‰ç»§ç»­æ“ä½œçš„å¿…è¦ï¼Œå»ºè®®æ›´æ¢è®¾å¤‡ã€‚\n- å„å‚å•†è®¾å¤‡ BootLoader è§£é”æ–¹å¼å¯èƒ½ä¸å°½ç›¸åŒã€‚\n    - å°ç±³å®˜ç½‘ä»ç„¶å¼€æ”¾ BL è§£é”å·¥å…·ï¼ˆå»ºè®®ä½¿ç”¨å°ç±³æ‰‹æœºæµ‹è¯•ï¼‰\n    - è´­ä¹°ç¬¬ä¸‰æ–¹è§£é”å·¥å…· UAndroid\n    - OPPO å®˜æ–¹ä¹Ÿæœ‰â€˜æ·±åº¦æµ‹è¯•â€™è§£é”å·¥å…·ï¼Œä½†ç”³è¯·åé¢æœ‰é™ï¼Œå®¡æ ¸æ—¶é—´é•¿ï¼Œä¸æ¨è\n\n## å¦‚ä½•ä½¿ç”¨\n\nä»¥å°ç±³æ‰‹æœºä¸ºä¾‹ï¼ˆå› ä¸º BL è§£é”æ–¹ä¾¿ï¼‰\n\n**1ã€è®¾å¤‡ Bootloader è§£é”**\n\n[å®˜æ–¹ï¼šç”³è¯·è§£é”å°ç±³æ‰‹æœº](http://www.miui.com/unlock/download.html)\n\nå°ç±³çš„ BL è§£é”å¯¹è®¾å¤‡çš„ä»¥åŠè´¦å·ç»‘å®šä¹Ÿæœ‰è¦æ±‚ï¼Œæ¯”å¦‚è´¦å·ä¸è®¾å¤‡ç»‘å®šæ—¶é—´ç­‰ã€‚å®˜ç½‘ä¸‹è½½å¾—åˆ°çš„å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚\n\n**2ã€ä¸‹è½½å®‰è£… Magisk**\n\nå®˜ç½‘ï¼šhttps://github.com/topjohnwu/Magisk\n\n**3ã€ä¸‹è½½å¤‡ç”¨ adb-fastboot**\n\né“¾æ¥ï¼šhttps://mrzzoxo.lanzouw.com/iMbPYz63p6f\n\n**4ã€å‡†å¤‡å¯¹åº”è®¾å¤‡å‹å·çš„åˆ·æœºåŒ…**\n\nå°ç±³åˆ·æœºåŒ…ï¼šhttps://mirom.ezbox.idv.tw/phone/\n\nä¸€èˆ¬å»ºè®®ä¸‹è½½å¤§é™†ç¨³å®šç‰ˆï¼ˆè‹¥æ˜¯å…¶ä»–å‚å•†åˆ·æœºåŒ…ï¼Œè‡ªè¡Œå¯»æ‰¾ï¼‰\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87a8268965d648df8775781e37f77679~tplv-k3u1fbpfcp-watermark.image?)\n\n**5ã€åˆ·å…¥ Magisk**\n\nå°½é‡æŒ‰é¡ºåºæ“ä½œ\n\n5.1 ä»åˆ·æœºåŒ…ä¸­è§£å‹è·å–Â Â **boot.img** æ–‡ä»¶ï¼ˆè‹¥æ— æ­¤æ–‡ä»¶å»ºè®®æ›´æ¢åˆ·æœºåŒ…ï¼Œä¹Ÿå¯ä»¥å¦å¯»ä»–æ³•ä»åˆ·æœºåŒ…ä¸­è§£æè·å¾—æ­¤æ–‡ä»¶ï¼‰\n5.2 æ‰“å¼€ Magisk é€‰æ‹© boot.img å®‰è£…è¡¥ä¸ï¼Œç­‰å¾…åˆ·å…¥å®Œæˆï¼ˆæ­¤æˆªå›¾æ˜¯å·²å®‰è£…å®Œæˆçš„ï¼Œä»¥å®é™…ä¸ºå‡†ï¼‰\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6b1f76ad8845d98bf1f2c901286ed9~tplv-k3u1fbpfcp-watermark.image?)\n\n5.3 åˆ·å…¥å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—è·å¾—ç”Ÿæˆçš„ img æ–‡ä»¶\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0d9d3a707544199a1b8e5f5518b4e4f~tplv-k3u1fbpfcp-zoom-1.image)\n\n5.4 å¤åˆ¶ç”Ÿæˆçš„Â img æ–‡ä»¶å’Œ boot.img æ–‡ä»¶åˆ° adb-fastboot ç›®å½•ä¸‹ï¼Œæ‰“å¼€Â æ‰“å¼€CMDå‘½ä»¤è¡Œ.batï¼ˆè‹¥ boot.img ä¸å­˜åœ¨æ­¤ç›®å½•ä¸‹ï¼Œåˆ·å…¥ magisk æ— æ•ˆï¼‰\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c3c9d8aa38426294d85cfdd38255a4~tplv-k3u1fbpfcp-zoom-1.image)\n\n5.5 è®¾å¤‡è¿›å…¥ BootLoader æ¨¡å¼\n    æ–¹å¼ä¸€ï¼šæ‰§è¡Œ adb reboot bootloader\n    æ–¹å¼äºŒï¼šå…³æœºçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶æŒ‰ä½Â éŸ³é‡â€”Â +Â ç”µæºé”®\n\næ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç­‰å¾…å®Œæˆï¼Œä½¿ç”¨å‘½ä»¤é‡å¯è®¾å¤‡ï¼›é‡å¯åé‡æ–°æ‰“å¼€ magisk æ˜¾ç¤ºç‰ˆæœ¬å·è¡¨ç¤ºæˆåŠŸã€‚Â \n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0cf7cae60c44815b1127984face396c~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe997317c794ad08d6c1242a54bf9a5~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35d48af81574b27bfba0c5eca5cfdc0~tplv-k3u1fbpfcp-zoom-1.image)\n\n**6ã€åˆ·å…¥ LSPosted**\n\nå®˜ç½‘ï¼šhttps://github.com/LSPosed/LSPosedã€https://github.com/RikkaApps/Riru/tags\n\n6.1 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c329e61e1fc48e5945863ce1a1f8cda~tplv-k3u1fbpfcp-zoom-1.image)\n\n6.2 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d948643a1a3f4bf79cb1ee7dd8075ea1~tplv-k3u1fbpfcp-zoom-1.image)\n\n6.3 ä¸‹è½½**LSPosted-zygisk**å¤‡ç”¨ï¼ˆå¿…é€‰ï¼‰\n\nå¦‚æœè®¾å¤‡æ”¯æŒ Zygiskï¼Œrituã€LSPosted-ritu æ¨¡å—å¯ä¸éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨æ”¯æŒ Zygisk çš„è®¾å¤‡\n\n6.4 æ‰“å¼€ Magisk å¼€å§‹åˆ·å…¥å¿…é€‰æ¨¡å—ï¼ŒæŒ‰ç…§æç¤ºé‡å¯è®¾å¤‡åæ˜¾ç¤ºÂ Zygisk æ˜¯ï¼Œæ¡Œé¢å‡ºç° LSPosted\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8e39c410d444628be03c7f83adaf92a~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b73cb22078b4610a4fac35e369b8eea~tplv-k3u1fbpfcp-zoom-1.image)\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90ae1ca939964ce68b0e56331bd50b63~tplv-k3u1fbpfcp-watermark.image?)\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baffbe16b1d04a1899ba2c4caee9b37b~tplv-k3u1fbpfcp-watermark.image?)\n\n**7ã€å®‰è£…æ£€æµ‹æ¨¡å—**\n\nå¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…æˆ‘ä»¬çš„Â **åˆè§„æ£€æµ‹æ¨¡å—**ï¼Œé‚£ä¹ˆç°åœ¨è¦å®‰è£…å•¦ï¼ï¼ï¼å¯åŠ¨æ¨¡å—ï¼Œå‹¾é€‰è¦æ£€æµ‹çš„åº”ç”¨ï¼Œè¿”å›æ¡Œé¢æ‰§è¡Œåº”ç”¨å°±å¯ä»¥çœ‹æ—¥å¿—\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5196bdc80d84b64b8fd752e47285651~tplv-k3u1fbpfcp-watermark.image?)\n\n# å…¶ä»–\n\n- âš ï¸ Android 9 åŠå…¶ä»¥ä¸‹è®¾å¤‡æ‰æ”¯æŒ IMEI è·å–ï¼Œåœ¨æµ‹è¯•è®¾å¤‡é€‰æ‹©ä¸Šéœ€æ³¨æ„\n- [å­¦ä¹ ç½‘ç«™ï¼šXDA Forums](https://forum.xda-developers.com/) è¯¥ç½‘ç«™çš„ä¸»è¦è®¨è®ºæ‰‹æœºç³»ç»Ÿï¼Œå¹¶æä¾›ç›¸å…³è®¾å¤‡çš„æŠ€æœ¯ä¿¡æ¯ã€[ROM](https://zh.m.wikipedia.org/wiki/ROM)å‡çº§ã€æŠ€æœ¯æ”¯æŒã€Qï¼†A\n- [ææœºç½‘ç«™ï¼šUAæ‰‹æœºç»´ä¿®äº¤æµ - Powered by Discuz!](https://bbs.gsmua.cn/)\n    å¯æä¾› UAndroid å·¥å…·ï¼Œç”¨äºå„å‚å•†è®¾å¤‡ BootLoader è§£é”\n    ä»˜è´¹å·¥å…·ã€ä¹Ÿå¯ä»¥è´¦å·ç§Ÿç”¨æ–¹å¼ä½¿ç”¨ï¼ˆä¸“ä¸šææœºï¼ŒæŸå®ä¹Ÿæœ‰ç›¸å…³æŠ€æœ¯æœåŠ¡ï¼‰\n","slug":"è®¾å¤‡ä¿¡æ¯è·å–æ£€æµ‹","published":1,"lang":"undefined","updated":"2022-09-29T14:59:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl99ignsu000ugaqp3srpgi83","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h1>å‰è¨€</h1>\n<p>è®¾å¤‡çš„ä¸ªäººä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè”ç³»äººä¿¡æ¯ã€çŸ­ä¿¡å†…å®¹ç­‰ï¼‰å±äºç”¨æˆ·éšç§ï¼Œè¿è§„è·å–ä¸ªäººä¿¡æ¯è¢«è§†ä¸ºä¾µçŠ¯ç”¨æˆ·æƒç›Šï¼›åœ¨è®¾å¤‡ä¸Šè·å–ä¸ªäººä¿¡æ¯ä¸€èˆ¬éœ€å…ˆè·å–åˆ°ç›¸åº”çš„æƒé™æ‰èƒ½è¿›è¡Œè·å–ï¼Œä¾‹å¦‚æƒ³è·å–ç›¸å†Œå›¾ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦ç”³è¯·è¯»å†™æƒé™ï¼Œç”¨æˆ·åŒæ„æƒé™ç”³è¯·ä¹‹åå¯è¯»å–ç›¸å†Œå›¾ç‰‡ã€‚åº”ç”¨å­˜åœ¨è¿è§„è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºï¼Œä¸ä¸ºç½•è§ï¼Œä½•ä¸ºè¿è§„è¡Œä¸ºï¼Ÿ</p>\n<p>ä¸ªäººç†è§£ï¼š</p>\n<ul>\n<li>åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…ä¸‹è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·åŒæ„éšç§æ”¿ç­–å‰è·å–ä¸ªäººä¿¡æ¯</li>\n<li>æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾ã€‚æ¯”å¦‚ï¼Œéšç§æ”¿ç­–æˆ–è¯´æ˜æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾</li>\n<li>è¶…èŒƒå›´è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå£çº¸ App ç”³è¯·å½•éŸ³æƒé™</li>\n</ul>\n<p>æ­¤å‰ï¼Œéƒ¨åˆ†åº”ç”¨å­˜åœ¨å¯¹ç”¨æˆ·ä¸ªäººä¿¡æ¯è¿è§„è·å–çš„è¡Œä¸ºï¼Œä¸ªäººéšç§æƒç›Šä¿æŠ¤æ„è¯†è–„å¼±ï¼Œè¿è§„è·å–çš„è¡Œä¸ºæœªå¾—åˆ°æœ‰æ•ˆè§£å†³ï¼Œç›´åˆ° 2019 å¹´ä½ï¼Œå·¥ä¿¡éƒ¨å‘å¸ƒå…³äºå°å‘ã€ŠAppè¿æ³•è¿è§„æ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯è¡Œä¸ºè®¤å®šæ–¹æ³•ã€‹é€šçŸ¥ï¼Œåº”ç”¨å•†åº—é€æ¸å¼€å§‹å¯¹è¿è§„è·å–è¡Œä¸ºè¦æ±‚æ•´æ”¹ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- æœªå…¬å¼€æ”¶é›†ä½¿ç”¨è§„åˆ™çš„è¡Œä¸º</span><br><span class=\"line\">- æœªæ˜ç¤ºæ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯çš„ç›®çš„ã€æ–¹å¼å’ŒèŒƒå›´çš„è¡Œä¸º</span><br><span class=\"line\">- æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºã€è¯¥ç‚¹ä¸ºæœ¬æ–‡è®¨è®ºå’Œè§£å†³çš„é‡ç‚¹ã€‘</span><br><span class=\"line\">- æ”¶é›†ä¸å…¶æä¾›æœåŠ¡æ— å…³çš„ä¸ªäººä¿¡æ¯çš„è¡Œä¸º</span><br><span class=\"line\">- æœªç»åŒæ„å‘ä»–äººæä¾›ä¸ªäººä¿¡æ¯çš„è¡Œä¸º</span><br><span class=\"line\">- æœªæŒ‰æ³•å¾‹è§„å®šæä¾›åˆ é™¤æˆ–æ›´æ­£ä¸ªäººä¿¡æ¯åŠŸèƒ½çš„</span><br><span class=\"line\"></span><br><span class=\"line\">é™¤æ­¤ä¹‹å¤–ï¼Œå›½å†…å•†åº—æ¸ é“è¿˜æœ‰å…¶ä»–è¦æ±‚ï¼Œæ¯”å¦‚ï¼š</span><br><span class=\"line\">- ä¸å…è®¸é¢‘ç¹è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆIMEIã€SSIDã€AndroidID ç­‰ï¼‰</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0f36e7ad9b4293b24fc5afcc4bc7a8~tplv-k3u1fbpfcp-watermark.image?\" alt=\"origin_img_v2_640fd02b-1194-4342-9ed9-200b1e9bf7ag.jpg\"></p>\n<p>ä»¥ä¸‹å›´ç»•å¦‚ä½•æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜åœ¨<strong>æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯</strong>çš„è¡Œä¸ºï¼Œä»¥åŠ<strong>æ˜¯å¦å­˜åœ¨é¢‘ç¹è·å–ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯</strong>çš„è¡Œä¸ºã€‚</p>\n<h1>Xposted æ¨¡å—</h1>\n<h2 id=\"ä»‹ç»-â˜•ï¸\">ä»‹ç» â˜•ï¸</h2>\n<p>è¯¥æ¨¡æ¿ç¼–å†™ä¸»è¦æ˜¯ Hook çŸ¥è¯†ç‚¹ï¼ŒHook ä½œä¸ºâ€˜é’©å­â€™å¯ä»¥ç²—ç•¥ç†è§£ä¸ºæ‹¦æˆªæŸæ®µä»£ç çš„æ‰§è¡Œï¼Œå¹¶åœ¨ä»£ç æ®µå‰åæ’å…¥ç›‘æ§äº‹ä»¶ï¼Œç¨‹åºæ‰§è¡Œæ­¤ä»£ç æ®µåŒæ—¶ä¹Ÿå°†è§¦å‘ç›‘æ§äº‹ä»¶ï¼Œå°†ç›‘æ§äº‹ä»¶è¿”å›ç»™å¤–å±‚ç”¨äºè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸ªäººç†è§£ï¼Œä½¿ç”¨ Hook å·¥å…·è¾ƒä¸ºå…³é”®çš„ä¸€ç‚¹å°±æ˜¯æ‰¾åˆ°è¾ƒä¸ºå‡†ç¡®çš„ Hook ç‚¹ã€‚</p>\n<h2 id=\"Hook-æ¡†æ¶-ğŸ¤”\">Hook æ¡†æ¶ ğŸ¤”</h2>\n<p>Android ä¸Šçš„ Hook æ¡†æ¶ï¼Œæƒ³å¿…å¾ˆå¤šäººéƒ½ç•¥æœ‰è€³é—»ï¼Œå½“å¹´ç‹‚çƒ­çš„ <strong>Xposted</strong>ï¼Œåé¢ç¼–å†™çš„æ£€æµ‹å·¥å…·ä¾¿æ˜¯åŸºäº Xposted åº“ï¼ŒXposted æ¨¡å—ç¼–å†™æ•™ç¨‹åœ¨ç½‘ä¸Šæ˜¯æ»¡å¤©é£ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘è§‰å¾—æè¿°å¾—æ¯”è¾ƒæ¸…æ™°ï¼š<a href=\"https://www.freebuf.com/articles/terminal/189021.html\">æ–°æ‰‹ä¸è¦å†è¢«è¯¯å¯¼ï¼è¿™æ˜¯ä¸€ç¯‡æœ€æ–°çš„Xposedæ¨¡å—ç¼–å†™æ•™ç¨‹</a>ã€‚çœ‹å®Œå¼•ç”¨çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“ xposted åº“ä½¿ç”¨çš„ hook æ¨¡æ¿ï¼Œæ£€æµ‹å·¥å…·æ ¹æ®æ¨¡æ¿ç¼–å†™ä»£ç ï¼Œæ•´åˆå¤šä¸ªæ£€æµ‹ç‚¹å°±å¯ä»¥ï¼ˆæ¯”å¦‚æˆ‘éœ€è¦æ£€æµ‹ AndroidIdã€MACã€IMEI ç­‰çš„è·å–ï¼‰ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//æ¨¡æ¿</span></span><br><span class=\"line\">XposedHelpers.findAndHookMethod(</span><br><span class=\"line\">className,      <span class=\"comment\">//éœ€è¦ hook çš„ç±»åï¼Œå› ä¸ºä½¿ç”¨åå°„ï¼Œéœ€è¦ç±»çš„å…¨é™å®šå</span></span><br><span class=\"line\">methondName,    <span class=\"comment\">//éœ€è¦ hook çš„æ–¹æ³•ç­¾å</span></span><br><span class=\"line\">params1.class,  <span class=\"comment\">//éœ€è¦ hook çš„æ–¹æ³•çš„å‚æ•°ï¼ˆå‚æ•°å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œå‚æ•°ç±»å‹éœ€å’Œæ–¹æ³•ç­¾åä¿æŒä¸€è‡´ï¼‰</span></span><br><span class=\"line\">params2.class,</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">new</span> XC_MethodHook() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">beforeHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook before</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">afterHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook after</span></span><br><span class=\"line\">    &#125;&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ä¸¾ä¸ªæ —å­ğŸŒ°\">ä¸¾ä¸ªæ —å­ğŸŒ°</h2>\n<p>Android Java å±‚è·å– AndroidID çš„ä»£ç é€šå¸¸æ˜¯ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Settings.Secure.getString(context.getContentResolver(), </span><br><span class=\"line\">Settings.Secure.ANDROID_ID);</span><br></pre></td></tr></table></figure>\n<p>é‚£ä¹ˆï¼Œæ ¹æ®ä¸Šè¿°çš„ hook æ¨¡ç‰ˆï¼Œæ‰¾åˆ°ä»¥ä¸‹å‚æ•°åªå€¼ï¼š</p>\n<ul>\n<li>classNameï¼šandroid.provider.Settings</li>\n<li>methodNameï¼šgetString ï¼ˆæœ‰å‚æ–¹æ³•ï¼Œæ³¨æ„åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°å¯æ ¹æ®ä¸åŒçš„ä¼ å€¼è·å–ä¸åŒçš„è®¾å¤‡ä¿¡æ¯ï¼‰</li>\n<li>params1ï¼šContentResolver.class</li>\n<li>params2ï¼šString.class</li>\n</ul>\n<p>ç”±æ­¤å¯å¾— androidId è·å–æ£€æµ‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// æ£€æµ‹ AndroidID è·å–</span></span><br><span class=\"line\">XposedHelpers.findAndHookMethod(</span><br><span class=\"line\"><span class=\"string\">&quot;android.provider.Settings&quot;</span>,</span><br><span class=\"line\"><span class=\"string\">&quot;getString&quot;</span>,</span><br><span class=\"line\">ContentResolver.class,</span><br><span class=\"line\">String.class,</span><br><span class=\"line\"><span class=\"keyword\">new</span> XC_MethodHook() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">beforeHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook before</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">afterHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook after</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(param == <span class=\"keyword\">null</span>)<span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"comment\">//æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåˆ—è¡¨</span></span><br><span class=\"line\">      Object[] args = param.args;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(args == <span class=\"keyword\">null</span> || args.lenght &lt;= <span class=\"number\">0</span>)<span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"comment\">//getString æ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“ç¬¬äºŒä¸ªå‚æ•°å€¼æ‰æœ‰æ„ä¹‰ï¼Œæ‰èƒ½ç»§ç»­åˆ¤æ–­æ˜¯è·å– androidid è¿˜æ˜¯åˆ«çš„ä¿¡æ¯</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(args.lenght &gt;= <span class=\"number\">2</span>)&#123;</span><br><span class=\"line\">          String params2 = (String)args[<span class=\"number\">1</span>];</span><br><span class=\"line\">          <span class=\"comment\">//æ³¨æ„ï¼špublic static final String ANDROID_ID = &quot;android_id&quot;;</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span>(<span class=\"string\">&quot;android_id&quot;</span>.equal(params2))&#123;</span><br><span class=\"line\">              Log.d(<span class=\"string\">&quot;TAG&quot;</span>,<span class=\"string\">&quot;æ£€æµ‹åˆ°è·å– androidid&quot;</span>)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å°±è¿™æ ·ï¼Œæ£€æµ‹ androidid è·å–çš„ä»£ç å°±å†™å¥½äº†ï¼Œç®€å•å§ã€‚å¦‚æœä½ å¯¹ xposted å®ç°æ„Ÿå…´è¶£å¯ä»¥çœ‹æºç <a href=\"https://github.com/android-hacker/VirtualXposed\">ï¼šandroid-hacker-VirtualXposted</a>ã€‚æŸ¥çœ‹ android æºç å¯çŸ¥ï¼Œè·å– androidid çš„ getString æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å¯é€‰å€¼</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//æ‰€ä»¥ï¼Œå½“ä½  Hook è¿™ä¸ªæ–¹æ³•æ—¶å€™ï¼Œä¸ä»…ä»…å¯ä»¥ Hook AndroidID çš„è·å–ï¼Œä¹Ÿå¯ä»¥æ£€æµ‹å…¶ä»–ä¿¡æ¯çš„è·å–æƒ…å†µ</span></span><br><span class=\"line\"><span class=\"comment\">//public static final String ANDROID_ID = &quot;android_id&quot;;</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    MOVED_TO_SECURE = <span class=\"keyword\">new</span> HashSet&lt;&gt;(<span class=\"number\">30</span>);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.ADAPTIVE_SLEEP);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.ANDROID_ID);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.HTTP_PROXY);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCATION_PROVIDERS_ALLOWED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_BIOMETRIC_WEAK_FLAGS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_VISIBLE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_TACTILE_FEEDBACK_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOGGING_ID);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_LAST_UPDATE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_REDIRECT_URL);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.SETTINGS_CLASSNAME);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.USE_GOOGLE_MAIL);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NUM_OPEN_NETWORKS_KEPT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ACCEPTABLE_PACKET_LOSS_PERCENTAGE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_AP_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_DELAY_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_TIMEOUT_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_INITIAL_IGNORED_PING_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_MAX_AP_CHECKS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_DELAY_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_TIMEOUT_MS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// At one time in System, then Global, but now back in Secure</span></span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.INSTALL_NON_MARKET_APPS);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç -ğŸ¤”ï¸\">æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç  ğŸ¤”ï¸</h2>\n<p>è¯»åˆ°è¿™é‡Œï¼Œæ ¹æ®ä¸Šé¢çš„ xposted hook æ¨¡æ¿ï¼Œæ€ç»´å‘æ•£ï¼Œä½ å·²ç»å…·å¤‡å†™ä¸€ä¸ªåˆè§„æ£€ Xposted æ’ä»¶çš„èƒ½åŠ›ã€‚é€šå¸¸ï¼Œåˆè§„æ£€æµ‹æ’ä»¶åº”è¯¥ hook å“ªäº›åœ°æ–¹ï¼Ÿåº”è¯¥æ£€æµ‹å“ªäº›ä¿¡æ¯çš„è·å–è¡Œä¸ºï¼Ÿå…¶å®ä½ å¯ä»¥å‚è€ƒæ¸ é“å®¡æ ¸è¦æ±‚ç»¼åˆè€ƒè™‘ï¼Œå½’çº³æ€»ç»“ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹å‡ ç‚¹ï¼š</p>\n<ul>\n<li>androidID æ£€æµ‹</li>\n<li>IMEI æ£€æµ‹</li>\n<li>SSID æ£€æµ‹</li>\n<li>IMSI æ£€æµ‹</li>\n<li>MAC æ£€æµ‹</li>\n<li>OAID æ£€æµ‹ã€å› ä¸ºè·å– IMEI çš„é—®é¢˜ï¼Œç°åœ¨å›½å†…å¾ˆå¤šéƒ½åœ¨ä½¿ç”¨ OAIDã€‘</li>\n<li>å®šä½ä¿¡æ¯è¯»å–æ£€æµ‹</li>\n<li>è”ç³»äººåˆ—è¡¨è¯»å–æ£€æµ‹</li>\n<li>çŸ­ä¿¡å†…å®¹æ£€æµ‹</li>\n<li>ç›¸å†Œè¯»å–æ£€æµ‹</li>\n<li>è½¯ä»¶å®‰è£…åˆ—è¡¨è¯»å–æ£€æµ‹</li>\n<li>åº”ç”¨ä¿¡æ¯è¯»å–æ£€æµ‹</li>\n</ul>\n<p>ç¼–å†™åˆè§„æ£€æµ‹æ’ä»¶å¯èƒ½é‡åˆ°æˆ–éœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ</p>\n<ul>\n<li>åº”ç”¨çš„å¤šè¿›ç¨‹ç¯å¢ƒã€‚é¿å…æŸäº›æ“ä½œé‡å¤æ‰§è¡Œï¼Œæ£€æµ‹æ•°æ®é‡å¤</li>\n<li>ä¿¡æ¯è·å–è·å–è¡Œä¸ºæ•°æ®å¤„ç†ã€‚æ˜¯å¦éœ€å¼•å…¥æ•°æ®æŒä¹…åŒ–æ¡†æ¶ï¼Œå¯¹æ•°æ®å­˜å‚¨åç»Ÿä¸€å¤„ç†</li>\n<li>Android å¹³å°æ•°æ®åº“æ¡†æ¶åˆå§‹åŒ–ä¾èµ– contextã€‚æ˜¯å¦éœ€è¦ hook application è·å– context</li>\n<li>ç­‰ç­‰ï¼ˆéœ€æ±‚é©±åŠ¨å¼€å‘ï¼‰</li>\n</ul>\n<h1>Use VirtualXposted ğŸ’”</h1>\n<p><strong>æ–¹æ¡ˆå¯è¡Œä½†ä¸æ¨èï¼Œå­˜åœ¨ä¸€å®šçš„å±€é™</strong></p>\n<p>ä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿæœ‰ä»€ä¹ˆå±€é™ï¼Ÿéœ€æ£€æŸ¥åº”ç”¨è¿è¡Œç¯å¢ƒä»¥æ¥ VirtualXpostedAppï¼Œä¾µå…¥æ€§å¼ºï¼Œæ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹åˆ°å­˜åœ¨ xposted ç¯å¢ƒï¼Œxposted hook ç‰¹å¾æ˜æ˜¾ï¼Œå®¹æ˜“è¢«æ£€æµ‹ã€‚æ¯”å¦‚æŸäº›åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹ SDK æœ‰åš xposted é˜²æŠ¤ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è¿è¡Œç¯å¢ƒå­˜åœ¨ xpostedï¼Œå¯èƒ½ä¼šåšç›¸åº”å¤„ç†â€”â€”â€”â€”ç»ˆæ­¢ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¸åˆ©äºæ£€æµ‹åº”ç”¨ä¸ªäººä¿¡æ¯è·å–æƒ…å†µã€‚ä¼˜ç‚¹æ˜¯ç¯å¢ƒå‡†å¤‡ç®€å•ã€‚</p>\n<h2 id=\"å¦‚ä½•ä½¿ç”¨\">å¦‚ä½•ä½¿ç”¨</h2>\n<p>1ã€ä¸‹è½½å®‰è£… virtualXposted</p>\n<p><a href=\"https://github.com/android-hacker/VirtualXposed\">android-hacker-VirtualXposted</a></p>\n<p>2ã€æ¿€æ´» xposted</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca83e472c58447ce84f6eb4f1aad5b2e~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b53d5cd381f419ba50e4eea9f9f8a39~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>3ã€æ·»åŠ æ¨¡æ¿å’Œå¾…æ£€æµ‹åº”ç”¨</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e93823fe3fe14092a287bb6ac95c3310~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39273c5ee0534cc4b705ee3de92d9fc0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>4ã€å¯åŠ¨æ¨¡å—</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5bc1c3afd294c378d5cb57d7f7dda1b~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/798cac0dc3e2428699a16d74bfab6d44~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7748fbdc0e24f12bc2148383117e9b8~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5622c01867c64155a5cae84c6a57be57~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>æœ€åå°±æ˜¯è¿è¡Œåº”ç”¨ï¼ŒæŸ¥çœ‹è‡ªå®šä¹‰è¾“å‡ºæ—¥å¿—ã€‚ç”±äº xposted é˜²æŠ¤çš„å±€é™ï¼Œè‹¥ä¸èƒ½æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿˜éœ€å¦å¯»ä»–æ³•ã€‚</p>\n<h1>Use Taichi ğŸ’”</h1>\n<p><strong>æ–¹æ¡ˆä¸å¯è¡Œä½†ä¸æ¨èï¼Œå†™å¥½çš„æ¨¡æ¿æ— æ³•ä½¿ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰</strong></p>\n<p>ä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿå†™å¥½çš„æ£€æµ‹æ¨¡æ¿è¢«é™åˆ¶ä½¿ç”¨ï¼Œå®˜ç½‘ï¼š<a href=\"https://github.com/taichi-framework/TaiChi\">https://github.com/taichi-framework/TaiChi</a></p>\n<p>å¦‚ä½•ä½¿ç”¨å¤ªæå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼Œè¿™é‡Œæä¸‹é‡åˆ°çš„é—®é¢˜ï¼š</p>\n<p><strong>é—®é¢˜ä¸€ï¼šæš‚ä¸æ”¯æŒ</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ef794ca6102471bb11b702f6f062a1f~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>çœ‹ä¸‹å®˜ç½‘æœ‰å¯¹â€˜æš‚æ—¶ä¸æ”¯æŒâ€™çš„æè¿°ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š</strong></p>\n<ul>\n<li>å½“å‰å¤ªææ˜¯å¤ªæé˜´æ¨¡å¼ï¼ˆæœ‰é˜´ã€é˜³ä¸¤ç§æ¨¡å¼ï¼Œè‡ªè¡Œå®˜ç½‘äº†è§£ï¼‰</li>\n<li>å½“å‰æ¨¡å—ä¸å­˜åœ¨ç™½åå•ä¸­</li>\n</ul>\n<p>æš‚æ—¶æ²¡åŠæ³•ï¼Œè¯•è¯•æŠŠå¤ªææ¿€æ´»ä¸ºâ€˜å¤ªæé˜³â€™æ¨¡å¼ï¼Œç„¶è€Œå‘¢è¿˜æ˜¯æ˜¾ç¤ºæš‚ä¸æ”¯æŒï¼›çŒœæµ‹æ˜¯å¦ä¸€ç§å¯èƒ½ï¼Œæ¨¡æ¿ä¸å­˜åœ¨ç™½åå•ä¸­ï¼Œè¦åŠ å…¥ç™½åå•è¦è”ç³»ä½œè€…ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜æ˜¯å¦å¯»ä»–æ³•å§ã€‚åæ¥å‘ç°äº†å¦ä¸€ä¸ªæ¡†æ¶ LSP ã€‚ï¼ˆå¦‚ä½•å¼€å¯å¤ªæé˜³ï¼Œå®˜ç½‘æœ‰æ•™ç¨‹ï¼Œéœ€è¦å€ŸåŠ© Magiskï¼Œä¸‹æ–‡ä¼šç”¨åˆ°è¿™ä¸ªå·¥å…·ï¼‰</p>\n<h1>Use Lsposted â¤ï¸</h1>\n<p><strong>æ–¹æ¡ˆå¯è¡Œï¼Œæ¨èä½¿ç”¨</strong><br>\nä¸ºä»€ä¹ˆæ¨èï¼ŸLSP ä¾µå…¥æ€§å¼±ï¼Œä¸æ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿé¿å… xposted é˜²æŠ¤ã€‚</p>\n<h2 id=\"æ³¨æ„äº‹é¡¹\">æ³¨æ„äº‹é¡¹</h2>\n<ul>\n<li>BootLoader è§£é”å°†æ¸…é™¤è®¾å¤‡æ•°æ®ï¼Œé‡è¦æ•°æ®è¯·æ³¨æ„å¤‡ä»½</li>\n<li>æ­¤æ“ä½œéœ€è¦è®¾å¤‡è§£é” Bootloader ï¼ˆåˆ·æœºï¼‰ï¼Œè‹¥BootLoader è§£é”å¤±è´¥ï¼Œå…¶ä»–æ“ä½œå·²æ— æ„ä¹‰ï¼Œæ²¡æœ‰ç»§ç»­æ“ä½œçš„å¿…è¦ï¼Œå»ºè®®æ›´æ¢è®¾å¤‡ã€‚</li>\n<li>å„å‚å•†è®¾å¤‡ BootLoader è§£é”æ–¹å¼å¯èƒ½ä¸å°½ç›¸åŒã€‚\n<ul>\n<li>å°ç±³å®˜ç½‘ä»ç„¶å¼€æ”¾ BL è§£é”å·¥å…·ï¼ˆå»ºè®®ä½¿ç”¨å°ç±³æ‰‹æœºæµ‹è¯•ï¼‰</li>\n<li>è´­ä¹°ç¬¬ä¸‰æ–¹è§£é”å·¥å…· UAndroid</li>\n<li>OPPO å®˜æ–¹ä¹Ÿæœ‰â€˜æ·±åº¦æµ‹è¯•â€™è§£é”å·¥å…·ï¼Œä½†ç”³è¯·åé¢æœ‰é™ï¼Œå®¡æ ¸æ—¶é—´é•¿ï¼Œä¸æ¨è</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"å¦‚ä½•ä½¿ç”¨-2\">å¦‚ä½•ä½¿ç”¨</h2>\n<p>ä»¥å°ç±³æ‰‹æœºä¸ºä¾‹ï¼ˆå› ä¸º BL è§£é”æ–¹ä¾¿ï¼‰</p>\n<p><strong>1ã€è®¾å¤‡ Bootloader è§£é”</strong></p>\n<p><a href=\"http://www.miui.com/unlock/download.html\">å®˜æ–¹ï¼šç”³è¯·è§£é”å°ç±³æ‰‹æœº</a></p>\n<p>å°ç±³çš„ BL è§£é”å¯¹è®¾å¤‡çš„ä»¥åŠè´¦å·ç»‘å®šä¹Ÿæœ‰è¦æ±‚ï¼Œæ¯”å¦‚è´¦å·ä¸è®¾å¤‡ç»‘å®šæ—¶é—´ç­‰ã€‚å®˜ç½‘ä¸‹è½½å¾—åˆ°çš„å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚</p>\n<p><strong>2ã€ä¸‹è½½å®‰è£… Magisk</strong></p>\n<p>å®˜ç½‘ï¼š<a href=\"https://github.com/topjohnwu/Magisk\">https://github.com/topjohnwu/Magisk</a></p>\n<p><strong>3ã€ä¸‹è½½å¤‡ç”¨ adb-fastboot</strong></p>\n<p>é“¾æ¥ï¼š<a href=\"https://mrzzoxo.lanzouw.com/iMbPYz63p6f\">https://mrzzoxo.lanzouw.com/iMbPYz63p6f</a></p>\n<p><strong>4ã€å‡†å¤‡å¯¹åº”è®¾å¤‡å‹å·çš„åˆ·æœºåŒ…</strong></p>\n<p>å°ç±³åˆ·æœºåŒ…ï¼š<a href=\"https://mirom.ezbox.idv.tw/phone/\">https://mirom.ezbox.idv.tw/phone/</a></p>\n<p>ä¸€èˆ¬å»ºè®®ä¸‹è½½å¤§é™†ç¨³å®šç‰ˆï¼ˆè‹¥æ˜¯å…¶ä»–å‚å•†åˆ·æœºåŒ…ï¼Œè‡ªè¡Œå¯»æ‰¾ï¼‰</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87a8268965d648df8775781e37f77679~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>5ã€åˆ·å…¥ Magisk</strong></p>\n<p>å°½é‡æŒ‰é¡ºåºæ“ä½œ</p>\n<p>5.1 ä»åˆ·æœºåŒ…ä¸­è§£å‹è·å–Â Â <strong>boot.img</strong> æ–‡ä»¶ï¼ˆè‹¥æ— æ­¤æ–‡ä»¶å»ºè®®æ›´æ¢åˆ·æœºåŒ…ï¼Œä¹Ÿå¯ä»¥å¦å¯»ä»–æ³•ä»åˆ·æœºåŒ…ä¸­è§£æè·å¾—æ­¤æ–‡ä»¶ï¼‰<br>\n5.2 æ‰“å¼€ Magisk é€‰æ‹© boot.img å®‰è£…è¡¥ä¸ï¼Œç­‰å¾…åˆ·å…¥å®Œæˆï¼ˆæ­¤æˆªå›¾æ˜¯å·²å®‰è£…å®Œæˆçš„ï¼Œä»¥å®é™…ä¸ºå‡†ï¼‰</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6b1f76ad8845d98bf1f2c901286ed9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>5.3 åˆ·å…¥å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—è·å¾—ç”Ÿæˆçš„ img æ–‡ä»¶</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0d9d3a707544199a1b8e5f5518b4e4f~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>5.4 å¤åˆ¶ç”Ÿæˆçš„Â img æ–‡ä»¶å’Œ boot.img æ–‡ä»¶åˆ° adb-fastboot ç›®å½•ä¸‹ï¼Œæ‰“å¼€Â æ‰“å¼€CMDå‘½ä»¤è¡Œ.batï¼ˆè‹¥ boot.img ä¸å­˜åœ¨æ­¤ç›®å½•ä¸‹ï¼Œåˆ·å…¥ magisk æ— æ•ˆï¼‰</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c3c9d8aa38426294d85cfdd38255a4~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>5.5 è®¾å¤‡è¿›å…¥ BootLoader æ¨¡å¼<br>\næ–¹å¼ä¸€ï¼šæ‰§è¡Œ adb reboot bootloader<br>\næ–¹å¼äºŒï¼šå…³æœºçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶æŒ‰ä½Â éŸ³é‡â€”Â +Â ç”µæºé”®</p>\n<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç­‰å¾…å®Œæˆï¼Œä½¿ç”¨å‘½ä»¤é‡å¯è®¾å¤‡ï¼›é‡å¯åé‡æ–°æ‰“å¼€ magisk æ˜¾ç¤ºç‰ˆæœ¬å·è¡¨ç¤ºæˆåŠŸã€‚</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0cf7cae60c44815b1127984face396c~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe997317c794ad08d6c1242a54bf9a5~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35d48af81574b27bfba0c5eca5cfdc0~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><strong>6ã€åˆ·å…¥ LSPosted</strong></p>\n<p>å®˜ç½‘ï¼š<a href=\"https://github.com/LSPosed/LSPosed%E3%80%81https://github.com/RikkaApps/Riru/tags\">https://github.com/LSPosed/LSPosedã€https://github.com/RikkaApps/Riru/tags</a></p>\n<p>6.1 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c329e61e1fc48e5945863ce1a1f8cda~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>6.2 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d948643a1a3f4bf79cb1ee7dd8075ea1~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>6.3 ä¸‹è½½<strong>LSPosted-zygisk</strong>å¤‡ç”¨ï¼ˆå¿…é€‰ï¼‰</p>\n<p>å¦‚æœè®¾å¤‡æ”¯æŒ Zygiskï¼Œrituã€LSPosted-ritu æ¨¡å—å¯ä¸éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨æ”¯æŒ Zygisk çš„è®¾å¤‡</p>\n<p>6.4 æ‰“å¼€ Magisk å¼€å§‹åˆ·å…¥å¿…é€‰æ¨¡å—ï¼ŒæŒ‰ç…§æç¤ºé‡å¯è®¾å¤‡åæ˜¾ç¤ºÂ Zygisk æ˜¯ï¼Œæ¡Œé¢å‡ºç° LSPosted</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8e39c410d444628be03c7f83adaf92a~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b73cb22078b4610a4fac35e369b8eea~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90ae1ca939964ce68b0e56331bd50b63~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baffbe16b1d04a1899ba2c4caee9b37b~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>7ã€å®‰è£…æ£€æµ‹æ¨¡å—</strong></p>\n<p>å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…æˆ‘ä»¬çš„Â <strong>åˆè§„æ£€æµ‹æ¨¡å—</strong>ï¼Œé‚£ä¹ˆç°åœ¨è¦å®‰è£…å•¦ï¼ï¼ï¼å¯åŠ¨æ¨¡å—ï¼Œå‹¾é€‰è¦æ£€æµ‹çš„åº”ç”¨ï¼Œè¿”å›æ¡Œé¢æ‰§è¡Œåº”ç”¨å°±å¯ä»¥çœ‹æ—¥å¿—</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5196bdc80d84b64b8fd752e47285651~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h1>å…¶ä»–</h1>\n<ul>\n<li>âš ï¸ Android 9 åŠå…¶ä»¥ä¸‹è®¾å¤‡æ‰æ”¯æŒ IMEI è·å–ï¼Œåœ¨æµ‹è¯•è®¾å¤‡é€‰æ‹©ä¸Šéœ€æ³¨æ„</li>\n<li><a href=\"https://forum.xda-developers.com/\">å­¦ä¹ ç½‘ç«™ï¼šXDA Forums</a> è¯¥ç½‘ç«™çš„ä¸»è¦è®¨è®ºæ‰‹æœºç³»ç»Ÿï¼Œå¹¶æä¾›ç›¸å…³è®¾å¤‡çš„æŠ€æœ¯ä¿¡æ¯ã€<a href=\"https://zh.m.wikipedia.org/wiki/ROM\">ROM</a>å‡çº§ã€æŠ€æœ¯æ”¯æŒã€Qï¼†A</li>\n<li><a href=\"https://bbs.gsmua.cn/\">ææœºç½‘ç«™ï¼šUAæ‰‹æœºç»´ä¿®äº¤æµ - Powered by Discuz!</a><br>\nå¯æä¾› UAndroid å·¥å…·ï¼Œç”¨äºå„å‚å•†è®¾å¤‡ BootLoader è§£é”<br>\nä»˜è´¹å·¥å…·ã€ä¹Ÿå¯ä»¥è´¦å·ç§Ÿç”¨æ–¹å¼ä½¿ç”¨ï¼ˆä¸“ä¸šææœºï¼ŒæŸå®ä¹Ÿæœ‰ç›¸å…³æŠ€æœ¯æœåŠ¡ï¼‰</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1>å‰è¨€</h1>\n<p>è®¾å¤‡çš„ä¸ªäººä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè”ç³»äººä¿¡æ¯ã€çŸ­ä¿¡å†…å®¹ç­‰ï¼‰å±äºç”¨æˆ·éšç§ï¼Œè¿è§„è·å–ä¸ªäººä¿¡æ¯è¢«è§†ä¸ºä¾µçŠ¯ç”¨æˆ·æƒç›Šï¼›åœ¨è®¾å¤‡ä¸Šè·å–ä¸ªäººä¿¡æ¯ä¸€èˆ¬éœ€å…ˆè·å–åˆ°ç›¸åº”çš„æƒé™æ‰èƒ½è¿›è¡Œè·å–ï¼Œä¾‹å¦‚æƒ³è·å–ç›¸å†Œå›¾ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦ç”³è¯·è¯»å†™æƒé™ï¼Œç”¨æˆ·åŒæ„æƒé™ç”³è¯·ä¹‹åå¯è¯»å–ç›¸å†Œå›¾ç‰‡ã€‚åº”ç”¨å­˜åœ¨è¿è§„è·å–ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºï¼Œä¸ä¸ºç½•è§ï¼Œä½•ä¸ºè¿è§„è¡Œä¸ºï¼Ÿ</p>\n<p>ä¸ªäººç†è§£ï¼š</p>\n<ul>\n<li>åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…ä¸‹è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·åŒæ„éšç§æ”¿ç­–å‰è·å–ä¸ªäººä¿¡æ¯</li>\n<li>æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾ã€‚æ¯”å¦‚ï¼Œéšç§æ”¿ç­–æˆ–è¯´æ˜æœªå‘ç”¨æˆ·æ˜ç¡®ä¸ªäººä¿¡æ¯ä½¿ç”¨æ„å›¾</li>\n<li>è¶…èŒƒå›´è·å–ä¸ªäººä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå£çº¸ App ç”³è¯·å½•éŸ³æƒé™</li>\n</ul>\n<p>æ­¤å‰ï¼Œéƒ¨åˆ†åº”ç”¨å­˜åœ¨å¯¹ç”¨æˆ·ä¸ªäººä¿¡æ¯è¿è§„è·å–çš„è¡Œä¸ºï¼Œä¸ªäººéšç§æƒç›Šä¿æŠ¤æ„è¯†è–„å¼±ï¼Œè¿è§„è·å–çš„è¡Œä¸ºæœªå¾—åˆ°æœ‰æ•ˆè§£å†³ï¼Œç›´åˆ° 2019 å¹´ä½ï¼Œå·¥ä¿¡éƒ¨å‘å¸ƒå…³äºå°å‘ã€ŠAppè¿æ³•è¿è§„æ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯è¡Œä¸ºè®¤å®šæ–¹æ³•ã€‹é€šçŸ¥ï¼Œåº”ç”¨å•†åº—é€æ¸å¼€å§‹å¯¹è¿è§„è·å–è¡Œä¸ºè¦æ±‚æ•´æ”¹ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- æœªå…¬å¼€æ”¶é›†ä½¿ç”¨è§„åˆ™çš„è¡Œä¸º</span><br><span class=\"line\">- æœªæ˜ç¤ºæ”¶é›†ä½¿ç”¨ä¸ªäººä¿¡æ¯çš„ç›®çš„ã€æ–¹å¼å’ŒèŒƒå›´çš„è¡Œä¸º</span><br><span class=\"line\">- æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯çš„è¡Œä¸ºã€è¯¥ç‚¹ä¸ºæœ¬æ–‡è®¨è®ºå’Œè§£å†³çš„é‡ç‚¹ã€‘</span><br><span class=\"line\">- æ”¶é›†ä¸å…¶æä¾›æœåŠ¡æ— å…³çš„ä¸ªäººä¿¡æ¯çš„è¡Œä¸º</span><br><span class=\"line\">- æœªç»åŒæ„å‘ä»–äººæä¾›ä¸ªäººä¿¡æ¯çš„è¡Œä¸º</span><br><span class=\"line\">- æœªæŒ‰æ³•å¾‹è§„å®šæä¾›åˆ é™¤æˆ–æ›´æ­£ä¸ªäººä¿¡æ¯åŠŸèƒ½çš„</span><br><span class=\"line\"></span><br><span class=\"line\">é™¤æ­¤ä¹‹å¤–ï¼Œå›½å†…å•†åº—æ¸ é“è¿˜æœ‰å…¶ä»–è¦æ±‚ï¼Œæ¯”å¦‚ï¼š</span><br><span class=\"line\">- ä¸å…è®¸é¢‘ç¹è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆIMEIã€SSIDã€AndroidID ç­‰ï¼‰</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0f36e7ad9b4293b24fc5afcc4bc7a8~tplv-k3u1fbpfcp-watermark.image?\" alt=\"origin_img_v2_640fd02b-1194-4342-9ed9-200b1e9bf7ag.jpg\"></p>\n<p>ä»¥ä¸‹å›´ç»•å¦‚ä½•æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜åœ¨<strong>æœªç»ç”¨æˆ·åŒæ„æ”¶é›†ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯</strong>çš„è¡Œä¸ºï¼Œä»¥åŠ<strong>æ˜¯å¦å­˜åœ¨é¢‘ç¹è·å–ä¸ªäººä¿¡æ¯æˆ–è®¾å¤‡ä¿¡æ¯</strong>çš„è¡Œä¸ºã€‚</p>\n<h1>Xposted æ¨¡å—</h1>\n<h2 id=\"ä»‹ç»-â˜•ï¸\">ä»‹ç» â˜•ï¸</h2>\n<p>è¯¥æ¨¡æ¿ç¼–å†™ä¸»è¦æ˜¯ Hook çŸ¥è¯†ç‚¹ï¼ŒHook ä½œä¸ºâ€˜é’©å­â€™å¯ä»¥ç²—ç•¥ç†è§£ä¸ºæ‹¦æˆªæŸæ®µä»£ç çš„æ‰§è¡Œï¼Œå¹¶åœ¨ä»£ç æ®µå‰åæ’å…¥ç›‘æ§äº‹ä»¶ï¼Œç¨‹åºæ‰§è¡Œæ­¤ä»£ç æ®µåŒæ—¶ä¹Ÿå°†è§¦å‘ç›‘æ§äº‹ä»¶ï¼Œå°†ç›‘æ§äº‹ä»¶è¿”å›ç»™å¤–å±‚ç”¨äºè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸ªäººç†è§£ï¼Œä½¿ç”¨ Hook å·¥å…·è¾ƒä¸ºå…³é”®çš„ä¸€ç‚¹å°±æ˜¯æ‰¾åˆ°è¾ƒä¸ºå‡†ç¡®çš„ Hook ç‚¹ã€‚</p>\n<h2 id=\"Hook-æ¡†æ¶-ğŸ¤”\">Hook æ¡†æ¶ ğŸ¤”</h2>\n<p>Android ä¸Šçš„ Hook æ¡†æ¶ï¼Œæƒ³å¿…å¾ˆå¤šäººéƒ½ç•¥æœ‰è€³é—»ï¼Œå½“å¹´ç‹‚çƒ­çš„ <strong>Xposted</strong>ï¼Œåé¢ç¼–å†™çš„æ£€æµ‹å·¥å…·ä¾¿æ˜¯åŸºäº Xposted åº“ï¼ŒXposted æ¨¡å—ç¼–å†™æ•™ç¨‹åœ¨ç½‘ä¸Šæ˜¯æ»¡å¤©é£ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘è§‰å¾—æè¿°å¾—æ¯”è¾ƒæ¸…æ™°ï¼š<a href=\"https://www.freebuf.com/articles/terminal/189021.html\">æ–°æ‰‹ä¸è¦å†è¢«è¯¯å¯¼ï¼è¿™æ˜¯ä¸€ç¯‡æœ€æ–°çš„Xposedæ¨¡å—ç¼–å†™æ•™ç¨‹</a>ã€‚çœ‹å®Œå¼•ç”¨çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“ xposted åº“ä½¿ç”¨çš„ hook æ¨¡æ¿ï¼Œæ£€æµ‹å·¥å…·æ ¹æ®æ¨¡æ¿ç¼–å†™ä»£ç ï¼Œæ•´åˆå¤šä¸ªæ£€æµ‹ç‚¹å°±å¯ä»¥ï¼ˆæ¯”å¦‚æˆ‘éœ€è¦æ£€æµ‹ AndroidIdã€MACã€IMEI ç­‰çš„è·å–ï¼‰ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//æ¨¡æ¿</span></span><br><span class=\"line\">XposedHelpers.findAndHookMethod(</span><br><span class=\"line\">className,      <span class=\"comment\">//éœ€è¦ hook çš„ç±»åï¼Œå› ä¸ºä½¿ç”¨åå°„ï¼Œéœ€è¦ç±»çš„å…¨é™å®šå</span></span><br><span class=\"line\">methondName,    <span class=\"comment\">//éœ€è¦ hook çš„æ–¹æ³•ç­¾å</span></span><br><span class=\"line\">params1.class,  <span class=\"comment\">//éœ€è¦ hook çš„æ–¹æ³•çš„å‚æ•°ï¼ˆå‚æ•°å­˜åœ¨å¤šä¸ªï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œå‚æ•°ç±»å‹éœ€å’Œæ–¹æ³•ç­¾åä¿æŒä¸€è‡´ï¼‰</span></span><br><span class=\"line\">params2.class,</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">new</span> XC_MethodHook() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">beforeHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook before</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">afterHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook after</span></span><br><span class=\"line\">    &#125;&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ä¸¾ä¸ªæ —å­ğŸŒ°\">ä¸¾ä¸ªæ —å­ğŸŒ°</h2>\n<p>Android Java å±‚è·å– AndroidID çš„ä»£ç é€šå¸¸æ˜¯ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Settings.Secure.getString(context.getContentResolver(), </span><br><span class=\"line\">Settings.Secure.ANDROID_ID);</span><br></pre></td></tr></table></figure>\n<p>é‚£ä¹ˆï¼Œæ ¹æ®ä¸Šè¿°çš„ hook æ¨¡ç‰ˆï¼Œæ‰¾åˆ°ä»¥ä¸‹å‚æ•°åªå€¼ï¼š</p>\n<ul>\n<li>classNameï¼šandroid.provider.Settings</li>\n<li>methodNameï¼šgetString ï¼ˆæœ‰å‚æ–¹æ³•ï¼Œæ³¨æ„åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°å¯æ ¹æ®ä¸åŒçš„ä¼ å€¼è·å–ä¸åŒçš„è®¾å¤‡ä¿¡æ¯ï¼‰</li>\n<li>params1ï¼šContentResolver.class</li>\n<li>params2ï¼šString.class</li>\n</ul>\n<p>ç”±æ­¤å¯å¾— androidId è·å–æ£€æµ‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// æ£€æµ‹ AndroidID è·å–</span></span><br><span class=\"line\">XposedHelpers.findAndHookMethod(</span><br><span class=\"line\"><span class=\"string\">&quot;android.provider.Settings&quot;</span>,</span><br><span class=\"line\"><span class=\"string\">&quot;getString&quot;</span>,</span><br><span class=\"line\">ContentResolver.class,</span><br><span class=\"line\">String.class,</span><br><span class=\"line\"><span class=\"keyword\">new</span> XC_MethodHook() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">beforeHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook before</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">afterHookedMethod</span><span class=\"params\">(MethodHookParam param)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//hook after</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(param == <span class=\"keyword\">null</span>)<span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"comment\">//æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåˆ—è¡¨</span></span><br><span class=\"line\">      Object[] args = param.args;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(args == <span class=\"keyword\">null</span> || args.lenght &lt;= <span class=\"number\">0</span>)<span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"comment\">//getString æ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“ç¬¬äºŒä¸ªå‚æ•°å€¼æ‰æœ‰æ„ä¹‰ï¼Œæ‰èƒ½ç»§ç»­åˆ¤æ–­æ˜¯è·å– androidid è¿˜æ˜¯åˆ«çš„ä¿¡æ¯</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(args.lenght &gt;= <span class=\"number\">2</span>)&#123;</span><br><span class=\"line\">          String params2 = (String)args[<span class=\"number\">1</span>];</span><br><span class=\"line\">          <span class=\"comment\">//æ³¨æ„ï¼špublic static final String ANDROID_ID = &quot;android_id&quot;;</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span>(<span class=\"string\">&quot;android_id&quot;</span>.equal(params2))&#123;</span><br><span class=\"line\">              Log.d(<span class=\"string\">&quot;TAG&quot;</span>,<span class=\"string\">&quot;æ£€æµ‹åˆ°è·å– androidid&quot;</span>)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å°±è¿™æ ·ï¼Œæ£€æµ‹ androidid è·å–çš„ä»£ç å°±å†™å¥½äº†ï¼Œç®€å•å§ã€‚å¦‚æœä½ å¯¹ xposted å®ç°æ„Ÿå…´è¶£å¯ä»¥çœ‹æºç <a href=\"https://github.com/android-hacker/VirtualXposed\">ï¼šandroid-hacker-VirtualXposted</a>ã€‚æŸ¥çœ‹ android æºç å¯çŸ¥ï¼Œè·å– androidid çš„ getString æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å¯é€‰å€¼</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//æ‰€ä»¥ï¼Œå½“ä½  Hook è¿™ä¸ªæ–¹æ³•æ—¶å€™ï¼Œä¸ä»…ä»…å¯ä»¥ Hook AndroidID çš„è·å–ï¼Œä¹Ÿå¯ä»¥æ£€æµ‹å…¶ä»–ä¿¡æ¯çš„è·å–æƒ…å†µ</span></span><br><span class=\"line\"><span class=\"comment\">//public static final String ANDROID_ID = &quot;android_id&quot;;</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    MOVED_TO_SECURE = <span class=\"keyword\">new</span> HashSet&lt;&gt;(<span class=\"number\">30</span>);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.ADAPTIVE_SLEEP);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.ANDROID_ID);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.HTTP_PROXY);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCATION_PROVIDERS_ALLOWED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_BIOMETRIC_WEAK_FLAGS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_VISIBLE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOCK_PATTERN_TACTILE_FEEDBACK_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.LOGGING_ID);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_LAST_UPDATE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.PARENTAL_CONTROL_REDIRECT_URL);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.SETTINGS_CLASSNAME);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.USE_GOOGLE_MAIL);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_NOTIFICATION_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_NUM_OPEN_NETWORKS_KEPT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ACCEPTABLE_PACKET_LOSS_PERCENTAGE);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_AP_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_DELAY_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_ENABLED);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_BACKGROUND_CHECK_TIMEOUT_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_INITIAL_IGNORED_PING_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_MAX_AP_CHECKS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_ON);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_COUNT);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_DELAY_MS);</span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.WIFI_WATCHDOG_PING_TIMEOUT_MS);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// At one time in System, then Global, but now back in Secure</span></span><br><span class=\"line\">    MOVED_TO_SECURE.add(Secure.INSTALL_NON_MARKET_APPS);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç -ğŸ¤”ï¸\">æœ‰æ²¡æœ‰ç°æˆçš„ä»£ç  ğŸ¤”ï¸</h2>\n<p>è¯»åˆ°è¿™é‡Œï¼Œæ ¹æ®ä¸Šé¢çš„ xposted hook æ¨¡æ¿ï¼Œæ€ç»´å‘æ•£ï¼Œä½ å·²ç»å…·å¤‡å†™ä¸€ä¸ªåˆè§„æ£€ Xposted æ’ä»¶çš„èƒ½åŠ›ã€‚é€šå¸¸ï¼Œåˆè§„æ£€æµ‹æ’ä»¶åº”è¯¥ hook å“ªäº›åœ°æ–¹ï¼Ÿåº”è¯¥æ£€æµ‹å“ªäº›ä¿¡æ¯çš„è·å–è¡Œä¸ºï¼Ÿå…¶å®ä½ å¯ä»¥å‚è€ƒæ¸ é“å®¡æ ¸è¦æ±‚ç»¼åˆè€ƒè™‘ï¼Œå½’çº³æ€»ç»“ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹å‡ ç‚¹ï¼š</p>\n<ul>\n<li>androidID æ£€æµ‹</li>\n<li>IMEI æ£€æµ‹</li>\n<li>SSID æ£€æµ‹</li>\n<li>IMSI æ£€æµ‹</li>\n<li>MAC æ£€æµ‹</li>\n<li>OAID æ£€æµ‹ã€å› ä¸ºè·å– IMEI çš„é—®é¢˜ï¼Œç°åœ¨å›½å†…å¾ˆå¤šéƒ½åœ¨ä½¿ç”¨ OAIDã€‘</li>\n<li>å®šä½ä¿¡æ¯è¯»å–æ£€æµ‹</li>\n<li>è”ç³»äººåˆ—è¡¨è¯»å–æ£€æµ‹</li>\n<li>çŸ­ä¿¡å†…å®¹æ£€æµ‹</li>\n<li>ç›¸å†Œè¯»å–æ£€æµ‹</li>\n<li>è½¯ä»¶å®‰è£…åˆ—è¡¨è¯»å–æ£€æµ‹</li>\n<li>åº”ç”¨ä¿¡æ¯è¯»å–æ£€æµ‹</li>\n</ul>\n<p>ç¼–å†™åˆè§„æ£€æµ‹æ’ä»¶å¯èƒ½é‡åˆ°æˆ–éœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ</p>\n<ul>\n<li>åº”ç”¨çš„å¤šè¿›ç¨‹ç¯å¢ƒã€‚é¿å…æŸäº›æ“ä½œé‡å¤æ‰§è¡Œï¼Œæ£€æµ‹æ•°æ®é‡å¤</li>\n<li>ä¿¡æ¯è·å–è·å–è¡Œä¸ºæ•°æ®å¤„ç†ã€‚æ˜¯å¦éœ€å¼•å…¥æ•°æ®æŒä¹…åŒ–æ¡†æ¶ï¼Œå¯¹æ•°æ®å­˜å‚¨åç»Ÿä¸€å¤„ç†</li>\n<li>Android å¹³å°æ•°æ®åº“æ¡†æ¶åˆå§‹åŒ–ä¾èµ– contextã€‚æ˜¯å¦éœ€è¦ hook application è·å– context</li>\n<li>ç­‰ç­‰ï¼ˆéœ€æ±‚é©±åŠ¨å¼€å‘ï¼‰</li>\n</ul>\n<h1>Use VirtualXposted ğŸ’”</h1>\n<p><strong>æ–¹æ¡ˆå¯è¡Œä½†ä¸æ¨èï¼Œå­˜åœ¨ä¸€å®šçš„å±€é™</strong></p>\n<p>ä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿæœ‰ä»€ä¹ˆå±€é™ï¼Ÿéœ€æ£€æŸ¥åº”ç”¨è¿è¡Œç¯å¢ƒä»¥æ¥ VirtualXpostedAppï¼Œä¾µå…¥æ€§å¼ºï¼Œæ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹åˆ°å­˜åœ¨ xposted ç¯å¢ƒï¼Œxposted hook ç‰¹å¾æ˜æ˜¾ï¼Œå®¹æ˜“è¢«æ£€æµ‹ã€‚æ¯”å¦‚æŸäº›åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹ SDK æœ‰åš xposted é˜²æŠ¤ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è¿è¡Œç¯å¢ƒå­˜åœ¨ xpostedï¼Œå¯èƒ½ä¼šåšç›¸åº”å¤„ç†â€”â€”â€”â€”ç»ˆæ­¢ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¸åˆ©äºæ£€æµ‹åº”ç”¨ä¸ªäººä¿¡æ¯è·å–æƒ…å†µã€‚ä¼˜ç‚¹æ˜¯ç¯å¢ƒå‡†å¤‡ç®€å•ã€‚</p>\n<h2 id=\"å¦‚ä½•ä½¿ç”¨\">å¦‚ä½•ä½¿ç”¨</h2>\n<p>1ã€ä¸‹è½½å®‰è£… virtualXposted</p>\n<p><a href=\"https://github.com/android-hacker/VirtualXposed\">android-hacker-VirtualXposted</a></p>\n<p>2ã€æ¿€æ´» xposted</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca83e472c58447ce84f6eb4f1aad5b2e~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b53d5cd381f419ba50e4eea9f9f8a39~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>3ã€æ·»åŠ æ¨¡æ¿å’Œå¾…æ£€æµ‹åº”ç”¨</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e93823fe3fe14092a287bb6ac95c3310~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39273c5ee0534cc4b705ee3de92d9fc0~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>4ã€å¯åŠ¨æ¨¡å—</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5bc1c3afd294c378d5cb57d7f7dda1b~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/798cac0dc3e2428699a16d74bfab6d44~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7748fbdc0e24f12bc2148383117e9b8~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5622c01867c64155a5cae84c6a57be57~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>æœ€åå°±æ˜¯è¿è¡Œåº”ç”¨ï¼ŒæŸ¥çœ‹è‡ªå®šä¹‰è¾“å‡ºæ—¥å¿—ã€‚ç”±äº xposted é˜²æŠ¤çš„å±€é™ï¼Œè‹¥ä¸èƒ½æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œè¿˜éœ€å¦å¯»ä»–æ³•ã€‚</p>\n<h1>Use Taichi ğŸ’”</h1>\n<p><strong>æ–¹æ¡ˆä¸å¯è¡Œä½†ä¸æ¨èï¼Œå†™å¥½çš„æ¨¡æ¿æ— æ³•ä½¿ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰</strong></p>\n<p>ä¸ºä»€ä¹ˆä¸æ¨èï¼Ÿå†™å¥½çš„æ£€æµ‹æ¨¡æ¿è¢«é™åˆ¶ä½¿ç”¨ï¼Œå®˜ç½‘ï¼š<a href=\"https://github.com/taichi-framework/TaiChi\">https://github.com/taichi-framework/TaiChi</a></p>\n<p>å¦‚ä½•ä½¿ç”¨å¤ªæå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼Œè¿™é‡Œæä¸‹é‡åˆ°çš„é—®é¢˜ï¼š</p>\n<p><strong>é—®é¢˜ä¸€ï¼šæš‚ä¸æ”¯æŒ</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ef794ca6102471bb11b702f6f062a1f~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>çœ‹ä¸‹å®˜ç½‘æœ‰å¯¹â€˜æš‚æ—¶ä¸æ”¯æŒâ€™çš„æè¿°ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š</strong></p>\n<ul>\n<li>å½“å‰å¤ªææ˜¯å¤ªæé˜´æ¨¡å¼ï¼ˆæœ‰é˜´ã€é˜³ä¸¤ç§æ¨¡å¼ï¼Œè‡ªè¡Œå®˜ç½‘äº†è§£ï¼‰</li>\n<li>å½“å‰æ¨¡å—ä¸å­˜åœ¨ç™½åå•ä¸­</li>\n</ul>\n<p>æš‚æ—¶æ²¡åŠæ³•ï¼Œè¯•è¯•æŠŠå¤ªææ¿€æ´»ä¸ºâ€˜å¤ªæé˜³â€™æ¨¡å¼ï¼Œç„¶è€Œå‘¢è¿˜æ˜¯æ˜¾ç¤ºæš‚ä¸æ”¯æŒï¼›çŒœæµ‹æ˜¯å¦ä¸€ç§å¯èƒ½ï¼Œæ¨¡æ¿ä¸å­˜åœ¨ç™½åå•ä¸­ï¼Œè¦åŠ å…¥ç™½åå•è¦è”ç³»ä½œè€…ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜æ˜¯å¦å¯»ä»–æ³•å§ã€‚åæ¥å‘ç°äº†å¦ä¸€ä¸ªæ¡†æ¶ LSP ã€‚ï¼ˆå¦‚ä½•å¼€å¯å¤ªæé˜³ï¼Œå®˜ç½‘æœ‰æ•™ç¨‹ï¼Œéœ€è¦å€ŸåŠ© Magiskï¼Œä¸‹æ–‡ä¼šç”¨åˆ°è¿™ä¸ªå·¥å…·ï¼‰</p>\n<h1>Use Lsposted â¤ï¸</h1>\n<p><strong>æ–¹æ¡ˆå¯è¡Œï¼Œæ¨èä½¿ç”¨</strong><br>\nä¸ºä»€ä¹ˆæ¨èï¼ŸLSP ä¾µå…¥æ€§å¼±ï¼Œä¸æ˜“è¢«ç¬¬ä¸‰æ–¹æ£€æµ‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿé¿å… xposted é˜²æŠ¤ã€‚</p>\n<h2 id=\"æ³¨æ„äº‹é¡¹\">æ³¨æ„äº‹é¡¹</h2>\n<ul>\n<li>BootLoader è§£é”å°†æ¸…é™¤è®¾å¤‡æ•°æ®ï¼Œé‡è¦æ•°æ®è¯·æ³¨æ„å¤‡ä»½</li>\n<li>æ­¤æ“ä½œéœ€è¦è®¾å¤‡è§£é” Bootloader ï¼ˆåˆ·æœºï¼‰ï¼Œè‹¥BootLoader è§£é”å¤±è´¥ï¼Œå…¶ä»–æ“ä½œå·²æ— æ„ä¹‰ï¼Œæ²¡æœ‰ç»§ç»­æ“ä½œçš„å¿…è¦ï¼Œå»ºè®®æ›´æ¢è®¾å¤‡ã€‚</li>\n<li>å„å‚å•†è®¾å¤‡ BootLoader è§£é”æ–¹å¼å¯èƒ½ä¸å°½ç›¸åŒã€‚\n<ul>\n<li>å°ç±³å®˜ç½‘ä»ç„¶å¼€æ”¾ BL è§£é”å·¥å…·ï¼ˆå»ºè®®ä½¿ç”¨å°ç±³æ‰‹æœºæµ‹è¯•ï¼‰</li>\n<li>è´­ä¹°ç¬¬ä¸‰æ–¹è§£é”å·¥å…· UAndroid</li>\n<li>OPPO å®˜æ–¹ä¹Ÿæœ‰â€˜æ·±åº¦æµ‹è¯•â€™è§£é”å·¥å…·ï¼Œä½†ç”³è¯·åé¢æœ‰é™ï¼Œå®¡æ ¸æ—¶é—´é•¿ï¼Œä¸æ¨è</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"å¦‚ä½•ä½¿ç”¨-2\">å¦‚ä½•ä½¿ç”¨</h2>\n<p>ä»¥å°ç±³æ‰‹æœºä¸ºä¾‹ï¼ˆå› ä¸º BL è§£é”æ–¹ä¾¿ï¼‰</p>\n<p><strong>1ã€è®¾å¤‡ Bootloader è§£é”</strong></p>\n<p><a href=\"http://www.miui.com/unlock/download.html\">å®˜æ–¹ï¼šç”³è¯·è§£é”å°ç±³æ‰‹æœº</a></p>\n<p>å°ç±³çš„ BL è§£é”å¯¹è®¾å¤‡çš„ä»¥åŠè´¦å·ç»‘å®šä¹Ÿæœ‰è¦æ±‚ï¼Œæ¯”å¦‚è´¦å·ä¸è®¾å¤‡ç»‘å®šæ—¶é—´ç­‰ã€‚å®˜ç½‘ä¸‹è½½å¾—åˆ°çš„å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚</p>\n<p><strong>2ã€ä¸‹è½½å®‰è£… Magisk</strong></p>\n<p>å®˜ç½‘ï¼š<a href=\"https://github.com/topjohnwu/Magisk\">https://github.com/topjohnwu/Magisk</a></p>\n<p><strong>3ã€ä¸‹è½½å¤‡ç”¨ adb-fastboot</strong></p>\n<p>é“¾æ¥ï¼š<a href=\"https://mrzzoxo.lanzouw.com/iMbPYz63p6f\">https://mrzzoxo.lanzouw.com/iMbPYz63p6f</a></p>\n<p><strong>4ã€å‡†å¤‡å¯¹åº”è®¾å¤‡å‹å·çš„åˆ·æœºåŒ…</strong></p>\n<p>å°ç±³åˆ·æœºåŒ…ï¼š<a href=\"https://mirom.ezbox.idv.tw/phone/\">https://mirom.ezbox.idv.tw/phone/</a></p>\n<p>ä¸€èˆ¬å»ºè®®ä¸‹è½½å¤§é™†ç¨³å®šç‰ˆï¼ˆè‹¥æ˜¯å…¶ä»–å‚å•†åˆ·æœºåŒ…ï¼Œè‡ªè¡Œå¯»æ‰¾ï¼‰</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87a8268965d648df8775781e37f77679~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>5ã€åˆ·å…¥ Magisk</strong></p>\n<p>å°½é‡æŒ‰é¡ºåºæ“ä½œ</p>\n<p>5.1 ä»åˆ·æœºåŒ…ä¸­è§£å‹è·å–Â Â <strong>boot.img</strong> æ–‡ä»¶ï¼ˆè‹¥æ— æ­¤æ–‡ä»¶å»ºè®®æ›´æ¢åˆ·æœºåŒ…ï¼Œä¹Ÿå¯ä»¥å¦å¯»ä»–æ³•ä»åˆ·æœºåŒ…ä¸­è§£æè·å¾—æ­¤æ–‡ä»¶ï¼‰<br>\n5.2 æ‰“å¼€ Magisk é€‰æ‹© boot.img å®‰è£…è¡¥ä¸ï¼Œç­‰å¾…åˆ·å…¥å®Œæˆï¼ˆæ­¤æˆªå›¾æ˜¯å·²å®‰è£…å®Œæˆçš„ï¼Œä»¥å®é™…ä¸ºå‡†ï¼‰</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6b1f76ad8845d98bf1f2c901286ed9~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>5.3 åˆ·å…¥å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—è·å¾—ç”Ÿæˆçš„ img æ–‡ä»¶</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0d9d3a707544199a1b8e5f5518b4e4f~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>5.4 å¤åˆ¶ç”Ÿæˆçš„Â img æ–‡ä»¶å’Œ boot.img æ–‡ä»¶åˆ° adb-fastboot ç›®å½•ä¸‹ï¼Œæ‰“å¼€Â æ‰“å¼€CMDå‘½ä»¤è¡Œ.batï¼ˆè‹¥ boot.img ä¸å­˜åœ¨æ­¤ç›®å½•ä¸‹ï¼Œåˆ·å…¥ magisk æ— æ•ˆï¼‰</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c3c9d8aa38426294d85cfdd38255a4~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>5.5 è®¾å¤‡è¿›å…¥ BootLoader æ¨¡å¼<br>\næ–¹å¼ä¸€ï¼šæ‰§è¡Œ adb reboot bootloader<br>\næ–¹å¼äºŒï¼šå…³æœºçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶æŒ‰ä½Â éŸ³é‡â€”Â +Â ç”µæºé”®</p>\n<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç­‰å¾…å®Œæˆï¼Œä½¿ç”¨å‘½ä»¤é‡å¯è®¾å¤‡ï¼›é‡å¯åé‡æ–°æ‰“å¼€ magisk æ˜¾ç¤ºç‰ˆæœ¬å·è¡¨ç¤ºæˆåŠŸã€‚</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0cf7cae60c44815b1127984face396c~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffe997317c794ad08d6c1242a54bf9a5~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35d48af81574b27bfba0c5eca5cfdc0~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><strong>6ã€åˆ·å…¥ LSPosted</strong></p>\n<p>å®˜ç½‘ï¼š<a href=\"https://github.com/LSPosed/LSPosed%E3%80%81https://github.com/RikkaApps/Riru/tags\">https://github.com/LSPosed/LSPosedã€https://github.com/RikkaApps/Riru/tags</a></p>\n<p>6.1 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c329e61e1fc48e5945863ce1a1f8cda~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>6.2 å¼€å¯ Zygiskï¼ŒæŒ‰æç¤ºé‡å¯è®¾å¤‡</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d948643a1a3f4bf79cb1ee7dd8075ea1~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>6.3 ä¸‹è½½<strong>LSPosted-zygisk</strong>å¤‡ç”¨ï¼ˆå¿…é€‰ï¼‰</p>\n<p>å¦‚æœè®¾å¤‡æ”¯æŒ Zygiskï¼Œrituã€LSPosted-ritu æ¨¡å—å¯ä¸éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨æ”¯æŒ Zygisk çš„è®¾å¤‡</p>\n<p>6.4 æ‰“å¼€ Magisk å¼€å§‹åˆ·å…¥å¿…é€‰æ¨¡å—ï¼ŒæŒ‰ç…§æç¤ºé‡å¯è®¾å¤‡åæ˜¾ç¤ºÂ Zygisk æ˜¯ï¼Œæ¡Œé¢å‡ºç° LSPosted</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8e39c410d444628be03c7f83adaf92a~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b73cb22078b4610a4fac35e369b8eea~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90ae1ca939964ce68b0e56331bd50b63~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baffbe16b1d04a1899ba2c4caee9b37b~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p><strong>7ã€å®‰è£…æ£€æµ‹æ¨¡å—</strong></p>\n<p>å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…æˆ‘ä»¬çš„Â <strong>åˆè§„æ£€æµ‹æ¨¡å—</strong>ï¼Œé‚£ä¹ˆç°åœ¨è¦å®‰è£…å•¦ï¼ï¼ï¼å¯åŠ¨æ¨¡å—ï¼Œå‹¾é€‰è¦æ£€æµ‹çš„åº”ç”¨ï¼Œè¿”å›æ¡Œé¢æ‰§è¡Œåº”ç”¨å°±å¯ä»¥çœ‹æ—¥å¿—</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5196bdc80d84b64b8fd752e47285651~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h1>å…¶ä»–</h1>\n<ul>\n<li>âš ï¸ Android 9 åŠå…¶ä»¥ä¸‹è®¾å¤‡æ‰æ”¯æŒ IMEI è·å–ï¼Œåœ¨æµ‹è¯•è®¾å¤‡é€‰æ‹©ä¸Šéœ€æ³¨æ„</li>\n<li><a href=\"https://forum.xda-developers.com/\">å­¦ä¹ ç½‘ç«™ï¼šXDA Forums</a> è¯¥ç½‘ç«™çš„ä¸»è¦è®¨è®ºæ‰‹æœºç³»ç»Ÿï¼Œå¹¶æä¾›ç›¸å…³è®¾å¤‡çš„æŠ€æœ¯ä¿¡æ¯ã€<a href=\"https://zh.m.wikipedia.org/wiki/ROM\">ROM</a>å‡çº§ã€æŠ€æœ¯æ”¯æŒã€Qï¼†A</li>\n<li><a href=\"https://bbs.gsmua.cn/\">ææœºç½‘ç«™ï¼šUAæ‰‹æœºç»´ä¿®äº¤æµ - Powered by Discuz!</a><br>\nå¯æä¾› UAndroid å·¥å…·ï¼Œç”¨äºå„å‚å•†è®¾å¤‡ BootLoader è§£é”<br>\nä»˜è´¹å·¥å…·ã€ä¹Ÿå¯ä»¥è´¦å·ç§Ÿç”¨æ–¹å¼ä½¿ç”¨ï¼ˆä¸“ä¸šææœºï¼ŒæŸå®ä¹Ÿæœ‰ç›¸å…³æŠ€æœ¯æœåŠ¡ï¼‰</li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"cl99ignsj0001gaqpb9qgfwmi","tag_id":"cl99ignsl0004gaqp1byh4tr6","_id":"cl99ignso000cgaqpdp6s7mut"},{"post_id":"cl99ignsl0003gaqp311kas46","tag_id":"cl99ignso000bgaqp0mpgdbzg","_id":"cl99ignsq000hgaqp9oyx8fgj"},{"post_id":"cl99ignsp000ggaqp3m782xx9","tag_id":"cl99ignsl0004gaqp1byh4tr6","_id":"cl99ignsr000kgaqpaoks37jg"},{"post_id":"cl99ignsm0006gaqp7m2t9fpu","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignss000mgaqp6jcod0gg"},{"post_id":"cl99ignsr000igaqpaa094qj1","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignst000pgaqp3oep5dqg"},{"post_id":"cl99ignsn0008gaqp74h4b86f","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignst000rgaqp20o65ho5"},{"post_id":"cl99ignso000agaqp6pb183u7","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignsu000vgaqph2szcp43"},{"post_id":"cl99ignsu000sgaqp9aqdb9bb","tag_id":"cl99ignso000bgaqp0mpgdbzg","_id":"cl99ignsu000wgaqp7arecti0"},{"post_id":"cl99ignso000dgaqph4pu9be0","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignsu000ygaqp60xs744v"},{"post_id":"cl99ignsp000egaqphqsi1vr9","tag_id":"cl99ignsp000fgaqp0r9dbwae","_id":"cl99ignsv0010gaqpaasu3ud8"},{"post_id":"cl99ignss000lgaqpfz0scezr","tag_id":"cl99ignsu000zgaqpehm26k6a","_id":"cl99ignsv0012gaqp6f8e35gz"},{"post_id":"cl99ignst000ngaqp3o3phl19","tag_id":"cl99ignsv0011gaqpgxjw5s2v","_id":"cl99ignsv0014gaqpf7zl229v"},{"post_id":"cl99ignst000qgaqp2on65nh8","tag_id":"cl99ignsu000zgaqpehm26k6a","_id":"cl99ignsv0016gaqphr1ucy2z"},{"post_id":"cl99ignsu000ugaqp3srpgi83","tag_id":"cl99ignsv0015gaqpe6df4ptr","_id":"cl99ignsv0017gaqp32bsgp57"}],"Tag":[{"name":"å­—èŠ‚ç ","_id":"cl99ignsl0004gaqp1byh4tr6"},{"name":"ç¬”è®°","_id":"cl99ignso000bgaqp0mpgdbzg"},{"name":"AOSP","_id":"cl99ignsp000fgaqp0r9dbwae"},{"name":"å·¥å…·","_id":"cl99ignsu000zgaqpehm26k6a"},{"name":"SDK","_id":"cl99ignsv0011gaqpgxjw5s2v"},{"name":"åˆ·æœº","_id":"cl99ignsv0015gaqpe6df4ptr"}]}}